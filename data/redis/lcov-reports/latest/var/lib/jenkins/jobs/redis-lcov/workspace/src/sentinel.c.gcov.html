<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - redis-lcov_9.info - /var/lib/jenkins/jobs/redis-lcov/workspace/src/sentinel.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../../../index.html">top level</a> - <a href="index.html">var/lib/jenkins/jobs/redis-lcov/workspace/src</a> - sentinel.c<span style="font-size: 80%;"> (source / <a href="sentinel.c.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">redis-lcov_9.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">1405</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2013-08-26</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">81</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
            | Branches:
            <span class="coverLegendCov">+</span> taken
            <span class="coverLegendNoCov">-</span> not taken
            <span class="coverLegendNoCov">#</span> not executed
</td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">937</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr><td><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : /* Redis Sentinel implementation</a>
<span class="lineNum">       2 </span>                :            :  *
<span class="lineNum">       3 </span>                :            :  * Copyright (c) 2009-2012, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;
<span class="lineNum">       4 </span>                :            :  * All rights reserved.
<span class="lineNum">       5 </span>                :            :  *
<span class="lineNum">       6 </span>                :            :  * Redistribution and use in source and binary forms, with or without
<span class="lineNum">       7 </span>                :            :  * modification, are permitted provided that the following conditions are met:
<span class="lineNum">       8 </span>                :            :  *
<span class="lineNum">       9 </span>                :            :  *   * Redistributions of source code must retain the above copyright notice,
<span class="lineNum">      10 </span>                :            :  *     this list of conditions and the following disclaimer.
<span class="lineNum">      11 </span>                :            :  *   * Redistributions in binary form must reproduce the above copyright
<span class="lineNum">      12 </span>                :            :  *     notice, this list of conditions and the following disclaimer in the
<span class="lineNum">      13 </span>                :            :  *     documentation and/or other materials provided with the distribution.
<span class="lineNum">      14 </span>                :            :  *   * Neither the name of Redis nor the names of its contributors may be used
<span class="lineNum">      15 </span>                :            :  *     to endorse or promote products derived from this software without
<span class="lineNum">      16 </span>                :            :  *     specific prior written permission.
<span class="lineNum">      17 </span>                :            :  *
<span class="lineNum">      18 </span>                :            :  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;
<span class="lineNum">      19 </span>                :            :  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
<span class="lineNum">      20 </span>                :            :  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
<span class="lineNum">      21 </span>                :            :  * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
<span class="lineNum">      22 </span>                :            :  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
<span class="lineNum">      23 </span>                :            :  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
<span class="lineNum">      24 </span>                :            :  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
<span class="lineNum">      25 </span>                :            :  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
<span class="lineNum">      26 </span>                :            :  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
<span class="lineNum">      27 </span>                :            :  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
<span class="lineNum">      28 </span>                :            :  * POSSIBILITY OF SUCH DAMAGE.
<span class="lineNum">      29 </span>                :            :  */
<span class="lineNum">      30 </span>                :            : 
<span class="lineNum">      31 </span>                :            : #include &quot;redis.h&quot;
<span class="lineNum">      32 </span>                :            : #include &quot;hiredis.h&quot;
<span class="lineNum">      33 </span>                :            : #include &quot;async.h&quot;
<span class="lineNum">      34 </span>                :            : 
<span class="lineNum">      35 </span>                :            : #include &lt;ctype.h&gt;
<span class="lineNum">      36 </span>                :            : #include &lt;arpa/inet.h&gt;
<span class="lineNum">      37 </span>                :            : #include &lt;sys/socket.h&gt;
<span class="lineNum">      38 </span>                :            : #include &lt;sys/wait.h&gt;
<span class="lineNum">      39 </span>                :            : 
<span class="lineNum">      40 </span>                :            : extern char **environ;
<span class="lineNum">      41 </span>                :            : 
<span class="lineNum">      42 </span>                :            : #define REDIS_SENTINEL_PORT 26379
<span class="lineNum">      43 </span>                :            : 
<span class="lineNum">      44 </span>                :            : /* ======================== Sentinel global state =========================== */
<span class="lineNum">      45 </span>                :            : 
<span class="lineNum">      46 </span>                :            : typedef long long mstime_t; /* millisecond time type. */
<span class="lineNum">      47 </span>                :            : 
<span class="lineNum">      48 </span>                :            : /* Address object, used to describe an ip:port pair. */
<span class="lineNum">      49 </span>                :            : typedef struct sentinelAddr {
<span class="lineNum">      50 </span>                :            :     char *ip;
<span class="lineNum">      51 </span>                :            :     int port;
<span class="lineNum">      52 </span>                :            : } sentinelAddr;
<span class="lineNum">      53 </span>                :            : 
<span class="lineNum">      54 </span>                :            : /* A Sentinel Redis Instance object is monitoring. */
<span class="lineNum">      55 </span>                :            : #define SRI_MASTER  (1&lt;&lt;0)
<span class="lineNum">      56 </span>                :            : #define SRI_SLAVE   (1&lt;&lt;1)
<span class="lineNum">      57 </span>                :            : #define SRI_SENTINEL (1&lt;&lt;2)
<span class="lineNum">      58 </span>                :            : #define SRI_DISCONNECTED (1&lt;&lt;3)
<span class="lineNum">      59 </span>                :            : #define SRI_S_DOWN (1&lt;&lt;4)   /* Subjectively down (no quorum). */
<span class="lineNum">      60 </span>                :            : #define SRI_O_DOWN (1&lt;&lt;5)   /* Objectively down (quorum reached). */
<span class="lineNum">      61 </span>                :            : #define SRI_MASTER_DOWN (1&lt;&lt;6) /* A Sentinel with this flag set thinks that
<span class="lineNum">      62 </span>                :            :                                    its master is down. */
<span class="lineNum">      63 </span>                :            : /* SRI_CAN_FAILOVER when set in an SRI_MASTER instance means that we are
<span class="lineNum">      64 </span>                :            :  * allowed to perform the failover for this master.
<span class="lineNum">      65 </span>                :            :  * When set in a SRI_SENTINEL instance means that sentinel is allowed to
<span class="lineNum">      66 </span>                :            :  * perform the failover on its master. */
<span class="lineNum">      67 </span>                :            : #define SRI_CAN_FAILOVER (1&lt;&lt;7)
<span class="lineNum">      68 </span>                :            : #define SRI_FAILOVER_IN_PROGRESS (1&lt;&lt;8) /* Failover is in progress for
<span class="lineNum">      69 </span>                :            :                                            this master. */
<span class="lineNum">      70 </span>                :            : #define SRI_I_AM_THE_LEADER (1&lt;&lt;9)     /* We are the leader for this master. */
<span class="lineNum">      71 </span>                :            : #define SRI_PROMOTED (1&lt;&lt;10)            /* Slave selected for promotion. */
<span class="lineNum">      72 </span>                :            : #define SRI_RECONF_SENT (1&lt;&lt;11)     /* SLAVEOF &lt;newmaster&gt; sent. */
<span class="lineNum">      73 </span>                :            : #define SRI_RECONF_INPROG (1&lt;&lt;12)   /* Slave synchronization in progress. */
<span class="lineNum">      74 </span>                :            : #define SRI_RECONF_DONE (1&lt;&lt;13)     /* Slave synchronized with new master. */
<span class="lineNum">      75 </span>                :            : #define SRI_FORCE_FAILOVER (1&lt;&lt;14)  /* Force failover with master up. */
<span class="lineNum">      76 </span>                :            : #define SRI_SCRIPT_KILL_SENT (1&lt;&lt;15) /* SCRIPT KILL already sent on -BUSY */
<span class="lineNum">      77 </span>                :            : #define SRI_DEMOTE (1&lt;&lt;16)   /* If the instance claims to be a master, demote
<span class="lineNum">      78 </span>                :            :                                 it into a slave sending SLAVEOF. */
<span class="lineNum">      79 </span>                :            : 
<span class="lineNum">      80 </span>                :            : #define SENTINEL_INFO_PERIOD 10000
<span class="lineNum">      81 </span>                :            : #define SENTINEL_PING_PERIOD 1000
<span class="lineNum">      82 </span>                :            : #define SENTINEL_ASK_PERIOD 1000
<span class="lineNum">      83 </span>                :            : #define SENTINEL_PUBLISH_PERIOD 5000
<span class="lineNum">      84 </span>                :            : #define SENTINEL_DOWN_AFTER_PERIOD 30000
<span class="lineNum">      85 </span>                :            : #define SENTINEL_HELLO_CHANNEL &quot;__sentinel__:hello&quot;
<span class="lineNum">      86 </span>                :            : #define SENTINEL_TILT_TRIGGER 2000
<span class="lineNum">      87 </span>                :            : #define SENTINEL_TILT_PERIOD (SENTINEL_PING_PERIOD*30)
<span class="lineNum">      88 </span>                :            : #define SENTINEL_DEFAULT_SLAVE_PRIORITY 100
<span class="lineNum">      89 </span>                :            : #define SENTINEL_PROMOTION_RETRY_PERIOD 30000
<span class="lineNum">      90 </span>                :            : #define SENTINEL_SLAVE_RECONF_RETRY_PERIOD 10000
<span class="lineNum">      91 </span>                :            : #define SENTINEL_DEFAULT_PARALLEL_SYNCS 1
<span class="lineNum">      92 </span>                :            : #define SENTINEL_MIN_LINK_RECONNECT_PERIOD 15000
<span class="lineNum">      93 </span>                :            : #define SENTINEL_DEFAULT_FAILOVER_TIMEOUT (60*15*1000)
<span class="lineNum">      94 </span>                :            : #define SENTINEL_MAX_PENDING_COMMANDS 100
<span class="lineNum">      95 </span>                :            : #define SENTINEL_EXTENDED_SDOWN_MULTIPLIER 10
<span class="lineNum">      96 </span>                :            : 
<span class="lineNum">      97 </span>                :            : /* How many milliseconds is an information valid? This applies for instance
<span class="lineNum">      98 </span>                :            :  * to the reply to SENTINEL IS-MASTER-DOWN-BY-ADDR replies. */
<span class="lineNum">      99 </span>                :            : #define SENTINEL_INFO_VALIDITY_TIME 5000
<span class="lineNum">     100 </span>                :            : #define SENTINEL_FAILOVER_FIXED_DELAY 5000
<span class="lineNum">     101 </span>                :            : #define SENTINEL_FAILOVER_MAX_RANDOM_DELAY 10000
<span class="lineNum">     102 </span>                :            : 
<span class="lineNum">     103 </span>                :            : /* Failover machine different states. */
<span class="lineNum">     104 </span>                :            : #define SENTINEL_FAILOVER_STATE_NONE 0  /* No failover in progress. */
<span class="lineNum">     105 </span>                :            : #define SENTINEL_FAILOVER_STATE_WAIT_START 1  /* Wait for failover_start_time*/ 
<span class="lineNum">     106 </span>                :            : #define SENTINEL_FAILOVER_STATE_SELECT_SLAVE 2 /* Select slave to promote */
<span class="lineNum">     107 </span>                :            : #define SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE 3 /* Slave -&gt; Master */
<span class="lineNum">     108 </span>                :            : #define SENTINEL_FAILOVER_STATE_WAIT_PROMOTION 4 /* Wait slave to change role */
<span class="lineNum">     109 </span>                :            : #define SENTINEL_FAILOVER_STATE_RECONF_SLAVES 5 /* SLAVEOF newmaster */
<span class="lineNum">     110 </span>                :            : #define SENTINEL_FAILOVER_STATE_WAIT_NEXT_SLAVE 6 /* wait replication */
<span class="lineNum">     111 </span>                :            : #define SENTINEL_FAILOVER_STATE_ALERT_CLIENTS 7 /* Run user script. */
<span class="lineNum">     112 </span>                :            : #define SENTINEL_FAILOVER_STATE_WAIT_ALERT_SCRIPT 8 /* Wait script exec. */
<span class="lineNum">     113 </span>                :            : #define SENTINEL_FAILOVER_STATE_DETECT_END 9 /* Check for failover end. */
<span class="lineNum">     114 </span>                :            : #define SENTINEL_FAILOVER_STATE_UPDATE_CONFIG 10 /* Monitor promoted slave. */
<span class="lineNum">     115 </span>                :            : 
<span class="lineNum">     116 </span>                :            : #define SENTINEL_MASTER_LINK_STATUS_UP 0
<span class="lineNum">     117 </span>                :            : #define SENTINEL_MASTER_LINK_STATUS_DOWN 1
<span class="lineNum">     118 </span>                :            : 
<span class="lineNum">     119 </span>                :            : /* Generic flags that can be used with different functions. */
<span class="lineNum">     120 </span>                :            : #define SENTINEL_NO_FLAGS 0
<span class="lineNum">     121 </span>                :            : #define SENTINEL_GENERATE_EVENT 1
<span class="lineNum">     122 </span>                :            : #define SENTINEL_LEADER 2
<span class="lineNum">     123 </span>                :            : #define SENTINEL_OBSERVER 4
<span class="lineNum">     124 </span>                :            : 
<span class="lineNum">     125 </span>                :            : /* Script execution flags and limits. */
<span class="lineNum">     126 </span>                :            : #define SENTINEL_SCRIPT_NONE 0
<span class="lineNum">     127 </span>                :            : #define SENTINEL_SCRIPT_RUNNING 1
<span class="lineNum">     128 </span>                :            : #define SENTINEL_SCRIPT_MAX_QUEUE 256
<span class="lineNum">     129 </span>                :            : #define SENTINEL_SCRIPT_MAX_RUNNING 16
<span class="lineNum">     130 </span>                :            : #define SENTINEL_SCRIPT_MAX_RUNTIME 60000 /* 60 seconds max exec time. */
<span class="lineNum">     131 </span>                :            : #define SENTINEL_SCRIPT_MAX_RETRY 10
<span class="lineNum">     132 </span>                :            : #define SENTINEL_SCRIPT_RETRY_DELAY 30000 /* 30 seconds between retries. */
<span class="lineNum">     133 </span>                :            : 
<span class="lineNum">     134 </span>                :            : typedef struct sentinelRedisInstance {
<span class="lineNum">     135 </span>                :            :     int flags;      /* See SRI_... defines */
<span class="lineNum">     136 </span>                :            :     char *name;     /* Master name from the point of view of this sentinel. */
<span class="lineNum">     137 </span>                :            :     char *runid;    /* run ID of this instance. */
<span class="lineNum">     138 </span>                :            :     sentinelAddr *addr; /* Master host. */
<span class="lineNum">     139 </span>                :            :     redisAsyncContext *cc; /* Hiredis context for commands. */
<span class="lineNum">     140 </span>                :            :     redisAsyncContext *pc; /* Hiredis context for Pub / Sub. */
<span class="lineNum">     141 </span>                :            :     int pending_commands;   /* Number of commands sent waiting for a reply. */
<span class="lineNum">     142 </span>                :            :     mstime_t cc_conn_time; /* cc connection time. */
<span class="lineNum">     143 </span>                :            :     mstime_t pc_conn_time; /* pc connection time. */
<span class="lineNum">     144 </span>                :            :     mstime_t pc_last_activity; /* Last time we received any message. */
<span class="lineNum">     145 </span>                :            :     mstime_t last_avail_time; /* Last time the instance replied to ping with
<span class="lineNum">     146 </span>                :            :                                  a reply we consider valid. */
<span class="lineNum">     147 </span>                :            :     mstime_t last_pong_time;  /* Last time the instance replied to ping,
<span class="lineNum">     148 </span>                :            :                                  whatever the reply was. That's used to check
<span class="lineNum">     149 </span>                :            :                                  if the link is idle and must be reconnected. */
<span class="lineNum">     150 </span>                :            :     mstime_t last_pub_time;   /* Last time we sent hello via Pub/Sub. */
<span class="lineNum">     151 </span>                :            :     mstime_t last_hello_time; /* Only used if SRI_SENTINEL is set. Last time
<span class="lineNum">     152 </span>                :            :                                  we received an hello from this Sentinel
<span class="lineNum">     153 </span>                :            :                                  via Pub/Sub. */
<span class="lineNum">     154 </span>                :            :     mstime_t last_master_down_reply_time; /* Time of last reply to
<span class="lineNum">     155 </span>                :            :                                              SENTINEL is-master-down command. */
<span class="lineNum">     156 </span>                :            :     mstime_t s_down_since_time; /* Subjectively down since time. */
<span class="lineNum">     157 </span>                :            :     mstime_t o_down_since_time; /* Objectively down since time. */
<span class="lineNum">     158 </span>                :            :     mstime_t down_after_period; /* Consider it down after that period. */
<span class="lineNum">     159 </span>                :            :     mstime_t info_refresh;  /* Time at which we received INFO output from it. */
<span class="lineNum">     160 </span>                :            : 
<span class="lineNum">     161 </span>                :            :     /* Master specific. */
<span class="lineNum">     162 </span>                :            :     dict *sentinels;    /* Other sentinels monitoring the same master. */
<span class="lineNum">     163 </span>                :            :     dict *slaves;       /* Slaves for this master instance. */
<span class="lineNum">     164 </span>                :            :     int quorum;         /* Number of sentinels that need to agree on failure. */
<span class="lineNum">     165 </span>                :            :     int parallel_syncs; /* How many slaves to reconfigure at same time. */
<span class="lineNum">     166 </span>                :            :     char *auth_pass;    /* Password to use for AUTH against master &amp; slaves. */
<span class="lineNum">     167 </span>                :            : 
<span class="lineNum">     168 </span>                :            :     /* Slave specific. */
<span class="lineNum">     169 </span>                :            :     mstime_t master_link_down_time; /* Slave replication link down time. */
<span class="lineNum">     170 </span>                :            :     int slave_priority; /* Slave priority according to its INFO output. */
<span class="lineNum">     171 </span>                :            :     mstime_t slave_reconf_sent_time; /* Time at which we sent SLAVE OF &lt;new&gt; */
<span class="lineNum">     172 </span>                :            :     struct sentinelRedisInstance *master; /* Master instance if SRI_SLAVE is set. */
<span class="lineNum">     173 </span>                :            :     char *slave_master_host;    /* Master host as reported by INFO */
<span class="lineNum">     174 </span>                :            :     int slave_master_port;      /* Master port as reported by INFO */
<span class="lineNum">     175 </span>                :            :     int slave_master_link_status; /* Master link status as reported by INFO */
<span class="lineNum">     176 </span>                :            :     /* Failover */
<span class="lineNum">     177 </span>                :            :     char *leader;       /* If this is a master instance, this is the runid of
<span class="lineNum">     178 </span>                :            :                            the Sentinel that should perform the failover. If
<span class="lineNum">     179 </span>                :            :                            this is a Sentinel, this is the runid of the Sentinel
<span class="lineNum">     180 </span>                :            :                            that this other Sentinel is voting as leader.
<span class="lineNum">     181 </span>                :            :                            This field is valid only if SRI_MASTER_DOWN is
<span class="lineNum">     182 </span>                :            :                            set on the Sentinel instance. */
<span class="lineNum">     183 </span>                :            :     int failover_state; /* See SENTINEL_FAILOVER_STATE_* defines. */
<span class="lineNum">     184 </span>                :            :     mstime_t failover_state_change_time;
<span class="lineNum">     185 </span>                :            :     mstime_t failover_start_time;   /* When to start to failover if leader. */
<span class="lineNum">     186 </span>                :            :     mstime_t failover_timeout;      /* Max time to refresh failover state. */
<span class="lineNum">     187 </span>                :            :     struct sentinelRedisInstance *promoted_slave; /* Promoted slave instance. */
<span class="lineNum">     188 </span>                :            :     /* Scripts executed to notify admin or reconfigure clients: when they
<span class="lineNum">     189 </span>                :            :      * are set to NULL no script is executed. */
<span class="lineNum">     190 </span>                :            :     char *notification_script;
<span class="lineNum">     191 </span>                :            :     char *client_reconfig_script;
<span class="lineNum">     192 </span>                :            : } sentinelRedisInstance;
<span class="lineNum">     193 </span>                :            : 
<span class="lineNum">     194 </span>                :            : /* Main state. */
<span class="lineNum">     195 </span>                :            : struct sentinelState {
<span class="lineNum">     196 </span>                :            :     dict *masters;      /* Dictionary of master sentinelRedisInstances.
<span class="lineNum">     197 </span>                :            :                            Key is the instance name, value is the
<span class="lineNum">     198 </span>                :            :                            sentinelRedisInstance structure pointer. */
<span class="lineNum">     199 </span>                :            :     int tilt;           /* Are we in TILT mode? */
<span class="lineNum">     200 </span>                :            :     int running_scripts;    /* Number of scripts in execution right now. */
<span class="lineNum">     201 </span>                :            :     mstime_t tilt_start_time;   /* When TITL started. */
<span class="lineNum">     202 </span>                :            :     mstime_t previous_time;     /* Time last time we ran the time handler. */
<span class="lineNum">     203 </span>                :            :     list *scripts_queue;    /* Queue of user scripts to execute. */
<span class="lineNum">     204 </span>                :            : } sentinel;
<span class="lineNum">     205 </span>                :            : 
<span class="lineNum">     206 </span>                :            : /* A script execution job. */
<span class="lineNum">     207 </span>                :            : typedef struct sentinelScriptJob {
<span class="lineNum">     208 </span>                :            :     int flags;              /* Script job flags: SENTINEL_SCRIPT_* */
<span class="lineNum">     209 </span>                :            :     int retry_num;          /* Number of times we tried to execute it. */
<span class="lineNum">     210 </span>                :            :     char **argv;            /* Arguments to call the script. */
<span class="lineNum">     211 </span>                :            :     mstime_t start_time;    /* Script execution time if the script is running,
<span class="lineNum">     212 </span>                :            :                                otherwise 0 if we are allowed to retry the
<span class="lineNum">     213 </span>                :            :                                execution at any time. If the script is not
<span class="lineNum">     214 </span>                :            :                                running and it's not 0, it means: do not run
<span class="lineNum">     215 </span>                :            :                                before the specified time. */
<span class="lineNum">     216 </span>                :            :     pid_t pid;              /* Script execution pid. */
<span class="lineNum">     217 </span>                :            : } sentinelScriptJob;
<span class="lineNum">     218 </span>                :            : 
<span class="lineNum">     219 </span>                :            : /* ======================= hiredis ae.c adapters =============================
<span class="lineNum">     220 </span>                :            :  * Note: this implementation is taken from hiredis/adapters/ae.h, however
<span class="lineNum">     221 </span>                :            :  * we have our modified copy for Sentinel in order to use our allocator
<span class="lineNum">     222 </span>                :            :  * and to have full control over how the adapter works. */
<span class="lineNum">     223 </span>                :            : 
<span class="lineNum">     224 </span>                :            : typedef struct redisAeEvents {
<span class="lineNum">     225 </span>                :            :     redisAsyncContext *context;
<span class="lineNum">     226 </span>                :            :     aeEventLoop *loop;
<span class="lineNum">     227 </span>                :            :     int fd;
<span class="lineNum">     228 </span>                :            :     int reading, writing;
<a name="229"><span class="lineNum">     229 </span>                :            : } redisAeEvents;</a>
<span class="lineNum">     230 </span>                :            : 
<span class="lineNum">     231 </span>                :<span class="lineNoCov">          0 : static void redisAeReadEvent(aeEventLoop *el, int fd, void *privdata, int mask) {</span>
<span class="lineNum">     232 </span>                :            :     ((void)el); ((void)fd); ((void)mask);
<span class="lineNum">     233 </span>                :            : 
<span class="lineNum">     234 </span>                :<span class="lineNoCov">          0 :     redisAeEvents *e = (redisAeEvents*)privdata;</span>
<span class="lineNum">     235 </span>                :<span class="lineNoCov">          0 :     redisAsyncHandleRead(e-&gt;context);</span>
<a name="236"><span class="lineNum">     236 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     237 </span>                :            : 
<span class="lineNum">     238 </span>                :<span class="lineNoCov">          0 : static void redisAeWriteEvent(aeEventLoop *el, int fd, void *privdata, int mask) {</span>
<span class="lineNum">     239 </span>                :            :     ((void)el); ((void)fd); ((void)mask);
<span class="lineNum">     240 </span>                :            : 
<span class="lineNum">     241 </span>                :<span class="lineNoCov">          0 :     redisAeEvents *e = (redisAeEvents*)privdata;</span>
<span class="lineNum">     242 </span>                :<span class="lineNoCov">          0 :     redisAsyncHandleWrite(e-&gt;context);</span>
<a name="243"><span class="lineNum">     243 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     244 </span>                :            : 
<span class="lineNum">     245 </span>                :<span class="lineNoCov">          0 : static void redisAeAddRead(void *privdata) {</span>
<span class="lineNum">     246 </span>                :<span class="lineNoCov">          0 :     redisAeEvents *e = (redisAeEvents*)privdata;</span>
<span class="lineNum">     247 </span>                :<span class="lineNoCov">          0 :     aeEventLoop *loop = e-&gt;loop;</span>
<span class="lineNum">     248 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!e-&gt;reading) {</span>
<span class="lineNum">     249 </span>                :<span class="lineNoCov">          0 :         e-&gt;reading = 1;</span>
<span class="lineNum">     250 </span>                :<span class="lineNoCov">          0 :         aeCreateFileEvent(loop,e-&gt;fd,AE_READABLE,redisAeReadEvent,e);</span>
<span class="lineNum">     251 </span>                :            :     }
<a name="252"><span class="lineNum">     252 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     253 </span>                :            : 
<span class="lineNum">     254 </span>                :<span class="lineNoCov">          0 : static void redisAeDelRead(void *privdata) {</span>
<span class="lineNum">     255 </span>                :<span class="lineNoCov">          0 :     redisAeEvents *e = (redisAeEvents*)privdata;</span>
<span class="lineNum">     256 </span>                :<span class="lineNoCov">          0 :     aeEventLoop *loop = e-&gt;loop;</span>
<span class="lineNum">     257 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (e-&gt;reading) {</span>
<span class="lineNum">     258 </span>                :<span class="lineNoCov">          0 :         e-&gt;reading = 0;</span>
<span class="lineNum">     259 </span>                :<span class="lineNoCov">          0 :         aeDeleteFileEvent(loop,e-&gt;fd,AE_READABLE);</span>
<span class="lineNum">     260 </span>                :            :     }
<a name="261"><span class="lineNum">     261 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     262 </span>                :            : 
<span class="lineNum">     263 </span>                :<span class="lineNoCov">          0 : static void redisAeAddWrite(void *privdata) {</span>
<span class="lineNum">     264 </span>                :<span class="lineNoCov">          0 :     redisAeEvents *e = (redisAeEvents*)privdata;</span>
<span class="lineNum">     265 </span>                :<span class="lineNoCov">          0 :     aeEventLoop *loop = e-&gt;loop;</span>
<span class="lineNum">     266 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!e-&gt;writing) {</span>
<span class="lineNum">     267 </span>                :<span class="lineNoCov">          0 :         e-&gt;writing = 1;</span>
<span class="lineNum">     268 </span>                :<span class="lineNoCov">          0 :         aeCreateFileEvent(loop,e-&gt;fd,AE_WRITABLE,redisAeWriteEvent,e);</span>
<span class="lineNum">     269 </span>                :            :     }
<a name="270"><span class="lineNum">     270 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     271 </span>                :            : 
<span class="lineNum">     272 </span>                :<span class="lineNoCov">          0 : static void redisAeDelWrite(void *privdata) {</span>
<span class="lineNum">     273 </span>                :<span class="lineNoCov">          0 :     redisAeEvents *e = (redisAeEvents*)privdata;</span>
<span class="lineNum">     274 </span>                :<span class="lineNoCov">          0 :     aeEventLoop *loop = e-&gt;loop;</span>
<span class="lineNum">     275 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (e-&gt;writing) {</span>
<span class="lineNum">     276 </span>                :<span class="lineNoCov">          0 :         e-&gt;writing = 0;</span>
<span class="lineNum">     277 </span>                :<span class="lineNoCov">          0 :         aeDeleteFileEvent(loop,e-&gt;fd,AE_WRITABLE);</span>
<span class="lineNum">     278 </span>                :            :     }
<a name="279"><span class="lineNum">     279 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     280 </span>                :            : 
<span class="lineNum">     281 </span>                :<span class="lineNoCov">          0 : static void redisAeCleanup(void *privdata) {</span>
<span class="lineNum">     282 </span>                :<span class="lineNoCov">          0 :     redisAeEvents *e = (redisAeEvents*)privdata;</span>
<span class="lineNum">     283 </span>                :<span class="lineNoCov">          0 :     redisAeDelRead(privdata);</span>
<span class="lineNum">     284 </span>                :<span class="lineNoCov">          0 :     redisAeDelWrite(privdata);</span>
<span class="lineNum">     285 </span>                :<span class="lineNoCov">          0 :     zfree(e);</span>
<span class="lineNum">     286 </span>                :<span class="lineNoCov">          0 : }</span>
<a name="287"><span class="lineNum">     287 </span>                :            : </a>
<span class="lineNum">     288 </span>                :            : static int redisAeAttach(aeEventLoop *loop, redisAsyncContext *ac) {
<span class="lineNum">     289 </span>                :<span class="lineNoCov">          0 :     redisContext *c = &amp;(ac-&gt;c);</span>
<span class="lineNum">     290 </span>                :            :     redisAeEvents *e;
<span class="lineNum">     291 </span>                :            : 
<span class="lineNum">     292 </span>                :            :     /* Nothing should be attached when something is already attached */
<span class="lineNum">     293 </span>  [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ac-&gt;ev.data != NULL)</span>
<span class="lineNum">     294 </span>                :            :         return REDIS_ERR;
<span class="lineNum">     295 </span>                :            : 
<span class="lineNum">     296 </span>                :            :     /* Create container for context and r/w events */
<span class="lineNum">     297 </span>                :<span class="lineNoCov">          0 :     e = (redisAeEvents*)zmalloc(sizeof(*e));</span>
<span class="lineNum">     298 </span>                :<span class="lineNoCov">          0 :     e-&gt;context = ac;</span>
<span class="lineNum">     299 </span>                :<span class="lineNoCov">          0 :     e-&gt;loop = loop;</span>
<span class="lineNum">     300 </span>                :<span class="lineNoCov">          0 :     e-&gt;fd = c-&gt;fd;</span>
<span class="lineNum">     301 </span>                :<span class="lineNoCov">          0 :     e-&gt;reading = e-&gt;writing = 0;</span>
<span class="lineNum">     302 </span>                :            : 
<span class="lineNum">     303 </span>                :            :     /* Register functions to start/stop listening for events */
<span class="lineNum">     304 </span>                :<span class="lineNoCov">          0 :     ac-&gt;ev.addRead = redisAeAddRead;</span>
<span class="lineNum">     305 </span>                :<span class="lineNoCov">          0 :     ac-&gt;ev.delRead = redisAeDelRead;</span>
<span class="lineNum">     306 </span>                :<span class="lineNoCov">          0 :     ac-&gt;ev.addWrite = redisAeAddWrite;</span>
<span class="lineNum">     307 </span>                :<span class="lineNoCov">          0 :     ac-&gt;ev.delWrite = redisAeDelWrite;</span>
<span class="lineNum">     308 </span>                :<span class="lineNoCov">          0 :     ac-&gt;ev.cleanup = redisAeCleanup;</span>
<span class="lineNum">     309 </span>                :<span class="lineNoCov">          0 :     ac-&gt;ev.data = e;</span>
<span class="lineNum">     310 </span>                :            : 
<span class="lineNum">     311 </span>                :            :     return REDIS_OK;
<span class="lineNum">     312 </span>                :            : }
<span class="lineNum">     313 </span>                :            : 
<span class="lineNum">     314 </span>                :            : /* ============================= Prototypes ================================= */
<span class="lineNum">     315 </span>                :            : 
<span class="lineNum">     316 </span>                :            : void sentinelLinkEstablishedCallback(const redisAsyncContext *c, int status);
<span class="lineNum">     317 </span>                :            : void sentinelDisconnectCallback(const redisAsyncContext *c, int status);
<span class="lineNum">     318 </span>                :            : void sentinelReceiveHelloMessages(redisAsyncContext *c, void *reply, void *privdata);
<span class="lineNum">     319 </span>                :            : sentinelRedisInstance *sentinelGetMasterByName(char *name);
<span class="lineNum">     320 </span>                :            : char *sentinelGetSubjectiveLeader(sentinelRedisInstance *master);
<span class="lineNum">     321 </span>                :            : char *sentinelGetObjectiveLeader(sentinelRedisInstance *master);
<span class="lineNum">     322 </span>                :            : int yesnotoi(char *s);
<span class="lineNum">     323 </span>                :            : void sentinelDisconnectInstanceFromContext(const redisAsyncContext *c);
<span class="lineNum">     324 </span>                :            : void sentinelKillLink(sentinelRedisInstance *ri, redisAsyncContext *c);
<span class="lineNum">     325 </span>                :            : const char *sentinelRedisInstanceTypeStr(sentinelRedisInstance *ri);
<span class="lineNum">     326 </span>                :            : void sentinelAbortFailover(sentinelRedisInstance *ri);
<span class="lineNum">     327 </span>                :            : void sentinelEvent(int level, char *type, sentinelRedisInstance *ri, const char *fmt, ...);
<span class="lineNum">     328 </span>                :            : sentinelRedisInstance *sentinelSelectSlave(sentinelRedisInstance *master);
<span class="lineNum">     329 </span>                :            : void sentinelScheduleScriptExecution(char *path, ...);
<span class="lineNum">     330 </span>                :            : void sentinelStartFailover(sentinelRedisInstance *master, int state);
<span class="lineNum">     331 </span>                :            : void sentinelDiscardReplyCallback(redisAsyncContext *c, void *reply, void *privdata);
<span class="lineNum">     332 </span>                :            : 
<span class="lineNum">     333 </span>                :            : /* ========================= Dictionary types =============================== */
<span class="lineNum">     334 </span>                :            : 
<span class="lineNum">     335 </span>                :            : unsigned int dictSdsHash(const void *key);
<span class="lineNum">     336 </span>                :            : int dictSdsKeyCompare(void *privdata, const void *key1, const void *key2);
<a name="337"><span class="lineNum">     337 </span>                :            : void releaseSentinelRedisInstance(sentinelRedisInstance *ri);</a>
<span class="lineNum">     338 </span>                :            : 
<span class="lineNum">     339 </span>                :<span class="lineNoCov">          0 : void dictInstancesValDestructor (void *privdata, void *obj) {</span>
<span class="lineNum">     340 </span>                :<span class="lineNoCov">          0 :     releaseSentinelRedisInstance(obj);</span>
<span class="lineNum">     341 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     342 </span>                :            : 
<span class="lineNum">     343 </span>                :            : /* Instance name (sds) -&gt; instance (sentinelRedisInstance pointer)
<span class="lineNum">     344 </span>                :            :  *
<span class="lineNum">     345 </span>                :            :  * also used for: sentinelRedisInstance-&gt;sentinels dictionary that maps
<span class="lineNum">     346 </span>                :            :  * sentinels ip:port to last seen time in Pub/Sub hello message. */
<span class="lineNum">     347 </span>                :            : dictType instancesDictType = {
<span class="lineNum">     348 </span>                :            :     dictSdsHash,               /* hash function */
<span class="lineNum">     349 </span>                :            :     NULL,                      /* key dup */
<span class="lineNum">     350 </span>                :            :     NULL,                      /* val dup */
<span class="lineNum">     351 </span>                :            :     dictSdsKeyCompare,         /* key compare */
<span class="lineNum">     352 </span>                :            :     NULL,                      /* key destructor */
<span class="lineNum">     353 </span>                :            :     dictInstancesValDestructor /* val destructor */
<span class="lineNum">     354 </span>                :            : };
<span class="lineNum">     355 </span>                :            : 
<span class="lineNum">     356 </span>                :            : /* Instance runid (sds) -&gt; votes (long casted to void*)
<span class="lineNum">     357 </span>                :            :  *
<span class="lineNum">     358 </span>                :            :  * This is useful into sentinelGetObjectiveLeader() function in order to
<span class="lineNum">     359 </span>                :            :  * count the votes and understand who is the leader. */
<span class="lineNum">     360 </span>                :            : dictType leaderVotesDictType = {
<span class="lineNum">     361 </span>                :            :     dictSdsHash,               /* hash function */
<span class="lineNum">     362 </span>                :            :     NULL,                      /* key dup */
<span class="lineNum">     363 </span>                :            :     NULL,                      /* val dup */
<span class="lineNum">     364 </span>                :            :     dictSdsKeyCompare,         /* key compare */
<span class="lineNum">     365 </span>                :            :     NULL,                      /* key destructor */
<span class="lineNum">     366 </span>                :            :     NULL                       /* val destructor */
<span class="lineNum">     367 </span>                :            : };
<span class="lineNum">     368 </span>                :            : 
<span class="lineNum">     369 </span>                :            : /* =========================== Initialization =============================== */
<span class="lineNum">     370 </span>                :            : 
<span class="lineNum">     371 </span>                :            : void sentinelCommand(redisClient *c);
<span class="lineNum">     372 </span>                :            : void sentinelInfoCommand(redisClient *c);
<span class="lineNum">     373 </span>                :            : 
<span class="lineNum">     374 </span>                :            : struct redisCommand sentinelcmds[] = {
<span class="lineNum">     375 </span>                :            :     {&quot;ping&quot;,pingCommand,1,&quot;&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     376 </span>                :            :     {&quot;sentinel&quot;,sentinelCommand,-2,&quot;&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     377 </span>                :            :     {&quot;subscribe&quot;,subscribeCommand,-2,&quot;&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     378 </span>                :            :     {&quot;unsubscribe&quot;,unsubscribeCommand,-1,&quot;&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     379 </span>                :            :     {&quot;psubscribe&quot;,psubscribeCommand,-2,&quot;&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     380 </span>                :            :     {&quot;punsubscribe&quot;,punsubscribeCommand,-1,&quot;&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     381 </span>                :            :     {&quot;info&quot;,sentinelInfoCommand,-1,&quot;&quot;,0,NULL,0,0,0,0,0}
<span class="lineNum">     382 </span>                :            : };
<span class="lineNum">     383 </span>                :            : 
<a name="384"><span class="lineNum">     384 </span>                :            : /* This function overwrites a few normal Redis config default with Sentinel</a>
<span class="lineNum">     385 </span>                :            :  * specific defaults. */
<span class="lineNum">     386 </span>                :<span class="lineNoCov">          0 : void initSentinelConfig(void) {</span>
<span class="lineNum">     387 </span>                :<span class="lineNoCov">          0 :     server.port = REDIS_SENTINEL_PORT;</span>
<span class="lineNum">     388 </span>                :<span class="lineNoCov">          0 : }</span>
<a name="389"><span class="lineNum">     389 </span>                :            : </a>
<span class="lineNum">     390 </span>                :            : /* Perform the Sentinel mode initialization. */
<span class="lineNum">     391 </span>                :<span class="lineNoCov">          0 : void initSentinel(void) {</span>
<span class="lineNum">     392 </span>                :            :     int j;
<span class="lineNum">     393 </span>                :            : 
<span class="lineNum">     394 </span>                :            :     /* Remove usual Redis commands from the command table, then just add
<span class="lineNum">     395 </span>                :            :      * the SENTINEL command. */
<span class="lineNum">     396 </span>                :<span class="lineNoCov">          0 :     dictEmpty(server.commands);</span>
<span class="lineNum">     397 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (j = 0; j &lt; sizeof(sentinelcmds)/sizeof(sentinelcmds[0]); j++) {</span>
<span class="lineNum">     398 </span>                :            :         int retval;
<span class="lineNum">     399 </span>                :<span class="lineNoCov">          0 :         struct redisCommand *cmd = sentinelcmds+j;</span>
<span class="lineNum">     400 </span>                :            : 
<span class="lineNum">     401 </span>                :<span class="lineNoCov">          0 :         retval = dictAdd(server.commands, sdsnew(cmd-&gt;name), cmd);</span>
<span class="lineNum">     402 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         redisAssert(retval == DICT_OK);</span>
<span class="lineNum">     403 </span>                :            :     }
<span class="lineNum">     404 </span>                :            : 
<span class="lineNum">     405 </span>                :            :     /* Initialize various data structures. */
<span class="lineNum">     406 </span>                :<span class="lineNoCov">          0 :     sentinel.masters = dictCreate(&amp;instancesDictType,NULL);</span>
<span class="lineNum">     407 </span>                :<span class="lineNoCov">          0 :     sentinel.tilt = 0;</span>
<span class="lineNum">     408 </span>                :<span class="lineNoCov">          0 :     sentinel.tilt_start_time = 0;</span>
<span class="lineNum">     409 </span>                :<span class="lineNoCov">          0 :     sentinel.previous_time = mstime();</span>
<span class="lineNum">     410 </span>                :<span class="lineNoCov">          0 :     sentinel.running_scripts = 0;</span>
<span class="lineNum">     411 </span>                :<span class="lineNoCov">          0 :     sentinel.scripts_queue = listCreate();</span>
<span class="lineNum">     412 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     413 </span>                :            : 
<span class="lineNum">     414 </span>                :            : /* ============================== sentinelAddr ============================== */
<span class="lineNum">     415 </span>                :            : 
<span class="lineNum">     416 </span>                :            : /* Create a sentinelAddr object and return it on success.
<span class="lineNum">     417 </span>                :            :  * On error NULL is returned and errno is set to:
<span class="lineNum">     418 </span>                :            :  *  ENOENT: Can't resolve the hostname.
<a name="419"><span class="lineNum">     419 </span>                :            :  *  EINVAL: Invalid port number.</a>
<span class="lineNum">     420 </span>                :            :  */
<span class="lineNum">     421 </span>                :<span class="lineNoCov">          0 : sentinelAddr *createSentinelAddr(char *hostname, int port) {</span>
<span class="lineNum">     422 </span>                :            :     char buf[32];
<span class="lineNum">     423 </span>                :            :     sentinelAddr *sa;
<span class="lineNum">     424 </span>                :            : 
<span class="lineNum">     425 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (port &lt;= 0 || port &gt; 65535) {</span>
<span class="lineNum">     426 </span>                :<span class="lineNoCov">          0 :         errno = EINVAL;</span>
<span class="lineNum">     427 </span>                :<span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">     428 </span>                :            :     }
<span class="lineNum">     429 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (anetResolve(NULL,hostname,buf,sizeof(buf)) == ANET_ERR) {</span>
<span class="lineNum">     430 </span>                :<span class="lineNoCov">          0 :         errno = ENOENT;</span>
<span class="lineNum">     431 </span>                :<span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">     432 </span>                :            :     }
<span class="lineNum">     433 </span>                :<span class="lineNoCov">          0 :     sa = zmalloc(sizeof(*sa));</span>
<span class="lineNum">     434 </span>                :<span class="lineNoCov">          0 :     sa-&gt;ip = sdsnew(buf);</span>
<span class="lineNum">     435 </span>                :<span class="lineNoCov">          0 :     sa-&gt;port = port;</span>
<span class="lineNum">     436 </span>                :<span class="lineNoCov">          0 :     return sa;</span>
<span class="lineNum">     437 </span>                :            : }
<a name="438"><span class="lineNum">     438 </span>                :            : </a>
<span class="lineNum">     439 </span>                :            : /* Free a Sentinel address. Can't fail. */
<span class="lineNum">     440 </span>                :<span class="lineNoCov">          0 : void releaseSentinelAddr(sentinelAddr *sa) {</span>
<span class="lineNum">     441 </span>                :<span class="lineNoCov">          0 :     sdsfree(sa-&gt;ip);</span>
<span class="lineNum">     442 </span>                :<span class="lineNoCov">          0 :     zfree(sa);</span>
<span class="lineNum">     443 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     444 </span>                :            : 
<span class="lineNum">     445 </span>                :            : /* =========================== Events notification ========================== */
<span class="lineNum">     446 </span>                :            : 
<span class="lineNum">     447 </span>                :            : /* Send an event to log, pub/sub, user notification script.
<span class="lineNum">     448 </span>                :            :  * 
<span class="lineNum">     449 </span>                :            :  * 'level' is the log level for logging. Only REDIS_WARNING events will trigger
<span class="lineNum">     450 </span>                :            :  * the execution of the user notification script.
<span class="lineNum">     451 </span>                :            :  *
<span class="lineNum">     452 </span>                :            :  * 'type' is the message type, also used as a pub/sub channel name.
<span class="lineNum">     453 </span>                :            :  *
<span class="lineNum">     454 </span>                :            :  * 'ri', is the redis instance target of this event if applicable, and is
<span class="lineNum">     455 </span>                :            :  * used to obtain the path of the notification script to execute.
<span class="lineNum">     456 </span>                :            :  *
<span class="lineNum">     457 </span>                :            :  * The remaining arguments are printf-alike.
<span class="lineNum">     458 </span>                :            :  * If the format specifier starts with the two characters &quot;%@&quot; then ri is
<span class="lineNum">     459 </span>                :            :  * not NULL, and the message is prefixed with an instance identifier in the
<span class="lineNum">     460 </span>                :            :  * following format:
<span class="lineNum">     461 </span>                :            :  *
<span class="lineNum">     462 </span>                :            :  *  &lt;instance type&gt; &lt;instance name&gt; &lt;ip&gt; &lt;port&gt;
<span class="lineNum">     463 </span>                :            :  *
<span class="lineNum">     464 </span>                :            :  *  If the instance type is not master, than the additional string is
<span class="lineNum">     465 </span>                :            :  *  added to specify the originating master:
<span class="lineNum">     466 </span>                :            :  *
<span class="lineNum">     467 </span>                :            :  *  @ &lt;master name&gt; &lt;master ip&gt; &lt;master port&gt;
<span class="lineNum">     468 </span>                :            :  *
<a name="469"><span class="lineNum">     469 </span>                :            :  *  Any other specifier after &quot;%@&quot; is processed by printf itself.</a>
<span class="lineNum">     470 </span>                :            :  */
<span class="lineNum">     471 </span>                :<span class="lineNoCov">          0 : void sentinelEvent(int level, char *type, sentinelRedisInstance *ri,</span>
<span class="lineNum">     472 </span>                :            :                    const char *fmt, ...) {
<span class="lineNum">     473 </span>                :            :     va_list ap;
<span class="lineNum">     474 </span>                :            :     char msg[REDIS_MAX_LOGMSG_LEN];
<span class="lineNum">     475 </span>                :            :     robj *channel, *payload;
<span class="lineNum">     476 </span>                :            : 
<span class="lineNum">     477 </span>                :            :     /* Handle %@ */
<span class="lineNum">     478 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (fmt[0] == '%' &amp;&amp; fmt[1] == '@') {</span>
<span class="lineNum">     479 </span>                :<span class="lineNoCov">          0 :         sentinelRedisInstance *master = (ri-&gt;flags &amp; SRI_MASTER) ?</span>
<span class="lineNum">     480 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                          NULL : ri-&gt;master;</span>
<span class="lineNum">     481 </span>                :            : 
<span class="lineNum">     482 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (master) {</span>
<span class="lineNum">     483 </span>                :<span class="lineNoCov">          0 :             snprintf(msg, sizeof(msg), &quot;%s %s %s %d @ %s %s %d&quot;,</span>
<span class="lineNum">     484 </span>                :            :                 sentinelRedisInstanceTypeStr(ri),
<span class="lineNum">     485 </span>                :<span class="lineNoCov">          0 :                 ri-&gt;name, ri-&gt;addr-&gt;ip, ri-&gt;addr-&gt;port,</span>
<span class="lineNum">     486 </span>                :<span class="lineNoCov">          0 :                 master-&gt;name, master-&gt;addr-&gt;ip, master-&gt;addr-&gt;port);</span>
<span class="lineNum">     487 </span>                :            :         } else {
<span class="lineNum">     488 </span>                :<span class="lineNoCov">          0 :             snprintf(msg, sizeof(msg), &quot;%s %s %s %d&quot;,</span>
<span class="lineNum">     489 </span>                :            :                 sentinelRedisInstanceTypeStr(ri),
<span class="lineNum">     490 </span>                :<span class="lineNoCov">          0 :                 ri-&gt;name, ri-&gt;addr-&gt;ip, ri-&gt;addr-&gt;port);</span>
<span class="lineNum">     491 </span>                :            :         }
<span class="lineNum">     492 </span>                :<span class="lineNoCov">          0 :         fmt += 2;</span>
<span class="lineNum">     493 </span>                :            :     } else {
<span class="lineNum">     494 </span>                :<span class="lineNoCov">          0 :         msg[0] = '\0';</span>
<span class="lineNum">     495 </span>                :            :     }
<span class="lineNum">     496 </span>                :            : 
<span class="lineNum">     497 </span>                :            :     /* Use vsprintf for the rest of the formatting if any. */
<span class="lineNum">     498 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (fmt[0] != '\0') {</span>
<span class="lineNum">     499 </span>                :<span class="lineNoCov">          0 :         va_start(ap, fmt);</span>
<span class="lineNum">     500 </span>                :<span class="lineNoCov">          0 :         vsnprintf(msg+strlen(msg), sizeof(msg)-strlen(msg), fmt, ap);</span>
<span class="lineNum">     501 </span>                :<span class="lineNoCov">          0 :         va_end(ap);</span>
<span class="lineNum">     502 </span>                :            :     }
<span class="lineNum">     503 </span>                :            : 
<span class="lineNum">     504 </span>                :            :     /* Log the message if the log level allows it to be logged. */
<span class="lineNum">     505 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (level &gt;= server.verbosity)</span>
<span class="lineNum">     506 </span>                :<span class="lineNoCov">          0 :         redisLog(level,&quot;%s %s&quot;,type,msg);</span>
<span class="lineNum">     507 </span>                :            : 
<span class="lineNum">     508 </span>                :            :     /* Publish the message via Pub/Sub if it's not a debugging one. */
<span class="lineNum">     509 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (level != REDIS_DEBUG) {</span>
<span class="lineNum">     510 </span>                :<span class="lineNoCov">          0 :         channel = createStringObject(type,strlen(type));</span>
<span class="lineNum">     511 </span>                :<span class="lineNoCov">          0 :         payload = createStringObject(msg,strlen(msg));</span>
<span class="lineNum">     512 </span>                :<span class="lineNoCov">          0 :         pubsubPublishMessage(channel,payload);</span>
<span class="lineNum">     513 </span>                :<span class="lineNoCov">          0 :         decrRefCount(channel);</span>
<span class="lineNum">     514 </span>                :<span class="lineNoCov">          0 :         decrRefCount(payload);</span>
<span class="lineNum">     515 </span>                :            :     }
<span class="lineNum">     516 </span>                :            : 
<span class="lineNum">     517 </span>                :            :     /* Call the notification script if applicable. */
<span class="lineNum">     518 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (level == REDIS_WARNING &amp;&amp; ri != NULL) {</span>
<span class="lineNum">     519 </span>                :<span class="lineNoCov">          0 :         sentinelRedisInstance *master = (ri-&gt;flags &amp; SRI_MASTER) ?</span>
<span class="lineNum">     520 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                          ri : ri-&gt;master;</span>
<span class="lineNum">     521 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (master-&gt;notification_script) {</span>
<span class="lineNum">     522 </span>                :<span class="lineNoCov">          0 :             sentinelScheduleScriptExecution(master-&gt;notification_script,</span>
<span class="lineNum">     523 </span>                :            :                 type,msg,NULL);
<span class="lineNum">     524 </span>                :            :         }
<span class="lineNum">     525 </span>                :            :     }
<span class="lineNum">     526 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     527 </span>                :            : 
<span class="lineNum">     528 </span>                :            : /* ============================ script execution ============================ */
<a name="529"><span class="lineNum">     529 </span>                :            : </a>
<span class="lineNum">     530 </span>                :            : /* Release a script job structure and all the associated data. */
<span class="lineNum">     531 </span>                :<span class="lineNoCov">          0 : void sentinelReleaseScriptJob(sentinelScriptJob *sj) {</span>
<span class="lineNum">     532 </span>                :<span class="lineNoCov">          0 :     int j = 0;</span>
<span class="lineNum">     533 </span>                :            : 
<span class="lineNum">     534 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while(sj-&gt;argv[j]) sdsfree(sj-&gt;argv[j++]);</span>
<span class="lineNum">     535 </span>                :<span class="lineNoCov">          0 :     zfree(sj-&gt;argv);</span>
<span class="lineNum">     536 </span>                :<span class="lineNoCov">          0 :     zfree(sj);</span>
<span class="lineNum">     537 </span>                :<span class="lineNoCov">          0 : }</span>
<a name="538"><span class="lineNum">     538 </span>                :            : </a>
<span class="lineNum">     539 </span>                :            : #define SENTINEL_SCRIPT_MAX_ARGS 16
<span class="lineNum">     540 </span>                :<span class="lineNoCov">          0 : void sentinelScheduleScriptExecution(char *path, ...) {</span>
<span class="lineNum">     541 </span>                :            :     va_list ap;
<span class="lineNum">     542 </span>                :            :     char *argv[SENTINEL_SCRIPT_MAX_ARGS+1];
<span class="lineNum">     543 </span>                :<span class="lineNoCov">          0 :     int argc = 1;</span>
<span class="lineNum">     544 </span>                :            :     sentinelScriptJob *sj;
<span class="lineNum">     545 </span>                :            : 
<span class="lineNum">     546 </span>                :<span class="lineNoCov">          0 :     va_start(ap, path);</span>
<span class="lineNum">     547 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while(argc &lt; SENTINEL_SCRIPT_MAX_ARGS) {</span>
<span class="lineNum">     548 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         argv[argc] = va_arg(ap,char*);</span>
<span class="lineNum">     549 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!argv[argc]) break;</span>
<span class="lineNum">     550 </span>                :<span class="lineNoCov">          0 :         argv[argc] = sdsnew(argv[argc]); /* Copy the string. */</span>
<span class="lineNum">     551 </span>                :<span class="lineNoCov">          0 :         argc++;</span>
<span class="lineNum">     552 </span>                :            :     }
<span class="lineNum">     553 </span>                :<span class="lineNoCov">          0 :     va_end(ap);</span>
<span class="lineNum">     554 </span>                :<span class="lineNoCov">          0 :     argv[0] = sdsnew(path);</span>
<span class="lineNum">     555 </span>                :            :     
<span class="lineNum">     556 </span>                :<span class="lineNoCov">          0 :     sj = zmalloc(sizeof(*sj));</span>
<span class="lineNum">     557 </span>                :<span class="lineNoCov">          0 :     sj-&gt;flags = SENTINEL_SCRIPT_NONE;</span>
<span class="lineNum">     558 </span>                :<span class="lineNoCov">          0 :     sj-&gt;retry_num = 0;</span>
<span class="lineNum">     559 </span>                :<span class="lineNoCov">          0 :     sj-&gt;argv = zmalloc(sizeof(char*)*(argc+1));</span>
<span class="lineNum">     560 </span>                :<span class="lineNoCov">          0 :     sj-&gt;start_time = 0;</span>
<span class="lineNum">     561 </span>                :<span class="lineNoCov">          0 :     sj-&gt;pid = 0;</span>
<span class="lineNum">     562 </span>                :<span class="lineNoCov">          0 :     memcpy(sj-&gt;argv,argv,sizeof(char*)*(argc+1));</span>
<span class="lineNum">     563 </span>                :            : 
<span class="lineNum">     564 </span>                :<span class="lineNoCov">          0 :     listAddNodeTail(sentinel.scripts_queue,sj);</span>
<span class="lineNum">     565 </span>                :            : 
<span class="lineNum">     566 </span>                :            :     /* Remove the oldest non running script if we already hit the limit. */
<span class="lineNum">     567 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (listLength(sentinel.scripts_queue) &gt; SENTINEL_SCRIPT_MAX_QUEUE) {</span>
<span class="lineNum">     568 </span>                :            :         listNode *ln;
<span class="lineNum">     569 </span>                :            :         listIter li;
<span class="lineNum">     570 </span>                :            : 
<span class="lineNum">     571 </span>                :<span class="lineNoCov">          0 :         listRewind(sentinel.scripts_queue,&amp;li);</span>
<span class="lineNum">     572 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         while ((ln = listNext(&amp;li)) != NULL) {</span>
<span class="lineNum">     573 </span>                :<span class="lineNoCov">          0 :             sj = ln-&gt;value;</span>
<span class="lineNum">     574 </span>                :            : 
<span class="lineNum">     575 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (sj-&gt;flags &amp; SENTINEL_SCRIPT_RUNNING) continue;</span>
<span class="lineNum">     576 </span>                :            :             /* The first node is the oldest as we add on tail. */
<span class="lineNum">     577 </span>                :<span class="lineNoCov">          0 :             listDelNode(sentinel.scripts_queue,ln);</span>
<span class="lineNum">     578 </span>                :<span class="lineNoCov">          0 :             sentinelReleaseScriptJob(sj);</span>
<span class="lineNum">     579 </span>                :<span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     580 </span>                :            :         }
<span class="lineNum">     581 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         redisAssert(listLength(sentinel.scripts_queue) &lt;=</span>
<span class="lineNum">     582 </span>                :            :                     SENTINEL_SCRIPT_MAX_QUEUE);
<span class="lineNum">     583 </span>                :            :     }
<span class="lineNum">     584 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     585 </span>                :            : 
<a name="586"><span class="lineNum">     586 </span>                :            : /* Lookup a script in the scripts queue via pid, and returns the list node</a>
<span class="lineNum">     587 </span>                :            :  * (so that we can easily remove it from the queue if needed). */
<span class="lineNum">     588 </span>                :<span class="lineNoCov">          0 : listNode *sentinelGetScriptListNodeByPid(pid_t pid) {</span>
<span class="lineNum">     589 </span>                :            :     listNode *ln;
<span class="lineNum">     590 </span>                :            :     listIter li;
<span class="lineNum">     591 </span>                :            : 
<span class="lineNum">     592 </span>                :<span class="lineNoCov">          0 :     listRewind(sentinel.scripts_queue,&amp;li);</span>
<span class="lineNum">     593 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while ((ln = listNext(&amp;li)) != NULL) {</span>
<span class="lineNum">     594 </span>                :<span class="lineNoCov">          0 :         sentinelScriptJob *sj = ln-&gt;value;</span>
<span class="lineNum">     595 </span>                :            : 
<span class="lineNum">     596 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ((sj-&gt;flags &amp; SENTINEL_SCRIPT_RUNNING) &amp;&amp; sj-&gt;pid == pid)</span>
<span class="lineNum">     597 </span>                :            :             return ln;
<span class="lineNum">     598 </span>                :            :     }
<span class="lineNum">     599 </span>                :            :     return NULL;
<span class="lineNum">     600 </span>                :            : }
<span class="lineNum">     601 </span>                :            : 
<a name="602"><span class="lineNum">     602 </span>                :            : /* Run pending scripts if we are not already at max number of running</a>
<span class="lineNum">     603 </span>                :            :  * scripts. */
<span class="lineNum">     604 </span>                :<span class="lineNoCov">          0 : void sentinelRunPendingScripts(void) {</span>
<span class="lineNum">     605 </span>                :            :     listNode *ln;
<span class="lineNum">     606 </span>                :            :     listIter li;
<span class="lineNum">     607 </span>                :<span class="lineNoCov">          0 :     mstime_t now = mstime();</span>
<span class="lineNum">     608 </span>                :            : 
<span class="lineNum">     609 </span>                :            :     /* Find jobs that are not running and run them, from the top to the
<span class="lineNum">     610 </span>                :            :      * tail of the queue, so we run older jobs first. */
<span class="lineNum">     611 </span>                :<span class="lineNoCov">          0 :     listRewind(sentinel.scripts_queue,&amp;li);</span>
<span class="lineNum">     612 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while (sentinel.running_scripts &lt; SENTINEL_SCRIPT_MAX_RUNNING &amp;&amp;</span>
<span class="lineNum">     613 </span>                :            :            (ln = listNext(&amp;li)) != NULL)
<span class="lineNum">     614 </span>                :            :     {
<span class="lineNum">     615 </span>                :<span class="lineNoCov">          0 :         sentinelScriptJob *sj = ln-&gt;value;</span>
<span class="lineNum">     616 </span>                :            :         pid_t pid;
<span class="lineNum">     617 </span>                :            : 
<span class="lineNum">     618 </span>                :            :         /* Skip if already running. */
<span class="lineNum">     619 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (sj-&gt;flags &amp; SENTINEL_SCRIPT_RUNNING) continue;</span>
<span class="lineNum">     620 </span>                :            : 
<span class="lineNum">     621 </span>                :            :         /* Skip if it's a retry, but not enough time has elapsed. */
<span class="lineNum">     622 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (sj-&gt;start_time &amp;&amp; sj-&gt;start_time &gt; now) continue;</span>
<span class="lineNum">     623 </span>                :            : 
<span class="lineNum">     624 </span>                :<span class="lineNoCov">          0 :         sj-&gt;flags |= SENTINEL_SCRIPT_RUNNING;</span>
<span class="lineNum">     625 </span>                :<span class="lineNoCov">          0 :         sj-&gt;start_time = mstime();</span>
<span class="lineNum">     626 </span>                :<span class="lineNoCov">          0 :         sj-&gt;retry_num++;</span>
<span class="lineNum">     627 </span>                :<span class="lineNoCov">          0 :         pid = fork();</span>
<span class="lineNum">     628 </span>                :            : 
<span class="lineNum">     629 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (pid == -1) {</span>
<span class="lineNum">     630 </span>                :            :             /* Parent (fork error).
<span class="lineNum">     631 </span>                :            :              * We report fork errors as signal 99, in order to unify the
<span class="lineNum">     632 </span>                :            :              * reporting with other kind of errors. */
<span class="lineNum">     633 </span>                :<span class="lineNoCov">          0 :             sentinelEvent(REDIS_WARNING,&quot;-script-error&quot;,NULL,</span>
<span class="lineNum">     634 </span>                :<span class="lineNoCov">          0 :                           &quot;%s %d %d&quot;, sj-&gt;argv[0], 99, 0);</span>
<span class="lineNum">     635 </span>                :<span class="lineNoCov">          0 :             sj-&gt;flags &amp;= ~SENTINEL_SCRIPT_RUNNING;</span>
<span class="lineNum">     636 </span>                :<span class="lineNoCov">          0 :             sj-&gt;pid = 0;</span>
<span class="lineNum">     637 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         } else if (pid == 0) {</span>
<span class="lineNum">     638 </span>                :            :             /* Child */
<span class="lineNum">     639 </span>                :<span class="lineNoCov">          0 :             execve(sj-&gt;argv[0],sj-&gt;argv,environ);</span>
<span class="lineNum">     640 </span>                :            :             /* If we are here an error occurred. */
<span class="lineNum">     641 </span>                :<span class="lineNoCov">          0 :             _exit(2); /* Don't retry execution. */</span>
<span class="lineNum">     642 </span>                :            :         } else {
<span class="lineNum">     643 </span>                :<span class="lineNoCov">          0 :             sentinel.running_scripts++;</span>
<span class="lineNum">     644 </span>                :<span class="lineNoCov">          0 :             sj-&gt;pid = pid;</span>
<span class="lineNum">     645 </span>                :<span class="lineNoCov">          0 :             sentinelEvent(REDIS_DEBUG,&quot;+script-child&quot;,NULL,&quot;%ld&quot;,(long)pid);</span>
<span class="lineNum">     646 </span>                :            :         }
<span class="lineNum">     647 </span>                :            :     }
<span class="lineNum">     648 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     649 </span>                :            : 
<span class="lineNum">     650 </span>                :            : /* How much to delay the execution of a script that we need to retry after
<span class="lineNum">     651 </span>                :            :  * an error?
<span class="lineNum">     652 </span>                :            :  *
<span class="lineNum">     653 </span>                :            :  * We double the retry delay for every further retry we do. So for instance
<span class="lineNum">     654 </span>                :            :  * if RETRY_DELAY is set to 30 seconds and the max number of retries is 10
<a name="655"><span class="lineNum">     655 </span>                :            :  * starting from the second attempt to execute the script the delays are:</a>
<a name="656"><span class="lineNum">     656 </span>                :            :  * 30 sec, 60 sec, 2 min, 4 min, 8 min, 16 min, 32 min, 64 min, 128 min. */</a>
<span class="lineNum">     657 </span>                :<span class="lineNoCov">          0 : mstime_t sentinelScriptRetryDelay(int retry_num) {</span>
<span class="lineNum">     658 </span>                :<span class="lineNoCov">          0 :     mstime_t delay = SENTINEL_SCRIPT_RETRY_DELAY;</span>
<span class="lineNum">     659 </span>                :            : 
<span class="lineNum">     660 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while (retry_num-- &gt; 1) delay *= 2;</span>
<span class="lineNum">     661 </span>                :<span class="lineNoCov">          0 :     return delay;</span>
<span class="lineNum">     662 </span>                :            : }
<span class="lineNum">     663 </span>                :            : 
<span class="lineNum">     664 </span>                :            : /* Check for scripts that terminated, and remove them from the queue if the
<span class="lineNum">     665 </span>                :            :  * script terminated successfully. If instead the script was terminated by
<span class="lineNum">     666 </span>                :            :  * a signal, or returned exit code &quot;1&quot;, it is scheduled to run again if
<span class="lineNum">     667 </span>                :            :  * the max number of retries did not already elapsed. */
<span class="lineNum">     668 </span>                :<span class="lineNoCov">          0 : void sentinelCollectTerminatedScripts(void) {</span>
<span class="lineNum">     669 </span>                :            :     int statloc;
<span class="lineNum">     670 </span>                :            :     pid_t pid;
<span class="lineNum">     671 </span>                :            : 
<span class="lineNum">     672 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while ((pid = wait3(&amp;statloc,WNOHANG,NULL)) &gt; 0) {</span>
<span class="lineNum">     673 </span>                :<span class="lineNoCov">          0 :         int exitcode = WEXITSTATUS(statloc);</span>
<span class="lineNum">     674 </span>                :<span class="lineNoCov">          0 :         int bysignal = 0;</span>
<span class="lineNum">     675 </span>                :            :         listNode *ln;
<span class="lineNum">     676 </span>                :            :         sentinelScriptJob *sj;
<span class="lineNum">     677 </span>                :            : 
<span class="lineNum">     678 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (WIFSIGNALED(statloc)) bysignal = WTERMSIG(statloc);</span>
<span class="lineNum">     679 </span>                :<span class="lineNoCov">          0 :         sentinelEvent(REDIS_DEBUG,&quot;-script-child&quot;,NULL,&quot;%ld %d %d&quot;,</span>
<span class="lineNum">     680 </span>                :            :             (long)pid, exitcode, bysignal);
<span class="lineNum">     681 </span>                :            :         
<span class="lineNum">     682 </span>                :<span class="lineNoCov">          0 :         ln = sentinelGetScriptListNodeByPid(pid);</span>
<span class="lineNum">     683 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ln == NULL) {</span>
<span class="lineNum">     684 </span>                :<span class="lineNoCov">          0 :             redisLog(REDIS_WARNING,&quot;wait3() returned a pid (%ld) we can't find in our scripts execution queue!&quot;, (long)pid);</span>
<span class="lineNum">     685 </span>                :<span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     686 </span>                :            :         }
<span class="lineNum">     687 </span>                :<span class="lineNoCov">          0 :         sj = ln-&gt;value;</span>
<span class="lineNum">     688 </span>                :            : 
<span class="lineNum">     689 </span>                :            :         /* If the script was terminated by a signal or returns an
<span class="lineNum">     690 </span>                :            :          * exit code of &quot;1&quot; (that means: please retry), we reschedule it
<span class="lineNum">     691 </span>                :            :          * if the max number of retries is not already reached. */
<span class="lineNum">     692 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ((bysignal || exitcode == 1) &amp;&amp;</span>
<span class="lineNum">     693 </span>                :<span class="lineNoCov">          0 :             sj-&gt;retry_num != SENTINEL_SCRIPT_MAX_RETRY)</span>
<span class="lineNum">     694 </span>                :            :         {
<span class="lineNum">     695 </span>                :<span class="lineNoCov">          0 :             sj-&gt;flags &amp;= ~SENTINEL_SCRIPT_RUNNING;</span>
<span class="lineNum">     696 </span>                :<span class="lineNoCov">          0 :             sj-&gt;pid = 0;</span>
<span class="lineNum">     697 </span>                :<span class="lineNoCov">          0 :             sj-&gt;start_time = mstime() +</span>
<span class="lineNum">     698 </span>                :<span class="lineNoCov">          0 :                              sentinelScriptRetryDelay(sj-&gt;retry_num);</span>
<span class="lineNum">     699 </span>                :            :         } else {
<span class="lineNum">     700 </span>                :            :             /* Otherwise let's remove the script, but log the event if the
<span class="lineNum">     701 </span>                :            :              * execution did not terminated in the best of the ways. */
<span class="lineNum">     702 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (bysignal || exitcode != 0) {</span>
<span class="lineNum">     703 </span>                :<span class="lineNoCov">          0 :                 sentinelEvent(REDIS_WARNING,&quot;-script-error&quot;,NULL,</span>
<span class="lineNum">     704 </span>                :<span class="lineNoCov">          0 :                               &quot;%s %d %d&quot;, sj-&gt;argv[0], bysignal, exitcode);</span>
<span class="lineNum">     705 </span>                :            :             }
<span class="lineNum">     706 </span>                :<span class="lineNoCov">          0 :             listDelNode(sentinel.scripts_queue,ln);</span>
<span class="lineNum">     707 </span>                :<span class="lineNoCov">          0 :             sentinelReleaseScriptJob(sj);</span>
<span class="lineNum">     708 </span>                :<span class="lineNoCov">          0 :             sentinel.running_scripts--;</span>
<span class="lineNum">     709 </span>                :            :         }
<span class="lineNum">     710 </span>                :            :     }
<span class="lineNum">     711 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     712 </span>                :            : 
<a name="713"><span class="lineNum">     713 </span>                :            : /* Kill scripts in timeout, they'll be collected by the</a>
<span class="lineNum">     714 </span>                :            :  * sentinelCollectTerminatedScripts() function. */
<span class="lineNum">     715 </span>                :<span class="lineNoCov">          0 : void sentinelKillTimedoutScripts(void) {</span>
<span class="lineNum">     716 </span>                :            :     listNode *ln;
<span class="lineNum">     717 </span>                :            :     listIter li;
<span class="lineNum">     718 </span>                :<span class="lineNoCov">          0 :     mstime_t now = mstime();</span>
<span class="lineNum">     719 </span>                :            : 
<span class="lineNum">     720 </span>                :<span class="lineNoCov">          0 :     listRewind(sentinel.scripts_queue,&amp;li);</span>
<span class="lineNum">     721 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while ((ln = listNext(&amp;li)) != NULL) {</span>
<span class="lineNum">     722 </span>                :<span class="lineNoCov">          0 :         sentinelScriptJob *sj = ln-&gt;value;</span>
<span class="lineNum">     723 </span>                :            : 
<span class="lineNum">     724 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (sj-&gt;flags &amp; SENTINEL_SCRIPT_RUNNING &amp;&amp;</span>
<span class="lineNum">     725 </span>                :<span class="lineNoCov">          0 :             (now - sj-&gt;start_time) &gt; SENTINEL_SCRIPT_MAX_RUNTIME)</span>
<span class="lineNum">     726 </span>                :            :         {
<span class="lineNum">     727 </span>                :<span class="lineNoCov">          0 :             sentinelEvent(REDIS_WARNING,&quot;-script-timeout&quot;,NULL,&quot;%s %ld&quot;,</span>
<span class="lineNum">     728 </span>                :<span class="lineNoCov">          0 :                 sj-&gt;argv[0], (long)sj-&gt;pid);</span>
<span class="lineNum">     729 </span>                :<span class="lineNoCov">          0 :             kill(sj-&gt;pid,SIGKILL);</span>
<span class="lineNum">     730 </span>                :            :         }
<span class="lineNum">     731 </span>                :            :     }
<span class="lineNum">     732 </span>                :<span class="lineNoCov">          0 : }</span>
<a name="733"><span class="lineNum">     733 </span>                :            : </a>
<span class="lineNum">     734 </span>                :            : /* Implements SENTINEL PENDING-SCRIPTS command. */
<span class="lineNum">     735 </span>                :<span class="lineNoCov">          0 : void sentinelPendingScriptsCommand(redisClient *c) {</span>
<span class="lineNum">     736 </span>                :            :     listNode *ln;
<span class="lineNum">     737 </span>                :            :     listIter li;
<span class="lineNum">     738 </span>                :            : 
<span class="lineNum">     739 </span>                :<span class="lineNoCov">          0 :     addReplyMultiBulkLen(c,listLength(sentinel.scripts_queue));</span>
<span class="lineNum">     740 </span>                :<span class="lineNoCov">          0 :     listRewind(sentinel.scripts_queue,&amp;li);</span>
<span class="lineNum">     741 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while ((ln = listNext(&amp;li)) != NULL) {</span>
<span class="lineNum">     742 </span>                :<span class="lineNoCov">          0 :         sentinelScriptJob *sj = ln-&gt;value;</span>
<span class="lineNum">     743 </span>                :<span class="lineNoCov">          0 :         int j = 0;</span>
<span class="lineNum">     744 </span>                :            : 
<span class="lineNum">     745 </span>                :<span class="lineNoCov">          0 :         addReplyMultiBulkLen(c,10);</span>
<span class="lineNum">     746 </span>                :            : 
<span class="lineNum">     747 </span>                :<span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;argv&quot;);</span>
<span class="lineNum">     748 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         while (sj-&gt;argv[j]) j++;</span>
<span class="lineNum">     749 </span>                :<span class="lineNoCov">          0 :         addReplyMultiBulkLen(c,j);</span>
<span class="lineNum">     750 </span>                :<span class="lineNoCov">          0 :         j = 0;</span>
<span class="lineNum">     751 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         while (sj-&gt;argv[j]) addReplyBulkCString(c,sj-&gt;argv[j++]);</span>
<span class="lineNum">     752 </span>                :            : 
<span class="lineNum">     753 </span>                :<span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;flags&quot;);</span>
<span class="lineNum">     754 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         addReplyBulkCString(c,</span>
<span class="lineNum">     755 </span>                :<span class="lineNoCov">          0 :             (sj-&gt;flags &amp; SENTINEL_SCRIPT_RUNNING) ? &quot;running&quot; : &quot;scheduled&quot;);</span>
<span class="lineNum">     756 </span>                :            : 
<span class="lineNum">     757 </span>                :<span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;pid&quot;);</span>
<span class="lineNum">     758 </span>                :<span class="lineNoCov">          0 :         addReplyBulkLongLong(c,sj-&gt;pid);</span>
<span class="lineNum">     759 </span>                :            : 
<span class="lineNum">     760 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (sj-&gt;flags &amp; SENTINEL_SCRIPT_RUNNING) {</span>
<span class="lineNum">     761 </span>                :<span class="lineNoCov">          0 :             addReplyBulkCString(c,&quot;run-time&quot;);</span>
<span class="lineNum">     762 </span>                :<span class="lineNoCov">          0 :             addReplyBulkLongLong(c,mstime() - sj-&gt;start_time);</span>
<span class="lineNum">     763 </span>                :            :         } else {
<span class="lineNum">     764 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             mstime_t delay = sj-&gt;start_time ? (sj-&gt;start_time-mstime()) : 0;</span>
<span class="lineNum">     765 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (delay &lt; 0) delay = 0;</span>
<span class="lineNum">     766 </span>                :<span class="lineNoCov">          0 :             addReplyBulkCString(c,&quot;run-delay&quot;);</span>
<span class="lineNum">     767 </span>                :<span class="lineNoCov">          0 :             addReplyBulkLongLong(c,delay);</span>
<span class="lineNum">     768 </span>                :            :         }
<span class="lineNum">     769 </span>                :            : 
<span class="lineNum">     770 </span>                :<span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;retry-num&quot;);</span>
<span class="lineNum">     771 </span>                :<span class="lineNoCov">          0 :         addReplyBulkLongLong(c,sj-&gt;retry_num);</span>
<span class="lineNum">     772 </span>                :            :     }
<span class="lineNum">     773 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     774 </span>                :            : 
<span class="lineNum">     775 </span>                :            : /* This function calls, if any, the client reconfiguration script with the
<span class="lineNum">     776 </span>                :            :  * following parameters:
<span class="lineNum">     777 </span>                :            :  *
<span class="lineNum">     778 </span>                :            :  * &lt;master-name&gt; &lt;role&gt; &lt;state&gt; &lt;from-ip&gt; &lt;from-port&gt; &lt;to-ip&gt; &lt;to-port&gt;
<span class="lineNum">     779 </span>                :            :  *
<span class="lineNum">     780 </span>                :            :  * It is called every time a failover starts, ends, or is aborted.
<span class="lineNum">     781 </span>                :            :  *
<span class="lineNum">     782 </span>                :            :  * &lt;state&gt; is &quot;start&quot;, &quot;end&quot; or &quot;abort&quot;.
<span class="lineNum">     783 </span>                :            :  * &lt;role&gt; is either &quot;leader&quot; or &quot;observer&quot;.
<span class="lineNum">     784 </span>                :            :  *
<span class="lineNum">     785 </span>                :            :  * from/to fields are respectively master -&gt; promoted slave addresses for
<span class="lineNum">     786 </span>                :            :  * &quot;start&quot; and &quot;end&quot;, or the reverse (promoted slave -&gt; master) in case of
<a name="787"><span class="lineNum">     787 </span>                :            :  * &quot;abort&quot;.</a>
<span class="lineNum">     788 </span>                :            :  */
<span class="lineNum">     789 </span>                :<span class="lineNoCov">          0 : void sentinelCallClientReconfScript(sentinelRedisInstance *master, int role, char *state, sentinelAddr *from, sentinelAddr *to) {</span>
<span class="lineNum">     790 </span>                :            :     char fromport[32], toport[32];
<span class="lineNum">     791 </span>                :            : 
<span class="lineNum">     792 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (master-&gt;client_reconfig_script == NULL) return;</span>
<span class="lineNum">     793 </span>                :<span class="lineNoCov">          0 :     ll2string(fromport,sizeof(fromport),from-&gt;port);</span>
<span class="lineNum">     794 </span>                :<span class="lineNoCov">          0 :     ll2string(toport,sizeof(toport),to-&gt;port);</span>
<span class="lineNum">     795 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     sentinelScheduleScriptExecution(master-&gt;client_reconfig_script,</span>
<span class="lineNum">     796 </span>                :            :         master-&gt;name,
<span class="lineNum">     797 </span>                :            :         (role == SENTINEL_LEADER) ? &quot;leader&quot; : &quot;observer&quot;,
<span class="lineNum">     798 </span>                :            :         state, from-&gt;ip, fromport, to-&gt;ip, toport, NULL);
<span class="lineNum">     799 </span>                :            : }
<span class="lineNum">     800 </span>                :            : 
<span class="lineNum">     801 </span>                :            : /* ========================== sentinelRedisInstance ========================= */
<span class="lineNum">     802 </span>                :            : 
<span class="lineNum">     803 </span>                :            : /* Create a redis instance, the following fields must be populated by the
<span class="lineNum">     804 </span>                :            :  * caller if needed:
<span class="lineNum">     805 </span>                :            :  * runid: set to NULL but will be populated once INFO output is received.
<span class="lineNum">     806 </span>                :            :  * info_refresh: is set to 0 to mean that we never received INFO so far.
<span class="lineNum">     807 </span>                :            :  *
<span class="lineNum">     808 </span>                :            :  * If SRI_MASTER is set into initial flags the instance is added to
<span class="lineNum">     809 </span>                :            :  * sentinel.masters table.
<span class="lineNum">     810 </span>                :            :  *
<span class="lineNum">     811 </span>                :            :  * if SRI_SLAVE or SRI_SENTINEL is set then 'master' must be not NULL and the
<span class="lineNum">     812 </span>                :            :  * instance is added into master-&gt;slaves or master-&gt;sentinels table.
<span class="lineNum">     813 </span>                :            :  *
<span class="lineNum">     814 </span>                :            :  * If the instance is a slave or sentinel, the name parameter is ignored and
<span class="lineNum">     815 </span>                :            :  * is created automatically as hostname:port.
<span class="lineNum">     816 </span>                :            :  *
<span class="lineNum">     817 </span>                :            :  * The function fails if hostname can't be resolved or port is out of range.
<span class="lineNum">     818 </span>                :            :  * When this happens NULL is returned and errno is set accordingly to the
<span class="lineNum">     819 </span>                :            :  * createSentinelAddr() function.
<span class="lineNum">     820 </span>                :            :  *
<a name="821"><span class="lineNum">     821 </span>                :            :  * The function may also fail and return NULL with errno set to EBUSY if</a>
<span class="lineNum">     822 </span>                :            :  * a master or slave with the same name already exists. */
<span class="lineNum">     823 </span>                :<span class="lineNoCov">          0 : sentinelRedisInstance *createSentinelRedisInstance(char *name, int flags, char *hostname, int port, int quorum, sentinelRedisInstance *master) {</span>
<span class="lineNum">     824 </span>                :            :     sentinelRedisInstance *ri;
<span class="lineNum">     825 </span>                :            :     sentinelAddr *addr;
<span class="lineNum">     826 </span>                :<span class="lineNoCov">          0 :     dict *table = NULL;</span>
<span class="lineNum">     827 </span>                :            :     char slavename[128], *sdsname;
<span class="lineNum">     828 </span>                :            : 
<span class="lineNum">     829 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     redisAssert(flags &amp; (SRI_MASTER|SRI_SLAVE|SRI_SENTINEL));</span>
<span class="lineNum">     830 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     redisAssert((flags &amp; SRI_MASTER) || master != NULL);</span>
<span class="lineNum">     831 </span>                :            : 
<span class="lineNum">     832 </span>                :            :     /* Check address validity. */
<span class="lineNum">     833 </span>                :<span class="lineNoCov">          0 :     addr = createSentinelAddr(hostname,port);</span>
<span class="lineNum">     834 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (addr == NULL) return NULL;</span>
<span class="lineNum">     835 </span>                :            : 
<span class="lineNum">     836 </span>                :            :     /* For slaves and sentinel we use ip:port as name. */
<span class="lineNum">     837 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (flags &amp; (SRI_SLAVE|SRI_SENTINEL)) {</span>
<span class="lineNum">     838 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         snprintf(slavename,sizeof(slavename),</span>
<span class="lineNum">     839 </span>                :<span class="lineNoCov">          0 :             strchr(hostname,':') ? &quot;[%s]:%d&quot; : &quot;%s:%d&quot;,</span>
<span class="lineNum">     840 </span>                :            :             hostname,port);
<span class="lineNum">     841 </span>                :<span class="lineNoCov">          0 :         name = slavename;</span>
<span class="lineNum">     842 </span>                :            :     }
<span class="lineNum">     843 </span>                :            : 
<span class="lineNum">     844 </span>                :            :     /* Make sure the entry is not duplicated. This may happen when the same
<span class="lineNum">     845 </span>                :            :      * name for a master is used multiple times inside the configuration or
<span class="lineNum">     846 </span>                :            :      * if we try to add multiple times a slave or sentinel with same ip/port
<span class="lineNum">     847 </span>                :            :      * to a master. */
<span class="lineNum">     848 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (flags &amp; SRI_MASTER) table = sentinel.masters;</span>
<span class="lineNum">     849 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     else if (flags &amp; SRI_SLAVE) table = master-&gt;slaves;</span>
<span class="lineNum">     850 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     else if (flags &amp; SRI_SENTINEL) table = master-&gt;sentinels;</span>
<span class="lineNum">     851 </span>                :<span class="lineNoCov">          0 :     sdsname = sdsnew(name);</span>
<span class="lineNum">     852 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (dictFind(table,sdsname)) {</span>
<span class="lineNum">     853 </span>                :<span class="lineNoCov">          0 :         sdsfree(sdsname);</span>
<span class="lineNum">     854 </span>                :<span class="lineNoCov">          0 :         errno = EBUSY;</span>
<span class="lineNum">     855 </span>                :<span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">     856 </span>                :            :     }
<span class="lineNum">     857 </span>                :            : 
<span class="lineNum">     858 </span>                :            :     /* Create the instance object. */
<span class="lineNum">     859 </span>                :<span class="lineNoCov">          0 :     ri = zmalloc(sizeof(*ri));</span>
<span class="lineNum">     860 </span>                :            :     /* Note that all the instances are started in the disconnected state,
<span class="lineNum">     861 </span>                :            :      * the event loop will take care of connecting them. */
<span class="lineNum">     862 </span>                :<span class="lineNoCov">          0 :     ri-&gt;flags = flags | SRI_DISCONNECTED;</span>
<span class="lineNum">     863 </span>                :<span class="lineNoCov">          0 :     ri-&gt;name = sdsname;</span>
<span class="lineNum">     864 </span>                :<span class="lineNoCov">          0 :     ri-&gt;runid = NULL;</span>
<span class="lineNum">     865 </span>                :<span class="lineNoCov">          0 :     ri-&gt;addr = addr;</span>
<span class="lineNum">     866 </span>                :<span class="lineNoCov">          0 :     ri-&gt;cc = NULL;</span>
<span class="lineNum">     867 </span>                :<span class="lineNoCov">          0 :     ri-&gt;pc = NULL;</span>
<span class="lineNum">     868 </span>                :<span class="lineNoCov">          0 :     ri-&gt;pending_commands = 0;</span>
<span class="lineNum">     869 </span>                :<span class="lineNoCov">          0 :     ri-&gt;cc_conn_time = 0;</span>
<span class="lineNum">     870 </span>                :<span class="lineNoCov">          0 :     ri-&gt;pc_conn_time = 0;</span>
<span class="lineNum">     871 </span>                :<span class="lineNoCov">          0 :     ri-&gt;pc_last_activity = 0;</span>
<span class="lineNum">     872 </span>                :<span class="lineNoCov">          0 :     ri-&gt;last_avail_time = mstime();</span>
<span class="lineNum">     873 </span>                :<span class="lineNoCov">          0 :     ri-&gt;last_pong_time = mstime();</span>
<span class="lineNum">     874 </span>                :<span class="lineNoCov">          0 :     ri-&gt;last_pub_time = mstime();</span>
<span class="lineNum">     875 </span>                :<span class="lineNoCov">          0 :     ri-&gt;last_hello_time = mstime();</span>
<span class="lineNum">     876 </span>                :<span class="lineNoCov">          0 :     ri-&gt;last_master_down_reply_time = mstime();</span>
<span class="lineNum">     877 </span>                :<span class="lineNoCov">          0 :     ri-&gt;s_down_since_time = 0;</span>
<span class="lineNum">     878 </span>                :<span class="lineNoCov">          0 :     ri-&gt;o_down_since_time = 0;</span>
<span class="lineNum">     879 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     ri-&gt;down_after_period = master ? master-&gt;down_after_period :</span>
<span class="lineNum">     880 </span>                :            :                             SENTINEL_DOWN_AFTER_PERIOD;
<span class="lineNum">     881 </span>                :<span class="lineNoCov">          0 :     ri-&gt;master_link_down_time = 0;</span>
<span class="lineNum">     882 </span>                :<span class="lineNoCov">          0 :     ri-&gt;auth_pass = NULL;</span>
<span class="lineNum">     883 </span>                :<span class="lineNoCov">          0 :     ri-&gt;slave_priority = SENTINEL_DEFAULT_SLAVE_PRIORITY;</span>
<span class="lineNum">     884 </span>                :<span class="lineNoCov">          0 :     ri-&gt;slave_reconf_sent_time = 0;</span>
<span class="lineNum">     885 </span>                :<span class="lineNoCov">          0 :     ri-&gt;slave_master_host = NULL;</span>
<span class="lineNum">     886 </span>                :<span class="lineNoCov">          0 :     ri-&gt;slave_master_port = 0;</span>
<span class="lineNum">     887 </span>                :<span class="lineNoCov">          0 :     ri-&gt;slave_master_link_status = SENTINEL_MASTER_LINK_STATUS_DOWN;</span>
<span class="lineNum">     888 </span>                :<span class="lineNoCov">          0 :     ri-&gt;sentinels = dictCreate(&amp;instancesDictType,NULL);</span>
<span class="lineNum">     889 </span>                :<span class="lineNoCov">          0 :     ri-&gt;quorum = quorum;</span>
<span class="lineNum">     890 </span>                :<span class="lineNoCov">          0 :     ri-&gt;parallel_syncs = SENTINEL_DEFAULT_PARALLEL_SYNCS;</span>
<span class="lineNum">     891 </span>                :<span class="lineNoCov">          0 :     ri-&gt;master = master;</span>
<span class="lineNum">     892 </span>                :<span class="lineNoCov">          0 :     ri-&gt;slaves = dictCreate(&amp;instancesDictType,NULL);</span>
<span class="lineNum">     893 </span>                :<span class="lineNoCov">          0 :     ri-&gt;info_refresh = 0;</span>
<span class="lineNum">     894 </span>                :            : 
<span class="lineNum">     895 </span>                :            :     /* Failover state. */
<span class="lineNum">     896 </span>                :<span class="lineNoCov">          0 :     ri-&gt;leader = NULL;</span>
<span class="lineNum">     897 </span>                :<span class="lineNoCov">          0 :     ri-&gt;failover_state = SENTINEL_FAILOVER_STATE_NONE;</span>
<span class="lineNum">     898 </span>                :<span class="lineNoCov">          0 :     ri-&gt;failover_state_change_time = 0;</span>
<span class="lineNum">     899 </span>                :<span class="lineNoCov">          0 :     ri-&gt;failover_start_time = 0;</span>
<span class="lineNum">     900 </span>                :<span class="lineNoCov">          0 :     ri-&gt;failover_timeout = SENTINEL_DEFAULT_FAILOVER_TIMEOUT;</span>
<span class="lineNum">     901 </span>                :<span class="lineNoCov">          0 :     ri-&gt;promoted_slave = NULL;</span>
<span class="lineNum">     902 </span>                :<span class="lineNoCov">          0 :     ri-&gt;notification_script = NULL;</span>
<span class="lineNum">     903 </span>                :<span class="lineNoCov">          0 :     ri-&gt;client_reconfig_script = NULL;</span>
<span class="lineNum">     904 </span>                :            : 
<span class="lineNum">     905 </span>                :            :     /* Add into the right table. */
<span class="lineNum">     906 </span>                :<span class="lineNoCov">          0 :     dictAdd(table, ri-&gt;name, ri);</span>
<span class="lineNum">     907 </span>                :<span class="lineNoCov">          0 :     return ri;</span>
<span class="lineNum">     908 </span>                :            : }
<span class="lineNum">     909 </span>                :            : 
<span class="lineNum">     910 </span>                :            : /* Release this instance and all its slaves, sentinels, hiredis connections.
<span class="lineNum">     911 </span>                :            :  * This function also takes care of unlinking the instance from the main
<a name="912"><span class="lineNum">     912 </span>                :            :  * masters table (if it is a master) or from its master sentinels/slaves table</a>
<span class="lineNum">     913 </span>                :            :  * if it is a slave or sentinel. */
<span class="lineNum">     914 </span>                :<span class="lineNoCov">          0 : void releaseSentinelRedisInstance(sentinelRedisInstance *ri) {</span>
<span class="lineNum">     915 </span>                :            :     /* Release all its slaves or sentinels if any. */
<span class="lineNum">     916 </span>                :<span class="lineNoCov">          0 :     dictRelease(ri-&gt;sentinels);</span>
<span class="lineNum">     917 </span>                :<span class="lineNoCov">          0 :     dictRelease(ri-&gt;slaves);</span>
<span class="lineNum">     918 </span>                :            : 
<span class="lineNum">     919 </span>                :            :     /* Release hiredis connections. */
<span class="lineNum">     920 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;cc) sentinelKillLink(ri,ri-&gt;cc);</span>
<span class="lineNum">     921 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;pc) sentinelKillLink(ri,ri-&gt;pc);</span>
<span class="lineNum">     922 </span>                :            : 
<span class="lineNum">     923 </span>                :            :     /* Free other resources. */
<span class="lineNum">     924 </span>                :<span class="lineNoCov">          0 :     sdsfree(ri-&gt;name);</span>
<span class="lineNum">     925 </span>                :<span class="lineNoCov">          0 :     sdsfree(ri-&gt;runid);</span>
<span class="lineNum">     926 </span>                :<span class="lineNoCov">          0 :     sdsfree(ri-&gt;notification_script);</span>
<span class="lineNum">     927 </span>                :<span class="lineNoCov">          0 :     sdsfree(ri-&gt;client_reconfig_script);</span>
<span class="lineNum">     928 </span>                :<span class="lineNoCov">          0 :     sdsfree(ri-&gt;slave_master_host);</span>
<span class="lineNum">     929 </span>                :<span class="lineNoCov">          0 :     sdsfree(ri-&gt;leader);</span>
<span class="lineNum">     930 </span>                :<span class="lineNoCov">          0 :     sdsfree(ri-&gt;auth_pass);</span>
<span class="lineNum">     931 </span>                :<span class="lineNoCov">          0 :     releaseSentinelAddr(ri-&gt;addr);</span>
<span class="lineNum">     932 </span>                :            : 
<span class="lineNum">     933 </span>                :            :     /* Clear state into the master if needed. */
<span class="lineNum">     934 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if ((ri-&gt;flags &amp; SRI_SLAVE) &amp;&amp; (ri-&gt;flags &amp; SRI_PROMOTED) &amp;&amp; ri-&gt;master)</span>
<span class="lineNum">     935 </span>                :<span class="lineNoCov">          0 :         ri-&gt;master-&gt;promoted_slave = NULL;</span>
<span class="lineNum">     936 </span>                :            : 
<span class="lineNum">     937 </span>                :<span class="lineNoCov">          0 :     zfree(ri);</span>
<span class="lineNum">     938 </span>                :<span class="lineNoCov">          0 : }</span>
<a name="939"><span class="lineNum">     939 </span>                :            : </a>
<span class="lineNum">     940 </span>                :            : /* Lookup a slave in a master Redis instance, by ip and port. */
<span class="lineNum">     941 </span>                :<span class="lineNoCov">          0 : sentinelRedisInstance *sentinelRedisInstanceLookupSlave(</span>
<span class="lineNum">     942 </span>                :            :                 sentinelRedisInstance *ri, char *ip, int port)
<span class="lineNum">     943 </span>                :            : {
<span class="lineNum">     944 </span>                :            :     sds key;
<span class="lineNum">     945 </span>                :            :     sentinelRedisInstance *slave;
<span class="lineNum">     946 </span>                :            :   
<span class="lineNum">     947 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     redisAssert(ri-&gt;flags &amp; SRI_MASTER);</span>
<span class="lineNum">     948 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     key = sdscatprintf(sdsempty(),</span>
<span class="lineNum">     949 </span>                :<span class="lineNoCov">          0 :         strchr(ip,':') ? &quot;[%s]:%d&quot; : &quot;%s:%d&quot;,</span>
<span class="lineNum">     950 </span>                :            :         ip,port);
<span class="lineNum">     951 </span>                :<span class="lineNoCov">          0 :     slave = dictFetchValue(ri-&gt;slaves,key);</span>
<span class="lineNum">     952 </span>                :<span class="lineNoCov">          0 :     sdsfree(key);</span>
<span class="lineNum">     953 </span>                :<span class="lineNoCov">          0 :     return slave;</span>
<span class="lineNum">     954 </span>                :            : }
<a name="955"><span class="lineNum">     955 </span>                :            : </a>
<span class="lineNum">     956 </span>                :            : /* Return the name of the type of the instance as a string. */
<span class="lineNum">     957 </span>                :<span class="lineNoCov">          0 : const char *sentinelRedisInstanceTypeStr(sentinelRedisInstance *ri) {</span>
<span class="lineNum">     958 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_MASTER) return &quot;master&quot;;</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">     959 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     else if (ri-&gt;flags &amp; SRI_SLAVE) return &quot;slave&quot;;</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">     960 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     else if (ri-&gt;flags &amp; SRI_SENTINEL) return &quot;sentinel&quot;;</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">     961 </span>                :<span class="lineNoCov">          0 :     else return &quot;unknown&quot;;</span>
<span class="lineNum">     962 </span>                :            : }
<span class="lineNum">     963 </span>                :            : 
<span class="lineNum">     964 </span>                :            : /* This function removes all the instances found in the dictionary of instances
<span class="lineNum">     965 </span>                :            :  * 'd', having either:
<span class="lineNum">     966 </span>                :            :  * 
<span class="lineNum">     967 </span>                :            :  * 1) The same ip/port as specified.
<span class="lineNum">     968 </span>                :            :  * 2) The same runid.
<span class="lineNum">     969 </span>                :            :  *
<span class="lineNum">     970 </span>                :            :  * &quot;1&quot; and &quot;2&quot; don't need to verify at the same time, just one is enough.
<span class="lineNum">     971 </span>                :            :  * If &quot;runid&quot; is NULL it is not checked.
<span class="lineNum">     972 </span>                :            :  * Similarly if &quot;ip&quot; is NULL it is not checked.
<span class="lineNum">     973 </span>                :            :  *
<span class="lineNum">     974 </span>                :            :  * This function is useful because every time we add a new Sentinel into
<span class="lineNum">     975 </span>                :            :  * a master's Sentinels dictionary, we want to be very sure about not
<span class="lineNum">     976 </span>                :            :  * having duplicated instances for any reason. This is so important because
<span class="lineNum">     977 </span>                :            :  * we use those other sentinels in order to run our quorum protocol to
<span class="lineNum">     978 </span>                :            :  * understand if it's time to proceed with the fail over.
<span class="lineNum">     979 </span>                :            :  *
<span class="lineNum">     980 </span>                :            :  * Making sure no duplication is possible we greatly improve the robustness
<span class="lineNum">     981 </span>                :            :  * of the quorum (otherwise we may end counting the same instance multiple
<span class="lineNum">     982 </span>                :            :  * times for some reason).
<a name="983"><span class="lineNum">     983 </span>                :            :  *</a>
<span class="lineNum">     984 </span>                :            :  * The function returns the number of Sentinels removed. */
<span class="lineNum">     985 </span>                :<span class="lineNoCov">          0 : int removeMatchingSentinelsFromMaster(sentinelRedisInstance *master, char *ip, int port, char *runid) {</span>
<span class="lineNum">     986 </span>                :            :     dictIterator *di;
<span class="lineNum">     987 </span>                :            :     dictEntry *de;
<span class="lineNum">     988 </span>                :<span class="lineNoCov">          0 :     int removed = 0;</span>
<span class="lineNum">     989 </span>                :            : 
<span class="lineNum">     990 </span>                :<span class="lineNoCov">          0 :     di = dictGetSafeIterator(master-&gt;sentinels);</span>
<span class="lineNum">     991 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">     992 </span>                :<span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">     993 </span>                :            : 
<span class="lineNum">     994 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ((ri-&gt;runid &amp;&amp; runid &amp;&amp; strcmp(ri-&gt;runid,runid) == 0) ||</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">     995 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :             (ip &amp;&amp; strcmp(ri-&gt;addr-&gt;ip,ip) == 0 &amp;&amp; port == ri-&gt;addr-&gt;port))</span>
<span class="lineNum">     996 </span>                :            :         {
<span class="lineNum">     997 </span>                :<span class="lineNoCov">          0 :             dictDelete(master-&gt;sentinels,ri-&gt;name);</span>
<span class="lineNum">     998 </span>                :<span class="lineNoCov">          0 :             removed++;</span>
<span class="lineNum">     999 </span>                :            :         }
<span class="lineNum">    1000 </span>                :            :     }
<span class="lineNum">    1001 </span>                :<span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    1002 </span>                :<span class="lineNoCov">          0 :     return removed;</span>
<span class="lineNum">    1003 </span>                :            : }
<span class="lineNum">    1004 </span>                :            : 
<span class="lineNum">    1005 </span>                :            : /* Search an instance with the same runid, ip and port into a dictionary
<span class="lineNum">    1006 </span>                :            :  * of instances. Return NULL if not found, otherwise return the instance
<span class="lineNum">    1007 </span>                :            :  * pointer.
<span class="lineNum">    1008 </span>                :            :  *
<a name="1009"><span class="lineNum">    1009 </span>                :            :  * runid or ip can be NULL. In such a case the search is performed only</a>
<span class="lineNum">    1010 </span>                :            :  * by the non-NULL field. */
<span class="lineNum">    1011 </span>                :<span class="lineNoCov">          0 : sentinelRedisInstance *getSentinelRedisInstanceByAddrAndRunID(dict *instances, char *ip, int port, char *runid) {</span>
<span class="lineNum">    1012 </span>                :            :     dictIterator *di;
<span class="lineNum">    1013 </span>                :            :     dictEntry *de;
<span class="lineNum">    1014 </span>                :<span class="lineNoCov">          0 :     sentinelRedisInstance *instance = NULL;</span>
<span class="lineNum">    1015 </span>                :            : 
<span class="lineNum">    1016 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     redisAssert(ip || runid);   /* User must pass at least one search param. */</span>
<span class="lineNum">    1017 </span>                :<span class="lineNoCov">          0 :     di = dictGetIterator(instances);</span>
<span class="lineNum">    1018 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    1019 </span>                :<span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    1020 </span>                :            : 
<span class="lineNum">    1021 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (runid &amp;&amp; !ri-&gt;runid) continue;</span>
<span class="lineNum">    1022 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ((runid == NULL || strcmp(ri-&gt;runid, runid) == 0) &amp;&amp;</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    1023 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :             (ip == NULL || (strcmp(ri-&gt;addr-&gt;ip, ip) == 0 &amp;&amp;</span>
<span class="lineNum">    1024 </span>                :<span class="lineNoCov">          0 :                             ri-&gt;addr-&gt;port == port)))</span>
<span class="lineNum">    1025 </span>                :            :         {
<span class="lineNum">    1026 </span>                :            :             instance = ri;
<span class="lineNum">    1027 </span>                :            :             break;
<span class="lineNum">    1028 </span>                :            :         }
<span class="lineNum">    1029 </span>                :            :     }
<span class="lineNum">    1030 </span>                :<span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    1031 </span>                :<span class="lineNoCov">          0 :     return instance;</span>
<span class="lineNum">    1032 </span>                :            : }
<a name="1033"><span class="lineNum">    1033 </span>                :            : </a>
<span class="lineNum">    1034 </span>                :            : /* Simple master lookup by name */
<span class="lineNum">    1035 </span>                :<span class="lineNoCov">          0 : sentinelRedisInstance *sentinelGetMasterByName(char *name) {</span>
<span class="lineNum">    1036 </span>                :            :     sentinelRedisInstance *ri;
<span class="lineNum">    1037 </span>                :<span class="lineNoCov">          0 :     sds sdsname = sdsnew(name);</span>
<span class="lineNum">    1038 </span>                :            : 
<span class="lineNum">    1039 </span>                :<span class="lineNoCov">          0 :     ri = dictFetchValue(sentinel.masters,sdsname);</span>
<span class="lineNum">    1040 </span>                :<span class="lineNoCov">          0 :     sdsfree(sdsname);</span>
<span class="lineNum">    1041 </span>                :<span class="lineNoCov">          0 :     return ri;</span>
<span class="lineNum">    1042 </span>                :            : }
<a name="1043"><span class="lineNum">    1043 </span>                :            : </a>
<span class="lineNum">    1044 </span>                :            : /* Add the specified flags to all the instances in the specified dictionary. */
<span class="lineNum">    1045 </span>                :<span class="lineNoCov">          0 : void sentinelAddFlagsToDictOfRedisInstances(dict *instances, int flags) {</span>
<span class="lineNum">    1046 </span>                :            :     dictIterator *di;
<span class="lineNum">    1047 </span>                :            :     dictEntry *de;
<span class="lineNum">    1048 </span>                :            : 
<span class="lineNum">    1049 </span>                :<span class="lineNoCov">          0 :     di = dictGetIterator(instances);</span>
<span class="lineNum">    1050 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    1051 </span>                :<span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    1052 </span>                :<span class="lineNoCov">          0 :         ri-&gt;flags |= flags;</span>
<span class="lineNum">    1053 </span>                :            :     }
<span class="lineNum">    1054 </span>                :<span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    1055 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1056 </span>                :            : 
<a name="1057"><span class="lineNum">    1057 </span>                :            : /* Remove the specified flags to all the instances in the specified</a>
<span class="lineNum">    1058 </span>                :            :  * dictionary. */
<span class="lineNum">    1059 </span>                :<span class="lineNoCov">          0 : void sentinelDelFlagsToDictOfRedisInstances(dict *instances, int flags) {</span>
<span class="lineNum">    1060 </span>                :            :     dictIterator *di;
<span class="lineNum">    1061 </span>                :            :     dictEntry *de;
<span class="lineNum">    1062 </span>                :            : 
<span class="lineNum">    1063 </span>                :<span class="lineNoCov">          0 :     di = dictGetIterator(instances);</span>
<span class="lineNum">    1064 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    1065 </span>                :<span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    1066 </span>                :<span class="lineNoCov">          0 :         ri-&gt;flags &amp;= ~flags;</span>
<span class="lineNum">    1067 </span>                :            :     }
<span class="lineNum">    1068 </span>                :<span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    1069 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1070 </span>                :            : 
<span class="lineNum">    1071 </span>                :            : /* Reset the state of a monitored master:
<span class="lineNum">    1072 </span>                :            :  * 1) Remove all slaves.
<span class="lineNum">    1073 </span>                :            :  * 2) Remove all sentinels.
<span class="lineNum">    1074 </span>                :            :  * 3) Remove most of the flags resulting from runtime operations.
<span class="lineNum">    1075 </span>                :            :  * 4) Reset timers to their default value.
<span class="lineNum">    1076 </span>                :            :  * 5) In the process of doing this undo the failover if in progress.
<a name="1077"><span class="lineNum">    1077 </span>                :            :  * 6) Disconnect the connections with the master (will reconnect automatically).</a>
<span class="lineNum">    1078 </span>                :            :  */
<span class="lineNum">    1079 </span>                :<span class="lineNoCov">          0 : void sentinelResetMaster(sentinelRedisInstance *ri, int flags) {</span>
<span class="lineNum">    1080 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     redisAssert(ri-&gt;flags &amp; SRI_MASTER);</span>
<span class="lineNum">    1081 </span>                :<span class="lineNoCov">          0 :     dictRelease(ri-&gt;slaves);</span>
<span class="lineNum">    1082 </span>                :<span class="lineNoCov">          0 :     dictRelease(ri-&gt;sentinels);</span>
<span class="lineNum">    1083 </span>                :<span class="lineNoCov">          0 :     ri-&gt;slaves = dictCreate(&amp;instancesDictType,NULL);</span>
<span class="lineNum">    1084 </span>                :<span class="lineNoCov">          0 :     ri-&gt;sentinels = dictCreate(&amp;instancesDictType,NULL);</span>
<span class="lineNum">    1085 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;cc) sentinelKillLink(ri,ri-&gt;cc);</span>
<span class="lineNum">    1086 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;pc) sentinelKillLink(ri,ri-&gt;pc);</span>
<span class="lineNum">    1087 </span>                :<span class="lineNoCov">          0 :     ri-&gt;flags &amp;= SRI_MASTER|SRI_CAN_FAILOVER|SRI_DISCONNECTED;</span>
<span class="lineNum">    1088 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;leader) {</span>
<span class="lineNum">    1089 </span>                :<span class="lineNoCov">          0 :         sdsfree(ri-&gt;leader);</span>
<span class="lineNum">    1090 </span>                :<span class="lineNoCov">          0 :         ri-&gt;leader = NULL;</span>
<span class="lineNum">    1091 </span>                :            :     }
<span class="lineNum">    1092 </span>                :<span class="lineNoCov">          0 :     ri-&gt;failover_state = SENTINEL_FAILOVER_STATE_NONE;</span>
<span class="lineNum">    1093 </span>                :<span class="lineNoCov">          0 :     ri-&gt;failover_state_change_time = 0;</span>
<span class="lineNum">    1094 </span>                :<span class="lineNoCov">          0 :     ri-&gt;failover_start_time = 0;</span>
<span class="lineNum">    1095 </span>                :<span class="lineNoCov">          0 :     ri-&gt;promoted_slave = NULL;</span>
<span class="lineNum">    1096 </span>                :<span class="lineNoCov">          0 :     sdsfree(ri-&gt;runid);</span>
<span class="lineNum">    1097 </span>                :<span class="lineNoCov">          0 :     sdsfree(ri-&gt;slave_master_host);</span>
<span class="lineNum">    1098 </span>                :<span class="lineNoCov">          0 :     ri-&gt;runid = NULL;</span>
<span class="lineNum">    1099 </span>                :<span class="lineNoCov">          0 :     ri-&gt;slave_master_host = NULL;</span>
<span class="lineNum">    1100 </span>                :<span class="lineNoCov">          0 :     ri-&gt;last_avail_time = mstime();</span>
<span class="lineNum">    1101 </span>                :<span class="lineNoCov">          0 :     ri-&gt;last_pong_time = mstime();</span>
<span class="lineNum">    1102 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (flags &amp; SENTINEL_GENERATE_EVENT)</span>
<span class="lineNum">    1103 </span>                :<span class="lineNoCov">          0 :         sentinelEvent(REDIS_WARNING,&quot;+reset-master&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    1104 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1105 </span>                :            : 
<a name="1106"><span class="lineNum">    1106 </span>                :            : /* Call sentinelResetMaster() on every master with a name matching the specified</a>
<span class="lineNum">    1107 </span>                :            :  * pattern. */
<span class="lineNum">    1108 </span>                :<span class="lineNoCov">          0 : int sentinelResetMastersByPattern(char *pattern, int flags) {</span>
<span class="lineNum">    1109 </span>                :            :     dictIterator *di;
<span class="lineNum">    1110 </span>                :            :     dictEntry *de;
<span class="lineNum">    1111 </span>                :<span class="lineNoCov">          0 :     int reset = 0;</span>
<span class="lineNum">    1112 </span>                :            : 
<span class="lineNum">    1113 </span>                :<span class="lineNoCov">          0 :     di = dictGetIterator(sentinel.masters);</span>
<span class="lineNum">    1114 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    1115 </span>                :<span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    1116 </span>                :            : 
<span class="lineNum">    1117 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ri-&gt;name) {</span>
<span class="lineNum">    1118 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (stringmatch(pattern,ri-&gt;name,0)) {</span>
<span class="lineNum">    1119 </span>                :<span class="lineNoCov">          0 :                 sentinelResetMaster(ri,flags);</span>
<span class="lineNum">    1120 </span>                :<span class="lineNoCov">          0 :                 reset++;</span>
<span class="lineNum">    1121 </span>                :            :             }
<span class="lineNum">    1122 </span>                :            :         }
<span class="lineNum">    1123 </span>                :            :     }
<span class="lineNum">    1124 </span>                :<span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    1125 </span>                :<span class="lineNoCov">          0 :     return reset;</span>
<span class="lineNum">    1126 </span>                :            : }
<span class="lineNum">    1127 </span>                :            : 
<span class="lineNum">    1128 </span>                :            : /* Reset the specified master with sentinelResetMaster(), and also change
<span class="lineNum">    1129 </span>                :            :  * the ip:port address, but take the name of the instance unmodified.
<span class="lineNum">    1130 </span>                :            :  *
<span class="lineNum">    1131 </span>                :            :  * This is used to handle the +switch-master and +redirect-to-master events.
<span class="lineNum">    1132 </span>                :            :  *
<span class="lineNum">    1133 </span>                :            :  * The function returns REDIS_ERR if the address can't be resolved for some
<span class="lineNum">    1134 </span>                :            :  * reason. Otherwise REDIS_OK is returned.
<span class="lineNum">    1135 </span>                :            :  *
<span class="lineNum">    1136 </span>                :            :  * TODO: make this reset so that original sentinels are re-added with
<a name="1137"><span class="lineNum">    1137 </span>                :            :  * same ip / port / runid.</a>
<span class="lineNum">    1138 </span>                :            :  */
<span class="lineNum">    1139 </span>                :<span class="lineNoCov">          0 : int sentinelResetMasterAndChangeAddress(sentinelRedisInstance *master, char *ip, int port) {</span>
<span class="lineNum">    1140 </span>                :            :     sentinelAddr *oldaddr, *newaddr;
<span class="lineNum">    1141 </span>                :            : 
<span class="lineNum">    1142 </span>                :<span class="lineNoCov">          0 :     newaddr = createSentinelAddr(ip,port);</span>
<span class="lineNum">    1143 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (newaddr == NULL) return REDIS_ERR;</span>
<span class="lineNum">    1144 </span>                :<span class="lineNoCov">          0 :     sentinelResetMaster(master,SENTINEL_NO_FLAGS);</span>
<span class="lineNum">    1145 </span>                :<span class="lineNoCov">          0 :     oldaddr = master-&gt;addr;</span>
<span class="lineNum">    1146 </span>                :<span class="lineNoCov">          0 :     master-&gt;addr = newaddr;</span>
<span class="lineNum">    1147 </span>                :<span class="lineNoCov">          0 :     master-&gt;o_down_since_time = 0;</span>
<span class="lineNum">    1148 </span>                :<span class="lineNoCov">          0 :     master-&gt;s_down_since_time = 0;</span>
<span class="lineNum">    1149 </span>                :            : 
<span class="lineNum">    1150 </span>                :            :     /* Release the old address at the end so we are safe even if the function
<span class="lineNum">    1151 </span>                :            :      * gets the master-&gt;addr-&gt;ip and master-&gt;addr-&gt;port as arguments. */
<span class="lineNum">    1152 </span>                :<span class="lineNoCov">          0 :     releaseSentinelAddr(oldaddr);</span>
<span class="lineNum">    1153 </span>                :<span class="lineNoCov">          0 :     return REDIS_OK;</span>
<span class="lineNum">    1154 </span>                :            : }
<span class="lineNum">    1155 </span>                :            : 
<a name="1156"><span class="lineNum">    1156 </span>                :            : /* Return non-zero if there was no SDOWN or ODOWN error associated to this</a>
<span class="lineNum">    1157 </span>                :            :  * instance in the latest 'ms' milliseconds. */
<span class="lineNum">    1158 </span>                :<span class="lineNoCov">          0 : int sentinelRedisInstanceNoDownFor(sentinelRedisInstance *ri, mstime_t ms) {</span>
<span class="lineNum">    1159 </span>                :            :     mstime_t most_recent;
<span class="lineNum">    1160 </span>                :            : 
<span class="lineNum">    1161 </span>                :<span class="lineNoCov">          0 :     most_recent = ri-&gt;s_down_since_time;</span>
<span class="lineNum">    1162 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;o_down_since_time &gt; most_recent)</span>
<span class="lineNum">    1163 </span>                :<span class="lineNoCov">          0 :         most_recent = ri-&gt;o_down_since_time;</span>
<span class="lineNum">    1164 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :     return most_recent == 0 || (mstime() - most_recent) &gt; ms;</span>
<span class="lineNum">    1165 </span>                :            : }
<a name="1166"><span class="lineNum">    1166 </span>                :            : </a>
<span class="lineNum">    1167 </span>                :            : /* ============================ Config handling ============================= */
<span class="lineNum">    1168 </span>                :<span class="lineNoCov">          0 : char *sentinelHandleConfiguration(char **argv, int argc) {</span>
<span class="lineNum">    1169 </span>                :            :     sentinelRedisInstance *ri;
<span class="lineNum">    1170 </span>                :            : 
<span class="lineNum">    1171 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!strcasecmp(argv[0],&quot;monitor&quot;) &amp;&amp; argc == 5) {</span>
<span class="lineNum">    1172 </span>                :            :         /* monitor &lt;name&gt; &lt;host&gt; &lt;port&gt; &lt;quorum&gt; */
<span class="lineNum">    1173 </span>                :<span class="lineNoCov">          0 :         int quorum = atoi(argv[4]);</span>
<span class="lineNum">    1174 </span>                :            : 
<span class="lineNum">    1175 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (quorum &lt;= 0) return &quot;Quorum must be 1 or greater.&quot;;</span>
<span class="lineNum">    1176 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (createSentinelRedisInstance(argv[1],SRI_MASTER,argv[2],</span>
<span class="lineNum">    1177 </span>                :            :                                         atoi(argv[3]),quorum,NULL) == NULL)
<span class="lineNum">    1178 </span>                :            :         {
<span class="lineNum">    1179 </span>  [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :             switch(errno) {</span>
<span class="lineNum">    1180 </span>                :            :             case EBUSY: return &quot;Duplicated master name.&quot;;
<span class="lineNum">    1181 </span>                :<span class="lineNoCov">          0 :             case ENOENT: return &quot;Can't resolve master instance hostname.&quot;;</span>
<span class="lineNum">    1182 </span>                :<span class="lineNoCov">          0 :             case EINVAL: return &quot;Invalid port number&quot;;</span>
<span class="lineNum">    1183 </span>                :            :             }
<span class="lineNum">    1184 </span>                :            :         }
<span class="lineNum">    1185 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     } else if (!strcasecmp(argv[0],&quot;down-after-milliseconds&quot;) &amp;&amp; argc == 3) {</span>
<span class="lineNum">    1186 </span>                :            :         /* down-after-milliseconds &lt;name&gt; &lt;milliseconds&gt; */
<span class="lineNum">    1187 </span>                :<span class="lineNoCov">          0 :         ri = sentinelGetMasterByName(argv[1]);</span>
<span class="lineNum">    1188 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!ri) return &quot;No such master with specified name.&quot;;</span>
<span class="lineNum">    1189 </span>                :<span class="lineNoCov">          0 :         ri-&gt;down_after_period = atoi(argv[2]);</span>
<span class="lineNum">    1190 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ri-&gt;down_after_period &lt;= 0)</span>
<span class="lineNum">    1191 </span>                :            :             return &quot;negative or zero time parameter.&quot;;
<span class="lineNum">    1192 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     } else if (!strcasecmp(argv[0],&quot;failover-timeout&quot;) &amp;&amp; argc == 3) {</span>
<span class="lineNum">    1193 </span>                :            :         /* failover-timeout &lt;name&gt; &lt;milliseconds&gt; */
<span class="lineNum">    1194 </span>                :<span class="lineNoCov">          0 :         ri = sentinelGetMasterByName(argv[1]);</span>
<span class="lineNum">    1195 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!ri) return &quot;No such master with specified name.&quot;;</span>
<span class="lineNum">    1196 </span>                :<span class="lineNoCov">          0 :         ri-&gt;failover_timeout = atoi(argv[2]);</span>
<span class="lineNum">    1197 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ri-&gt;failover_timeout &lt;= 0)</span>
<span class="lineNum">    1198 </span>                :            :             return &quot;negative or zero time parameter.&quot;;
<span class="lineNum">    1199 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     } else if (!strcasecmp(argv[0],&quot;can-failover&quot;) &amp;&amp; argc == 3) {</span>
<span class="lineNum">    1200 </span>                :            :         /* can-failover &lt;name&gt; &lt;yes/no&gt; */
<span class="lineNum">    1201 </span>                :<span class="lineNoCov">          0 :         int yesno = yesnotoi(argv[2]);</span>
<span class="lineNum">    1202 </span>                :            : 
<span class="lineNum">    1203 </span>                :<span class="lineNoCov">          0 :         ri = sentinelGetMasterByName(argv[1]);</span>
<span class="lineNum">    1204 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!ri) return &quot;No such master with specified name.&quot;;</span>
<span class="lineNum">    1205 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (yesno == -1) return &quot;Argument must be either yes or no.&quot;;</span>
<span class="lineNum">    1206 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (yesno)</span>
<span class="lineNum">    1207 </span>                :<span class="lineNoCov">          0 :             ri-&gt;flags |= SRI_CAN_FAILOVER;</span>
<span class="lineNum">    1208 </span>                :            :         else
<span class="lineNum">    1209 </span>                :<span class="lineNoCov">          0 :             ri-&gt;flags &amp;= ~SRI_CAN_FAILOVER;</span>
<span class="lineNum">    1210 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :    } else if (!strcasecmp(argv[0],&quot;parallel-syncs&quot;) &amp;&amp; argc == 3) {</span>
<span class="lineNum">    1211 </span>                :            :         /* parallel-syncs &lt;name&gt; &lt;milliseconds&gt; */
<span class="lineNum">    1212 </span>                :<span class="lineNoCov">          0 :         ri = sentinelGetMasterByName(argv[1]);</span>
<span class="lineNum">    1213 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!ri) return &quot;No such master with specified name.&quot;;</span>
<span class="lineNum">    1214 </span>                :<span class="lineNoCov">          0 :         ri-&gt;parallel_syncs = atoi(argv[2]);</span>
<span class="lineNum">    1215 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :    } else if (!strcasecmp(argv[0],&quot;notification-script&quot;) &amp;&amp; argc == 3) {</span>
<span class="lineNum">    1216 </span>                :            :         /* notification-script &lt;name&gt; &lt;path&gt; */
<span class="lineNum">    1217 </span>                :<span class="lineNoCov">          0 :         ri = sentinelGetMasterByName(argv[1]);</span>
<span class="lineNum">    1218 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!ri) return &quot;No such master with specified name.&quot;;</span>
<span class="lineNum">    1219 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (access(argv[2],X_OK) == -1)</span>
<span class="lineNum">    1220 </span>                :            :             return &quot;Notification script seems non existing or non executable.&quot;;
<span class="lineNum">    1221 </span>                :<span class="lineNoCov">          0 :         ri-&gt;notification_script = sdsnew(argv[2]);</span>
<span class="lineNum">    1222 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :    } else if (!strcasecmp(argv[0],&quot;client-reconfig-script&quot;) &amp;&amp; argc == 3) {</span>
<span class="lineNum">    1223 </span>                :            :         /* client-reconfig-script &lt;name&gt; &lt;path&gt; */
<span class="lineNum">    1224 </span>                :<span class="lineNoCov">          0 :         ri = sentinelGetMasterByName(argv[1]);</span>
<span class="lineNum">    1225 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!ri) return &quot;No such master with specified name.&quot;;</span>
<span class="lineNum">    1226 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (access(argv[2],X_OK) == -1)</span>
<span class="lineNum">    1227 </span>                :            :             return &quot;Client reconfiguration script seems non existing or &quot;
<span class="lineNum">    1228 </span>                :            :                    &quot;non executable.&quot;;
<span class="lineNum">    1229 </span>                :<span class="lineNoCov">          0 :         ri-&gt;client_reconfig_script = sdsnew(argv[2]);</span>
<span class="lineNum">    1230 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :    } else if (!strcasecmp(argv[0],&quot;auth-pass&quot;) &amp;&amp; argc == 3) {</span>
<span class="lineNum">    1231 </span>                :            :         /* auth-pass &lt;name&gt; &lt;password&gt; */
<span class="lineNum">    1232 </span>                :<span class="lineNoCov">          0 :         ri = sentinelGetMasterByName(argv[1]);</span>
<span class="lineNum">    1233 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!ri) return &quot;No such master with specified name.&quot;;</span>
<span class="lineNum">    1234 </span>                :<span class="lineNoCov">          0 :         ri-&gt;auth_pass = sdsnew(argv[2]);</span>
<span class="lineNum">    1235 </span>                :            :     } else {
<span class="lineNum">    1236 </span>                :            :         return &quot;Unrecognized sentinel configuration statement.&quot;;
<span class="lineNum">    1237 </span>                :            :     }
<span class="lineNum">    1238 </span>                :<span class="lineNoCov">          0 :     return NULL;</span>
<span class="lineNum">    1239 </span>                :            : }
<span class="lineNum">    1240 </span>                :            : 
<span class="lineNum">    1241 </span>                :            : /* ====================== hiredis connection handling ======================= */
<a name="1242"><span class="lineNum">    1242 </span>                :            : </a>
<span class="lineNum">    1243 </span>                :            : /* Completely disconnect an hiredis link from an instance. */
<span class="lineNum">    1244 </span>                :<span class="lineNoCov">          0 : void sentinelKillLink(sentinelRedisInstance *ri, redisAsyncContext *c) {</span>
<span class="lineNum">    1245 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;cc == c) {</span>
<span class="lineNum">    1246 </span>                :<span class="lineNoCov">          0 :         ri-&gt;cc = NULL;</span>
<span class="lineNum">    1247 </span>                :<span class="lineNoCov">          0 :         ri-&gt;pending_commands = 0;</span>
<span class="lineNum">    1248 </span>                :            :     }
<span class="lineNum">    1249 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;pc == c) ri-&gt;pc = NULL;</span>
<span class="lineNum">    1250 </span>                :<span class="lineNoCov">          0 :     c-&gt;data = NULL;</span>
<span class="lineNum">    1251 </span>                :<span class="lineNoCov">          0 :     ri-&gt;flags |= SRI_DISCONNECTED;</span>
<span class="lineNum">    1252 </span>                :<span class="lineNoCov">          0 :     redisAsyncFree(c);</span>
<span class="lineNum">    1253 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1254 </span>                :            : 
<span class="lineNum">    1255 </span>                :            : /* This function takes an hiredis context that is in an error condition
<span class="lineNum">    1256 </span>                :            :  * and make sure to mark the instance as disconnected performing the
<span class="lineNum">    1257 </span>                :            :  * cleanup needed.
<span class="lineNum">    1258 </span>                :            :  *
<a name="1259"><span class="lineNum">    1259 </span>                :            :  * Note: we don't free the hiredis context as hiredis will do it for us</a>
<span class="lineNum">    1260 </span>                :            :  * for async connections. */
<span class="lineNum">    1261 </span>                :<span class="lineNoCov">          0 : void sentinelDisconnectInstanceFromContext(const redisAsyncContext *c) {</span>
<span class="lineNum">    1262 </span>                :<span class="lineNoCov">          0 :     sentinelRedisInstance *ri = c-&gt;data;</span>
<span class="lineNum">    1263 </span>                :            :     int pubsub;
<span class="lineNum">    1264 </span>                :            : 
<span class="lineNum">    1265 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri == NULL) return; /* The instance no longer exists. */</span>
<span class="lineNum">    1266 </span>                :            : 
<span class="lineNum">    1267 </span>                :<span class="lineNoCov">          0 :     pubsub = (ri-&gt;pc == c);</span>
<span class="lineNum">    1268 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     sentinelEvent(REDIS_DEBUG, pubsub ? &quot;-pubsub-link&quot; : &quot;-cmd-link&quot;, ri,</span>
<span class="lineNum">    1269 </span>                :            :         &quot;%@ #%s&quot;, c-&gt;errstr);
<span class="lineNum">    1270 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (pubsub)</span>
<span class="lineNum">    1271 </span>                :<span class="lineNoCov">          0 :         ri-&gt;pc = NULL;</span>
<span class="lineNum">    1272 </span>                :            :     else
<span class="lineNum">    1273 </span>                :<span class="lineNoCov">          0 :         ri-&gt;cc = NULL;</span>
<span class="lineNum">    1274 </span>                :<span class="lineNoCov">          0 :     ri-&gt;flags |= SRI_DISCONNECTED;</span>
<a name="1275"><span class="lineNum">    1275 </span>                :            : }</a>
<span class="lineNum">    1276 </span>                :            : 
<span class="lineNum">    1277 </span>                :<span class="lineNoCov">          0 : void sentinelLinkEstablishedCallback(const redisAsyncContext *c, int status) {</span>
<span class="lineNum">    1278 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (status != REDIS_OK) {</span>
<span class="lineNum">    1279 </span>                :<span class="lineNoCov">          0 :         sentinelDisconnectInstanceFromContext(c);</span>
<span class="lineNum">    1280 </span>                :            :     } else {
<span class="lineNum">    1281 </span>                :<span class="lineNoCov">          0 :         sentinelRedisInstance *ri = c-&gt;data;</span>
<span class="lineNum">    1282 </span>                :<span class="lineNoCov">          0 :         int pubsub = (ri-&gt;pc == c);</span>
<span class="lineNum">    1283 </span>                :            : 
<span class="lineNum">    1284 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         sentinelEvent(REDIS_DEBUG, pubsub ? &quot;+pubsub-link&quot; : &quot;+cmd-link&quot;, ri,</span>
<span class="lineNum">    1285 </span>                :            :             &quot;%@&quot;);
<span class="lineNum">    1286 </span>                :            :     }
<a name="1287"><span class="lineNum">    1287 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1288 </span>                :            : 
<span class="lineNum">    1289 </span>                :<span class="lineNoCov">          0 : void sentinelDisconnectCallback(const redisAsyncContext *c, int status) {</span>
<span class="lineNum">    1290 </span>                :<span class="lineNoCov">          0 :     sentinelDisconnectInstanceFromContext(c);</span>
<span class="lineNum">    1291 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1292 </span>                :            : 
<span class="lineNum">    1293 </span>                :            : /* Send the AUTH command with the specified master password if needed.
<span class="lineNum">    1294 </span>                :            :  * Note that for slaves the password set for the master is used.
<span class="lineNum">    1295 </span>                :            :  *
<span class="lineNum">    1296 </span>                :            :  * We don't check at all if the command was successfully transmitted
<a name="1297"><span class="lineNum">    1297 </span>                :            :  * to the instance as if it fails Sentinel will detect the instance down,</a>
<span class="lineNum">    1298 </span>                :            :  * will disconnect and reconnect the link and so forth. */
<span class="lineNum">    1299 </span>                :<span class="lineNoCov">          0 : void sentinelSendAuthIfNeeded(sentinelRedisInstance *ri, redisAsyncContext *c) {</span>
<span class="lineNum">    1300 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     char *auth_pass = (ri-&gt;flags &amp; SRI_MASTER) ? ri-&gt;auth_pass :</span>
<span class="lineNum">    1301 </span>                :<span class="lineNoCov">          0 :                                                  ri-&gt;master-&gt;auth_pass;</span>
<span class="lineNum">    1302 </span>                :            : 
<span class="lineNum">    1303 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (auth_pass)</span>
<span class="lineNum">    1304 </span>                :<span class="lineNoCov">          0 :         redisAsyncCommand(c, sentinelDiscardReplyCallback, NULL, &quot;AUTH %s&quot;,</span>
<span class="lineNum">    1305 </span>                :            :             auth_pass);
<span class="lineNum">    1306 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1307 </span>                :            : 
<span class="lineNum">    1308 </span>                :            : /* Create the async connections for the specified instance if the instance
<span class="lineNum">    1309 </span>                :            :  * is disconnected. Note that the SRI_DISCONNECTED flag is set even if just
<span class="lineNum">    1310 </span>                :            :  * one of the two links (commands and pub/sub) is missing. */
<span class="lineNum">    1311 </span>                :<span class="lineNoCov">          0 : void sentinelReconnectInstance(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    1312 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!(ri-&gt;flags &amp; SRI_DISCONNECTED)) return;</span>
<span class="lineNum">    1313 </span>                :            : 
<span class="lineNum">    1314 </span>                :            :     /* Commands connection. */
<span class="lineNum">    1315 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;cc == NULL) {</span>
<span class="lineNum">    1316 </span>                :<span class="lineNoCov">          0 :         ri-&gt;cc = redisAsyncConnect(ri-&gt;addr-&gt;ip,ri-&gt;addr-&gt;port);</span>
<span class="lineNum">    1317 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ri-&gt;cc-&gt;err) {</span>
<span class="lineNum">    1318 </span>                :<span class="lineNoCov">          0 :             sentinelEvent(REDIS_DEBUG,&quot;-cmd-link-reconnection&quot;,ri,&quot;%@ #%s&quot;,</span>
<span class="lineNum">    1319 </span>                :<span class="lineNoCov">          0 :                 ri-&gt;cc-&gt;errstr);</span>
<span class="lineNum">    1320 </span>                :<span class="lineNoCov">          0 :             sentinelKillLink(ri,ri-&gt;cc);</span>
<span class="lineNum">    1321 </span>                :            :         } else {
<span class="lineNum">    1322 </span>                :<span class="lineNoCov">          0 :             ri-&gt;cc_conn_time = mstime();</span>
<span class="lineNum">    1323 </span>                :<span class="lineNoCov">          0 :             ri-&gt;cc-&gt;data = ri;</span>
<span class="lineNum">    1324 </span>                :<span class="lineNoCov">          0 :             redisAeAttach(server.el,ri-&gt;cc);</span>
<span class="lineNum">    1325 </span>                :<span class="lineNoCov">          0 :             redisAsyncSetConnectCallback(ri-&gt;cc,</span>
<span class="lineNum">    1326 </span>                :            :                                             sentinelLinkEstablishedCallback);
<span class="lineNum">    1327 </span>                :<span class="lineNoCov">          0 :             redisAsyncSetDisconnectCallback(ri-&gt;cc,</span>
<span class="lineNum">    1328 </span>                :            :                                             sentinelDisconnectCallback);
<span class="lineNum">    1329 </span>                :<span class="lineNoCov">          0 :             sentinelSendAuthIfNeeded(ri,ri-&gt;cc);</span>
<span class="lineNum">    1330 </span>                :            :         }
<span class="lineNum">    1331 </span>                :            :     }
<span class="lineNum">    1332 </span>                :            :     /* Pub / Sub */
<span class="lineNum">    1333 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if ((ri-&gt;flags &amp; SRI_MASTER) &amp;&amp; ri-&gt;pc == NULL) {</span>
<span class="lineNum">    1334 </span>                :<span class="lineNoCov">          0 :         ri-&gt;pc = redisAsyncConnect(ri-&gt;addr-&gt;ip,ri-&gt;addr-&gt;port);</span>
<span class="lineNum">    1335 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ri-&gt;pc-&gt;err) {</span>
<span class="lineNum">    1336 </span>                :<span class="lineNoCov">          0 :             sentinelEvent(REDIS_DEBUG,&quot;-pubsub-link-reconnection&quot;,ri,&quot;%@ #%s&quot;,</span>
<span class="lineNum">    1337 </span>                :<span class="lineNoCov">          0 :                 ri-&gt;pc-&gt;errstr);</span>
<span class="lineNum">    1338 </span>                :<span class="lineNoCov">          0 :             sentinelKillLink(ri,ri-&gt;pc);</span>
<span class="lineNum">    1339 </span>                :            :         } else {
<span class="lineNum">    1340 </span>                :            :             int retval;
<span class="lineNum">    1341 </span>                :            : 
<span class="lineNum">    1342 </span>                :<span class="lineNoCov">          0 :             ri-&gt;pc_conn_time = mstime();</span>
<span class="lineNum">    1343 </span>                :<span class="lineNoCov">          0 :             ri-&gt;pc-&gt;data = ri;</span>
<span class="lineNum">    1344 </span>                :<span class="lineNoCov">          0 :             redisAeAttach(server.el,ri-&gt;pc);</span>
<span class="lineNum">    1345 </span>                :<span class="lineNoCov">          0 :             redisAsyncSetConnectCallback(ri-&gt;pc,</span>
<span class="lineNum">    1346 </span>                :            :                                             sentinelLinkEstablishedCallback);
<span class="lineNum">    1347 </span>                :<span class="lineNoCov">          0 :             redisAsyncSetDisconnectCallback(ri-&gt;pc,</span>
<span class="lineNum">    1348 </span>                :            :                                             sentinelDisconnectCallback);
<span class="lineNum">    1349 </span>                :<span class="lineNoCov">          0 :             sentinelSendAuthIfNeeded(ri,ri-&gt;pc);</span>
<span class="lineNum">    1350 </span>                :            :             /* Now we subscribe to the Sentinels &quot;Hello&quot; channel. */
<span class="lineNum">    1351 </span>                :<span class="lineNoCov">          0 :             retval = redisAsyncCommand(ri-&gt;pc,</span>
<span class="lineNum">    1352 </span>                :            :                 sentinelReceiveHelloMessages, NULL, &quot;SUBSCRIBE %s&quot;,
<span class="lineNum">    1353 </span>                :            :                     SENTINEL_HELLO_CHANNEL);
<span class="lineNum">    1354 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (retval != REDIS_OK) {</span>
<span class="lineNum">    1355 </span>                :            :                 /* If we can't subscribe, the Pub/Sub connection is useless
<span class="lineNum">    1356 </span>                :            :                  * and we can simply disconnect it and try again. */
<span class="lineNum">    1357 </span>                :<span class="lineNoCov">          0 :                 sentinelKillLink(ri,ri-&gt;pc);</span>
<span class="lineNum">    1358 </span>                :<span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1359 </span>                :            :             }
<span class="lineNum">    1360 </span>                :            :         }
<span class="lineNum">    1361 </span>                :            :     }
<span class="lineNum">    1362 </span>                :            :     /* Clear the DISCONNECTED flags only if we have both the connections
<span class="lineNum">    1363 </span>                :            :      * (or just the commands connection if this is a slave or a
<span class="lineNum">    1364 </span>                :            :      * sentinel instance). */
<span class="lineNum">    1365 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;cc &amp;&amp; (ri-&gt;flags &amp; (SRI_SLAVE|SRI_SENTINEL) || ri-&gt;pc))</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    1366 </span>                :<span class="lineNoCov">          0 :         ri-&gt;flags &amp;= ~SRI_DISCONNECTED;</span>
<span class="lineNum">    1367 </span>                :            : }
<span class="lineNum">    1368 </span>                :            : 
<span class="lineNum">    1369 </span>                :            : /* ======================== Redis instances pinging  ======================== */
<a name="1370"><span class="lineNum">    1370 </span>                :            : </a>
<span class="lineNum">    1371 </span>                :            : /* Process the INFO output from masters. */
<span class="lineNum">    1372 </span>                :<span class="lineNoCov">          0 : void sentinelRefreshInstanceInfo(sentinelRedisInstance *ri, const char *info) {</span>
<span class="lineNum">    1373 </span>                :            :     sds *lines;
<span class="lineNum">    1374 </span>                :            :     int numlines, j;
<span class="lineNum">    1375 </span>                :<span class="lineNoCov">          0 :     int role = 0;</span>
<span class="lineNum">    1376 </span>                :<span class="lineNoCov">          0 :     int runid_changed = 0;  /* true if runid changed. */</span>
<span class="lineNum">    1377 </span>                :<span class="lineNoCov">          0 :     int first_runid = 0;    /* true if this is the first runid we receive. */</span>
<span class="lineNum">    1378 </span>                :            : 
<span class="lineNum">    1379 </span>                :            :     /* The following fields must be reset to a given value in the case they
<span class="lineNum">    1380 </span>                :            :      * are not found at all in the INFO output. */
<span class="lineNum">    1381 </span>                :<span class="lineNoCov">          0 :     ri-&gt;master_link_down_time = 0;</span>
<span class="lineNum">    1382 </span>                :            : 
<span class="lineNum">    1383 </span>                :            :     /* Process line by line. */
<span class="lineNum">    1384 </span>                :<span class="lineNoCov">          0 :     lines = sdssplitlen(info,strlen(info),&quot;\r\n&quot;,2,&amp;numlines);</span>
<span class="lineNum">    1385 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (j = 0; j &lt; numlines; j++) {</span>
<span class="lineNum">    1386 </span>                :            :         sentinelRedisInstance *slave;
<span class="lineNum">    1387 </span>                :<span class="lineNoCov">          0 :         sds l = lines[j];</span>
<span class="lineNum">    1388 </span>                :            : 
<span class="lineNum">    1389 </span>                :            :         /* run_id:&lt;40 hex chars&gt;*/
<span class="lineNum">    1390 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (sdslen(l) &gt;= 47 &amp;&amp; !memcmp(l,&quot;run_id:&quot;,7)) {</span>
<span class="lineNum">    1391 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (ri-&gt;runid == NULL) {</span>
<span class="lineNum">    1392 </span>                :<span class="lineNoCov">          0 :                 ri-&gt;runid = sdsnewlen(l+7,40);</span>
<span class="lineNum">    1393 </span>                :<span class="lineNoCov">          0 :                 first_runid = 1;</span>
<span class="lineNum">    1394 </span>                :            :             } else {
<span class="lineNum">    1395 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (strncmp(ri-&gt;runid,l+7,40) != 0) {</span>
<span class="lineNum">    1396 </span>                :<span class="lineNoCov">          0 :                     runid_changed = 1;</span>
<span class="lineNum">    1397 </span>                :<span class="lineNoCov">          0 :                     sentinelEvent(REDIS_NOTICE,&quot;+reboot&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    1398 </span>                :<span class="lineNoCov">          0 :                     sdsfree(ri-&gt;runid);</span>
<span class="lineNum">    1399 </span>                :<span class="lineNoCov">          0 :                     ri-&gt;runid = sdsnewlen(l+7,40);</span>
<span class="lineNum">    1400 </span>                :            :                 }
<span class="lineNum">    1401 </span>                :            :             }
<span class="lineNum">    1402 </span>                :            :         }
<span class="lineNum">    1403 </span>                :            : 
<span class="lineNum">    1404 </span>                :            :         /* old versions: slave0:&lt;ip&gt;,&lt;port&gt;,&lt;state&gt;
<span class="lineNum">    1405 </span>                :            :          * new versions: slave0:ip=127.0.0.1,port=9999,... */
<span class="lineNum">    1406 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ((ri-&gt;flags &amp; SRI_MASTER) &amp;&amp;</span>
<span class="lineNum">    1407 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             sdslen(l) &gt;= 7 &amp;&amp;</span>
<span class="lineNum">    1408 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             !memcmp(l,&quot;slave&quot;,5) &amp;&amp; isdigit(l[5]))</span>
<span class="lineNum">    1409 </span>                :            :         {
<span class="lineNum">    1410 </span>                :            :             char *ip, *port, *end;
<span class="lineNum">    1411 </span>                :            : 
<span class="lineNum">    1412 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (strstr(l,&quot;ip=&quot;) == NULL) {</span>
<span class="lineNum">    1413 </span>                :            :                 /* Old format. */
<span class="lineNum">    1414 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ip = strchr(l,':'); if (!ip) continue;</span>
<span class="lineNum">    1415 </span>                :<span class="lineNoCov">          0 :                 ip++; /* Now ip points to start of ip address. */</span>
<span class="lineNum">    1416 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 port = strchr(ip,','); if (!port) continue;</span>
<span class="lineNum">    1417 </span>                :<span class="lineNoCov">          0 :                 *port = '\0'; /* nul term for easy access. */</span>
<span class="lineNum">    1418 </span>                :<span class="lineNoCov">          0 :                 port++; /* Now port points to start of port number. */</span>
<span class="lineNum">    1419 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 end = strchr(port,','); if (!end) continue;</span>
<span class="lineNum">    1420 </span>                :<span class="lineNoCov">          0 :                 *end = '\0'; /* nul term for easy access. */</span>
<span class="lineNum">    1421 </span>                :            :             } else {
<span class="lineNum">    1422 </span>                :            :                 /* New format. */
<span class="lineNum">    1423 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ip = strstr(l,&quot;ip=&quot;); if (!ip) continue;</span>
<span class="lineNum">    1424 </span>                :<span class="lineNoCov">          0 :                 ip += 3; /* Now ip points to start of ip address. */</span>
<span class="lineNum">    1425 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 port = strstr(l,&quot;port=&quot;); if (!port) continue;</span>
<span class="lineNum">    1426 </span>                :<span class="lineNoCov">          0 :                 port += 5; /* Now port points to start of port number. */</span>
<span class="lineNum">    1427 </span>                :            :                 /* Nul term both fields for easy access. */
<span class="lineNum">    1428 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 end = strchr(ip,','); if (end) *end = '\0';</span>
<span class="lineNum">    1429 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 end = strchr(port,','); if (end) *end = '\0';</span>
<span class="lineNum">    1430 </span>                :            :             }
<span class="lineNum">    1431 </span>                :            : 
<span class="lineNum">    1432 </span>                :            :             /* Check if we already have this slave into our table,
<span class="lineNum">    1433 </span>                :            :              * otherwise add it. */
<span class="lineNum">    1434 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (sentinelRedisInstanceLookupSlave(ri,ip,atoi(port)) == NULL) {</span>
<span class="lineNum">    1435 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if ((slave = createSentinelRedisInstance(NULL,SRI_SLAVE,ip,</span>
<span class="lineNum">    1436 </span>                :            :                             atoi(port), ri-&gt;quorum, ri)) != NULL)
<span class="lineNum">    1437 </span>                :            :                 {
<span class="lineNum">    1438 </span>                :<span class="lineNoCov">          0 :                     sentinelEvent(REDIS_NOTICE,&quot;+slave&quot;,slave,&quot;%@&quot;);</span>
<span class="lineNum">    1439 </span>                :            :                 }
<span class="lineNum">    1440 </span>                :            :             }
<span class="lineNum">    1441 </span>                :            :         }
<span class="lineNum">    1442 </span>                :            : 
<span class="lineNum">    1443 </span>                :            :         /* master_link_down_since_seconds:&lt;seconds&gt; */
<span class="lineNum">    1444 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (sdslen(l) &gt;= 32 &amp;&amp;</span>
<span class="lineNum">    1445 </span>                :<span class="lineNoCov">          0 :             !memcmp(l,&quot;master_link_down_since_seconds&quot;,30))</span>
<span class="lineNum">    1446 </span>                :            :         {
<span class="lineNum">    1447 </span>                :<span class="lineNoCov">          0 :             ri-&gt;master_link_down_time = strtoll(l+31,NULL,10)*1000;</span>
<span class="lineNum">    1448 </span>                :            :         }
<span class="lineNum">    1449 </span>                :            : 
<span class="lineNum">    1450 </span>                :            :         /* role:&lt;role&gt; */
<span class="lineNum">    1451 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!memcmp(l,&quot;role:master&quot;,11)) role = SRI_MASTER;</span>
<span class="lineNum">    1452 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         else if (!memcmp(l,&quot;role:slave&quot;,10)) role = SRI_SLAVE;</span>
<span class="lineNum">    1453 </span>                :            : 
<span class="lineNum">    1454 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (role == SRI_SLAVE) {</span>
<span class="lineNum">    1455 </span>                :            :             /* master_host:&lt;host&gt; */
<span class="lineNum">    1456 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (sdslen(l) &gt;= 12 &amp;&amp; !memcmp(l,&quot;master_host:&quot;,12)) {</span>
<span class="lineNum">    1457 </span>                :<span class="lineNoCov">          0 :                 sdsfree(ri-&gt;slave_master_host);</span>
<span class="lineNum">    1458 </span>                :<span class="lineNoCov">          0 :                 ri-&gt;slave_master_host = sdsnew(l+12);</span>
<span class="lineNum">    1459 </span>                :            :             }
<span class="lineNum">    1460 </span>                :            : 
<span class="lineNum">    1461 </span>                :            :             /* master_port:&lt;port&gt; */
<span class="lineNum">    1462 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (sdslen(l) &gt;= 12 &amp;&amp; !memcmp(l,&quot;master_port:&quot;,12))</span>
<span class="lineNum">    1463 </span>                :<span class="lineNoCov">          0 :                 ri-&gt;slave_master_port = atoi(l+12);</span>
<span class="lineNum">    1464 </span>                :            :             
<span class="lineNum">    1465 </span>                :            :             /* master_link_status:&lt;status&gt; */
<span class="lineNum">    1466 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (sdslen(l) &gt;= 19 &amp;&amp; !memcmp(l,&quot;master_link_status:&quot;,19)) {</span>
<span class="lineNum">    1467 </span>                :<span class="lineNoCov">          0 :                 ri-&gt;slave_master_link_status =</span>
<span class="lineNum">    1468 </span>                :<span class="lineNoCov">          0 :                     (strcasecmp(l+19,&quot;up&quot;) == 0) ?</span>
<span class="lineNum">    1469 </span>                :<span class="lineNoCov">          0 :                     SENTINEL_MASTER_LINK_STATUS_UP :</span>
<span class="lineNum">    1470 </span>                :            :                     SENTINEL_MASTER_LINK_STATUS_DOWN;
<span class="lineNum">    1471 </span>                :            :             }
<span class="lineNum">    1472 </span>                :            : 
<span class="lineNum">    1473 </span>                :            :             /* slave_priority:&lt;priority&gt; */
<span class="lineNum">    1474 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (sdslen(l) &gt;= 15 &amp;&amp; !memcmp(l,&quot;slave_priority:&quot;,15))</span>
<span class="lineNum">    1475 </span>                :<span class="lineNoCov">          0 :                 ri-&gt;slave_priority = atoi(l+15);</span>
<span class="lineNum">    1476 </span>                :            :         }
<span class="lineNum">    1477 </span>                :            :     }
<span class="lineNum">    1478 </span>                :<span class="lineNoCov">          0 :     ri-&gt;info_refresh = mstime();</span>
<span class="lineNum">    1479 </span>                :<span class="lineNoCov">          0 :     sdsfreesplitres(lines,numlines);</span>
<span class="lineNum">    1480 </span>                :            : 
<span class="lineNum">    1481 </span>                :            :     /* ---------------------------- Acting half -----------------------------
<span class="lineNum">    1482 </span>                :            :      * Some things will not happen if sentinel.tilt is true, but some will
<span class="lineNum">    1483 </span>                :            :      * still be processed. */
<span class="lineNum">    1484 </span>                :            : 
<span class="lineNum">    1485 </span>                :            :     /* When what we believe is our master, turned into a slave, the wiser
<span class="lineNum">    1486 </span>                :            :      * thing we can do is to follow the events and redirect to the new
<span class="lineNum">    1487 </span>                :            :      * master, always. */
<span class="lineNum">    1488 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if ((ri-&gt;flags &amp; SRI_MASTER) &amp;&amp; role == SRI_SLAVE &amp;&amp; ri-&gt;slave_master_host)</span>
<span class="lineNum">    1489 </span>                :            :     {
<span class="lineNum">    1490 </span>                :<span class="lineNoCov">          0 :         sentinelEvent(REDIS_WARNING,&quot;+redirect-to-master&quot;,ri,</span>
<span class="lineNum">    1491 </span>                :            :             &quot;%s %s %d %s %d&quot;,
<span class="lineNum">    1492 </span>                :<span class="lineNoCov">          0 :             ri-&gt;name, ri-&gt;addr-&gt;ip, ri-&gt;addr-&gt;port,</span>
<span class="lineNum">    1493 </span>                :            :             ri-&gt;slave_master_host, ri-&gt;slave_master_port);
<span class="lineNum">    1494 </span>                :<span class="lineNoCov">          0 :         sentinelResetMasterAndChangeAddress(ri,ri-&gt;slave_master_host,</span>
<span class="lineNum">    1495 </span>                :            :                                                ri-&gt;slave_master_port);
<span class="lineNum">    1496 </span>                :<span class="lineNoCov">          0 :         return; /* Don't process anything after this event. */</span>
<span class="lineNum">    1497 </span>                :            :     }
<span class="lineNum">    1498 </span>                :            : 
<span class="lineNum">    1499 </span>                :            :     /* Handle slave -&gt; master role switch. */
<span class="lineNum">    1500 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if ((ri-&gt;flags &amp; SRI_SLAVE) &amp;&amp; role == SRI_MASTER) {</span>
<span class="lineNum">    1501 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!sentinel.tilt &amp;&amp; ri-&gt;flags &amp; SRI_DEMOTE) {</span>
<span class="lineNum">    1502 </span>                :            :             /* If this sentinel was partitioned from the slave's master,
<span class="lineNum">    1503 </span>                :            :              * or tilted recently, wait some time before to act,
<span class="lineNum">    1504 </span>                :            :              * so that DOWN and roles INFO will be refreshed. */
<span class="lineNum">    1505 </span>                :<span class="lineNoCov">          0 :             mstime_t wait_time = SENTINEL_INFO_PERIOD*2 +</span>
<span class="lineNum">    1506 </span>                :<span class="lineNoCov">          0 :                                  ri-&gt;master-&gt;down_after_period*2;</span>
<span class="lineNum">    1507 </span>                :            : 
<span class="lineNum">    1508 </span>  [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (!sentinelRedisInstanceNoDownFor(ri-&gt;master,wait_time) ||</span>
<span class="lineNum">    1509 </span>                :<span class="lineNoCov">          0 :                 (mstime()-sentinel.tilt_start_time) &lt; wait_time)</span>
<span class="lineNum">    1510 </span>                :            :                 return;
<span class="lineNum">    1511 </span>                :            : 
<span class="lineNum">    1512 </span>                :            :             /* Old master returned back? Turn it into a slave ASAP if
<span class="lineNum">    1513 </span>                :            :              * we can reach what we believe is the new master now, and
<span class="lineNum">    1514 </span>                :            :              * have a recent role information for it.
<span class="lineNum">    1515 </span>                :            :              *
<span class="lineNum">    1516 </span>                :            :              * Note: we'll clear the DEMOTE flag only when we have the
<span class="lineNum">    1517 </span>                :            :              * acknowledge that it's a slave again. */
<span class="lineNum">    1518 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (ri-&gt;master-&gt;flags &amp; SRI_MASTER &amp;&amp;</span>
<span class="lineNum">    1519 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 (ri-&gt;master-&gt;flags &amp; (SRI_S_DOWN|SRI_O_DOWN)) == 0 &amp;&amp;</span>
<span class="lineNum">    1520 </span>                :<span class="lineNoCov">          0 :                 (mstime() - ri-&gt;master-&gt;info_refresh) &lt; SENTINEL_INFO_PERIOD*2)</span>
<span class="lineNum">    1521 </span>                :            :             {
<span class="lineNum">    1522 </span>                :            :                 int retval;
<span class="lineNum">    1523 </span>                :<span class="lineNoCov">          0 :                 retval = redisAsyncCommand(ri-&gt;cc,</span>
<span class="lineNum">    1524 </span>                :            :                     sentinelDiscardReplyCallback, NULL, &quot;SLAVEOF %s %d&quot;,
<span class="lineNum">    1525 </span>                :<span class="lineNoCov">          0 :                         ri-&gt;master-&gt;addr-&gt;ip,</span>
<span class="lineNum">    1526 </span>                :<span class="lineNoCov">          0 :                         ri-&gt;master-&gt;addr-&gt;port);</span>
<span class="lineNum">    1527 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (retval == REDIS_OK)</span>
<span class="lineNum">    1528 </span>                :<span class="lineNoCov">          0 :                     sentinelEvent(REDIS_NOTICE,&quot;+demote-old-slave&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    1529 </span>                :            :             } else {
<span class="lineNum">    1530 </span>                :            :                 /* Otherwise if there are not the conditions to demote, we
<span class="lineNum">    1531 </span>                :            :                  * no longer trust the DEMOTE flag and remove it. */
<span class="lineNum">    1532 </span>                :<span class="lineNoCov">          0 :                 ri-&gt;flags &amp;= ~SRI_DEMOTE;</span>
<span class="lineNum">    1533 </span>                :<span class="lineNoCov">          0 :                 sentinelEvent(REDIS_NOTICE,&quot;-demote-flag-cleared&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    1534 </span>                :            :             }
<span class="lineNum">    1535 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         } else if (!(ri-&gt;master-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) &amp;&amp;</span>
<span class="lineNum">    1536 </span>                :<span class="lineNoCov">          0 :                     (runid_changed || first_runid))</span>
<span class="lineNum">    1537 </span>                :            :         {
<span class="lineNum">    1538 </span>                :            :             /* If a slave turned into master but:
<span class="lineNum">    1539 </span>                :            :              *
<span class="lineNum">    1540 </span>                :            :              * 1) Failover not in progress.
<span class="lineNum">    1541 </span>                :            :              * 2) RunID has changed or its the first time we see an INFO output.
<span class="lineNum">    1542 </span>                :            :              * 
<span class="lineNum">    1543 </span>                :            :              * We assume this is a reboot with a wrong configuration.
<span class="lineNum">    1544 </span>                :            :              * Log the event and remove the slave. Note that this is processed
<span class="lineNum">    1545 </span>                :            :              * in tilt mode as well, otherwise we lose the information that the
<span class="lineNum">    1546 </span>                :            :              * runid changed (reboot?) and when the tilt mode ends a fake
<span class="lineNum">    1547 </span>                :            :              * failover will be detected. */
<span class="lineNum">    1548 </span>                :            :             int retval;
<span class="lineNum">    1549 </span>                :            : 
<span class="lineNum">    1550 </span>                :<span class="lineNoCov">          0 :             sentinelEvent(REDIS_WARNING,&quot;-slave-restart-as-master&quot;,ri,&quot;%@ #removing it from the attached slaves&quot;);</span>
<span class="lineNum">    1551 </span>                :<span class="lineNoCov">          0 :             retval = dictDelete(ri-&gt;master-&gt;slaves,ri-&gt;name);</span>
<span class="lineNum">    1552 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             redisAssert(retval == REDIS_OK);</span>
<span class="lineNum">    1553 </span>                :            :             return;
<span class="lineNum">    1554 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         } else if (!sentinel.tilt &amp;&amp; ri-&gt;flags &amp; SRI_PROMOTED) {</span>
<span class="lineNum">    1555 </span>                :            :             /* If this is a promoted slave we can change state to the
<span class="lineNum">    1556 </span>                :            :              * failover state machine. */
<span class="lineNum">    1557 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if ((ri-&gt;master-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) &amp;&amp;</span>
<span class="lineNum">    1558 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 (ri-&gt;master-&gt;flags &amp; SRI_I_AM_THE_LEADER) &amp;&amp;</span>
<span class="lineNum">    1559 </span>                :<span class="lineNoCov">          0 :                 (ri-&gt;master-&gt;failover_state ==</span>
<span class="lineNum">    1560 </span>                :            :                     SENTINEL_FAILOVER_STATE_WAIT_PROMOTION))
<span class="lineNum">    1561 </span>                :            :             {
<span class="lineNum">    1562 </span>                :<span class="lineNoCov">          0 :                 ri-&gt;master-&gt;failover_state = SENTINEL_FAILOVER_STATE_RECONF_SLAVES;</span>
<span class="lineNum">    1563 </span>                :<span class="lineNoCov">          0 :                 ri-&gt;master-&gt;failover_state_change_time = mstime();</span>
<span class="lineNum">    1564 </span>                :<span class="lineNoCov">          0 :                 sentinelEvent(REDIS_WARNING,&quot;+promoted-slave&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    1565 </span>                :<span class="lineNoCov">          0 :                 sentinelEvent(REDIS_WARNING,&quot;+failover-state-reconf-slaves&quot;,</span>
<span class="lineNum">    1566 </span>                :<span class="lineNoCov">          0 :                     ri-&gt;master,&quot;%@&quot;);</span>
<span class="lineNum">    1567 </span>                :<span class="lineNoCov">          0 :                 sentinelCallClientReconfScript(ri-&gt;master,SENTINEL_LEADER,</span>
<span class="lineNum">    1568 </span>                :<span class="lineNoCov">          0 :                     &quot;start&quot;,ri-&gt;master-&gt;addr,ri-&gt;addr);</span>
<span class="lineNum">    1569 </span>                :            :             }
<span class="lineNum">    1570 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         } else if (!sentinel.tilt &amp;&amp; (</span>
<span class="lineNum">    1571 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     !(ri-&gt;master-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) ||</span>
<span class="lineNum">    1572 </span>                :<span class="lineNoCov">          0 :                      ((ri-&gt;master-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) &amp;&amp;</span>
<span class="lineNum">    1573 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                       (ri-&gt;master-&gt;flags &amp; SRI_I_AM_THE_LEADER) &amp;&amp;</span>
<span class="lineNum">    1574 </span>                :<span class="lineNoCov">          0 :                        ri-&gt;master-&gt;failover_state ==</span>
<span class="lineNum">    1575 </span>                :            :                        SENTINEL_FAILOVER_STATE_WAIT_START)))
<span class="lineNum">    1576 </span>                :            :         {
<span class="lineNum">    1577 </span>                :            :             /* No failover in progress? Then it is the start of a failover
<span class="lineNum">    1578 </span>                :            :              * and we are an observer.
<span class="lineNum">    1579 </span>                :            :              *
<span class="lineNum">    1580 </span>                :            :              * We also do that if we are a leader doing a failover, in wait
<span class="lineNum">    1581 </span>                :            :              * start, but well, somebody else started before us. */
<span class="lineNum">    1582 </span>                :            : 
<span class="lineNum">    1583 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (ri-&gt;master-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) {</span>
<span class="lineNum">    1584 </span>                :<span class="lineNoCov">          0 :                 sentinelEvent(REDIS_WARNING,&quot;-failover-abort-race&quot;,</span>
<span class="lineNum">    1585 </span>                :<span class="lineNoCov">          0 :                                 ri-&gt;master, &quot;%@&quot;);</span>
<span class="lineNum">    1586 </span>                :<span class="lineNoCov">          0 :                 sentinelAbortFailover(ri-&gt;master);</span>
<span class="lineNum">    1587 </span>                :            :             }
<span class="lineNum">    1588 </span>                :            : 
<span class="lineNum">    1589 </span>                :<span class="lineNoCov">          0 :             ri-&gt;master-&gt;flags |= SRI_FAILOVER_IN_PROGRESS;</span>
<span class="lineNum">    1590 </span>                :<span class="lineNoCov">          0 :             sentinelEvent(REDIS_WARNING,&quot;+failover-detected&quot;,ri-&gt;master,&quot;%@&quot;);</span>
<span class="lineNum">    1591 </span>                :<span class="lineNoCov">          0 :             ri-&gt;master-&gt;failover_state = SENTINEL_FAILOVER_STATE_DETECT_END;</span>
<span class="lineNum">    1592 </span>                :<span class="lineNoCov">          0 :             ri-&gt;master-&gt;failover_state_change_time = mstime();</span>
<span class="lineNum">    1593 </span>                :<span class="lineNoCov">          0 :             ri-&gt;master-&gt;promoted_slave = ri;</span>
<span class="lineNum">    1594 </span>                :<span class="lineNoCov">          0 :             ri-&gt;flags |= SRI_PROMOTED;</span>
<span class="lineNum">    1595 </span>                :<span class="lineNoCov">          0 :             ri-&gt;flags &amp;= ~SRI_DEMOTE;</span>
<span class="lineNum">    1596 </span>                :<span class="lineNoCov">          0 :             sentinelCallClientReconfScript(ri-&gt;master,SENTINEL_OBSERVER,</span>
<span class="lineNum">    1597 </span>                :<span class="lineNoCov">          0 :                 &quot;start&quot;, ri-&gt;master-&gt;addr,ri-&gt;addr);</span>
<span class="lineNum">    1598 </span>                :            :             /* We are an observer, so we can only assume that the leader
<span class="lineNum">    1599 </span>                :            :              * is reconfiguring the slave instances. For this reason we
<span class="lineNum">    1600 </span>                :            :              * set all the instances as RECONF_SENT waiting for progresses
<span class="lineNum">    1601 </span>                :            :              * on this side. */
<span class="lineNum">    1602 </span>                :<span class="lineNoCov">          0 :             sentinelAddFlagsToDictOfRedisInstances(ri-&gt;master-&gt;slaves,</span>
<span class="lineNum">    1603 </span>                :            :                 SRI_RECONF_SENT);
<span class="lineNum">    1604 </span>                :            :         }
<span class="lineNum">    1605 </span>                :            :     }
<span class="lineNum">    1606 </span>                :            : 
<span class="lineNum">    1607 </span>                :            :     /* None of the following conditions are processed when in tilt mode, so
<span class="lineNum">    1608 </span>                :            :      * return asap. */
<span class="lineNum">    1609 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (sentinel.tilt) return;</span>
<span class="lineNum">    1610 </span>                :            : 
<span class="lineNum">    1611 </span>                :            :     /* Detect if the slave that is in the process of being reconfigured
<span class="lineNum">    1612 </span>                :            :      * changed state. */
<span class="lineNum">    1613 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if ((ri-&gt;flags &amp; SRI_SLAVE) &amp;&amp; role == SRI_SLAVE &amp;&amp;</span>
<span class="lineNum">    1614 </span>                :<span class="lineNoCov">          0 :         (ri-&gt;flags &amp; (SRI_RECONF_SENT|SRI_RECONF_INPROG)))</span>
<span class="lineNum">    1615 </span>                :            :     {
<span class="lineNum">    1616 </span>                :            :         /* SRI_RECONF_SENT -&gt; SRI_RECONF_INPROG. */
<span class="lineNum">    1617 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ((ri-&gt;flags &amp; SRI_RECONF_SENT) &amp;&amp;</span>
<span class="lineNum">    1618 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             ri-&gt;slave_master_host &amp;&amp;</span>
<span class="lineNum">    1619 </span>                :<span class="lineNoCov">          0 :             strcmp(ri-&gt;slave_master_host,</span>
<span class="lineNum">    1620 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     ri-&gt;master-&gt;promoted_slave-&gt;addr-&gt;ip) == 0 &amp;&amp;</span>
<span class="lineNum">    1621 </span>                :<span class="lineNoCov">          0 :             ri-&gt;slave_master_port == ri-&gt;master-&gt;promoted_slave-&gt;addr-&gt;port)</span>
<span class="lineNum">    1622 </span>                :            :         {
<span class="lineNum">    1623 </span>                :<span class="lineNoCov">          0 :             ri-&gt;flags &amp;= ~SRI_RECONF_SENT;</span>
<span class="lineNum">    1624 </span>                :<span class="lineNoCov">          0 :             ri-&gt;flags |= SRI_RECONF_INPROG;</span>
<span class="lineNum">    1625 </span>                :<span class="lineNoCov">          0 :             sentinelEvent(REDIS_NOTICE,&quot;+slave-reconf-inprog&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    1626 </span>                :            :         }
<span class="lineNum">    1627 </span>                :            : 
<span class="lineNum">    1628 </span>                :            :         /* SRI_RECONF_INPROG -&gt; SRI_RECONF_DONE */
<span class="lineNum">    1629 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ((ri-&gt;flags &amp; SRI_RECONF_INPROG) &amp;&amp;</span>
<span class="lineNum">    1630 </span>                :<span class="lineNoCov">          0 :             ri-&gt;slave_master_link_status == SENTINEL_MASTER_LINK_STATUS_UP)</span>
<span class="lineNum">    1631 </span>                :            :         {
<span class="lineNum">    1632 </span>                :<span class="lineNoCov">          0 :             ri-&gt;flags &amp;= ~SRI_RECONF_INPROG;</span>
<span class="lineNum">    1633 </span>                :<span class="lineNoCov">          0 :             ri-&gt;flags |= SRI_RECONF_DONE;</span>
<span class="lineNum">    1634 </span>                :<span class="lineNoCov">          0 :             sentinelEvent(REDIS_NOTICE,&quot;+slave-reconf-done&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    1635 </span>                :            :             /* If we are moving forward (a new slave is now configured)
<span class="lineNum">    1636 </span>                :            :              * we update the change_time as we are conceptually passing
<span class="lineNum">    1637 </span>                :            :              * to the next slave. */
<span class="lineNum">    1638 </span>                :<span class="lineNoCov">          0 :             ri-&gt;failover_state_change_time = mstime();</span>
<span class="lineNum">    1639 </span>                :            :         }
<span class="lineNum">    1640 </span>                :            :     }
<span class="lineNum">    1641 </span>                :            : 
<span class="lineNum">    1642 </span>                :            :     /* Detect if the old master was demoted as slave and generate the
<span class="lineNum">    1643 </span>                :            :      * +slave event. */
<span class="lineNum">    1644 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (role == SRI_SLAVE &amp;&amp; ri-&gt;flags &amp; SRI_DEMOTE) {</span>
<span class="lineNum">    1645 </span>                :<span class="lineNoCov">          0 :         sentinelEvent(REDIS_NOTICE,&quot;+slave&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    1646 </span>                :<span class="lineNoCov">          0 :         ri-&gt;flags &amp;= ~SRI_DEMOTE;</span>
<span class="lineNum">    1647 </span>                :            :     }
<a name="1648"><span class="lineNum">    1648 </span>                :            : }</a>
<span class="lineNum">    1649 </span>                :            : 
<span class="lineNum">    1650 </span>                :<span class="lineNoCov">          0 : void sentinelInfoReplyCallback(redisAsyncContext *c, void *reply, void *privdata) {</span>
<span class="lineNum">    1651 </span>                :<span class="lineNoCov">          0 :     sentinelRedisInstance *ri = c-&gt;data;</span>
<span class="lineNum">    1652 </span>                :            :     redisReply *r;
<span class="lineNum">    1653 </span>                :            : 
<span class="lineNum">    1654 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri) ri-&gt;pending_commands--;</span>
<span class="lineNum">    1655 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!reply || !ri) return;</span>
<span class="lineNum">    1656 </span>                :<span class="lineNoCov">          0 :     r = reply;</span>
<span class="lineNum">    1657 </span>                :            : 
<span class="lineNum">    1658 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (r-&gt;type == REDIS_REPLY_STRING) {</span>
<span class="lineNum">    1659 </span>                :<span class="lineNoCov">          0 :         sentinelRefreshInstanceInfo(ri,r-&gt;str);</span>
<span class="lineNum">    1660 </span>                :            :     }
<span class="lineNum">    1661 </span>                :            : }
<span class="lineNum">    1662 </span>                :            : 
<a name="1663"><span class="lineNum">    1663 </span>                :            : /* Just discard the reply. We use this when we are not monitoring the return</a>
<span class="lineNum">    1664 </span>                :            :  * value of the command but its effects directly. */
<span class="lineNum">    1665 </span>                :<span class="lineNoCov">          0 : void sentinelDiscardReplyCallback(redisAsyncContext *c, void *reply, void *privdata) {</span>
<span class="lineNum">    1666 </span>                :<span class="lineNoCov">          0 :     sentinelRedisInstance *ri = c-&gt;data;</span>
<span class="lineNum">    1667 </span>                :            : 
<span class="lineNum">    1668 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri) ri-&gt;pending_commands--;</span>
<a name="1669"><span class="lineNum">    1669 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1670 </span>                :            : 
<span class="lineNum">    1671 </span>                :<span class="lineNoCov">          0 : void sentinelPingReplyCallback(redisAsyncContext *c, void *reply, void *privdata) {</span>
<span class="lineNum">    1672 </span>                :<span class="lineNoCov">          0 :     sentinelRedisInstance *ri = c-&gt;data;</span>
<span class="lineNum">    1673 </span>                :            :     redisReply *r;
<span class="lineNum">    1674 </span>                :            : 
<span class="lineNum">    1675 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri) ri-&gt;pending_commands--;</span>
<span class="lineNum">    1676 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!reply || !ri) return;</span>
<span class="lineNum">    1677 </span>                :<span class="lineNoCov">          0 :     r = reply;</span>
<span class="lineNum">    1678 </span>                :            : 
<span class="lineNum">    1679 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (r-&gt;type == REDIS_REPLY_STATUS ||</span>
<span class="lineNum">    1680 </span>                :            :         r-&gt;type == REDIS_REPLY_ERROR) {
<span class="lineNum">    1681 </span>                :            :         /* Update the &quot;instance available&quot; field only if this is an
<span class="lineNum">    1682 </span>                :            :          * acceptable reply. */
<span class="lineNum">    1683 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (strncmp(r-&gt;str,&quot;PONG&quot;,4) == 0 ||</span>
<span class="lineNum">    1684 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             strncmp(r-&gt;str,&quot;LOADING&quot;,7) == 0 ||</span>
<span class="lineNum">    1685 </span>                :<span class="lineNoCov">          0 :             strncmp(r-&gt;str,&quot;MASTERDOWN&quot;,10) == 0)</span>
<span class="lineNum">    1686 </span>                :            :         {
<span class="lineNum">    1687 </span>                :<span class="lineNoCov">          0 :             ri-&gt;last_avail_time = mstime();</span>
<span class="lineNum">    1688 </span>                :            :         } else {
<span class="lineNum">    1689 </span>                :            :             /* Send a SCRIPT KILL command if the instance appears to be
<span class="lineNum">    1690 </span>                :            :              * down because of a busy script. */
<span class="lineNum">    1691 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (strncmp(r-&gt;str,&quot;BUSY&quot;,4) == 0 &amp;&amp;</span>
<span class="lineNum">    1692 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 (ri-&gt;flags &amp; SRI_S_DOWN) &amp;&amp;</span>
<span class="lineNum">    1693 </span>                :            :                 !(ri-&gt;flags &amp; SRI_SCRIPT_KILL_SENT))
<span class="lineNum">    1694 </span>                :            :             {
<span class="lineNum">    1695 </span>                :<span class="lineNoCov">          0 :                 redisAsyncCommand(ri-&gt;cc,</span>
<span class="lineNum">    1696 </span>                :            :                     sentinelDiscardReplyCallback, NULL, &quot;SCRIPT KILL&quot;);
<span class="lineNum">    1697 </span>                :<span class="lineNoCov">          0 :                 ri-&gt;flags |= SRI_SCRIPT_KILL_SENT;</span>
<span class="lineNum">    1698 </span>                :            :             }
<span class="lineNum">    1699 </span>                :            :         }
<span class="lineNum">    1700 </span>                :            :     }
<span class="lineNum">    1701 </span>                :<span class="lineNoCov">          0 :     ri-&gt;last_pong_time = mstime();</span>
<span class="lineNum">    1702 </span>                :            : }
<span class="lineNum">    1703 </span>                :            : 
<a name="1704"><span class="lineNum">    1704 </span>                :            : /* This is called when we get the reply about the PUBLISH command we send</a>
<span class="lineNum">    1705 </span>                :            :  * to the master to advertise this sentinel. */
<span class="lineNum">    1706 </span>                :<span class="lineNoCov">          0 : void sentinelPublishReplyCallback(redisAsyncContext *c, void *reply, void *privdata) {</span>
<span class="lineNum">    1707 </span>                :<span class="lineNoCov">          0 :     sentinelRedisInstance *ri = c-&gt;data;</span>
<span class="lineNum">    1708 </span>                :            :     redisReply *r;
<span class="lineNum">    1709 </span>                :            : 
<span class="lineNum">    1710 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri) ri-&gt;pending_commands--;</span>
<span class="lineNum">    1711 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!reply || !ri) return;</span>
<span class="lineNum">    1712 </span>                :<span class="lineNoCov">          0 :     r = reply;</span>
<span class="lineNum">    1713 </span>                :            : 
<span class="lineNum">    1714 </span>                :            :     /* Only update pub_time if we actually published our message. Otherwise
<span class="lineNum">    1715 </span>                :            :      * we'll retry against in 100 milliseconds. */
<span class="lineNum">    1716 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (r-&gt;type != REDIS_REPLY_ERROR)</span>
<span class="lineNum">    1717 </span>                :<span class="lineNoCov">          0 :         ri-&gt;last_pub_time = mstime();</span>
<span class="lineNum">    1718 </span>                :            : }
<span class="lineNum">    1719 </span>                :            : 
<a name="1720"><span class="lineNum">    1720 </span>                :            : /* This is our Pub/Sub callback for the Hello channel. It's useful in order</a>
<span class="lineNum">    1721 </span>                :            :  * to discover other sentinels attached at the same master. */
<span class="lineNum">    1722 </span>                :<span class="lineNoCov">          0 : void sentinelReceiveHelloMessages(redisAsyncContext *c, void *reply, void *privdata) {</span>
<span class="lineNum">    1723 </span>                :<span class="lineNoCov">          0 :     sentinelRedisInstance *ri = c-&gt;data;</span>
<span class="lineNum">    1724 </span>                :            :     redisReply *r;
<span class="lineNum">    1725 </span>                :            : 
<span class="lineNum">    1726 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!reply || !ri) return;</span>
<span class="lineNum">    1727 </span>                :<span class="lineNoCov">          0 :     r = reply;</span>
<span class="lineNum">    1728 </span>                :            : 
<span class="lineNum">    1729 </span>                :            :     /* Update the last activity in the pubsub channel. Note that since we
<span class="lineNum">    1730 </span>                :            :      * receive our messages as well this timestamp can be used to detect
<span class="lineNum">    1731 </span>                :            :      * if the link is probably disconnected even if it seems otherwise. */
<span class="lineNum">    1732 </span>                :<span class="lineNoCov">          0 :     ri-&gt;pc_last_activity = mstime();</span>
<span class="lineNum">    1733 </span>                :            :    
<span class="lineNum">    1734 </span>                :            :     /* Sanity check in the reply we expect, so that the code that follows
<span class="lineNum">    1735 </span>                :            :      * can avoid to check for details. */
<span class="lineNum">    1736 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (r-&gt;type != REDIS_REPLY_ARRAY ||</span>
<span class="lineNum">    1737 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         r-&gt;elements != 3 ||</span>
<span class="lineNum">    1738 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         r-&gt;element[0]-&gt;type != REDIS_REPLY_STRING ||</span>
<span class="lineNum">    1739 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         r-&gt;element[1]-&gt;type != REDIS_REPLY_STRING ||</span>
<span class="lineNum">    1740 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         r-&gt;element[2]-&gt;type != REDIS_REPLY_STRING ||</span>
<span class="lineNum">    1741 </span>                :<span class="lineNoCov">          0 :         strcmp(r-&gt;element[0]-&gt;str,&quot;message&quot;) != 0) return;</span>
<span class="lineNum">    1742 </span>                :            : 
<span class="lineNum">    1743 </span>                :            :     /* We are not interested in meeting ourselves */
<span class="lineNum">    1744 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (strstr(r-&gt;element[2]-&gt;str,server.runid) != NULL) return;</span>
<span class="lineNum">    1745 </span>                :            : 
<span class="lineNum">    1746 </span>                :            :     {
<span class="lineNum">    1747 </span>                :            :         int numtokens, port, removed, canfailover;
<span class="lineNum">    1748 </span>                :            :         /* Separator changed from &quot;:&quot; to &quot;,&quot; in recent versions in order to
<span class="lineNum">    1749 </span>                :            :          * play well with IPv6 addresses. For now we make sure to parse both
<span class="lineNum">    1750 </span>                :            :          * correctly detecting if there is &quot;,&quot; inside the string. */
<span class="lineNum">    1751 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         char *sep = strchr(r-&gt;element[2]-&gt;str,',') ? &quot;,&quot; : &quot;:&quot;;</span>
<span class="lineNum">    1752 </span>                :<span class="lineNoCov">          0 :         char **token = sdssplitlen(r-&gt;element[2]-&gt;str,</span>
<span class="lineNum">    1753 </span>                :<span class="lineNoCov">          0 :                                    r-&gt;element[2]-&gt;len,</span>
<span class="lineNum">    1754 </span>                :            :                                    sep,1,&amp;numtokens);
<span class="lineNum">    1755 </span>                :            :         sentinelRedisInstance *sentinel;
<span class="lineNum">    1756 </span>                :            : 
<span class="lineNum">    1757 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (numtokens == 4) {</span>
<span class="lineNum">    1758 </span>                :            :             /* First, try to see if we already have this sentinel. */
<span class="lineNum">    1759 </span>                :<span class="lineNoCov">          0 :             port = atoi(token[1]);</span>
<span class="lineNum">    1760 </span>                :<span class="lineNoCov">          0 :             canfailover = atoi(token[3]);</span>
<span class="lineNum">    1761 </span>                :<span class="lineNoCov">          0 :             sentinel = getSentinelRedisInstanceByAddrAndRunID(</span>
<span class="lineNum">    1762 </span>                :            :                             ri-&gt;sentinels,token[0],port,token[2]);
<span class="lineNum">    1763 </span>                :            : 
<span class="lineNum">    1764 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (!sentinel) {</span>
<span class="lineNum">    1765 </span>                :            :                 /* If not, remove all the sentinels that have the same runid
<span class="lineNum">    1766 </span>                :            :                  * OR the same ip/port, because it's either a restart or a
<span class="lineNum">    1767 </span>                :            :                  * network topology change. */
<span class="lineNum">    1768 </span>                :<span class="lineNoCov">          0 :                 removed = removeMatchingSentinelsFromMaster(ri,token[0],port,</span>
<span class="lineNum">    1769 </span>                :            :                                 token[2]);
<span class="lineNum">    1770 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (removed) {</span>
<span class="lineNum">    1771 </span>                :<span class="lineNoCov">          0 :                     sentinelEvent(REDIS_NOTICE,&quot;-dup-sentinel&quot;,ri,</span>
<span class="lineNum">    1772 </span>                :            :                         &quot;%@ #duplicate of %s:%d or %s&quot;,
<span class="lineNum">    1773 </span>                :            :                         token[0],port,token[2]);
<span class="lineNum">    1774 </span>                :            :                 }
<span class="lineNum">    1775 </span>                :            : 
<span class="lineNum">    1776 </span>                :            :                 /* Add the new sentinel. */
<span class="lineNum">    1777 </span>                :<span class="lineNoCov">          0 :                 sentinel = createSentinelRedisInstance(NULL,SRI_SENTINEL,</span>
<span class="lineNum">    1778 </span>                :            :                                 token[0],port,ri-&gt;quorum,ri);
<span class="lineNum">    1779 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (sentinel) {</span>
<span class="lineNum">    1780 </span>                :<span class="lineNoCov">          0 :                     sentinelEvent(REDIS_NOTICE,&quot;+sentinel&quot;,sentinel,&quot;%@&quot;);</span>
<span class="lineNum">    1781 </span>                :            :                     /* The runid is NULL after a new instance creation and
<span class="lineNum">    1782 </span>                :            :                      * for Sentinels we don't have a later chance to fill it,
<span class="lineNum">    1783 </span>                :            :                      * so do it now. */
<span class="lineNum">    1784 </span>                :<span class="lineNoCov">          0 :                     sentinel-&gt;runid = sdsnew(token[2]);</span>
<span class="lineNum">    1785 </span>                :            :                 }
<span class="lineNum">    1786 </span>                :            :             }
<span class="lineNum">    1787 </span>                :            : 
<span class="lineNum">    1788 </span>                :            :             /* Update the state of the Sentinel. */
<span class="lineNum">    1789 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (sentinel) {</span>
<span class="lineNum">    1790 </span>                :<span class="lineNoCov">          0 :                 sentinel-&gt;last_hello_time = mstime();</span>
<span class="lineNum">    1791 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (canfailover)</span>
<span class="lineNum">    1792 </span>                :<span class="lineNoCov">          0 :                     sentinel-&gt;flags |= SRI_CAN_FAILOVER;</span>
<span class="lineNum">    1793 </span>                :            :                 else
<span class="lineNum">    1794 </span>                :<span class="lineNoCov">          0 :                     sentinel-&gt;flags &amp;= ~SRI_CAN_FAILOVER;</span>
<span class="lineNum">    1795 </span>                :            :             }
<span class="lineNum">    1796 </span>                :            :         }
<span class="lineNum">    1797 </span>                :<span class="lineNoCov">          0 :         sdsfreesplitres(token,numtokens);</span>
<span class="lineNum">    1798 </span>                :            :     }
<a name="1799"><span class="lineNum">    1799 </span>                :            : }</a>
<span class="lineNum">    1800 </span>                :            : 
<span class="lineNum">    1801 </span>                :<span class="lineNoCov">          0 : void sentinelPingInstance(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    1802 </span>                :<span class="lineNoCov">          0 :     mstime_t now = mstime();</span>
<span class="lineNum">    1803 </span>                :            :     mstime_t info_period;
<span class="lineNum">    1804 </span>                :            :     int retval;
<span class="lineNum">    1805 </span>                :            : 
<span class="lineNum">    1806 </span>                :            :     /* Return ASAP if we have already a PING or INFO already pending, or
<span class="lineNum">    1807 </span>                :            :      * in the case the instance is not properly connected. */
<span class="lineNum">    1808 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_DISCONNECTED) return;</span>
<span class="lineNum">    1809 </span>                :            : 
<span class="lineNum">    1810 </span>                :            :     /* For INFO, PING, PUBLISH that are not critical commands to send we
<span class="lineNum">    1811 </span>                :            :      * also have a limit of SENTINEL_MAX_PENDING_COMMANDS. We don't
<span class="lineNum">    1812 </span>                :            :      * want to use a lot of memory just because a link is not working
<span class="lineNum">    1813 </span>                :            :      * properly (note that anyway there is a redundant protection about this,
<span class="lineNum">    1814 </span>                :            :      * that is, the link will be disconnected and reconnected if a long
<span class="lineNum">    1815 </span>                :            :      * timeout condition is detected. */
<span class="lineNum">    1816 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;pending_commands &gt;= SENTINEL_MAX_PENDING_COMMANDS) return;</span>
<span class="lineNum">    1817 </span>                :            : 
<span class="lineNum">    1818 </span>                :            :     /* If this is a slave of a master in O_DOWN condition we start sending
<span class="lineNum">    1819 </span>                :            :      * it INFO every second, instead of the usual SENTINEL_INFO_PERIOD
<span class="lineNum">    1820 </span>                :            :      * period. In this state we want to closely monitor slaves in case they
<span class="lineNum">    1821 </span>                :            :      * are turned into masters by another Sentinel, or by the sysadmin. */
<span class="lineNum">    1822 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if ((ri-&gt;flags &amp; SRI_SLAVE) &amp;&amp;</span>
<span class="lineNum">    1823 </span>                :<span class="lineNoCov">          0 :         (ri-&gt;master-&gt;flags &amp; (SRI_O_DOWN|SRI_FAILOVER_IN_PROGRESS))) {</span>
<span class="lineNum">    1824 </span>                :            :         info_period = 1000;
<span class="lineNum">    1825 </span>                :            :     } else {
<span class="lineNum">    1826 </span>                :<span class="lineNoCov">          0 :         info_period = SENTINEL_INFO_PERIOD;</span>
<span class="lineNum">    1827 </span>                :            :     }
<span class="lineNum">    1828 </span>                :            : 
<span class="lineNum">    1829 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if ((ri-&gt;flags &amp; SRI_SENTINEL) == 0 &amp;&amp;</span>
<span class="lineNum">    1830 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         (ri-&gt;info_refresh == 0 ||</span>
<span class="lineNum">    1831 </span>                :<span class="lineNoCov">          0 :         (now - ri-&gt;info_refresh) &gt; info_period))</span>
<span class="lineNum">    1832 </span>                :            :     {
<span class="lineNum">    1833 </span>                :            :         /* Send INFO to masters and slaves, not sentinels. */
<span class="lineNum">    1834 </span>                :<span class="lineNoCov">          0 :         retval = redisAsyncCommand(ri-&gt;cc,</span>
<span class="lineNum">    1835 </span>                :            :             sentinelInfoReplyCallback, NULL, &quot;INFO&quot;);
<span class="lineNum">    1836 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (retval != REDIS_OK) return;</span>
<span class="lineNum">    1837 </span>                :<span class="lineNoCov">          0 :         ri-&gt;pending_commands++;</span>
<span class="lineNum">    1838 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     } else if ((now - ri-&gt;last_pong_time) &gt; SENTINEL_PING_PERIOD) {</span>
<span class="lineNum">    1839 </span>                :            :         /* Send PING to all the three kinds of instances. */
<span class="lineNum">    1840 </span>                :<span class="lineNoCov">          0 :         retval = redisAsyncCommand(ri-&gt;cc,</span>
<span class="lineNum">    1841 </span>                :            :             sentinelPingReplyCallback, NULL, &quot;PING&quot;);
<span class="lineNum">    1842 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (retval != REDIS_OK) return;</span>
<span class="lineNum">    1843 </span>                :<span class="lineNoCov">          0 :         ri-&gt;pending_commands++;</span>
<span class="lineNum">    1844 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     } else if ((ri-&gt;flags &amp; SRI_MASTER) &amp;&amp;</span>
<span class="lineNum">    1845 </span>                :<span class="lineNoCov">          0 :                (now - ri-&gt;last_pub_time) &gt; SENTINEL_PUBLISH_PERIOD)</span>
<span class="lineNum">    1846 </span>                :            :     {
<span class="lineNum">    1847 </span>                :            :         /* PUBLISH hello messages only to masters. */
<span class="lineNum">    1848 </span>                :            :         char ip[REDIS_IP_STR_LEN];
<span class="lineNum">    1849 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (anetSockName(ri-&gt;cc-&gt;c.fd,ip,sizeof(ip),NULL) != -1) {</span>
<span class="lineNum">    1850 </span>                :            :             char myaddr[REDIS_IP_STR_LEN+128];
<span class="lineNum">    1851 </span>                :            : 
<span class="lineNum">    1852 </span>                :<span class="lineNoCov">          0 :             snprintf(myaddr,sizeof(myaddr),&quot;%s,%d,%s,%d&quot;,</span>
<span class="lineNum">    1853 </span>                :            :                 ip, server.port, server.runid,
<span class="lineNum">    1854 </span>                :<span class="lineNoCov">          0 :                 (ri-&gt;flags &amp; SRI_CAN_FAILOVER) != 0);</span>
<span class="lineNum">    1855 </span>                :<span class="lineNoCov">          0 :             retval = redisAsyncCommand(ri-&gt;cc,</span>
<span class="lineNum">    1856 </span>                :            :                 sentinelPublishReplyCallback, NULL, &quot;PUBLISH %s %s&quot;,
<span class="lineNum">    1857 </span>                :            :                     SENTINEL_HELLO_CHANNEL,myaddr);
<span class="lineNum">    1858 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (retval != REDIS_OK) return;</span>
<span class="lineNum">    1859 </span>                :<span class="lineNoCov">          0 :             ri-&gt;pending_commands++;</span>
<span class="lineNum">    1860 </span>                :            :         }
<span class="lineNum">    1861 </span>                :            :     }
<span class="lineNum">    1862 </span>                :            : }
<span class="lineNum">    1863 </span>                :            : 
<a name="1864"><span class="lineNum">    1864 </span>                :            : /* =========================== SENTINEL command ============================= */</a>
<span class="lineNum">    1865 </span>                :            : 
<span class="lineNum">    1866 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 : const char *sentinelFailoverStateStr(int state) {</span>
<span class="lineNum">    1867 </span>                :            :     switch(state) {
<span class="lineNum">    1868 </span>                :            :     case SENTINEL_FAILOVER_STATE_NONE: return &quot;none&quot;;
<span class="lineNum">    1869 </span>                :            :     case SENTINEL_FAILOVER_STATE_WAIT_START: return &quot;wait_start&quot;;
<span class="lineNum">    1870 </span>                :            :     case SENTINEL_FAILOVER_STATE_SELECT_SLAVE: return &quot;select_slave&quot;;
<span class="lineNum">    1871 </span>                :            :     case SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE: return &quot;send_slaveof_noone&quot;;
<span class="lineNum">    1872 </span>                :            :     case SENTINEL_FAILOVER_STATE_WAIT_PROMOTION: return &quot;wait_promotion&quot;;
<span class="lineNum">    1873 </span>                :            :     case SENTINEL_FAILOVER_STATE_RECONF_SLAVES: return &quot;reconf_slaves&quot;;
<span class="lineNum">    1874 </span>                :            :     case SENTINEL_FAILOVER_STATE_ALERT_CLIENTS: return &quot;alert_clients&quot;;
<span class="lineNum">    1875 </span>                :            :     case SENTINEL_FAILOVER_STATE_DETECT_END: return &quot;detect_end&quot;;
<span class="lineNum">    1876 </span>                :            :     case SENTINEL_FAILOVER_STATE_UPDATE_CONFIG: return &quot;update_config&quot;;
<span class="lineNum">    1877 </span>                :            :     default: return &quot;unknown&quot;;
<span class="lineNum">    1878 </span>                :            :     }
<span class="lineNum">    1879 </span>                :            : }
<a name="1880"><span class="lineNum">    1880 </span>                :            : </a>
<span class="lineNum">    1881 </span>                :            : /* Redis instance to Redis protocol representation. */
<span class="lineNum">    1882 </span>                :<span class="lineNoCov">          0 : void addReplySentinelRedisInstance(redisClient *c, sentinelRedisInstance *ri) {</span>
<span class="lineNum">    1883 </span>                :<span class="lineNoCov">          0 :     char *flags = sdsempty();</span>
<span class="lineNum">    1884 </span>                :            :     void *mbl;
<span class="lineNum">    1885 </span>                :<span class="lineNoCov">          0 :     int fields = 0;</span>
<span class="lineNum">    1886 </span>                :            : 
<span class="lineNum">    1887 </span>                :<span class="lineNoCov">          0 :     mbl = addDeferredMultiBulkLength(c);</span>
<span class="lineNum">    1888 </span>                :            : 
<span class="lineNum">    1889 </span>                :<span class="lineNoCov">          0 :     addReplyBulkCString(c,&quot;name&quot;);</span>
<span class="lineNum">    1890 </span>                :<span class="lineNoCov">          0 :     addReplyBulkCString(c,ri-&gt;name);</span>
<span class="lineNum">    1891 </span>                :<span class="lineNoCov">          0 :     fields++;</span>
<span class="lineNum">    1892 </span>                :            : 
<span class="lineNum">    1893 </span>                :<span class="lineNoCov">          0 :     addReplyBulkCString(c,&quot;ip&quot;);</span>
<span class="lineNum">    1894 </span>                :<span class="lineNoCov">          0 :     addReplyBulkCString(c,ri-&gt;addr-&gt;ip);</span>
<span class="lineNum">    1895 </span>                :<span class="lineNoCov">          0 :     fields++;</span>
<span class="lineNum">    1896 </span>                :            : 
<span class="lineNum">    1897 </span>                :<span class="lineNoCov">          0 :     addReplyBulkCString(c,&quot;port&quot;);</span>
<span class="lineNum">    1898 </span>                :<span class="lineNoCov">          0 :     addReplyBulkLongLong(c,ri-&gt;addr-&gt;port);</span>
<span class="lineNum">    1899 </span>                :<span class="lineNoCov">          0 :     fields++;</span>
<span class="lineNum">    1900 </span>                :            : 
<span class="lineNum">    1901 </span>                :<span class="lineNoCov">          0 :     addReplyBulkCString(c,&quot;runid&quot;);</span>
<span class="lineNum">    1902 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     addReplyBulkCString(c,ri-&gt;runid ? ri-&gt;runid : &quot;&quot;);</span>
<span class="lineNum">    1903 </span>                :<span class="lineNoCov">          0 :     fields++;</span>
<span class="lineNum">    1904 </span>                :            : 
<span class="lineNum">    1905 </span>                :<span class="lineNoCov">          0 :     addReplyBulkCString(c,&quot;flags&quot;);</span>
<span class="lineNum">    1906 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_S_DOWN) flags = sdscat(flags,&quot;s_down,&quot;);</span>
<span class="lineNum">    1907 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_O_DOWN) flags = sdscat(flags,&quot;o_down,&quot;);</span>
<span class="lineNum">    1908 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_MASTER) flags = sdscat(flags,&quot;master,&quot;);</span>
<span class="lineNum">    1909 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_SLAVE) flags = sdscat(flags,&quot;slave,&quot;);</span>
<span class="lineNum">    1910 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_SENTINEL) flags = sdscat(flags,&quot;sentinel,&quot;);</span>
<span class="lineNum">    1911 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_DISCONNECTED) flags = sdscat(flags,&quot;disconnected,&quot;);</span>
<span class="lineNum">    1912 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_MASTER_DOWN) flags = sdscat(flags,&quot;master_down,&quot;);</span>
<span class="lineNum">    1913 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS)</span>
<span class="lineNum">    1914 </span>                :<span class="lineNoCov">          0 :         flags = sdscat(flags,&quot;failover_in_progress,&quot;);</span>
<span class="lineNum">    1915 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_I_AM_THE_LEADER)</span>
<span class="lineNum">    1916 </span>                :<span class="lineNoCov">          0 :         flags = sdscat(flags,&quot;i_am_the_leader,&quot;);</span>
<span class="lineNum">    1917 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_PROMOTED) flags = sdscat(flags,&quot;promoted,&quot;);</span>
<span class="lineNum">    1918 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_RECONF_SENT) flags = sdscat(flags,&quot;reconf_sent,&quot;);</span>
<span class="lineNum">    1919 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_RECONF_INPROG) flags = sdscat(flags,&quot;reconf_inprog,&quot;);</span>
<span class="lineNum">    1920 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_RECONF_DONE) flags = sdscat(flags,&quot;reconf_done,&quot;);</span>
<span class="lineNum">    1921 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_DEMOTE) flags = sdscat(flags,&quot;demote,&quot;);</span>
<span class="lineNum">    1922 </span>                :            : 
<span class="lineNum">    1923 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (sdslen(flags) != 0) sdsrange(flags,0,-2); /* remove last &quot;,&quot; */</span>
<span class="lineNum">    1924 </span>                :<span class="lineNoCov">          0 :     addReplyBulkCString(c,flags);</span>
<span class="lineNum">    1925 </span>                :<span class="lineNoCov">          0 :     sdsfree(flags);</span>
<span class="lineNum">    1926 </span>                :<span class="lineNoCov">          0 :     fields++;</span>
<span class="lineNum">    1927 </span>                :            : 
<span class="lineNum">    1928 </span>                :<span class="lineNoCov">          0 :     addReplyBulkCString(c,&quot;pending-commands&quot;);</span>
<span class="lineNum">    1929 </span>                :<span class="lineNoCov">          0 :     addReplyBulkLongLong(c,ri-&gt;pending_commands);</span>
<span class="lineNum">    1930 </span>                :<span class="lineNoCov">          0 :     fields++;</span>
<span class="lineNum">    1931 </span>                :            : 
<span class="lineNum">    1932 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) {</span>
<span class="lineNum">    1933 </span>                :<span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;failover-state&quot;);</span>
<span class="lineNum">    1934 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         addReplyBulkCString(c,(char*)sentinelFailoverStateStr(ri-&gt;failover_state));</span>
<span class="lineNum">    1935 </span>                :<span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    1936 </span>                :            :     }
<span class="lineNum">    1937 </span>                :            : 
<span class="lineNum">    1938 </span>                :<span class="lineNoCov">          0 :     addReplyBulkCString(c,&quot;last-ok-ping-reply&quot;);</span>
<span class="lineNum">    1939 </span>                :<span class="lineNoCov">          0 :     addReplyBulkLongLong(c,mstime() - ri-&gt;last_avail_time);</span>
<span class="lineNum">    1940 </span>                :<span class="lineNoCov">          0 :     fields++;</span>
<span class="lineNum">    1941 </span>                :            : 
<span class="lineNum">    1942 </span>                :<span class="lineNoCov">          0 :     addReplyBulkCString(c,&quot;last-ping-reply&quot;);</span>
<span class="lineNum">    1943 </span>                :<span class="lineNoCov">          0 :     addReplyBulkLongLong(c,mstime() - ri-&gt;last_pong_time);</span>
<span class="lineNum">    1944 </span>                :<span class="lineNoCov">          0 :     fields++;</span>
<span class="lineNum">    1945 </span>                :            : 
<span class="lineNum">    1946 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_S_DOWN) {</span>
<span class="lineNum">    1947 </span>                :<span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;s-down-time&quot;);</span>
<span class="lineNum">    1948 </span>                :<span class="lineNoCov">          0 :         addReplyBulkLongLong(c,mstime()-ri-&gt;s_down_since_time);</span>
<span class="lineNum">    1949 </span>                :<span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    1950 </span>                :            :     }
<span class="lineNum">    1951 </span>                :            : 
<span class="lineNum">    1952 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_O_DOWN) {</span>
<span class="lineNum">    1953 </span>                :<span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;o-down-time&quot;);</span>
<span class="lineNum">    1954 </span>                :<span class="lineNoCov">          0 :         addReplyBulkLongLong(c,mstime()-ri-&gt;o_down_since_time);</span>
<span class="lineNum">    1955 </span>                :<span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    1956 </span>                :            :     }
<span class="lineNum">    1957 </span>                :            : 
<span class="lineNum">    1958 </span>                :            :     /* Masters and Slaves */
<span class="lineNum">    1959 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; (SRI_MASTER|SRI_SLAVE)) {</span>
<span class="lineNum">    1960 </span>                :<span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;info-refresh&quot;);</span>
<span class="lineNum">    1961 </span>                :<span class="lineNoCov">          0 :         addReplyBulkLongLong(c,mstime() - ri-&gt;info_refresh);</span>
<span class="lineNum">    1962 </span>                :<span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    1963 </span>                :            :     }
<span class="lineNum">    1964 </span>                :            : 
<span class="lineNum">    1965 </span>                :            :     /* Only masters */
<span class="lineNum">    1966 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_MASTER) {</span>
<span class="lineNum">    1967 </span>                :<span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;num-slaves&quot;);</span>
<span class="lineNum">    1968 </span>                :<span class="lineNoCov">          0 :         addReplyBulkLongLong(c,dictSize(ri-&gt;slaves));</span>
<span class="lineNum">    1969 </span>                :<span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    1970 </span>                :            : 
<span class="lineNum">    1971 </span>                :<span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;num-other-sentinels&quot;);</span>
<span class="lineNum">    1972 </span>                :<span class="lineNoCov">          0 :         addReplyBulkLongLong(c,dictSize(ri-&gt;sentinels));</span>
<span class="lineNum">    1973 </span>                :<span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    1974 </span>                :            : 
<span class="lineNum">    1975 </span>                :<span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;quorum&quot;);</span>
<span class="lineNum">    1976 </span>                :<span class="lineNoCov">          0 :         addReplyBulkLongLong(c,ri-&gt;quorum);</span>
<span class="lineNum">    1977 </span>                :<span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    1978 </span>                :            :     }
<span class="lineNum">    1979 </span>                :            : 
<span class="lineNum">    1980 </span>                :            :     /* Only slaves */
<span class="lineNum">    1981 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_SLAVE) {</span>
<span class="lineNum">    1982 </span>                :<span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;master-link-down-time&quot;);</span>
<span class="lineNum">    1983 </span>                :<span class="lineNoCov">          0 :         addReplyBulkLongLong(c,ri-&gt;master_link_down_time);</span>
<span class="lineNum">    1984 </span>                :<span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    1985 </span>                :            : 
<span class="lineNum">    1986 </span>                :<span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;master-link-status&quot;);</span>
<span class="lineNum">    1987 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         addReplyBulkCString(c,</span>
<span class="lineNum">    1988 </span>                :<span class="lineNoCov">          0 :             (ri-&gt;slave_master_link_status == SENTINEL_MASTER_LINK_STATUS_UP) ?</span>
<span class="lineNum">    1989 </span>                :            :             &quot;ok&quot; : &quot;err&quot;);
<span class="lineNum">    1990 </span>                :<span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    1991 </span>                :            : 
<span class="lineNum">    1992 </span>                :<span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;master-host&quot;);</span>
<span class="lineNum">    1993 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         addReplyBulkCString(c,</span>
<span class="lineNum">    1994 </span>                :<span class="lineNoCov">          0 :             ri-&gt;slave_master_host ? ri-&gt;slave_master_host : &quot;?&quot;);</span>
<span class="lineNum">    1995 </span>                :<span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    1996 </span>                :            : 
<span class="lineNum">    1997 </span>                :<span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;master-port&quot;);</span>
<span class="lineNum">    1998 </span>                :<span class="lineNoCov">          0 :         addReplyBulkLongLong(c,ri-&gt;slave_master_port);</span>
<span class="lineNum">    1999 </span>                :<span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2000 </span>                :            : 
<span class="lineNum">    2001 </span>                :<span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;slave-priority&quot;);</span>
<span class="lineNum">    2002 </span>                :<span class="lineNoCov">          0 :         addReplyBulkLongLong(c,ri-&gt;slave_priority);</span>
<span class="lineNum">    2003 </span>                :<span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2004 </span>                :            :     }
<span class="lineNum">    2005 </span>                :            : 
<span class="lineNum">    2006 </span>                :            :     /* Only sentinels */
<span class="lineNum">    2007 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_SENTINEL) {</span>
<span class="lineNum">    2008 </span>                :<span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;last-hello-message&quot;);</span>
<span class="lineNum">    2009 </span>                :<span class="lineNoCov">          0 :         addReplyBulkLongLong(c,mstime() - ri-&gt;last_hello_time);</span>
<span class="lineNum">    2010 </span>                :<span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2011 </span>                :            : 
<span class="lineNum">    2012 </span>                :<span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;can-failover-its-master&quot;);</span>
<span class="lineNum">    2013 </span>                :<span class="lineNoCov">          0 :         addReplyBulkLongLong(c,(ri-&gt;flags &amp; SRI_CAN_FAILOVER) != 0);</span>
<span class="lineNum">    2014 </span>                :<span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2015 </span>                :            : 
<span class="lineNum">    2016 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ri-&gt;flags &amp; SRI_MASTER_DOWN) {</span>
<span class="lineNum">    2017 </span>                :<span class="lineNoCov">          0 :             addReplyBulkCString(c,&quot;subjective-leader&quot;);</span>
<span class="lineNum">    2018 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             addReplyBulkCString(c,ri-&gt;leader ? ri-&gt;leader : &quot;?&quot;);</span>
<span class="lineNum">    2019 </span>                :<span class="lineNoCov">          0 :             fields++;</span>
<span class="lineNum">    2020 </span>                :            :         }
<span class="lineNum">    2021 </span>                :            :     }
<span class="lineNum">    2022 </span>                :            : 
<span class="lineNum">    2023 </span>                :<span class="lineNoCov">          0 :     setDeferredMultiBulkLength(c,mbl,fields*2);</span>
<span class="lineNum">    2024 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2025 </span>                :            : 
<a name="2026"><span class="lineNum">    2026 </span>                :            : /* Output a number of instances contained inside a dictionary as</a>
<span class="lineNum">    2027 </span>                :            :  * Redis protocol. */
<span class="lineNum">    2028 </span>                :<span class="lineNoCov">          0 : void addReplyDictOfRedisInstances(redisClient *c, dict *instances) {</span>
<span class="lineNum">    2029 </span>                :            :     dictIterator *di;
<span class="lineNum">    2030 </span>                :            :     dictEntry *de;
<span class="lineNum">    2031 </span>                :            : 
<span class="lineNum">    2032 </span>                :<span class="lineNoCov">          0 :     di = dictGetIterator(instances);</span>
<span class="lineNum">    2033 </span>                :<span class="lineNoCov">          0 :     addReplyMultiBulkLen(c,dictSize(instances));</span>
<span class="lineNum">    2034 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    2035 </span>                :<span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    2036 </span>                :            : 
<span class="lineNum">    2037 </span>                :<span class="lineNoCov">          0 :         addReplySentinelRedisInstance(c,ri);</span>
<span class="lineNum">    2038 </span>                :            :     }
<span class="lineNum">    2039 </span>                :<span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    2040 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2041 </span>                :            : 
<span class="lineNum">    2042 </span>                :            : /* Lookup the named master into sentinel.masters.
<a name="2043"><span class="lineNum">    2043 </span>                :            :  * If the master is not found reply to the client with an error and returns</a>
<span class="lineNum">    2044 </span>                :            :  * NULL. */
<span class="lineNum">    2045 </span>                :<span class="lineNoCov">          0 : sentinelRedisInstance *sentinelGetMasterByNameOrReplyError(redisClient *c,</span>
<span class="lineNum">    2046 </span>                :            :                         robj *name)
<span class="lineNum">    2047 </span>                :            : {
<span class="lineNum">    2048 </span>                :            :     sentinelRedisInstance *ri;
<span class="lineNum">    2049 </span>                :            : 
<span class="lineNum">    2050 </span>                :<span class="lineNoCov">          0 :     ri = dictFetchValue(sentinel.masters,c-&gt;argv[2]-&gt;ptr);</span>
<span class="lineNum">    2051 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!ri) {</span>
<span class="lineNum">    2052 </span>                :<span class="lineNoCov">          0 :         addReplyError(c,&quot;No such master with that name&quot;);</span>
<span class="lineNum">    2053 </span>                :<span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    2054 </span>                :            :     }
<span class="lineNum">    2055 </span>                :            :     return ri;
<a name="2056"><span class="lineNum">    2056 </span>                :            : }</a>
<span class="lineNum">    2057 </span>                :            : 
<span class="lineNum">    2058 </span>                :<span class="lineNoCov">          0 : void sentinelCommand(redisClient *c) {</span>
<span class="lineNum">    2059 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;masters&quot;)) {</span>
<span class="lineNum">    2060 </span>                :            :         /* SENTINEL MASTERS */
<span class="lineNum">    2061 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (c-&gt;argc != 2) goto numargserr;</span>
<span class="lineNum">    2062 </span>                :            : 
<span class="lineNum">    2063 </span>                :<span class="lineNoCov">          0 :         addReplyDictOfRedisInstances(c,sentinel.masters);</span>
<span class="lineNum">    2064 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;slaves&quot;)) {</span>
<span class="lineNum">    2065 </span>                :            :         /* SENTINEL SLAVES &lt;master-name&gt; */
<span class="lineNum">    2066 </span>                :            :         sentinelRedisInstance *ri;
<span class="lineNum">    2067 </span>                :            : 
<span class="lineNum">    2068 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (c-&gt;argc != 3) goto numargserr;</span>
<span class="lineNum">    2069 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ((ri = sentinelGetMasterByNameOrReplyError(c,c-&gt;argv[2])) == NULL)</span>
<span class="lineNum">    2070 </span>                :            :             return;
<span class="lineNum">    2071 </span>                :<span class="lineNoCov">          0 :         addReplyDictOfRedisInstances(c,ri-&gt;slaves);</span>
<span class="lineNum">    2072 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;sentinels&quot;)) {</span>
<span class="lineNum">    2073 </span>                :            :         /* SENTINEL SENTINELS &lt;master-name&gt; */
<span class="lineNum">    2074 </span>                :            :         sentinelRedisInstance *ri;
<span class="lineNum">    2075 </span>                :            : 
<span class="lineNum">    2076 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (c-&gt;argc != 3) goto numargserr;</span>
<span class="lineNum">    2077 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ((ri = sentinelGetMasterByNameOrReplyError(c,c-&gt;argv[2])) == NULL)</span>
<span class="lineNum">    2078 </span>                :            :             return;
<span class="lineNum">    2079 </span>                :<span class="lineNoCov">          0 :         addReplyDictOfRedisInstances(c,ri-&gt;sentinels);</span>
<span class="lineNum">    2080 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;is-master-down-by-addr&quot;)) {</span>
<span class="lineNum">    2081 </span>                :            :         /* SENTINEL IS-MASTER-DOWN-BY-ADDR &lt;ip&gt; &lt;port&gt; */
<span class="lineNum">    2082 </span>                :            :         sentinelRedisInstance *ri;
<span class="lineNum">    2083 </span>                :<span class="lineNoCov">          0 :         char *leader = NULL;</span>
<span class="lineNum">    2084 </span>                :            :         long port;
<span class="lineNum">    2085 </span>                :<span class="lineNoCov">          0 :         int isdown = 0;</span>
<span class="lineNum">    2086 </span>                :            : 
<span class="lineNum">    2087 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (c-&gt;argc != 4) goto numargserr;</span>
<span class="lineNum">    2088 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (getLongFromObjectOrReply(c,c-&gt;argv[3],&amp;port,NULL) != REDIS_OK)</span>
<span class="lineNum">    2089 </span>                :            :             return;
<span class="lineNum">    2090 </span>                :<span class="lineNoCov">          0 :         ri = getSentinelRedisInstanceByAddrAndRunID(sentinel.masters,</span>
<span class="lineNum">    2091 </span>                :<span class="lineNoCov">          0 :             c-&gt;argv[2]-&gt;ptr,port,NULL);</span>
<span class="lineNum">    2092 </span>                :            : 
<span class="lineNum">    2093 </span>                :            :         /* It exists? Is actually a master? Is subjectively down? It's down.
<span class="lineNum">    2094 </span>                :            :          * Note: if we are in tilt mode we always reply with &quot;0&quot;. */
<span class="lineNum">    2095 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!sentinel.tilt &amp;&amp; ri &amp;&amp; (ri-&gt;flags &amp; SRI_S_DOWN) &amp;&amp;</span>
<span class="lineNum">    2096 </span>                :            :                                     (ri-&gt;flags &amp; SRI_MASTER))
<span class="lineNum">    2097 </span>                :<span class="lineNoCov">          0 :             isdown = 1;</span>
<span class="lineNum">    2098 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ri) leader = sentinelGetSubjectiveLeader(ri);</span>
<span class="lineNum">    2099 </span>                :            : 
<span class="lineNum">    2100 </span>                :            :         /* Reply with a two-elements multi-bulk reply: down state, leader. */
<span class="lineNum">    2101 </span>                :<span class="lineNoCov">          0 :         addReplyMultiBulkLen(c,2);</span>
<span class="lineNum">    2102 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         addReply(c, isdown ? shared.cone : shared.czero);</span>
<span class="lineNum">    2103 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         addReplyBulkCString(c, leader ? leader : &quot;?&quot;);</span>
<span class="lineNum">    2104 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (leader) sdsfree(leader);</span>
<span class="lineNum">    2105 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;reset&quot;)) {</span>
<span class="lineNum">    2106 </span>                :            :         /* SENTINEL RESET &lt;pattern&gt; */
<span class="lineNum">    2107 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (c-&gt;argc != 3) goto numargserr;</span>
<span class="lineNum">    2108 </span>                :<span class="lineNoCov">          0 :         addReplyLongLong(c,sentinelResetMastersByPattern(c-&gt;argv[2]-&gt;ptr,SENTINEL_GENERATE_EVENT));</span>
<span class="lineNum">    2109 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;get-master-addr-by-name&quot;)) {</span>
<span class="lineNum">    2110 </span>                :            :         /* SENTINEL GET-MASTER-ADDR-BY-NAME &lt;master-name&gt; */
<span class="lineNum">    2111 </span>                :            :         sentinelRedisInstance *ri;
<span class="lineNum">    2112 </span>                :            : 
<span class="lineNum">    2113 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (c-&gt;argc != 3) goto numargserr;</span>
<span class="lineNum">    2114 </span>                :<span class="lineNoCov">          0 :         ri = sentinelGetMasterByName(c-&gt;argv[2]-&gt;ptr);</span>
<span class="lineNum">    2115 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ri == NULL) {</span>
<span class="lineNum">    2116 </span>                :<span class="lineNoCov">          0 :             addReply(c,shared.nullmultibulk);</span>
<span class="lineNum">    2117 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         } else if (ri-&gt;info_refresh == 0) {</span>
<span class="lineNum">    2118 </span>                :<span class="lineNoCov">          0 :             addReplySds(c,sdsnew(&quot;-IDONTKNOW I have not enough information to reply. Please ask another Sentinel.\r\n&quot;));</span>
<span class="lineNum">    2119 </span>                :            :         } else {
<span class="lineNum">    2120 </span>                :<span class="lineNoCov">          0 :             sentinelAddr *addr = ri-&gt;addr;</span>
<span class="lineNum">    2121 </span>                :            : 
<span class="lineNum">    2122 </span>                :            :             /* If we are in the middle of a failover, and the slave was
<span class="lineNum">    2123 </span>                :            :              * already successfully switched to master role, we can advertise
<span class="lineNum">    2124 </span>                :            :              * the new address as slave in order to allow clients to talk
<span class="lineNum">    2125 </span>                :            :              * with the new master ASAP. */
<span class="lineNum">    2126 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if ((ri-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) &amp;&amp;</span>
<span class="lineNum">    2127 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ri-&gt;promoted_slave &amp;&amp;</span>
<span class="lineNum">    2128 </span>                :<span class="lineNoCov">          0 :                 ri-&gt;failover_state &gt;= SENTINEL_FAILOVER_STATE_RECONF_SLAVES)</span>
<span class="lineNum">    2129 </span>                :            :             {
<span class="lineNum">    2130 </span>                :<span class="lineNoCov">          0 :                 addr = ri-&gt;promoted_slave-&gt;addr;</span>
<span class="lineNum">    2131 </span>                :            :             }
<span class="lineNum">    2132 </span>                :<span class="lineNoCov">          0 :             addReplyMultiBulkLen(c,2);</span>
<span class="lineNum">    2133 </span>                :<span class="lineNoCov">          0 :             addReplyBulkCString(c,addr-&gt;ip);</span>
<span class="lineNum">    2134 </span>                :<span class="lineNoCov">          0 :             addReplyBulkLongLong(c,addr-&gt;port);</span>
<span class="lineNum">    2135 </span>                :            :         }
<span class="lineNum">    2136 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;failover&quot;)) {</span>
<span class="lineNum">    2137 </span>                :            :         /* SENTINEL FAILOVER &lt;master-name&gt; */
<span class="lineNum">    2138 </span>                :            :         sentinelRedisInstance *ri;
<span class="lineNum">    2139 </span>                :            : 
<span class="lineNum">    2140 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (c-&gt;argc != 3) goto numargserr;</span>
<span class="lineNum">    2141 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ((ri = sentinelGetMasterByNameOrReplyError(c,c-&gt;argv[2])) == NULL)</span>
<span class="lineNum">    2142 </span>                :            :             return;
<span class="lineNum">    2143 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ri-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) {</span>
<span class="lineNum">    2144 </span>                :<span class="lineNoCov">          0 :             addReplySds(c,sdsnew(&quot;-INPROG Failover already in progress\r\n&quot;));</span>
<span class="lineNum">    2145 </span>                :<span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">    2146 </span>                :            :         }
<span class="lineNum">    2147 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (sentinelSelectSlave(ri) == NULL) {</span>
<span class="lineNum">    2148 </span>                :<span class="lineNoCov">          0 :             addReplySds(c,sdsnew(&quot;-NOGOODSLAVE No suitable slave to promote\r\n&quot;));</span>
<span class="lineNum">    2149 </span>                :<span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">    2150 </span>                :            :         }
<span class="lineNum">    2151 </span>                :<span class="lineNoCov">          0 :         sentinelStartFailover(ri,SENTINEL_FAILOVER_STATE_WAIT_START);</span>
<span class="lineNum">    2152 </span>                :<span class="lineNoCov">          0 :         ri-&gt;flags |= SRI_FORCE_FAILOVER;</span>
<span class="lineNum">    2153 </span>                :<span class="lineNoCov">          0 :         addReply(c,shared.ok);</span>
<span class="lineNum">    2154 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;pending-scripts&quot;)) {</span>
<span class="lineNum">    2155 </span>                :            :         /* SENTINEL PENDING-SCRIPTS */
<span class="lineNum">    2156 </span>                :            : 
<span class="lineNum">    2157 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (c-&gt;argc != 2) goto numargserr;</span>
<span class="lineNum">    2158 </span>                :<span class="lineNoCov">          0 :         sentinelPendingScriptsCommand(c);</span>
<span class="lineNum">    2159 </span>                :            :     } else {
<span class="lineNum">    2160 </span>                :<span class="lineNoCov">          0 :         addReplyErrorFormat(c,&quot;Unknown sentinel subcommand '%s'&quot;,</span>
<span class="lineNum">    2161 </span>                :<span class="lineNoCov">          0 :                                (char*)c-&gt;argv[1]-&gt;ptr);</span>
<span class="lineNum">    2162 </span>                :            :     }
<span class="lineNum">    2163 </span>                :            :     return;
<span class="lineNum">    2164 </span>                :            : 
<span class="lineNum">    2165 </span>                :            : numargserr:
<span class="lineNum">    2166 </span>                :<span class="lineNoCov">          0 :     addReplyErrorFormat(c,&quot;Wrong number of commands for 'sentinel %s'&quot;,</span>
<span class="lineNum">    2167 </span>                :<span class="lineNoCov">          0 :                           (char*)c-&gt;argv[1]-&gt;ptr);</span>
<a name="2168"><span class="lineNum">    2168 </span>                :            : }</a>
<span class="lineNum">    2169 </span>                :            : 
<span class="lineNum">    2170 </span>                :<span class="lineNoCov">          0 : void sentinelInfoCommand(redisClient *c) {</span>
<span class="lineNum">    2171 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     char *section = c-&gt;argc == 2 ? c-&gt;argv[1]-&gt;ptr : &quot;default&quot;;</span>
<span class="lineNum">    2172 </span>                :<span class="lineNoCov">          0 :     sds info = sdsempty();</span>
<span class="lineNum">    2173 </span>                :<span class="lineNoCov">          0 :     int defsections = !strcasecmp(section,&quot;default&quot;);</span>
<span class="lineNum">    2174 </span>                :<span class="lineNoCov">          0 :     int sections = 0;</span>
<span class="lineNum">    2175 </span>                :            : 
<span class="lineNum">    2176 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (c-&gt;argc &gt; 2) {</span>
<span class="lineNum">    2177 </span>                :<span class="lineNoCov">          0 :         addReply(c,shared.syntaxerr);</span>
<span class="lineNum">    2178 </span>                :<span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    2179 </span>                :            :     }
<span class="lineNum">    2180 </span>                :            : 
<span class="lineNum">    2181 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!strcasecmp(section,&quot;server&quot;) || defsections) {</span>
<span class="lineNum">    2182 </span>                :<span class="lineNoCov">          0 :         if (sections++) info = sdscat(info,&quot;\r\n&quot;);</span>
<span class="lineNum">    2183 </span>                :<span class="lineNoCov">          0 :         sds serversection = genRedisInfoString(&quot;server&quot;);</span>
<span class="lineNum">    2184 </span>                :<span class="lineNoCov">          0 :         info = sdscatlen(info,serversection,sdslen(serversection));</span>
<span class="lineNum">    2185 </span>                :<span class="lineNoCov">          0 :         sdsfree(serversection);</span>
<span class="lineNum">    2186 </span>                :            :     }
<span class="lineNum">    2187 </span>                :            : 
<span class="lineNum">    2188 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!strcasecmp(section,&quot;sentinel&quot;) || defsections) {</span>
<span class="lineNum">    2189 </span>                :            :         dictIterator *di;
<span class="lineNum">    2190 </span>                :            :         dictEntry *de;
<span class="lineNum">    2191 </span>                :<span class="lineNoCov">          0 :         int master_id = 0;</span>
<span class="lineNum">    2192 </span>                :            : 
<span class="lineNum">    2193 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (sections++) info = sdscat(info,&quot;\r\n&quot;);</span>
<span class="lineNum">    2194 </span>                :<span class="lineNoCov">          0 :         info = sdscatprintf(info,</span>
<span class="lineNum">    2195 </span>                :            :             &quot;# Sentinel\r\n&quot;
<span class="lineNum">    2196 </span>                :            :             &quot;sentinel_masters:%lu\r\n&quot;
<span class="lineNum">    2197 </span>                :            :             &quot;sentinel_tilt:%d\r\n&quot;
<span class="lineNum">    2198 </span>                :            :             &quot;sentinel_running_scripts:%d\r\n&quot;
<span class="lineNum">    2199 </span>                :            :             &quot;sentinel_scripts_queue_length:%ld\r\n&quot;,
<span class="lineNum">    2200 </span>                :<span class="lineNoCov">          0 :             dictSize(sentinel.masters),</span>
<span class="lineNum">    2201 </span>                :            :             sentinel.tilt,
<span class="lineNum">    2202 </span>                :            :             sentinel.running_scripts,
<span class="lineNum">    2203 </span>                :<span class="lineNoCov">          0 :             listLength(sentinel.scripts_queue));</span>
<span class="lineNum">    2204 </span>                :            : 
<span class="lineNum">    2205 </span>                :<span class="lineNoCov">          0 :         di = dictGetIterator(sentinel.masters);</span>
<span class="lineNum">    2206 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    2207 </span>                :<span class="lineNoCov">          0 :             sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    2208 </span>                :<span class="lineNoCov">          0 :             char *status = &quot;ok&quot;;</span>
<span class="lineNum">    2209 </span>                :            : 
<span class="lineNum">    2210 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (ri-&gt;flags &amp; SRI_O_DOWN) status = &quot;odown&quot;;</span>
<span class="lineNum">    2211 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             else if (ri-&gt;flags &amp; SRI_S_DOWN) status = &quot;sdown&quot;;</span>
<span class="lineNum">    2212 </span>                :<span class="lineNoCov">          0 :             info = sdscatprintf(info,</span>
<span class="lineNum">    2213 </span>                :            :                 &quot;master%d:name=%s,status=%s,address=%s:%d,&quot;
<span class="lineNum">    2214 </span>                :            :                 &quot;slaves=%lu,sentinels=%lu\r\n&quot;,
<span class="lineNum">    2215 </span>                :            :                 master_id++, ri-&gt;name, status,
<span class="lineNum">    2216 </span>                :<span class="lineNoCov">          0 :                 ri-&gt;addr-&gt;ip, ri-&gt;addr-&gt;port,</span>
<span class="lineNum">    2217 </span>                :<span class="lineNoCov">          0 :                 dictSize(ri-&gt;slaves),</span>
<span class="lineNum">    2218 </span>                :<span class="lineNoCov">          0 :                 dictSize(ri-&gt;sentinels)+1);</span>
<span class="lineNum">    2219 </span>                :            :         }
<span class="lineNum">    2220 </span>                :<span class="lineNoCov">          0 :         dictReleaseIterator(di);</span>
<span class="lineNum">    2221 </span>                :            :     }
<span class="lineNum">    2222 </span>                :            : 
<span class="lineNum">    2223 </span>                :<span class="lineNoCov">          0 :     addReplySds(c,sdscatprintf(sdsempty(),&quot;$%lu\r\n&quot;,</span>
<span class="lineNum">    2224 </span>                :            :         (unsigned long)sdslen(info)));
<span class="lineNum">    2225 </span>                :<span class="lineNoCov">          0 :     addReplySds(c,info);</span>
<span class="lineNum">    2226 </span>                :<span class="lineNoCov">          0 :     addReply(c,shared.crlf);</span>
<span class="lineNum">    2227 </span>                :            : }
<span class="lineNum">    2228 </span>                :            : 
<span class="lineNum">    2229 </span>                :            : /* ===================== SENTINEL availability checks ======================= */
<a name="2230"><span class="lineNum">    2230 </span>                :            : </a>
<span class="lineNum">    2231 </span>                :            : /* Is this instance down from our point of view? */
<span class="lineNum">    2232 </span>                :<span class="lineNoCov">          0 : void sentinelCheckSubjectivelyDown(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    2233 </span>                :<span class="lineNoCov">          0 :     mstime_t elapsed = mstime() - ri-&gt;last_avail_time;</span>
<span class="lineNum">    2234 </span>                :            : 
<span class="lineNum">    2235 </span>                :            :     /* Check if we are in need for a reconnection of one of the 
<span class="lineNum">    2236 </span>                :            :      * links, because we are detecting low activity.
<span class="lineNum">    2237 </span>                :            :      *
<span class="lineNum">    2238 </span>                :            :      * 1) Check if the command link seems connected, was connected not less
<span class="lineNum">    2239 </span>                :            :      *    than SENTINEL_MIN_LINK_RECONNECT_PERIOD, but still we have an
<span class="lineNum">    2240 </span>                :            :      *    idle time that is greater than down_after_period / 2 seconds. */
<span class="lineNum">    2241 </span>  [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;cc &amp;&amp;</span>
<span class="lineNum">    2242 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         (mstime() - ri-&gt;cc_conn_time) &gt; SENTINEL_MIN_LINK_RECONNECT_PERIOD &amp;&amp;</span>
<span class="lineNum">    2243 </span>                :<span class="lineNoCov">          0 :         (mstime() - ri-&gt;last_pong_time) &gt; (ri-&gt;down_after_period/2))</span>
<span class="lineNum">    2244 </span>                :            :     {
<span class="lineNum">    2245 </span>                :<span class="lineNoCov">          0 :         sentinelKillLink(ri,ri-&gt;cc);</span>
<span class="lineNum">    2246 </span>                :            :     }
<span class="lineNum">    2247 </span>                :            : 
<span class="lineNum">    2248 </span>                :            :     /* 2) Check if the pubsub link seems connected, was connected not less
<span class="lineNum">    2249 </span>                :            :      *    than SENTINEL_MIN_LINK_RECONNECT_PERIOD, but still we have no
<span class="lineNum">    2250 </span>                :            :      *    activity in the Pub/Sub channel for more than
<span class="lineNum">    2251 </span>                :            :      *    SENTINEL_PUBLISH_PERIOD * 3.
<span class="lineNum">    2252 </span>                :            :      */
<span class="lineNum">    2253 </span>  [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;pc &amp;&amp;</span>
<span class="lineNum">    2254 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         (mstime() - ri-&gt;pc_conn_time) &gt; SENTINEL_MIN_LINK_RECONNECT_PERIOD &amp;&amp;</span>
<span class="lineNum">    2255 </span>                :<span class="lineNoCov">          0 :         (mstime() - ri-&gt;pc_last_activity) &gt; (SENTINEL_PUBLISH_PERIOD*3))</span>
<span class="lineNum">    2256 </span>                :            :     {
<span class="lineNum">    2257 </span>                :<span class="lineNoCov">          0 :         sentinelKillLink(ri,ri-&gt;pc);</span>
<span class="lineNum">    2258 </span>                :            :     }
<span class="lineNum">    2259 </span>                :            : 
<span class="lineNum">    2260 </span>                :            :     /* Update the subjectively down flag. */
<span class="lineNum">    2261 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (elapsed &gt; ri-&gt;down_after_period) {</span>
<span class="lineNum">    2262 </span>                :            :         /* Is subjectively down */
<span class="lineNum">    2263 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ((ri-&gt;flags &amp; SRI_S_DOWN) == 0) {</span>
<span class="lineNum">    2264 </span>                :<span class="lineNoCov">          0 :             sentinelEvent(REDIS_WARNING,&quot;+sdown&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    2265 </span>                :<span class="lineNoCov">          0 :             ri-&gt;s_down_since_time = mstime();</span>
<span class="lineNum">    2266 </span>                :<span class="lineNoCov">          0 :             ri-&gt;flags |= SRI_S_DOWN;</span>
<span class="lineNum">    2267 </span>                :            :         }
<span class="lineNum">    2268 </span>                :            :     } else {
<span class="lineNum">    2269 </span>                :            :         /* Is subjectively up */
<span class="lineNum">    2270 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ri-&gt;flags &amp; SRI_S_DOWN) {</span>
<span class="lineNum">    2271 </span>                :<span class="lineNoCov">          0 :             sentinelEvent(REDIS_WARNING,&quot;-sdown&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    2272 </span>                :<span class="lineNoCov">          0 :             ri-&gt;flags &amp;= ~(SRI_S_DOWN|SRI_SCRIPT_KILL_SENT);</span>
<span class="lineNum">    2273 </span>                :            :         }
<span class="lineNum">    2274 </span>                :            :     }
<span class="lineNum">    2275 </span>                :<span class="lineNoCov">          0 : }</span>
<a name="2276"><span class="lineNum">    2276 </span>                :            : </a>
<span class="lineNum">    2277 </span>                :            : /* Is this instance down accordingly to the configured quorum? */
<span class="lineNum">    2278 </span>                :<span class="lineNoCov">          0 : void sentinelCheckObjectivelyDown(sentinelRedisInstance *master) {</span>
<span class="lineNum">    2279 </span>                :            :     dictIterator *di;
<span class="lineNum">    2280 </span>                :            :     dictEntry *de;
<span class="lineNum">    2281 </span>                :<span class="lineNoCov">          0 :     int quorum = 0, odown = 0;</span>
<span class="lineNum">    2282 </span>                :            : 
<span class="lineNum">    2283 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (master-&gt;flags &amp; SRI_S_DOWN) {</span>
<span class="lineNum">    2284 </span>                :            :         /* Is down for enough sentinels? */
<span class="lineNum">    2285 </span>                :<span class="lineNoCov">          0 :         quorum = 1; /* the current sentinel. */</span>
<span class="lineNum">    2286 </span>                :            :         /* Count all the other sentinels. */
<span class="lineNum">    2287 </span>                :<span class="lineNoCov">          0 :         di = dictGetIterator(master-&gt;sentinels);</span>
<span class="lineNum">    2288 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    2289 </span>                :<span class="lineNoCov">          0 :             sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    2290 </span>                :            : 
<span class="lineNum">    2291 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (ri-&gt;flags &amp; SRI_MASTER_DOWN) quorum++;</span>
<span class="lineNum">    2292 </span>                :            :         }
<span class="lineNum">    2293 </span>                :<span class="lineNoCov">          0 :         dictReleaseIterator(di);</span>
<span class="lineNum">    2294 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (quorum &gt;= master-&gt;quorum) odown = 1;</span>
<span class="lineNum">    2295 </span>                :            :     }
<span class="lineNum">    2296 </span>                :            : 
<span class="lineNum">    2297 </span>                :            :     /* Set the flag accordingly to the outcome. */
<span class="lineNum">    2298 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (odown) {</span>
<span class="lineNum">    2299 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ((master-&gt;flags &amp; SRI_O_DOWN) == 0) {</span>
<span class="lineNum">    2300 </span>                :<span class="lineNoCov">          0 :             sentinelEvent(REDIS_WARNING,&quot;+odown&quot;,master,&quot;%@ #quorum %d/%d&quot;,</span>
<span class="lineNum">    2301 </span>                :            :                 quorum, master-&gt;quorum);
<span class="lineNum">    2302 </span>                :<span class="lineNoCov">          0 :             master-&gt;flags |= SRI_O_DOWN;</span>
<span class="lineNum">    2303 </span>                :<span class="lineNoCov">          0 :             master-&gt;o_down_since_time = mstime();</span>
<span class="lineNum">    2304 </span>                :            :         }
<span class="lineNum">    2305 </span>                :            :     } else {
<span class="lineNum">    2306 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (master-&gt;flags &amp; SRI_O_DOWN) {</span>
<span class="lineNum">    2307 </span>                :<span class="lineNoCov">          0 :             sentinelEvent(REDIS_WARNING,&quot;-odown&quot;,master,&quot;%@&quot;);</span>
<span class="lineNum">    2308 </span>                :<span class="lineNoCov">          0 :             master-&gt;flags &amp;= ~SRI_O_DOWN;</span>
<span class="lineNum">    2309 </span>                :            :         }
<span class="lineNum">    2310 </span>                :            :     }
<span class="lineNum">    2311 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2312 </span>                :            : 
<a name="2313"><span class="lineNum">    2313 </span>                :            : /* Receive the SENTINEL is-master-down-by-addr reply, see the</a>
<span class="lineNum">    2314 </span>                :            :  * sentinelAskMasterStateToOtherSentinels() function for more information. */
<span class="lineNum">    2315 </span>                :<span class="lineNoCov">          0 : void sentinelReceiveIsMasterDownReply(redisAsyncContext *c, void *reply, void *privdata) {</span>
<span class="lineNum">    2316 </span>                :<span class="lineNoCov">          0 :     sentinelRedisInstance *ri = c-&gt;data;</span>
<span class="lineNum">    2317 </span>                :            :     redisReply *r;
<span class="lineNum">    2318 </span>                :            : 
<span class="lineNum">    2319 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri) ri-&gt;pending_commands--;</span>
<span class="lineNum">    2320 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!reply || !ri) return;</span>
<span class="lineNum">    2321 </span>                :<span class="lineNoCov">          0 :     r = reply;</span>
<span class="lineNum">    2322 </span>                :            : 
<span class="lineNum">    2323 </span>                :            :     /* Ignore every error or unexpected reply.
<span class="lineNum">    2324 </span>                :            :      * Note that if the command returns an error for any reason we'll
<span class="lineNum">    2325 </span>                :            :      * end clearing the SRI_MASTER_DOWN flag for timeout anyway. */
<span class="lineNum">    2326 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (r-&gt;type == REDIS_REPLY_ARRAY &amp;&amp; r-&gt;elements == 2 &amp;&amp;</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    2327 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         r-&gt;element[0]-&gt;type == REDIS_REPLY_INTEGER &amp;&amp;</span>
<span class="lineNum">    2328 </span>                :<span class="lineNoCov">          0 :         r-&gt;element[1]-&gt;type == REDIS_REPLY_STRING)</span>
<span class="lineNum">    2329 </span>                :            :     {
<span class="lineNum">    2330 </span>                :<span class="lineNoCov">          0 :         ri-&gt;last_master_down_reply_time = mstime();</span>
<span class="lineNum">    2331 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (r-&gt;element[0]-&gt;integer == 1) {</span>
<span class="lineNum">    2332 </span>                :<span class="lineNoCov">          0 :             ri-&gt;flags |= SRI_MASTER_DOWN;</span>
<span class="lineNum">    2333 </span>                :            :         } else {
<span class="lineNum">    2334 </span>                :<span class="lineNoCov">          0 :             ri-&gt;flags &amp;= ~SRI_MASTER_DOWN;</span>
<span class="lineNum">    2335 </span>                :            :         }
<span class="lineNum">    2336 </span>                :<span class="lineNoCov">          0 :         sdsfree(ri-&gt;leader);</span>
<span class="lineNum">    2337 </span>                :<span class="lineNoCov">          0 :         ri-&gt;leader = sdsnew(r-&gt;element[1]-&gt;str);</span>
<span class="lineNum">    2338 </span>                :            :     }
<span class="lineNum">    2339 </span>                :            : }
<span class="lineNum">    2340 </span>                :            : 
<span class="lineNum">    2341 </span>                :            : /* If we think (subjectively) the master is down, we start sending
<span class="lineNum">    2342 </span>                :            :  * SENTINEL IS-MASTER-DOWN-BY-ADDR requests to other sentinels
<a name="2343"><span class="lineNum">    2343 </span>                :            :  * in order to get the replies that allow to reach the quorum and</a>
<span class="lineNum">    2344 </span>                :            :  * possibly also mark the master as objectively down. */
<span class="lineNum">    2345 </span>                :<span class="lineNoCov">          0 : void sentinelAskMasterStateToOtherSentinels(sentinelRedisInstance *master) {</span>
<span class="lineNum">    2346 </span>                :            :     dictIterator *di;
<span class="lineNum">    2347 </span>                :            :     dictEntry *de;
<span class="lineNum">    2348 </span>                :            : 
<span class="lineNum">    2349 </span>                :<span class="lineNoCov">          0 :     di = dictGetIterator(master-&gt;sentinels);</span>
<span class="lineNum">    2350 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    2351 </span>                :<span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    2352 </span>                :<span class="lineNoCov">          0 :         mstime_t elapsed = mstime() - ri-&gt;last_master_down_reply_time;</span>
<span class="lineNum">    2353 </span>                :            :         char port[32];
<span class="lineNum">    2354 </span>                :            :         int retval;
<span class="lineNum">    2355 </span>                :            : 
<span class="lineNum">    2356 </span>                :            :         /* If the master state from other sentinel is too old, we clear it. */
<span class="lineNum">    2357 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (elapsed &gt; SENTINEL_INFO_VALIDITY_TIME) {</span>
<span class="lineNum">    2358 </span>                :<span class="lineNoCov">          0 :             ri-&gt;flags &amp;= ~SRI_MASTER_DOWN;</span>
<span class="lineNum">    2359 </span>                :<span class="lineNoCov">          0 :             sdsfree(ri-&gt;leader);</span>
<span class="lineNum">    2360 </span>                :<span class="lineNoCov">          0 :             ri-&gt;leader = NULL;</span>
<span class="lineNum">    2361 </span>                :            :         }
<span class="lineNum">    2362 </span>                :            : 
<span class="lineNum">    2363 </span>                :            :         /* Only ask if master is down to other sentinels if:
<span class="lineNum">    2364 </span>                :            :          *
<span class="lineNum">    2365 </span>                :            :          * 1) We believe it is down, or there is a failover in progress.
<span class="lineNum">    2366 </span>                :            :          * 2) Sentinel is connected.
<span class="lineNum">    2367 </span>                :            :          * 3) We did not received the info within SENTINEL_ASK_PERIOD ms. */
<span class="lineNum">    2368 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ((master-&gt;flags &amp; (SRI_S_DOWN|SRI_FAILOVER_IN_PROGRESS)) == 0)</span>
<span class="lineNum">    2369 </span>                :<span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    2370 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ri-&gt;flags &amp; SRI_DISCONNECTED) continue;</span>
<span class="lineNum">    2371 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (mstime() - ri-&gt;last_master_down_reply_time &lt; SENTINEL_ASK_PERIOD)</span>
<span class="lineNum">    2372 </span>                :<span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    2373 </span>                :            : 
<span class="lineNum">    2374 </span>                :            :         /* Ask */
<span class="lineNum">    2375 </span>                :<span class="lineNoCov">          0 :         ll2string(port,sizeof(port),master-&gt;addr-&gt;port);</span>
<span class="lineNum">    2376 </span>                :<span class="lineNoCov">          0 :         retval = redisAsyncCommand(ri-&gt;cc,</span>
<span class="lineNum">    2377 </span>                :            :                     sentinelReceiveIsMasterDownReply, NULL,
<span class="lineNum">    2378 </span>                :            :                     &quot;SENTINEL is-master-down-by-addr %s %s&quot;,
<span class="lineNum">    2379 </span>                :<span class="lineNoCov">          0 :                     master-&gt;addr-&gt;ip, port);</span>
<span class="lineNum">    2380 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (retval == REDIS_OK) ri-&gt;pending_commands++;</span>
<span class="lineNum">    2381 </span>                :            :     }
<span class="lineNum">    2382 </span>                :<span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    2383 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2384 </span>                :            : 
<span class="lineNum">    2385 </span>                :            : /* =============================== FAILOVER ================================= */
<span class="lineNum">    2386 </span>                :            : 
<span class="lineNum">    2387 </span>                :            : /* Given a master get the &quot;subjective leader&quot;, that is, among all the sentinels
<span class="lineNum">    2388 </span>                :            :  * with given characteristics, the one with the lexicographically smaller
<span class="lineNum">    2389 </span>                :            :  * runid. The characteristics required are:
<span class="lineNum">    2390 </span>                :            :  *
<span class="lineNum">    2391 </span>                :            :  * 1) Has SRI_CAN_FAILOVER flag.
<span class="lineNum">    2392 </span>                :            :  * 2) Is not disconnected.
<span class="lineNum">    2393 </span>                :            :  * 3) Recently answered to our ping (no longer than
<span class="lineNum">    2394 </span>                :            :  *    SENTINEL_INFO_VALIDITY_TIME milliseconds ago).
<span class="lineNum">    2395 </span>                :            :  *
<span class="lineNum">    2396 </span>                :            :  * The function returns a pointer to an sds string representing the runid of the
<span class="lineNum">    2397 </span>                :            :  * leader sentinel instance (from our point of view). Otherwise NULL is
<span class="lineNum">    2398 </span>                :            :  * returned if there are no suitable sentinels.
<a name="2399"><span class="lineNum">    2399 </span>                :            :  */</a>
<span class="lineNum">    2400 </span>                :            : 
<span class="lineNum">    2401 </span>                :<span class="lineNoCov">          0 : int compareRunID(const void *a, const void *b) {</span>
<span class="lineNum">    2402 </span>                :<span class="lineNoCov">          0 :     char **aptrptr = (char**)a, **bptrptr = (char**)b;</span>
<span class="lineNum">    2403 </span>                :<span class="lineNoCov">          0 :     return strcasecmp(*aptrptr, *bptrptr);</span>
<a name="2404"><span class="lineNum">    2404 </span>                :            : }</a>
<span class="lineNum">    2405 </span>                :            : 
<span class="lineNum">    2406 </span>                :<span class="lineNoCov">          0 : char *sentinelGetSubjectiveLeader(sentinelRedisInstance *master) {</span>
<span class="lineNum">    2407 </span>                :            :     dictIterator *di;
<span class="lineNum">    2408 </span>                :            :     dictEntry *de;
<span class="lineNum">    2409 </span>                :<span class="lineNoCov">          0 :     char **instance =</span>
<span class="lineNum">    2410 </span>                :<span class="lineNoCov">          0 :         zmalloc(sizeof(char*)*(dictSize(master-&gt;sentinels)+1));</span>
<span class="lineNum">    2411 </span>                :<span class="lineNoCov">          0 :     int instances = 0;</span>
<span class="lineNum">    2412 </span>                :<span class="lineNoCov">          0 :     char *leader = NULL;</span>
<span class="lineNum">    2413 </span>                :            : 
<span class="lineNum">    2414 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (master-&gt;flags &amp; SRI_CAN_FAILOVER) {</span>
<span class="lineNum">    2415 </span>                :            :         /* Add myself if I'm a Sentinel that can failover this master. */
<span class="lineNum">    2416 </span>                :<span class="lineNoCov">          0 :         instance[instances++] = server.runid;</span>
<span class="lineNum">    2417 </span>                :            :     }
<span class="lineNum">    2418 </span>                :            : 
<span class="lineNum">    2419 </span>                :<span class="lineNoCov">          0 :     di = dictGetIterator(master-&gt;sentinels);</span>
<span class="lineNum">    2420 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    2421 </span>                :<span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    2422 </span>                :<span class="lineNoCov">          0 :         mstime_t lag = mstime() - ri-&gt;last_avail_time;</span>
<span class="lineNum">    2423 </span>                :            : 
<span class="lineNum">    2424 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (lag &gt; SENTINEL_INFO_VALIDITY_TIME ||</span>
<span class="lineNum">    2425 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             !(ri-&gt;flags &amp; SRI_CAN_FAILOVER) ||</span>
<span class="lineNum">    2426 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             (ri-&gt;flags &amp; SRI_DISCONNECTED) ||</span>
<span class="lineNum">    2427 </span>                :<span class="lineNoCov">          0 :             ri-&gt;runid == NULL)</span>
<span class="lineNum">    2428 </span>                :<span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    2429 </span>                :<span class="lineNoCov">          0 :         instance[instances++] = ri-&gt;runid;</span>
<span class="lineNum">    2430 </span>                :            :     }
<span class="lineNum">    2431 </span>                :<span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    2432 </span>                :            : 
<span class="lineNum">    2433 </span>                :            :     /* If we have at least one instance passing our checks, order the array
<span class="lineNum">    2434 </span>                :            :      * by runid. */
<span class="lineNum">    2435 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (instances) {</span>
<span class="lineNum">    2436 </span>                :<span class="lineNoCov">          0 :         qsort(instance,instances,sizeof(char*),compareRunID);</span>
<span class="lineNum">    2437 </span>                :<span class="lineNoCov">          0 :         leader = sdsnew(instance[0]);</span>
<span class="lineNum">    2438 </span>                :            :     }
<span class="lineNum">    2439 </span>                :<span class="lineNoCov">          0 :     zfree(instance);</span>
<span class="lineNum">    2440 </span>                :<span class="lineNoCov">          0 :     return leader;</span>
<span class="lineNum">    2441 </span>                :            : }
<span class="lineNum">    2442 </span>                :            : 
<span class="lineNum">    2443 </span>                :            : struct sentinelLeader {
<span class="lineNum">    2444 </span>                :            :     char *runid;
<span class="lineNum">    2445 </span>                :            :     unsigned long votes;
<span class="lineNum">    2446 </span>                :            : };
<span class="lineNum">    2447 </span>                :            : 
<a name="2448"><span class="lineNum">    2448 </span>                :            : /* Helper function for sentinelGetObjectiveLeader, increment the counter</a>
<span class="lineNum">    2449 </span>                :            :  * relative to the specified runid. */
<span class="lineNum">    2450 </span>                :<span class="lineNoCov">          0 : void sentinelObjectiveLeaderIncr(dict *counters, char *runid) {</span>
<span class="lineNum">    2451 </span>                :<span class="lineNoCov">          0 :     dictEntry *de = dictFind(counters,runid);</span>
<span class="lineNum">    2452 </span>                :            :     uint64_t oldval;
<span class="lineNum">    2453 </span>                :            : 
<span class="lineNum">    2454 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (de) {</span>
<span class="lineNum">    2455 </span>                :<span class="lineNoCov">          0 :         oldval = dictGetUnsignedIntegerVal(de);</span>
<span class="lineNum">    2456 </span>                :<span class="lineNoCov">          0 :         dictSetUnsignedIntegerVal(de,oldval+1);</span>
<span class="lineNum">    2457 </span>                :            :     } else {
<span class="lineNum">    2458 </span>                :<span class="lineNoCov">          0 :         de = dictAddRaw(counters,runid);</span>
<span class="lineNum">    2459 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         redisAssert(de != NULL);</span>
<span class="lineNum">    2460 </span>                :<span class="lineNoCov">          0 :         dictSetUnsignedIntegerVal(de,1);</span>
<span class="lineNum">    2461 </span>                :            :     }
<span class="lineNum">    2462 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2463 </span>                :            : 
<a name="2464"><span class="lineNum">    2464 </span>                :            : /* Scan all the Sentinels attached to this master to check what is the</a>
<span class="lineNum">    2465 </span>                :            :  * most voted leader among Sentinels. */
<span class="lineNum">    2466 </span>                :<span class="lineNoCov">          0 : char *sentinelGetObjectiveLeader(sentinelRedisInstance *master) {</span>
<span class="lineNum">    2467 </span>                :            :     dict *counters;
<span class="lineNum">    2468 </span>                :            :     dictIterator *di;
<span class="lineNum">    2469 </span>                :            :     dictEntry *de;
<span class="lineNum">    2470 </span>                :<span class="lineNoCov">          0 :     unsigned int voters = 0, voters_quorum;</span>
<span class="lineNum">    2471 </span>                :            :     char *myvote;
<span class="lineNum">    2472 </span>                :<span class="lineNoCov">          0 :     char *winner = NULL;</span>
<span class="lineNum">    2473 </span>                :            : 
<span class="lineNum">    2474 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     redisAssert(master-&gt;flags &amp; (SRI_O_DOWN|SRI_FAILOVER_IN_PROGRESS));</span>
<span class="lineNum">    2475 </span>                :<span class="lineNoCov">          0 :     counters = dictCreate(&amp;leaderVotesDictType,NULL);</span>
<span class="lineNum">    2476 </span>                :            : 
<span class="lineNum">    2477 </span>                :            :     /* Count my vote. */
<span class="lineNum">    2478 </span>                :<span class="lineNoCov">          0 :     myvote = sentinelGetSubjectiveLeader(master);</span>
<span class="lineNum">    2479 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (myvote) {</span>
<span class="lineNum">    2480 </span>                :<span class="lineNoCov">          0 :         sentinelObjectiveLeaderIncr(counters,myvote);</span>
<span class="lineNum">    2481 </span>                :<span class="lineNoCov">          0 :         voters++;</span>
<span class="lineNum">    2482 </span>                :            :     }
<span class="lineNum">    2483 </span>                :            : 
<span class="lineNum">    2484 </span>                :            :     /* Count other sentinels votes */
<span class="lineNum">    2485 </span>                :<span class="lineNoCov">          0 :     di = dictGetIterator(master-&gt;sentinels);</span>
<span class="lineNum">    2486 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    2487 </span>                :<span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    2488 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ri-&gt;leader == NULL) continue;</span>
<span class="lineNum">    2489 </span>                :            :         /* If the failover is not already in progress we are only interested
<span class="lineNum">    2490 </span>                :            :          * in Sentinels that believe the master is down. Otherwise the leader
<span class="lineNum">    2491 </span>                :            :          * selection is useful for the &quot;failover-takedown&quot; when the original
<span class="lineNum">    2492 </span>                :            :          * leader fails. In that case we consider all the voters. */
<span class="lineNum">    2493 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!(master-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) &amp;&amp;</span>
<span class="lineNum">    2494 </span>                :<span class="lineNoCov">          0 :             !(ri-&gt;flags &amp; SRI_MASTER_DOWN)) continue;</span>
<span class="lineNum">    2495 </span>                :<span class="lineNoCov">          0 :         sentinelObjectiveLeaderIncr(counters,ri-&gt;leader);</span>
<span class="lineNum">    2496 </span>                :<span class="lineNoCov">          0 :         voters++;</span>
<span class="lineNum">    2497 </span>                :            :     }
<span class="lineNum">    2498 </span>                :<span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    2499 </span>                :<span class="lineNoCov">          0 :     voters_quorum = voters/2+1;</span>
<span class="lineNum">    2500 </span>                :            : 
<span class="lineNum">    2501 </span>                :            :     /* Check what's the winner. For the winner to win, it needs two conditions:
<span class="lineNum">    2502 </span>                :            :      * 1) Absolute majority between voters (50% + 1).
<span class="lineNum">    2503 </span>                :            :      * 2) And anyway at least master-&gt;quorum votes. */
<span class="lineNum">    2504 </span>                :            :     {
<span class="lineNum">    2505 </span>                :<span class="lineNoCov">          0 :         uint64_t max_votes = 0; /* Max votes so far. */</span>
<span class="lineNum">    2506 </span>                :            : 
<span class="lineNum">    2507 </span>                :<span class="lineNoCov">          0 :         di = dictGetIterator(counters);</span>
<span class="lineNum">    2508 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    2509 </span>                :<span class="lineNoCov">          0 :             uint64_t votes = dictGetUnsignedIntegerVal(de);</span>
<span class="lineNum">    2510 </span>                :            : 
<span class="lineNum">    2511 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (max_votes &lt; votes) {</span>
<span class="lineNum">    2512 </span>                :<span class="lineNoCov">          0 :                 max_votes = votes;</span>
<span class="lineNum">    2513 </span>                :<span class="lineNoCov">          0 :                 winner = dictGetKey(de);</span>
<span class="lineNum">    2514 </span>                :            :             }
<span class="lineNum">    2515 </span>                :            :         }
<span class="lineNum">    2516 </span>                :<span class="lineNoCov">          0 :         dictReleaseIterator(di);</span>
<span class="lineNum">    2517 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (winner &amp;&amp; (max_votes &lt; voters_quorum || max_votes &lt; master-&gt;quorum))</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    2518 </span>                :<span class="lineNoCov">          0 :             winner = NULL;</span>
<span class="lineNum">    2519 </span>                :            :     }
<span class="lineNum">    2520 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     winner = winner ? sdsnew(winner) : NULL;</span>
<span class="lineNum">    2521 </span>                :<span class="lineNoCov">          0 :     sdsfree(myvote);</span>
<span class="lineNum">    2522 </span>                :<span class="lineNoCov">          0 :     dictRelease(counters);</span>
<span class="lineNum">    2523 </span>                :<span class="lineNoCov">          0 :     return winner;</span>
<span class="lineNum">    2524 </span>                :            : }
<span class="lineNum">    2525 </span>                :            : 
<span class="lineNum">    2526 </span>                :            : /* Setup the master state to start a failover as a leader.
<span class="lineNum">    2527 </span>                :            :  *
<span class="lineNum">    2528 </span>                :            :  * State can be either:
<span class="lineNum">    2529 </span>                :            :  *
<span class="lineNum">    2530 </span>                :            :  * SENTINEL_FAILOVER_STATE_WAIT_START: starts a failover from scratch.
<a name="2531"><span class="lineNum">    2531 </span>                :            :  * SENTINEL_FAILOVER_STATE_RECONF_SLAVES: takedown a failed failover.</a>
<span class="lineNum">    2532 </span>                :            :  */
<span class="lineNum">    2533 </span>                :<span class="lineNoCov">          0 : void sentinelStartFailover(sentinelRedisInstance *master, int state) {</span>
<span class="lineNum">    2534 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     redisAssert(master-&gt;flags &amp; SRI_MASTER);</span>
<span class="lineNum">    2535 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     redisAssert(state == SENTINEL_FAILOVER_STATE_WAIT_START ||</span>
<span class="lineNum">    2536 </span>                :            :                 state == SENTINEL_FAILOVER_STATE_RECONF_SLAVES);
<span class="lineNum">    2537 </span>                :            : 
<span class="lineNum">    2538 </span>                :<span class="lineNoCov">          0 :     master-&gt;failover_state = state;</span>
<span class="lineNum">    2539 </span>                :<span class="lineNoCov">          0 :     master-&gt;flags |= SRI_FAILOVER_IN_PROGRESS|SRI_I_AM_THE_LEADER;</span>
<span class="lineNum">    2540 </span>                :<span class="lineNoCov">          0 :     sentinelEvent(REDIS_WARNING,&quot;+failover-triggered&quot;,master,&quot;%@&quot;);</span>
<span class="lineNum">    2541 </span>                :            : 
<span class="lineNum">    2542 </span>                :            :     /* Pick a random delay if it's a fresh failover (WAIT_START), and not
<span class="lineNum">    2543 </span>                :            :      * a recovery of a failover started by another sentinel. */
<span class="lineNum">    2544 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (master-&gt;failover_state == SENTINEL_FAILOVER_STATE_WAIT_START) {</span>
<span class="lineNum">    2545 </span>                :<span class="lineNoCov">          0 :         master-&gt;failover_start_time = mstime() +</span>
<span class="lineNum">    2546 </span>                :<span class="lineNoCov">          0 :             SENTINEL_FAILOVER_FIXED_DELAY +</span>
<span class="lineNum">    2547 </span>                :<span class="lineNoCov">          0 :             (rand() % SENTINEL_FAILOVER_MAX_RANDOM_DELAY);</span>
<span class="lineNum">    2548 </span>                :<span class="lineNoCov">          0 :         sentinelEvent(REDIS_WARNING,&quot;+failover-state-wait-start&quot;,master,</span>
<span class="lineNum">    2549 </span>                :            :             &quot;%@ #starting in %lld milliseconds&quot;,
<span class="lineNum">    2550 </span>                :<span class="lineNoCov">          0 :             master-&gt;failover_start_time-mstime());</span>
<span class="lineNum">    2551 </span>                :            :     }
<span class="lineNum">    2552 </span>                :<span class="lineNoCov">          0 :     master-&gt;failover_state_change_time = mstime();</span>
<span class="lineNum">    2553 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2554 </span>                :            : 
<span class="lineNum">    2555 </span>                :            : /* This function checks if there are the conditions to start the failover,
<span class="lineNum">    2556 </span>                :            :  * that is:
<span class="lineNum">    2557 </span>                :            :  *
<span class="lineNum">    2558 </span>                :            :  * 1) Enough time has passed since O_DOWN.
<span class="lineNum">    2559 </span>                :            :  * 2) The master is marked as SRI_CAN_FAILOVER, so we can failover it.
<span class="lineNum">    2560 </span>                :            :  * 3) We are the objectively leader for this master.
<span class="lineNum">    2561 </span>                :            :  *
<span class="lineNum">    2562 </span>                :            :  * If the conditions are met we flag the master as SRI_FAILOVER_IN_PROGRESS
<a name="2563"><span class="lineNum">    2563 </span>                :            :  * and SRI_I_AM_THE_LEADER.</a>
<span class="lineNum">    2564 </span>                :            :  */
<span class="lineNum">    2565 </span>                :<span class="lineNoCov">          0 : void sentinelStartFailoverIfNeeded(sentinelRedisInstance *master) {</span>
<span class="lineNum">    2566 </span>                :            :     char *leader;
<span class="lineNum">    2567 </span>                :            :     int isleader;
<span class="lineNum">    2568 </span>                :            : 
<span class="lineNum">    2569 </span>                :            :     /* We can't failover if the master is not in O_DOWN state or if
<span class="lineNum">    2570 </span>                :            :      * there is not already a failover in progress (to perform the
<span class="lineNum">    2571 </span>                :            :      * takedown if the leader died) or if this Sentinel is not allowed
<span class="lineNum">    2572 </span>                :            :      * to start a failover. */
<span class="lineNum">    2573 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!(master-&gt;flags &amp; SRI_CAN_FAILOVER) ||</span>
<span class="lineNum">    2574 </span>                :<span class="lineNoCov">          0 :         !(master-&gt;flags &amp; (SRI_O_DOWN|SRI_FAILOVER_IN_PROGRESS))) return;</span>
<span class="lineNum">    2575 </span>                :            : 
<span class="lineNum">    2576 </span>                :<span class="lineNoCov">          0 :     leader = sentinelGetObjectiveLeader(master);</span>
<span class="lineNum">    2577 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :     isleader = leader &amp;&amp; strcasecmp(leader,server.runid) == 0;</span>
<span class="lineNum">    2578 </span>                :<span class="lineNoCov">          0 :     sdsfree(leader);</span>
<span class="lineNum">    2579 </span>                :            : 
<span class="lineNum">    2580 </span>                :            :     /* If I'm not the leader, I can't failover for sure. */
<span class="lineNum">    2581 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!isleader) return;</span>
<span class="lineNum">    2582 </span>                :            : 
<span class="lineNum">    2583 </span>                :            :     /* If the failover is already in progress there are two options... */
<span class="lineNum">    2584 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (master-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) {</span>
<span class="lineNum">    2585 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (master-&gt;flags &amp; SRI_I_AM_THE_LEADER) {</span>
<span class="lineNum">    2586 </span>                :            :             /* 1) I'm flagged as leader so I already started the failover.
<span class="lineNum">    2587 </span>                :            :              *    Just return. */
<span class="lineNum">    2588 </span>                :            :             return;
<span class="lineNum">    2589 </span>                :            :         } else {
<span class="lineNum">    2590 </span>                :<span class="lineNoCov">          0 :             mstime_t elapsed = mstime() - master-&gt;failover_state_change_time;</span>
<span class="lineNum">    2591 </span>                :            : 
<span class="lineNum">    2592 </span>                :            :             /* 2) I'm the new leader, but I'm not flagged as leader in the
<span class="lineNum">    2593 </span>                :            :              *    master: I did not started the failover, but the original
<span class="lineNum">    2594 </span>                :            :              *    leader has no longer the leadership.
<span class="lineNum">    2595 </span>                :            :              *
<span class="lineNum">    2596 </span>                :            :              *    In this case if the failover appears to be lagging
<span class="lineNum">    2597 </span>                :            :              *    for at least 25% of the configured failover timeout,
<span class="lineNum">    2598 </span>                :            :              *    I can assume I can take control. Otherwise
<span class="lineNum">    2599 </span>                :            :              *    it's better to return and wait more. */
<span class="lineNum">    2600 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (elapsed &lt; (master-&gt;failover_timeout/4)) return;</span>
<span class="lineNum">    2601 </span>                :<span class="lineNoCov">          0 :             sentinelEvent(REDIS_WARNING,&quot;+failover-takedown&quot;,master,&quot;%@&quot;);</span>
<span class="lineNum">    2602 </span>                :            :             /* We have already an elected slave if we are in
<span class="lineNum">    2603 </span>                :            :              * FAILOVER_IN_PROGRESS state, that is, the slave that we
<span class="lineNum">    2604 </span>                :            :              * observed turning into a master. */
<span class="lineNum">    2605 </span>                :<span class="lineNoCov">          0 :             sentinelStartFailover(master,SENTINEL_FAILOVER_STATE_RECONF_SLAVES);</span>
<span class="lineNum">    2606 </span>                :            :             /* As an observer we flagged all the slaves as RECONF_SENT but
<span class="lineNum">    2607 </span>                :            :              * now we are in charge of actually sending the reconfiguration
<span class="lineNum">    2608 </span>                :            :              * command so let's clear this flag for all the instances. */
<span class="lineNum">    2609 </span>                :<span class="lineNoCov">          0 :             sentinelDelFlagsToDictOfRedisInstances(master-&gt;slaves,</span>
<span class="lineNum">    2610 </span>                :            :                 SRI_RECONF_SENT);
<span class="lineNum">    2611 </span>                :            :         }
<span class="lineNum">    2612 </span>                :            :     } else {
<span class="lineNum">    2613 </span>                :            :         /* Brand new failover as SRI_FAILOVER_IN_PROGRESS was not set.
<span class="lineNum">    2614 </span>                :            :          *
<span class="lineNum">    2615 </span>                :            :          * Do we have a slave to promote? Otherwise don't start a failover
<span class="lineNum">    2616 </span>                :            :          * at all. */
<span class="lineNum">    2617 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (sentinelSelectSlave(master) == NULL) return;</span>
<span class="lineNum">    2618 </span>                :<span class="lineNoCov">          0 :         sentinelStartFailover(master,SENTINEL_FAILOVER_STATE_WAIT_START);</span>
<span class="lineNum">    2619 </span>                :            :     }
<span class="lineNum">    2620 </span>                :            : }
<span class="lineNum">    2621 </span>                :            : 
<span class="lineNum">    2622 </span>                :            : /* Select a suitable slave to promote. The current algorithm only uses
<span class="lineNum">    2623 </span>                :            :  * the following parameters:
<span class="lineNum">    2624 </span>                :            :  *
<span class="lineNum">    2625 </span>                :            :  * 1) None of the following conditions: S_DOWN, O_DOWN, DISCONNECTED.
<span class="lineNum">    2626 </span>                :            :  * 2) last_avail_time more recent than SENTINEL_INFO_VALIDITY_TIME.
<span class="lineNum">    2627 </span>                :            :  * 3) info_refresh more recent than SENTINEL_INFO_VALIDITY_TIME.
<span class="lineNum">    2628 </span>                :            :  * 4) master_link_down_time no more than:
<span class="lineNum">    2629 </span>                :            :  *     (now - master-&gt;s_down_since_time) + (master-&gt;down_after_period * 10).
<span class="lineNum">    2630 </span>                :            :  * 5) Slave priority can't be zero, otherwise the slave is discarded.
<span class="lineNum">    2631 </span>                :            :  *
<span class="lineNum">    2632 </span>                :            :  * Among all the slaves matching the above conditions we select the slave
<span class="lineNum">    2633 </span>                :            :  * with lower slave_priority. If priority is the same we select the slave
<span class="lineNum">    2634 </span>                :            :  * with lexicographically smaller runid.
<span class="lineNum">    2635 </span>                :            :  *
<span class="lineNum">    2636 </span>                :            :  * The function returns the pointer to the selected slave, otherwise
<span class="lineNum">    2637 </span>                :            :  * NULL if no suitable slave was found.
<a name="2638"><span class="lineNum">    2638 </span>                :            :  */</a>
<span class="lineNum">    2639 </span>                :            : 
<span class="lineNum">    2640 </span>                :<span class="lineNoCov">          0 : int compareSlavesForPromotion(const void *a, const void *b) {</span>
<span class="lineNum">    2641 </span>                :<span class="lineNoCov">          0 :     sentinelRedisInstance **sa = (sentinelRedisInstance **)a,</span>
<span class="lineNum">    2642 </span>                :<span class="lineNoCov">          0 :                           **sb = (sentinelRedisInstance **)b;</span>
<span class="lineNum">    2643 </span>                :            :     char *sa_runid, *sb_runid;
<span class="lineNum">    2644 </span>                :            : 
<span class="lineNum">    2645 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if ((*sa)-&gt;slave_priority != (*sb)-&gt;slave_priority)</span>
<span class="lineNum">    2646 </span>                :<span class="lineNoCov">          0 :         return (*sa)-&gt;slave_priority - (*sb)-&gt;slave_priority;</span>
<span class="lineNum">    2647 </span>                :            : 
<span class="lineNum">    2648 </span>                :            :     /* If priority is the same, select the slave with that has the
<span class="lineNum">    2649 </span>                :            :      * lexicographically smaller runid. Note that we try to handle runid
<span class="lineNum">    2650 </span>                :            :      * == NULL as there are old Redis versions that don't publish runid in
<span class="lineNum">    2651 </span>                :            :      * INFO. A NULL runid is considered bigger than any other runid. */
<span class="lineNum">    2652 </span>                :<span class="lineNoCov">          0 :     sa_runid = (*sa)-&gt;runid;</span>
<span class="lineNum">    2653 </span>                :<span class="lineNoCov">          0 :     sb_runid = (*sb)-&gt;runid;</span>
<span class="lineNum">    2654 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (sa_runid == NULL &amp;&amp; sb_runid == NULL) return 0;</span>
<span class="lineNum">    2655 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     else if (sa_runid == NULL) return 1;  /* a &gt; b */</span>
<span class="lineNum">    2656 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     else if (sb_runid == NULL) return -1; /* a &lt; b */</span>
<span class="lineNum">    2657 </span>                :<span class="lineNoCov">          0 :     return strcasecmp(sa_runid, sb_runid);</span>
<a name="2658"><span class="lineNum">    2658 </span>                :            : }</a>
<span class="lineNum">    2659 </span>                :            : 
<span class="lineNum">    2660 </span>                :<span class="lineNoCov">          0 : sentinelRedisInstance *sentinelSelectSlave(sentinelRedisInstance *master) {</span>
<span class="lineNum">    2661 </span>                :<span class="lineNoCov">          0 :     sentinelRedisInstance **instance =</span>
<span class="lineNum">    2662 </span>                :<span class="lineNoCov">          0 :         zmalloc(sizeof(instance[0])*dictSize(master-&gt;slaves));</span>
<span class="lineNum">    2663 </span>                :<span class="lineNoCov">          0 :     sentinelRedisInstance *selected = NULL;</span>
<span class="lineNum">    2664 </span>                :<span class="lineNoCov">          0 :     int instances = 0;</span>
<span class="lineNum">    2665 </span>                :            :     dictIterator *di;
<span class="lineNum">    2666 </span>                :            :     dictEntry *de;
<span class="lineNum">    2667 </span>                :<span class="lineNoCov">          0 :     mstime_t max_master_down_time = 0;</span>
<span class="lineNum">    2668 </span>                :            : 
<span class="lineNum">    2669 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (master-&gt;flags &amp; SRI_S_DOWN)</span>
<span class="lineNum">    2670 </span>                :<span class="lineNoCov">          0 :         max_master_down_time += mstime() - master-&gt;s_down_since_time;</span>
<span class="lineNum">    2671 </span>                :<span class="lineNoCov">          0 :     max_master_down_time += master-&gt;down_after_period * 10;</span>
<span class="lineNum">    2672 </span>                :            : 
<span class="lineNum">    2673 </span>                :<span class="lineNoCov">          0 :     di = dictGetIterator(master-&gt;slaves);</span>
<span class="lineNum">    2674 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    2675 </span>                :<span class="lineNoCov">          0 :         sentinelRedisInstance *slave = dictGetVal(de);</span>
<span class="lineNum">    2676 </span>                :<span class="lineNoCov">          0 :         mstime_t info_validity_time = mstime()-SENTINEL_INFO_VALIDITY_TIME;</span>
<span class="lineNum">    2677 </span>                :            : 
<span class="lineNum">    2678 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (slave-&gt;flags &amp; (SRI_S_DOWN|SRI_O_DOWN|SRI_DISCONNECTED)) continue;</span>
<span class="lineNum">    2679 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (slave-&gt;flags &amp; SRI_DEMOTE) continue; /* Old master not yet ready. */</span>
<span class="lineNum">    2680 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (slave-&gt;last_avail_time &lt; info_validity_time) continue;</span>
<span class="lineNum">    2681 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (slave-&gt;slave_priority == 0) continue;</span>
<span class="lineNum">    2682 </span>                :            : 
<span class="lineNum">    2683 </span>                :            :         /* If the master is in SDOWN state we get INFO for slaves every second.
<span class="lineNum">    2684 </span>                :            :          * Otherwise we get it with the usual period so we need to account for
<span class="lineNum">    2685 </span>                :            :          * a larger delay. */
<span class="lineNum">    2686 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ((master-&gt;flags &amp; SRI_S_DOWN) == 0)</span>
<span class="lineNum">    2687 </span>                :<span class="lineNoCov">          0 :             info_validity_time -= SENTINEL_INFO_PERIOD;</span>
<span class="lineNum">    2688 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (slave-&gt;info_refresh &lt; info_validity_time) continue;</span>
<span class="lineNum">    2689 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (slave-&gt;master_link_down_time &gt; max_master_down_time) continue;</span>
<span class="lineNum">    2690 </span>                :<span class="lineNoCov">          0 :         instance[instances++] = slave;</span>
<span class="lineNum">    2691 </span>                :            :     }
<span class="lineNum">    2692 </span>                :<span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    2693 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (instances) {</span>
<span class="lineNum">    2694 </span>                :<span class="lineNoCov">          0 :         qsort(instance,instances,sizeof(sentinelRedisInstance*),</span>
<span class="lineNum">    2695 </span>                :            :             compareSlavesForPromotion);
<span class="lineNum">    2696 </span>                :<span class="lineNoCov">          0 :         selected = instance[0];</span>
<span class="lineNum">    2697 </span>                :            :     }
<span class="lineNum">    2698 </span>                :<span class="lineNoCov">          0 :     zfree(instance);</span>
<span class="lineNum">    2699 </span>                :<span class="lineNoCov">          0 :     return selected;</span>
<span class="lineNum">    2700 </span>                :            : }
<a name="2701"><span class="lineNum">    2701 </span>                :            : </a>
<span class="lineNum">    2702 </span>                :            : /* ---------------- Failover state machine implementation ------------------- */
<span class="lineNum">    2703 </span>                :<span class="lineNoCov">          0 : void sentinelFailoverWaitStart(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    2704 </span>                :            :     /* If we in &quot;wait start&quot; but the master is no longer in ODOWN nor in
<span class="lineNum">    2705 </span>                :            :      * SDOWN condition we abort the failover. This is important as it
<span class="lineNum">    2706 </span>                :            :      * prevents a useless failover in a a notable case of netsplit, where
<span class="lineNum">    2707 </span>                :            :      * the sentinels are split from the redis instances. In this case
<span class="lineNum">    2708 </span>                :            :      * the failover will not start while there is the split because no
<span class="lineNum">    2709 </span>                :            :      * good slave can be reached. However when the split is resolved, we
<span class="lineNum">    2710 </span>                :            :      * can go to waitstart if the slave is back reachable a few milliseconds
<span class="lineNum">    2711 </span>                :            :      * before the master is. In that case when the master is back online
<span class="lineNum">    2712 </span>                :            :      * we cancel the failover. */
<span class="lineNum">    2713 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if ((ri-&gt;flags &amp; (SRI_S_DOWN|SRI_O_DOWN|SRI_FORCE_FAILOVER)) == 0) {</span>
<span class="lineNum">    2714 </span>                :<span class="lineNoCov">          0 :         sentinelEvent(REDIS_WARNING,&quot;-failover-abort-master-is-back&quot;,</span>
<span class="lineNum">    2715 </span>                :            :             ri,&quot;%@&quot;);
<span class="lineNum">    2716 </span>                :<span class="lineNoCov">          0 :         sentinelAbortFailover(ri);</span>
<span class="lineNum">    2717 </span>                :<span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    2718 </span>                :            :     }
<span class="lineNum">    2719 </span>                :            : 
<span class="lineNum">    2720 </span>                :            :     /* Start the failover going to the next state if enough time has
<span class="lineNum">    2721 </span>                :            :      * elapsed. */
<span class="lineNum">    2722 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (mstime() &gt;= ri-&gt;failover_start_time) {</span>
<span class="lineNum">    2723 </span>                :<span class="lineNoCov">          0 :         ri-&gt;failover_state = SENTINEL_FAILOVER_STATE_SELECT_SLAVE;</span>
<span class="lineNum">    2724 </span>                :<span class="lineNoCov">          0 :         ri-&gt;failover_state_change_time = mstime();</span>
<span class="lineNum">    2725 </span>                :<span class="lineNoCov">          0 :         sentinelEvent(REDIS_WARNING,&quot;+failover-state-select-slave&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    2726 </span>                :            :     }
<a name="2727"><span class="lineNum">    2727 </span>                :            : }</a>
<span class="lineNum">    2728 </span>                :            : 
<span class="lineNum">    2729 </span>                :<span class="lineNoCov">          0 : void sentinelFailoverSelectSlave(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    2730 </span>                :<span class="lineNoCov">          0 :     sentinelRedisInstance *slave = sentinelSelectSlave(ri);</span>
<span class="lineNum">    2731 </span>                :            : 
<span class="lineNum">    2732 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (slave == NULL) {</span>
<span class="lineNum">    2733 </span>                :<span class="lineNoCov">          0 :         sentinelEvent(REDIS_WARNING,&quot;-failover-abort-no-good-slave&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    2734 </span>                :<span class="lineNoCov">          0 :         sentinelAbortFailover(ri);</span>
<span class="lineNum">    2735 </span>                :            :     } else {
<span class="lineNum">    2736 </span>                :<span class="lineNoCov">          0 :         sentinelEvent(REDIS_WARNING,&quot;+selected-slave&quot;,slave,&quot;%@&quot;);</span>
<span class="lineNum">    2737 </span>                :<span class="lineNoCov">          0 :         slave-&gt;flags |= SRI_PROMOTED;</span>
<span class="lineNum">    2738 </span>                :<span class="lineNoCov">          0 :         ri-&gt;promoted_slave = slave;</span>
<span class="lineNum">    2739 </span>                :<span class="lineNoCov">          0 :         ri-&gt;failover_state = SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE;</span>
<span class="lineNum">    2740 </span>                :<span class="lineNoCov">          0 :         ri-&gt;failover_state_change_time = mstime();</span>
<span class="lineNum">    2741 </span>                :<span class="lineNoCov">          0 :         sentinelEvent(REDIS_NOTICE,&quot;+failover-state-send-slaveof-noone&quot;,</span>
<span class="lineNum">    2742 </span>                :            :             slave, &quot;%@&quot;);
<span class="lineNum">    2743 </span>                :            :     }
<a name="2744"><span class="lineNum">    2744 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2745 </span>                :            : 
<span class="lineNum">    2746 </span>                :<span class="lineNoCov">          0 : void sentinelFailoverSendSlaveOfNoOne(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    2747 </span>                :            :     int retval;
<span class="lineNum">    2748 </span>                :            : 
<span class="lineNum">    2749 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;promoted_slave-&gt;flags &amp; SRI_DISCONNECTED) return;</span>
<span class="lineNum">    2750 </span>                :            : 
<span class="lineNum">    2751 </span>                :            :     /* Send SLAVEOF NO ONE command to turn the slave into a master.
<span class="lineNum">    2752 </span>                :            :      * We actually register a generic callback for this command as we don't
<span class="lineNum">    2753 </span>                :            :      * really care about the reply. We check if it worked indirectly observing
<span class="lineNum">    2754 </span>                :            :      * if INFO returns a different role (master instead of slave). */
<span class="lineNum">    2755 </span>                :<span class="lineNoCov">          0 :     retval = redisAsyncCommand(ri-&gt;promoted_slave-&gt;cc,</span>
<span class="lineNum">    2756 </span>                :            :         sentinelDiscardReplyCallback, NULL, &quot;SLAVEOF NO ONE&quot;);
<span class="lineNum">    2757 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (retval != REDIS_OK) return;</span>
<span class="lineNum">    2758 </span>                :<span class="lineNoCov">          0 :     ri-&gt;promoted_slave-&gt;pending_commands++;</span>
<span class="lineNum">    2759 </span>                :<span class="lineNoCov">          0 :     sentinelEvent(REDIS_NOTICE, &quot;+failover-state-wait-promotion&quot;,</span>
<span class="lineNum">    2760 </span>                :<span class="lineNoCov">          0 :         ri-&gt;promoted_slave,&quot;%@&quot;);</span>
<span class="lineNum">    2761 </span>                :<span class="lineNoCov">          0 :     ri-&gt;failover_state = SENTINEL_FAILOVER_STATE_WAIT_PROMOTION;</span>
<span class="lineNum">    2762 </span>                :<span class="lineNoCov">          0 :     ri-&gt;failover_state_change_time = mstime();</span>
<span class="lineNum">    2763 </span>                :            : }
<span class="lineNum">    2764 </span>                :            : 
<a name="2765"><span class="lineNum">    2765 </span>                :            : /* We actually wait for promotion indirectly checking with INFO when the</a>
<span class="lineNum">    2766 </span>                :            :  * slave turns into a master. */
<span class="lineNum">    2767 </span>                :<span class="lineNoCov">          0 : void sentinelFailoverWaitPromotion(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    2768 </span>                :<span class="lineNoCov">          0 :     mstime_t elapsed = mstime() - ri-&gt;failover_state_change_time;</span>
<span class="lineNum">    2769 </span>                :            : 
<span class="lineNum">    2770 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (elapsed &gt;= SENTINEL_PROMOTION_RETRY_PERIOD) {</span>
<span class="lineNum">    2771 </span>                :<span class="lineNoCov">          0 :         sentinelEvent(REDIS_WARNING,&quot;-promotion-timeout&quot;,ri-&gt;promoted_slave,</span>
<span class="lineNum">    2772 </span>                :            :             &quot;%@&quot;);
<span class="lineNum">    2773 </span>                :<span class="lineNoCov">          0 :         sentinelEvent(REDIS_WARNING,&quot;+failover-state-select-slave&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    2774 </span>                :<span class="lineNoCov">          0 :         ri-&gt;failover_state = SENTINEL_FAILOVER_STATE_SELECT_SLAVE;</span>
<span class="lineNum">    2775 </span>                :<span class="lineNoCov">          0 :         ri-&gt;failover_state_change_time = mstime();</span>
<span class="lineNum">    2776 </span>                :<span class="lineNoCov">          0 :         ri-&gt;promoted_slave-&gt;flags &amp;= ~SRI_PROMOTED;</span>
<span class="lineNum">    2777 </span>                :<span class="lineNoCov">          0 :         ri-&gt;promoted_slave = NULL;</span>
<span class="lineNum">    2778 </span>                :            :     }
<a name="2779"><span class="lineNum">    2779 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2780 </span>                :            : 
<span class="lineNum">    2781 </span>                :<span class="lineNoCov">          0 : void sentinelFailoverDetectEnd(sentinelRedisInstance *master) {</span>
<span class="lineNum">    2782 </span>                :<span class="lineNoCov">          0 :     int not_reconfigured = 0, timeout = 0;</span>
<span class="lineNum">    2783 </span>                :            :     dictIterator *di;
<span class="lineNum">    2784 </span>                :            :     dictEntry *de;
<span class="lineNum">    2785 </span>                :<span class="lineNoCov">          0 :     mstime_t elapsed = mstime() - master-&gt;failover_state_change_time;</span>
<span class="lineNum">    2786 </span>                :            : 
<span class="lineNum">    2787 </span>                :            :     /* We can't consider failover finished if the promoted slave is
<span class="lineNum">    2788 </span>                :            :      * not reachable. */
<span class="lineNum">    2789 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (master-&gt;promoted_slave == NULL ||</span>
<span class="lineNum">    2790 </span>                :<span class="lineNoCov">          0 :         master-&gt;promoted_slave-&gt;flags &amp; SRI_S_DOWN) return;</span>
<span class="lineNum">    2791 </span>                :            : 
<span class="lineNum">    2792 </span>                :            :     /* The failover terminates once all the reachable slaves are properly
<span class="lineNum">    2793 </span>                :            :      * configured. */
<span class="lineNum">    2794 </span>                :<span class="lineNoCov">          0 :     di = dictGetIterator(master-&gt;slaves);</span>
<span class="lineNum">    2795 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    2796 </span>                :<span class="lineNoCov">          0 :         sentinelRedisInstance *slave = dictGetVal(de);</span>
<span class="lineNum">    2797 </span>                :            : 
<span class="lineNum">    2798 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (slave-&gt;flags &amp; (SRI_PROMOTED|SRI_RECONF_DONE)) continue;</span>
<span class="lineNum">    2799 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (slave-&gt;flags &amp; SRI_S_DOWN) continue;</span>
<span class="lineNum">    2800 </span>                :<span class="lineNoCov">          0 :         not_reconfigured++;</span>
<span class="lineNum">    2801 </span>                :            :     }
<span class="lineNum">    2802 </span>                :<span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    2803 </span>                :            : 
<span class="lineNum">    2804 </span>                :            :     /* Force end of failover on timeout. */
<span class="lineNum">    2805 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (elapsed &gt; master-&gt;failover_timeout) {</span>
<span class="lineNum">    2806 </span>                :<span class="lineNoCov">          0 :         not_reconfigured = 0;</span>
<span class="lineNum">    2807 </span>                :<span class="lineNoCov">          0 :         timeout = 1;</span>
<span class="lineNum">    2808 </span>                :<span class="lineNoCov">          0 :         sentinelEvent(REDIS_WARNING,&quot;+failover-end-for-timeout&quot;,master,&quot;%@&quot;);</span>
<span class="lineNum">    2809 </span>                :            :     }
<span class="lineNum">    2810 </span>                :            : 
<span class="lineNum">    2811 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (not_reconfigured == 0) {</span>
<span class="lineNum">    2812 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         int role = (master-&gt;flags &amp; SRI_I_AM_THE_LEADER) ? SENTINEL_LEADER :</span>
<span class="lineNum">    2813 </span>                :            :                                                            SENTINEL_OBSERVER;
<span class="lineNum">    2814 </span>                :            : 
<span class="lineNum">    2815 </span>                :<span class="lineNoCov">          0 :         sentinelEvent(REDIS_WARNING,&quot;+failover-end&quot;,master,&quot;%@&quot;);</span>
<span class="lineNum">    2816 </span>                :<span class="lineNoCov">          0 :         master-&gt;failover_state = SENTINEL_FAILOVER_STATE_UPDATE_CONFIG;</span>
<span class="lineNum">    2817 </span>                :<span class="lineNoCov">          0 :         master-&gt;failover_state_change_time = mstime();</span>
<span class="lineNum">    2818 </span>                :<span class="lineNoCov">          0 :         sentinelCallClientReconfScript(master,role,&quot;end&quot;,master-&gt;addr,</span>
<span class="lineNum">    2819 </span>                :<span class="lineNoCov">          0 :             master-&gt;promoted_slave-&gt;addr);</span>
<span class="lineNum">    2820 </span>                :            :     }
<span class="lineNum">    2821 </span>                :            : 
<span class="lineNum">    2822 </span>                :            :     /* If I'm the leader it is a good idea to send a best effort SLAVEOF
<span class="lineNum">    2823 </span>                :            :      * command to all the slaves still not reconfigured to replicate with
<span class="lineNum">    2824 </span>                :            :      * the new master. */
<span class="lineNum">    2825 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (timeout &amp;&amp; (master-&gt;flags &amp; SRI_I_AM_THE_LEADER)) {</span>
<span class="lineNum">    2826 </span>                :            :         dictIterator *di;
<span class="lineNum">    2827 </span>                :            :         dictEntry *de;
<span class="lineNum">    2828 </span>                :            :         char master_port[32];
<span class="lineNum">    2829 </span>                :            : 
<span class="lineNum">    2830 </span>                :<span class="lineNoCov">          0 :         ll2string(master_port,sizeof(master_port),</span>
<span class="lineNum">    2831 </span>                :<span class="lineNoCov">          0 :             master-&gt;promoted_slave-&gt;addr-&gt;port);</span>
<span class="lineNum">    2832 </span>                :            : 
<span class="lineNum">    2833 </span>                :<span class="lineNoCov">          0 :         di = dictGetIterator(master-&gt;slaves);</span>
<span class="lineNum">    2834 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    2835 </span>                :<span class="lineNoCov">          0 :             sentinelRedisInstance *slave = dictGetVal(de);</span>
<span class="lineNum">    2836 </span>                :            :             int retval;
<span class="lineNum">    2837 </span>                :            : 
<span class="lineNum">    2838 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (slave-&gt;flags &amp;</span>
<span class="lineNum">    2839 </span>                :<span class="lineNoCov">          0 :                 (SRI_RECONF_DONE|SRI_RECONF_SENT|SRI_DISCONNECTED)) continue;</span>
<span class="lineNum">    2840 </span>                :            : 
<span class="lineNum">    2841 </span>                :<span class="lineNoCov">          0 :             retval = redisAsyncCommand(slave-&gt;cc,</span>
<span class="lineNum">    2842 </span>                :            :                 sentinelDiscardReplyCallback, NULL, &quot;SLAVEOF %s %s&quot;,
<span class="lineNum">    2843 </span>                :<span class="lineNoCov">          0 :                     master-&gt;promoted_slave-&gt;addr-&gt;ip,</span>
<span class="lineNum">    2844 </span>                :            :                     master_port);
<span class="lineNum">    2845 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (retval == REDIS_OK) {</span>
<span class="lineNum">    2846 </span>                :<span class="lineNoCov">          0 :                 sentinelEvent(REDIS_NOTICE,&quot;+slave-reconf-sent-be&quot;,slave,&quot;%@&quot;);</span>
<span class="lineNum">    2847 </span>                :<span class="lineNoCov">          0 :                 slave-&gt;flags |= SRI_RECONF_SENT;</span>
<span class="lineNum">    2848 </span>                :            :             }
<span class="lineNum">    2849 </span>                :            :         }
<span class="lineNum">    2850 </span>                :<span class="lineNoCov">          0 :         dictReleaseIterator(di);</span>
<span class="lineNum">    2851 </span>                :            :     }
<span class="lineNum">    2852 </span>                :            : }
<span class="lineNum">    2853 </span>                :            : 
<a name="2854"><span class="lineNum">    2854 </span>                :            : /* Send SLAVE OF &lt;new master address&gt; to all the remaining slaves that</a>
<span class="lineNum">    2855 </span>                :            :  * still don't appear to have the configuration updated. */
<span class="lineNum">    2856 </span>                :<span class="lineNoCov">          0 : void sentinelFailoverReconfNextSlave(sentinelRedisInstance *master) {</span>
<span class="lineNum">    2857 </span>                :            :     dictIterator *di;
<span class="lineNum">    2858 </span>                :            :     dictEntry *de;
<span class="lineNum">    2859 </span>                :<span class="lineNoCov">          0 :     int in_progress = 0;</span>
<span class="lineNum">    2860 </span>                :            : 
<span class="lineNum">    2861 </span>                :<span class="lineNoCov">          0 :     di = dictGetIterator(master-&gt;slaves);</span>
<span class="lineNum">    2862 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    2863 </span>                :<span class="lineNoCov">          0 :         sentinelRedisInstance *slave = dictGetVal(de);</span>
<span class="lineNum">    2864 </span>                :            : 
<span class="lineNum">    2865 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (slave-&gt;flags &amp; (SRI_RECONF_SENT|SRI_RECONF_INPROG))</span>
<span class="lineNum">    2866 </span>                :<span class="lineNoCov">          0 :             in_progress++;</span>
<span class="lineNum">    2867 </span>                :            :     }
<span class="lineNum">    2868 </span>                :<span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    2869 </span>                :            : 
<span class="lineNum">    2870 </span>                :<span class="lineNoCov">          0 :     di = dictGetIterator(master-&gt;slaves);</span>
<span class="lineNum">    2871 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while(in_progress &lt; master-&gt;parallel_syncs &amp;&amp;</span>
<span class="lineNum">    2872 </span>                :            :           (de = dictNext(di)) != NULL)
<span class="lineNum">    2873 </span>                :            :     {
<span class="lineNum">    2874 </span>                :<span class="lineNoCov">          0 :         sentinelRedisInstance *slave = dictGetVal(de);</span>
<span class="lineNum">    2875 </span>                :            :         int retval;
<span class="lineNum">    2876 </span>                :            :         char master_port[32];
<span class="lineNum">    2877 </span>                :            : 
<span class="lineNum">    2878 </span>                :            :         /* Skip the promoted slave, and already configured slaves. */
<span class="lineNum">    2879 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (slave-&gt;flags &amp; (SRI_PROMOTED|SRI_RECONF_DONE)) continue;</span>
<span class="lineNum">    2880 </span>                :            : 
<span class="lineNum">    2881 </span>                :            :         /* Clear the SRI_RECONF_SENT flag if too much time elapsed without
<span class="lineNum">    2882 </span>                :            :          * the slave moving forward to the next state. */
<span class="lineNum">    2883 </span>  [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ((slave-&gt;flags &amp; SRI_RECONF_SENT) &amp;&amp;</span>
<span class="lineNum">    2884 </span>                :<span class="lineNoCov">          0 :             (mstime() - slave-&gt;slave_reconf_sent_time) &gt;</span>
<span class="lineNum">    2885 </span>                :            :             SENTINEL_SLAVE_RECONF_RETRY_PERIOD)
<span class="lineNum">    2886 </span>                :            :         {
<span class="lineNum">    2887 </span>                :<span class="lineNoCov">          0 :             sentinelEvent(REDIS_NOTICE,&quot;-slave-reconf-sent-timeout&quot;,slave,&quot;%@&quot;);</span>
<span class="lineNum">    2888 </span>                :<span class="lineNoCov">          0 :             slave-&gt;flags &amp;= ~SRI_RECONF_SENT;</span>
<span class="lineNum">    2889 </span>                :            :         }
<span class="lineNum">    2890 </span>                :            : 
<span class="lineNum">    2891 </span>                :            :         /* Nothing to do for instances that are disconnected or already
<span class="lineNum">    2892 </span>                :            :          * in RECONF_SENT state. */
<span class="lineNum">    2893 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (slave-&gt;flags &amp; (SRI_DISCONNECTED|SRI_RECONF_SENT|SRI_RECONF_INPROG))</span>
<span class="lineNum">    2894 </span>                :<span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    2895 </span>                :            : 
<span class="lineNum">    2896 </span>                :            :         /* Send SLAVEOF &lt;new master&gt;. */
<span class="lineNum">    2897 </span>                :<span class="lineNoCov">          0 :         ll2string(master_port,sizeof(master_port),</span>
<span class="lineNum">    2898 </span>                :<span class="lineNoCov">          0 :             master-&gt;promoted_slave-&gt;addr-&gt;port);</span>
<span class="lineNum">    2899 </span>                :<span class="lineNoCov">          0 :         retval = redisAsyncCommand(slave-&gt;cc,</span>
<span class="lineNum">    2900 </span>                :            :             sentinelDiscardReplyCallback, NULL, &quot;SLAVEOF %s %s&quot;,
<span class="lineNum">    2901 </span>                :<span class="lineNoCov">          0 :                 master-&gt;promoted_slave-&gt;addr-&gt;ip,</span>
<span class="lineNum">    2902 </span>                :            :                 master_port);
<span class="lineNum">    2903 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (retval == REDIS_OK) {</span>
<span class="lineNum">    2904 </span>                :<span class="lineNoCov">          0 :             slave-&gt;flags |= SRI_RECONF_SENT;</span>
<span class="lineNum">    2905 </span>                :<span class="lineNoCov">          0 :             slave-&gt;pending_commands++;</span>
<span class="lineNum">    2906 </span>                :<span class="lineNoCov">          0 :             slave-&gt;slave_reconf_sent_time = mstime();</span>
<span class="lineNum">    2907 </span>                :<span class="lineNoCov">          0 :             sentinelEvent(REDIS_NOTICE,&quot;+slave-reconf-sent&quot;,slave,&quot;%@&quot;);</span>
<span class="lineNum">    2908 </span>                :<span class="lineNoCov">          0 :             in_progress++;</span>
<span class="lineNum">    2909 </span>                :            :         }
<span class="lineNum">    2910 </span>                :            :     }
<span class="lineNum">    2911 </span>                :<span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    2912 </span>                :<span class="lineNoCov">          0 :     sentinelFailoverDetectEnd(master);</span>
<span class="lineNum">    2913 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2914 </span>                :            : 
<span class="lineNum">    2915 </span>                :            : /* This function is called when the slave is in
<span class="lineNum">    2916 </span>                :            :  * SENTINEL_FAILOVER_STATE_UPDATE_CONFIG state. In this state we need
<span class="lineNum">    2917 </span>                :            :  * to remove it from the master table and add the promoted slave instead.
<span class="lineNum">    2918 </span>                :            :  *
<span class="lineNum">    2919 </span>                :            :  * If there are no promoted slaves as this instance is unique, we remove
<a name="2920"><span class="lineNum">    2920 </span>                :            :  * and re-add it with the same address to trigger a complete state</a>
<span class="lineNum">    2921 </span>                :            :  * refresh. */
<span class="lineNum">    2922 </span>                :<span class="lineNoCov">          0 : void sentinelFailoverSwitchToPromotedSlave(sentinelRedisInstance *master) {</span>
<span class="lineNum">    2923 </span>                :<span class="lineNoCov">          0 :     sentinelRedisInstance *ref = master-&gt;promoted_slave ?</span>
<span class="lineNum">    2924 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                  master-&gt;promoted_slave : master;</span>
<span class="lineNum">    2925 </span>                :            :     sds old_master_ip;
<span class="lineNum">    2926 </span>                :            :     int old_master_port;
<span class="lineNum">    2927 </span>                :            : 
<span class="lineNum">    2928 </span>                :<span class="lineNoCov">          0 :     sentinelEvent(REDIS_WARNING,&quot;+switch-master&quot;,master,&quot;%s %s %d %s %d&quot;,</span>
<span class="lineNum">    2929 </span>                :<span class="lineNoCov">          0 :         master-&gt;name, master-&gt;addr-&gt;ip, master-&gt;addr-&gt;port,</span>
<span class="lineNum">    2930 </span>                :<span class="lineNoCov">          0 :         ref-&gt;addr-&gt;ip, ref-&gt;addr-&gt;port);</span>
<span class="lineNum">    2931 </span>                :            : 
<span class="lineNum">    2932 </span>                :<span class="lineNoCov">          0 :     old_master_ip = sdsdup(master-&gt;addr-&gt;ip);</span>
<span class="lineNum">    2933 </span>                :<span class="lineNoCov">          0 :     old_master_port = master-&gt;addr-&gt;port;</span>
<span class="lineNum">    2934 </span>                :<span class="lineNoCov">          0 :     sentinelResetMasterAndChangeAddress(master,ref-&gt;addr-&gt;ip,ref-&gt;addr-&gt;port);</span>
<span class="lineNum">    2935 </span>                :            :     /* If this is a real switch, that is, we have master-&gt;promoted_slave not
<span class="lineNum">    2936 </span>                :            :      * NULL, then we want to add the old master as a slave of the new master,
<span class="lineNum">    2937 </span>                :            :      * but flagging it with SRI_DEMOTE so that we know we'll need to send
<span class="lineNum">    2938 </span>                :            :      * SLAVEOF once the old master is reachable again. */
<span class="lineNum">    2939 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (master != ref) {</span>
<span class="lineNum">    2940 </span>                :            :         /* Add the new slave, but don't generate a Sentinel event as it will
<span class="lineNum">    2941 </span>                :            :          * happen later when finally the instance will claim to be a slave
<span class="lineNum">    2942 </span>                :            :          * in the INFO output. */
<span class="lineNum">    2943 </span>                :<span class="lineNoCov">          0 :         createSentinelRedisInstance(NULL,SRI_SLAVE|SRI_DEMOTE,</span>
<span class="lineNum">    2944 </span>                :            :                     old_master_ip, old_master_port, master-&gt;quorum, master);
<span class="lineNum">    2945 </span>                :            :     }
<span class="lineNum">    2946 </span>                :<span class="lineNoCov">          0 :     sdsfree(old_master_ip);</span>
<a name="2947"><span class="lineNum">    2947 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2948 </span>                :            : 
<span class="lineNum">    2949 </span>                :<span class="lineNoCov">          0 : void sentinelFailoverStateMachine(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    2950 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     redisAssert(ri-&gt;flags &amp; SRI_MASTER);</span>
<span class="lineNum">    2951 </span>                :            : 
<span class="lineNum">    2952 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!(ri-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS)) return;</span>
<span class="lineNum">    2953 </span>                :            : 
<span class="lineNum">    2954 </span>  [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span> :<span class="lineNoCov">          0 :     switch(ri-&gt;failover_state) {</span>
<span class="lineNum">         </span>      <span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]
<span class="lineNum">    2955 </span>                :            :         case SENTINEL_FAILOVER_STATE_WAIT_START:
<span class="lineNum">    2956 </span>                :<span class="lineNoCov">          0 :             sentinelFailoverWaitStart(ri);</span>
<span class="lineNum">    2957 </span>                :<span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    2958 </span>                :            :         case SENTINEL_FAILOVER_STATE_SELECT_SLAVE:
<span class="lineNum">    2959 </span>                :<span class="lineNoCov">          0 :             sentinelFailoverSelectSlave(ri);</span>
<span class="lineNum">    2960 </span>                :<span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    2961 </span>                :            :         case SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE:
<span class="lineNum">    2962 </span>                :<span class="lineNoCov">          0 :             sentinelFailoverSendSlaveOfNoOne(ri);</span>
<span class="lineNum">    2963 </span>                :<span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    2964 </span>                :            :         case SENTINEL_FAILOVER_STATE_WAIT_PROMOTION:
<span class="lineNum">    2965 </span>                :<span class="lineNoCov">          0 :             sentinelFailoverWaitPromotion(ri);</span>
<span class="lineNum">    2966 </span>                :<span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    2967 </span>                :            :         case SENTINEL_FAILOVER_STATE_RECONF_SLAVES:
<span class="lineNum">    2968 </span>                :<span class="lineNoCov">          0 :             sentinelFailoverReconfNextSlave(ri);</span>
<span class="lineNum">    2969 </span>                :<span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    2970 </span>                :            :         case SENTINEL_FAILOVER_STATE_DETECT_END:
<span class="lineNum">    2971 </span>                :<span class="lineNoCov">          0 :             sentinelFailoverDetectEnd(ri);</span>
<span class="lineNum">    2972 </span>                :<span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    2973 </span>                :            :     }
<span class="lineNum">    2974 </span>                :            : }
<span class="lineNum">    2975 </span>                :            : 
<span class="lineNum">    2976 </span>                :            : /* Abort a failover in progress with the following steps:
<span class="lineNum">    2977 </span>                :            :  * 1) If this instance is the leaer send a SLAVEOF command to all the already
<span class="lineNum">    2978 </span>                :            :  *    reconfigured slaves if any to configure them to replicate with the
<span class="lineNum">    2979 </span>                :            :  *    original master.
<span class="lineNum">    2980 </span>                :            :  * 2) For both leaders and observers: clear the failover flags and state in
<span class="lineNum">    2981 </span>                :            :  *    the master instance.
<span class="lineNum">    2982 </span>                :            :  * 3) If there is already a promoted slave and we are the leader, and this
<span class="lineNum">    2983 </span>                :            :  *    slave is not DISCONNECTED, try to reconfigure it to replicate
<a name="2984"><span class="lineNum">    2984 </span>                :            :  *    back to the master as well, sending a best effort SLAVEOF command.</a>
<span class="lineNum">    2985 </span>                :            :  */
<span class="lineNum">    2986 </span>                :<span class="lineNoCov">          0 : void sentinelAbortFailover(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    2987 </span>                :            :     char master_port[32];
<span class="lineNum">    2988 </span>                :            :     dictIterator *di;
<span class="lineNum">    2989 </span>                :            :     dictEntry *de;
<span class="lineNum">    2990 </span>                :            :     int sentinel_role;
<span class="lineNum">    2991 </span>                :            : 
<span class="lineNum">    2992 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     redisAssert(ri-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS);</span>
<span class="lineNum">    2993 </span>                :<span class="lineNoCov">          0 :     ll2string(master_port,sizeof(master_port),ri-&gt;addr-&gt;port);</span>
<span class="lineNum">    2994 </span>                :            : 
<span class="lineNum">    2995 </span>                :            :     /* Clear failover related flags from slaves.
<span class="lineNum">    2996 </span>                :            :      * Also if we are the leader make sure to send SLAVEOF commands to all the
<span class="lineNum">    2997 </span>                :            :      * already reconfigured slaves in order to turn them back into slaves of
<span class="lineNum">    2998 </span>                :            :      * the original master. */
<span class="lineNum">    2999 </span>                :<span class="lineNoCov">          0 :     di = dictGetIterator(ri-&gt;slaves);</span>
<span class="lineNum">    3000 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    3001 </span>                :<span class="lineNoCov">          0 :         sentinelRedisInstance *slave = dictGetVal(de);</span>
<span class="lineNum">    3002 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ((ri-&gt;flags &amp; SRI_I_AM_THE_LEADER) &amp;&amp;</span>
<span class="lineNum">    3003 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             !(slave-&gt;flags &amp; SRI_DISCONNECTED) &amp;&amp;</span>
<span class="lineNum">    3004 </span>                :<span class="lineNoCov">          0 :              (slave-&gt;flags &amp; (SRI_PROMOTED|SRI_RECONF_SENT|SRI_RECONF_INPROG|</span>
<span class="lineNum">    3005 </span>                :            :                               SRI_RECONF_DONE)))
<span class="lineNum">    3006 </span>                :            :         {
<span class="lineNum">    3007 </span>                :            :             int retval;
<span class="lineNum">    3008 </span>                :            : 
<span class="lineNum">    3009 </span>                :<span class="lineNoCov">          0 :             retval = redisAsyncCommand(slave-&gt;cc,</span>
<span class="lineNum">    3010 </span>                :            :                 sentinelDiscardReplyCallback, NULL, &quot;SLAVEOF %s %s&quot;,
<span class="lineNum">    3011 </span>                :<span class="lineNoCov">          0 :                     ri-&gt;addr-&gt;ip,</span>
<span class="lineNum">    3012 </span>                :            :                     master_port);
<span class="lineNum">    3013 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (retval == REDIS_OK)</span>
<span class="lineNum">    3014 </span>                :<span class="lineNoCov">          0 :                 sentinelEvent(REDIS_NOTICE,&quot;-slave-reconf-undo&quot;,slave,&quot;%@&quot;);</span>
<span class="lineNum">    3015 </span>                :            :         }
<span class="lineNum">    3016 </span>                :<span class="lineNoCov">          0 :         slave-&gt;flags &amp;= ~(SRI_RECONF_SENT|SRI_RECONF_INPROG|SRI_RECONF_DONE);</span>
<span class="lineNum">    3017 </span>                :            :     }
<span class="lineNum">    3018 </span>                :<span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    3019 </span>                :            : 
<span class="lineNum">    3020 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     sentinel_role = (ri-&gt;flags &amp; SRI_I_AM_THE_LEADER) ? SENTINEL_LEADER :</span>
<span class="lineNum">    3021 </span>                :            :                                                         SENTINEL_OBSERVER;
<span class="lineNum">    3022 </span>                :<span class="lineNoCov">          0 :     ri-&gt;flags &amp;= ~(SRI_FAILOVER_IN_PROGRESS|SRI_I_AM_THE_LEADER|SRI_FORCE_FAILOVER);</span>
<span class="lineNum">    3023 </span>                :<span class="lineNoCov">          0 :     ri-&gt;failover_state = SENTINEL_FAILOVER_STATE_NONE;</span>
<span class="lineNum">    3024 </span>                :<span class="lineNoCov">          0 :     ri-&gt;failover_state_change_time = mstime();</span>
<span class="lineNum">    3025 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;promoted_slave) {</span>
<span class="lineNum">    3026 </span>                :<span class="lineNoCov">          0 :         sentinelCallClientReconfScript(ri,sentinel_role,&quot;abort&quot;,</span>
<span class="lineNum">    3027 </span>                :<span class="lineNoCov">          0 :             ri-&gt;promoted_slave-&gt;addr,ri-&gt;addr);</span>
<span class="lineNum">    3028 </span>                :<span class="lineNoCov">          0 :         ri-&gt;promoted_slave-&gt;flags &amp;= ~SRI_PROMOTED;</span>
<span class="lineNum">    3029 </span>                :<span class="lineNoCov">          0 :         ri-&gt;promoted_slave = NULL;</span>
<span class="lineNum">    3030 </span>                :            :     }
<span class="lineNum">    3031 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3032 </span>                :            : 
<span class="lineNum">    3033 </span>                :            : /* The following is called only for master instances and will abort the
<span class="lineNum">    3034 </span>                :            :  * failover process if:
<span class="lineNum">    3035 </span>                :            :  *
<span class="lineNum">    3036 </span>                :            :  * 1) The failover is in progress.
<span class="lineNum">    3037 </span>                :            :  * 2) We already promoted a slave.
<a name="3038"><span class="lineNum">    3038 </span>                :            :  * 3) The promoted slave is in extended SDOWN condition.</a>
<span class="lineNum">    3039 </span>                :            :  */
<span class="lineNum">    3040 </span>                :<span class="lineNoCov">          0 : void sentinelAbortFailoverIfNeeded(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    3041 </span>                :            :     /* Failover is in progress? Do we have a promoted slave? */
<span class="lineNum">    3042 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!(ri-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) || !ri-&gt;promoted_slave) return;</span>
<span class="lineNum">    3043 </span>                :            : 
<span class="lineNum">    3044 </span>                :            :     /* Is the promoted slave into an extended SDOWN state? */
<span class="lineNum">    3045 </span>  [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!(ri-&gt;promoted_slave-&gt;flags &amp; SRI_S_DOWN) ||</span>
<span class="lineNum">    3046 </span>                :<span class="lineNoCov">          0 :         (mstime() - ri-&gt;promoted_slave-&gt;s_down_since_time) &lt;</span>
<span class="lineNum">    3047 </span>                :<span class="lineNoCov">          0 :         (ri-&gt;down_after_period * SENTINEL_EXTENDED_SDOWN_MULTIPLIER)) return;</span>
<span class="lineNum">    3048 </span>                :            : 
<span class="lineNum">    3049 </span>                :<span class="lineNoCov">          0 :     sentinelEvent(REDIS_WARNING,&quot;-failover-abort-x-sdown&quot;,ri-&gt;promoted_slave,&quot;%@&quot;);</span>
<span class="lineNum">    3050 </span>                :<span class="lineNoCov">          0 :     sentinelAbortFailover(ri);</span>
<span class="lineNum">    3051 </span>                :            : }
<span class="lineNum">    3052 </span>                :            : 
<span class="lineNum">    3053 </span>                :            : /* ======================== SENTINEL timer handler ==========================
<span class="lineNum">    3054 </span>                :            :  * This is the &quot;main&quot; our Sentinel, being sentinel completely non blocking
<span class="lineNum">    3055 </span>                :            :  * in design. The function is called every second.
<span class="lineNum">    3056 </span>                :            :  * -------------------------------------------------------------------------- */
<a name="3057"><span class="lineNum">    3057 </span>                :            : </a>
<span class="lineNum">    3058 </span>                :            : /* Perform scheduled operations for the specified Redis instance. */
<span class="lineNum">    3059 </span>                :<span class="lineNoCov">          0 : void sentinelHandleRedisInstance(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    3060 </span>                :            :     /* ========== MONITORING HALF ============ */
<span class="lineNum">    3061 </span>                :            :     /* Every kind of instance */
<span class="lineNum">    3062 </span>                :<span class="lineNoCov">          0 :     sentinelReconnectInstance(ri);</span>
<span class="lineNum">    3063 </span>                :<span class="lineNoCov">          0 :     sentinelPingInstance(ri);</span>
<span class="lineNum">    3064 </span>                :            : 
<span class="lineNum">    3065 </span>                :            :     /* Masters and slaves */
<span class="lineNum">    3066 </span>                :            :     if (ri-&gt;flags &amp; (SRI_MASTER|SRI_SLAVE)) {
<span class="lineNum">    3067 </span>                :            :         /* Nothing so far. */
<span class="lineNum">    3068 </span>                :            :     }
<span class="lineNum">    3069 </span>                :            : 
<span class="lineNum">    3070 </span>                :            :     /* Only masters */
<span class="lineNum">    3071 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_MASTER) {</span>
<span class="lineNum">    3072 </span>                :<span class="lineNoCov">          0 :         sentinelAskMasterStateToOtherSentinels(ri);</span>
<span class="lineNum">    3073 </span>                :            :     }
<span class="lineNum">    3074 </span>                :            : 
<span class="lineNum">    3075 </span>                :            :     /* ============== ACTING HALF ============= */
<span class="lineNum">    3076 </span>                :            :     /* We don't proceed with the acting half if we are in TILT mode.
<span class="lineNum">    3077 </span>                :            :      * TILT happens when we find something odd with the time, like a
<span class="lineNum">    3078 </span>                :            :      * sudden change in the clock. */
<span class="lineNum">    3079 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (sentinel.tilt) {</span>
<span class="lineNum">    3080 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (mstime()-sentinel.tilt_start_time &lt; SENTINEL_TILT_PERIOD) return;</span>
<span class="lineNum">    3081 </span>                :<span class="lineNoCov">          0 :         sentinel.tilt = 0;</span>
<span class="lineNum">    3082 </span>                :<span class="lineNoCov">          0 :         sentinelEvent(REDIS_WARNING,&quot;-tilt&quot;,NULL,&quot;#tilt mode exited&quot;);</span>
<span class="lineNum">    3083 </span>                :            :     }
<span class="lineNum">    3084 </span>                :            : 
<span class="lineNum">    3085 </span>                :            :     /* Every kind of instance */
<span class="lineNum">    3086 </span>                :<span class="lineNoCov">          0 :     sentinelCheckSubjectivelyDown(ri);</span>
<span class="lineNum">    3087 </span>                :            : 
<span class="lineNum">    3088 </span>                :            :     /* Masters and slaves */
<span class="lineNum">    3089 </span>                :            :     if (ri-&gt;flags &amp; (SRI_MASTER|SRI_SLAVE)) {
<span class="lineNum">    3090 </span>                :            :         /* Nothing so far. */
<span class="lineNum">    3091 </span>                :            :     }
<span class="lineNum">    3092 </span>                :            : 
<span class="lineNum">    3093 </span>                :            :     /* Only masters */
<span class="lineNum">    3094 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_MASTER) {</span>
<span class="lineNum">    3095 </span>                :<span class="lineNoCov">          0 :         sentinelCheckObjectivelyDown(ri);</span>
<span class="lineNum">    3096 </span>                :<span class="lineNoCov">          0 :         sentinelStartFailoverIfNeeded(ri);</span>
<span class="lineNum">    3097 </span>                :<span class="lineNoCov">          0 :         sentinelFailoverStateMachine(ri);</span>
<span class="lineNum">    3098 </span>                :<span class="lineNoCov">          0 :         sentinelAbortFailoverIfNeeded(ri);</span>
<span class="lineNum">    3099 </span>                :            :     }
<span class="lineNum">    3100 </span>                :            : }
<span class="lineNum">    3101 </span>                :            : 
<a name="3102"><span class="lineNum">    3102 </span>                :            : /* Perform scheduled operations for all the instances in the dictionary.</a>
<span class="lineNum">    3103 </span>                :            :  * Recursively call the function against dictionaries of slaves. */
<span class="lineNum">    3104 </span>                :<span class="lineNoCov">          0 : void sentinelHandleDictOfRedisInstances(dict *instances) {</span>
<span class="lineNum">    3105 </span>                :            :     dictIterator *di;
<span class="lineNum">    3106 </span>                :            :     dictEntry *de;
<span class="lineNum">    3107 </span>                :<span class="lineNoCov">          0 :     sentinelRedisInstance *switch_to_promoted = NULL;</span>
<span class="lineNum">    3108 </span>                :            : 
<span class="lineNum">    3109 </span>                :            :     /* There are a number of things we need to perform against every master. */
<span class="lineNum">    3110 </span>                :<span class="lineNoCov">          0 :     di = dictGetIterator(instances);</span>
<span class="lineNum">    3111 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    3112 </span>                :<span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    3113 </span>                :            : 
<span class="lineNum">    3114 </span>                :<span class="lineNoCov">          0 :         sentinelHandleRedisInstance(ri);</span>
<span class="lineNum">    3115 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ri-&gt;flags &amp; SRI_MASTER) {</span>
<span class="lineNum">    3116 </span>                :<span class="lineNoCov">          0 :             sentinelHandleDictOfRedisInstances(ri-&gt;slaves);</span>
<span class="lineNum">    3117 </span>                :<span class="lineNoCov">          0 :             sentinelHandleDictOfRedisInstances(ri-&gt;sentinels);</span>
<span class="lineNum">    3118 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (ri-&gt;failover_state == SENTINEL_FAILOVER_STATE_UPDATE_CONFIG) {</span>
<span class="lineNum">    3119 </span>                :<span class="lineNoCov">          0 :                 switch_to_promoted = ri;</span>
<span class="lineNum">    3120 </span>                :            :             }
<span class="lineNum">    3121 </span>                :            :         }
<span class="lineNum">    3122 </span>                :            :     }
<span class="lineNum">    3123 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (switch_to_promoted)</span>
<span class="lineNum">    3124 </span>                :<span class="lineNoCov">          0 :         sentinelFailoverSwitchToPromotedSlave(switch_to_promoted);</span>
<span class="lineNum">    3125 </span>                :<span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    3126 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3127 </span>                :            : 
<span class="lineNum">    3128 </span>                :            : /* This function checks if we need to enter the TITL mode.
<span class="lineNum">    3129 </span>                :            :  *
<span class="lineNum">    3130 </span>                :            :  * The TILT mode is entered if we detect that between two invocations of the
<span class="lineNum">    3131 </span>                :            :  * timer interrupt, a negative amount of time, or too much time has passed.
<span class="lineNum">    3132 </span>                :            :  * Note that we expect that more or less just 100 milliseconds will pass
<span class="lineNum">    3133 </span>                :            :  * if everything is fine. However we'll see a negative number or a
<span class="lineNum">    3134 </span>                :            :  * difference bigger than SENTINEL_TILT_TRIGGER milliseconds if one of the
<span class="lineNum">    3135 </span>                :            :  * following conditions happen:
<span class="lineNum">    3136 </span>                :            :  *
<span class="lineNum">    3137 </span>                :            :  * 1) The Sentiel process for some time is blocked, for every kind of
<span class="lineNum">    3138 </span>                :            :  * random reason: the load is huge, the computer was frozen for some time
<span class="lineNum">    3139 </span>                :            :  * in I/O or alike, the process was stopped by a signal. Everything.
<span class="lineNum">    3140 </span>                :            :  * 2) The system clock was altered significantly.
<span class="lineNum">    3141 </span>                :            :  *
<span class="lineNum">    3142 </span>                :            :  * Under both this conditions we'll see everything as timed out and failing
<span class="lineNum">    3143 </span>                :            :  * without good reasons. Instead we enter the TILT mode and wait
<span class="lineNum">    3144 </span>                :            :  * for SENTINEL_TILT_PERIOD to elapse before starting to act again.
<a name="3145"><span class="lineNum">    3145 </span>                :            :  *</a>
<span class="lineNum">    3146 </span>                :            :  * During TILT time we still collect information, we just do not act. */
<span class="lineNum">    3147 </span>                :<span class="lineNoCov">          0 : void sentinelCheckTiltCondition(void) {</span>
<span class="lineNum">    3148 </span>                :<span class="lineNoCov">          0 :     mstime_t now = mstime();</span>
<span class="lineNum">    3149 </span>                :<span class="lineNoCov">          0 :     mstime_t delta = now - sentinel.previous_time;</span>
<span class="lineNum">    3150 </span>                :            : 
<span class="lineNum">    3151 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (delta &lt; 0 || delta &gt; SENTINEL_TILT_TRIGGER) {</span>
<span class="lineNum">    3152 </span>                :<span class="lineNoCov">          0 :         sentinel.tilt = 1;</span>
<span class="lineNum">    3153 </span>                :<span class="lineNoCov">          0 :         sentinel.tilt_start_time = mstime();</span>
<span class="lineNum">    3154 </span>                :<span class="lineNoCov">          0 :         sentinelEvent(REDIS_WARNING,&quot;+tilt&quot;,NULL,&quot;#tilt mode entered&quot;);</span>
<span class="lineNum">    3155 </span>                :            :     }
<span class="lineNum">    3156 </span>                :<span class="lineNoCov">          0 :     sentinel.previous_time = mstime();</span>
<a name="3157"><span class="lineNum">    3157 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    3158 </span>                :            : 
<span class="lineNum">    3159 </span>                :<span class="lineNoCov">          0 : void sentinelTimer(void) {</span>
<span class="lineNum">    3160 </span>                :<span class="lineNoCov">          0 :     sentinelCheckTiltCondition();</span>
<span class="lineNum">    3161 </span>                :<span class="lineNoCov">          0 :     sentinelHandleDictOfRedisInstances(sentinel.masters);</span>
<span class="lineNum">    3162 </span>                :<span class="lineNoCov">          0 :     sentinelRunPendingScripts();</span>
<span class="lineNum">    3163 </span>                :<span class="lineNoCov">          0 :     sentinelCollectTerminatedScripts();</span>
<span class="lineNum">    3164 </span>                :<span class="lineNoCov">          0 :     sentinelKillTimedoutScripts();</span>
<span class="lineNum">    3165 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3166 </span>                :            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.9</a></td></tr>
  </table>
  <br>

</body>
</html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - redis-lcov_9.info - /var/lib/jenkins/jobs/redis-lcov/workspace/src/redis.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../../../index.html">top level</a> - <a href="index.html">var/lib/jenkins/jobs/redis-lcov/workspace/src</a> - redis.c<span style="font-size: 80%;"> (source / <a href="redis.c.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">redis-lcov_9.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1065</td>
            <td class="headerCovTableEntry">1302</td>
            <td class="headerCovTableEntryMed">81.8 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2013-08-26</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">61</td>
            <td class="headerCovTableEntry">76</td>
            <td class="headerCovTableEntryMed">80.3 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
            | Branches:
            <span class="coverLegendCov">+</span> taken
            <span class="coverLegendNoCov">-</span> not taken
            <span class="coverLegendNoCov">#</span> not executed
</td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">539</td>
            <td class="headerCovTableEntry">823</td>
            <td class="headerCovTableEntryLo">65.5 %</td>
          </tr>
          <tr><td><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : /*</a>
<span class="lineNum">       2 </span>                :            :  * Copyright (c) 2009-2012, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;
<span class="lineNum">       3 </span>                :            :  * All rights reserved.
<span class="lineNum">       4 </span>                :            :  *
<span class="lineNum">       5 </span>                :            :  * Redistribution and use in source and binary forms, with or without
<span class="lineNum">       6 </span>                :            :  * modification, are permitted provided that the following conditions are met:
<span class="lineNum">       7 </span>                :            :  *
<span class="lineNum">       8 </span>                :            :  *   * Redistributions of source code must retain the above copyright notice,
<span class="lineNum">       9 </span>                :            :  *     this list of conditions and the following disclaimer.
<span class="lineNum">      10 </span>                :            :  *   * Redistributions in binary form must reproduce the above copyright
<span class="lineNum">      11 </span>                :            :  *     notice, this list of conditions and the following disclaimer in the
<span class="lineNum">      12 </span>                :            :  *     documentation and/or other materials provided with the distribution.
<span class="lineNum">      13 </span>                :            :  *   * Neither the name of Redis nor the names of its contributors may be used
<span class="lineNum">      14 </span>                :            :  *     to endorse or promote products derived from this software without
<span class="lineNum">      15 </span>                :            :  *     specific prior written permission.
<span class="lineNum">      16 </span>                :            :  *
<span class="lineNum">      17 </span>                :            :  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;
<span class="lineNum">      18 </span>                :            :  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
<span class="lineNum">      19 </span>                :            :  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
<span class="lineNum">      20 </span>                :            :  * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
<span class="lineNum">      21 </span>                :            :  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
<span class="lineNum">      22 </span>                :            :  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
<span class="lineNum">      23 </span>                :            :  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
<span class="lineNum">      24 </span>                :            :  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
<span class="lineNum">      25 </span>                :            :  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
<span class="lineNum">      26 </span>                :            :  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
<span class="lineNum">      27 </span>                :            :  * POSSIBILITY OF SUCH DAMAGE.
<span class="lineNum">      28 </span>                :            :  */
<span class="lineNum">      29 </span>                :            : 
<span class="lineNum">      30 </span>                :            : #include &quot;redis.h&quot;
<span class="lineNum">      31 </span>                :            : #include &quot;slowlog.h&quot;
<span class="lineNum">      32 </span>                :            : #include &quot;bio.h&quot;
<span class="lineNum">      33 </span>                :            : 
<span class="lineNum">      34 </span>                :            : #include &lt;time.h&gt;
<span class="lineNum">      35 </span>                :            : #include &lt;signal.h&gt;
<span class="lineNum">      36 </span>                :            : #include &lt;sys/wait.h&gt;
<span class="lineNum">      37 </span>                :            : #include &lt;errno.h&gt;
<span class="lineNum">      38 </span>                :            : #include &lt;assert.h&gt;
<span class="lineNum">      39 </span>                :            : #include &lt;ctype.h&gt;
<span class="lineNum">      40 </span>                :            : #include &lt;stdarg.h&gt;
<span class="lineNum">      41 </span>                :            : #include &lt;arpa/inet.h&gt;
<span class="lineNum">      42 </span>                :            : #include &lt;sys/stat.h&gt;
<span class="lineNum">      43 </span>                :            : #include &lt;fcntl.h&gt;
<span class="lineNum">      44 </span>                :            : #include &lt;sys/time.h&gt;
<span class="lineNum">      45 </span>                :            : #include &lt;sys/resource.h&gt;
<span class="lineNum">      46 </span>                :            : #include &lt;sys/uio.h&gt;
<span class="lineNum">      47 </span>                :            : #include &lt;limits.h&gt;
<span class="lineNum">      48 </span>                :            : #include &lt;float.h&gt;
<span class="lineNum">      49 </span>                :            : #include &lt;math.h&gt;
<span class="lineNum">      50 </span>                :            : #include &lt;sys/resource.h&gt;
<span class="lineNum">      51 </span>                :            : #include &lt;sys/utsname.h&gt;
<span class="lineNum">      52 </span>                :            : #include &lt;locale.h&gt;
<span class="lineNum">      53 </span>                :            : 
<span class="lineNum">      54 </span>                :            : /* Our shared &quot;common&quot; objects */
<span class="lineNum">      55 </span>                :            : 
<span class="lineNum">      56 </span>                :            : struct sharedObjectsStruct shared;
<span class="lineNum">      57 </span>                :            : 
<span class="lineNum">      58 </span>                :            : /* Global vars that are actually used as constants. The following double
<span class="lineNum">      59 </span>                :            :  * values are used for double on-disk serialization, and are initialized
<span class="lineNum">      60 </span>                :            :  * at runtime to avoid strange compiler optimizations. */
<span class="lineNum">      61 </span>                :            : 
<span class="lineNum">      62 </span>                :            : double R_Zero, R_PosInf, R_NegInf, R_Nan;
<span class="lineNum">      63 </span>                :            : 
<span class="lineNum">      64 </span>                :            : /*================================= Globals ================================= */
<span class="lineNum">      65 </span>                :            : 
<span class="lineNum">      66 </span>                :            : /* Global vars */
<span class="lineNum">      67 </span>                :            : struct redisServer server; /* server global state */
<span class="lineNum">      68 </span>                :            : struct redisCommand *commandTable;
<span class="lineNum">      69 </span>                :            : 
<span class="lineNum">      70 </span>                :            : /* Our command table.
<span class="lineNum">      71 </span>                :            :  *
<span class="lineNum">      72 </span>                :            :  * Every entry is composed of the following fields:
<span class="lineNum">      73 </span>                :            :  *
<span class="lineNum">      74 </span>                :            :  * name: a string representing the command name.
<span class="lineNum">      75 </span>                :            :  * function: pointer to the C function implementing the command.
<span class="lineNum">      76 </span>                :            :  * arity: number of arguments, it is possible to use -N to say &gt;= N
<span class="lineNum">      77 </span>                :            :  * sflags: command flags as string. See below for a table of flags.
<span class="lineNum">      78 </span>                :            :  * flags: flags as bitmask. Computed by Redis using the 'sflags' field.
<span class="lineNum">      79 </span>                :            :  * get_keys_proc: an optional function to get key arguments from a command.
<span class="lineNum">      80 </span>                :            :  *                This is only used when the following three fields are not
<span class="lineNum">      81 </span>                :            :  *                enough to specify what arguments are keys.
<span class="lineNum">      82 </span>                :            :  * first_key_index: first argument that is a key
<span class="lineNum">      83 </span>                :            :  * last_key_index: last argument that is a key
<span class="lineNum">      84 </span>                :            :  * key_step: step to get all the keys from first to last argument. For instance
<span class="lineNum">      85 </span>                :            :  *           in MSET the step is two since arguments are key,val,key,val,...
<span class="lineNum">      86 </span>                :            :  * microseconds: microseconds of total execution time for this command.
<span class="lineNum">      87 </span>                :            :  * calls: total number of calls of this command.
<span class="lineNum">      88 </span>                :            :  *
<span class="lineNum">      89 </span>                :            :  * The flags, microseconds and calls fields are computed by Redis and should
<span class="lineNum">      90 </span>                :            :  * always be set to zero.
<span class="lineNum">      91 </span>                :            :  *
<span class="lineNum">      92 </span>                :            :  * Command flags are expressed using strings where every character represents
<span class="lineNum">      93 </span>                :            :  * a flag. Later the populateCommandTable() function will take care of
<span class="lineNum">      94 </span>                :            :  * populating the real 'flags' field using this characters.
<span class="lineNum">      95 </span>                :            :  *
<span class="lineNum">      96 </span>                :            :  * This is the meaning of the flags:
<span class="lineNum">      97 </span>                :            :  *
<span class="lineNum">      98 </span>                :            :  * w: write command (may modify the key space).
<span class="lineNum">      99 </span>                :            :  * r: read command  (will never modify the key space).
<span class="lineNum">     100 </span>                :            :  * m: may increase memory usage once called. Don't allow if out of memory.
<span class="lineNum">     101 </span>                :            :  * a: admin command, like SAVE or SHUTDOWN.
<span class="lineNum">     102 </span>                :            :  * p: Pub/Sub related command.
<span class="lineNum">     103 </span>                :            :  * f: force replication of this command, regardless of server.dirty.
<span class="lineNum">     104 </span>                :            :  * s: command not allowed in scripts.
<span class="lineNum">     105 </span>                :            :  * R: random command. Command is not deterministic, that is, the same command
<span class="lineNum">     106 </span>                :            :  *    with the same arguments, with the same key space, may have different
<span class="lineNum">     107 </span>                :            :  *    results. For instance SPOP and RANDOMKEY are two random commands.
<span class="lineNum">     108 </span>                :            :  * S: Sort command output array if called from script, so that the output
<span class="lineNum">     109 </span>                :            :  *    is deterministic.
<span class="lineNum">     110 </span>                :            :  * l: Allow command while loading the database.
<span class="lineNum">     111 </span>                :            :  * t: Allow command while a slave has stale data but is not allowed to
<span class="lineNum">     112 </span>                :            :  *    server this data. Normally no command is accepted in this condition
<span class="lineNum">     113 </span>                :            :  *    but just a few.
<span class="lineNum">     114 </span>                :            :  * M: Do not automatically propagate the command on MONITOR.
<span class="lineNum">     115 </span>                :            :  * k: Perform an implicit ASKING for this command, so the command will be
<span class="lineNum">     116 </span>                :            :  *    accepted in cluster mode if the slot is marked as 'importing'.
<span class="lineNum">     117 </span>                :            :  */
<span class="lineNum">     118 </span>                :            : struct redisCommand redisCommandTable[] = {
<span class="lineNum">     119 </span>                :            :     {&quot;get&quot;,getCommand,2,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     120 </span>                :            :     {&quot;set&quot;,setCommand,-3,&quot;wm&quot;,0,noPreloadGetKeys,1,1,1,0,0},
<span class="lineNum">     121 </span>                :            :     {&quot;setnx&quot;,setnxCommand,3,&quot;wm&quot;,0,noPreloadGetKeys,1,1,1,0,0},
<span class="lineNum">     122 </span>                :            :     {&quot;setex&quot;,setexCommand,4,&quot;wm&quot;,0,noPreloadGetKeys,1,1,1,0,0},
<span class="lineNum">     123 </span>                :            :     {&quot;psetex&quot;,psetexCommand,4,&quot;wm&quot;,0,noPreloadGetKeys,1,1,1,0,0},
<span class="lineNum">     124 </span>                :            :     {&quot;append&quot;,appendCommand,3,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     125 </span>                :            :     {&quot;strlen&quot;,strlenCommand,2,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     126 </span>                :            :     {&quot;del&quot;,delCommand,-2,&quot;w&quot;,0,noPreloadGetKeys,1,-1,1,0,0},
<span class="lineNum">     127 </span>                :            :     {&quot;exists&quot;,existsCommand,2,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     128 </span>                :            :     {&quot;setbit&quot;,setbitCommand,4,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     129 </span>                :            :     {&quot;getbit&quot;,getbitCommand,3,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     130 </span>                :            :     {&quot;setrange&quot;,setrangeCommand,4,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     131 </span>                :            :     {&quot;getrange&quot;,getrangeCommand,4,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     132 </span>                :            :     {&quot;substr&quot;,getrangeCommand,4,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     133 </span>                :            :     {&quot;incr&quot;,incrCommand,2,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     134 </span>                :            :     {&quot;decr&quot;,decrCommand,2,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     135 </span>                :            :     {&quot;mget&quot;,mgetCommand,-2,&quot;r&quot;,0,NULL,1,-1,1,0,0},
<span class="lineNum">     136 </span>                :            :     {&quot;rpush&quot;,rpushCommand,-3,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     137 </span>                :            :     {&quot;lpush&quot;,lpushCommand,-3,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     138 </span>                :            :     {&quot;rpushx&quot;,rpushxCommand,3,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     139 </span>                :            :     {&quot;lpushx&quot;,lpushxCommand,3,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     140 </span>                :            :     {&quot;linsert&quot;,linsertCommand,5,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     141 </span>                :            :     {&quot;rpop&quot;,rpopCommand,2,&quot;w&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     142 </span>                :            :     {&quot;lpop&quot;,lpopCommand,2,&quot;w&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     143 </span>                :            :     {&quot;brpop&quot;,brpopCommand,-3,&quot;ws&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     144 </span>                :            :     {&quot;brpoplpush&quot;,brpoplpushCommand,4,&quot;wms&quot;,0,NULL,1,2,1,0,0},
<span class="lineNum">     145 </span>                :            :     {&quot;blpop&quot;,blpopCommand,-3,&quot;ws&quot;,0,NULL,1,-2,1,0,0},
<span class="lineNum">     146 </span>                :            :     {&quot;llen&quot;,llenCommand,2,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     147 </span>                :            :     {&quot;lindex&quot;,lindexCommand,3,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     148 </span>                :            :     {&quot;lset&quot;,lsetCommand,4,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     149 </span>                :            :     {&quot;lrange&quot;,lrangeCommand,4,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     150 </span>                :            :     {&quot;ltrim&quot;,ltrimCommand,4,&quot;w&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     151 </span>                :            :     {&quot;lrem&quot;,lremCommand,4,&quot;w&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     152 </span>                :            :     {&quot;rpoplpush&quot;,rpoplpushCommand,3,&quot;wm&quot;,0,NULL,1,2,1,0,0},
<span class="lineNum">     153 </span>                :            :     {&quot;sadd&quot;,saddCommand,-3,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     154 </span>                :            :     {&quot;srem&quot;,sremCommand,-3,&quot;w&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     155 </span>                :            :     {&quot;smove&quot;,smoveCommand,4,&quot;w&quot;,0,NULL,1,2,1,0,0},
<span class="lineNum">     156 </span>                :            :     {&quot;sismember&quot;,sismemberCommand,3,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     157 </span>                :            :     {&quot;scard&quot;,scardCommand,2,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     158 </span>                :            :     {&quot;spop&quot;,spopCommand,2,&quot;wRs&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     159 </span>                :            :     {&quot;srandmember&quot;,srandmemberCommand,-2,&quot;rR&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     160 </span>                :            :     {&quot;sinter&quot;,sinterCommand,-2,&quot;rS&quot;,0,NULL,1,-1,1,0,0},
<span class="lineNum">     161 </span>                :            :     {&quot;sinterstore&quot;,sinterstoreCommand,-3,&quot;wm&quot;,0,NULL,1,-1,1,0,0},
<span class="lineNum">     162 </span>                :            :     {&quot;sunion&quot;,sunionCommand,-2,&quot;rS&quot;,0,NULL,1,-1,1,0,0},
<span class="lineNum">     163 </span>                :            :     {&quot;sunionstore&quot;,sunionstoreCommand,-3,&quot;wm&quot;,0,NULL,1,-1,1,0,0},
<span class="lineNum">     164 </span>                :            :     {&quot;sdiff&quot;,sdiffCommand,-2,&quot;rS&quot;,0,NULL,1,-1,1,0,0},
<span class="lineNum">     165 </span>                :            :     {&quot;sdiffstore&quot;,sdiffstoreCommand,-3,&quot;wm&quot;,0,NULL,1,-1,1,0,0},
<span class="lineNum">     166 </span>                :            :     {&quot;smembers&quot;,sinterCommand,2,&quot;rS&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     167 </span>                :            :     {&quot;zadd&quot;,zaddCommand,-4,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     168 </span>                :            :     {&quot;zincrby&quot;,zincrbyCommand,4,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     169 </span>                :            :     {&quot;zrem&quot;,zremCommand,-3,&quot;w&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     170 </span>                :            :     {&quot;zremrangebyscore&quot;,zremrangebyscoreCommand,4,&quot;w&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     171 </span>                :            :     {&quot;zremrangebyrank&quot;,zremrangebyrankCommand,4,&quot;w&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     172 </span>                :            :     {&quot;zunionstore&quot;,zunionstoreCommand,-4,&quot;wm&quot;,0,zunionInterGetKeys,0,0,0,0,0},
<span class="lineNum">     173 </span>                :            :     {&quot;zinterstore&quot;,zinterstoreCommand,-4,&quot;wm&quot;,0,zunionInterGetKeys,0,0,0,0,0},
<span class="lineNum">     174 </span>                :            :     {&quot;zrange&quot;,zrangeCommand,-4,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     175 </span>                :            :     {&quot;zrangebyscore&quot;,zrangebyscoreCommand,-4,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     176 </span>                :            :     {&quot;zrevrangebyscore&quot;,zrevrangebyscoreCommand,-4,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     177 </span>                :            :     {&quot;zcount&quot;,zcountCommand,4,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     178 </span>                :            :     {&quot;zrevrange&quot;,zrevrangeCommand,-4,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     179 </span>                :            :     {&quot;zcard&quot;,zcardCommand,2,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     180 </span>                :            :     {&quot;zscore&quot;,zscoreCommand,3,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     181 </span>                :            :     {&quot;zrank&quot;,zrankCommand,3,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     182 </span>                :            :     {&quot;zrevrank&quot;,zrevrankCommand,3,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     183 </span>                :            :     {&quot;hset&quot;,hsetCommand,4,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     184 </span>                :            :     {&quot;hsetnx&quot;,hsetnxCommand,4,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     185 </span>                :            :     {&quot;hget&quot;,hgetCommand,3,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     186 </span>                :            :     {&quot;hmset&quot;,hmsetCommand,-4,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     187 </span>                :            :     {&quot;hmget&quot;,hmgetCommand,-3,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     188 </span>                :            :     {&quot;hincrby&quot;,hincrbyCommand,4,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     189 </span>                :            :     {&quot;hincrbyfloat&quot;,hincrbyfloatCommand,4,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     190 </span>                :            :     {&quot;hdel&quot;,hdelCommand,-3,&quot;w&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     191 </span>                :            :     {&quot;hlen&quot;,hlenCommand,2,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     192 </span>                :            :     {&quot;hkeys&quot;,hkeysCommand,2,&quot;rS&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     193 </span>                :            :     {&quot;hvals&quot;,hvalsCommand,2,&quot;rS&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     194 </span>                :            :     {&quot;hgetall&quot;,hgetallCommand,2,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     195 </span>                :            :     {&quot;hexists&quot;,hexistsCommand,3,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     196 </span>                :            :     {&quot;incrby&quot;,incrbyCommand,3,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     197 </span>                :            :     {&quot;decrby&quot;,decrbyCommand,3,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     198 </span>                :            :     {&quot;incrbyfloat&quot;,incrbyfloatCommand,3,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     199 </span>                :            :     {&quot;getset&quot;,getsetCommand,3,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     200 </span>                :            :     {&quot;mset&quot;,msetCommand,-3,&quot;wm&quot;,0,NULL,1,-1,2,0,0},
<span class="lineNum">     201 </span>                :            :     {&quot;msetnx&quot;,msetnxCommand,-3,&quot;wm&quot;,0,NULL,1,-1,2,0,0},
<span class="lineNum">     202 </span>                :            :     {&quot;randomkey&quot;,randomkeyCommand,1,&quot;rR&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     203 </span>                :            :     {&quot;select&quot;,selectCommand,2,&quot;rl&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     204 </span>                :            :     {&quot;move&quot;,moveCommand,3,&quot;w&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     205 </span>                :            :     {&quot;rename&quot;,renameCommand,3,&quot;w&quot;,0,renameGetKeys,1,2,1,0,0},
<span class="lineNum">     206 </span>                :            :     {&quot;renamenx&quot;,renamenxCommand,3,&quot;w&quot;,0,renameGetKeys,1,2,1,0,0},
<span class="lineNum">     207 </span>                :            :     {&quot;expire&quot;,expireCommand,3,&quot;w&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     208 </span>                :            :     {&quot;expireat&quot;,expireatCommand,3,&quot;w&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     209 </span>                :            :     {&quot;pexpire&quot;,pexpireCommand,3,&quot;w&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     210 </span>                :            :     {&quot;pexpireat&quot;,pexpireatCommand,3,&quot;w&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     211 </span>                :            :     {&quot;keys&quot;,keysCommand,2,&quot;rS&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     212 </span>                :            :     {&quot;dbsize&quot;,dbsizeCommand,1,&quot;r&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     213 </span>                :            :     {&quot;auth&quot;,authCommand,2,&quot;rsl&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     214 </span>                :            :     {&quot;ping&quot;,pingCommand,1,&quot;r&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     215 </span>                :            :     {&quot;echo&quot;,echoCommand,2,&quot;r&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     216 </span>                :            :     {&quot;save&quot;,saveCommand,1,&quot;ars&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     217 </span>                :            :     {&quot;bgsave&quot;,bgsaveCommand,1,&quot;ar&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     218 </span>                :            :     {&quot;bgrewriteaof&quot;,bgrewriteaofCommand,1,&quot;ar&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     219 </span>                :            :     {&quot;shutdown&quot;,shutdownCommand,-1,&quot;arl&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     220 </span>                :            :     {&quot;lastsave&quot;,lastsaveCommand,1,&quot;rR&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     221 </span>                :            :     {&quot;type&quot;,typeCommand,2,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     222 </span>                :            :     {&quot;multi&quot;,multiCommand,1,&quot;rs&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     223 </span>                :            :     {&quot;exec&quot;,execCommand,1,&quot;sM&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     224 </span>                :            :     {&quot;discard&quot;,discardCommand,1,&quot;rs&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     225 </span>                :            :     {&quot;sync&quot;,syncCommand,1,&quot;ars&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     226 </span>                :            :     {&quot;psync&quot;,syncCommand,3,&quot;ars&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     227 </span>                :            :     {&quot;replconf&quot;,replconfCommand,-1,&quot;arslt&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     228 </span>                :            :     {&quot;flushdb&quot;,flushdbCommand,1,&quot;w&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     229 </span>                :            :     {&quot;flushall&quot;,flushallCommand,1,&quot;w&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     230 </span>                :            :     {&quot;sort&quot;,sortCommand,-2,&quot;wm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     231 </span>                :            :     {&quot;info&quot;,infoCommand,-1,&quot;rlt&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     232 </span>                :            :     {&quot;monitor&quot;,monitorCommand,1,&quot;ars&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     233 </span>                :            :     {&quot;ttl&quot;,ttlCommand,2,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     234 </span>                :            :     {&quot;pttl&quot;,pttlCommand,2,&quot;r&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     235 </span>                :            :     {&quot;persist&quot;,persistCommand,2,&quot;w&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     236 </span>                :            :     {&quot;slaveof&quot;,slaveofCommand,3,&quot;ast&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     237 </span>                :            :     {&quot;debug&quot;,debugCommand,-2,&quot;as&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     238 </span>                :            :     {&quot;config&quot;,configCommand,-2,&quot;ar&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     239 </span>                :            :     {&quot;subscribe&quot;,subscribeCommand,-2,&quot;rpslt&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     240 </span>                :            :     {&quot;unsubscribe&quot;,unsubscribeCommand,-1,&quot;rpslt&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     241 </span>                :            :     {&quot;psubscribe&quot;,psubscribeCommand,-2,&quot;rpslt&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     242 </span>                :            :     {&quot;punsubscribe&quot;,punsubscribeCommand,-1,&quot;rpslt&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     243 </span>                :            :     {&quot;publish&quot;,publishCommand,3,&quot;pltr&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     244 </span>                :            :     {&quot;pubsub&quot;,pubsubCommand,-2,&quot;pltrR&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     245 </span>                :            :     {&quot;watch&quot;,watchCommand,-2,&quot;rs&quot;,0,noPreloadGetKeys,1,-1,1,0,0},
<span class="lineNum">     246 </span>                :            :     {&quot;unwatch&quot;,unwatchCommand,1,&quot;rs&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     247 </span>                :            :     {&quot;cluster&quot;,clusterCommand,-2,&quot;ar&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     248 </span>                :            :     {&quot;restore&quot;,restoreCommand,-4,&quot;awm&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     249 </span>                :            :     {&quot;restore-asking&quot;,restoreCommand,-4,&quot;awmk&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     250 </span>                :            :     {&quot;migrate&quot;,migrateCommand,-6,&quot;aw&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     251 </span>                :            :     {&quot;asking&quot;,askingCommand,1,&quot;r&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     252 </span>                :            :     {&quot;dump&quot;,dumpCommand,2,&quot;ar&quot;,0,NULL,1,1,1,0,0},
<span class="lineNum">     253 </span>                :            :     {&quot;object&quot;,objectCommand,-2,&quot;r&quot;,0,NULL,2,2,2,0,0},
<span class="lineNum">     254 </span>                :            :     {&quot;client&quot;,clientCommand,-2,&quot;ar&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     255 </span>                :            :     {&quot;eval&quot;,evalCommand,-3,&quot;s&quot;,0,zunionInterGetKeys,0,0,0,0,0},
<span class="lineNum">     256 </span>                :            :     {&quot;evalsha&quot;,evalShaCommand,-3,&quot;s&quot;,0,zunionInterGetKeys,0,0,0,0,0},
<span class="lineNum">     257 </span>                :            :     {&quot;slowlog&quot;,slowlogCommand,-2,&quot;r&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     258 </span>                :            :     {&quot;script&quot;,scriptCommand,-2,&quot;ras&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     259 </span>                :            :     {&quot;time&quot;,timeCommand,1,&quot;rR&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     260 </span>                :            :     {&quot;bitop&quot;,bitopCommand,-4,&quot;wm&quot;,0,NULL,2,-1,1,0,0},
<span class="lineNum">     261 </span>                :            :     {&quot;bitcount&quot;,bitcountCommand,-2,&quot;r&quot;,0,NULL,1,1,1,0,0}
<span class="lineNum">     262 </span>                :            : };
<span class="lineNum">     263 </span>                :            : 
<span class="lineNum">     264 </span>                :            : /*============================ Utility functions ============================ */
<span class="lineNum">     265 </span>                :            : 
<a name="266"><span class="lineNum">     266 </span>                :            : /* Low level logging. To use only for very big messages, otherwise</a>
<span class="lineNum">     267 </span>                :            :  * redisLog() is to prefer. */
<span class="lineNum">     268 </span>                :<span class="lineCov">       4464 : void redisLogRaw(int level, const char *msg) {</span>
<span class="lineNum">     269 </span>                :<span class="lineCov">       4464 :     const int syslogLevelMap[] = { LOG_DEBUG, LOG_INFO, LOG_NOTICE, LOG_WARNING };</span>
<span class="lineNum">     270 </span>                :<span class="lineCov">       4464 :     const char *c = &quot;.-*#&quot;;</span>
<span class="lineNum">     271 </span>                :            :     FILE *fp;
<span class="lineNum">     272 </span>                :            :     char buf[64];
<span class="lineNum">     273 </span>                :<span class="lineCov">       4464 :     int rawmode = (level &amp; REDIS_LOG_RAW);</span>
<span class="lineNum">     274 </span>                :<span class="lineCov">       4464 :     int log_to_stdout = server.logfile[0] == '\0';</span>
<span class="lineNum">     275 </span>                :            : 
<span class="lineNum">     276 </span>                :<span class="lineCov">       4464 :     level &amp;= 0xff; /* clear flags */</span>
<span class="lineNum">     277 </span>        [<span class="branchCov" title="Branch 0 was taken 4464 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       4464 :     if (level &lt; server.verbosity) return;</span>
<span class="lineNum">     278 </span>                :            : 
<span class="lineNum">     279 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4464 times"> + </span>]:<span class="lineCov">       4464 :     fp = log_to_stdout ? stdout : fopen(server.logfile,&quot;a&quot;);</span>
<span class="lineNum">     280 </span>        [<span class="branchCov" title="Branch 0 was taken 4464 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       4464 :     if (!fp) return;</span>
<span class="lineNum">     281 </span>                :            : 
<span class="lineNum">     282 </span>        [<span class="branchCov" title="Branch 0 was taken 131 times"> + </span><span class="branchCov" title="Branch 1 was taken 4333 times"> + </span>]:<span class="lineCov">       4464 :     if (rawmode) {</span>
<span class="lineNum">     283 </span>                :            :         fprintf(fp,&quot;%s&quot;,msg);
<span class="lineNum">     284 </span>                :            :     } else {
<span class="lineNum">     285 </span>                :            :         int off;
<span class="lineNum">     286 </span>                :            :         struct timeval tv;
<span class="lineNum">     287 </span>                :            : 
<span class="lineNum">     288 </span>                :<span class="lineCov">       4333 :         gettimeofday(&amp;tv,NULL);</span>
<span class="lineNum">     289 </span>                :<span class="lineCov">       4333 :         off = strftime(buf,sizeof(buf),&quot;%d %b %H:%M:%S.&quot;,localtime(&amp;tv.tv_sec));</span>
<span class="lineNum">     290 </span>                :<span class="lineCov">       4333 :         snprintf(buf+off,sizeof(buf)-off,&quot;%03d&quot;,(int)tv.tv_usec/1000);</span>
<span class="lineNum">     291 </span>                :<span class="lineCov">       4333 :         fprintf(fp,&quot;[%d] %s %c %s\n&quot;,(int)getpid(),buf,c[level],msg);</span>
<span class="lineNum">     292 </span>                :            :     }
<span class="lineNum">     293 </span>                :<span class="lineCov">       4464 :     fflush(fp);</span>
<span class="lineNum">     294 </span>                :            : 
<span class="lineNum">     295 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4464 times"> + </span>]:<span class="lineCov">       4464 :     if (!log_to_stdout) fclose(fp);</span>
<span class="lineNum">     296 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4464 times"> + </span>]:<span class="lineCov">       4464 :     if (server.syslog_enabled) syslog(syslogLevelMap[level], &quot;%s&quot;, msg);</span>
<span class="lineNum">     297 </span>                :            : }
<span class="lineNum">     298 </span>                :            : 
<span class="lineNum">     299 </span>                :            : /* Like redisLogRaw() but with printf-alike support. This is the function that
<a name="300"><span class="lineNum">     300 </span>                :            :  * is used across the code. The raw version is only used in order to dump</a>
<span class="lineNum">     301 </span>                :            :  * the INFO output on crash. */
<span class="lineNum">     302 </span>                :<span class="lineCov">       4361 : void redisLog(int level, const char *fmt, ...) {</span>
<span class="lineNum">     303 </span>                :            :     va_list ap;
<span class="lineNum">     304 </span>                :            :     char msg[REDIS_MAX_LOGMSG_LEN];
<span class="lineNum">     305 </span>                :            : 
<span class="lineNum">     306 </span>        [<span class="branchCov" title="Branch 0 was taken 4333 times"> + </span><span class="branchCov" title="Branch 1 was taken 28 times"> + </span>]:<span class="lineCov">       8694 :     if ((level&amp;0xff) &lt; server.verbosity) return;</span>
<span class="lineNum">     307 </span>                :            : 
<span class="lineNum">     308 </span>                :<span class="lineCov">       4333 :     va_start(ap, fmt);</span>
<span class="lineNum">     309 </span>                :            :     vsnprintf(msg, sizeof(msg), fmt, ap);
<span class="lineNum">     310 </span>                :<span class="lineCov">       4333 :     va_end(ap);</span>
<span class="lineNum">     311 </span>                :            : 
<span class="lineNum">     312 </span>                :<span class="lineCov">       4333 :     redisLogRaw(level,msg);</span>
<span class="lineNum">     313 </span>                :            : }
<span class="lineNum">     314 </span>                :            : 
<span class="lineNum">     315 </span>                :            : /* Log a fixed message without printf-alike capabilities, in a way that is
<span class="lineNum">     316 </span>                :            :  * safe to call from a signal handler.
<span class="lineNum">     317 </span>                :            :  *
<span class="lineNum">     318 </span>                :            :  * We actually use this only for signals that are not fatal from the point
<a name="319"><span class="lineNum">     319 </span>                :            :  * of view of Redis. Signals that are going to kill the server anyway and</a>
<span class="lineNum">     320 </span>                :            :  * where we need printf-alike features are served by redisLog(). */
<span class="lineNum">     321 </span>                :<span class="lineCov">         74 : void redisLogFromHandler(int level, const char *msg) {</span>
<span class="lineNum">     322 </span>                :            :     int fd;
<span class="lineNum">     323 </span>                :<span class="lineCov">         74 :     int log_to_stdout = server.logfile[0] == '\0';</span>
<span class="lineNum">     324 </span>                :            :     char buf[64];
<span class="lineNum">     325 </span>                :            : 
<span class="lineNum">     326 </span>[<span class="branchCov" title="Branch 0 was taken 74 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 74 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">         74 :     if ((level&amp;0xff) &lt; server.verbosity || (log_to_stdout &amp;&amp; server.daemonize))</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 74 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]
<span class="lineNum">     327 </span>                :            :         return;
<span class="lineNum">     328 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 74 times"> + </span>]:<span class="lineCov">         74 :     fd = log_to_stdout ? STDOUT_FILENO : </span>
<span class="lineNum">     329 </span>                :<span class="lineNoCov">          0 :                          open(server.logfile, O_APPEND|O_CREAT|O_WRONLY, 0644);</span>
<span class="lineNum">     330 </span>        [<span class="branchCov" title="Branch 0 was taken 74 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         74 :     if (fd == -1) return;</span>
<span class="lineNum">     331 </span>                :<span class="lineCov">         74 :     ll2string(buf,sizeof(buf),getpid());</span>
<span class="lineNum">     332 </span>        [<span class="branchCov" title="Branch 1 was taken 74 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         74 :     if (write(fd,&quot;[&quot;,1) == -1) goto err;</span>
<span class="lineNum">     333 </span>        [<span class="branchCov" title="Branch 1 was taken 74 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         74 :     if (write(fd,buf,strlen(buf)) == -1) goto err;</span>
<span class="lineNum">     334 </span>        [<span class="branchCov" title="Branch 1 was taken 74 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         74 :     if (write(fd,&quot; | signal handler] (&quot;,20) == -1) goto err;</span>
<span class="lineNum">     335 </span>                :<span class="lineCov">         74 :     ll2string(buf,sizeof(buf),time(NULL));</span>
<span class="lineNum">     336 </span>        [<span class="branchCov" title="Branch 1 was taken 74 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         74 :     if (write(fd,buf,strlen(buf)) == -1) goto err;</span>
<span class="lineNum">     337 </span>        [<span class="branchCov" title="Branch 1 was taken 74 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         74 :     if (write(fd,&quot;) &quot;,2) == -1) goto err;</span>
<span class="lineNum">     338 </span>        [<span class="branchCov" title="Branch 1 was taken 74 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         74 :     if (write(fd,msg,strlen(msg)) == -1) goto err;</span>
<span class="lineNum">     339 </span>                :<span class="lineCov">         74 :     if (write(fd,&quot;\n&quot;,1) == -1) goto err;</span>
<span class="lineNum">     340 </span>                :            : err:
<span class="lineNum">     341 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 74 times"> + </span>]:<span class="lineCov">         74 :     if (!log_to_stdout) close(fd);</span>
<span class="lineNum">     342 </span>                :            : }
<a name="343"><span class="lineNum">     343 </span>                :            : </a>
<span class="lineNum">     344 </span>                :            : /* Return the UNIX time in microseconds */
<span class="lineNum">     345 </span>                :<span class="lineCov">   16779928 : long long ustime(void) {</span>
<span class="lineNum">     346 </span>                :            :     struct timeval tv;
<span class="lineNum">     347 </span>                :            :     long long ust;
<span class="lineNum">     348 </span>                :            : 
<span class="lineNum">     349 </span>                :<span class="lineCov">   16779928 :     gettimeofday(&amp;tv, NULL);</span>
<span class="lineNum">     350 </span>                :<span class="lineCov">   16779928 :     ust = ((long long)tv.tv_sec)*1000000;</span>
<span class="lineNum">     351 </span>                :<span class="lineCov">   16779928 :     ust += tv.tv_usec;</span>
<span class="lineNum">     352 </span>                :<span class="lineCov">   16779928 :     return ust;</span>
<span class="lineNum">     353 </span>                :            : }
<a name="354"><span class="lineNum">     354 </span>                :            : </a>
<span class="lineNum">     355 </span>                :            : /* Return the UNIX time in milliseconds */
<span class="lineNum">     356 </span>                :<span class="lineCov">      56437 : long long mstime(void) {</span>
<span class="lineNum">     357 </span>                :<span class="lineCov">      56437 :     return ustime()/1000;</span>
<span class="lineNum">     358 </span>                :            : }
<span class="lineNum">     359 </span>                :            : 
<span class="lineNum">     360 </span>                :            : /* After an RDB dump or AOF rewrite we exit from children using _exit() instead of
<span class="lineNum">     361 </span>                :            :  * exit(), because the latter may interact with the same file objects used by
<a name="362"><span class="lineNum">     362 </span>                :            :  * the parent process. However if we are testing the coverage normal exit() is</a>
<span class="lineNum">     363 </span>                :            :  * used in order to obtain the right coverage information. */
<span class="lineNum">     364 </span>                :<span class="lineCov">         51 : void exitFromChild(int retcode) {</span>
<span class="lineNum">     365 </span>                :            : #ifdef COVERAGE_TEST
<span class="lineNum">     366 </span>                :<span class="lineCov">         51 :     exit(retcode);</span>
<span class="lineNum">     367 </span>                :            : #else
<span class="lineNum">     368 </span>                :            :     _exit(retcode);
<span class="lineNum">     369 </span>                :            : #endif
<span class="lineNum">     370 </span>                :            : }
<span class="lineNum">     371 </span>                :            : 
<span class="lineNum">     372 </span>                :            : /*====================== Hash table type implementation  ==================== */
<span class="lineNum">     373 </span>                :            : 
<span class="lineNum">     374 </span>                :            : /* This is an hash table type that uses the SDS dynamic strings library as
<span class="lineNum">     375 </span>                :            :  * keys and radis objects as values (objects can hold SDS strings,
<a name="376"><span class="lineNum">     376 </span>                :            :  * lists, sets). */</a>
<span class="lineNum">     377 </span>                :            : 
<span class="lineNum">     378 </span>                :<span class="lineNoCov">          0 : void dictVanillaFree(void *privdata, void *val)</span>
<span class="lineNum">     379 </span>                :            : {
<span class="lineNum">     380 </span>                :            :     DICT_NOTUSED(privdata);
<span class="lineNum">     381 </span>                :<span class="lineNoCov">          0 :     zfree(val);</span>
<a name="382"><span class="lineNum">     382 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     383 </span>                :            : 
<span class="lineNum">     384 </span>                :<span class="lineCov">        173 : void dictListDestructor(void *privdata, void *val)</span>
<span class="lineNum">     385 </span>                :            : {
<span class="lineNum">     386 </span>                :            :     DICT_NOTUSED(privdata);
<span class="lineNum">     387 </span>                :<span class="lineCov">        173 :     listRelease((list*)val);</span>
<a name="388"><span class="lineNum">     388 </span>                :<span class="lineCov">        173 : }</span></a>
<span class="lineNum">     389 </span>                :            : 
<span class="lineNum">     390 </span>                :<span class="lineCov">   13714638 : int dictSdsKeyCompare(void *privdata, const void *key1,</span>
<span class="lineNum">     391 </span>                :            :         const void *key2)
<span class="lineNum">     392 </span>                :            : {
<span class="lineNum">     393 </span>                :            :     int l1,l2;
<span class="lineNum">     394 </span>                :            :     DICT_NOTUSED(privdata);
<span class="lineNum">     395 </span>                :            : 
<span class="lineNum">     396 </span>                :<span class="lineCov">   13714638 :     l1 = sdslen((sds)key1);</span>
<span class="lineNum">     397 </span>                :<span class="lineCov">   13714638 :     l2 = sdslen((sds)key2);</span>
<span class="lineNum">     398 </span>        [<span class="branchCov" title="Branch 0 was taken 9081100 times"> + </span><span class="branchCov" title="Branch 1 was taken 4633538 times"> + </span>]:<span class="lineCov">   13714638 :     if (l1 != l2) return 0;</span>
<span class="lineNum">     399 </span>                :<span class="lineCov">   13714638 :     return memcmp(key1, key2, l1) == 0;</span>
<span class="lineNum">     400 </span>                :            : }
<span class="lineNum">     401 </span>                :            : 
<a name="402"><span class="lineNum">     402 </span>                :            : /* A case insensitive version used for the command lookup table and other</a>
<span class="lineNum">     403 </span>                :            :  * places where case insensitive non binary-safe comparison is needed. */
<span class="lineNum">     404 </span>                :<span class="lineCov">    8115223 : int dictSdsKeyCaseCompare(void *privdata, const void *key1,</span>
<span class="lineNum">     405 </span>                :            :         const void *key2)
<span class="lineNum">     406 </span>                :            : {
<span class="lineNum">     407 </span>                :            :     DICT_NOTUSED(privdata);
<span class="lineNum">     408 </span>                :            : 
<span class="lineNum">     409 </span>                :<span class="lineCov">    8115223 :     return strcasecmp(key1, key2) == 0;</span>
<a name="410"><span class="lineNum">     410 </span>                :            : }</a>
<span class="lineNum">     411 </span>                :            : 
<span class="lineNum">     412 </span>                :<span class="lineCov">     885396 : void dictRedisObjectDestructor(void *privdata, void *val)</span>
<span class="lineNum">     413 </span>                :            : {
<span class="lineNum">     414 </span>                :            :     DICT_NOTUSED(privdata);
<span class="lineNum">     415 </span>                :            : 
<span class="lineNum">     416 </span>        [<span class="branchCov" title="Branch 0 was taken 885396 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    1770792 :     if (val == NULL) return; /* Values of swapped out keys as set to NULL */</span>
<span class="lineNum">     417 </span>                :<span class="lineCov">     885396 :     decrRefCount(val);</span>
<a name="418"><span class="lineNum">     418 </span>                :            : }</a>
<span class="lineNum">     419 </span>                :            : 
<span class="lineNum">     420 </span>                :<span class="lineCov">     425155 : void dictSdsDestructor(void *privdata, void *val)</span>
<span class="lineNum">     421 </span>                :            : {
<span class="lineNum">     422 </span>                :            :     DICT_NOTUSED(privdata);
<span class="lineNum">     423 </span>                :            : 
<span class="lineNum">     424 </span>                :<span class="lineCov">     425155 :     sdsfree(val);</span>
<a name="425"><span class="lineNum">     425 </span>                :<span class="lineCov">     425155 : }</span></a>
<span class="lineNum">     426 </span>                :            : 
<span class="lineNum">     427 </span>                :<span class="lineCov">     102485 : int dictObjKeyCompare(void *privdata, const void *key1,</span>
<span class="lineNum">     428 </span>                :            :         const void *key2)
<span class="lineNum">     429 </span>                :            : {
<span class="lineNum">     430 </span>                :<span class="lineCov">     102485 :     const robj *o1 = key1, *o2 = key2;</span>
<span class="lineNum">     431 </span>                :<span class="lineCov">     102485 :     return dictSdsKeyCompare(privdata,o1-&gt;ptr,o2-&gt;ptr);</span>
<a name="432"><span class="lineNum">     432 </span>                :            : }</a>
<span class="lineNum">     433 </span>                :            : 
<span class="lineNum">     434 </span>                :<span class="lineCov">     102926 : unsigned int dictObjHash(const void *key) {</span>
<span class="lineNum">     435 </span>                :<span class="lineCov">     102926 :     const robj *o = key;</span>
<span class="lineNum">     436 </span>                :<span class="lineCov">     102926 :     return dictGenHashFunction(o-&gt;ptr, sdslen((sds)o-&gt;ptr));</span>
<a name="437"><span class="lineNum">     437 </span>                :            : }</a>
<span class="lineNum">     438 </span>                :            : 
<span class="lineNum">     439 </span>                :<span class="lineCov">   20274322 : unsigned int dictSdsHash(const void *key) {</span>
<span class="lineNum">     440 </span>                :<span class="lineCov">   20274322 :     return dictGenHashFunction((unsigned char*)key, sdslen((char*)key));</span>
<a name="441"><span class="lineNum">     441 </span>                :            : }</a>
<span class="lineNum">     442 </span>                :            : 
<span class="lineNum">     443 </span>                :<span class="lineCov">    7351957 : unsigned int dictSdsCaseHash(const void *key) {</span>
<span class="lineNum">     444 </span>                :<span class="lineCov">    7351957 :     return dictGenCaseHashFunction((unsigned char*)key, sdslen((char*)key));</span>
<a name="445"><span class="lineNum">     445 </span>                :            : }</a>
<span class="lineNum">     446 </span>                :            : 
<span class="lineNum">     447 </span>                :<span class="lineCov">     292938 : int dictEncObjKeyCompare(void *privdata, const void *key1,</span>
<span class="lineNum">     448 </span>                :            :         const void *key2)
<span class="lineNum">     449 </span>                :            : {
<span class="lineNum">     450 </span>                :<span class="lineCov">     292938 :     robj *o1 = (robj*) key1, *o2 = (robj*) key2;</span>
<span class="lineNum">     451 </span>                :            :     int cmp;
<span class="lineNum">     452 </span>                :            : 
<span class="lineNum">     453 </span>[<span class="branchCov" title="Branch 0 was taken 160354 times"> + </span><span class="branchCov" title="Branch 1 was taken 132584 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 142254 times"> + </span><span class="branchCov" title="Branch 3 was taken 18100 times"> + </span>]:<span class="lineCov">     292938 :     if (o1-&gt;encoding == REDIS_ENCODING_INT &amp;&amp;</span>
<span class="lineNum">     454 </span>                :<span class="lineCov">     160354 :         o2-&gt;encoding == REDIS_ENCODING_INT)</span>
<span class="lineNum">     455 </span>                :<span class="lineCov">     142254 :             return o1-&gt;ptr == o2-&gt;ptr;</span>
<span class="lineNum">     456 </span>                :            : 
<span class="lineNum">     457 </span>                :<span class="lineCov">     150684 :     o1 = getDecodedObject(o1);</span>
<span class="lineNum">     458 </span>                :<span class="lineCov">     150684 :     o2 = getDecodedObject(o2);</span>
<span class="lineNum">     459 </span>                :<span class="lineCov">     150684 :     cmp = dictSdsKeyCompare(privdata,o1-&gt;ptr,o2-&gt;ptr);</span>
<span class="lineNum">     460 </span>                :<span class="lineCov">     150684 :     decrRefCount(o1);</span>
<span class="lineNum">     461 </span>                :<span class="lineCov">     150684 :     decrRefCount(o2);</span>
<span class="lineNum">     462 </span>                :<span class="lineCov">     292938 :     return cmp;</span>
<a name="463"><span class="lineNum">     463 </span>                :            : }</a>
<span class="lineNum">     464 </span>                :            : 
<span class="lineNum">     465 </span>                :<span class="lineCov">     602232 : unsigned int dictEncObjHash(const void *key) {</span>
<span class="lineNum">     466 </span>                :<span class="lineCov">     602232 :     robj *o = (robj*) key;</span>
<span class="lineNum">     467 </span>                :            : 
<span class="lineNum">     468 </span>        [<span class="branchCov" title="Branch 0 was taken 280892 times"> + </span><span class="branchCov" title="Branch 1 was taken 321340 times"> + </span>]:<span class="lineCov">     602232 :     if (sdsEncodedObject(o)) {</span>
<span class="lineNum">     469 </span>                :<span class="lineCov">     280892 :         return dictGenHashFunction(o-&gt;ptr, sdslen((sds)o-&gt;ptr));</span>
<span class="lineNum">     470 </span>                :            :     } else {
<span class="lineNum">     471 </span>        [<span class="branchCov" title="Branch 0 was taken 321340 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     321340 :         if (o-&gt;encoding == REDIS_ENCODING_INT) {</span>
<span class="lineNum">     472 </span>                :            :             char buf[32];
<span class="lineNum">     473 </span>                :            :             int len;
<span class="lineNum">     474 </span>                :            : 
<span class="lineNum">     475 </span>                :<span class="lineCov">     321340 :             len = ll2string(buf,32,(long)o-&gt;ptr);</span>
<span class="lineNum">     476 </span>                :<span class="lineCov">     321340 :             return dictGenHashFunction((unsigned char*)buf, len);</span>
<span class="lineNum">     477 </span>                :            :         } else {
<span class="lineNum">     478 </span>                :            :             unsigned int hash;
<span class="lineNum">     479 </span>                :            : 
<span class="lineNum">     480 </span>                :<span class="lineNoCov">          0 :             o = getDecodedObject(o);</span>
<span class="lineNum">     481 </span>                :<span class="lineNoCov">          0 :             hash = dictGenHashFunction(o-&gt;ptr, sdslen((sds)o-&gt;ptr));</span>
<span class="lineNum">     482 </span>                :<span class="lineNoCov">          0 :             decrRefCount(o);</span>
<span class="lineNum">     483 </span>                :<span class="lineCov">     602232 :             return hash;</span>
<span class="lineNum">     484 </span>                :            :         }
<span class="lineNum">     485 </span>                :            :     }
<span class="lineNum">     486 </span>                :            : }
<span class="lineNum">     487 </span>                :            : 
<span class="lineNum">     488 </span>                :            : /* Sets type hash table */
<span class="lineNum">     489 </span>                :            : dictType setDictType = {
<span class="lineNum">     490 </span>                :            :     dictEncObjHash,            /* hash function */
<span class="lineNum">     491 </span>                :            :     NULL,                      /* key dup */
<span class="lineNum">     492 </span>                :            :     NULL,                      /* val dup */
<span class="lineNum">     493 </span>                :            :     dictEncObjKeyCompare,      /* key compare */
<span class="lineNum">     494 </span>                :            :     dictRedisObjectDestructor, /* key destructor */
<span class="lineNum">     495 </span>                :            :     NULL                       /* val destructor */
<span class="lineNum">     496 </span>                :            : };
<span class="lineNum">     497 </span>                :            : 
<span class="lineNum">     498 </span>                :            : /* Sorted sets hash (note: a skiplist is used in addition to the hash table) */
<span class="lineNum">     499 </span>                :            : dictType zsetDictType = {
<span class="lineNum">     500 </span>                :            :     dictEncObjHash,            /* hash function */
<span class="lineNum">     501 </span>                :            :     NULL,                      /* key dup */
<span class="lineNum">     502 </span>                :            :     NULL,                      /* val dup */
<span class="lineNum">     503 </span>                :            :     dictEncObjKeyCompare,      /* key compare */
<span class="lineNum">     504 </span>                :            :     dictRedisObjectDestructor, /* key destructor */
<span class="lineNum">     505 </span>                :            :     NULL                       /* val destructor */
<span class="lineNum">     506 </span>                :            : };
<span class="lineNum">     507 </span>                :            : 
<span class="lineNum">     508 </span>                :            : /* Db-&gt;dict, keys are sds strings, vals are Redis objects. */
<span class="lineNum">     509 </span>                :            : dictType dbDictType = {
<span class="lineNum">     510 </span>                :            :     dictSdsHash,                /* hash function */
<span class="lineNum">     511 </span>                :            :     NULL,                       /* key dup */
<span class="lineNum">     512 </span>                :            :     NULL,                       /* val dup */
<span class="lineNum">     513 </span>                :            :     dictSdsKeyCompare,          /* key compare */
<span class="lineNum">     514 </span>                :            :     dictSdsDestructor,          /* key destructor */
<span class="lineNum">     515 </span>                :            :     dictRedisObjectDestructor   /* val destructor */
<span class="lineNum">     516 </span>                :            : };
<span class="lineNum">     517 </span>                :            : 
<span class="lineNum">     518 </span>                :            : /* server.lua_scripts sha (as sds string) -&gt; scripts (as robj) cache. */
<span class="lineNum">     519 </span>                :            : dictType shaScriptObjectDictType = {
<span class="lineNum">     520 </span>                :            :     dictSdsCaseHash,            /* hash function */
<span class="lineNum">     521 </span>                :            :     NULL,                       /* key dup */
<span class="lineNum">     522 </span>                :            :     NULL,                       /* val dup */
<span class="lineNum">     523 </span>                :            :     dictSdsKeyCaseCompare,      /* key compare */
<span class="lineNum">     524 </span>                :            :     dictSdsDestructor,          /* key destructor */
<span class="lineNum">     525 </span>                :            :     dictRedisObjectDestructor   /* val destructor */
<span class="lineNum">     526 </span>                :            : };
<span class="lineNum">     527 </span>                :            : 
<span class="lineNum">     528 </span>                :            : /* Db-&gt;expires */
<span class="lineNum">     529 </span>                :            : dictType keyptrDictType = {
<span class="lineNum">     530 </span>                :            :     dictSdsHash,               /* hash function */
<span class="lineNum">     531 </span>                :            :     NULL,                      /* key dup */
<span class="lineNum">     532 </span>                :            :     NULL,                      /* val dup */
<span class="lineNum">     533 </span>                :            :     dictSdsKeyCompare,         /* key compare */
<span class="lineNum">     534 </span>                :            :     NULL,                      /* key destructor */
<span class="lineNum">     535 </span>                :            :     NULL                       /* val destructor */
<span class="lineNum">     536 </span>                :            : };
<span class="lineNum">     537 </span>                :            : 
<span class="lineNum">     538 </span>                :            : /* Command table. sds string -&gt; command struct pointer. */
<span class="lineNum">     539 </span>                :            : dictType commandTableDictType = {
<span class="lineNum">     540 </span>                :            :     dictSdsCaseHash,           /* hash function */
<span class="lineNum">     541 </span>                :            :     NULL,                      /* key dup */
<span class="lineNum">     542 </span>                :            :     NULL,                      /* val dup */
<span class="lineNum">     543 </span>                :            :     dictSdsKeyCaseCompare,     /* key compare */
<span class="lineNum">     544 </span>                :            :     dictSdsDestructor,         /* key destructor */
<span class="lineNum">     545 </span>                :            :     NULL                       /* val destructor */
<span class="lineNum">     546 </span>                :            : };
<span class="lineNum">     547 </span>                :            : 
<span class="lineNum">     548 </span>                :            : /* Hash type hash table (note that small hashes are represented with ziplists) */
<span class="lineNum">     549 </span>                :            : dictType hashDictType = {
<span class="lineNum">     550 </span>                :            :     dictEncObjHash,             /* hash function */
<span class="lineNum">     551 </span>                :            :     NULL,                       /* key dup */
<span class="lineNum">     552 </span>                :            :     NULL,                       /* val dup */
<span class="lineNum">     553 </span>                :            :     dictEncObjKeyCompare,       /* key compare */
<span class="lineNum">     554 </span>                :            :     dictRedisObjectDestructor,  /* key destructor */
<span class="lineNum">     555 </span>                :            :     dictRedisObjectDestructor   /* val destructor */
<span class="lineNum">     556 </span>                :            : };
<span class="lineNum">     557 </span>                :            : 
<span class="lineNum">     558 </span>                :            : /* Keylist hash table type has unencoded redis objects as keys and
<span class="lineNum">     559 </span>                :            :  * lists as values. It's used for blocking operations (BLPOP) and to
<span class="lineNum">     560 </span>                :            :  * map swapped keys to a list of clients waiting for this keys to be loaded. */
<span class="lineNum">     561 </span>                :            : dictType keylistDictType = {
<span class="lineNum">     562 </span>                :            :     dictObjHash,                /* hash function */
<span class="lineNum">     563 </span>                :            :     NULL,                       /* key dup */
<span class="lineNum">     564 </span>                :            :     NULL,                       /* val dup */
<span class="lineNum">     565 </span>                :            :     dictObjKeyCompare,          /* key compare */
<span class="lineNum">     566 </span>                :            :     dictRedisObjectDestructor,  /* key destructor */
<span class="lineNum">     567 </span>                :            :     dictListDestructor          /* val destructor */
<span class="lineNum">     568 </span>                :            : };
<span class="lineNum">     569 </span>                :            : 
<span class="lineNum">     570 </span>                :            : /* Cluster nodes hash table, mapping nodes addresses 1.2.3.4:6379 to
<span class="lineNum">     571 </span>                :            :  * clusterNode structures. */
<span class="lineNum">     572 </span>                :            : dictType clusterNodesDictType = {
<span class="lineNum">     573 </span>                :            :     dictSdsHash,                /* hash function */
<span class="lineNum">     574 </span>                :            :     NULL,                       /* key dup */
<span class="lineNum">     575 </span>                :            :     NULL,                       /* val dup */
<span class="lineNum">     576 </span>                :            :     dictSdsKeyCompare,          /* key compare */
<span class="lineNum">     577 </span>                :            :     dictSdsDestructor,          /* key destructor */
<span class="lineNum">     578 </span>                :            :     NULL                        /* val destructor */
<span class="lineNum">     579 </span>                :            : };
<span class="lineNum">     580 </span>                :            : 
<span class="lineNum">     581 </span>                :            : /* Migrate cache dict type. */
<span class="lineNum">     582 </span>                :            : dictType migrateCacheDictType = {
<span class="lineNum">     583 </span>                :            :     dictSdsHash,                /* hash function */
<span class="lineNum">     584 </span>                :            :     NULL,                       /* key dup */
<span class="lineNum">     585 </span>                :            :     NULL,                       /* val dup */
<span class="lineNum">     586 </span>                :            :     dictSdsKeyCompare,          /* key compare */
<span class="lineNum">     587 </span>                :            :     dictSdsDestructor,          /* key destructor */
<span class="lineNum">     588 </span>                :            :     NULL                        /* val destructor */
<span class="lineNum">     589 </span>                :            : };
<span class="lineNum">     590 </span>                :            : 
<span class="lineNum">     591 </span>                :            : /* Replication cached script dict (server.repl_scriptcache_dict).
<span class="lineNum">     592 </span>                :            :  * Keys are sds SHA1 strings, while values are not used at all in the current
<span class="lineNum">     593 </span>                :            :  * implementation. */
<span class="lineNum">     594 </span>                :            : dictType replScriptCacheDictType = {
<span class="lineNum">     595 </span>                :            :     dictSdsCaseHash,            /* hash function */
<span class="lineNum">     596 </span>                :            :     NULL,                       /* key dup */
<span class="lineNum">     597 </span>                :            :     NULL,                       /* val dup */
<span class="lineNum">     598 </span>                :            :     dictSdsKeyCaseCompare,      /* key compare */
<span class="lineNum">     599 </span>                :            :     dictSdsDestructor,          /* key destructor */
<span class="lineNum">     600 </span>                :            :     NULL                        /* val destructor */
<a name="601"><span class="lineNum">     601 </span>                :            : };</a>
<span class="lineNum">     602 </span>                :            : 
<span class="lineNum">     603 </span>                :<span class="lineCov">     260642 : int htNeedsResize(dict *dict) {</span>
<span class="lineNum">     604 </span>                :            :     long long size, used;
<span class="lineNum">     605 </span>                :            : 
<span class="lineNum">     606 </span>                :<span class="lineCov">     260642 :     size = dictSlots(dict);</span>
<span class="lineNum">     607 </span>                :<span class="lineCov">     260642 :     used = dictSize(dict);</span>
<span class="lineNum">     608 </span>[<span class="branchCov" title="Branch 0 was taken 14303 times"> + </span><span class="branchCov" title="Branch 1 was taken 246339 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 11504 times"> + </span><span class="branchCov" title="Branch 3 was taken 2799 times"> + </span>]:<span class="lineCov">     260642 :     return (size &amp;&amp; used &amp;&amp; size &gt; DICT_HT_INITIAL_SIZE &amp;&amp;</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 11226 times"> + </span><span class="branchCov" title="Branch 5 was taken 278 times"> + </span>]
<span class="lineNum">     609 </span>                :<span class="lineCov">      11504 :             (used*100/size &lt; REDIS_HT_MINFILL));</span>
<span class="lineNum">     610 </span>                :            : }
<span class="lineNum">     611 </span>                :            : 
<a name="612"><span class="lineNum">     612 </span>                :            : /* If the percentage of used slots in the HT reaches REDIS_HT_MINFILL</a>
<span class="lineNum">     613 </span>                :            :  * we resize the hash table to save memory */
<span class="lineNum">     614 </span>                :<span class="lineCov">     118832 : void tryResizeHashTables(int dbid) {</span>
<span class="lineNum">     615 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 118831 times"> + </span>]:<span class="lineCov">     118832 :     if (htNeedsResize(server.db[dbid].dict))</span>
<span class="lineNum">     616 </span>                :<span class="lineCov">          1 :         dictResize(server.db[dbid].dict);</span>
<span class="lineNum">     617 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 118830 times"> + </span>]:<span class="lineCov">     118832 :     if (htNeedsResize(server.db[dbid].expires))</span>
<span class="lineNum">     618 </span>                :<span class="lineCov">          2 :         dictResize(server.db[dbid].expires);</span>
<span class="lineNum">     619 </span>                :<span class="lineCov">     118832 : }</span>
<span class="lineNum">     620 </span>                :            : 
<span class="lineNum">     621 </span>                :            : /* Our hash table implementation performs rehashing incrementally while
<span class="lineNum">     622 </span>                :            :  * we write/read from the hash table. Still if the server is idle, the hash
<span class="lineNum">     623 </span>                :            :  * table will use two tables for a long time. So we try to use 1 millisecond
<span class="lineNum">     624 </span>                :            :  * of CPU time at every call of this function to perform some rehahsing.
<span class="lineNum">     625 </span>                :            :  *
<a name="626"><span class="lineNum">     626 </span>                :            :  * The function returns 1 if some rehashing was performed, otherwise 0</a>
<span class="lineNum">     627 </span>                :            :  * is returned. */
<span class="lineNum">     628 </span>                :<span class="lineCov">     117849 : int incrementallyRehash(int dbid) {</span>
<span class="lineNum">     629 </span>                :            :     /* Keys dictionary */
<span class="lineNum">     630 </span>        [<span class="branchCov" title="Branch 0 was taken 272 times"> + </span><span class="branchCov" title="Branch 1 was taken 117577 times"> + </span>]:<span class="lineCov">     117849 :     if (dictIsRehashing(server.db[dbid].dict)) {</span>
<span class="lineNum">     631 </span>                :<span class="lineCov">        272 :         dictRehashMilliseconds(server.db[dbid].dict,1);</span>
<span class="lineNum">     632 </span>                :<span class="lineCov">        272 :         return 1; /* already used our millisecond for this loop... */</span>
<span class="lineNum">     633 </span>                :            :     }
<span class="lineNum">     634 </span>                :            :     /* Expires */
<span class="lineNum">     635 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 117573 times"> + </span>]:<span class="lineCov">     117577 :     if (dictIsRehashing(server.db[dbid].expires)) {</span>
<span class="lineNum">     636 </span>                :<span class="lineCov">          4 :         dictRehashMilliseconds(server.db[dbid].expires,1);</span>
<span class="lineNum">     637 </span>                :<span class="lineCov">     117849 :         return 1; /* already used our millisecond for this loop... */</span>
<span class="lineNum">     638 </span>                :            :     }
<span class="lineNum">     639 </span>                :            :     return 0;
<span class="lineNum">     640 </span>                :            : }
<span class="lineNum">     641 </span>                :            : 
<span class="lineNum">     642 </span>                :            : /* This function is called once a background process of some kind terminates,
<span class="lineNum">     643 </span>                :            :  * as we want to avoid resizing the hash tables when there is a child in order
<span class="lineNum">     644 </span>                :            :  * to play well with copy-on-write (otherwise when a resize happens lots of
<span class="lineNum">     645 </span>                :            :  * memory pages are copied). The goal of this function is to update the ability
<a name="646"><span class="lineNum">     646 </span>                :            :  * for dict.c to resize the hash tables accordingly to the fact we have o not</a>
<span class="lineNum">     647 </span>                :            :  * running childs. */
<span class="lineNum">     648 </span>                :<span class="lineCov">        533 : void updateDictResizePolicy(void) {</span>
<span class="lineNum">     649 </span>[<span class="branchCov" title="Branch 0 was taken 489 times"> + </span><span class="branchCov" title="Branch 1 was taken 44 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 257 times"> + </span><span class="branchCov" title="Branch 3 was taken 232 times"> + </span>]:<span class="lineCov">        533 :     if (server.rdb_child_pid == -1 &amp;&amp; server.aof_child_pid == -1)</span>
<span class="lineNum">     650 </span>                :<span class="lineCov">        257 :         dictEnableResize();</span>
<span class="lineNum">     651 </span>                :            :     else
<span class="lineNum">     652 </span>                :<span class="lineCov">        276 :         dictDisableResize();</span>
<span class="lineNum">     653 </span>                :<span class="lineCov">        533 : }</span>
<span class="lineNum">     654 </span>                :            : 
<span class="lineNum">     655 </span>                :            : /* ======================= Cron: called every 100 ms ======================== */
<span class="lineNum">     656 </span>                :            : 
<span class="lineNum">     657 </span>                :            : /* Helper function for the activeExpireCycle() function.
<span class="lineNum">     658 </span>                :            :  * This function will try to expire the key that is stored in the hash table
<span class="lineNum">     659 </span>                :            :  * entry 'de' of the 'expires' hash table of a Redis database.
<span class="lineNum">     660 </span>                :            :  *
<span class="lineNum">     661 </span>                :            :  * If the key is found to be expired, it is removed from the database and
<span class="lineNum">     662 </span>                :            :  * 1 is returned. Otherwise no operation is performed and 0 is returned.
<span class="lineNum">     663 </span>                :            :  *
<span class="lineNum">     664 </span>                :            :  * When a key is expired, server.stat_expiredkeys is incremented.
<span class="lineNum">     665 </span>                :            :  *
<a name="666"><span class="lineNum">     666 </span>                :            :  * The parameter 'now' is the current time in milliseconds as is passed</a>
<span class="lineNum">     667 </span>                :            :  * to the function to avoid too many gettimeofday() syscalls. */
<span class="lineNum">     668 </span>                :<span class="lineCov">       2546 : int activeExpireCycleTryExpire(redisDb *db, struct dictEntry *de, long long now) {</span>
<span class="lineNum">     669 </span>                :<span class="lineCov">       2546 :     long long t = dictGetSignedIntegerVal(de);</span>
<span class="lineNum">     670 </span>        [<span class="branchCov" title="Branch 0 was taken 27 times"> + </span><span class="branchCov" title="Branch 1 was taken 2519 times"> + </span>]:<span class="lineCov">       2546 :     if (now &gt; t) {</span>
<span class="lineNum">     671 </span>                :<span class="lineCov">         27 :         sds key = dictGetKey(de);</span>
<span class="lineNum">     672 </span>                :<span class="lineCov">         27 :         robj *keyobj = createStringObject(key,sdslen(key));</span>
<span class="lineNum">     673 </span>                :            : 
<span class="lineNum">     674 </span>                :<span class="lineCov">         27 :         propagateExpire(db,keyobj);</span>
<span class="lineNum">     675 </span>                :<span class="lineCov">         27 :         dbDelete(db,keyobj);</span>
<span class="lineNum">     676 </span>                :<span class="lineCov">         27 :         notifyKeyspaceEvent(REDIS_NOTIFY_EXPIRED,</span>
<span class="lineNum">     677 </span>                :            :             &quot;expired&quot;,keyobj,db-&gt;id);
<span class="lineNum">     678 </span>                :<span class="lineCov">         27 :         decrRefCount(keyobj);</span>
<span class="lineNum">     679 </span>                :<span class="lineCov">         27 :         server.stat_expiredkeys++;</span>
<span class="lineNum">     680 </span>                :<span class="lineCov">       2546 :         return 1;</span>
<span class="lineNum">     681 </span>                :            :     } else {
<span class="lineNum">     682 </span>                :            :         return 0;
<span class="lineNum">     683 </span>                :            :     }
<span class="lineNum">     684 </span>                :            : }
<span class="lineNum">     685 </span>                :            : 
<span class="lineNum">     686 </span>                :            : /* Try to expire a few timed out keys. The algorithm used is adaptive and
<span class="lineNum">     687 </span>                :            :  * will use few CPU cycles if there are few expiring keys, otherwise
<span class="lineNum">     688 </span>                :            :  * it will get more aggressive to avoid that too much memory is used by
<span class="lineNum">     689 </span>                :            :  * keys that can be removed from the keyspace.
<span class="lineNum">     690 </span>                :            :  *
<span class="lineNum">     691 </span>                :            :  * No more than REDIS_DBCRON_DBS_PER_CALL databases are tested at every
<span class="lineNum">     692 </span>                :            :  * iteration.
<span class="lineNum">     693 </span>                :            :  *
<span class="lineNum">     694 </span>                :            :  * This kind of call is used when Redis detects that timelimit_exit is
<span class="lineNum">     695 </span>                :            :  * true, so there is more work to do, and we do it more incrementally from
<span class="lineNum">     696 </span>                :            :  * the beforeSleep() function of the event loop.
<span class="lineNum">     697 </span>                :            :  *
<span class="lineNum">     698 </span>                :            :  * Expire cycle type:
<span class="lineNum">     699 </span>                :            :  *
<span class="lineNum">     700 </span>                :            :  * If type is ACTIVE_EXPIRE_CYCLE_FAST the function will try to run a
<span class="lineNum">     701 </span>                :            :  * &quot;fast&quot; expire cycle that takes no longer than EXPIRE_FAST_CYCLE_DURATION
<span class="lineNum">     702 </span>                :            :  * microseconds, and is not repeated again before the same amount of time.
<span class="lineNum">     703 </span>                :            :  *
<span class="lineNum">     704 </span>                :            :  * If type is ACTIVE_EXPIRE_CYCLE_SLOW, that normal expire cycle is
<span class="lineNum">     705 </span>                :            :  * executed, where the time limit is a percentage of the REDIS_HZ period
<a name="706"><span class="lineNum">     706 </span>                :            :  * as specified by the REDIS_EXPIRELOOKUPS_TIME_PERC define. */</a>
<span class="lineNum">     707 </span>                :            : 
<span class="lineNum">     708 </span>                :<span class="lineCov">    4191277 : void activeExpireCycle(int type) {</span>
<span class="lineNum">     709 </span>                :            :     /* This function has some global state in order to continue the work
<span class="lineNum">     710 </span>                :            :      * incrementally across calls. */
<span class="lineNum">     711 </span>                :            :     static unsigned int current_db = 0; /* Last DB tested. */
<span class="lineNum">     712 </span>                :            :     static int timelimit_exit = 0;      /* Time limit hit in previous call? */
<span class="lineNum">     713 </span>                :            :     static long long last_fast_cycle = 0; /* When last fast cycle ran. */
<span class="lineNum">     714 </span>                :            : 
<span class="lineNum">     715 </span>                :<span class="lineCov">    4191277 :     unsigned int j, iteration = 0;</span>
<span class="lineNum">     716 </span>                :<span class="lineCov">    4191277 :     unsigned int dbs_per_call = REDIS_DBCRON_DBS_PER_CALL;</span>
<span class="lineNum">     717 </span>                :<span class="lineCov">    4191277 :     long long start = ustime(), timelimit;</span>
<span class="lineNum">     718 </span>                :            : 
<span class="lineNum">     719 </span>        [<span class="branchCov" title="Branch 0 was taken 4185104 times"> + </span><span class="branchCov" title="Branch 1 was taken 6173 times"> + </span>]:<span class="lineCov">    4191277 :     if (type == ACTIVE_EXPIRE_CYCLE_FAST) {</span>
<span class="lineNum">     720 </span>                :            :         /* Don't start a fast cycle if the previous cycle did not exited
<span class="lineNum">     721 </span>                :            :          * for time limt. Also don't repeat a fast cycle for the same period
<span class="lineNum">     722 </span>                :            :          * as the fast cycle total duration itself. */
<span class="lineNum">     723 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4185104 times"> + </span>]:<span class="lineCov">    4185104 :         if (!timelimit_exit) return;</span>
<span class="lineNum">     724 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (start &lt; last_fast_cycle + ACTIVE_EXPIRE_CYCLE_FAST_DURATION*2) return;</span>
<span class="lineNum">     725 </span>                :<span class="lineNoCov">          0 :         last_fast_cycle = start;</span>
<span class="lineNum">     726 </span>                :            :     }
<span class="lineNum">     727 </span>                :            : 
<span class="lineNum">     728 </span>                :            :     /* We usually should test REDIS_DBCRON_DBS_PER_CALL per iteration, with
<span class="lineNum">     729 </span>                :            :      * two exceptions:
<span class="lineNum">     730 </span>                :            :      *
<span class="lineNum">     731 </span>                :            :      * 1) Don't test more DBs than we have.
<span class="lineNum">     732 </span>                :            :      * 2) If last time we hit the time limit, we want to scan all DBs
<span class="lineNum">     733 </span>                :            :      * in this iteration, as there is work to do in some DB and we don't want
<span class="lineNum">     734 </span>                :            :      * expired keys to use memory for too much time. */
<span class="lineNum">     735 </span>[<span class="branchCov" title="Branch 0 was taken 6173 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 6173 times"> + </span>]:<span class="lineCov">       6173 :     if (dbs_per_call &gt; server.dbnum || timelimit_exit)</span>
<span class="lineNum">     736 </span>                :<span class="lineNoCov">          0 :         dbs_per_call = server.dbnum;</span>
<span class="lineNum">     737 </span>                :            : 
<span class="lineNum">     738 </span>                :            :     /* We can use at max ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC percentage of CPU time
<span class="lineNum">     739 </span>                :            :      * per iteration. Since this function gets called with a frequency of
<span class="lineNum">     740 </span>                :            :      * server.hz times per second, the following is the max amount of
<span class="lineNum">     741 </span>                :            :      * microseconds we can spend in this function. */
<span class="lineNum">     742 </span>                :<span class="lineCov">       6173 :     timelimit = 1000000*ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC/server.hz/100;</span>
<span class="lineNum">     743 </span>                :<span class="lineCov">       6173 :     timelimit_exit = 0;</span>
<span class="lineNum">     744 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 6173 times"> + </span>]:<span class="lineCov">       6173 :     if (timelimit &lt;= 0) timelimit = 1;</span>
<span class="lineNum">     745 </span>                :            : 
<span class="lineNum">     746 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 6173 times"> + </span>]:<span class="lineCov">       6173 :     if (type == ACTIVE_EXPIRE_CYCLE_FAST)</span>
<span class="lineNum">     747 </span>                :<span class="lineNoCov">          0 :         timelimit = ACTIVE_EXPIRE_CYCLE_FAST_DURATION; /* in microseconds. */</span>
<span class="lineNum">     748 </span>                :            : 
<span class="lineNum">     749 </span>        [<span class="branchCov" title="Branch 0 was taken 98768 times"> + </span><span class="branchCov" title="Branch 1 was taken 6173 times"> + </span>]:<span class="lineCov">    4290045 :     for (j = 0; j &lt; dbs_per_call; j++) {</span>
<span class="lineNum">     750 </span>                :            :         int expired;
<span class="lineNum">     751 </span>                :<span class="lineCov">      98768 :         redisDb *db = server.db+(current_db % server.dbnum);</span>
<span class="lineNum">     752 </span>                :            : 
<span class="lineNum">     753 </span>                :            :         /* Increment the DB now so we are sure if we run out of time
<span class="lineNum">     754 </span>                :            :          * in the current DB we'll restart from the next. This allows to
<span class="lineNum">     755 </span>                :            :          * distribute the time evenly across DBs. */
<span class="lineNum">     756 </span>                :<span class="lineCov">      98768 :         current_db++;</span>
<span class="lineNum">     757 </span>                :            : 
<span class="lineNum">     758 </span>                :            :         /* Continue to expire if at the end of the cycle more than 25%
<span class="lineNum">     759 </span>                :            :          * of the keys were expired. */
<span class="lineNum">     760 </span>                :            :         do {
<span class="lineNum">     761 </span>                :            :             unsigned long num, slots;
<span class="lineNum">     762 </span>                :            :             long long now, ttl_sum;
<span class="lineNum">     763 </span>                :            :             int ttl_samples;
<span class="lineNum">     764 </span>                :            : 
<span class="lineNum">     765 </span>                :            :             /* If there is nothing to expire try next DB ASAP. */
<span class="lineNum">     766 </span>        [<span class="branchCov" title="Branch 0 was taken 98436 times"> + </span><span class="branchCov" title="Branch 1 was taken 332 times"> + </span>]:<span class="lineCov">      98768 :             if ((num = dictSize(db-&gt;expires)) == 0) {</span>
<span class="lineNum">     767 </span>                :<span class="lineCov">      98436 :                 db-&gt;avg_ttl = 0;</span>
<span class="lineNum">     768 </span>                :<span class="lineCov">      98436 :                 break;</span>
<span class="lineNum">     769 </span>                :            :             }
<span class="lineNum">     770 </span>                :<span class="lineCov">        332 :             slots = dictSlots(db-&gt;expires);</span>
<span class="lineNum">     771 </span>                :<span class="lineCov">        332 :             now = mstime();</span>
<span class="lineNum">     772 </span>                :            : 
<span class="lineNum">     773 </span>                :            :             /* When there are less than 1% filled slots getting random
<span class="lineNum">     774 </span>                :            :              * keys is expensive, so stop here waiting for better times...
<span class="lineNum">     775 </span>                :            :              * The dictionary will be resized asap. */
<span class="lineNum">     776 </span>[<span class="branchCov" title="Branch 0 was taken 117 times"> + </span><span class="branchCov" title="Branch 1 was taken 215 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 117 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">        332 :             if (num &amp;&amp; slots &gt; DICT_HT_INITIAL_SIZE &amp;&amp;</span>
<span class="lineNum">     777 </span>                :<span class="lineCov">        117 :                 (num*100/slots &lt; 1)) break;</span>
<span class="lineNum">     778 </span>                :            : 
<span class="lineNum">     779 </span>                :            :             /* The main collection cycle. Sample random keys among keys
<span class="lineNum">     780 </span>                :            :              * with an expire set, checking for expired ones. */
<span class="lineNum">     781 </span>                :<span class="lineCov">        332 :             expired = 0;</span>
<span class="lineNum">     782 </span>                :<span class="lineCov">        332 :             ttl_sum = 0;</span>
<span class="lineNum">     783 </span>                :<span class="lineCov">        332 :             ttl_samples = 0;</span>
<span class="lineNum">     784 </span>                :            : 
<span class="lineNum">     785 </span>        [<span class="branchCov" title="Branch 0 was taken 100 times"> + </span><span class="branchCov" title="Branch 1 was taken 232 times"> + </span>]:<span class="lineCov">        332 :             if (num &gt; ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP)</span>
<span class="lineNum">     786 </span>                :<span class="lineCov">        332 :                 num = ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP;</span>
<span class="lineNum">     787 </span>                :            : 
<span class="lineNum">     788 </span>        [<span class="branchCov" title="Branch 0 was taken 2546 times"> + </span><span class="branchCov" title="Branch 1 was taken 332 times"> + </span>]:<span class="lineCov">       2878 :             while (num--) {</span>
<span class="lineNum">     789 </span>                :            :                 dictEntry *de;
<span class="lineNum">     790 </span>                :            :                 long long ttl;
<span class="lineNum">     791 </span>                :            : 
<span class="lineNum">     792 </span>        [<span class="branchCov" title="Branch 1 was taken 2546 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       2546 :                 if ((de = dictGetRandomKey(db-&gt;expires)) == NULL) break;</span>
<span class="lineNum">     793 </span>                :<span class="lineCov">       2546 :                 ttl = dictGetSignedIntegerVal(de)-now;</span>
<span class="lineNum">     794 </span>        [<span class="branchCov" title="Branch 1 was taken 27 times"> + </span><span class="branchCov" title="Branch 2 was taken 2519 times"> + </span>]:<span class="lineCov">       2546 :                 if (activeExpireCycleTryExpire(db,de,now)) expired++;</span>
<span class="lineNum">     795 </span>        [<span class="branchCov" title="Branch 0 was taken 27 times"> + </span><span class="branchCov" title="Branch 1 was taken 2519 times"> + </span>]:<span class="lineCov">       2546 :                 if (ttl &lt; 0) ttl = 0;</span>
<span class="lineNum">     796 </span>                :<span class="lineCov">       2546 :                 ttl_sum += ttl;</span>
<span class="lineNum">     797 </span>                :<span class="lineCov">       2546 :                 ttl_samples++;</span>
<span class="lineNum">     798 </span>                :            :             }
<span class="lineNum">     799 </span>                :            : 
<span class="lineNum">     800 </span>                :            :             /* Update the average TTL stats for this database. */
<span class="lineNum">     801 </span>        [<span class="branchCov" title="Branch 0 was taken 332 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        332 :             if (ttl_samples) {</span>
<span class="lineNum">     802 </span>                :<span class="lineCov">        332 :                 long long avg_ttl = ttl_sum/ttl_samples;</span>
<span class="lineNum">     803 </span>                :            : 
<span class="lineNum">     804 </span>        [<span class="branchCov" title="Branch 0 was taken 19 times"> + </span><span class="branchCov" title="Branch 1 was taken 313 times"> + </span>]:<span class="lineCov">        332 :                 if (db-&gt;avg_ttl == 0) db-&gt;avg_ttl = avg_ttl;</span>
<span class="lineNum">     805 </span>                :            :                 /* Smooth the value averaging with the previous one. */
<span class="lineNum">     806 </span>                :<span class="lineCov">        332 :                 db-&gt;avg_ttl = (db-&gt;avg_ttl+avg_ttl)/2;</span>
<span class="lineNum">     807 </span>                :            :             }
<span class="lineNum">     808 </span>                :            : 
<span class="lineNum">     809 </span>                :            :             /* We can't block forever here even if there are many keys to
<span class="lineNum">     810 </span>                :            :              * expire. So after a given amount of milliseconds return to the
<span class="lineNum">     811 </span>                :            :              * caller waiting for the other active expire cycle. */
<span class="lineNum">     812 </span>                :<span class="lineCov">        332 :             iteration++;</span>
<span class="lineNum">     813 </span>  [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 332 times"> + </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">        332 :             if ((iteration &amp; 0xf) == 0 &amp;&amp; /* check once every 16 iterations. */</span>
<span class="lineNum">     814 </span>                :<span class="lineNoCov">          0 :                 (ustime()-start) &gt; timelimit)</span>
<span class="lineNum">     815 </span>                :            :             {
<span class="lineNum">     816 </span>                :<span class="lineNoCov">          0 :                 timelimit_exit = 1;</span>
<span class="lineNum">     817 </span>                :            :             }
<span class="lineNum">     818 </span>        [<span class="branchCov" title="Branch 0 was taken 332 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        332 :             if (timelimit_exit) return;</span>
<span class="lineNum">     819 </span>                :            :             /* We don't repeat the cycle if there are less than 25% of keys
<span class="lineNum">     820 </span>                :            :              * found expired in the current DB. */
<span class="lineNum">     821 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 332 times"> + </span>]:<span class="lineCov">        332 :         } while (expired &gt; ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP/4);</span>
<span class="lineNum">     822 </span>                :            :     }
<a name="823"><span class="lineNum">     823 </span>                :            : }</a>
<a name="824"><span class="lineNum">     824 </span>                :            : </a>
<span class="lineNum">     825 </span>                :<span class="lineNoCov">          0 : void updateLRUClock(void) {</span>
<span class="lineNum">     826 </span>                :<span class="lineCov">       7921 :     server.lruclock = (server.unixtime/REDIS_LRU_CLOCK_RESOLUTION) &amp;</span>
<span class="lineNum">     827 </span>                :            :                                                 REDIS_LRU_CLOCK_MAX;
<span class="lineNum">     828 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     829 </span>                :            : 
<a name="830"><span class="lineNum">     830 </span>                :            : </a>
<span class="lineNum">     831 </span>                :            : /* Add a sample to the operations per second array of samples. */
<span class="lineNum">     832 </span>                :<span class="lineCov">       7790 : void trackOperationsPerSecond(void) {</span>
<span class="lineNum">     833 </span>                :<span class="lineCov">       7790 :     long long t = mstime() - server.ops_sec_last_sample_time;</span>
<span class="lineNum">     834 </span>                :<span class="lineCov">       7790 :     long long ops = server.stat_numcommands - server.ops_sec_last_sample_ops;</span>
<span class="lineNum">     835 </span>                :            :     long long ops_sec;
<span class="lineNum">     836 </span>                :            : 
<span class="lineNum">     837 </span>        [<span class="branchCov" title="Branch 0 was taken 7790 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       7790 :     ops_sec = t &gt; 0 ? (ops*1000/t) : 0;</span>
<span class="lineNum">     838 </span>                :            : 
<span class="lineNum">     839 </span>                :<span class="lineCov">       7790 :     server.ops_sec_samples[server.ops_sec_idx] = ops_sec;</span>
<span class="lineNum">     840 </span>                :<span class="lineCov">       7790 :     server.ops_sec_idx = (server.ops_sec_idx+1) % REDIS_OPS_SEC_SAMPLES;</span>
<span class="lineNum">     841 </span>                :<span class="lineCov">       7790 :     server.ops_sec_last_sample_time = mstime();</span>
<span class="lineNum">     842 </span>                :<span class="lineCov">       7790 :     server.ops_sec_last_sample_ops = server.stat_numcommands;</span>
<span class="lineNum">     843 </span>                :<span class="lineCov">       7790 : }</span>
<a name="844"><span class="lineNum">     844 </span>                :            : </a>
<span class="lineNum">     845 </span>                :            : /* Return the mean of all the samples. */
<a name="846"><span class="lineNum">     846 </span>                :<span class="lineNoCov">          0 : long long getOperationsPerSecond(void) {</span></a>
<span class="lineNum">     847 </span>                :            :     int j;
<span class="lineNum">     848 </span>                :<span class="lineCov">       9672 :     long long sum = 0;</span>
<span class="lineNum">     849 </span>                :            : 
<span class="lineNum">     850 </span>[<span class="branchCov" title="Branch 0 was taken 154752 times"> + </span><span class="branchCov" title="Branch 1 was taken 9672 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     164424 :     for (j = 0; j &lt; REDIS_OPS_SEC_SAMPLES; j++)</span>
<span class="lineNum">     851 </span>                :<span class="lineCov">     154752 :         sum += server.ops_sec_samples[j];</span>
<span class="lineNum">     852 </span>                :<span class="lineNoCov">          0 :     return sum / REDIS_OPS_SEC_SAMPLES;</span>
<span class="lineNum">     853 </span>                :            : }
<a name="854"><span class="lineNum">     854 </span>                :            : </a>
<span class="lineNum">     855 </span>                :            : /* Check for timeouts. Returns non-zero if the client was terminated */
<span class="lineNum">     856 </span>                :<span class="lineCov">      17892 : int clientsCronHandleTimeout(redisClient *c) {</span>
<span class="lineNum">     857 </span>                :<span class="lineCov">      17892 :     time_t now = server.unixtime;</span>
<span class="lineNum">     858 </span>                :            : 
<span class="lineNum">     859 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 17892 times"> + </span>]:<span class="lineCov">      17892 :     if (server.maxidletime &amp;&amp;</span>
<span class="lineNum">     860 </span>                :            :         !(c-&gt;flags &amp; REDIS_SLAVE) &amp;&amp;    /* no timeout for slaves */
<span class="lineNum">     861 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         !(c-&gt;flags &amp; REDIS_MASTER) &amp;&amp;   /* no timeout for masters */</span>
<span class="lineNum">     862 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         !(c-&gt;flags &amp; REDIS_BLOCKED) &amp;&amp;  /* no timeout for BLPOP */</span>
<span class="lineNum">     863 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         dictSize(c-&gt;pubsub_channels) == 0 &amp;&amp; /* no timeout for pubsub */</span>
<span class="lineNum">     864 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         listLength(c-&gt;pubsub_patterns) == 0 &amp;&amp;</span>
<span class="lineNum">     865 </span>                :<span class="lineNoCov">          0 :         (now - c-&gt;lastinteraction &gt; server.maxidletime))</span>
<span class="lineNum">     866 </span>                :            :     {
<span class="lineNum">     867 </span>                :<span class="lineNoCov">          0 :         redisLog(REDIS_VERBOSE,&quot;Closing idle client&quot;);</span>
<span class="lineNum">     868 </span>                :<span class="lineNoCov">          0 :         freeClient(c);</span>
<span class="lineNum">     869 </span>                :<span class="lineNoCov">          0 :         return 1;</span>
<span class="lineNum">     870 </span>        [<span class="branchCov" title="Branch 0 was taken 134 times"> + </span><span class="branchCov" title="Branch 1 was taken 17758 times"> + </span>]:<span class="lineCov">      17892 :     } else if (c-&gt;flags &amp; REDIS_BLOCKED) {</span>
<span class="lineNum">     871 </span>[<span class="branchCov" title="Branch 0 was taken 53 times"> + </span><span class="branchCov" title="Branch 1 was taken 81 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 3 times"> + </span><span class="branchCov" title="Branch 3 was taken 50 times"> + </span>]:<span class="lineCov">        134 :         if (c-&gt;bpop.timeout != 0 &amp;&amp; c-&gt;bpop.timeout &lt; now) {</span>
<span class="lineNum">     872 </span>                :<span class="lineCov">          3 :             addReply(c,shared.nullmultibulk);</span>
<span class="lineNum">     873 </span>                :<span class="lineCov">      17892 :             unblockClientWaitingData(c);</span>
<span class="lineNum">     874 </span>                :            :         }
<span class="lineNum">     875 </span>                :            :     }
<span class="lineNum">     876 </span>                :            :     return 0;
<span class="lineNum">     877 </span>                :            : }
<span class="lineNum">     878 </span>                :            : 
<span class="lineNum">     879 </span>                :            : /* The client query buffer is an sds.c string that can end with a lot of
<span class="lineNum">     880 </span>                :            :  * free space not used, this function reclaims space if needed.
<a name="881"><span class="lineNum">     881 </span>                :            :  *</a>
<span class="lineNum">     882 </span>                :            :  * The function always returns 0 as it never terminates the client. */
<span class="lineNum">     883 </span>                :<span class="lineCov">      17892 : int clientsCronResizeQueryBuffer(redisClient *c) {</span>
<span class="lineNum">     884 </span>                :<span class="lineCov">      17892 :     size_t querybuf_size = sdsAllocSize(c-&gt;querybuf);</span>
<span class="lineNum">     885 </span>                :<span class="lineCov">      17892 :     time_t idletime = server.unixtime - c-&gt;lastinteraction;</span>
<span class="lineNum">     886 </span>                :            : 
<span class="lineNum">     887 </span>                :            :     /* There are two conditions to resize the query buffer:
<span class="lineNum">     888 </span>                :            :      * 1) Query buffer is &gt; BIG_ARG and too big for latest peak.
<span class="lineNum">     889 </span>                :            :      * 2) Client is inactive and the buffer is bigger than 1k. */
<span class="lineNum">     890 </span>[<span class="branchCov" title="Branch 0 was taken 5949 times"> + </span><span class="branchCov" title="Branch 1 was taken 11943 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 106 times"> + </span><span class="branchCov" title="Branch 3 was taken 5843 times"> + </span>]:<span class="lineCov">      17892 :     if (((querybuf_size &gt; REDIS_MBULK_BIG_ARG) &amp;&amp;</span>
<span class="lineNum">     891 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 12049 times"> + </span>]:<span class="lineCov">      12049 :          (querybuf_size/(c-&gt;querybuf_peak+1)) &gt; 2) ||</span>
<span class="lineNum">     892 </span>                :<span class="lineCov">      12049 :          (querybuf_size &gt; 1024 &amp;&amp; idletime &gt; 2))</span>
<span class="lineNum">     893 </span>                :            :     {
<span class="lineNum">     894 </span>                :            :         /* Only resize the query buffer if it is actually wasting space. */
<span class="lineNum">     895 </span>        [<span class="branchCov" title="Branch 0 was taken 5843 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       5843 :         if (sdsavail(c-&gt;querybuf) &gt; 1024) {</span>
<span class="lineNum">     896 </span>                :<span class="lineCov">       5843 :             c-&gt;querybuf = sdsRemoveFreeSpace(c-&gt;querybuf);</span>
<span class="lineNum">     897 </span>                :            :         }
<span class="lineNum">     898 </span>                :            :     }
<span class="lineNum">     899 </span>                :            :     /* Reset the peak again to capture the peak memory usage in the next
<span class="lineNum">     900 </span>                :            :      * cycle. */
<span class="lineNum">     901 </span>                :<span class="lineCov">      17892 :     c-&gt;querybuf_peak = 0;</span>
<span class="lineNum">     902 </span>                :<span class="lineCov">      17892 :     return 0;</span>
<a name="903"><span class="lineNum">     903 </span>                :            : }</a>
<span class="lineNum">     904 </span>                :            : 
<span class="lineNum">     905 </span>                :<span class="lineCov">       7716 : void clientsCron(void) {</span>
<span class="lineNum">     906 </span>                :            :     /* Make sure to process at least 1/(server.hz*10) of clients per call.
<span class="lineNum">     907 </span>                :            :      * Since this function is called server.hz times per second we are sure that
<span class="lineNum">     908 </span>                :            :      * in the worst case we process all the clients in 10 seconds.
<span class="lineNum">     909 </span>                :            :      * In normal conditions (a reasonable number of clients) we process
<span class="lineNum">     910 </span>                :            :      * all the clients in a shorter time. */
<span class="lineNum">     911 </span>                :<span class="lineCov">       7716 :     int numclients = listLength(server.clients);</span>
<span class="lineNum">     912 </span>                :<span class="lineCov">       7716 :     int iterations = numclients/(server.hz*10);</span>
<span class="lineNum">     913 </span>                :            : 
<span class="lineNum">     914 </span>        [<span class="branchCov" title="Branch 0 was taken 7716 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       7716 :     if (iterations &lt; 50)</span>
<span class="lineNum">     915 </span>                :<span class="lineCov">       7716 :         iterations = (numclients &lt; 50) ? numclients : 50;</span>
<span class="lineNum">     916 </span>[<span class="branchCov" title="Branch 0 was taken 25353 times"> + </span><span class="branchCov" title="Branch 1 was taken 255 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 17892 times"> + </span><span class="branchCov" title="Branch 3 was taken 7461 times"> + </span>]:<span class="lineCov">      25608 :     while(listLength(server.clients) &amp;&amp; iterations--) {</span>
<span class="lineNum">     917 </span>                :            :         redisClient *c;
<span class="lineNum">     918 </span>                :            :         listNode *head;
<span class="lineNum">     919 </span>                :            : 
<span class="lineNum">     920 </span>                :            :         /* Rotate the list, take the current head, process.
<span class="lineNum">     921 </span>                :            :          * This way if the client must be removed from the list it's the
<span class="lineNum">     922 </span>                :            :          * first element and we don't incur into O(N) computation. */
<span class="lineNum">     923 </span>                :<span class="lineCov">      17892 :         listRotate(server.clients);</span>
<span class="lineNum">     924 </span>                :<span class="lineCov">      17892 :         head = listFirst(server.clients);</span>
<span class="lineNum">     925 </span>                :<span class="lineCov">      17892 :         c = listNodeValue(head);</span>
<span class="lineNum">     926 </span>                :            :         /* The following functions do different service checks on the client.
<span class="lineNum">     927 </span>                :            :          * The protocol is that they return non-zero if the client was
<span class="lineNum">     928 </span>                :            :          * terminated. */
<span class="lineNum">     929 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 17892 times"> + </span>]:<span class="lineCov">      17892 :         if (clientsCronHandleTimeout(c)) continue;</span>
<span class="lineNum">     930 </span>                :<span class="lineCov">      17892 :         if (clientsCronResizeQueryBuffer(c)) continue;</span>
<span class="lineNum">     931 </span>                :            :     }
<span class="lineNum">     932 </span>                :<span class="lineCov">       7716 : }</span>
<span class="lineNum">     933 </span>                :            : 
<span class="lineNum">     934 </span>                :            : /* This function handles 'background' operations we are required to do
<a name="935"><span class="lineNum">     935 </span>                :            :  * incrementally in Redis databases, such as active key expiring, resizing,</a>
<span class="lineNum">     936 </span>                :            :  * rehashing. */
<span class="lineNum">     937 </span>                :<span class="lineCov">       7716 : void databasesCron(void) {</span>
<span class="lineNum">     938 </span>                :            :     /* Expire keys by random sampling. Not required for slaves
<span class="lineNum">     939 </span>                :            :      * as master will synthesize DELs for us. */
<span class="lineNum">     940 </span>[<span class="branchCov" title="Branch 0 was taken 7696 times"> + </span><span class="branchCov" title="Branch 1 was taken 20 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 6173 times"> + </span><span class="branchCov" title="Branch 3 was taken 1523 times"> + </span>]:<span class="lineCov">       7716 :     if (server.active_expire_enabled &amp;&amp; server.masterhost == NULL)</span>
<span class="lineNum">     941 </span>                :<span class="lineCov">       6173 :         activeExpireCycle(ACTIVE_EXPIRE_CYCLE_SLOW);</span>
<span class="lineNum">     942 </span>                :            : 
<span class="lineNum">     943 </span>                :            :     /* Perform hash tables rehashing if needed, but only if there are no
<span class="lineNum">     944 </span>                :            :      * other processes saving the DB on disk. Otherwise rehashing is bad
<span class="lineNum">     945 </span>                :            :      * as will cause a lot of copy-on-write of memory pages. */
<span class="lineNum">     946 </span>[<span class="branchCov" title="Branch 0 was taken 7658 times"> + </span><span class="branchCov" title="Branch 1 was taken 58 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 7427 times"> + </span><span class="branchCov" title="Branch 3 was taken 231 times"> + </span>]:<span class="lineCov">       7716 :     if (server.rdb_child_pid == -1 &amp;&amp; server.aof_child_pid == -1) {</span>
<span class="lineNum">     947 </span>                :            :         /* We use global counters so if we stop the computation at a given
<span class="lineNum">     948 </span>                :            :          * DB we'll be able to start from the successive in the next
<span class="lineNum">     949 </span>                :            :          * cron loop iteration. */
<span class="lineNum">     950 </span>                :            :         static unsigned int resize_db = 0;
<span class="lineNum">     951 </span>                :            :         static unsigned int rehash_db = 0;
<span class="lineNum">     952 </span>                :<span class="lineCov">       7427 :         unsigned int dbs_per_call = REDIS_DBCRON_DBS_PER_CALL;</span>
<span class="lineNum">     953 </span>                :            :         unsigned int j;
<span class="lineNum">     954 </span>                :            : 
<span class="lineNum">     955 </span>                :            :         /* Don't test more DBs than we have. */
<span class="lineNum">     956 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7427 times"> + </span>]:<span class="lineCov">       7427 :         if (dbs_per_call &gt; server.dbnum) dbs_per_call = server.dbnum;</span>
<span class="lineNum">     957 </span>                :            : 
<span class="lineNum">     958 </span>                :            :         /* Resize */
<span class="lineNum">     959 </span>        [<span class="branchCov" title="Branch 0 was taken 118832 times"> + </span><span class="branchCov" title="Branch 1 was taken 7427 times"> + </span>]:<span class="lineCov">     126259 :         for (j = 0; j &lt; dbs_per_call; j++) {</span>
<span class="lineNum">     960 </span>                :<span class="lineCov">     118832 :             tryResizeHashTables(resize_db % server.dbnum);</span>
<span class="lineNum">     961 </span>                :<span class="lineCov">     118832 :             resize_db++;</span>
<span class="lineNum">     962 </span>                :            :         }
<span class="lineNum">     963 </span>                :            : 
<span class="lineNum">     964 </span>                :            :         /* Rehash */
<span class="lineNum">     965 </span>        [<span class="branchCov" title="Branch 0 was taken 7427 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       7427 :         if (server.activerehashing) {</span>
<span class="lineNum">     966 </span>        [<span class="branchCov" title="Branch 0 was taken 117849 times"> + </span><span class="branchCov" title="Branch 1 was taken 7151 times"> + </span>]:<span class="lineCov">     125000 :             for (j = 0; j &lt; dbs_per_call; j++) {</span>
<span class="lineNum">     967 </span>                :<span class="lineCov">     117849 :                 int work_done = incrementallyRehash(rehash_db % server.dbnum);</span>
<span class="lineNum">     968 </span>                :<span class="lineCov">     117849 :                 rehash_db++;</span>
<span class="lineNum">     969 </span>        [<span class="branchCov" title="Branch 0 was taken 117573 times"> + </span><span class="branchCov" title="Branch 1 was taken 276 times"> + </span>]:<span class="lineCov">     117849 :                 if (work_done) {</span>
<span class="lineNum">     970 </span>                :            :                     /* If the function did some work, stop here, we'll do
<span class="lineNum">     971 </span>                :            :                      * more at the next cron loop. */
<span class="lineNum">     972 </span>                :            :                     break;
<span class="lineNum">     973 </span>                :            :                 }
<span class="lineNum">     974 </span>                :            :             }
<span class="lineNum">     975 </span>                :            :         }
<span class="lineNum">     976 </span>                :            :     }
<span class="lineNum">     977 </span>                :<span class="lineCov">       7716 : }</span>
<span class="lineNum">     978 </span>                :            : 
<span class="lineNum">     979 </span>                :            : /* This is our timer interrupt, called server.hz times per second.
<span class="lineNum">     980 </span>                :            :  * Here is where we do a number of things that need to be done asynchronously.
<span class="lineNum">     981 </span>                :            :  * For instance:
<span class="lineNum">     982 </span>                :            :  *
<span class="lineNum">     983 </span>                :            :  * - Active expired keys collection (it is also performed in a lazy way on
<span class="lineNum">     984 </span>                :            :  *   lookup).
<span class="lineNum">     985 </span>                :            :  * - Software watchdog.
<span class="lineNum">     986 </span>                :            :  * - Update some statistic.
<span class="lineNum">     987 </span>                :            :  * - Incremental rehashing of the DBs hash tables.
<span class="lineNum">     988 </span>                :            :  * - Triggering BGSAVE / AOF rewrite, and handling of terminated children.
<span class="lineNum">     989 </span>                :            :  * - Clients timeout of different kinds.
<span class="lineNum">     990 </span>                :            :  * - Replication reconnection.
<span class="lineNum">     991 </span>                :            :  * - Many more...
<span class="lineNum">     992 </span>                :            :  *
<span class="lineNum">     993 </span>                :            :  * Everything directly called here will be called server.hz times per second,
<span class="lineNum">     994 </span>                :            :  * so in order to throttle execution of things we want to do less frequently
<span class="lineNum">     995 </span>                :            :  * a macro is used: run_with_period(milliseconds) { .... }
<span class="lineNum">     996 </span>                :            :  */
<span class="lineNum">     997 </span>                :            : 
<span class="lineNum">     998 </span>                :<span class="lineCov">       7790 : int serverCron(struct aeEventLoop *eventLoop, long long id, void *clientData) {</span>
<span class="lineNum">     999 </span>                :            :     int j;
<span class="lineNum">    1000 </span>                :            :     REDIS_NOTUSED(eventLoop);
<span class="lineNum">    1001 </span>                :            :     REDIS_NOTUSED(id);
<span class="lineNum">    1002 </span>                :            :     REDIS_NOTUSED(clientData);
<span class="lineNum">    1003 </span>                :            : 
<span class="lineNum">    1004 </span>                :            :     /* Software watchdog: deliver the SIGALRM that will reach the signal
<span class="lineNum">    1005 </span>                :            :      * handler if we don't return here fast enough. */
<span class="lineNum">    1006 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7790 times"> + </span>]:<span class="lineCov">       7790 :     if (server.watchdog_period) watchdogScheduleSignal(server.watchdog_period);</span>
<span class="lineNum">    1007 </span>                :            : 
<span class="lineNum">    1008 </span>                :            :     /* We take a cached value of the unix time in the global state because
<span class="lineNum">    1009 </span>                :            :      * with virtual memory and aging there is to store the current time
<span class="lineNum">    1010 </span>                :            :      * in objects at every object access, and accuracy is not needed.
<span class="lineNum">    1011 </span>                :            :      * To access a global var is faster than calling time(NULL) */
<span class="lineNum">    1012 </span>                :<span class="lineCov">       7790 :     server.unixtime = time(NULL);</span>
<span class="lineNum">    1013 </span>                :<span class="lineCov">       7790 :     server.mstime = mstime();</span>
<span class="lineNum">    1014 </span>                :            : 
<span class="lineNum">    1015 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7790 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">       7790 :     run_with_period(100) trackOperationsPerSecond();</span>
<span class="lineNum">    1016 </span>                :            : 
<span class="lineNum">    1017 </span>                :            :     /* We have just 22 bits per object for LRU information.
<span class="lineNum">    1018 </span>                :            :      * So we use an (eventually wrapping) LRU clock with 10 seconds resolution.
<span class="lineNum">    1019 </span>                :            :      * 2^22 bits with 10 seconds resolution is more or less 1.5 years.
<span class="lineNum">    1020 </span>                :            :      *
<span class="lineNum">    1021 </span>                :            :      * Note that even if this will wrap after 1.5 years it's not a problem,
<span class="lineNum">    1022 </span>                :            :      * everything will still work but just some object will appear younger
<span class="lineNum">    1023 </span>                :            :      * to Redis. But for this to happen a given object should never be touched
<span class="lineNum">    1024 </span>                :            :      * for 1.5 years.
<span class="lineNum">    1025 </span>                :            :      *
<span class="lineNum">    1026 </span>                :            :      * Note that you can change the resolution altering the
<span class="lineNum">    1027 </span>                :            :      * REDIS_LRU_CLOCK_RESOLUTION define.
<span class="lineNum">    1028 </span>                :            :      */
<span class="lineNum">    1029 </span>                :            :     updateLRUClock();
<span class="lineNum">    1030 </span>                :            : 
<span class="lineNum">    1031 </span>                :            :     /* Record the max memory used since the server was started. */
<span class="lineNum">    1032 </span>        [<span class="branchCov" title="Branch 1 was taken 2063 times"> + </span><span class="branchCov" title="Branch 2 was taken 5727 times"> + </span>]:<span class="lineCov">       7790 :     if (zmalloc_used_memory() &gt; server.stat_peak_memory)</span>
<span class="lineNum">    1033 </span>                :<span class="lineCov">       2063 :         server.stat_peak_memory = zmalloc_used_memory();</span>
<span class="lineNum">    1034 </span>                :            : 
<span class="lineNum">    1035 </span>                :            :     /* We received a SIGTERM, shutting down here in a safe way, as it is
<span class="lineNum">    1036 </span>                :            :      * not ok doing so inside the signal handler. */
<span class="lineNum">    1037 </span>        [<span class="branchCov" title="Branch 0 was taken 74 times"> + </span><span class="branchCov" title="Branch 1 was taken 7716 times"> + </span>]:<span class="lineCov">       7790 :     if (server.shutdown_asap) {</span>
<span class="lineNum">    1038 </span>        [<span class="branchCov" title="Branch 1 was taken 74 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         74 :         if (prepareForShutdown(0) == REDIS_OK) exit(0);</span>
<span class="lineNum">    1039 </span>                :<span class="lineNoCov">          0 :         redisLog(REDIS_WARNING,&quot;SIGTERM received but errors trying to shut down the server, check the logs for more information&quot;);</span>
<span class="lineNum">    1040 </span>                :<span class="lineNoCov">          0 :         server.shutdown_asap = 0;</span>
<span class="lineNum">    1041 </span>                :            :     }
<span class="lineNum">    1042 </span>                :            : 
<span class="lineNum">    1043 </span>                :            :     /* Show some info about non-empty databases */
<span class="lineNum">    1044 </span>[<span class="branchCov" title="Branch 0 was taken 7716 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 240 times"> + </span><span class="branchCov" title="Branch 3 was taken 7476 times"> + </span>]:<span class="lineCov">       7716 :     run_with_period(5000) {</span>
<span class="lineNum">    1045 </span>        [<span class="branchCov" title="Branch 0 was taken 3840 times"> + </span><span class="branchCov" title="Branch 1 was taken 240 times"> + </span>]:<span class="lineCov">       4080 :         for (j = 0; j &lt; server.dbnum; j++) {</span>
<span class="lineNum">    1046 </span>                :            :             long long size, used, vkeys;
<span class="lineNum">    1047 </span>                :            : 
<span class="lineNum">    1048 </span>                :<span class="lineCov">       3840 :             size = dictSlots(server.db[j].dict);</span>
<span class="lineNum">    1049 </span>                :<span class="lineCov">       3840 :             used = dictSize(server.db[j].dict);</span>
<span class="lineNum">    1050 </span>                :<span class="lineCov">       3840 :             vkeys = dictSize(server.db[j].expires);</span>
<span class="lineNum">    1051 </span>        [<span class="branchCov" title="Branch 0 was taken 135 times"> + </span><span class="branchCov" title="Branch 1 was taken 3705 times"> + </span>]:<span class="lineCov">       3840 :             if (used || vkeys) {</span>
<span class="lineNum">    1052 </span>                :<span class="lineCov">        135 :                 redisLog(REDIS_VERBOSE,&quot;DB %d: %lld keys (%lld volatile) in %lld slots HT.&quot;,j,used,vkeys,size);</span>
<span class="lineNum">    1053 </span>                :            :                 /* dictPrintStats(server.dict); */
<span class="lineNum">    1054 </span>                :            :             }
<span class="lineNum">    1055 </span>                :            :         }
<span class="lineNum">    1056 </span>                :            :     }
<span class="lineNum">    1057 </span>                :            : 
<span class="lineNum">    1058 </span>                :            :     /* Show information about connected clients */
<span class="lineNum">    1059 </span>        [<span class="branchCov" title="Branch 0 was taken 7716 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       7716 :     if (!server.sentinel_mode) {</span>
<span class="lineNum">    1060 </span>[<span class="branchCov" title="Branch 0 was taken 7716 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 240 times"> + </span><span class="branchCov" title="Branch 3 was taken 7476 times"> + </span>]:<span class="lineCov">       7716 :         run_with_period(5000) {</span>
<span class="lineNum">    1061 </span>                :<span class="lineCov">        240 :             redisLog(REDIS_VERBOSE,</span>
<span class="lineNum">    1062 </span>                :            :                 &quot;%lu clients connected (%lu slaves), %zu bytes in use&quot;,
<span class="lineNum">    1063 </span>                :<span class="lineCov">        240 :                 listLength(server.clients)-listLength(server.slaves),</span>
<span class="lineNum">    1064 </span>                :            :                 listLength(server.slaves),
<span class="lineNum">    1065 </span>                :            :                 zmalloc_used_memory());
<span class="lineNum">    1066 </span>                :            :         }
<span class="lineNum">    1067 </span>                :            :     }
<span class="lineNum">    1068 </span>                :            : 
<span class="lineNum">    1069 </span>                :            :     /* We need to do a few operations on clients asynchronously. */
<span class="lineNum">    1070 </span>                :<span class="lineCov">       7716 :     clientsCron();</span>
<span class="lineNum">    1071 </span>                :            : 
<span class="lineNum">    1072 </span>                :            :     /* Handle background operations on Redis databases. */
<span class="lineNum">    1073 </span>                :<span class="lineCov">       7716 :     databasesCron();</span>
<span class="lineNum">    1074 </span>                :            : 
<span class="lineNum">    1075 </span>                :            :     /* Start a scheduled AOF rewrite if this was requested by the user while
<span class="lineNum">    1076 </span>                :            :      * a BGSAVE was in progress. */
<span class="lineNum">    1077 </span>[<span class="branchCov" title="Branch 0 was taken 7658 times"> + </span><span class="branchCov" title="Branch 1 was taken 58 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 7427 times"> + </span><span class="branchCov" title="Branch 3 was taken 231 times"> + </span>]:<span class="lineCov">       7716 :     if (server.rdb_child_pid == -1 &amp;&amp; server.aof_child_pid == -1 &amp;&amp;</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 2 times"> + </span><span class="branchCov" title="Branch 5 was taken 7425 times"> + </span>]
<span class="lineNum">    1078 </span>                :<span class="lineCov">       7427 :         server.aof_rewrite_scheduled)</span>
<span class="lineNum">    1079 </span>                :            :     {
<span class="lineNum">    1080 </span>                :<span class="lineCov">          2 :         rewriteAppendOnlyFileBackground();</span>
<span class="lineNum">    1081 </span>                :            :     }
<span class="lineNum">    1082 </span>                :            : 
<span class="lineNum">    1083 </span>                :            :     /* Check if a background saving or AOF rewrite in progress terminated. */
<span class="lineNum">    1084 </span>[<span class="branchCov" title="Branch 0 was taken 7657 times"> + </span><span class="branchCov" title="Branch 1 was taken 58 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 7425 times"> + </span><span class="branchCov" title="Branch 3 was taken 232 times"> + </span>]:<span class="lineCov">       7715 :     if (server.rdb_child_pid != -1 || server.aof_child_pid != -1) {</span>
<span class="lineNum">    1085 </span>                :            :         int statloc;
<span class="lineNum">    1086 </span>                :            :         pid_t pid;
<span class="lineNum">    1087 </span>                :            : 
<span class="lineNum">    1088 </span>        [<span class="branchCov" title="Branch 1 was taken 257 times"> + </span><span class="branchCov" title="Branch 2 was taken 33 times"> + </span>]:<span class="lineCov">        290 :         if ((pid = wait3(&amp;statloc,WNOHANG,NULL)) != 0) {</span>
<span class="lineNum">    1089 </span>                :<span class="lineCov">        257 :             int exitcode = WEXITSTATUS(statloc);</span>
<span class="lineNum">    1090 </span>                :<span class="lineCov">        257 :             int bysignal = 0;</span>
<span class="lineNum">    1091 </span>                :            :             
<span class="lineNum">    1092 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 257 times"> + </span>]:<span class="lineCov">        257 :             if (WIFSIGNALED(statloc)) bysignal = WTERMSIG(statloc);</span>
<span class="lineNum">    1093 </span>                :            : 
<span class="lineNum">    1094 </span>        [<span class="branchCov" title="Branch 0 was taken 44 times"> + </span><span class="branchCov" title="Branch 1 was taken 213 times"> + </span>]:<span class="lineCov">        257 :             if (pid == server.rdb_child_pid) {</span>
<span class="lineNum">    1095 </span>                :<span class="lineCov">         44 :                 backgroundSaveDoneHandler(exitcode,bysignal);</span>
<span class="lineNum">    1096 </span>        [<span class="branchCov" title="Branch 0 was taken 213 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        213 :             } else if (pid == server.aof_child_pid) {</span>
<span class="lineNum">    1097 </span>                :<span class="lineCov">        213 :                 backgroundRewriteDoneHandler(exitcode,bysignal);</span>
<span class="lineNum">    1098 </span>                :            :             } else {
<span class="lineNum">    1099 </span>                :<span class="lineNoCov">          0 :                 redisLog(REDIS_WARNING,</span>
<span class="lineNum">    1100 </span>                :            :                     &quot;Warning, detected child with unmatched pid: %ld&quot;,
<span class="lineNum">    1101 </span>                :            :                     (long)pid);
<span class="lineNum">    1102 </span>                :            :             }
<span class="lineNum">    1103 </span>                :<span class="lineCov">        257 :             updateDictResizePolicy();</span>
<span class="lineNum">    1104 </span>                :            :         }
<span class="lineNum">    1105 </span>                :            :     } else {
<span class="lineNum">    1106 </span>                :            :         /* If there is not a background saving/rewrite in progress check if
<span class="lineNum">    1107 </span>                :            :          * we have to save/rewrite now */
<span class="lineNum">    1108 </span>        [<span class="branchCov" title="Branch 0 was taken 7425 times"> + </span><span class="branchCov" title="Branch 1 was taken 7425 times"> + </span>]:<span class="lineCov">      14850 :          for (j = 0; j &lt; server.saveparamslen; j++) {</span>
<span class="lineNum">    1109 </span>                :<span class="lineCov">       7425 :             struct saveparam *sp = server.saveparams+j;</span>
<span class="lineNum">    1110 </span>                :            : 
<span class="lineNum">    1111 </span>                :            :             /* Save if we reached the given amount of changes,
<span class="lineNum">    1112 </span>                :            :              * the given amount of seconds, and if the latest bgsave was
<span class="lineNum">    1113 </span>                :            :              * successful or if, in case of an error, at least
<span class="lineNum">    1114 </span>                :            :              * REDIS_BGSAVE_RETRY_DELAY seconds already elapsed. */
<span class="lineNum">    1115 </span>[<span class="branchCov" title="Branch 0 was taken 2565 times"> + </span><span class="branchCov" title="Branch 1 was taken 4860 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 2565 times"> + </span>]:<span class="lineCov">       7425 :             if (server.dirty &gt;= sp-&gt;changes &amp;&amp;</span>
<span class="lineNum">    1116 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 server.unixtime-server.lastsave &gt; sp-&gt;seconds &amp;&amp;</span>
<span class="lineNum">    1117 </span>                :<span class="lineNoCov">          0 :                 (server.unixtime-server.lastbgsave_try &gt;</span>
<span class="lineNum">    1118 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                  REDIS_BGSAVE_RETRY_DELAY ||</span>
<span class="lineNum">    1119 </span>                :<span class="lineNoCov">          0 :                  server.lastbgsave_status == REDIS_OK))</span>
<span class="lineNum">    1120 </span>                :            :             {
<span class="lineNum">    1121 </span>                :<span class="lineNoCov">          0 :                 redisLog(REDIS_NOTICE,&quot;%d changes in %d seconds. Saving...&quot;,</span>
<span class="lineNum">    1122 </span>                :<span class="lineNoCov">          0 :                     sp-&gt;changes, (int)sp-&gt;seconds);</span>
<span class="lineNum">    1123 </span>                :<span class="lineNoCov">          0 :                 rdbSaveBackground(server.rdb_filename);</span>
<span class="lineNum">    1124 </span>                :<span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    1125 </span>                :            :             }
<span class="lineNum">    1126 </span>                :            :          }
<span class="lineNum">    1127 </span>                :            : 
<span class="lineNum">    1128 </span>                :            :          /* Trigger an AOF rewrite if needed */
<span class="lineNum">    1129 </span>[<span class="branchCov" title="Branch 0 was taken 7425 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 7425 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       7425 :          if (server.rdb_child_pid == -1 &amp;&amp;</span>
<span class="lineNum">    1130 </span>        [<span class="branchCov" title="Branch 0 was taken 7425 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       7425 :              server.aof_child_pid == -1 &amp;&amp;</span>
<span class="lineNum">    1131 </span>        [<span class="branchCov" title="Branch 0 was taken 32 times"> + </span><span class="branchCov" title="Branch 1 was taken 7393 times"> + </span>]:<span class="lineCov">       7425 :              server.aof_rewrite_perc &amp;&amp;</span>
<span class="lineNum">    1132 </span>                :<span class="lineCov">       7425 :              server.aof_current_size &gt; server.aof_rewrite_min_size)</span>
<span class="lineNum">    1133 </span>                :            :          {
<span class="lineNum">    1134 </span>        [<span class="branchCov" title="Branch 0 was taken 32 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         32 :             long long base = server.aof_rewrite_base_size ?</span>
<span class="lineNum">    1135 </span>                :            :                             server.aof_rewrite_base_size : 1;
<span class="lineNum">    1136 </span>                :<span class="lineCov">         32 :             long long growth = (server.aof_current_size*100/base) - 100;</span>
<span class="lineNum">    1137 </span>        [<span class="branchCov" title="Branch 0 was taken 20 times"> + </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>]:<span class="lineCov">         32 :             if (growth &gt;= server.aof_rewrite_perc) {</span>
<span class="lineNum">    1138 </span>                :<span class="lineCov">         20 :                 redisLog(REDIS_NOTICE,&quot;Starting automatic rewriting of AOF on %lld%% growth&quot;,growth);</span>
<span class="lineNum">    1139 </span>                :<span class="lineCov">         20 :                 rewriteAppendOnlyFileBackground();</span>
<span class="lineNum">    1140 </span>                :            :             }
<span class="lineNum">    1141 </span>                :            :          }
<span class="lineNum">    1142 </span>                :            :     }
<span class="lineNum">    1143 </span>                :            : 
<span class="lineNum">    1144 </span>                :            : 
<span class="lineNum">    1145 </span>                :            :     /* If we postponed an AOF buffer flush, let's try to do it every time the
<span class="lineNum">    1146 </span>                :            :      * cron function is called. */
<span class="lineNum">    1147 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7710 times"> + </span>]:<span class="lineCov">       7710 :     if (server.aof_flush_postponed_start) flushAppendOnlyFile(0);</span>
<span class="lineNum">    1148 </span>                :            : 
<span class="lineNum">    1149 </span>                :            :     /* Close clients that need to be closed asynchronous */
<span class="lineNum">    1150 </span>                :<span class="lineCov">       7710 :     freeClientsInAsyncFreeQueue();</span>
<span class="lineNum">    1151 </span>                :            : 
<span class="lineNum">    1152 </span>                :            :     /* Replication cron function -- used to reconnect to master and
<span class="lineNum">    1153 </span>                :            :      * to detect transfer failures. */
<span class="lineNum">    1154 </span>[<span class="branchCov" title="Branch 0 was taken 7710 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 845 times"> + </span><span class="branchCov" title="Branch 3 was taken 6865 times"> + </span>]:<span class="lineCov">       7710 :     run_with_period(1000) replicationCron();</span>
<span class="lineNum">    1155 </span>                :            : 
<span class="lineNum">    1156 </span>                :            :     /* Run the Redis Cluster cron. */
<span class="lineNum">    1157 </span>[<span class="branchCov" title="Branch 0 was taken 7710 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 845 times"> + </span><span class="branchCov" title="Branch 3 was taken 6865 times"> + </span>]:<span class="lineCov">       7710 :     run_with_period(1000) {</span>
<span class="lineNum">    1158 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 845 times"> + </span>]:<span class="lineCov">        845 :         if (server.cluster_enabled) clusterCron();</span>
<span class="lineNum">    1159 </span>                :            :     }
<span class="lineNum">    1160 </span>                :            : 
<span class="lineNum">    1161 </span>                :            :     /* Run the Sentinel timer if we are in sentinel mode. */
<span class="lineNum">    1162 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7710 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">       7710 :     run_with_period(100) {</span>
<span class="lineNum">    1163 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7710 times"> + </span>]:<span class="lineCov">       7710 :         if (server.sentinel_mode) sentinelTimer();</span>
<span class="lineNum">    1164 </span>                :            :     }
<span class="lineNum">    1165 </span>                :            : 
<span class="lineNum">    1166 </span>                :            :     /* Cleanup expired MIGRATE cached sockets. */
<span class="lineNum">    1167 </span>[<span class="branchCov" title="Branch 0 was taken 7710 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 845 times"> + </span><span class="branchCov" title="Branch 3 was taken 6865 times"> + </span>]:<span class="lineCov">       7710 :     run_with_period(1000) {</span>
<span class="lineNum">    1168 </span>                :<span class="lineCov">        845 :         migrateCloseTimedoutSockets();</span>
<span class="lineNum">    1169 </span>                :            :     }
<span class="lineNum">    1170 </span>                :            : 
<span class="lineNum">    1171 </span>                :<span class="lineCov">       7710 :     server.cronloops++;</span>
<span class="lineNum">    1172 </span>                :<span class="lineCov">       7710 :     return 1000/server.hz;</span>
<span class="lineNum">    1173 </span>                :            : }
<span class="lineNum">    1174 </span>                :            : 
<span class="lineNum">    1175 </span>                :            : /* This function gets called every time Redis is entering the
<a name="1176"><span class="lineNum">    1176 </span>                :            :  * main loop of the event driven library, that is, before to sleep</a>
<span class="lineNum">    1177 </span>                :            :  * for ready file descriptors. */
<span class="lineNum">    1178 </span>                :<span class="lineCov">    4185104 : void beforeSleep(struct aeEventLoop *eventLoop) {</span>
<span class="lineNum">    1179 </span>                :            :     REDIS_NOTUSED(eventLoop);
<span class="lineNum">    1180 </span>                :            :     listNode *ln;
<span class="lineNum">    1181 </span>                :            :     redisClient *c;
<span class="lineNum">    1182 </span>                :            : 
<span class="lineNum">    1183 </span>                :            :     /* Run a fast expire cycle. */
<span class="lineNum">    1184 </span>                :<span class="lineCov">    4185104 :     activeExpireCycle(ACTIVE_EXPIRE_CYCLE_FAST);</span>
<span class="lineNum">    1185 </span>                :            : 
<span class="lineNum">    1186 </span>                :            :     /* Try to process pending commands for clients that were just unblocked. */
<span class="lineNum">    1187 </span>        [<span class="branchCov" title="Branch 0 was taken 37 times"> + </span><span class="branchCov" title="Branch 1 was taken 4185104 times"> + </span>]:<span class="lineCov">    4185141 :     while (listLength(server.unblocked_clients)) {</span>
<span class="lineNum">    1188 </span>                :<span class="lineCov">         37 :         ln = listFirst(server.unblocked_clients);</span>
<span class="lineNum">    1189 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 37 times"> + </span>]:<span class="lineCov">         37 :         redisAssert(ln != NULL);</span>
<span class="lineNum">    1190 </span>                :<span class="lineCov">         37 :         c = ln-&gt;value;</span>
<span class="lineNum">    1191 </span>                :<span class="lineCov">         37 :         listDelNode(server.unblocked_clients,ln);</span>
<span class="lineNum">    1192 </span>                :<span class="lineCov">         37 :         c-&gt;flags &amp;= ~REDIS_UNBLOCKED;</span>
<span class="lineNum">    1193 </span>                :            : 
<span class="lineNum">    1194 </span>                :            :         /* Process remaining data in the input buffer. */
<span class="lineNum">    1195 </span>[<span class="branchCov" title="Branch 0 was taken 37 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchCov" title="Branch 3 was taken 35 times"> + </span>]:<span class="lineCov">         37 :         if (c-&gt;querybuf &amp;&amp; sdslen(c-&gt;querybuf) &gt; 0) {</span>
<span class="lineNum">    1196 </span>                :<span class="lineCov">          2 :             server.current_client = c;</span>
<span class="lineNum">    1197 </span>                :<span class="lineCov">          2 :             processInputBuffer(c);</span>
<span class="lineNum">    1198 </span>                :<span class="lineCov">         37 :             server.current_client = NULL;</span>
<span class="lineNum">    1199 </span>                :            :         }
<span class="lineNum">    1200 </span>                :            :     }
<span class="lineNum">    1201 </span>                :            : 
<span class="lineNum">    1202 </span>                :            :     /* Write the AOF buffer on disk */
<span class="lineNum">    1203 </span>                :<span class="lineCov">    4185104 :     flushAppendOnlyFile(0);</span>
<span class="lineNum">    1204 </span>                :<span class="lineCov">    4185104 : }</span>
<span class="lineNum">    1205 </span>                :            : 
<a name="1206"><span class="lineNum">    1206 </span>                :            : /* =========================== Server initialization ======================== */</a>
<span class="lineNum">    1207 </span>                :            : 
<span class="lineNum">    1208 </span>                :<span class="lineCov">        131 : void createSharedObjects(void) {</span>
<span class="lineNum">    1209 </span>                :            :     int j;
<span class="lineNum">    1210 </span>                :            : 
<span class="lineNum">    1211 </span>                :<span class="lineCov">        131 :     shared.crlf = createObject(REDIS_STRING,sdsnew(&quot;\r\n&quot;));</span>
<span class="lineNum">    1212 </span>                :<span class="lineCov">        131 :     shared.ok = createObject(REDIS_STRING,sdsnew(&quot;+OK\r\n&quot;));</span>
<span class="lineNum">    1213 </span>                :<span class="lineCov">        131 :     shared.err = createObject(REDIS_STRING,sdsnew(&quot;-ERR\r\n&quot;));</span>
<span class="lineNum">    1214 </span>                :<span class="lineCov">        131 :     shared.emptybulk = createObject(REDIS_STRING,sdsnew(&quot;$0\r\n\r\n&quot;));</span>
<span class="lineNum">    1215 </span>                :<span class="lineCov">        131 :     shared.czero = createObject(REDIS_STRING,sdsnew(&quot;:0\r\n&quot;));</span>
<span class="lineNum">    1216 </span>                :<span class="lineCov">        131 :     shared.cone = createObject(REDIS_STRING,sdsnew(&quot;:1\r\n&quot;));</span>
<span class="lineNum">    1217 </span>                :<span class="lineCov">        131 :     shared.cnegone = createObject(REDIS_STRING,sdsnew(&quot;:-1\r\n&quot;));</span>
<span class="lineNum">    1218 </span>                :<span class="lineCov">        131 :     shared.nullbulk = createObject(REDIS_STRING,sdsnew(&quot;$-1\r\n&quot;));</span>
<span class="lineNum">    1219 </span>                :<span class="lineCov">        131 :     shared.nullmultibulk = createObject(REDIS_STRING,sdsnew(&quot;*-1\r\n&quot;));</span>
<span class="lineNum">    1220 </span>                :<span class="lineCov">        131 :     shared.emptymultibulk = createObject(REDIS_STRING,sdsnew(&quot;*0\r\n&quot;));</span>
<span class="lineNum">    1221 </span>                :<span class="lineCov">        131 :     shared.pong = createObject(REDIS_STRING,sdsnew(&quot;+PONG\r\n&quot;));</span>
<span class="lineNum">    1222 </span>                :<span class="lineCov">        131 :     shared.queued = createObject(REDIS_STRING,sdsnew(&quot;+QUEUED\r\n&quot;));</span>
<span class="lineNum">    1223 </span>                :<span class="lineCov">        131 :     shared.wrongtypeerr = createObject(REDIS_STRING,sdsnew(</span>
<span class="lineNum">    1224 </span>                :            :         &quot;-WRONGTYPE Operation against a key holding the wrong kind of value\r\n&quot;));
<span class="lineNum">    1225 </span>                :<span class="lineCov">        131 :     shared.nokeyerr = createObject(REDIS_STRING,sdsnew(</span>
<span class="lineNum">    1226 </span>                :            :         &quot;-ERR no such key\r\n&quot;));
<span class="lineNum">    1227 </span>                :<span class="lineCov">        131 :     shared.syntaxerr = createObject(REDIS_STRING,sdsnew(</span>
<span class="lineNum">    1228 </span>                :            :         &quot;-ERR syntax error\r\n&quot;));
<span class="lineNum">    1229 </span>                :<span class="lineCov">        131 :     shared.sameobjecterr = createObject(REDIS_STRING,sdsnew(</span>
<span class="lineNum">    1230 </span>                :            :         &quot;-ERR source and destination objects are the same\r\n&quot;));
<span class="lineNum">    1231 </span>                :<span class="lineCov">        131 :     shared.outofrangeerr = createObject(REDIS_STRING,sdsnew(</span>
<span class="lineNum">    1232 </span>                :            :         &quot;-ERR index out of range\r\n&quot;));
<span class="lineNum">    1233 </span>                :<span class="lineCov">        131 :     shared.noscripterr = createObject(REDIS_STRING,sdsnew(</span>
<span class="lineNum">    1234 </span>                :            :         &quot;-NOSCRIPT No matching script. Please use EVAL.\r\n&quot;));
<span class="lineNum">    1235 </span>                :<span class="lineCov">        131 :     shared.loadingerr = createObject(REDIS_STRING,sdsnew(</span>
<span class="lineNum">    1236 </span>                :            :         &quot;-LOADING Redis is loading the dataset in memory\r\n&quot;));
<span class="lineNum">    1237 </span>                :<span class="lineCov">        131 :     shared.slowscripterr = createObject(REDIS_STRING,sdsnew(</span>
<span class="lineNum">    1238 </span>                :            :         &quot;-BUSY Redis is busy running a script. You can only call SCRIPT KILL or SHUTDOWN NOSAVE.\r\n&quot;));
<span class="lineNum">    1239 </span>                :<span class="lineCov">        131 :     shared.masterdownerr = createObject(REDIS_STRING,sdsnew(</span>
<span class="lineNum">    1240 </span>                :            :         &quot;-MASTERDOWN Link with MASTER is down and slave-serve-stale-data is set to 'no'.\r\n&quot;));
<span class="lineNum">    1241 </span>                :<span class="lineCov">        131 :     shared.bgsaveerr = createObject(REDIS_STRING,sdsnew(</span>
<span class="lineNum">    1242 </span>                :            :         &quot;-MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk. Commands that may modify the data set are disabled. Please check Redis logs for details about the error.\r\n&quot;));
<span class="lineNum">    1243 </span>                :<span class="lineCov">        131 :     shared.roslaveerr = createObject(REDIS_STRING,sdsnew(</span>
<span class="lineNum">    1244 </span>                :            :         &quot;-READONLY You can't write against a read only slave.\r\n&quot;));
<span class="lineNum">    1245 </span>                :<span class="lineCov">        131 :     shared.noautherr = createObject(REDIS_STRING,sdsnew(</span>
<span class="lineNum">    1246 </span>                :            :         &quot;-NOAUTH Authentication required.\r\n&quot;));
<span class="lineNum">    1247 </span>                :<span class="lineCov">        131 :     shared.oomerr = createObject(REDIS_STRING,sdsnew(</span>
<span class="lineNum">    1248 </span>                :            :         &quot;-OOM command not allowed when used memory &gt; 'maxmemory'.\r\n&quot;));
<span class="lineNum">    1249 </span>                :<span class="lineCov">        131 :     shared.execaborterr = createObject(REDIS_STRING,sdsnew(</span>
<span class="lineNum">    1250 </span>                :            :         &quot;-EXECABORT Transaction discarded because of previous errors.\r\n&quot;));
<span class="lineNum">    1251 </span>                :<span class="lineCov">        131 :     shared.noreplicaserr = createObject(REDIS_STRING,sdsnew(</span>
<span class="lineNum">    1252 </span>                :            :         &quot;-NOREPLICAS Not enough good slaves to write.\r\n&quot;));
<span class="lineNum">    1253 </span>                :<span class="lineCov">        131 :     shared.space = createObject(REDIS_STRING,sdsnew(&quot; &quot;));</span>
<span class="lineNum">    1254 </span>                :<span class="lineCov">        131 :     shared.colon = createObject(REDIS_STRING,sdsnew(&quot;:&quot;));</span>
<span class="lineNum">    1255 </span>                :<span class="lineCov">        131 :     shared.plus = createObject(REDIS_STRING,sdsnew(&quot;+&quot;));</span>
<span class="lineNum">    1256 </span>                :            : 
<span class="lineNum">    1257 </span>        [<span class="branchCov" title="Branch 0 was taken 1310 times"> + </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">       1441 :     for (j = 0; j &lt; REDIS_SHARED_SELECT_CMDS; j++) {</span>
<span class="lineNum">    1258 </span>                :            :         char dictid_str[64];
<span class="lineNum">    1259 </span>                :            :         int dictid_len;
<span class="lineNum">    1260 </span>                :            : 
<span class="lineNum">    1261 </span>                :<span class="lineCov">       1310 :         dictid_len = ll2string(dictid_str,sizeof(dictid_str),j);</span>
<span class="lineNum">    1262 </span>                :<span class="lineCov">       1310 :         shared.select[j] = createObject(REDIS_STRING,</span>
<span class="lineNum">    1263 </span>                :<span class="lineCov">       1310 :             sdscatprintf(sdsempty(),</span>
<span class="lineNum">    1264 </span>                :            :                 &quot;*2\r\n$6\r\nSELECT\r\n$%d\r\n%s\r\n&quot;,
<span class="lineNum">    1265 </span>                :            :                 dictid_len, dictid_str));
<span class="lineNum">    1266 </span>                :            :     }
<span class="lineNum">    1267 </span>                :<span class="lineCov">        131 :     shared.messagebulk = createStringObject(&quot;$7\r\nmessage\r\n&quot;,13);</span>
<span class="lineNum">    1268 </span>                :<span class="lineCov">        131 :     shared.pmessagebulk = createStringObject(&quot;$8\r\npmessage\r\n&quot;,14);</span>
<span class="lineNum">    1269 </span>                :<span class="lineCov">        131 :     shared.subscribebulk = createStringObject(&quot;$9\r\nsubscribe\r\n&quot;,15);</span>
<span class="lineNum">    1270 </span>                :<span class="lineCov">        131 :     shared.unsubscribebulk = createStringObject(&quot;$11\r\nunsubscribe\r\n&quot;,18);</span>
<span class="lineNum">    1271 </span>                :<span class="lineCov">        131 :     shared.psubscribebulk = createStringObject(&quot;$10\r\npsubscribe\r\n&quot;,17);</span>
<span class="lineNum">    1272 </span>                :<span class="lineCov">        131 :     shared.punsubscribebulk = createStringObject(&quot;$12\r\npunsubscribe\r\n&quot;,19);</span>
<span class="lineNum">    1273 </span>                :<span class="lineCov">        131 :     shared.del = createStringObject(&quot;DEL&quot;,3);</span>
<span class="lineNum">    1274 </span>                :<span class="lineCov">        131 :     shared.rpop = createStringObject(&quot;RPOP&quot;,4);</span>
<span class="lineNum">    1275 </span>                :<span class="lineCov">        131 :     shared.lpop = createStringObject(&quot;LPOP&quot;,4);</span>
<span class="lineNum">    1276 </span>                :<span class="lineCov">        131 :     shared.lpush = createStringObject(&quot;LPUSH&quot;,5);</span>
<span class="lineNum">    1277 </span>        [<span class="branchCov" title="Branch 0 was taken 1310000 times"> + </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">    1310131 :     for (j = 0; j &lt; REDIS_SHARED_INTEGERS; j++) {</span>
<span class="lineNum">    1278 </span>                :<span class="lineCov">    1310000 :         shared.integers[j] = createObject(REDIS_STRING,(void*)(long)j);</span>
<span class="lineNum">    1279 </span>                :<span class="lineCov">    1310000 :         shared.integers[j]-&gt;encoding = REDIS_ENCODING_INT;</span>
<span class="lineNum">    1280 </span>                :            :     }
<span class="lineNum">    1281 </span>        [<span class="branchCov" title="Branch 0 was taken 4192 times"> + </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">       4323 :     for (j = 0; j &lt; REDIS_SHARED_BULKHDR_LEN; j++) {</span>
<span class="lineNum">    1282 </span>                :<span class="lineCov">       4192 :         shared.mbulkhdr[j] = createObject(REDIS_STRING,</span>
<span class="lineNum">    1283 </span>                :<span class="lineCov">       4192 :             sdscatprintf(sdsempty(),&quot;*%d\r\n&quot;,j));</span>
<span class="lineNum">    1284 </span>                :<span class="lineCov">       4192 :         shared.bulkhdr[j] = createObject(REDIS_STRING,</span>
<span class="lineNum">    1285 </span>                :<span class="lineCov">       4192 :             sdscatprintf(sdsempty(),&quot;$%d\r\n&quot;,j));</span>
<span class="lineNum">    1286 </span>                :            :     }
<span class="lineNum">    1287 </span>                :<span class="lineCov">        131 : }</span>
<span class="lineNum">    1288 </span>                :            : 
<span class="lineNum">    1289 </span>                :<span class="lineCov">        131 : void initServerConfig() {</span>
<span class="lineNum">    1290 </span>                :            :     int j;
<span class="lineNum">    1291 </span>                :            : 
<span class="lineNum">    1292 </span>                :<span class="lineCov">        131 :     getRandomHexChars(server.runid,REDIS_RUN_ID_SIZE);</span>
<span class="lineNum">    1293 </span>                :<span class="lineCov">        131 :     server.configfile = NULL;</span>
<span class="lineNum">    1294 </span>                :<span class="lineCov">        131 :     server.hz = REDIS_DEFAULT_HZ;</span>
<span class="lineNum">    1295 </span>                :<span class="lineCov">        131 :     server.runid[REDIS_RUN_ID_SIZE] = '\0';</span>
<span class="lineNum">    1296 </span>                :<span class="lineCov">        131 :     server.arch_bits = (sizeof(long) == 8) ? 64 : 32;</span>
<span class="lineNum">    1297 </span>                :<span class="lineCov">        131 :     server.port = REDIS_SERVERPORT;</span>
<span class="lineNum">    1298 </span>                :<span class="lineCov">        131 :     server.bindaddr_count = 0;</span>
<span class="lineNum">    1299 </span>                :<span class="lineCov">        131 :     server.unixsocket = NULL;</span>
<span class="lineNum">    1300 </span>                :<span class="lineCov">        131 :     server.unixsocketperm = REDIS_DEFAULT_UNIX_SOCKET_PERM;</span>
<span class="lineNum">    1301 </span>                :<span class="lineCov">        131 :     server.ipfd_count = 0;</span>
<span class="lineNum">    1302 </span>                :<span class="lineCov">        131 :     server.sofd = -1;</span>
<span class="lineNum">    1303 </span>                :<span class="lineCov">        131 :     server.dbnum = REDIS_DEFAULT_DBNUM;</span>
<span class="lineNum">    1304 </span>                :<span class="lineCov">        131 :     server.verbosity = REDIS_DEFAULT_VERBOSITY;</span>
<span class="lineNum">    1305 </span>                :<span class="lineCov">        131 :     server.maxidletime = REDIS_MAXIDLETIME;</span>
<span class="lineNum">    1306 </span>                :<span class="lineCov">        131 :     server.tcpkeepalive = REDIS_DEFAULT_TCP_KEEPALIVE;</span>
<span class="lineNum">    1307 </span>                :<span class="lineCov">        131 :     server.active_expire_enabled = 1;</span>
<span class="lineNum">    1308 </span>                :<span class="lineCov">        131 :     server.client_max_querybuf_len = REDIS_MAX_QUERYBUF_LEN;</span>
<span class="lineNum">    1309 </span>                :<span class="lineCov">        131 :     server.saveparams = NULL;</span>
<span class="lineNum">    1310 </span>                :<span class="lineCov">        131 :     server.loading = 0;</span>
<span class="lineNum">    1311 </span>                :<span class="lineCov">        131 :     server.logfile = zstrdup(REDIS_DEFAULT_LOGFILE);</span>
<span class="lineNum">    1312 </span>                :<span class="lineCov">        131 :     server.syslog_enabled = REDIS_DEFAULT_SYSLOG_ENABLED;</span>
<span class="lineNum">    1313 </span>                :<span class="lineCov">        131 :     server.syslog_ident = zstrdup(REDIS_DEFAULT_SYSLOG_IDENT);</span>
<span class="lineNum">    1314 </span>                :<span class="lineCov">        131 :     server.syslog_facility = LOG_LOCAL0;</span>
<span class="lineNum">    1315 </span>                :<span class="lineCov">        131 :     server.daemonize = REDIS_DEFAULT_DAEMONIZE;</span>
<span class="lineNum">    1316 </span>                :<span class="lineCov">        131 :     server.aof_state = REDIS_AOF_OFF;</span>
<span class="lineNum">    1317 </span>                :<span class="lineCov">        131 :     server.aof_fsync = REDIS_DEFAULT_AOF_FSYNC;</span>
<span class="lineNum">    1318 </span>                :<span class="lineCov">        131 :     server.aof_no_fsync_on_rewrite = REDIS_DEFAULT_AOF_NO_FSYNC_ON_REWRITE;</span>
<span class="lineNum">    1319 </span>                :<span class="lineCov">        131 :     server.aof_rewrite_perc = REDIS_AOF_REWRITE_PERC;</span>
<span class="lineNum">    1320 </span>                :<span class="lineCov">        131 :     server.aof_rewrite_min_size = REDIS_AOF_REWRITE_MIN_SIZE;</span>
<span class="lineNum">    1321 </span>                :<span class="lineCov">        131 :     server.aof_rewrite_base_size = 0;</span>
<span class="lineNum">    1322 </span>                :<span class="lineCov">        131 :     server.aof_rewrite_scheduled = 0;</span>
<span class="lineNum">    1323 </span>                :<span class="lineCov">        131 :     server.aof_last_fsync = time(NULL);</span>
<span class="lineNum">    1324 </span>                :<span class="lineCov">        131 :     server.aof_rewrite_time_last = -1;</span>
<span class="lineNum">    1325 </span>                :<span class="lineCov">        131 :     server.aof_rewrite_time_start = -1;</span>
<span class="lineNum">    1326 </span>                :<span class="lineCov">        131 :     server.aof_lastbgrewrite_status = REDIS_OK;</span>
<span class="lineNum">    1327 </span>                :<span class="lineCov">        131 :     server.aof_delayed_fsync = 0;</span>
<span class="lineNum">    1328 </span>                :<span class="lineCov">        131 :     server.aof_fd = -1;</span>
<span class="lineNum">    1329 </span>                :<span class="lineCov">        131 :     server.aof_selected_db = -1; /* Make sure the first time will not match */</span>
<span class="lineNum">    1330 </span>                :<span class="lineCov">        131 :     server.aof_flush_postponed_start = 0;</span>
<span class="lineNum">    1331 </span>                :<span class="lineCov">        131 :     server.aof_rewrite_incremental_fsync = REDIS_DEFAULT_AOF_REWRITE_INCREMENTAL_FSYNC;</span>
<span class="lineNum">    1332 </span>                :<span class="lineCov">        131 :     server.pidfile = zstrdup(REDIS_DEFAULT_PID_FILE);</span>
<span class="lineNum">    1333 </span>                :<span class="lineCov">        131 :     server.rdb_filename = zstrdup(REDIS_DEFAULT_RDB_FILENAME);</span>
<span class="lineNum">    1334 </span>                :<span class="lineCov">        131 :     server.aof_filename = zstrdup(&quot;appendonly.aof&quot;);</span>
<span class="lineNum">    1335 </span>                :<span class="lineCov">        131 :     server.requirepass = NULL;</span>
<span class="lineNum">    1336 </span>                :<span class="lineCov">        131 :     server.rdb_compression = REDIS_DEFAULT_RDB_COMPRESSION;</span>
<span class="lineNum">    1337 </span>                :<span class="lineCov">        131 :     server.rdb_checksum = REDIS_DEFAULT_RDB_CHECKSUM;</span>
<span class="lineNum">    1338 </span>                :<span class="lineCov">        131 :     server.stop_writes_on_bgsave_err = REDIS_DEFAULT_STOP_WRITES_ON_BGSAVE_ERROR;</span>
<span class="lineNum">    1339 </span>                :<span class="lineCov">        131 :     server.activerehashing = REDIS_DEFAULT_ACTIVE_REHASHING;</span>
<span class="lineNum">    1340 </span>                :<span class="lineCov">        131 :     server.notify_keyspace_events = 0;</span>
<span class="lineNum">    1341 </span>                :<span class="lineCov">        131 :     server.maxclients = REDIS_MAX_CLIENTS;</span>
<span class="lineNum">    1342 </span>                :<span class="lineCov">        131 :     server.bpop_blocked_clients = 0;</span>
<span class="lineNum">    1343 </span>                :<span class="lineCov">        131 :     server.maxmemory = REDIS_DEFAULT_MAXMEMORY;</span>
<span class="lineNum">    1344 </span>                :<span class="lineCov">        131 :     server.maxmemory_policy = REDIS_DEFAULT_MAXMEMORY_POLICY;</span>
<span class="lineNum">    1345 </span>                :<span class="lineCov">        131 :     server.maxmemory_samples = REDIS_DEFAULT_MAXMEMORY_SAMPLES;</span>
<span class="lineNum">    1346 </span>                :<span class="lineCov">        131 :     server.hash_max_ziplist_entries = REDIS_HASH_MAX_ZIPLIST_ENTRIES;</span>
<span class="lineNum">    1347 </span>                :<span class="lineCov">        131 :     server.hash_max_ziplist_value = REDIS_HASH_MAX_ZIPLIST_VALUE;</span>
<span class="lineNum">    1348 </span>                :<span class="lineCov">        131 :     server.list_max_ziplist_entries = REDIS_LIST_MAX_ZIPLIST_ENTRIES;</span>
<span class="lineNum">    1349 </span>                :<span class="lineCov">        131 :     server.list_max_ziplist_value = REDIS_LIST_MAX_ZIPLIST_VALUE;</span>
<span class="lineNum">    1350 </span>                :<span class="lineCov">        131 :     server.set_max_intset_entries = REDIS_SET_MAX_INTSET_ENTRIES;</span>
<span class="lineNum">    1351 </span>                :<span class="lineCov">        131 :     server.zset_max_ziplist_entries = REDIS_ZSET_MAX_ZIPLIST_ENTRIES;</span>
<span class="lineNum">    1352 </span>                :<span class="lineCov">        131 :     server.zset_max_ziplist_value = REDIS_ZSET_MAX_ZIPLIST_VALUE;</span>
<span class="lineNum">    1353 </span>                :<span class="lineCov">        131 :     server.shutdown_asap = 0;</span>
<span class="lineNum">    1354 </span>                :<span class="lineCov">        131 :     server.repl_ping_slave_period = REDIS_REPL_PING_SLAVE_PERIOD;</span>
<span class="lineNum">    1355 </span>                :<span class="lineCov">        131 :     server.repl_timeout = REDIS_REPL_TIMEOUT;</span>
<span class="lineNum">    1356 </span>                :<span class="lineCov">        131 :     server.repl_min_slaves_to_write = REDIS_DEFAULT_MIN_SLAVES_TO_WRITE;</span>
<span class="lineNum">    1357 </span>                :<span class="lineCov">        131 :     server.repl_min_slaves_max_lag = REDIS_DEFAULT_MIN_SLAVES_MAX_LAG;</span>
<span class="lineNum">    1358 </span>                :<span class="lineCov">        131 :     server.cluster_enabled = 0;</span>
<span class="lineNum">    1359 </span>                :<span class="lineCov">        131 :     server.cluster_node_timeout = REDIS_CLUSTER_DEFAULT_NODE_TIMEOUT;</span>
<span class="lineNum">    1360 </span>                :<span class="lineCov">        131 :     server.cluster_configfile = zstrdup(REDIS_DEFAULT_CLUSTER_CONFIG_FILE);</span>
<span class="lineNum">    1361 </span>                :<span class="lineCov">        131 :     server.lua_caller = NULL;</span>
<span class="lineNum">    1362 </span>                :<span class="lineCov">        131 :     server.lua_time_limit = REDIS_LUA_TIME_LIMIT;</span>
<span class="lineNum">    1363 </span>                :<span class="lineCov">        131 :     server.lua_client = NULL;</span>
<span class="lineNum">    1364 </span>                :<span class="lineCov">        131 :     server.lua_timedout = 0;</span>
<span class="lineNum">    1365 </span>                :<span class="lineCov">        131 :     server.migrate_cached_sockets = dictCreate(&amp;migrateCacheDictType,NULL);</span>
<span class="lineNum">    1366 </span>                :<span class="lineCov">        131 :     server.loading_process_events_interval_bytes = (1024*1024*2);</span>
<span class="lineNum">    1367 </span>                :            : 
<span class="lineNum">    1368 </span>                :            :     updateLRUClock();
<span class="lineNum">    1369 </span>                :<span class="lineCov">        131 :     resetServerSaveParams();</span>
<span class="lineNum">    1370 </span>                :            : 
<span class="lineNum">    1371 </span>                :<span class="lineCov">        131 :     appendServerSaveParams(60*60,1);  /* save after 1 hour and 1 change */</span>
<span class="lineNum">    1372 </span>                :<span class="lineCov">        131 :     appendServerSaveParams(300,100);  /* save after 5 minutes and 100 changes */</span>
<span class="lineNum">    1373 </span>                :<span class="lineCov">        131 :     appendServerSaveParams(60,10000); /* save after 1 minute and 10000 changes */</span>
<span class="lineNum">    1374 </span>                :            :     /* Replication related */
<span class="lineNum">    1375 </span>                :<span class="lineCov">        131 :     server.masterauth = NULL;</span>
<span class="lineNum">    1376 </span>                :<span class="lineCov">        131 :     server.masterhost = NULL;</span>
<span class="lineNum">    1377 </span>                :<span class="lineCov">        131 :     server.masterport = 6379;</span>
<span class="lineNum">    1378 </span>                :<span class="lineCov">        131 :     server.master = NULL;</span>
<span class="lineNum">    1379 </span>                :<span class="lineCov">        131 :     server.cached_master = NULL;</span>
<span class="lineNum">    1380 </span>                :<span class="lineCov">        131 :     server.repl_master_initial_offset = -1;</span>
<span class="lineNum">    1381 </span>                :<span class="lineCov">        131 :     server.repl_state = REDIS_REPL_NONE;</span>
<span class="lineNum">    1382 </span>                :<span class="lineCov">        131 :     server.repl_syncio_timeout = REDIS_REPL_SYNCIO_TIMEOUT;</span>
<span class="lineNum">    1383 </span>                :<span class="lineCov">        131 :     server.repl_serve_stale_data = REDIS_DEFAULT_SLAVE_SERVE_STALE_DATA;</span>
<span class="lineNum">    1384 </span>                :<span class="lineCov">        131 :     server.repl_slave_ro = REDIS_DEFAULT_SLAVE_READ_ONLY;</span>
<span class="lineNum">    1385 </span>                :<span class="lineCov">        131 :     server.repl_down_since = 0; /* Never connected, repl is down since EVER. */</span>
<span class="lineNum">    1386 </span>                :<span class="lineCov">        131 :     server.repl_disable_tcp_nodelay = REDIS_DEFAULT_REPL_DISABLE_TCP_NODELAY;</span>
<span class="lineNum">    1387 </span>                :<span class="lineCov">        131 :     server.slave_priority = REDIS_DEFAULT_SLAVE_PRIORITY;</span>
<span class="lineNum">    1388 </span>                :<span class="lineCov">        131 :     server.master_repl_offset = 0;</span>
<span class="lineNum">    1389 </span>                :            : 
<span class="lineNum">    1390 </span>                :            :     /* Replication partial resync backlog */
<span class="lineNum">    1391 </span>                :<span class="lineCov">        131 :     server.repl_backlog = NULL;</span>
<span class="lineNum">    1392 </span>                :<span class="lineCov">        131 :     server.repl_backlog_size = REDIS_DEFAULT_REPL_BACKLOG_SIZE;</span>
<span class="lineNum">    1393 </span>                :<span class="lineCov">        131 :     server.repl_backlog_histlen = 0;</span>
<span class="lineNum">    1394 </span>                :<span class="lineCov">        131 :     server.repl_backlog_idx = 0;</span>
<span class="lineNum">    1395 </span>                :<span class="lineCov">        131 :     server.repl_backlog_off = 0;</span>
<span class="lineNum">    1396 </span>                :<span class="lineCov">        131 :     server.repl_backlog_time_limit = REDIS_DEFAULT_REPL_BACKLOG_TIME_LIMIT;</span>
<span class="lineNum">    1397 </span>                :<span class="lineCov">        131 :     server.repl_no_slaves_since = time(NULL);</span>
<span class="lineNum">    1398 </span>                :            : 
<span class="lineNum">    1399 </span>                :            :     /* Client output buffer limits */
<span class="lineNum">    1400 </span>        [<span class="branchCov" title="Branch 0 was taken 393 times"> + </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">        524 :     for (j = 0; j &lt; REDIS_CLIENT_LIMIT_NUM_CLASSES; j++)</span>
<span class="lineNum">    1401 </span>                :<span class="lineCov">        393 :         server.client_obuf_limits[j] = clientBufferLimitsDefaults[j];</span>
<span class="lineNum">    1402 </span>                :            : 
<span class="lineNum">    1403 </span>                :            :     /* Double constants initialization */
<span class="lineNum">    1404 </span>                :<span class="lineCov">        131 :     R_Zero = 0.0;</span>
<span class="lineNum">    1405 </span>                :<span class="lineCov">        131 :     R_PosInf = 1.0/R_Zero;</span>
<span class="lineNum">    1406 </span>                :<span class="lineCov">        131 :     R_NegInf = -1.0/R_Zero;</span>
<span class="lineNum">    1407 </span>                :<span class="lineCov">        131 :     R_Nan = R_Zero/R_Zero;</span>
<span class="lineNum">    1408 </span>                :            : 
<span class="lineNum">    1409 </span>                :            :     /* Command table -- we initiialize it here as it is part of the
<span class="lineNum">    1410 </span>                :            :      * initial configuration, since command names may be changed via
<span class="lineNum">    1411 </span>                :            :      * redis.conf using the rename-command directive. */
<span class="lineNum">    1412 </span>                :<span class="lineCov">        131 :     server.commands = dictCreate(&amp;commandTableDictType,NULL);</span>
<span class="lineNum">    1413 </span>                :<span class="lineCov">        131 :     server.orig_commands = dictCreate(&amp;commandTableDictType,NULL);</span>
<span class="lineNum">    1414 </span>                :<span class="lineCov">        131 :     populateCommandTable();</span>
<span class="lineNum">    1415 </span>                :<span class="lineCov">        131 :     server.delCommand = lookupCommandByCString(&quot;del&quot;);</span>
<span class="lineNum">    1416 </span>                :<span class="lineCov">        131 :     server.multiCommand = lookupCommandByCString(&quot;multi&quot;);</span>
<span class="lineNum">    1417 </span>                :<span class="lineCov">        131 :     server.lpushCommand = lookupCommandByCString(&quot;lpush&quot;);</span>
<span class="lineNum">    1418 </span>                :<span class="lineCov">        131 :     server.lpopCommand = lookupCommandByCString(&quot;lpop&quot;);</span>
<span class="lineNum">    1419 </span>                :<span class="lineCov">        131 :     server.rpopCommand = lookupCommandByCString(&quot;rpop&quot;);</span>
<span class="lineNum">    1420 </span>                :            :     
<span class="lineNum">    1421 </span>                :            :     /* Slow log */
<span class="lineNum">    1422 </span>                :<span class="lineCov">        131 :     server.slowlog_log_slower_than = REDIS_SLOWLOG_LOG_SLOWER_THAN;</span>
<span class="lineNum">    1423 </span>                :<span class="lineCov">        131 :     server.slowlog_max_len = REDIS_SLOWLOG_MAX_LEN;</span>
<span class="lineNum">    1424 </span>                :            : 
<span class="lineNum">    1425 </span>                :            :     /* Debugging */
<span class="lineNum">    1426 </span>                :<span class="lineCov">        131 :     server.assert_failed = &quot;&lt;no assertion failed&gt;&quot;;</span>
<span class="lineNum">    1427 </span>                :<span class="lineCov">        131 :     server.assert_file = &quot;&lt;no file&gt;&quot;;</span>
<span class="lineNum">    1428 </span>                :<span class="lineCov">        131 :     server.assert_line = 0;</span>
<span class="lineNum">    1429 </span>                :<span class="lineCov">        131 :     server.bug_report_start = 0;</span>
<span class="lineNum">    1430 </span>                :<span class="lineCov">        131 :     server.watchdog_period = 0;</span>
<span class="lineNum">    1431 </span>                :<span class="lineCov">        131 : }</span>
<span class="lineNum">    1432 </span>                :            : 
<span class="lineNum">    1433 </span>                :            : /* This function will try to raise the max number of open files accordingly to
<span class="lineNum">    1434 </span>                :            :  * the configured max number of clients. It will also account for 32 additional
<span class="lineNum">    1435 </span>                :            :  * file descriptors as we need a few more for persistence, listening
<span class="lineNum">    1436 </span>                :            :  * sockets, log files and so forth.
<span class="lineNum">    1437 </span>                :            :  *
<span class="lineNum">    1438 </span>                :            :  * If it will not be possible to set the limit accordingly to the configured
<a name="1439"><span class="lineNum">    1439 </span>                :            :  * max number of clients, the function will do the reverse setting</a>
<span class="lineNum">    1440 </span>                :            :  * server.maxclients to the value that we can actually handle. */
<span class="lineNum">    1441 </span>                :<span class="lineCov">        131 : void adjustOpenFilesLimit(void) {</span>
<span class="lineNum">    1442 </span>                :<span class="lineCov">        131 :     rlim_t maxfiles = server.maxclients+32;</span>
<span class="lineNum">    1443 </span>                :            :     struct rlimit limit;
<span class="lineNum">    1444 </span>                :            : 
<span class="lineNum">    1445 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 131 times"> + </span>]:<span class="lineCov">        131 :     if (getrlimit(RLIMIT_NOFILE,&amp;limit) == -1) {</span>
<span class="lineNum">    1446 </span>                :<span class="lineNoCov">          0 :         redisLog(REDIS_WARNING,&quot;Unable to obtain the current NOFILE limit (%s), assuming 1024 and setting the max clients configuration accordingly.&quot;,</span>
<span class="lineNum">    1447 </span>                :<span class="lineNoCov">          0 :             strerror(errno));</span>
<span class="lineNum">    1448 </span>                :<span class="lineNoCov">          0 :         server.maxclients = 1024-32;</span>
<span class="lineNum">    1449 </span>                :            :     } else {
<span class="lineNum">    1450 </span>                :<span class="lineCov">        131 :         rlim_t oldlimit = limit.rlim_cur;</span>
<span class="lineNum">    1451 </span>                :            : 
<span class="lineNum">    1452 </span>                :            :         /* Set the max number of files if the current limit is not enough
<span class="lineNum">    1453 </span>                :            :          * for our needs. */
<span class="lineNum">    1454 </span>        [<span class="branchCov" title="Branch 0 was taken 130 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">        131 :         if (oldlimit &lt; maxfiles) {</span>
<span class="lineNum">    1455 </span>                :            :             rlim_t f;
<span class="lineNum">    1456 </span>                :            :             
<span class="lineNum">    1457 </span>                :            :             f = maxfiles;
<span class="lineNum">    1458 </span>        [<span class="branchCov" title="Branch 0 was taken 1950 times"> + </span><span class="branchCov" title="Branch 1 was taken 130 times"> + </span>]:<span class="lineCov">       2080 :             while(f &gt; oldlimit) {</span>
<span class="lineNum">    1459 </span>                :<span class="lineCov">       1950 :                 limit.rlim_cur = f;</span>
<span class="lineNum">    1460 </span>                :<span class="lineCov">       1950 :                 limit.rlim_max = f;</span>
<span class="lineNum">    1461 </span>        [<span class="branchCov" title="Branch 1 was taken 1950 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1950 :                 if (setrlimit(RLIMIT_NOFILE,&amp;limit) != -1) break;</span>
<span class="lineNum">    1462 </span>                :<span class="lineCov">       1950 :                 f -= 128;</span>
<span class="lineNum">    1463 </span>                :            :             }
<span class="lineNum">    1464 </span>        [<span class="branchCov" title="Branch 0 was taken 130 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        130 :             if (f &lt; oldlimit) f = oldlimit;</span>
<span class="lineNum">    1465 </span>        [<span class="branchCov" title="Branch 0 was taken 130 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        130 :             if (f != maxfiles) {</span>
<span class="lineNum">    1466 </span>                :<span class="lineCov">        130 :                 server.maxclients = f-32;</span>
<span class="lineNum">    1467 </span>                :<span class="lineCov">        130 :                 redisLog(REDIS_WARNING,&quot;Unable to set the max number of files limit to %d (%s), setting the max clients configuration to %d.&quot;,</span>
<span class="lineNum">    1468 </span>                :<span class="lineCov">        130 :                     (int) maxfiles, strerror(errno), (int) server.maxclients);</span>
<span class="lineNum">    1469 </span>                :            :             } else {
<span class="lineNum">    1470 </span>                :<span class="lineNoCov">          0 :                 redisLog(REDIS_NOTICE,&quot;Max number of open files set to %d&quot;,</span>
<span class="lineNum">    1471 </span>                :            :                     (int) maxfiles);
<span class="lineNum">    1472 </span>                :            :             }
<span class="lineNum">    1473 </span>                :            :         }
<span class="lineNum">    1474 </span>                :            :     }
<a name="1475"><span class="lineNum">    1475 </span>                :<span class="lineCov">        131 : }</span></a>
<span class="lineNum">    1476 </span>                :            : 
<span class="lineNum">    1477 </span>                :<span class="lineCov">        131 : void initServer() {</span>
<span class="lineNum">    1478 </span>                :            :     int j;
<span class="lineNum">    1479 </span>                :            : 
<span class="lineNum">    1480 </span>                :<span class="lineCov">        131 :     signal(SIGHUP, SIG_IGN);</span>
<span class="lineNum">    1481 </span>                :<span class="lineCov">        131 :     signal(SIGPIPE, SIG_IGN);</span>
<span class="lineNum">    1482 </span>                :<span class="lineCov">        131 :     setupSignalHandlers();</span>
<span class="lineNum">    1483 </span>                :            : 
<span class="lineNum">    1484 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">        131 :     if (server.syslog_enabled) {</span>
<span class="lineNum">    1485 </span>                :<span class="lineNoCov">          0 :         openlog(server.syslog_ident, LOG_PID | LOG_NDELAY | LOG_NOWAIT,</span>
<span class="lineNum">    1486 </span>                :            :             server.syslog_facility);
<span class="lineNum">    1487 </span>                :            :     }
<span class="lineNum">    1488 </span>                :            : 
<span class="lineNum">    1489 </span>                :<span class="lineCov">        131 :     server.current_client = NULL;</span>
<span class="lineNum">    1490 </span>                :<span class="lineCov">        131 :     server.clients = listCreate();</span>
<span class="lineNum">    1491 </span>                :<span class="lineCov">        131 :     server.clients_to_close = listCreate();</span>
<span class="lineNum">    1492 </span>                :<span class="lineCov">        131 :     server.slaves = listCreate();</span>
<span class="lineNum">    1493 </span>                :<span class="lineCov">        131 :     server.monitors = listCreate();</span>
<span class="lineNum">    1494 </span>                :<span class="lineCov">        131 :     server.slaveseldb = -1; /* Force to emit the first SELECT command. */</span>
<span class="lineNum">    1495 </span>                :<span class="lineCov">        131 :     server.unblocked_clients = listCreate();</span>
<span class="lineNum">    1496 </span>                :<span class="lineCov">        131 :     server.ready_keys = listCreate();</span>
<span class="lineNum">    1497 </span>                :            : 
<span class="lineNum">    1498 </span>                :<span class="lineCov">        131 :     createSharedObjects();</span>
<span class="lineNum">    1499 </span>                :<span class="lineCov">        131 :     adjustOpenFilesLimit();</span>
<span class="lineNum">    1500 </span>                :<span class="lineCov">        131 :     server.el = aeCreateEventLoop(server.maxclients+REDIS_EVENTLOOP_FDSET_INCR);</span>
<span class="lineNum">    1501 </span>                :<span class="lineCov">        131 :     server.db = zmalloc(sizeof(redisDb)*server.dbnum);</span>
<span class="lineNum">    1502 </span>                :            : 
<span class="lineNum">    1503 </span>                :            :     /* Open the TCP listening sockets. */
<span class="lineNum">    1504 </span>        [<span class="branchCov" title="Branch 0 was taken 131 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        131 :     if (server.port != 0) {</span>
<span class="lineNum">    1505 </span>                :            :         /* Force binding of 0.0.0.0 if no bind address is specified, always
<span class="lineNum">    1506 </span>                :            :          * entering the loop if j == 0. */
<span class="lineNum">    1507 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">        131 :         if (server.bindaddr_count == 0) server.bindaddr[0] = NULL;</span>
<span class="lineNum">    1508 </span>        [<span class="branchCov" title="Branch 0 was taken 131 times"> + </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">        262 :         for (j = 0; j &lt; server.bindaddr_count || j == 0; j++) {</span>
<span class="lineNum">    1509 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">        131 :             if (server.bindaddr[j] == NULL) {</span>
<span class="lineNum">    1510 </span>                :            :                 /* Bind * for both IPv6 and IPv4. */
<span class="lineNum">    1511 </span>                :<span class="lineNoCov">          0 :                 server.ipfd[0] = anetTcp6Server(server.neterr,server.port,NULL);</span>
<span class="lineNum">    1512 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (server.ipfd[0] != ANET_ERR) server.ipfd_count++;</span>
<span class="lineNum">    1513 </span>                :<span class="lineNoCov">          0 :                 server.ipfd[1] = anetTcpServer(server.neterr,server.port,NULL);</span>
<span class="lineNum">    1514 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">        131 :             } else if (strchr(server.bindaddr[j],':')) {</span>
<span class="lineNum">    1515 </span>                :            :                 /* Bind IPv6 address. */
<span class="lineNum">    1516 </span>                :<span class="lineNoCov">          0 :                 server.ipfd[server.ipfd_count] = anetTcp6Server(server.neterr,server.port,server.bindaddr[j]);</span>
<span class="lineNum">    1517 </span>                :            :             } else {
<span class="lineNum">    1518 </span>                :            :                 /* Bind IPv4 address. */
<span class="lineNum">    1519 </span>                :<span class="lineCov">        131 :                 server.ipfd[server.ipfd_count] = anetTcpServer(server.neterr,server.port,server.bindaddr[j]);</span>
<span class="lineNum">    1520 </span>                :            :             }
<span class="lineNum">    1521 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">        131 :             if (server.ipfd[server.ipfd_count] == ANET_ERR) {</span>
<span class="lineNum">    1522 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 redisLog(REDIS_WARNING,</span>
<span class="lineNum">    1523 </span>                :            :                     &quot;Creating Server TCP listening socket %s:%d: %s&quot;,
<span class="lineNum">    1524 </span>                :<span class="lineNoCov">          0 :                     server.bindaddr[j] ? server.bindaddr[j] : &quot;*&quot;,</span>
<span class="lineNum">    1525 </span>                :            :                     server.port, server.neterr);
<span class="lineNum">    1526 </span>                :<span class="lineNoCov">          0 :                 exit(1);</span>
<span class="lineNum">    1527 </span>                :            :             }
<span class="lineNum">    1528 </span>                :<span class="lineCov">        131 :             server.ipfd_count++;</span>
<span class="lineNum">    1529 </span>                :            :         }
<span class="lineNum">    1530 </span>                :            :     }
<span class="lineNum">    1531 </span>                :            : 
<span class="lineNum">    1532 </span>                :            :     /* Open the listening Unix domain socket. */
<span class="lineNum">    1533 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">        131 :     if (server.unixsocket != NULL) {</span>
<span class="lineNum">    1534 </span>                :<span class="lineNoCov">          0 :         unlink(server.unixsocket); /* don't care if this fails */</span>
<span class="lineNum">    1535 </span>                :<span class="lineNoCov">          0 :         server.sofd = anetUnixServer(server.neterr,server.unixsocket,server.unixsocketperm);</span>
<span class="lineNum">    1536 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (server.sofd == ANET_ERR) {</span>
<span class="lineNum">    1537 </span>                :<span class="lineNoCov">          0 :             redisLog(REDIS_WARNING, &quot;Opening socket: %s&quot;, server.neterr);</span>
<span class="lineNum">    1538 </span>                :<span class="lineNoCov">          0 :             exit(1);</span>
<span class="lineNum">    1539 </span>                :            :         }
<span class="lineNum">    1540 </span>                :            :     }
<span class="lineNum">    1541 </span>                :            : 
<span class="lineNum">    1542 </span>                :            :     /* Abort if there are no listening sockets at all. */
<span class="lineNum">    1543 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">        131 :     if (server.ipfd_count == 0 &amp;&amp; server.sofd &lt; 0) {</span>
<span class="lineNum">    1544 </span>                :<span class="lineNoCov">          0 :         redisLog(REDIS_WARNING, &quot;Configured to not listen anywhere, exiting.&quot;);</span>
<span class="lineNum">    1545 </span>                :<span class="lineNoCov">          0 :         exit(1);</span>
<span class="lineNum">    1546 </span>                :            :     }
<span class="lineNum">    1547 </span>                :            : 
<span class="lineNum">    1548 </span>                :            :     /* Create the Redis databases, and initialize other internal state. */
<span class="lineNum">    1549 </span>        [<span class="branchCov" title="Branch 0 was taken 2096 times"> + </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">       2227 :     for (j = 0; j &lt; server.dbnum; j++) {</span>
<span class="lineNum">    1550 </span>                :<span class="lineCov">       2096 :         server.db[j].dict = dictCreate(&amp;dbDictType,NULL);</span>
<span class="lineNum">    1551 </span>                :<span class="lineCov">       2096 :         server.db[j].expires = dictCreate(&amp;keyptrDictType,NULL);</span>
<span class="lineNum">    1552 </span>                :<span class="lineCov">       2096 :         server.db[j].blocking_keys = dictCreate(&amp;keylistDictType,NULL);</span>
<span class="lineNum">    1553 </span>                :<span class="lineCov">       2096 :         server.db[j].ready_keys = dictCreate(&amp;setDictType,NULL);</span>
<span class="lineNum">    1554 </span>                :<span class="lineCov">       2096 :         server.db[j].watched_keys = dictCreate(&amp;keylistDictType,NULL);</span>
<span class="lineNum">    1555 </span>                :<span class="lineCov">       2096 :         server.db[j].id = j;</span>
<span class="lineNum">    1556 </span>                :<span class="lineCov">       2096 :         server.db[j].avg_ttl = 0;</span>
<span class="lineNum">    1557 </span>                :            :     }
<span class="lineNum">    1558 </span>                :<span class="lineCov">        131 :     server.pubsub_channels = dictCreate(&amp;keylistDictType,NULL);</span>
<span class="lineNum">    1559 </span>                :<span class="lineCov">        131 :     server.pubsub_patterns = listCreate();</span>
<span class="lineNum">    1560 </span>                :<span class="lineCov">        131 :     listSetFreeMethod(server.pubsub_patterns,freePubsubPattern);</span>
<span class="lineNum">    1561 </span>                :<span class="lineCov">        131 :     listSetMatchMethod(server.pubsub_patterns,listMatchPubsubPattern);</span>
<span class="lineNum">    1562 </span>                :<span class="lineCov">        131 :     server.cronloops = 0;</span>
<span class="lineNum">    1563 </span>                :<span class="lineCov">        131 :     server.rdb_child_pid = -1;</span>
<span class="lineNum">    1564 </span>                :<span class="lineCov">        131 :     server.aof_child_pid = -1;</span>
<span class="lineNum">    1565 </span>                :<span class="lineCov">        131 :     aofRewriteBufferReset();</span>
<span class="lineNum">    1566 </span>                :<span class="lineCov">        131 :     server.aof_buf = sdsempty();</span>
<span class="lineNum">    1567 </span>                :<span class="lineCov">        131 :     server.lastsave = time(NULL); /* At startup we consider the DB saved. */</span>
<span class="lineNum">    1568 </span>                :<span class="lineCov">        131 :     server.lastbgsave_try = 0;    /* At startup we never tried to BGSAVE. */</span>
<span class="lineNum">    1569 </span>                :<span class="lineCov">        131 :     server.rdb_save_time_last = -1;</span>
<span class="lineNum">    1570 </span>                :<span class="lineCov">        131 :     server.rdb_save_time_start = -1;</span>
<span class="lineNum">    1571 </span>                :<span class="lineCov">        131 :     server.dirty = 0;</span>
<span class="lineNum">    1572 </span>                :<span class="lineCov">        131 :     server.stat_numcommands = 0;</span>
<span class="lineNum">    1573 </span>                :<span class="lineCov">        131 :     server.stat_numconnections = 0;</span>
<span class="lineNum">    1574 </span>                :<span class="lineCov">        131 :     server.stat_expiredkeys = 0;</span>
<span class="lineNum">    1575 </span>                :<span class="lineCov">        131 :     server.stat_evictedkeys = 0;</span>
<span class="lineNum">    1576 </span>                :<span class="lineCov">        131 :     server.stat_starttime = time(NULL);</span>
<span class="lineNum">    1577 </span>                :<span class="lineCov">        131 :     server.stat_keyspace_misses = 0;</span>
<span class="lineNum">    1578 </span>                :<span class="lineCov">        131 :     server.stat_keyspace_hits = 0;</span>
<span class="lineNum">    1579 </span>                :<span class="lineCov">        131 :     server.stat_peak_memory = 0;</span>
<span class="lineNum">    1580 </span>                :<span class="lineCov">        131 :     server.stat_fork_time = 0;</span>
<span class="lineNum">    1581 </span>                :<span class="lineCov">        131 :     server.stat_rejected_conn = 0;</span>
<span class="lineNum">    1582 </span>                :<span class="lineCov">        131 :     server.stat_sync_full = 0;</span>
<span class="lineNum">    1583 </span>                :<span class="lineCov">        131 :     server.stat_sync_partial_ok = 0;</span>
<span class="lineNum">    1584 </span>                :<span class="lineCov">        131 :     server.stat_sync_partial_err = 0;</span>
<span class="lineNum">    1585 </span>                :            :     memset(server.ops_sec_samples,0,sizeof(server.ops_sec_samples));
<span class="lineNum">    1586 </span>                :<span class="lineCov">        131 :     server.ops_sec_idx = 0;</span>
<span class="lineNum">    1587 </span>                :<span class="lineCov">        131 :     server.ops_sec_last_sample_time = mstime();</span>
<span class="lineNum">    1588 </span>                :<span class="lineCov">        131 :     server.ops_sec_last_sample_ops = 0;</span>
<span class="lineNum">    1589 </span>                :<span class="lineCov">        131 :     server.unixtime = time(NULL);</span>
<span class="lineNum">    1590 </span>                :<span class="lineCov">        131 :     server.mstime = mstime();</span>
<span class="lineNum">    1591 </span>                :<span class="lineCov">        131 :     server.lastbgsave_status = REDIS_OK;</span>
<span class="lineNum">    1592 </span>                :<span class="lineCov">        131 :     server.repl_good_slaves_count = 0;</span>
<span class="lineNum">    1593 </span>                :            : 
<span class="lineNum">    1594 </span>                :            :     /* Create the serverCron() time event, that's our main way to process
<span class="lineNum">    1595 </span>                :            :      * background operations. */
<span class="lineNum">    1596 </span>        [<span class="branchCov" title="Branch 1 was taken 131 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        131 :     if(aeCreateTimeEvent(server.el, 1, serverCron, NULL, NULL) == AE_ERR) {</span>
<span class="lineNum">    1597 </span>                :<span class="lineNoCov">          0 :         redisPanic(&quot;Can't create the serverCron time event.&quot;);</span>
<span class="lineNum">    1598 </span>                :            :         exit(1);
<span class="lineNum">    1599 </span>                :            :     }
<span class="lineNum">    1600 </span>                :            : 
<span class="lineNum">    1601 </span>                :            :     /* Create an event handler for accepting new connections in TCP and Unix
<span class="lineNum">    1602 </span>                :            :      * domain sockets. */
<span class="lineNum">    1603 </span>        [<span class="branchCov" title="Branch 0 was taken 131 times"> + </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">        262 :     for (j = 0; j &lt; server.ipfd_count; j++) {</span>
<span class="lineNum">    1604 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 131 times"> + </span>]:<span class="lineCov">        131 :         if (aeCreateFileEvent(server.el, server.ipfd[j], AE_READABLE,</span>
<span class="lineNum">    1605 </span>                :            :             acceptTcpHandler,NULL) == AE_ERR)
<span class="lineNum">    1606 </span>                :            :             {
<span class="lineNum">    1607 </span>                :<span class="lineNoCov">          0 :                 redisPanic(</span>
<span class="lineNum">    1608 </span>                :            :                     &quot;Unrecoverable error creating server.ipfd file event.&quot;);
<span class="lineNum">    1609 </span>                :            :             }
<span class="lineNum">    1610 </span>                :            :     }
<span class="lineNum">    1611 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineCov">        131 :     if (server.sofd &gt; 0 &amp;&amp; aeCreateFileEvent(server.el,server.sofd,AE_READABLE,</span>
<span class="lineNum">    1612 </span>                :<span class="lineNoCov">          0 :         acceptUnixHandler,NULL) == AE_ERR) redisPanic(&quot;Unrecoverable error creating server.sofd file event.&quot;);</span>
<span class="lineNum">    1613 </span>                :            : 
<span class="lineNum">    1614 </span>                :            :     /* Open the AOF file if needed. */
<span class="lineNum">    1615 </span>        [<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchCov" title="Branch 1 was taken 125 times"> + </span>]:<span class="lineCov">        131 :     if (server.aof_state == REDIS_AOF_ON) {</span>
<span class="lineNum">    1616 </span>                :<span class="lineCov">         12 :         server.aof_fd = open(server.aof_filename,</span>
<span class="lineNum">    1617 </span>                :            :                                O_WRONLY|O_APPEND|O_CREAT,0644);
<span class="lineNum">    1618 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">          6 :         if (server.aof_fd == -1) {</span>
<span class="lineNum">    1619 </span>                :<span class="lineNoCov">          0 :             redisLog(REDIS_WARNING, &quot;Can't open the append-only file: %s&quot;,</span>
<span class="lineNum">    1620 </span>                :<span class="lineNoCov">          0 :                 strerror(errno));</span>
<span class="lineNum">    1621 </span>                :<span class="lineNoCov">          0 :             exit(1);</span>
<span class="lineNum">    1622 </span>                :            :         }
<span class="lineNum">    1623 </span>                :            :     }
<span class="lineNum">    1624 </span>                :            : 
<span class="lineNum">    1625 </span>                :            :     /* 32 bit instances are limited to 4GB of address space, so if there is
<span class="lineNum">    1626 </span>                :            :      * no explicit limit in the user provided configuration we set a limit
<span class="lineNum">    1627 </span>                :            :      * at 3 GB using maxmemory with 'noeviction' policy'. This avoids
<span class="lineNum">    1628 </span>                :            :      * useless crashes of the Redis instance for out of memory. */
<span class="lineNum">    1629 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">        131 :     if (server.arch_bits == 32 &amp;&amp; server.maxmemory == 0) {</span>
<span class="lineNum">    1630 </span>                :<span class="lineNoCov">          0 :         redisLog(REDIS_WARNING,&quot;Warning: 32 bit instance detected but no memory limit set. Setting 3 GB maxmemory limit with 'noeviction' policy now.&quot;);</span>
<span class="lineNum">    1631 </span>                :<span class="lineNoCov">          0 :         server.maxmemory = 3072LL*(1024*1024); /* 3 GB */</span>
<span class="lineNum">    1632 </span>                :<span class="lineNoCov">          0 :         server.maxmemory_policy = REDIS_MAXMEMORY_NO_EVICTION;</span>
<span class="lineNum">    1633 </span>                :            :     }
<span class="lineNum">    1634 </span>                :            : 
<span class="lineNum">    1635 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">        131 :     if (server.cluster_enabled) clusterInit();</span>
<span class="lineNum">    1636 </span>                :<span class="lineCov">        131 :     replicationScriptCacheInit();</span>
<span class="lineNum">    1637 </span>                :<span class="lineCov">        131 :     scriptingInit();</span>
<span class="lineNum">    1638 </span>                :<span class="lineCov">        131 :     slowlogInit();</span>
<span class="lineNum">    1639 </span>                :<span class="lineCov">        131 :     bioInit();</span>
<span class="lineNum">    1640 </span>                :<span class="lineCov">        131 : }</span>
<span class="lineNum">    1641 </span>                :            : 
<a name="1642"><span class="lineNum">    1642 </span>                :            : /* Populates the Redis Command Table starting from the hard coded list</a>
<span class="lineNum">    1643 </span>                :            :  * we have on top of redis.c file. */
<span class="lineNum">    1644 </span>                :<span class="lineCov">        131 : void populateCommandTable(void) {</span>
<span class="lineNum">    1645 </span>                :            :     int j;
<span class="lineNum">    1646 </span>                :<span class="lineCov">        131 :     int numcommands = sizeof(redisCommandTable)/sizeof(struct redisCommand);</span>
<span class="lineNum">    1647 </span>                :            : 
<span class="lineNum">    1648 </span>        [<span class="branchCov" title="Branch 0 was taken 18733 times"> + </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">      18864 :     for (j = 0; j &lt; numcommands; j++) {</span>
<span class="lineNum">    1649 </span>                :<span class="lineCov">      18733 :         struct redisCommand *c = redisCommandTable+j;</span>
<span class="lineNum">    1650 </span>                :<span class="lineCov">      18733 :         char *f = c-&gt;sflags;</span>
<span class="lineNum">    1651 </span>                :            :         int retval1, retval2;
<span class="lineNum">    1652 </span>                :            : 
<span class="lineNum">    1653 </span>        [<span class="branchCov" title="Branch 0 was taken 34191 times"> + </span><span class="branchCov" title="Branch 1 was taken 18733 times"> + </span>]:<span class="lineCov">      52924 :         while(*f != '\0') {</span>
<span class="lineNum">    1654 </span>  [<span class="branchCov" title="Branch 0 was taken 8515 times"> + </span><span class="branchCov" title="Branch 1 was taken 9563 times"> + </span><span class="branchCov" title="Branch 2 was taken 5240 times"> + </span><span class="branchCov" title="Branch 3 was taken 2358 times"> + </span> :<span class="lineCov">      34191 :             switch(*f) {</span>
<span class="lineNum">         </span><span class="branchCov" title="Branch 4 was taken 786 times"> + </span><span class="branchCov" title="Branch 5 was taken 3144 times"> + </span><span class="branchCov" title="Branch 6 was taken 786 times"> + </span><span class="branchCov" title="Branch 7 was taken 917 times"> + </span><span class="branchCov" title="Branch 8 was taken 1441 times"> + </span> 
<span class="lineNum">         </span>   <span class="branchCov" title="Branch 9 was taken 1179 times"> + </span><span class="branchCov" title="Branch 10 was taken 131 times"> + </span><span class="branchCov" title="Branch 11 was taken 131 times"> + </span><span class="branchNoCov" title="Branch 12 was not taken"> - </span>]
<span class="lineNum">    1655 </span>                :<span class="lineCov">       8515 :             case 'w': c-&gt;flags |= REDIS_CMD_WRITE; break;</span>
<span class="lineNum">    1656 </span>                :<span class="lineCov">       9563 :             case 'r': c-&gt;flags |= REDIS_CMD_READONLY; break;</span>
<span class="lineNum">    1657 </span>                :<span class="lineCov">       5240 :             case 'm': c-&gt;flags |= REDIS_CMD_DENYOOM; break;</span>
<span class="lineNum">    1658 </span>                :<span class="lineCov">       2358 :             case 'a': c-&gt;flags |= REDIS_CMD_ADMIN; break;</span>
<span class="lineNum">    1659 </span>                :<span class="lineCov">        786 :             case 'p': c-&gt;flags |= REDIS_CMD_PUBSUB; break;</span>
<span class="lineNum">    1660 </span>                :<span class="lineCov">       3144 :             case 's': c-&gt;flags |= REDIS_CMD_NOSCRIPT; break;</span>
<span class="lineNum">    1661 </span>                :<span class="lineCov">        786 :             case 'R': c-&gt;flags |= REDIS_CMD_RANDOM; break;</span>
<span class="lineNum">    1662 </span>                :<span class="lineCov">        917 :             case 'S': c-&gt;flags |= REDIS_CMD_SORT_FOR_SCRIPT; break;</span>
<span class="lineNum">    1663 </span>                :<span class="lineCov">       1441 :             case 'l': c-&gt;flags |= REDIS_CMD_LOADING; break;</span>
<span class="lineNum">    1664 </span>                :<span class="lineCov">       1179 :             case 't': c-&gt;flags |= REDIS_CMD_STALE; break;</span>
<span class="lineNum">    1665 </span>                :<span class="lineCov">        131 :             case 'M': c-&gt;flags |= REDIS_CMD_SKIP_MONITOR; break;</span>
<span class="lineNum">    1666 </span>                :<span class="lineCov">        131 :             case 'k': c-&gt;flags |= REDIS_CMD_ASKING; break;</span>
<span class="lineNum">    1667 </span>                :<span class="lineNoCov">          0 :             default: redisPanic(&quot;Unsupported command flag&quot;); break;</span>
<span class="lineNum">    1668 </span>                :            :             }
<span class="lineNum">    1669 </span>                :<span class="lineCov">      34191 :             f++;</span>
<span class="lineNum">    1670 </span>                :            :         }
<span class="lineNum">    1671 </span>                :            : 
<span class="lineNum">    1672 </span>                :<span class="lineCov">      18733 :         retval1 = dictAdd(server.commands, sdsnew(c-&gt;name), c);</span>
<span class="lineNum">    1673 </span>                :            :         /* Populate an additional dictionary that will be unaffected
<span class="lineNum">    1674 </span>                :            :          * by rename-command statements in redis.conf. */
<span class="lineNum">    1675 </span>                :<span class="lineCov">      18733 :         retval2 = dictAdd(server.orig_commands, sdsnew(c-&gt;name), c);</span>
<span class="lineNum">    1676 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 18733 times"> + </span>]:<span class="lineCov">      18733 :         redisAssert(retval1 == DICT_OK &amp;&amp; retval2 == DICT_OK);</span>
<span class="lineNum">    1677 </span>                :            :     }
<a name="1678"><span class="lineNum">    1678 </span>                :<span class="lineCov">        131 : }</span></a>
<span class="lineNum">    1679 </span>                :            : 
<span class="lineNum">    1680 </span>                :<span class="lineNoCov">          0 : void resetCommandTableStats(void) {</span>
<span class="lineNum">    1681 </span>                :<span class="lineNoCov">          0 :     int numcommands = sizeof(redisCommandTable)/sizeof(struct redisCommand);</span>
<span class="lineNum">    1682 </span>                :            :     int j;
<span class="lineNum">    1683 </span>                :            : 
<span class="lineNum">    1684 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (j = 0; j &lt; numcommands; j++) {</span>
<span class="lineNum">    1685 </span>                :<span class="lineNoCov">          0 :         struct redisCommand *c = redisCommandTable+j;</span>
<span class="lineNum">    1686 </span>                :            : 
<span class="lineNum">    1687 </span>                :<span class="lineNoCov">          0 :         c-&gt;microseconds = 0;</span>
<span class="lineNum">    1688 </span>                :<span class="lineNoCov">          0 :         c-&gt;calls = 0;</span>
<span class="lineNum">    1689 </span>                :            :     }
<span class="lineNum">    1690 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1691 </span>                :            : 
<a name="1692"><span class="lineNum">    1692 </span>                :            : /* ========================== Redis OP Array API ============================ */</a>
<a name="1693"><span class="lineNum">    1693 </span>                :            : </a>
<span class="lineNum">    1694 </span>                :<span class="lineNoCov">          0 : void redisOpArrayInit(redisOpArray *oa) {</span>
<span class="lineNum">    1695 </span>                :<span class="lineCov">    6063809 :     oa-&gt;ops = NULL;</span>
<span class="lineNum">    1696 </span>                :<span class="lineCov">    6063809 :     oa-&gt;numops = 0;</span>
<a name="1697"><span class="lineNum">    1697 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1698 </span>                :            : 
<span class="lineNum">    1699 </span>                :<span class="lineNoCov">          0 : int redisOpArrayAppend(redisOpArray *oa, struct redisCommand *cmd, int dbid,</span>
<span class="lineNum">    1700 </span>                :            :                        robj **argv, int argc, int target)
<span class="lineNum">    1701 </span>                :            : {
<span class="lineNum">    1702 </span>                :            :     redisOp *op;
<span class="lineNum">    1703 </span>                :            : 
<span class="lineNum">    1704 </span>                :<span class="lineNoCov">          0 :     oa-&gt;ops = zrealloc(oa-&gt;ops,sizeof(redisOp)*(oa-&gt;numops+1));</span>
<span class="lineNum">    1705 </span>                :<span class="lineNoCov">          0 :     op = oa-&gt;ops+oa-&gt;numops;</span>
<span class="lineNum">    1706 </span>                :<span class="lineNoCov">          0 :     op-&gt;cmd = cmd;</span>
<span class="lineNum">    1707 </span>                :<span class="lineNoCov">          0 :     op-&gt;dbid = dbid;</span>
<span class="lineNum">    1708 </span>                :<span class="lineNoCov">          0 :     op-&gt;argv = argv;</span>
<span class="lineNum">    1709 </span>                :<span class="lineNoCov">          0 :     op-&gt;argc = argc;</span>
<span class="lineNum">    1710 </span>                :<span class="lineNoCov">          0 :     op-&gt;target = target;</span>
<span class="lineNum">    1711 </span>                :<span class="lineNoCov">          0 :     oa-&gt;numops++;</span>
<span class="lineNum">    1712 </span>                :<span class="lineNoCov">          0 :     return oa-&gt;numops;</span>
<a name="1713"><span class="lineNum">    1713 </span>                :            : }</a>
<span class="lineNum">    1714 </span>                :            : 
<span class="lineNum">    1715 </span>                :<span class="lineNoCov">          0 : void redisOpArrayFree(redisOpArray *oa) {</span>
<span class="lineNum">    1716 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     while(oa-&gt;numops) {</span>
<span class="lineNum">    1717 </span>                :            :         int j;
<span class="lineNum">    1718 </span>                :            :         redisOp *op;
<span class="lineNum">    1719 </span>                :            : 
<span class="lineNum">    1720 </span>                :<span class="lineNoCov">          0 :         oa-&gt;numops--;</span>
<span class="lineNum">    1721 </span>                :<span class="lineNoCov">          0 :         op = oa-&gt;ops+oa-&gt;numops;</span>
<span class="lineNum">    1722 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (j = 0; j &lt; op-&gt;argc; j++)</span>
<span class="lineNum">    1723 </span>                :<span class="lineNoCov">          0 :             decrRefCount(op-&gt;argv[j]);</span>
<span class="lineNum">    1724 </span>                :<span class="lineNoCov">          0 :         zfree(op-&gt;argv);</span>
<span class="lineNum">    1725 </span>                :            :     }
<span class="lineNum">    1726 </span>                :<span class="lineNoCov">          0 :     zfree(oa-&gt;ops);</span>
<span class="lineNum">    1727 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1728 </span>                :            : 
<a name="1729"><span class="lineNum">    1729 </span>                :            : /* ====================== Commands lookup and execution ===================== */</a>
<span class="lineNum">    1730 </span>                :            : 
<span class="lineNum">    1731 </span>                :<span class="lineCov">    6087748 : struct redisCommand *lookupCommand(sds name) {</span>
<span class="lineNum">    1732 </span>                :<span class="lineCov">    6087748 :     return dictFetchValue(server.commands, name);</span>
<a name="1733"><span class="lineNum">    1733 </span>                :            : }</a>
<span class="lineNum">    1734 </span>                :            : 
<span class="lineNum">    1735 </span>                :<span class="lineCov">        655 : struct redisCommand *lookupCommandByCString(char *s) {</span>
<span class="lineNum">    1736 </span>                :            :     struct redisCommand *cmd;
<span class="lineNum">    1737 </span>                :<span class="lineCov">        655 :     sds name = sdsnew(s);</span>
<span class="lineNum">    1738 </span>                :            : 
<span class="lineNum">    1739 </span>                :<span class="lineCov">        655 :     cmd = dictFetchValue(server.commands, name);</span>
<span class="lineNum">    1740 </span>                :<span class="lineCov">        655 :     sdsfree(name);</span>
<span class="lineNum">    1741 </span>                :<span class="lineCov">        655 :     return cmd;</span>
<span class="lineNum">    1742 </span>                :            : }
<span class="lineNum">    1743 </span>                :            : 
<span class="lineNum">    1744 </span>                :            : /* Lookup the command in the current table, if not found also check in
<span class="lineNum">    1745 </span>                :            :  * the original table containing the original command names unaffected by
<span class="lineNum">    1746 </span>                :            :  * redis.conf rename-command statement.
<span class="lineNum">    1747 </span>                :            :  *
<span class="lineNum">    1748 </span>                :            :  * This is used by functions rewriting the argument vector such as
<a name="1749"><span class="lineNum">    1749 </span>                :            :  * rewriteClientCommandVector() in order to set client-&gt;cmd pointer</a>
<span class="lineNum">    1750 </span>                :            :  * correctly even if the command was renamed. */
<span class="lineNum">    1751 </span>                :<span class="lineCov">     138245 : struct redisCommand *lookupCommandOrOriginal(sds name) {</span>
<span class="lineNum">    1752 </span>                :<span class="lineCov">     138245 :     struct redisCommand *cmd = dictFetchValue(server.commands, name);</span>
<span class="lineNum">    1753 </span>                :            : 
<span class="lineNum">    1754 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 138245 times"> + </span>]:<span class="lineCov">     138245 :     if (!cmd) cmd = dictFetchValue(server.orig_commands,name);</span>
<span class="lineNum">    1755 </span>                :<span class="lineCov">     138245 :     return cmd;</span>
<span class="lineNum">    1756 </span>                :            : }
<span class="lineNum">    1757 </span>                :            : 
<span class="lineNum">    1758 </span>                :            : /* Propagate the specified command (in the context of the specified database id)
<span class="lineNum">    1759 </span>                :            :  * to AOF and Slaves.
<span class="lineNum">    1760 </span>                :            :  *
<span class="lineNum">    1761 </span>                :            :  * flags are an xor between:
<span class="lineNum">    1762 </span>                :            :  * + REDIS_PROPAGATE_NONE (no propagation of command at all)
<span class="lineNum">    1763 </span>                :            :  * + REDIS_PROPAGATE_AOF (propagate into the AOF file if is enabled)
<a name="1764"><span class="lineNum">    1764 </span>                :            :  * + REDIS_PROPAGATE_REPL (propagate into the replication link)</a>
<span class="lineNum">    1765 </span>                :            :  */
<span class="lineNum">    1766 </span>                :<span class="lineCov">    4246740 : void propagate(struct redisCommand *cmd, int dbid, robj **argv, int argc,</span>
<span class="lineNum">    1767 </span>                :            :                int flags)
<span class="lineNum">    1768 </span>                :            : {
<span class="lineNum">    1769 </span>[<span class="branchCov" title="Branch 0 was taken 256756 times"> + </span><span class="branchCov" title="Branch 1 was taken 3989984 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 256756 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">    4246740 :     if (server.aof_state != REDIS_AOF_OFF &amp;&amp; flags &amp; REDIS_PROPAGATE_AOF)</span>
<span class="lineNum">    1770 </span>                :<span class="lineCov">     256756 :         feedAppendOnlyFile(cmd,dbid,argv,argc);</span>
<span class="lineNum">    1771 </span>        [<span class="branchCov" title="Branch 0 was taken 4246740 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    4246740 :     if (flags &amp; REDIS_PROPAGATE_REPL)</span>
<span class="lineNum">    1772 </span>                :<span class="lineCov">    4246740 :         replicationFeedSlaves(server.slaves,dbid,argv,argc);</span>
<span class="lineNum">    1773 </span>                :<span class="lineCov">    4246740 : }</span>
<span class="lineNum">    1774 </span>                :            : 
<a name="1775"><span class="lineNum">    1775 </span>                :            : /* Used inside commands to schedule the propagation of additional commands</a>
<span class="lineNum">    1776 </span>                :            :  * after the current command is propagated to AOF / Replication. */
<span class="lineNum">    1777 </span>                :<span class="lineNoCov">          0 : void alsoPropagate(struct redisCommand *cmd, int dbid, robj **argv, int argc,</span>
<span class="lineNum">    1778 </span>                :            :                    int target)
<span class="lineNum">    1779 </span>                :            : {
<span class="lineNum">    1780 </span>                :<span class="lineNoCov">          0 :     redisOpArrayAppend(&amp;server.also_propagate,cmd,dbid,argv,argc,target);</span>
<span class="lineNum">    1781 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1782 </span>                :            : 
<span class="lineNum">    1783 </span>                :            : /* It is possible to call the function forceCommandPropagation() inside a
<a name="1784"><span class="lineNum">    1784 </span>                :            :  * Redis command implementaiton in order to to force the propagation of a</a>
<span class="lineNum">    1785 </span>                :            :  * specific command execution into AOF / Replication. */
<span class="lineNum">    1786 </span>                :<span class="lineCov">     101997 : void forceCommandPropagation(redisClient *c, int flags) {</span>
<span class="lineNum">    1787 </span>        [<span class="branchCov" title="Branch 0 was taken 101997 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     101997 :     if (flags &amp; REDIS_PROPAGATE_REPL) c-&gt;flags |= REDIS_FORCE_REPL;</span>
<span class="lineNum">    1788 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 101995 times"> + </span>]:<span class="lineCov">     101997 :     if (flags &amp; REDIS_PROPAGATE_AOF) c-&gt;flags |= REDIS_FORCE_AOF;</span>
<span class="lineNum">    1789 </span>                :<span class="lineCov">     101997 : }</span>
<span class="lineNum">    1790 </span>                :            : 
<span class="lineNum">    1791 </span>                :            : /* Call() is the core of Redis execution of a command */
<span class="lineNum">    1792 </span>                :<span class="lineCov">    6063809 : void call(redisClient *c, int flags) {</span>
<span class="lineNum">    1793 </span>                :<span class="lineCov">    6063809 :     long long dirty, start = ustime(), duration;</span>
<span class="lineNum">    1794 </span>                :<span class="lineCov">    6063809 :     int client_old_flags = c-&gt;flags;</span>
<span class="lineNum">    1795 </span>                :            : 
<span class="lineNum">    1796 </span>                :            :     /* Sent the command to clients in MONITOR mode, only if the commands are
<span class="lineNum">    1797 </span>                :            :      * not generated from reading an AOF. */
<span class="lineNum">    1798 </span>[<span class="branchCov" title="Branch 0 was taken 17 times"> + </span><span class="branchCov" title="Branch 1 was taken 6063792 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 17 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">    6063809 :     if (listLength(server.monitors) &amp;&amp;</span>
<span class="lineNum">    1799 </span>        [<span class="branchCov" title="Branch 0 was taken 17 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         17 :         !server.loading &amp;&amp;</span>
<span class="lineNum">    1800 </span>                :<span class="lineCov">         17 :         !(c-&gt;cmd-&gt;flags &amp; REDIS_CMD_SKIP_MONITOR))</span>
<span class="lineNum">    1801 </span>                :            :     {
<span class="lineNum">    1802 </span>                :<span class="lineCov">         17 :         replicationFeedMonitors(c,server.monitors,c-&gt;db-&gt;id,c-&gt;argv,c-&gt;argc);</span>
<span class="lineNum">    1803 </span>                :            :     }
<span class="lineNum">    1804 </span>                :            : 
<span class="lineNum">    1805 </span>                :            :     /* Call the command. */
<span class="lineNum">    1806 </span>                :<span class="lineCov">    6063809 :     c-&gt;flags &amp;= ~(REDIS_FORCE_AOF|REDIS_FORCE_REPL);</span>
<span class="lineNum">    1807 </span>                :            :     redisOpArrayInit(&amp;server.also_propagate);
<span class="lineNum">    1808 </span>                :<span class="lineCov">    6063809 :     dirty = server.dirty;</span>
<span class="lineNum">    1809 </span>                :<span class="lineCov">    6063809 :     c-&gt;cmd-&gt;proc(c);</span>
<span class="lineNum">    1810 </span>                :<span class="lineCov">    6063760 :     dirty = server.dirty-dirty;</span>
<span class="lineNum">    1811 </span>                :<span class="lineCov">    6063760 :     duration = ustime()-start;</span>
<span class="lineNum">    1812 </span>                :            : 
<span class="lineNum">    1813 </span>                :            :     /* When EVAL is called loading the AOF we don't want commands called
<span class="lineNum">    1814 </span>                :            :      * from Lua to go into the slowlog or to populate statistics. */
<span class="lineNum">    1815 </span>[<span class="branchCov" title="Branch 0 was taken 263 times"> + </span><span class="branchCov" title="Branch 1 was taken 6063497 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 261 times"> + </span><span class="branchCov" title="Branch 3 was taken 2 times"> + </span>]:<span class="lineCov">    6063760 :     if (server.loading &amp;&amp; c-&gt;flags &amp; REDIS_LUA_CLIENT)</span>
<span class="lineNum">    1816 </span>                :<span class="lineCov">        261 :         flags &amp;= ~(REDIS_CALL_SLOWLOG | REDIS_CALL_STATS);</span>
<span class="lineNum">    1817 </span>                :            : 
<span class="lineNum">    1818 </span>                :            :     /* If the caller is Lua, we want to force the EVAL caller to propagate
<span class="lineNum">    1819 </span>                :            :      * the script if the command flag or client flag are forcing the
<span class="lineNum">    1820 </span>                :            :      * propagation. */
<span class="lineNum">    1821 </span>[<span class="branchCov" title="Branch 0 was taken 417075 times"> + </span><span class="branchCov" title="Branch 1 was taken 5646685 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 417075 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">    6063760 :     if (c-&gt;flags &amp; REDIS_LUA_CLIENT &amp;&amp; server.lua_caller) {</span>
<span class="lineNum">    1822 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 417075 times"> + </span>]:<span class="lineCov">     417075 :         if (c-&gt;flags &amp; REDIS_FORCE_REPL)</span>
<span class="lineNum">    1823 </span>                :<span class="lineNoCov">          0 :             server.lua_caller-&gt;flags |= REDIS_FORCE_REPL;</span>
<span class="lineNum">    1824 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 417075 times"> + </span>]:<span class="lineCov">     417075 :         if (c-&gt;flags &amp; REDIS_FORCE_AOF)</span>
<span class="lineNum">    1825 </span>                :<span class="lineNoCov">          0 :             server.lua_caller-&gt;flags |= REDIS_FORCE_AOF;</span>
<span class="lineNum">    1826 </span>                :            :     }
<span class="lineNum">    1827 </span>                :            : 
<span class="lineNum">    1828 </span>                :            :     /* Log the command into the Slow log if needed, and populate the
<span class="lineNum">    1829 </span>                :            :      * per-command statistics that we show in INFO commandstats. */
<span class="lineNum">    1830 </span>[<span class="branchCov" title="Branch 0 was taken 6063499 times"> + </span><span class="branchCov" title="Branch 1 was taken 261 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 6063329 times"> + </span><span class="branchCov" title="Branch 3 was taken 170 times"> + </span>]:<span class="lineCov">    6063760 :     if (flags &amp; REDIS_CALL_SLOWLOG &amp;&amp; c-&gt;cmd-&gt;proc != execCommand)</span>
<span class="lineNum">    1831 </span>                :<span class="lineCov">    6063329 :         slowlogPushEntryIfNeeded(c-&gt;argv,c-&gt;argc,duration);</span>
<span class="lineNum">    1832 </span>        [<span class="branchCov" title="Branch 0 was taken 6063499 times"> + </span><span class="branchCov" title="Branch 1 was taken 261 times"> + </span>]:<span class="lineCov">    6063760 :     if (flags &amp; REDIS_CALL_STATS) {</span>
<span class="lineNum">    1833 </span>                :<span class="lineCov">    6063499 :         c-&gt;cmd-&gt;microseconds += duration;</span>
<span class="lineNum">    1834 </span>                :<span class="lineCov">    6063499 :         c-&gt;cmd-&gt;calls++;</span>
<span class="lineNum">    1835 </span>                :            :     }
<span class="lineNum">    1836 </span>                :            : 
<span class="lineNum">    1837 </span>                :            :     /* Propagate the command into the AOF and replication link */
<span class="lineNum">    1838 </span>        [<span class="branchCov" title="Branch 0 was taken 5646685 times"> + </span><span class="branchCov" title="Branch 1 was taken 417075 times"> + </span>]:<span class="lineCov">    6063760 :     if (flags &amp; REDIS_CALL_PROPAGATE) {</span>
<span class="lineNum">    1839 </span>                :<span class="lineCov">    5646685 :         int flags = REDIS_PROPAGATE_NONE;</span>
<span class="lineNum">    1840 </span>                :            : 
<span class="lineNum">    1841 </span>        [<span class="branchCov" title="Branch 0 was taken 101997 times"> + </span><span class="branchCov" title="Branch 1 was taken 5544688 times"> + </span>]:<span class="lineCov">    5646685 :         if (c-&gt;flags &amp; REDIS_FORCE_REPL) flags |= REDIS_PROPAGATE_REPL;</span>
<span class="lineNum">    1842 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 5646683 times"> + </span>]:<span class="lineCov">    5646685 :         if (c-&gt;flags &amp; REDIS_FORCE_AOF) flags |= REDIS_PROPAGATE_AOF;</span>
<span class="lineNum">    1843 </span>        [<span class="branchCov" title="Branch 0 was taken 4144668 times"> + </span><span class="branchCov" title="Branch 1 was taken 1502017 times"> + </span>]:<span class="lineCov">    5646685 :         if (dirty)</span>
<span class="lineNum">    1844 </span>                :<span class="lineCov">    4144668 :             flags |= (REDIS_PROPAGATE_REPL | REDIS_PROPAGATE_AOF);</span>
<span class="lineNum">    1845 </span>        [<span class="branchCov" title="Branch 0 was taken 4246665 times"> + </span><span class="branchCov" title="Branch 1 was taken 1400020 times"> + </span>]:<span class="lineCov">    5646685 :         if (flags != REDIS_PROPAGATE_NONE)</span>
<span class="lineNum">    1846 </span>                :<span class="lineCov">    4246665 :             propagate(c-&gt;cmd,c-&gt;db-&gt;id,c-&gt;argv,c-&gt;argc,flags);</span>
<span class="lineNum">    1847 </span>                :            :     }
<span class="lineNum">    1848 </span>                :            : 
<span class="lineNum">    1849 </span>                :            :     /* Restore the old FORCE_AOF/REPL flags, since call can be executed
<span class="lineNum">    1850 </span>                :            :      * recursively. */
<span class="lineNum">    1851 </span>                :<span class="lineCov">    6063760 :     c-&gt;flags &amp;= ~(REDIS_FORCE_AOF|REDIS_FORCE_REPL);</span>
<span class="lineNum">    1852 </span>                :<span class="lineCov">    6063760 :     c-&gt;flags |= client_old_flags &amp; (REDIS_FORCE_AOF|REDIS_FORCE_REPL);</span>
<span class="lineNum">    1853 </span>                :            : 
<span class="lineNum">    1854 </span>                :            :     /* Handle the alsoPropagate() API to handle commands that want to propagate
<span class="lineNum">    1855 </span>                :            :      * multiple separated commands. */
<span class="lineNum">    1856 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 6063760 times"> + </span>]:<span class="lineCov">    6063760 :     if (server.also_propagate.numops) {</span>
<span class="lineNum">    1857 </span>                :            :         int j;
<span class="lineNum">    1858 </span>                :            :         redisOp *rop;
<span class="lineNum">    1859 </span>                :            : 
<span class="lineNum">    1860 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (j = 0; j &lt; server.also_propagate.numops; j++) {</span>
<span class="lineNum">    1861 </span>                :<span class="lineNoCov">          0 :             rop = &amp;server.also_propagate.ops[j];</span>
<span class="lineNum">    1862 </span>                :<span class="lineNoCov">          0 :             propagate(rop-&gt;cmd, rop-&gt;dbid, rop-&gt;argv, rop-&gt;argc, rop-&gt;target);</span>
<span class="lineNum">    1863 </span>                :            :         }
<span class="lineNum">    1864 </span>                :<span class="lineNoCov">          0 :         redisOpArrayFree(&amp;server.also_propagate);</span>
<span class="lineNum">    1865 </span>                :            :     }
<span class="lineNum">    1866 </span>                :<span class="lineCov">    6063760 :     server.stat_numcommands++;</span>
<span class="lineNum">    1867 </span>                :<span class="lineCov">    6063760 : }</span>
<span class="lineNum">    1868 </span>                :            : 
<span class="lineNum">    1869 </span>                :            : /* If this function gets called we already read a whole
<span class="lineNum">    1870 </span>                :            :  * command, arguments are in the client argv/argc fields.
<span class="lineNum">    1871 </span>                :            :  * processCommand() execute the command or prepare the
<span class="lineNum">    1872 </span>                :            :  * server for a bulk read from the client.
<span class="lineNum">    1873 </span>                :            :  *
<span class="lineNum">    1874 </span>                :            :  * If 1 is returned the client is still alive and valid and
<a name="1875"><span class="lineNum">    1875 </span>                :            :  * other operations can be performed by the caller. Otherwise</a>
<span class="lineNum">    1876 </span>                :            :  * if 0 is returned the client was destroyed (i.e. after QUIT). */
<span class="lineNum">    1877 </span>                :<span class="lineCov">    5648946 : int processCommand(redisClient *c) {</span>
<span class="lineNum">    1878 </span>                :            :     /* The QUIT command is handled separately. Normal command procs will
<span class="lineNum">    1879 </span>                :            :      * go through checking for replication and QUIT will cause trouble
<span class="lineNum">    1880 </span>                :            :      * when FORCE_REPLICATION is enabled and would be implemented in
<span class="lineNum">    1881 </span>                :            :      * a regular command proc. */
<span class="lineNum">    1882 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchCov" title="Branch 2 was taken 5648943 times"> + </span>]:<span class="lineCov">    5648946 :     if (!strcasecmp(c-&gt;argv[0]-&gt;ptr,&quot;quit&quot;)) {</span>
<span class="lineNum">    1883 </span>                :<span class="lineCov">          3 :         addReply(c,shared.ok);</span>
<span class="lineNum">    1884 </span>                :<span class="lineCov">          3 :         c-&gt;flags |= REDIS_CLOSE_AFTER_REPLY;</span>
<span class="lineNum">    1885 </span>                :<span class="lineCov">          3 :         return REDIS_ERR;</span>
<span class="lineNum">    1886 </span>                :            :     }
<span class="lineNum">    1887 </span>                :            : 
<span class="lineNum">    1888 </span>                :            :     /* Now lookup the command and check ASAP about trivial error conditions
<span class="lineNum">    1889 </span>                :            :      * such as wrong arity, bad command name and so forth. */
<span class="lineNum">    1890 </span>                :<span class="lineCov">    5648943 :     c-&gt;cmd = c-&gt;lastcmd = lookupCommand(c-&gt;argv[0]-&gt;ptr);</span>
<span class="lineNum">    1891 </span>        [<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchCov" title="Branch 1 was taken 5648932 times"> + </span>]:<span class="lineCov">    5648943 :     if (!c-&gt;cmd) {</span>
<span class="lineNum">    1892 </span>                :<span class="lineCov">         11 :         flagTransaction(c);</span>
<span class="lineNum">    1893 </span>                :<span class="lineCov">         11 :         addReplyErrorFormat(c,&quot;unknown command '%s'&quot;,</span>
<span class="lineNum">    1894 </span>                :<span class="lineCov">         11 :             (char*)c-&gt;argv[0]-&gt;ptr);</span>
<span class="lineNum">    1895 </span>                :<span class="lineCov">         11 :         return REDIS_OK;</span>
<span class="lineNum">    1896 </span>[<span class="branchCov" title="Branch 0 was taken 1420921 times"> + </span><span class="branchCov" title="Branch 1 was taken 4228011 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1420918 times"> + </span><span class="branchCov" title="Branch 3 was taken 3 times"> + </span>]:<span class="lineCov">    5648932 :     } else if ((c-&gt;cmd-&gt;arity &gt; 0 &amp;&amp; c-&gt;cmd-&gt;arity != c-&gt;argc) ||</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 5648929 times"> + </span>]
<span class="lineNum">    1897 </span>                :<span class="lineCov">    5648929 :                (c-&gt;argc &lt; -c-&gt;cmd-&gt;arity)) {</span>
<span class="lineNum">    1898 </span>                :<span class="lineCov">          3 :         flagTransaction(c);</span>
<span class="lineNum">    1899 </span>                :<span class="lineCov">          3 :         addReplyErrorFormat(c,&quot;wrong number of arguments for '%s' command&quot;,</span>
<span class="lineNum">    1900 </span>                :<span class="lineCov">          3 :             c-&gt;cmd-&gt;name);</span>
<span class="lineNum">    1901 </span>                :<span class="lineCov">          3 :         return REDIS_OK;</span>
<span class="lineNum">    1902 </span>                :            :     }
<span class="lineNum">    1903 </span>                :            : 
<span class="lineNum">    1904 </span>                :            :     /* Check if the user is authenticated */
<span class="lineNum">    1905 </span>[<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchCov" title="Branch 1 was taken 5648923 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 4 times"> + </span><span class="branchCov" title="Branch 3 was taken 2 times"> + </span>]:<span class="lineCov">    5648929 :     if (server.requirepass &amp;&amp; !c-&gt;authenticated &amp;&amp; c-&gt;cmd-&gt;proc != authCommand)</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 2 times"> + </span><span class="branchCov" title="Branch 5 was taken 2 times"> + </span>]
<span class="lineNum">    1906 </span>                :            :     {
<span class="lineNum">    1907 </span>                :<span class="lineCov">          2 :         flagTransaction(c);</span>
<span class="lineNum">    1908 </span>                :<span class="lineCov">          2 :         addReply(c,shared.noautherr);</span>
<span class="lineNum">    1909 </span>                :<span class="lineCov">          2 :         return REDIS_OK;</span>
<span class="lineNum">    1910 </span>                :            :     }
<span class="lineNum">    1911 </span>                :            : 
<span class="lineNum">    1912 </span>                :            :     /* If cluster is enabled perform the cluster redirection here.
<span class="lineNum">    1913 </span>                :            :      * However we don't perform the redirection if:
<span class="lineNum">    1914 </span>                :            :      * 1) The sender of this command is our master.
<span class="lineNum">    1915 </span>                :            :      * 2) The command has no key arguments. */
<span class="lineNum">    1916 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5648927 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    5648927 :     if (server.cluster_enabled &amp;&amp;</span>
<span class="lineNum">    1917 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         !(c-&gt;flags &amp; REDIS_MASTER) &amp;&amp;</span>
<span class="lineNum">    1918 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         !(c-&gt;cmd-&gt;getkeys_proc == NULL &amp;&amp; c-&gt;cmd-&gt;firstkey == 0))</span>
<span class="lineNum">    1919 </span>                :            :     {
<span class="lineNum">    1920 </span>                :            :         int hashslot;
<span class="lineNum">    1921 </span>                :            : 
<span class="lineNum">    1922 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (server.cluster-&gt;state != REDIS_CLUSTER_OK) {</span>
<span class="lineNum">    1923 </span>                :<span class="lineNoCov">          0 :             addReplySds(c,sdsnew(&quot;-CLUSTERDOWN The cluster is down. Use CLUSTER INFO for more information\r\n&quot;));</span>
<span class="lineNum">    1924 </span>                :<span class="lineNoCov">          0 :             return REDIS_OK;</span>
<span class="lineNum">    1925 </span>                :            :         } else {
<span class="lineNum">    1926 </span>                :            :             int ask;
<span class="lineNum">    1927 </span>                :<span class="lineNoCov">          0 :             clusterNode *n = getNodeByQuery(c,c-&gt;cmd,c-&gt;argv,c-&gt;argc,&amp;hashslot,&amp;ask);</span>
<span class="lineNum">    1928 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (n == NULL) {</span>
<span class="lineNum">    1929 </span>                :<span class="lineNoCov">          0 :                 addReplyError(c,&quot;Multi keys request invalid in cluster&quot;);</span>
<span class="lineNum">    1930 </span>                :<span class="lineNoCov">          0 :                 return REDIS_OK;</span>
<span class="lineNum">    1931 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             } else if (n != server.cluster-&gt;myself) {</span>
<span class="lineNum">    1932 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 addReplySds(c,sdscatprintf(sdsempty(),</span>
<span class="lineNum">    1933 </span>                :<span class="lineNoCov">          0 :                     &quot;-%s %d %s:%d\r\n&quot;, ask ? &quot;ASK&quot; : &quot;MOVED&quot;,</span>
<span class="lineNum">    1934 </span>                :<span class="lineNoCov">          0 :                     hashslot,n-&gt;ip,n-&gt;port));</span>
<span class="lineNum">    1935 </span>                :<span class="lineNoCov">          0 :                 return REDIS_OK;</span>
<span class="lineNum">    1936 </span>                :            :             }
<span class="lineNum">    1937 </span>                :            :         }
<span class="lineNum">    1938 </span>                :            :     }
<span class="lineNum">    1939 </span>                :            : 
<span class="lineNum">    1940 </span>                :            :     /* Handle the maxmemory directive.
<span class="lineNum">    1941 </span>                :            :      *
<span class="lineNum">    1942 </span>                :            :      * First we try to free some memory if possible (if there are volatile
<span class="lineNum">    1943 </span>                :            :      * keys in the dataset). If there are not the only thing we can do
<span class="lineNum">    1944 </span>                :            :      * is returning an error. */
<span class="lineNum">    1945 </span>        [<span class="branchCov" title="Branch 0 was taken 28498 times"> + </span><span class="branchCov" title="Branch 1 was taken 5620429 times"> + </span>]:<span class="lineCov">    5648927 :     if (server.maxmemory) {</span>
<span class="lineNum">    1946 </span>                :<span class="lineCov">      28498 :         int retval = freeMemoryIfNeeded();</span>
<span class="lineNum">    1947 </span>        [<span class="branchCov" title="Branch 0 was taken 2114 times"> + </span><span class="branchCov" title="Branch 1 was taken 26384 times"> + </span>]:<span class="lineCov">      28498 :         if ((c-&gt;cmd-&gt;flags &amp; REDIS_CMD_DENYOOM) &amp;&amp; retval == REDIS_ERR) {</span>
<span class="lineNum">    1948 </span>                :<span class="lineCov">       2114 :             flagTransaction(c);</span>
<span class="lineNum">    1949 </span>                :<span class="lineCov">       2114 :             addReply(c, shared.oomerr);</span>
<span class="lineNum">    1950 </span>                :<span class="lineCov">       2114 :             return REDIS_OK;</span>
<span class="lineNum">    1951 </span>                :            :         }
<span class="lineNum">    1952 </span>                :            :     }
<span class="lineNum">    1953 </span>                :            : 
<span class="lineNum">    1954 </span>                :            :     /* Don't accept write commands if there are problems persisting on disk. */
<span class="lineNum">    1955 </span>[<span class="branchCov" title="Branch 0 was taken 5646813 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 5646813 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">    5646813 :     if (server.stop_writes_on_bgsave_err &amp;&amp;</span>
<span class="lineNum">    1956 </span>                :<span class="lineCov">    5646813 :         server.saveparamslen &gt; 0</span>
<span class="lineNum">    1957 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5646813 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    5646813 :         &amp;&amp; server.lastbgsave_status == REDIS_ERR &amp;&amp;</span>
<span class="lineNum">    1958 </span>                :<span class="lineNoCov">          0 :         c-&gt;cmd-&gt;flags &amp; REDIS_CMD_WRITE)</span>
<span class="lineNum">    1959 </span>                :            :     {
<span class="lineNum">    1960 </span>                :<span class="lineNoCov">          0 :         flagTransaction(c);</span>
<span class="lineNum">    1961 </span>                :<span class="lineNoCov">          0 :         addReply(c, shared.bgsaveerr);</span>
<span class="lineNum">    1962 </span>                :<span class="lineNoCov">          0 :         return REDIS_OK;</span>
<span class="lineNum">    1963 </span>                :            :     }
<span class="lineNum">    1964 </span>                :            : 
<span class="lineNum">    1965 </span>                :            :     /* Don't accept write commands if there are not enough good slaves and
<span class="lineNum">    1966 </span>                :            :      * used configured the min-slaves-to-write option. */
<span class="lineNum">    1967 </span>[<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 5646805 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">    5646813 :     if (server.repl_min_slaves_to_write &amp;&amp;</span>
<span class="lineNum">    1968 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">          8 :         server.repl_min_slaves_max_lag &amp;&amp;</span>
<span class="lineNum">    1969 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          4 :         c-&gt;cmd-&gt;flags &amp; REDIS_CMD_WRITE &amp;&amp;</span>
<span class="lineNum">    1970 </span>                :<span class="lineCov">          4 :         server.repl_good_slaves_count &lt; server.repl_min_slaves_to_write)</span>
<span class="lineNum">    1971 </span>                :            :     {
<span class="lineNum">    1972 </span>                :<span class="lineCov">          2 :         flagTransaction(c);</span>
<span class="lineNum">    1973 </span>                :<span class="lineCov">          2 :         addReply(c, shared.noreplicaserr);</span>
<span class="lineNum">    1974 </span>                :<span class="lineCov">          2 :         return REDIS_OK;</span>
<span class="lineNum">    1975 </span>                :            :     }
<span class="lineNum">    1976 </span>                :            : 
<span class="lineNum">    1977 </span>                :            :     /* Don't accept write commands if this is a read only slave. But
<span class="lineNum">    1978 </span>                :            :      * accept write commands if this is our master. */
<span class="lineNum">    1979 </span>[<span class="branchCov" title="Branch 0 was taken 1977602 times"> + </span><span class="branchCov" title="Branch 1 was taken 3669209 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1977602 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">    5646811 :     if (server.masterhost &amp;&amp; server.repl_slave_ro &amp;&amp;</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 271 times"> + </span><span class="branchCov" title="Branch 5 was taken 1977331 times"> + </span>]
<span class="lineNum">    1980 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 271 times"> + </span>]:<span class="lineCov">        271 :         !(c-&gt;flags &amp; REDIS_MASTER) &amp;&amp;</span>
<span class="lineNum">    1981 </span>                :<span class="lineCov">        271 :         c-&gt;cmd-&gt;flags &amp; REDIS_CMD_WRITE)</span>
<span class="lineNum">    1982 </span>                :            :     {
<span class="lineNum">    1983 </span>                :<span class="lineNoCov">          0 :         addReply(c, shared.roslaveerr);</span>
<span class="lineNum">    1984 </span>                :<span class="lineNoCov">          0 :         return REDIS_OK;</span>
<span class="lineNum">    1985 </span>                :            :     }
<span class="lineNum">    1986 </span>                :            : 
<span class="lineNum">    1987 </span>                :            :     /* Only allow SUBSCRIBE and UNSUBSCRIBE in the context of Pub/Sub */
<span class="lineNum">    1988 </span>[<span class="branchCov" title="Branch 0 was taken 5646807 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 3 times"> + </span><span class="branchCov" title="Branch 3 was taken 5646804 times"> + </span>]:<span class="lineCov">    5646811 :     if ((dictSize(c-&gt;pubsub_channels) &gt; 0 || listLength(c-&gt;pubsub_patterns) &gt; 0)</span>
<span class="lineNum">    1989 </span>        [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          7 :         &amp;&amp;</span>
<span class="lineNum">    1990 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          7 :         c-&gt;cmd-&gt;proc != subscribeCommand &amp;&amp;</span>
<span class="lineNum">    1991 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          4 :         c-&gt;cmd-&gt;proc != unsubscribeCommand &amp;&amp;</span>
<span class="lineNum">    1992 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          3 :         c-&gt;cmd-&gt;proc != psubscribeCommand &amp;&amp;</span>
<span class="lineNum">    1993 </span>                :<span class="lineCov">          3 :         c-&gt;cmd-&gt;proc != punsubscribeCommand) {</span>
<span class="lineNum">    1994 </span>                :<span class="lineNoCov">          0 :         addReplyError(c,&quot;only (P)SUBSCRIBE / (P)UNSUBSCRIBE / QUIT allowed in this context&quot;);</span>
<span class="lineNum">    1995 </span>                :<span class="lineNoCov">          0 :         return REDIS_OK;</span>
<span class="lineNum">    1996 </span>                :            :     }
<span class="lineNum">    1997 </span>                :            : 
<span class="lineNum">    1998 </span>                :            :     /* Only allow INFO and SLAVEOF when slave-serve-stale-data is no and
<span class="lineNum">    1999 </span>                :            :      * we are a slave with a broken link with master. */
<span class="lineNum">    2000 </span>[<span class="branchCov" title="Branch 0 was taken 1977602 times"> + </span><span class="branchCov" title="Branch 1 was taken 3669209 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 163 times"> + </span><span class="branchCov" title="Branch 3 was taken 1977439 times"> + </span>]:<span class="lineCov">    5646811 :     if (server.masterhost &amp;&amp; server.repl_state != REDIS_REPL_CONNECTED &amp;&amp;</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 163 times"> + </span>]
<span class="lineNum">    2001 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         server.repl_serve_stale_data == 0 &amp;&amp;</span>
<span class="lineNum">    2002 </span>                :<span class="lineNoCov">          0 :         !(c-&gt;cmd-&gt;flags &amp; REDIS_CMD_STALE))</span>
<span class="lineNum">    2003 </span>                :            :     {
<span class="lineNum">    2004 </span>                :<span class="lineNoCov">          0 :         flagTransaction(c);</span>
<span class="lineNum">    2005 </span>                :<span class="lineNoCov">          0 :         addReply(c, shared.masterdownerr);</span>
<span class="lineNum">    2006 </span>                :<span class="lineNoCov">          0 :         return REDIS_OK;</span>
<span class="lineNum">    2007 </span>                :            :     }
<span class="lineNum">    2008 </span>                :            : 
<span class="lineNum">    2009 </span>                :            :     /* Loading DB? Return an error if the command has not the
<span class="lineNum">    2010 </span>                :            :      * REDIS_CMD_LOADING flag. */
<span class="lineNum">    2011 </span>[<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 5646809 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 2 times"> + </span>]:<span class="lineCov">    5646811 :     if (server.loading &amp;&amp; !(c-&gt;cmd-&gt;flags &amp; REDIS_CMD_LOADING)) {</span>
<span class="lineNum">    2012 </span>                :<span class="lineNoCov">          0 :         addReply(c, shared.loadingerr);</span>
<span class="lineNum">    2013 </span>                :<span class="lineNoCov">          0 :         return REDIS_OK;</span>
<span class="lineNum">    2014 </span>                :            :     }
<span class="lineNum">    2015 </span>                :            : 
<span class="lineNum">    2016 </span>                :            :     /* Lua script too slow? Only allow a limited number of commands. */
<span class="lineNum">    2017 </span>[<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchCov" title="Branch 1 was taken 5646804 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">    5646811 :     if (server.lua_timedout &amp;&amp;</span>
<span class="lineNum">    2018 </span>        [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          7 :           c-&gt;cmd-&gt;proc != authCommand &amp;&amp;</span>
<span class="lineNum">    2019 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">          7 :           c-&gt;cmd-&gt;proc != replconfCommand &amp;&amp;</span>
<span class="lineNum">    2020 </span>  [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1 time"> + </span>]:<span class="lineCov">          2 :         !(c-&gt;cmd-&gt;proc == shutdownCommand &amp;&amp;</span>
<span class="lineNum">    2021 </span>                :<span class="lineCov">          1 :           c-&gt;argc == 2 &amp;&amp;</span>
<span class="lineNum">    2022 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span>]:<span class="lineCov">          7 :           tolower(((char*)c-&gt;argv[1]-&gt;ptr)[0]) == 'n') &amp;&amp;</span>
<span class="lineNum">    2023 </span>  [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 2 times"> + </span>]:<span class="lineCov">          4 :         !(c-&gt;cmd-&gt;proc == scriptCommand &amp;&amp;</span>
<span class="lineNum">    2024 </span>                :<span class="lineCov">          2 :           c-&gt;argc == 2 &amp;&amp;</span>
<span class="lineNum">    2025 </span>                :<span class="lineCov">          2 :           tolower(((char*)c-&gt;argv[1]-&gt;ptr)[0]) == 'k'))</span>
<span class="lineNum">    2026 </span>                :            :     {
<span class="lineNum">    2027 </span>                :<span class="lineCov">          4 :         flagTransaction(c);</span>
<span class="lineNum">    2028 </span>                :<span class="lineCov">          4 :         addReply(c, shared.slowscripterr);</span>
<span class="lineNum">    2029 </span>                :<span class="lineCov">          4 :         return REDIS_OK;</span>
<span class="lineNum">    2030 </span>                :            :     }
<span class="lineNum">    2031 </span>                :            : 
<span class="lineNum">    2032 </span>                :            :     /* Exec the command */
<span class="lineNum">    2033 </span>[<span class="branchCov" title="Branch 0 was taken 421 times"> + </span><span class="branchCov" title="Branch 1 was taken 5646386 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 250 times"> + </span><span class="branchCov" title="Branch 3 was taken 171 times"> + </span>]:<span class="lineCov">    5646807 :     if (c-&gt;flags &amp; REDIS_MULTI &amp;&amp;</span>
<span class="lineNum">    2034 </span>[<span class="branchCov" title="Branch 0 was taken 235 times"> + </span><span class="branchCov" title="Branch 1 was taken 15 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 230 times"> + </span><span class="branchCov" title="Branch 3 was taken 5 times"> + </span>]:<span class="lineCov">        250 :         c-&gt;cmd-&gt;proc != execCommand &amp;&amp; c-&gt;cmd-&gt;proc != discardCommand &amp;&amp;</span>
<span class="lineNum">    2035 </span>        [<span class="branchCov" title="Branch 0 was taken 225 times"> + </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">        230 :         c-&gt;cmd-&gt;proc != multiCommand &amp;&amp; c-&gt;cmd-&gt;proc != watchCommand)</span>
<span class="lineNum">    2036 </span>                :            :     {
<span class="lineNum">    2037 </span>                :<span class="lineCov">        225 :         queueMultiCommand(c);</span>
<span class="lineNum">    2038 </span>                :<span class="lineCov">        225 :         addReply(c,shared.queued);</span>
<span class="lineNum">    2039 </span>                :            :     } else {
<span class="lineNum">    2040 </span>                :<span class="lineCov">    5646582 :         call(c,REDIS_CALL_FULL);</span>
<span class="lineNum">    2041 </span>        [<span class="branchCov" title="Branch 0 was taken 31 times"> + </span><span class="branchCov" title="Branch 1 was taken 5646503 times"> + </span>]:<span class="lineCov">    5646534 :         if (listLength(server.ready_keys))</span>
<span class="lineNum">    2042 </span>                :<span class="lineCov">    5648898 :             handleClientsBlockedOnLists();</span>
<span class="lineNum">    2043 </span>                :            :     }
<span class="lineNum">    2044 </span>                :            :     return REDIS_OK;
<span class="lineNum">    2045 </span>                :            : }
<span class="lineNum">    2046 </span>                :            : 
<span class="lineNum">    2047 </span>                :            : /*================================== Shutdown =============================== */
<span class="lineNum">    2048 </span>                :            : 
<a name="2049"><span class="lineNum">    2049 </span>                :            : /* Close listening sockets. Also unlink the unix domain socket if</a>
<span class="lineNum">    2050 </span>                :            :  * unlink_unix_socket is non-zero. */
<span class="lineNum">    2051 </span>                :<span class="lineCov">        126 : void closeListeningSockets(int unlink_unix_socket) {</span>
<span class="lineNum">    2052 </span>                :            :     int j;
<span class="lineNum">    2053 </span>                :            : 
<span class="lineNum">    2054 </span>        [<span class="branchCov" title="Branch 1 was taken 126 times"> + </span><span class="branchCov" title="Branch 2 was taken 126 times"> + </span>]:<span class="lineCov">        252 :     for (j = 0; j &lt; server.ipfd_count; j++) close(server.ipfd[j]);</span>
<span class="lineNum">    2055 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 126 times"> + </span>]:<span class="lineCov">        126 :     if (server.sofd != -1) close(server.sofd);</span>
<span class="lineNum">    2056 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 126 times"> + </span>]:<span class="lineCov">        126 :     if (server.cluster_enabled)</span>
<span class="lineNum">    2057 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (j = 0; j &lt; server.cfd_count; j++) close(server.cfd[j]);</span>
<span class="lineNum">    2058 </span>[<span class="branchCov" title="Branch 0 was taken 75 times"> + </span><span class="branchCov" title="Branch 1 was taken 51 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 75 times"> + </span>]:<span class="lineCov">        126 :     if (unlink_unix_socket &amp;&amp; server.unixsocket) {</span>
<span class="lineNum">    2059 </span>                :<span class="lineNoCov">          0 :         redisLog(REDIS_NOTICE,&quot;Removing the unix socket file.&quot;);</span>
<span class="lineNum">    2060 </span>                :<span class="lineNoCov">          0 :         unlink(server.unixsocket); /* don't care if this fails */</span>
<span class="lineNum">    2061 </span>                :            :     }
<a name="2062"><span class="lineNum">    2062 </span>                :<span class="lineCov">        126 : }</span></a>
<span class="lineNum">    2063 </span>                :            : 
<span class="lineNum">    2064 </span>                :<span class="lineCov">         75 : int prepareForShutdown(int flags) {</span>
<span class="lineNum">    2065 </span>                :<span class="lineCov">         75 :     int save = flags &amp; REDIS_SHUTDOWN_SAVE;</span>
<span class="lineNum">    2066 </span>                :<span class="lineCov">         75 :     int nosave = flags &amp; REDIS_SHUTDOWN_NOSAVE;</span>
<span class="lineNum">    2067 </span>                :            : 
<span class="lineNum">    2068 </span>                :<span class="lineCov">         75 :     redisLog(REDIS_WARNING,&quot;User requested shutdown...&quot;);</span>
<span class="lineNum">    2069 </span>                :            :     /* Kill the saving child if there is a background saving in progress.
<span class="lineNum">    2070 </span>                :            :        We want to avoid race conditions, for instance our saving child may
<span class="lineNum">    2071 </span>                :            :        overwrite the synchronous saving did by SHUTDOWN. */
<span class="lineNum">    2072 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 75 times"> + </span>]:<span class="lineCov">         75 :     if (server.rdb_child_pid != -1) {</span>
<span class="lineNum">    2073 </span>                :<span class="lineNoCov">          0 :         redisLog(REDIS_WARNING,&quot;There is a child saving an .rdb. Killing it!&quot;);</span>
<span class="lineNum">    2074 </span>                :<span class="lineNoCov">          0 :         kill(server.rdb_child_pid,SIGUSR1);</span>
<span class="lineNum">    2075 </span>                :<span class="lineNoCov">          0 :         rdbRemoveTempFile(server.rdb_child_pid);</span>
<span class="lineNum">    2076 </span>                :            :     }
<span class="lineNum">    2077 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchCov" title="Branch 1 was taken 70 times"> + </span>]:<span class="lineCov">         75 :     if (server.aof_state != REDIS_AOF_OFF) {</span>
<span class="lineNum">    2078 </span>                :            :         /* Kill the AOF saving child as the AOF we already have may be longer
<span class="lineNum">    2079 </span>                :            :          * but contains the full dataset anyway. */
<span class="lineNum">    2080 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">          5 :         if (server.aof_child_pid != -1) {</span>
<span class="lineNum">    2081 </span>                :<span class="lineNoCov">          0 :             redisLog(REDIS_WARNING,</span>
<span class="lineNum">    2082 </span>                :            :                 &quot;There is a child rewriting the AOF. Killing it!&quot;);
<span class="lineNum">    2083 </span>                :<span class="lineNoCov">          0 :             kill(server.aof_child_pid,SIGUSR1);</span>
<span class="lineNum">    2084 </span>                :            :         }
<span class="lineNum">    2085 </span>                :            :         /* Append only file: fsync() the AOF and exit */
<span class="lineNum">    2086 </span>                :<span class="lineCov">          5 :         redisLog(REDIS_NOTICE,&quot;Calling fsync() on the AOF file.&quot;);</span>
<span class="lineNum">    2087 </span>                :<span class="lineCov">          5 :         aof_fsync(server.aof_fd);</span>
<span class="lineNum">    2088 </span>                :            :     }
<span class="lineNum">    2089 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 74 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1 time"> + </span>]:<span class="lineCov">         75 :     if ((server.saveparamslen &gt; 0 &amp;&amp; !nosave) || save) {</span>
<span class="lineNum">    2090 </span>                :<span class="lineCov">         74 :         redisLog(REDIS_NOTICE,&quot;Saving the final RDB snapshot before exiting.&quot;);</span>
<span class="lineNum">    2091 </span>                :            :         /* Snapshotting. Perform a SYNC SAVE and exit */
<span class="lineNum">    2092 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 74 times"> + </span>]:<span class="lineCov">         74 :         if (rdbSave(server.rdb_filename) != REDIS_OK) {</span>
<span class="lineNum">    2093 </span>                :            :             /* Ooops.. error saving! The best we can do is to continue
<span class="lineNum">    2094 </span>                :            :              * operating. Note that if there was a background saving process,
<span class="lineNum">    2095 </span>                :            :              * in the next cron() Redis will be notified that the background
<span class="lineNum">    2096 </span>                :            :              * saving aborted, handling special stuff like slaves pending for
<span class="lineNum">    2097 </span>                :            :              * synchronization... */
<span class="lineNum">    2098 </span>                :<span class="lineNoCov">          0 :             redisLog(REDIS_WARNING,&quot;Error trying to save the DB, can't exit.&quot;);</span>
<span class="lineNum">    2099 </span>                :<span class="lineNoCov">          0 :             return REDIS_ERR;</span>
<span class="lineNum">    2100 </span>                :            :         }
<span class="lineNum">    2101 </span>                :            :     }
<span class="lineNum">    2102 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 75 times"> + </span>]:<span class="lineCov">         75 :     if (server.daemonize) {</span>
<span class="lineNum">    2103 </span>                :<span class="lineNoCov">          0 :         redisLog(REDIS_NOTICE,&quot;Removing the pid file.&quot;);</span>
<span class="lineNum">    2104 </span>                :<span class="lineNoCov">          0 :         unlink(server.pidfile);</span>
<span class="lineNum">    2105 </span>                :            :     }
<span class="lineNum">    2106 </span>                :            :     /* Close the listening sockets. Apparently this allows faster restarts. */
<span class="lineNum">    2107 </span>                :<span class="lineCov">         75 :     closeListeningSockets(1);</span>
<span class="lineNum">    2108 </span>                :<span class="lineCov">         75 :     redisLog(REDIS_WARNING,&quot;Redis is now ready to exit, bye bye...&quot;);</span>
<span class="lineNum">    2109 </span>                :<span class="lineCov">         75 :     return REDIS_OK;</span>
<span class="lineNum">    2110 </span>                :            : }
<span class="lineNum">    2111 </span>                :            : 
<span class="lineNum">    2112 </span>                :            : /*================================== Commands =============================== */
<span class="lineNum">    2113 </span>                :            : 
<span class="lineNum">    2114 </span>                :            : /* Return zero if strings are the same, non-zero if they are not.
<span class="lineNum">    2115 </span>                :            :  * The comparison is performed in a way that prevents an attacker to obtain
<span class="lineNum">    2116 </span>                :            :  * information about the nature of the strings just monitoring the execution
<span class="lineNum">    2117 </span>                :            :  * time of the function.
<span class="lineNum">    2118 </span>                :            :  *
<span class="lineNum">    2119 </span>                :            :  * Note that limiting the comparison length to strings up to 512 bytes we
<span class="lineNum">    2120 </span>                :            :  * can avoid leaking any information about the password length and any
<a name="2121"><span class="lineNum">    2121 </span>                :            :  * possible branch misprediction related leak.</a>
<span class="lineNum">    2122 </span>                :            :  */
<span class="lineNum">    2123 </span>                :<span class="lineCov">          2 : int time_independent_strcmp(char *a, char *b) {</span>
<span class="lineNum">    2124 </span>                :            :     char bufa[REDIS_AUTHPASS_MAX_LEN], bufb[REDIS_AUTHPASS_MAX_LEN];
<span class="lineNum">    2125 </span>                :            :     /* The above two strlen perform len(a) + len(b) operations where either
<span class="lineNum">    2126 </span>                :            :      * a or b are fixed (our password) length, and the difference is only
<span class="lineNum">    2127 </span>                :            :      * relative to the length of the user provided string, so no information
<span class="lineNum">    2128 </span>                :            :      * leak is possible in the following two lines of code. */
<span class="lineNum">    2129 </span>                :<span class="lineCov">          2 :     int alen = strlen(a);</span>
<span class="lineNum">    2130 </span>                :<span class="lineCov">          2 :     int blen = strlen(b);</span>
<span class="lineNum">    2131 </span>                :            :     int j;
<span class="lineNum">    2132 </span>                :<span class="lineCov">          2 :     int diff = 0;</span>
<span class="lineNum">    2133 </span>                :            : 
<span class="lineNum">    2134 </span>                :            :     /* We can't compare strings longer than our static buffers.
<span class="lineNum">    2135 </span>                :            :      * Note that this will never pass the first test in practical circumstances
<span class="lineNum">    2136 </span>                :            :      * so there is no info leak. */
<span class="lineNum">    2137 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :     if (alen &gt; sizeof(bufa) || blen &gt; sizeof(bufb)) return 1;</span>
<span class="lineNum">    2138 </span>                :            : 
<span class="lineNum">    2139 </span>                :            :     memset(bufa,0,sizeof(bufa));        /* Constant time. */
<span class="lineNum">    2140 </span>                :            :     memset(bufb,0,sizeof(bufb));        /* Constant time. */
<span class="lineNum">    2141 </span>                :            :     /* Again the time of the following two copies is proportional to
<span class="lineNum">    2142 </span>                :            :      * len(a) + len(b) so no info is leaked. */
<span class="lineNum">    2143 </span>                :<span class="lineCov">          2 :     memcpy(bufa,a,alen);</span>
<span class="lineNum">    2144 </span>                :<span class="lineCov">          2 :     memcpy(bufb,b,blen);</span>
<span class="lineNum">    2145 </span>                :            : 
<span class="lineNum">    2146 </span>                :            :     /* Always compare all the chars in the two buffers without
<span class="lineNum">    2147 </span>                :            :      * conditional expressions. */
<span class="lineNum">    2148 </span>        [<span class="branchCov" title="Branch 0 was taken 1024 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">       1026 :     for (j = 0; j &lt; sizeof(bufa); j++) {</span>
<span class="lineNum">    2149 </span>                :<span class="lineCov">       1024 :         diff |= (bufa[j] ^ bufb[j]);</span>
<span class="lineNum">    2150 </span>                :            :     }
<span class="lineNum">    2151 </span>                :            :     /* Length must be equal as well. */
<span class="lineNum">    2152 </span>                :<span class="lineCov">          2 :     diff |= alen ^ blen;</span>
<span class="lineNum">    2153 </span>                :<span class="lineCov">          2 :     return diff; /* If zero strings are the same. */</span>
<a name="2154"><span class="lineNum">    2154 </span>                :            : }</a>
<span class="lineNum">    2155 </span>                :            : 
<span class="lineNum">    2156 </span>                :<span class="lineCov">          3 : void authCommand(redisClient *c) {</span>
<span class="lineNum">    2157 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          3 :     if (!server.requirepass) {</span>
<span class="lineNum">    2158 </span>                :<span class="lineCov">          1 :         addReplyError(c,&quot;Client sent AUTH, but no password is set&quot;);</span>
<span class="lineNum">    2159 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">          2 :     } else if (!time_independent_strcmp(c-&gt;argv[1]-&gt;ptr, server.requirepass)) {</span>
<span class="lineNum">    2160 </span>                :<span class="lineCov">          1 :       c-&gt;authenticated = 1;</span>
<span class="lineNum">    2161 </span>                :<span class="lineCov">          1 :       addReply(c,shared.ok);</span>
<span class="lineNum">    2162 </span>                :            :     } else {
<span class="lineNum">    2163 </span>                :<span class="lineCov">          1 :       c-&gt;authenticated = 0;</span>
<span class="lineNum">    2164 </span>                :<span class="lineCov">          1 :       addReplyError(c,&quot;invalid password&quot;);</span>
<span class="lineNum">    2165 </span>                :            :     }
<a name="2166"><span class="lineNum">    2166 </span>                :<span class="lineCov">          3 : }</span></a>
<span class="lineNum">    2167 </span>                :            : 
<span class="lineNum">    2168 </span>                :<span class="lineCov">     100356 : void pingCommand(redisClient *c) {</span>
<span class="lineNum">    2169 </span>                :<span class="lineCov">     100356 :     addReply(c,shared.pong);</span>
<a name="2170"><span class="lineNum">    2170 </span>                :<span class="lineCov">     100356 : }</span></a>
<span class="lineNum">    2171 </span>                :            : 
<span class="lineNum">    2172 </span>                :<span class="lineNoCov">          0 : void echoCommand(redisClient *c) {</span>
<span class="lineNum">    2173 </span>                :<span class="lineNoCov">          0 :     addReplyBulk(c,c-&gt;argv[1]);</span>
<a name="2174"><span class="lineNum">    2174 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2175 </span>                :            : 
<span class="lineNum">    2176 </span>                :<span class="lineNoCov">          0 : void timeCommand(redisClient *c) {</span>
<span class="lineNum">    2177 </span>                :            :     struct timeval tv;
<span class="lineNum">    2178 </span>                :            : 
<span class="lineNum">    2179 </span>                :            :     /* gettimeofday() can only fail if &amp;tv is a bad address so we
<span class="lineNum">    2180 </span>                :            :      * don't check for errors. */
<span class="lineNum">    2181 </span>                :<span class="lineNoCov">          0 :     gettimeofday(&amp;tv,NULL);</span>
<span class="lineNum">    2182 </span>                :<span class="lineNoCov">          0 :     addReplyMultiBulkLen(c,2);</span>
<span class="lineNum">    2183 </span>                :<span class="lineNoCov">          0 :     addReplyBulkLongLong(c,tv.tv_sec);</span>
<span class="lineNum">    2184 </span>                :<span class="lineNoCov">          0 :     addReplyBulkLongLong(c,tv.tv_usec);</span>
<span class="lineNum">    2185 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2186 </span>                :            : 
<a name="2187"><span class="lineNum">    2187 </span>                :            : /* Convert an amount of bytes into a human readable string in the form</a>
<span class="lineNum">    2188 </span>                :            :  * of 100B, 2G, 100M, 4K, and so forth. */
<span class="lineNum">    2189 </span>                :<span class="lineCov">      19344 : void bytesToHuman(char *s, unsigned long long n) {</span>
<span class="lineNum">    2190 </span>                :            :     double d;
<span class="lineNum">    2191 </span>                :            : 
<span class="lineNum">    2192 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 19344 times"> + </span>]:<span class="lineCov">      19344 :     if (n &lt; 1024) {</span>
<span class="lineNum">    2193 </span>                :            :         /* Bytes */
<span class="lineNum">    2194 </span>                :            :         sprintf(s,&quot;%lluB&quot;,n);
<span class="lineNum">    2195 </span>                :<span class="lineCov">      19344 :         return;</span>
<span class="lineNum">    2196 </span>        [<span class="branchCov" title="Branch 0 was taken 19186 times"> + </span><span class="branchCov" title="Branch 1 was taken 158 times"> + </span>]:<span class="lineCov">      19344 :     } else if (n &lt; (1024*1024)) {</span>
<span class="lineNum">    2197 </span>                :<span class="lineCov">      19186 :         d = (double)n/(1024);</span>
<span class="lineNum">    2198 </span>                :            :         sprintf(s,&quot;%.2fK&quot;,d);
<span class="lineNum">    2199 </span>        [<span class="branchCov" title="Branch 0 was taken 158 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        158 :     } else if (n &lt; (1024LL*1024*1024)) {</span>
<span class="lineNum">    2200 </span>                :<span class="lineCov">        158 :         d = (double)n/(1024*1024);</span>
<span class="lineNum">    2201 </span>                :            :         sprintf(s,&quot;%.2fM&quot;,d);
<span class="lineNum">    2202 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     } else if (n &lt; (1024LL*1024*1024*1024)) {</span>
<span class="lineNum">    2203 </span>                :<span class="lineNoCov">          0 :         d = (double)n/(1024LL*1024*1024);</span>
<span class="lineNum">    2204 </span>                :            :         sprintf(s,&quot;%.2fG&quot;,d);
<span class="lineNum">    2205 </span>                :            :     }
<span class="lineNum">    2206 </span>                :            : }
<span class="lineNum">    2207 </span>                :            : 
<span class="lineNum">    2208 </span>                :            : /* Create the string returned by the INFO command. This is decoupled
<span class="lineNum">    2209 </span>                :            :  * by the INFO command itself as we need to report the same information
<span class="lineNum">    2210 </span>                :            :  * on memory corruption problems. */
<span class="lineNum">    2211 </span>                :<span class="lineCov">       9698 : sds genRedisInfoString(char *section) {</span>
<span class="lineNum">    2212 </span>                :<span class="lineCov">       9698 :     sds info = sdsempty();</span>
<span class="lineNum">    2213 </span>                :<span class="lineCov">       9698 :     time_t uptime = server.unixtime-server.stat_starttime;</span>
<span class="lineNum">    2214 </span>                :            :     int j, numcommands;
<span class="lineNum">    2215 </span>                :            :     struct rusage self_ru, c_ru;
<span class="lineNum">    2216 </span>                :            :     unsigned long lol, bib;
<span class="lineNum">    2217 </span>                :<span class="lineCov">       9698 :     int allsections = 0, defsections = 0;</span>
<span class="lineNum">    2218 </span>                :<span class="lineCov">       9698 :     int sections = 0;</span>
<span class="lineNum">    2219 </span>                :            : 
<span class="lineNum">    2220 </span>        [<span class="branchCov" title="Branch 0 was taken 9698 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       9698 :     if (section) {</span>
<span class="lineNum">    2221 </span>                :<span class="lineCov">       9698 :         allsections = strcasecmp(section,&quot;all&quot;) == 0;</span>
<span class="lineNum">    2222 </span>                :<span class="lineCov">       9698 :         defsections = strcasecmp(section,&quot;default&quot;) == 0;</span>
<span class="lineNum">    2223 </span>                :            :     }
<span class="lineNum">    2224 </span>                :            : 
<span class="lineNum">    2225 </span>                :<span class="lineCov">       9698 :     getrusage(RUSAGE_SELF, &amp;self_ru);</span>
<span class="lineNum">    2226 </span>                :<span class="lineCov">       9698 :     getrusage(RUSAGE_CHILDREN, &amp;c_ru);</span>
<span class="lineNum">    2227 </span>                :<span class="lineCov">       9698 :     getClientsMaxBuffers(&amp;lol,&amp;bib);</span>
<span class="lineNum">    2228 </span>                :            : 
<span class="lineNum">    2229 </span>                :            :     /* Server */
<span class="lineNum">    2230 </span>[<span class="branchCov" title="Branch 0 was taken 26 times"> + </span><span class="branchCov" title="Branch 1 was taken 9672 times"> + </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 26 times"> + </span>]:<span class="lineCov">       9698 :     if (allsections || defsections || !strcasecmp(section,&quot;server&quot;)) {</span>
<span class="lineNum">    2231 </span>                :            :         struct utsname name;
<span class="lineNum">    2232 </span>                :            :         char *mode;
<span class="lineNum">    2233 </span>                :            : 
<span class="lineNum">    2234 </span>        [<span class="branchCov" title="Branch 0 was taken 9672 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       9672 :         if (server.cluster_enabled) mode = &quot;cluster&quot;;</span>
<span class="lineNum">    2235 </span>        [<span class="branchCov" title="Branch 0 was taken 9672 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       9672 :         else if (server.sentinel_mode) mode = &quot;sentinel&quot;;</span>
<span class="lineNum">    2236 </span>                :<span class="lineCov">       9672 :         else mode = &quot;standalone&quot;;</span>
<span class="lineNum">    2237 </span>                :            :     
<span class="lineNum">    2238 </span>                :<span class="lineCov">       9672 :         if (sections++) info = sdscat(info,&quot;\r\n&quot;);</span>
<span class="lineNum">    2239 </span>                :<span class="lineCov">       9672 :         uname(&amp;name);</span>
<span class="lineNum">    2240 </span>        [<span class="branchCov" title="Branch 0 was taken 9672 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      29016 :         info = sdscatprintf(info,</span>
<span class="lineNum">    2241 </span>                :            :             &quot;# Server\r\n&quot;
<span class="lineNum">    2242 </span>                :            :             &quot;redis_version:%s\r\n&quot;
<span class="lineNum">    2243 </span>                :            :             &quot;redis_git_sha1:%s\r\n&quot;
<span class="lineNum">    2244 </span>                :            :             &quot;redis_git_dirty:%d\r\n&quot;
<span class="lineNum">    2245 </span>                :            :             &quot;redis_build_id:%llx\r\n&quot;
<span class="lineNum">    2246 </span>                :            :             &quot;redis_mode:%s\r\n&quot;
<span class="lineNum">    2247 </span>                :            :             &quot;os:%s %s %s\r\n&quot;
<span class="lineNum">    2248 </span>                :            :             &quot;arch_bits:%d\r\n&quot;
<span class="lineNum">    2249 </span>                :            :             &quot;multiplexing_api:%s\r\n&quot;
<span class="lineNum">    2250 </span>                :            :             &quot;gcc_version:%d.%d.%d\r\n&quot;
<span class="lineNum">    2251 </span>                :            :             &quot;process_id:%ld\r\n&quot;
<span class="lineNum">    2252 </span>                :            :             &quot;run_id:%s\r\n&quot;
<span class="lineNum">    2253 </span>                :            :             &quot;tcp_port:%d\r\n&quot;
<span class="lineNum">    2254 </span>                :            :             &quot;uptime_in_seconds:%jd\r\n&quot;
<span class="lineNum">    2255 </span>                :            :             &quot;uptime_in_days:%jd\r\n&quot;
<span class="lineNum">    2256 </span>                :            :             &quot;hz:%d\r\n&quot;
<span class="lineNum">    2257 </span>                :            :             &quot;lru_clock:%ld\r\n&quot;
<span class="lineNum">    2258 </span>                :            :             &quot;config_file:%s\r\n&quot;,
<span class="lineNum">    2259 </span>                :            :             REDIS_VERSION,
<span class="lineNum">    2260 </span>                :            :             redisGitSHA1(),
<span class="lineNum">    2261 </span>                :<span class="lineCov">       9672 :             strtol(redisGitDirty(),NULL,10) &gt; 0,</span>
<span class="lineNum">    2262 </span>                :<span class="lineCov">       9672 :             (unsigned long long) redisBuildId(),</span>
<span class="lineNum">    2263 </span>                :            :             mode,
<span class="lineNum">    2264 </span>                :            :             name.sysname, name.release, name.machine,
<span class="lineNum">    2265 </span>                :            :             server.arch_bits,
<span class="lineNum">    2266 </span>                :            :             aeGetApiName(),
<span class="lineNum">    2267 </span>                :            : #ifdef __GNUC__
<span class="lineNum">    2268 </span>                :            :             __GNUC__,__GNUC_MINOR__,__GNUC_PATCHLEVEL__,
<span class="lineNum">    2269 </span>                :            : #else
<span class="lineNum">    2270 </span>                :            :             0,0,0,
<span class="lineNum">    2271 </span>                :            : #endif
<span class="lineNum">    2272 </span>                :<span class="lineCov">       9672 :             (long) getpid(),</span>
<span class="lineNum">    2273 </span>                :            :             server.runid,
<span class="lineNum">    2274 </span>                :            :             server.port,
<span class="lineNum">    2275 </span>                :            :             (intmax_t)uptime,
<span class="lineNum">    2276 </span>                :            :             (intmax_t)(uptime/(3600*24)),
<span class="lineNum">    2277 </span>                :            :             server.hz,
<span class="lineNum">    2278 </span>                :<span class="lineCov">       9672 :             (unsigned long) server.lruclock,</span>
<span class="lineNum">    2279 </span>                :<span class="lineCov">       9672 :             server.configfile ? server.configfile : &quot;&quot;);</span>
<span class="lineNum">    2280 </span>                :            :     }
<span class="lineNum">    2281 </span>                :            : 
<span class="lineNum">    2282 </span>                :            :     /* Clients */
<span class="lineNum">    2283 </span>[<span class="branchCov" title="Branch 0 was taken 26 times"> + </span><span class="branchCov" title="Branch 1 was taken 9672 times"> + </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 26 times"> + </span>]:<span class="lineCov">       9698 :     if (allsections || defsections || !strcasecmp(section,&quot;clients&quot;)) {</span>
<span class="lineNum">    2284 </span>        [<span class="branchCov" title="Branch 0 was taken 9672 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       9672 :         if (sections++) info = sdscat(info,&quot;\r\n&quot;);</span>
<span class="lineNum">    2285 </span>                :<span class="lineCov">       9672 :         info = sdscatprintf(info,</span>
<span class="lineNum">    2286 </span>                :            :             &quot;# Clients\r\n&quot;
<span class="lineNum">    2287 </span>                :            :             &quot;connected_clients:%lu\r\n&quot;
<span class="lineNum">    2288 </span>                :            :             &quot;client_longest_output_list:%lu\r\n&quot;
<span class="lineNum">    2289 </span>                :            :             &quot;client_biggest_input_buf:%lu\r\n&quot;
<span class="lineNum">    2290 </span>                :            :             &quot;blocked_clients:%d\r\n&quot;,
<span class="lineNum">    2291 </span>                :<span class="lineCov">       9672 :             listLength(server.clients)-listLength(server.slaves),</span>
<span class="lineNum">    2292 </span>                :            :             lol, bib,
<span class="lineNum">    2293 </span>                :            :             server.bpop_blocked_clients);
<span class="lineNum">    2294 </span>                :            :     }
<span class="lineNum">    2295 </span>                :            : 
<span class="lineNum">    2296 </span>                :            :     /* Memory */
<span class="lineNum">    2297 </span>[<span class="branchCov" title="Branch 0 was taken 26 times"> + </span><span class="branchCov" title="Branch 1 was taken 9672 times"> + </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 26 times"> + </span>]:<span class="lineCov">       9698 :     if (allsections || defsections || !strcasecmp(section,&quot;memory&quot;)) {</span>
<span class="lineNum">    2298 </span>                :            :         char hmem[64];
<span class="lineNum">    2299 </span>                :            :         char peak_hmem[64];
<span class="lineNum">    2300 </span>                :            : 
<span class="lineNum">    2301 </span>                :<span class="lineCov">       9672 :         bytesToHuman(hmem,zmalloc_used_memory());</span>
<span class="lineNum">    2302 </span>                :<span class="lineCov">       9672 :         bytesToHuman(peak_hmem,server.stat_peak_memory);</span>
<span class="lineNum">    2303 </span>        [<span class="branchCov" title="Branch 0 was taken 9672 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       9672 :         if (sections++) info = sdscat(info,&quot;\r\n&quot;);</span>
<span class="lineNum">    2304 </span>                :<span class="lineCov">       9672 :         info = sdscatprintf(info,</span>
<span class="lineNum">    2305 </span>                :            :             &quot;# Memory\r\n&quot;
<span class="lineNum">    2306 </span>                :            :             &quot;used_memory:%zu\r\n&quot;
<span class="lineNum">    2307 </span>                :            :             &quot;used_memory_human:%s\r\n&quot;
<span class="lineNum">    2308 </span>                :            :             &quot;used_memory_rss:%zu\r\n&quot;
<span class="lineNum">    2309 </span>                :            :             &quot;used_memory_peak:%zu\r\n&quot;
<span class="lineNum">    2310 </span>                :            :             &quot;used_memory_peak_human:%s\r\n&quot;
<span class="lineNum">    2311 </span>                :            :             &quot;used_memory_lua:%lld\r\n&quot;
<span class="lineNum">    2312 </span>                :            :             &quot;mem_fragmentation_ratio:%.2f\r\n&quot;
<span class="lineNum">    2313 </span>                :            :             &quot;mem_allocator:%s\r\n&quot;,
<span class="lineNum">    2314 </span>                :            :             zmalloc_used_memory(),
<span class="lineNum">    2315 </span>                :            :             hmem,
<span class="lineNum">    2316 </span>                :            :             zmalloc_get_rss(),
<span class="lineNum">    2317 </span>                :            :             server.stat_peak_memory,
<span class="lineNum">    2318 </span>                :            :             peak_hmem,
<span class="lineNum">    2319 </span>                :<span class="lineCov">       9672 :             ((long long)lua_gc(server.lua,LUA_GCCOUNT,0))*1024LL,</span>
<span class="lineNum">    2320 </span>                :<span class="lineCov">       9672 :             zmalloc_get_fragmentation_ratio(),</span>
<span class="lineNum">    2321 </span>                :            :             ZMALLOC_LIB
<span class="lineNum">    2322 </span>                :            :             );
<span class="lineNum">    2323 </span>                :            :     }
<span class="lineNum">    2324 </span>                :            : 
<span class="lineNum">    2325 </span>                :            :     /* Persistence */
<span class="lineNum">    2326 </span>[<span class="branchCov" title="Branch 0 was taken 26 times"> + </span><span class="branchCov" title="Branch 1 was taken 9672 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 8 times"> + </span><span class="branchCov" title="Branch 4 was taken 18 times"> + </span>]:<span class="lineCov">       9698 :     if (allsections || defsections || !strcasecmp(section,&quot;persistence&quot;)) {</span>
<span class="lineNum">    2327 </span>        [<span class="branchCov" title="Branch 0 was taken 9672 times"> + </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>]:<span class="lineCov">       9680 :         if (sections++) info = sdscat(info,&quot;\r\n&quot;);</span>
<span class="lineNum">    2328 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 9680 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 193 times"> + </span><span class="branchCov" title="Branch 3 was taken 9487 times"> + </span>]:<span class="lineCov">       9886 :         info = sdscatprintf(info,</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 13 times"> + </span><span class="branchCov" title="Branch 5 was taken 9667 times"> + </span>][<span class="branchNoCov" title="Branch 6 was not taken"> - </span><span class="branchCov" title="Branch 7 was taken 9680 times"> + </span>]
<span class="lineNum">    2329 </span>                :            :             &quot;# Persistence\r\n&quot;
<span class="lineNum">    2330 </span>                :            :             &quot;loading:%d\r\n&quot;
<span class="lineNum">    2331 </span>                :            :             &quot;rdb_changes_since_last_save:%lld\r\n&quot;
<span class="lineNum">    2332 </span>                :            :             &quot;rdb_bgsave_in_progress:%d\r\n&quot;
<span class="lineNum">    2333 </span>                :            :             &quot;rdb_last_save_time:%jd\r\n&quot;
<span class="lineNum">    2334 </span>                :            :             &quot;rdb_last_bgsave_status:%s\r\n&quot;
<span class="lineNum">    2335 </span>                :            :             &quot;rdb_last_bgsave_time_sec:%jd\r\n&quot;
<span class="lineNum">    2336 </span>                :            :             &quot;rdb_current_bgsave_time_sec:%jd\r\n&quot;
<span class="lineNum">    2337 </span>                :            :             &quot;aof_enabled:%d\r\n&quot;
<span class="lineNum">    2338 </span>                :            :             &quot;aof_rewrite_in_progress:%d\r\n&quot;
<span class="lineNum">    2339 </span>                :            :             &quot;aof_rewrite_scheduled:%d\r\n&quot;
<span class="lineNum">    2340 </span>                :            :             &quot;aof_last_rewrite_time_sec:%jd\r\n&quot;
<span class="lineNum">    2341 </span>                :            :             &quot;aof_current_rewrite_time_sec:%jd\r\n&quot;
<span class="lineNum">    2342 </span>                :            :             &quot;aof_last_bgrewrite_status:%s\r\n&quot;,
<span class="lineNum">    2343 </span>                :            :             server.loading,
<span class="lineNum">    2344 </span>                :            :             server.dirty,
<span class="lineNum">    2345 </span>                :<span class="lineCov">       9680 :             server.rdb_child_pid != -1,</span>
<span class="lineNum">    2346 </span>                :            :             (intmax_t)server.lastsave,
<span class="lineNum">    2347 </span>                :<span class="lineCov">       9680 :             (server.lastbgsave_status == REDIS_OK) ? &quot;ok&quot; : &quot;err&quot;,</span>
<span class="lineNum">    2348 </span>                :            :             (intmax_t)server.rdb_save_time_last,
<span class="lineNum">    2349 </span>                :<span class="lineCov">       9680 :             (intmax_t)((server.rdb_child_pid == -1) ?</span>
<span class="lineNum">    2350 </span>                :<span class="lineCov">         13 :                 -1 : time(NULL)-server.rdb_save_time_start),</span>
<span class="lineNum">    2351 </span>                :<span class="lineCov">       9680 :             server.aof_state != REDIS_AOF_OFF,</span>
<span class="lineNum">    2352 </span>                :<span class="lineCov">       9680 :             server.aof_child_pid != -1,</span>
<span class="lineNum">    2353 </span>                :            :             server.aof_rewrite_scheduled,
<span class="lineNum">    2354 </span>                :            :             (intmax_t)server.aof_rewrite_time_last,
<span class="lineNum">    2355 </span>                :<span class="lineCov">       9680 :             (intmax_t)((server.aof_child_pid == -1) ?</span>
<span class="lineNum">    2356 </span>                :<span class="lineCov">        193 :                 -1 : time(NULL)-server.aof_rewrite_time_start),</span>
<span class="lineNum">    2357 </span>                :<span class="lineCov">       9680 :             (server.aof_lastbgrewrite_status == REDIS_OK) ? &quot;ok&quot; : &quot;err&quot;);</span>
<span class="lineNum">    2358 </span>                :            : 
<span class="lineNum">    2359 </span>        [<span class="branchCov" title="Branch 0 was taken 42 times"> + </span><span class="branchCov" title="Branch 1 was taken 9638 times"> + </span>]:<span class="lineCov">       9680 :         if (server.aof_state != REDIS_AOF_OFF) {</span>
<span class="lineNum">    2360 </span>                :<span class="lineCov">         42 :             info = sdscatprintf(info,</span>
<span class="lineNum">    2361 </span>                :            :                 &quot;aof_current_size:%lld\r\n&quot;
<span class="lineNum">    2362 </span>                :            :                 &quot;aof_base_size:%lld\r\n&quot;
<span class="lineNum">    2363 </span>                :            :                 &quot;aof_pending_rewrite:%d\r\n&quot;
<span class="lineNum">    2364 </span>                :            :                 &quot;aof_buffer_length:%zu\r\n&quot;
<span class="lineNum">    2365 </span>                :            :                 &quot;aof_rewrite_buffer_length:%lu\r\n&quot;
<span class="lineNum">    2366 </span>                :            :                 &quot;aof_pending_bio_fsync:%llu\r\n&quot;
<span class="lineNum">    2367 </span>                :            :                 &quot;aof_delayed_fsync:%lu\r\n&quot;,
<span class="lineNum">    2368 </span>                :<span class="lineCov">         42 :                 (long long) server.aof_current_size,</span>
<span class="lineNum">    2369 </span>                :<span class="lineCov">         42 :                 (long long) server.aof_rewrite_base_size,</span>
<span class="lineNum">    2370 </span>                :            :                 server.aof_rewrite_scheduled,
<span class="lineNum">    2371 </span>                :            :                 sdslen(server.aof_buf),
<span class="lineNum">    2372 </span>                :            :                 aofRewriteBufferSize(),
<span class="lineNum">    2373 </span>                :            :                 bioPendingJobsOfType(REDIS_BIO_AOF_FSYNC),
<span class="lineNum">    2374 </span>                :            :                 server.aof_delayed_fsync);
<span class="lineNum">    2375 </span>                :            :         }
<span class="lineNum">    2376 </span>                :            : 
<span class="lineNum">    2377 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 9678 times"> + </span>]:<span class="lineCov">       9680 :         if (server.loading) {</span>
<span class="lineNum">    2378 </span>                :            :             double perc;
<span class="lineNum">    2379 </span>                :            :             time_t eta, elapsed;
<span class="lineNum">    2380 </span>                :<span class="lineCov">          4 :             off_t remaining_bytes = server.loading_total_bytes-</span>
<span class="lineNum">    2381 </span>                :<span class="lineCov">          2 :                                     server.loading_loaded_bytes;</span>
<span class="lineNum">    2382 </span>                :            : 
<span class="lineNum">    2383 </span>                :<span class="lineCov">          4 :             perc = ((double)server.loading_loaded_bytes /</span>
<span class="lineNum">    2384 </span>                :<span class="lineCov">          2 :                    server.loading_total_bytes) * 100;</span>
<span class="lineNum">    2385 </span>                :            : 
<span class="lineNum">    2386 </span>                :<span class="lineCov">          2 :             elapsed = server.unixtime-server.loading_start_time;</span>
<span class="lineNum">    2387 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          2 :             if (elapsed == 0) {</span>
<span class="lineNum">    2388 </span>                :            :                 eta = 1; /* A fake 1 second figure if we don't have
<span class="lineNum">    2389 </span>                :            :                             enough info */
<span class="lineNum">    2390 </span>                :            :             } else {
<span class="lineNum">    2391 </span>                :<span class="lineNoCov">          0 :                 eta = (elapsed*remaining_bytes)/server.loading_loaded_bytes;</span>
<span class="lineNum">    2392 </span>                :            :             }
<span class="lineNum">    2393 </span>                :            : 
<span class="lineNum">    2394 </span>                :<span class="lineCov">          2 :             info = sdscatprintf(info,</span>
<span class="lineNum">    2395 </span>                :            :                 &quot;loading_start_time:%jd\r\n&quot;
<span class="lineNum">    2396 </span>                :            :                 &quot;loading_total_bytes:%llu\r\n&quot;
<span class="lineNum">    2397 </span>                :            :                 &quot;loading_loaded_bytes:%llu\r\n&quot;
<span class="lineNum">    2398 </span>                :            :                 &quot;loading_loaded_perc:%.2f\r\n&quot;
<span class="lineNum">    2399 </span>                :            :                 &quot;loading_eta_seconds:%jd\r\n&quot;,
<span class="lineNum">    2400 </span>                :            :                 (intmax_t) server.loading_start_time,
<span class="lineNum">    2401 </span>                :<span class="lineCov">          2 :                 (unsigned long long) server.loading_total_bytes,</span>
<span class="lineNum">    2402 </span>                :<span class="lineCov">          2 :                 (unsigned long long) server.loading_loaded_bytes,</span>
<span class="lineNum">    2403 </span>                :            :                 perc,
<span class="lineNum">    2404 </span>                :            :                 (intmax_t)eta
<span class="lineNum">    2405 </span>                :            :             );
<span class="lineNum">    2406 </span>                :            :         }
<span class="lineNum">    2407 </span>                :            :     }
<span class="lineNum">    2408 </span>                :            : 
<span class="lineNum">    2409 </span>                :            :     /* Stats */
<span class="lineNum">    2410 </span>[<span class="branchCov" title="Branch 0 was taken 26 times"> + </span><span class="branchCov" title="Branch 1 was taken 9672 times"> + </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 26 times"> + </span>]:<span class="lineCov">       9698 :     if (allsections || defsections || !strcasecmp(section,&quot;stats&quot;)) {</span>
<span class="lineNum">    2411 </span>        [<span class="branchCov" title="Branch 0 was taken 9672 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       9672 :         if (sections++) info = sdscat(info,&quot;\r\n&quot;);</span>
<span class="lineNum">    2412 </span>                :<span class="lineCov">       9672 :         info = sdscatprintf(info,</span>
<span class="lineNum">    2413 </span>                :            :             &quot;# Stats\r\n&quot;
<span class="lineNum">    2414 </span>                :            :             &quot;total_connections_received:%lld\r\n&quot;
<span class="lineNum">    2415 </span>                :            :             &quot;total_commands_processed:%lld\r\n&quot;
<span class="lineNum">    2416 </span>                :            :             &quot;instantaneous_ops_per_sec:%lld\r\n&quot;
<span class="lineNum">    2417 </span>                :            :             &quot;rejected_connections:%lld\r\n&quot;
<span class="lineNum">    2418 </span>                :            :             &quot;sync_full:%lld\r\n&quot;
<span class="lineNum">    2419 </span>                :            :             &quot;sync_partial_ok:%lld\r\n&quot;
<span class="lineNum">    2420 </span>                :            :             &quot;sync_partial_err:%lld\r\n&quot;
<span class="lineNum">    2421 </span>                :            :             &quot;expired_keys:%lld\r\n&quot;
<span class="lineNum">    2422 </span>                :            :             &quot;evicted_keys:%lld\r\n&quot;
<span class="lineNum">    2423 </span>                :            :             &quot;keyspace_hits:%lld\r\n&quot;
<span class="lineNum">    2424 </span>                :            :             &quot;keyspace_misses:%lld\r\n&quot;
<span class="lineNum">    2425 </span>                :            :             &quot;pubsub_channels:%ld\r\n&quot;
<span class="lineNum">    2426 </span>                :            :             &quot;pubsub_patterns:%lu\r\n&quot;
<span class="lineNum">    2427 </span>                :            :             &quot;latest_fork_usec:%lld\r\n&quot;
<span class="lineNum">    2428 </span>                :            :             &quot;migrate_cached_sockets:%ld\r\n&quot;,
<span class="lineNum">    2429 </span>                :            :             server.stat_numconnections,
<span class="lineNum">    2430 </span>                :            :             server.stat_numcommands,
<span class="lineNum">    2431 </span>                :            :             getOperationsPerSecond(),
<span class="lineNum">    2432 </span>                :            :             server.stat_rejected_conn,
<span class="lineNum">    2433 </span>                :            :             server.stat_sync_full,
<span class="lineNum">    2434 </span>                :            :             server.stat_sync_partial_ok,
<span class="lineNum">    2435 </span>                :            :             server.stat_sync_partial_err,
<span class="lineNum">    2436 </span>                :            :             server.stat_expiredkeys,
<span class="lineNum">    2437 </span>                :            :             server.stat_evictedkeys,
<span class="lineNum">    2438 </span>                :            :             server.stat_keyspace_hits,
<span class="lineNum">    2439 </span>                :            :             server.stat_keyspace_misses,
<span class="lineNum">    2440 </span>                :<span class="lineCov">       9672 :             dictSize(server.pubsub_channels),</span>
<span class="lineNum">    2441 </span>                :<span class="lineCov">       9672 :             listLength(server.pubsub_patterns),</span>
<span class="lineNum">    2442 </span>                :            :             server.stat_fork_time,
<span class="lineNum">    2443 </span>                :<span class="lineCov">       9672 :             dictSize(server.migrate_cached_sockets));</span>
<span class="lineNum">    2444 </span>                :            :     }
<span class="lineNum">    2445 </span>                :            : 
<span class="lineNum">    2446 </span>                :            :     /* Replication */
<span class="lineNum">    2447 </span>[<span class="branchCov" title="Branch 0 was taken 26 times"> + </span><span class="branchCov" title="Branch 1 was taken 9672 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 18 times"> + </span><span class="branchCov" title="Branch 4 was taken 8 times"> + </span>]:<span class="lineCov">       9698 :     if (allsections || defsections || !strcasecmp(section,&quot;replication&quot;)) {</span>
<span class="lineNum">    2448 </span>        [<span class="branchCov" title="Branch 0 was taken 9672 times"> + </span><span class="branchCov" title="Branch 1 was taken 18 times"> + </span>]:<span class="lineCov">       9690 :         if (sections++) info = sdscat(info,&quot;\r\n&quot;);</span>
<span class="lineNum">    2449 </span>        [<span class="branchCov" title="Branch 0 was taken 169 times"> + </span><span class="branchCov" title="Branch 1 was taken 9521 times"> + </span>]:<span class="lineCov">       9690 :         info = sdscatprintf(info,</span>
<span class="lineNum">    2450 </span>                :            :             &quot;# Replication\r\n&quot;
<span class="lineNum">    2451 </span>                :            :             &quot;role:%s\r\n&quot;,
<span class="lineNum">    2452 </span>                :<span class="lineCov">       9690 :             server.masterhost == NULL ? &quot;master&quot; : &quot;slave&quot;);</span>
<span class="lineNum">    2453 </span>        [<span class="branchCov" title="Branch 0 was taken 169 times"> + </span><span class="branchCov" title="Branch 1 was taken 9521 times"> + </span>]:<span class="lineCov">       9690 :         if (server.masterhost) {</span>
<span class="lineNum">    2454 </span>[<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchCov" title="Branch 1 was taken 151 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 18 times"> + </span><span class="branchCov" title="Branch 3 was taken 151 times"> + </span>]:<span class="lineCov">        169 :             info = sdscatprintf(info,</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 151 times"> + </span><span class="branchCov" title="Branch 5 was taken 18 times"> + </span>]
<span class="lineNum">    2455 </span>                :            :                 &quot;master_host:%s\r\n&quot;
<span class="lineNum">    2456 </span>                :            :                 &quot;master_port:%d\r\n&quot;
<span class="lineNum">    2457 </span>                :            :                 &quot;master_link_status:%s\r\n&quot;
<span class="lineNum">    2458 </span>                :            :                 &quot;master_last_io_seconds_ago:%d\r\n&quot;
<span class="lineNum">    2459 </span>                :            :                 &quot;master_sync_in_progress:%d\r\n&quot;
<span class="lineNum">    2460 </span>                :            :                 &quot;slave_repl_offset:%lld\r\n&quot;
<span class="lineNum">    2461 </span>                :            :                 ,server.masterhost,
<span class="lineNum">    2462 </span>                :            :                 server.masterport,
<span class="lineNum">    2463 </span>                :<span class="lineCov">        169 :                 (server.repl_state == REDIS_REPL_CONNECTED) ?</span>
<span class="lineNum">    2464 </span>                :            :                     &quot;up&quot; : &quot;down&quot;,
<span class="lineNum">    2465 </span>                :<span class="lineCov">        169 :                 server.master ?</span>
<span class="lineNum">    2466 </span>                :<span class="lineCov">         18 :                 ((int)(server.unixtime-server.master-&gt;lastinteraction)) : -1,</span>
<span class="lineNum">    2467 </span>                :<span class="lineCov">        169 :                 server.repl_state == REDIS_REPL_TRANSFER,</span>
<span class="lineNum">    2468 </span>                :<span class="lineCov">        187 :                 server.master ? server.master-&gt;reploff : -1</span>
<span class="lineNum">    2469 </span>                :            :             );
<span class="lineNum">    2470 </span>                :            : 
<span class="lineNum">    2471 </span>        [<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchCov" title="Branch 1 was taken 158 times"> + </span>]:<span class="lineCov">        169 :             if (server.repl_state == REDIS_REPL_TRANSFER) {</span>
<span class="lineNum">    2472 </span>                :<span class="lineCov">         11 :                 info = sdscatprintf(info,</span>
<span class="lineNum">    2473 </span>                :            :                     &quot;master_sync_left_bytes:%lld\r\n&quot;
<span class="lineNum">    2474 </span>                :            :                     &quot;master_sync_last_io_seconds_ago:%d\r\n&quot;
<span class="lineNum">    2475 </span>                :            :                     , (long long)
<span class="lineNum">    2476 </span>                :<span class="lineCov">         11 :                         (server.repl_transfer_size - server.repl_transfer_read),</span>
<span class="lineNum">    2477 </span>                :<span class="lineCov">         22 :                     (int)(server.unixtime-server.repl_transfer_lastio)</span>
<span class="lineNum">    2478 </span>                :            :                 );
<span class="lineNum">    2479 </span>                :            :             }
<span class="lineNum">    2480 </span>                :            : 
<span class="lineNum">    2481 </span>        [<span class="branchCov" title="Branch 0 was taken 151 times"> + </span><span class="branchCov" title="Branch 1 was taken 18 times"> + </span>]:<span class="lineCov">        169 :             if (server.repl_state != REDIS_REPL_CONNECTED) {</span>
<span class="lineNum">    2482 </span>                :<span class="lineCov">        151 :                 info = sdscatprintf(info,</span>
<span class="lineNum">    2483 </span>                :            :                     &quot;master_link_down_since_seconds:%jd\r\n&quot;,
<span class="lineNum">    2484 </span>                :<span class="lineCov">        151 :                     (intmax_t)server.unixtime-server.repl_down_since);</span>
<span class="lineNum">    2485 </span>                :            :             }
<span class="lineNum">    2486 </span>                :<span class="lineCov">        169 :             info = sdscatprintf(info,</span>
<span class="lineNum">    2487 </span>                :            :                 &quot;slave_priority:%d\r\n&quot;
<span class="lineNum">    2488 </span>                :            :                 &quot;slave_read_only:%d\r\n&quot;,
<span class="lineNum">    2489 </span>                :            :                 server.slave_priority,
<span class="lineNum">    2490 </span>                :            :                 server.repl_slave_ro);
<span class="lineNum">    2491 </span>                :            :         }
<span class="lineNum">    2492 </span>                :            : 
<span class="lineNum">    2493 </span>                :<span class="lineCov">       9690 :         info = sdscatprintf(info,</span>
<span class="lineNum">    2494 </span>                :            :             &quot;connected_slaves:%lu\r\n&quot;,
<span class="lineNum">    2495 </span>                :<span class="lineCov">       9690 :             listLength(server.slaves));</span>
<span class="lineNum">    2496 </span>                :            : 
<span class="lineNum">    2497 </span>                :            :         /* If min-slaves-to-write is active, write the number of slaves
<span class="lineNum">    2498 </span>                :            :          * currently considered 'good'. */
<span class="lineNum">    2499 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 9690 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">       9690 :         if (server.repl_min_slaves_to_write &amp;&amp;</span>
<span class="lineNum">    2500 </span>                :<span class="lineNoCov">          0 :             server.repl_min_slaves_max_lag) {</span>
<span class="lineNum">    2501 </span>                :<span class="lineNoCov">          0 :             info = sdscatprintf(info,</span>
<span class="lineNum">    2502 </span>                :            :                 &quot;min_slaves_good_slaves:%d\r\n&quot;,
<span class="lineNum">    2503 </span>                :            :                 server.repl_good_slaves_count);
<span class="lineNum">    2504 </span>                :            :         }
<span class="lineNum">    2505 </span>                :            : 
<span class="lineNum">    2506 </span>        [<span class="branchCov" title="Branch 0 was taken 52 times"> + </span><span class="branchCov" title="Branch 1 was taken 9638 times"> + </span>]:<span class="lineCov">       9690 :         if (listLength(server.slaves)) {</span>
<span class="lineNum">    2507 </span>                :<span class="lineCov">         52 :             int slaveid = 0;</span>
<span class="lineNum">    2508 </span>                :            :             listNode *ln;
<span class="lineNum">    2509 </span>                :            :             listIter li;
<span class="lineNum">    2510 </span>                :            : 
<span class="lineNum">    2511 </span>                :<span class="lineCov">         52 :             listRewind(server.slaves,&amp;li);</span>
<span class="lineNum">    2512 </span>        [<span class="branchCov" title="Branch 1 was taken 140 times"> + </span><span class="branchCov" title="Branch 2 was taken 52 times"> + </span>]:<span class="lineCov">        192 :             while((ln = listNext(&amp;li))) {</span>
<span class="lineNum">    2513 </span>                :<span class="lineCov">        140 :                 redisClient *slave = listNodeValue(ln);</span>
<span class="lineNum">    2514 </span>                :<span class="lineCov">        140 :                 char *state = NULL;</span>
<span class="lineNum">    2515 </span>                :            :                 char ip[REDIS_IP_STR_LEN];
<span class="lineNum">    2516 </span>                :            :                 int port;
<span class="lineNum">    2517 </span>                :<span class="lineCov">        140 :                 long lag = 0;</span>
<span class="lineNum">    2518 </span>                :            : 
<span class="lineNum">    2519 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 140 times"> + </span>]:<span class="lineCov">        140 :                 if (anetPeerToString(slave-&gt;fd,ip,sizeof(ip),&amp;port) == -1) continue;</span>
<span class="lineNum">    2520 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 140 times"> + </span>]:<span class="lineCov">        140 :                 switch(slave-&gt;replstate) {</span>
<span class="lineNum">    2521 </span>                :            :                 case REDIS_REPL_WAIT_BGSAVE_START:
<span class="lineNum">    2522 </span>                :            :                 case REDIS_REPL_WAIT_BGSAVE_END:
<span class="lineNum">    2523 </span>                :            :                     state = &quot;wait_bgsave&quot;;
<span class="lineNum">    2524 </span>                :            :                     break;
<span class="lineNum">    2525 </span>                :            :                 case REDIS_REPL_SEND_BULK:
<span class="lineNum">    2526 </span>                :            :                     state = &quot;send_bulk&quot;;
<span class="lineNum">    2527 </span>                :            :                     break;
<span class="lineNum">    2528 </span>                :            :                 case REDIS_REPL_ONLINE:
<span class="lineNum">    2529 </span>                :            :                     state = &quot;online&quot;;
<span class="lineNum">    2530 </span>                :            :                     break;
<span class="lineNum">    2531 </span>                :            :                 }
<span class="lineNum">    2532 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 140 times"> + </span>]:<span class="lineCov">        140 :                 if (state == NULL) continue;</span>
<span class="lineNum">    2533 </span>        [<span class="branchCov" title="Branch 0 was taken 21 times"> + </span><span class="branchCov" title="Branch 1 was taken 119 times"> + </span>]:<span class="lineCov">        140 :                 if (slave-&gt;replstate == REDIS_REPL_ONLINE)</span>
<span class="lineNum">    2534 </span>                :<span class="lineCov">         21 :                     lag = time(NULL) - slave-&gt;repl_ack_time;</span>
<span class="lineNum">    2535 </span>                :            : 
<span class="lineNum">    2536 </span>                :<span class="lineCov">        140 :                 info = sdscatprintf(info,</span>
<span class="lineNum">    2537 </span>                :            :                     &quot;slave%d:ip=%s,port=%d,state=%s,&quot;
<span class="lineNum">    2538 </span>                :            :                     &quot;offset=%lld,lag=%ld\r\n&quot;,
<span class="lineNum">    2539 </span>                :            :                     slaveid,ip,slave-&gt;slave_listening_port,state,
<span class="lineNum">    2540 </span>                :            :                     slave-&gt;repl_ack_off, lag);
<span class="lineNum">    2541 </span>                :<span class="lineCov">        140 :                 slaveid++;</span>
<span class="lineNum">    2542 </span>                :            :             }
<span class="lineNum">    2543 </span>                :            :         }
<span class="lineNum">    2544 </span>                :<span class="lineCov">       9690 :         info = sdscatprintf(info,</span>
<span class="lineNum">    2545 </span>                :            :             &quot;master_repl_offset:%lld\r\n&quot;
<span class="lineNum">    2546 </span>                :            :             &quot;repl_backlog_active:%d\r\n&quot;
<span class="lineNum">    2547 </span>                :            :             &quot;repl_backlog_size:%lld\r\n&quot;
<span class="lineNum">    2548 </span>                :            :             &quot;repl_backlog_first_byte_offset:%lld\r\n&quot;
<span class="lineNum">    2549 </span>                :            :             &quot;repl_backlog_histlen:%lld\r\n&quot;,
<span class="lineNum">    2550 </span>                :            :             server.master_repl_offset,
<span class="lineNum">    2551 </span>                :<span class="lineCov">       9690 :             server.repl_backlog != NULL,</span>
<span class="lineNum">    2552 </span>                :            :             server.repl_backlog_size,
<span class="lineNum">    2553 </span>                :            :             server.repl_backlog_off,
<span class="lineNum">    2554 </span>                :            :             server.repl_backlog_histlen);
<span class="lineNum">    2555 </span>                :            :     }
<span class="lineNum">    2556 </span>                :            : 
<span class="lineNum">    2557 </span>                :            :     /* CPU */
<span class="lineNum">    2558 </span>[<span class="branchCov" title="Branch 0 was taken 26 times"> + </span><span class="branchCov" title="Branch 1 was taken 9672 times"> + </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 26 times"> + </span>]:<span class="lineCov">       9698 :     if (allsections || defsections || !strcasecmp(section,&quot;cpu&quot;)) {</span>
<span class="lineNum">    2559 </span>        [<span class="branchCov" title="Branch 0 was taken 9672 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       9672 :         if (sections++) info = sdscat(info,&quot;\r\n&quot;);</span>
<span class="lineNum">    2560 </span>                :<span class="lineCov">       9672 :         info = sdscatprintf(info,</span>
<span class="lineNum">    2561 </span>                :            :         &quot;# CPU\r\n&quot;
<span class="lineNum">    2562 </span>                :            :         &quot;used_cpu_sys:%.2f\r\n&quot;
<span class="lineNum">    2563 </span>                :            :         &quot;used_cpu_user:%.2f\r\n&quot;
<span class="lineNum">    2564 </span>                :            :         &quot;used_cpu_sys_children:%.2f\r\n&quot;
<span class="lineNum">    2565 </span>                :            :         &quot;used_cpu_user_children:%.2f\r\n&quot;,
<span class="lineNum">    2566 </span>                :<span class="lineCov">       9672 :         (float)self_ru.ru_stime.tv_sec+(float)self_ru.ru_stime.tv_usec/1000000,</span>
<span class="lineNum">    2567 </span>                :<span class="lineCov">       9672 :         (float)self_ru.ru_utime.tv_sec+(float)self_ru.ru_utime.tv_usec/1000000,</span>
<span class="lineNum">    2568 </span>                :<span class="lineCov">       9672 :         (float)c_ru.ru_stime.tv_sec+(float)c_ru.ru_stime.tv_usec/1000000,</span>
<span class="lineNum">    2569 </span>                :<span class="lineCov">       9672 :         (float)c_ru.ru_utime.tv_sec+(float)c_ru.ru_utime.tv_usec/1000000);</span>
<span class="lineNum">    2570 </span>                :            :     }
<span class="lineNum">    2571 </span>                :            : 
<span class="lineNum">    2572 </span>                :            :     /* cmdtime */
<span class="lineNum">    2573 </span>[<span class="branchCov" title="Branch 0 was taken 9698 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 9698 times"> + </span>]:<span class="lineCov">       9698 :     if (allsections || !strcasecmp(section,&quot;commandstats&quot;)) {</span>
<span class="lineNum">    2574 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (sections++) info = sdscat(info,&quot;\r\n&quot;);</span>
<span class="lineNum">    2575 </span>                :<span class="lineNoCov">          0 :         info = sdscatprintf(info, &quot;# Commandstats\r\n&quot;);</span>
<span class="lineNum">    2576 </span>                :<span class="lineNoCov">          0 :         numcommands = sizeof(redisCommandTable)/sizeof(struct redisCommand);</span>
<span class="lineNum">    2577 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (j = 0; j &lt; numcommands; j++) {</span>
<span class="lineNum">    2578 </span>                :<span class="lineNoCov">          0 :             struct redisCommand *c = redisCommandTable+j;</span>
<span class="lineNum">    2579 </span>                :            : 
<span class="lineNum">    2580 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (!c-&gt;calls) continue;</span>
<span class="lineNum">    2581 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             info = sdscatprintf(info,</span>
<span class="lineNum">    2582 </span>                :            :                 &quot;cmdstat_%s:calls=%lld,usec=%lld,usec_per_call=%.2f\r\n&quot;,
<span class="lineNum">    2583 </span>                :            :                 c-&gt;name, c-&gt;calls, c-&gt;microseconds,
<span class="lineNum">    2584 </span>                :<span class="lineNoCov">          0 :                 (c-&gt;calls == 0) ? 0 : ((float)c-&gt;microseconds/c-&gt;calls));</span>
<span class="lineNum">    2585 </span>                :            :         }
<span class="lineNum">    2586 </span>                :            :     }
<span class="lineNum">    2587 </span>                :            : 
<span class="lineNum">    2588 </span>                :            :     /* Cluster */
<span class="lineNum">    2589 </span>[<span class="branchCov" title="Branch 0 was taken 26 times"> + </span><span class="branchCov" title="Branch 1 was taken 9672 times"> + </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 26 times"> + </span>]:<span class="lineCov">       9698 :     if (allsections || defsections || !strcasecmp(section,&quot;cluster&quot;)) {</span>
<span class="lineNum">    2590 </span>        [<span class="branchCov" title="Branch 0 was taken 9672 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       9672 :         if (sections++) info = sdscat(info,&quot;\r\n&quot;);</span>
<span class="lineNum">    2591 </span>                :<span class="lineCov">       9672 :         info = sdscatprintf(info,</span>
<span class="lineNum">    2592 </span>                :            :         &quot;# Cluster\r\n&quot;
<span class="lineNum">    2593 </span>                :            :         &quot;cluster_enabled:%d\r\n&quot;,
<span class="lineNum">    2594 </span>                :            :         server.cluster_enabled);
<span class="lineNum">    2595 </span>                :            :     }
<span class="lineNum">    2596 </span>                :            : 
<span class="lineNum">    2597 </span>                :            :     /* Key space */
<span class="lineNum">    2598 </span>[<span class="branchCov" title="Branch 0 was taken 26 times"> + </span><span class="branchCov" title="Branch 1 was taken 9672 times"> + </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 26 times"> + </span>]:<span class="lineCov">       9698 :     if (allsections || defsections || !strcasecmp(section,&quot;keyspace&quot;)) {</span>
<span class="lineNum">    2599 </span>        [<span class="branchCov" title="Branch 0 was taken 9672 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       9672 :         if (sections++) info = sdscat(info,&quot;\r\n&quot;);</span>
<span class="lineNum">    2600 </span>                :<span class="lineCov">       9672 :         info = sdscatprintf(info, &quot;# Keyspace\r\n&quot;);</span>
<span class="lineNum">    2601 </span>        [<span class="branchCov" title="Branch 1 was taken 154752 times"> + </span><span class="branchCov" title="Branch 2 was taken 9672 times"> + </span>]:<span class="lineCov">     164424 :         for (j = 0; j &lt; server.dbnum; j++) {</span>
<span class="lineNum">    2602 </span>                :            :             long long keys, vkeys;
<span class="lineNum">    2603 </span>                :            : 
<span class="lineNum">    2604 </span>                :<span class="lineCov">     154752 :             keys = dictSize(server.db[j].dict);</span>
<span class="lineNum">    2605 </span>                :<span class="lineCov">     154752 :             vkeys = dictSize(server.db[j].expires);</span>
<span class="lineNum">    2606 </span>        [<span class="branchCov" title="Branch 0 was taken 9486 times"> + </span><span class="branchCov" title="Branch 1 was taken 145266 times"> + </span>]:<span class="lineCov">     154752 :             if (keys || vkeys) {</span>
<span class="lineNum">    2607 </span>                :<span class="lineCov">       9486 :                 info = sdscatprintf(info,</span>
<span class="lineNum">    2608 </span>                :            :                     &quot;db%d:keys=%lld,expires=%lld,avg_ttl=%lld\r\n&quot;,
<span class="lineNum">    2609 </span>                :<span class="lineCov">       9486 :                     j, keys, vkeys, server.db[j].avg_ttl);</span>
<span class="lineNum">    2610 </span>                :            :             }
<span class="lineNum">    2611 </span>                :            :         }
<span class="lineNum">    2612 </span>                :            :     }
<span class="lineNum">    2613 </span>                :<span class="lineCov">       9698 :     return info;</span>
<a name="2614"><span class="lineNum">    2614 </span>                :            : }</a>
<span class="lineNum">    2615 </span>                :            : 
<span class="lineNum">    2616 </span>                :<span class="lineCov">       9698 : void infoCommand(redisClient *c) {</span>
<span class="lineNum">    2617 </span>        [<span class="branchCov" title="Branch 0 was taken 26 times"> + </span><span class="branchCov" title="Branch 1 was taken 9672 times"> + </span>]:<span class="lineCov">       9698 :     char *section = c-&gt;argc == 2 ? c-&gt;argv[1]-&gt;ptr : &quot;default&quot;;</span>
<span class="lineNum">    2618 </span>                :            : 
<span class="lineNum">    2619 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 9698 times"> + </span>]:<span class="lineCov">       9698 :     if (c-&gt;argc &gt; 2) {</span>
<span class="lineNum">    2620 </span>                :<span class="lineNoCov">          0 :         addReply(c,shared.syntaxerr);</span>
<span class="lineNum">    2621 </span>                :<span class="lineCov">       9698 :         return;</span>
<span class="lineNum">    2622 </span>                :            :     }
<span class="lineNum">    2623 </span>                :<span class="lineCov">       9698 :     sds info = genRedisInfoString(section);</span>
<span class="lineNum">    2624 </span>                :<span class="lineCov">       9698 :     addReplySds(c,sdscatprintf(sdsempty(),&quot;$%lu\r\n&quot;,</span>
<span class="lineNum">    2625 </span>                :            :         (unsigned long)sdslen(info)));
<span class="lineNum">    2626 </span>                :<span class="lineCov">       9698 :     addReplySds(c,info);</span>
<span class="lineNum">    2627 </span>                :<span class="lineCov">       9698 :     addReply(c,shared.crlf);</span>
<a name="2628"><span class="lineNum">    2628 </span>                :            : }</a>
<span class="lineNum">    2629 </span>                :            : 
<span class="lineNum">    2630 </span>                :<span class="lineCov">          2 : void monitorCommand(redisClient *c) {</span>
<span class="lineNum">    2631 </span>                :            :     /* ignore MONITOR if already slave or in monitor mode */
<span class="lineNum">    2632 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          4 :     if (c-&gt;flags &amp; REDIS_SLAVE) return;</span>
<span class="lineNum">    2633 </span>                :            : 
<span class="lineNum">    2634 </span>                :<span class="lineCov">          2 :     c-&gt;flags |= (REDIS_SLAVE|REDIS_MONITOR);</span>
<span class="lineNum">    2635 </span>                :<span class="lineCov">          2 :     listAddNodeTail(server.monitors,c);</span>
<span class="lineNum">    2636 </span>                :<span class="lineCov">          2 :     addReply(c,shared.ok);</span>
<span class="lineNum">    2637 </span>                :            : }
<span class="lineNum">    2638 </span>                :            : 
<span class="lineNum">    2639 </span>                :            : /* ============================ Maxmemory directive  ======================== */
<span class="lineNum">    2640 </span>                :            : 
<span class="lineNum">    2641 </span>                :            : /* This function gets called when 'maxmemory' is set on the config file to limit
<span class="lineNum">    2642 </span>                :            :  * the max memory used by the server, before processing a command.
<span class="lineNum">    2643 </span>                :            :  *
<span class="lineNum">    2644 </span>                :            :  * The goal of the function is to free enough memory to keep Redis under the
<span class="lineNum">    2645 </span>                :            :  * configured memory limit.
<span class="lineNum">    2646 </span>                :            :  *
<span class="lineNum">    2647 </span>                :            :  * The function starts calculating how many bytes should be freed to keep
<span class="lineNum">    2648 </span>                :            :  * Redis under the limit, and enters a loop selecting the best keys to
<span class="lineNum">    2649 </span>                :            :  * evict accordingly to the configured policy.
<span class="lineNum">    2650 </span>                :            :  *
<span class="lineNum">    2651 </span>                :            :  * If all the bytes needed to return back under the limit were freed the
<span class="lineNum">    2652 </span>                :            :  * function returns REDIS_OK, otherwise REDIS_ERR is returned, and the caller
<span class="lineNum">    2653 </span>                :            :  * should block the execution of commands that will result in more memory
<a name="2654"><span class="lineNum">    2654 </span>                :            :  * used by the server.</a>
<span class="lineNum">    2655 </span>                :            :  */
<span class="lineNum">    2656 </span>                :<span class="lineCov">      28517 : int freeMemoryIfNeeded(void) {</span>
<span class="lineNum">    2657 </span>                :            :     size_t mem_used, mem_tofree, mem_freed;
<span class="lineNum">    2658 </span>                :<span class="lineCov">      28517 :     int slaves = listLength(server.slaves);</span>
<span class="lineNum">    2659 </span>                :            : 
<span class="lineNum">    2660 </span>                :            :     /* Remove the size of slaves output buffers and AOF buffer from the
<span class="lineNum">    2661 </span>                :            :      * count of used memory. */
<span class="lineNum">    2662 </span>                :<span class="lineCov">      28517 :     mem_used = zmalloc_used_memory();</span>
<span class="lineNum">    2663 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 28517 times"> + </span>]:<span class="lineCov">      28517 :     if (slaves) {</span>
<span class="lineNum">    2664 </span>                :            :         listIter li;
<span class="lineNum">    2665 </span>                :            :         listNode *ln;
<span class="lineNum">    2666 </span>                :            : 
<span class="lineNum">    2667 </span>                :<span class="lineNoCov">          0 :         listRewind(server.slaves,&amp;li);</span>
<span class="lineNum">    2668 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         while((ln = listNext(&amp;li))) {</span>
<span class="lineNum">    2669 </span>                :<span class="lineNoCov">          0 :             redisClient *slave = listNodeValue(ln);</span>
<span class="lineNum">    2670 </span>                :<span class="lineNoCov">          0 :             unsigned long obuf_bytes = getClientOutputBufferMemoryUsage(slave);</span>
<span class="lineNum">    2671 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (obuf_bytes &gt; mem_used)</span>
<span class="lineNum">    2672 </span>                :            :                 mem_used = 0;
<span class="lineNum">    2673 </span>                :            :             else
<span class="lineNum">    2674 </span>                :<span class="lineNoCov">          0 :                 mem_used -= obuf_bytes;</span>
<span class="lineNum">    2675 </span>                :            :         }
<span class="lineNum">    2676 </span>                :            :     }
<span class="lineNum">    2677 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 28517 times"> + </span>]:<span class="lineCov">      28517 :     if (server.aof_state != REDIS_AOF_OFF) {</span>
<span class="lineNum">    2678 </span>                :<span class="lineNoCov">          0 :         mem_used -= sdslen(server.aof_buf);</span>
<span class="lineNum">    2679 </span>                :<span class="lineNoCov">          0 :         mem_used -= aofRewriteBufferSize();</span>
<span class="lineNum">    2680 </span>                :            :     }
<span class="lineNum">    2681 </span>                :            : 
<span class="lineNum">    2682 </span>                :            :     /* Check if we are over the memory limit. */
<span class="lineNum">    2683 </span>        [<span class="branchCov" title="Branch 0 was taken 7595 times"> + </span><span class="branchCov" title="Branch 1 was taken 20922 times"> + </span>]:<span class="lineCov">      28517 :     if (mem_used &lt;= server.maxmemory) return REDIS_OK;</span>
<span class="lineNum">    2684 </span>                :            : 
<span class="lineNum">    2685 </span>        [<span class="branchCov" title="Branch 0 was taken 7595 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       7595 :     if (server.maxmemory_policy == REDIS_MAXMEMORY_NO_EVICTION)</span>
<span class="lineNum">    2686 </span>                :            :         return REDIS_ERR; /* We need to free memory, but policy forbids. */
<span class="lineNum">    2687 </span>                :            : 
<span class="lineNum">    2688 </span>                :            :     /* Compute how much memory we need to free. */
<span class="lineNum">    2689 </span>                :<span class="lineCov">       7595 :     mem_tofree = mem_used - server.maxmemory;</span>
<span class="lineNum">    2690 </span>                :<span class="lineCov">       7595 :     mem_freed = 0;</span>
<span class="lineNum">    2691 </span>        [<span class="branchCov" title="Branch 0 was taken 8351 times"> + </span><span class="branchCov" title="Branch 1 was taken 5469 times"> + </span>]:<span class="lineCov">      36868 :     while (mem_freed &lt; mem_tofree) {</span>
<span class="lineNum">    2692 </span>                :            :         int j, k, keys_freed = 0;
<span class="lineNum">    2693 </span>                :            : 
<span class="lineNum">    2694 </span>        [<span class="branchCov" title="Branch 0 was taken 133616 times"> + </span><span class="branchCov" title="Branch 1 was taken 8351 times"> + </span>]:<span class="lineCov">     141967 :         for (j = 0; j &lt; server.dbnum; j++) {</span>
<span class="lineNum">    2695 </span>                :<span class="lineCov">     133616 :             long bestval = 0; /* just to prevent warning */</span>
<span class="lineNum">    2696 </span>                :<span class="lineCov">     133616 :             sds bestkey = NULL;</span>
<span class="lineNum">    2697 </span>                :            :             struct dictEntry *de;
<span class="lineNum">    2698 </span>                :<span class="lineCov">     133616 :             redisDb *db = server.db+j;</span>
<span class="lineNum">    2699 </span>                :            :             dict *dict;
<span class="lineNum">    2700 </span>                :            : 
<span class="lineNum">    2701 </span>        [<span class="branchCov" title="Branch 0 was taken 36416 times"> + </span><span class="branchCov" title="Branch 1 was taken 97200 times"> + </span>]:<span class="lineCov">     133616 :             if (server.maxmemory_policy == REDIS_MAXMEMORY_ALLKEYS_LRU ||</span>
<span class="lineNum">    2702 </span>                :            :                 server.maxmemory_policy == REDIS_MAXMEMORY_ALLKEYS_RANDOM)
<span class="lineNum">    2703 </span>                :            :             {
<span class="lineNum">    2704 </span>                :<span class="lineCov">      36416 :                 dict = server.db[j].dict;</span>
<span class="lineNum">    2705 </span>                :            :             } else {
<span class="lineNum">    2706 </span>                :<span class="lineCov">      97200 :                 dict = server.db[j].expires;</span>
<span class="lineNum">    2707 </span>                :            :             }
<span class="lineNum">    2708 </span>        [<span class="branchCov" title="Branch 0 was taken 127391 times"> + </span><span class="branchCov" title="Branch 1 was taken 6225 times"> + </span>]:<span class="lineCov">     133616 :             if (dictSize(dict) == 0) continue;</span>
<span class="lineNum">    2709 </span>                :            : 
<span class="lineNum">    2710 </span>                :            :             /* volatile-random and allkeys-random policy */
<span class="lineNum">    2711 </span>        [<span class="branchCov" title="Branch 0 was taken 2453 times"> + </span><span class="branchCov" title="Branch 1 was taken 3772 times"> + </span>]:<span class="lineCov">       6225 :             if (server.maxmemory_policy == REDIS_MAXMEMORY_ALLKEYS_RANDOM ||</span>
<span class="lineNum">    2712 </span>                :            :                 server.maxmemory_policy == REDIS_MAXMEMORY_VOLATILE_RANDOM)
<span class="lineNum">    2713 </span>                :            :             {
<span class="lineNum">    2714 </span>                :<span class="lineCov">       2453 :                 de = dictGetRandomKey(dict);</span>
<span class="lineNum">    2715 </span>                :<span class="lineCov">       2453 :                 bestkey = dictGetKey(de);</span>
<span class="lineNum">    2716 </span>                :            :             }
<span class="lineNum">    2717 </span>                :            : 
<span class="lineNum">    2718 </span>                :            :             /* volatile-lru and allkeys-lru policy */
<span class="lineNum">    2719 </span>        [<span class="branchCov" title="Branch 0 was taken 2444 times"> + </span><span class="branchCov" title="Branch 1 was taken 1328 times"> + </span>]:<span class="lineCov">       3772 :             else if (server.maxmemory_policy == REDIS_MAXMEMORY_ALLKEYS_LRU ||</span>
<span class="lineNum">    2720 </span>                :            :                 server.maxmemory_policy == REDIS_MAXMEMORY_VOLATILE_LRU)
<span class="lineNum">    2721 </span>                :            :             {
<span class="lineNum">    2722 </span>        [<span class="branchCov" title="Branch 0 was taken 7332 times"> + </span><span class="branchCov" title="Branch 1 was taken 2444 times"> + </span>]:<span class="lineCov">       9776 :                 for (k = 0; k &lt; server.maxmemory_samples; k++) {</span>
<span class="lineNum">    2723 </span>                :            :                     sds thiskey;
<span class="lineNum">    2724 </span>                :            :                     long thisval;
<span class="lineNum">    2725 </span>                :            :                     robj *o;
<span class="lineNum">    2726 </span>                :            : 
<span class="lineNum">    2727 </span>                :<span class="lineCov">       7332 :                     de = dictGetRandomKey(dict);</span>
<span class="lineNum">    2728 </span>                :<span class="lineCov">       7332 :                     thiskey = dictGetKey(de);</span>
<span class="lineNum">    2729 </span>                :            :                     /* When policy is volatile-lru we need an additional lookup
<span class="lineNum">    2730 </span>                :            :                      * to locate the real key, as dict is set to db-&gt;expires. */
<span class="lineNum">    2731 </span>        [<span class="branchCov" title="Branch 0 was taken 3933 times"> + </span><span class="branchCov" title="Branch 1 was taken 3399 times"> + </span>]:<span class="lineCov">       7332 :                     if (server.maxmemory_policy == REDIS_MAXMEMORY_VOLATILE_LRU)</span>
<span class="lineNum">    2732 </span>                :<span class="lineCov">       3933 :                         de = dictFind(db-&gt;dict, thiskey);</span>
<span class="lineNum">    2733 </span>                :<span class="lineCov">       7332 :                     o = dictGetVal(de);</span>
<span class="lineNum">    2734 </span>                :<span class="lineCov">       7332 :                     thisval = estimateObjectIdleTime(o);</span>
<span class="lineNum">    2735 </span>                :            : 
<span class="lineNum">    2736 </span>                :            :                     /* Higher idle time is better candidate for deletion */
<span class="lineNum">    2737 </span>        [<span class="branchCov" title="Branch 0 was taken 2646 times"> + </span><span class="branchCov" title="Branch 1 was taken 4686 times"> + </span>]:<span class="lineCov">       7332 :                     if (bestkey == NULL || thisval &gt; bestval) {</span>
<span class="lineNum">    2738 </span>                :<span class="lineCov">       2646 :                         bestkey = thiskey;</span>
<span class="lineNum">    2739 </span>                :<span class="lineCov">       2646 :                         bestval = thisval;</span>
<span class="lineNum">    2740 </span>                :            :                     }
<span class="lineNum">    2741 </span>                :            :                 }
<span class="lineNum">    2742 </span>                :            :             }
<span class="lineNum">    2743 </span>                :            : 
<span class="lineNum">    2744 </span>                :            :             /* volatile-ttl */
<span class="lineNum">    2745 </span>        [<span class="branchCov" title="Branch 0 was taken 1328 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1328 :             else if (server.maxmemory_policy == REDIS_MAXMEMORY_VOLATILE_TTL) {</span>
<span class="lineNum">    2746 </span>        [<span class="branchCov" title="Branch 0 was taken 3984 times"> + </span><span class="branchCov" title="Branch 1 was taken 1328 times"> + </span>]:<span class="lineCov">       5312 :                 for (k = 0; k &lt; server.maxmemory_samples; k++) {</span>
<span class="lineNum">    2747 </span>                :            :                     sds thiskey;
<span class="lineNum">    2748 </span>                :            :                     long thisval;
<span class="lineNum">    2749 </span>                :            : 
<span class="lineNum">    2750 </span>                :<span class="lineCov">       3984 :                     de = dictGetRandomKey(dict);</span>
<span class="lineNum">    2751 </span>                :<span class="lineCov">       3984 :                     thiskey = dictGetKey(de);</span>
<span class="lineNum">    2752 </span>                :<span class="lineCov">       3984 :                     thisval = (long) dictGetVal(de);</span>
<span class="lineNum">    2753 </span>                :            : 
<span class="lineNum">    2754 </span>                :            :                     /* Expire sooner (minor expire unix timestamp) is better
<span class="lineNum">    2755 </span>                :            :                      * candidate for deletion */
<span class="lineNum">    2756 </span>        [<span class="branchCov" title="Branch 0 was taken 2393 times"> + </span><span class="branchCov" title="Branch 1 was taken 1591 times"> + </span>]:<span class="lineCov">       3984 :                     if (bestkey == NULL || thisval &lt; bestval) {</span>
<span class="lineNum">    2757 </span>                :<span class="lineCov">       2393 :                         bestkey = thiskey;</span>
<span class="lineNum">    2758 </span>                :<span class="lineCov">       2393 :                         bestval = thisval;</span>
<span class="lineNum">    2759 </span>                :            :                     }
<span class="lineNum">    2760 </span>                :            :                 }
<span class="lineNum">    2761 </span>                :            :             }
<span class="lineNum">    2762 </span>                :            : 
<span class="lineNum">    2763 </span>                :            :             /* Finally remove the selected key. */
<span class="lineNum">    2764 </span>        [<span class="branchCov" title="Branch 0 was taken 6225 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       6225 :             if (bestkey) {</span>
<span class="lineNum">    2765 </span>                :            :                 long long delta;
<span class="lineNum">    2766 </span>                :            : 
<span class="lineNum">    2767 </span>                :<span class="lineCov">       6225 :                 robj *keyobj = createStringObject(bestkey,sdslen(bestkey));</span>
<span class="lineNum">    2768 </span>                :<span class="lineCov">       6225 :                 propagateExpire(db,keyobj);</span>
<span class="lineNum">    2769 </span>                :            :                 /* We compute the amount of memory freed by dbDelete() alone.
<span class="lineNum">    2770 </span>                :            :                  * It is possible that actually the memory needed to propagate
<span class="lineNum">    2771 </span>                :            :                  * the DEL in AOF and replication link is greater than the one
<span class="lineNum">    2772 </span>                :            :                  * we are freeing removing the key, but we can't account for
<span class="lineNum">    2773 </span>                :            :                  * that otherwise we would never exit the loop.
<span class="lineNum">    2774 </span>                :            :                  *
<span class="lineNum">    2775 </span>                :            :                  * AOF and Output buffer memory will be freed eventually so
<span class="lineNum">    2776 </span>                :            :                  * we only care about memory used by the key space. */
<span class="lineNum">    2777 </span>                :<span class="lineCov">       6225 :                 delta = (long long) zmalloc_used_memory();</span>
<span class="lineNum">    2778 </span>                :<span class="lineCov">       6225 :                 dbDelete(db,keyobj);</span>
<span class="lineNum">    2779 </span>                :<span class="lineCov">       6225 :                 delta -= (long long) zmalloc_used_memory();</span>
<span class="lineNum">    2780 </span>                :<span class="lineCov">       6225 :                 mem_freed += delta;</span>
<span class="lineNum">    2781 </span>                :<span class="lineCov">       6225 :                 server.stat_evictedkeys++;</span>
<span class="lineNum">    2782 </span>                :<span class="lineCov">       6225 :                 notifyKeyspaceEvent(REDIS_NOTIFY_EVICTED, &quot;evicted&quot;,</span>
<span class="lineNum">    2783 </span>                :            :                     keyobj, db-&gt;id);
<span class="lineNum">    2784 </span>                :<span class="lineCov">       6225 :                 decrRefCount(keyobj);</span>
<span class="lineNum">    2785 </span>                :<span class="lineCov">       6225 :                 keys_freed++;</span>
<span class="lineNum">    2786 </span>                :            : 
<span class="lineNum">    2787 </span>                :            :                 /* When the memory to free starts to be big enough, we may
<span class="lineNum">    2788 </span>                :            :                  * start spending so much time here that is impossible to
<span class="lineNum">    2789 </span>                :            :                  * deliver data to the slaves fast enough, so we force the
<span class="lineNum">    2790 </span>                :            :                  * transmission here inside the loop. */
<span class="lineNum">    2791 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 6225 times"> + </span>]:<span class="lineCov">       6225 :                 if (slaves) flushSlavesOutputBuffers();</span>
<span class="lineNum">    2792 </span>                :            :             }
<span class="lineNum">    2793 </span>                :            :         }
<span class="lineNum">    2794 </span>        [<span class="branchCov" title="Branch 0 was taken 6225 times"> + </span><span class="branchCov" title="Branch 1 was taken 2126 times"> + </span>]:<span class="lineCov">       8351 :         if (!keys_freed) return REDIS_ERR; /* nothing to free... */</span>
<span class="lineNum">    2795 </span>                :            :     }
<span class="lineNum">    2796 </span>                :            :     return REDIS_OK;
<span class="lineNum">    2797 </span>                :            : }
<span class="lineNum">    2798 </span>                :            : 
<span class="lineNum">    2799 </span>                :            : /* =================================== Main! ================================ */
<a name="2800"><span class="lineNum">    2800 </span>                :            : </a>
<span class="lineNum">    2801 </span>                :            : #ifdef __linux__
<span class="lineNum">    2802 </span>                :<span class="lineCov">        131 : int linuxOvercommitMemoryValue(void) {</span>
<span class="lineNum">    2803 </span>                :<span class="lineCov">        131 :     FILE *fp = fopen(&quot;/proc/sys/vm/overcommit_memory&quot;,&quot;r&quot;);</span>
<span class="lineNum">    2804 </span>                :            :     char buf[64];
<span class="lineNum">    2805 </span>                :            : 
<span class="lineNum">    2806 </span>        [<span class="branchCov" title="Branch 0 was taken 131 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        131 :     if (!fp) return -1;</span>
<span class="lineNum">    2807 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">        131 :     if (fgets(buf,64,fp) == NULL) {</span>
<span class="lineNum">    2808 </span>                :<span class="lineNoCov">          0 :         fclose(fp);</span>
<span class="lineNum">    2809 </span>                :<span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">    2810 </span>                :            :     }
<span class="lineNum">    2811 </span>                :<span class="lineCov">        131 :     fclose(fp);</span>
<span class="lineNum">    2812 </span>                :            : 
<span class="lineNum">    2813 </span>                :<span class="lineCov">        131 :     return atoi(buf);</span>
<a name="2814"><span class="lineNum">    2814 </span>                :            : }</a>
<span class="lineNum">    2815 </span>                :            : 
<span class="lineNum">    2816 </span>                :<span class="lineCov">        131 : void linuxOvercommitMemoryWarning(void) {</span>
<span class="lineNum">    2817 </span>        [<span class="branchCov" title="Branch 1 was taken 131 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        131 :     if (linuxOvercommitMemoryValue() == 0) {</span>
<span class="lineNum">    2818 </span>                :<span class="lineCov">        131 :         redisLog(REDIS_WARNING,&quot;WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.&quot;);</span>
<span class="lineNum">    2819 </span>                :            :     }
<span class="lineNum">    2820 </span>                :<span class="lineCov">        131 : }</span>
<a name="2821"><span class="lineNum">    2821 </span>                :            : #endif /* __linux__ */</a>
<span class="lineNum">    2822 </span>                :            : 
<span class="lineNum">    2823 </span>                :<span class="lineNoCov">          0 : void createPidFile(void) {</span>
<span class="lineNum">    2824 </span>                :            :     /* Try to write the pid file in a best-effort way. */
<span class="lineNum">    2825 </span>                :<span class="lineNoCov">          0 :     FILE *fp = fopen(server.pidfile,&quot;w&quot;);</span>
<span class="lineNum">    2826 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (fp) {</span>
<span class="lineNum">    2827 </span>                :<span class="lineNoCov">          0 :         fprintf(fp,&quot;%d\n&quot;,(int)getpid());</span>
<span class="lineNum">    2828 </span>                :<span class="lineNoCov">          0 :         fclose(fp);</span>
<span class="lineNum">    2829 </span>                :            :     }
<a name="2830"><span class="lineNum">    2830 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2831 </span>                :            : 
<span class="lineNum">    2832 </span>                :<span class="lineNoCov">          0 : void daemonize(void) {</span>
<span class="lineNum">    2833 </span>                :            :     int fd;
<span class="lineNum">    2834 </span>                :            : 
<span class="lineNum">    2835 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (fork() != 0) exit(0); /* parent exits */</span>
<span class="lineNum">    2836 </span>                :<span class="lineNoCov">          0 :     setsid(); /* create a new session */</span>
<span class="lineNum">    2837 </span>                :            : 
<span class="lineNum">    2838 </span>                :            :     /* Every output goes to /dev/null. If Redis is daemonized but
<span class="lineNum">    2839 </span>                :            :      * the 'logfile' is set to 'stdout' in the configuration file
<span class="lineNum">    2840 </span>                :            :      * it will not log at all. */
<span class="lineNum">    2841 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if ((fd = open(&quot;/dev/null&quot;, O_RDWR, 0)) != -1) {</span>
<span class="lineNum">    2842 </span>                :<span class="lineNoCov">          0 :         dup2(fd, STDIN_FILENO);</span>
<span class="lineNum">    2843 </span>                :<span class="lineNoCov">          0 :         dup2(fd, STDOUT_FILENO);</span>
<span class="lineNum">    2844 </span>                :<span class="lineNoCov">          0 :         dup2(fd, STDERR_FILENO);</span>
<span class="lineNum">    2845 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (fd &gt; STDERR_FILENO) close(fd);</span>
<span class="lineNum">    2846 </span>                :            :     }
<a name="2847"><span class="lineNum">    2847 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2848 </span>                :            : 
<span class="lineNum">    2849 </span>                :<span class="lineNoCov">          0 : void version() {</span>
<span class="lineNum">    2850 </span>                :<span class="lineNoCov">          0 :     printf(&quot;Redis server v=%s sha=%s:%d malloc=%s bits=%d build=%llx\n&quot;,</span>
<span class="lineNum">    2851 </span>                :            :         REDIS_VERSION,
<span class="lineNum">    2852 </span>                :            :         redisGitSHA1(),
<span class="lineNum">    2853 </span>                :<span class="lineNoCov">          0 :         atoi(redisGitDirty()) &gt; 0,</span>
<span class="lineNum">    2854 </span>                :            :         ZMALLOC_LIB,
<span class="lineNum">    2855 </span>                :            :         sizeof(long) == 4 ? 32 : 64,
<span class="lineNum">    2856 </span>                :<span class="lineNoCov">          0 :         (unsigned long long) redisBuildId());</span>
<span class="lineNum">    2857 </span>                :<span class="lineNoCov">          0 :     exit(0);</span>
<a name="2858"><span class="lineNum">    2858 </span>                :            : }</a>
<span class="lineNum">    2859 </span>                :            : 
<span class="lineNum">    2860 </span>                :<span class="lineNoCov">          0 : void usage() {</span>
<span class="lineNum">    2861 </span>                :<span class="lineNoCov">          0 :     fprintf(stderr,&quot;Usage: ./redis-server [/path/to/redis.conf] [options]\n&quot;);</span>
<span class="lineNum">    2862 </span>                :<span class="lineNoCov">          0 :     fprintf(stderr,&quot;       ./redis-server - (read config from stdin)\n&quot;);</span>
<span class="lineNum">    2863 </span>                :<span class="lineNoCov">          0 :     fprintf(stderr,&quot;       ./redis-server -v or --version\n&quot;);</span>
<span class="lineNum">    2864 </span>                :<span class="lineNoCov">          0 :     fprintf(stderr,&quot;       ./redis-server -h or --help\n&quot;);</span>
<span class="lineNum">    2865 </span>                :<span class="lineNoCov">          0 :     fprintf(stderr,&quot;       ./redis-server --test-memory &lt;megabytes&gt;\n\n&quot;);</span>
<span class="lineNum">    2866 </span>                :<span class="lineNoCov">          0 :     fprintf(stderr,&quot;Examples:\n&quot;);</span>
<span class="lineNum">    2867 </span>                :<span class="lineNoCov">          0 :     fprintf(stderr,&quot;       ./redis-server (run the server with default conf)\n&quot;);</span>
<span class="lineNum">    2868 </span>                :<span class="lineNoCov">          0 :     fprintf(stderr,&quot;       ./redis-server /etc/redis/6379.conf\n&quot;);</span>
<span class="lineNum">    2869 </span>                :<span class="lineNoCov">          0 :     fprintf(stderr,&quot;       ./redis-server --port 7777\n&quot;);</span>
<span class="lineNum">    2870 </span>                :<span class="lineNoCov">          0 :     fprintf(stderr,&quot;       ./redis-server --port 7777 --slaveof 127.0.0.1 8888\n&quot;);</span>
<span class="lineNum">    2871 </span>                :<span class="lineNoCov">          0 :     fprintf(stderr,&quot;       ./redis-server /etc/myredis.conf --loglevel verbose\n\n&quot;);</span>
<span class="lineNum">    2872 </span>                :<span class="lineNoCov">          0 :     fprintf(stderr,&quot;Sentinel mode:\n&quot;);</span>
<span class="lineNum">    2873 </span>                :<span class="lineNoCov">          0 :     fprintf(stderr,&quot;       ./redis-server /etc/sentinel.conf --sentinel\n&quot;);</span>
<span class="lineNum">    2874 </span>                :<span class="lineNoCov">          0 :     exit(1);</span>
<a name="2875"><span class="lineNum">    2875 </span>                :            : }</a>
<span class="lineNum">    2876 </span>                :            : 
<span class="lineNum">    2877 </span>                :<span class="lineCov">        131 : void redisAsciiArt(void) {</span>
<span class="lineNum">    2878 </span>                :            : #include &quot;asciilogo.h&quot;
<span class="lineNum">    2879 </span>                :<span class="lineCov">        131 :     char *buf = zmalloc(1024*16);</span>
<span class="lineNum">    2880 </span>                :<span class="lineCov">        131 :     char *mode = &quot;stand alone&quot;;</span>
<span class="lineNum">    2881 </span>                :            : 
<span class="lineNum">    2882 </span>        [<span class="branchCov" title="Branch 0 was taken 131 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        131 :     if (server.cluster_enabled) mode = &quot;cluster&quot;;</span>
<span class="lineNum">    2883 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">        131 :     else if (server.sentinel_mode) mode = &quot;sentinel&quot;;</span>
<span class="lineNum">    2884 </span>                :            : 
<span class="lineNum">    2885 </span>                :<span class="lineCov">        131 :     snprintf(buf,1024*16,ascii_logo,</span>
<span class="lineNum">    2886 </span>                :            :         REDIS_VERSION,
<span class="lineNum">    2887 </span>                :            :         redisGitSHA1(),
<span class="lineNum">    2888 </span>                :<span class="lineCov">        131 :         strtol(redisGitDirty(),NULL,10) &gt; 0,</span>
<span class="lineNum">    2889 </span>                :            :         (sizeof(long) == 8) ? &quot;64&quot; : &quot;32&quot;,
<span class="lineNum">    2890 </span>                :            :         mode, server.port,
<span class="lineNum">    2891 </span>                :<span class="lineCov">        131 :         (long) getpid()</span>
<span class="lineNum">    2892 </span>                :            :     );
<span class="lineNum">    2893 </span>                :<span class="lineCov">        131 :     redisLogRaw(REDIS_NOTICE|REDIS_LOG_RAW,buf);</span>
<span class="lineNum">    2894 </span>                :<span class="lineCov">        131 :     zfree(buf);</span>
<a name="2895"><span class="lineNum">    2895 </span>                :<span class="lineCov">        131 : }</span></a>
<span class="lineNum">    2896 </span>                :            : 
<span class="lineNum">    2897 </span>                :<span class="lineCov">         74 : static void sigtermHandler(int sig) {</span>
<span class="lineNum">    2898 </span>                :            :     REDIS_NOTUSED(sig);
<span class="lineNum">    2899 </span>                :            : 
<span class="lineNum">    2900 </span>                :<span class="lineCov">         74 :     redisLogFromHandler(REDIS_WARNING,&quot;Received SIGTERM, scheduling shutdown...&quot;);</span>
<span class="lineNum">    2901 </span>                :<span class="lineCov">         74 :     server.shutdown_asap = 1;</span>
<a name="2902"><span class="lineNum">    2902 </span>                :<span class="lineCov">         74 : }</span></a>
<span class="lineNum">    2903 </span>                :            : 
<span class="lineNum">    2904 </span>                :<span class="lineCov">        131 : void setupSignalHandlers(void) {</span>
<span class="lineNum">    2905 </span>                :            :     struct sigaction act;
<span class="lineNum">    2906 </span>                :            : 
<span class="lineNum">    2907 </span>                :            :     /* When the SA_SIGINFO flag is set in sa_flags then sa_sigaction is used.
<span class="lineNum">    2908 </span>                :            :      * Otherwise, sa_handler is used. */
<span class="lineNum">    2909 </span>                :<span class="lineCov">        131 :     sigemptyset(&amp;act.sa_mask);</span>
<span class="lineNum">    2910 </span>                :<span class="lineCov">        131 :     act.sa_flags = 0;</span>
<span class="lineNum">    2911 </span>                :<span class="lineCov">        131 :     act.sa_handler = sigtermHandler;</span>
<span class="lineNum">    2912 </span>                :<span class="lineCov">        131 :     sigaction(SIGTERM, &amp;act, NULL);</span>
<span class="lineNum">    2913 </span>                :            : 
<span class="lineNum">    2914 </span>                :            : #ifdef HAVE_BACKTRACE
<span class="lineNum">    2915 </span>                :<span class="lineCov">        131 :     sigemptyset(&amp;act.sa_mask);</span>
<span class="lineNum">    2916 </span>                :<span class="lineCov">        131 :     act.sa_flags = SA_NODEFER | SA_RESETHAND | SA_SIGINFO;</span>
<span class="lineNum">    2917 </span>                :<span class="lineCov">        131 :     act.sa_sigaction = sigsegvHandler;</span>
<span class="lineNum">    2918 </span>                :<span class="lineCov">        131 :     sigaction(SIGSEGV, &amp;act, NULL);</span>
<span class="lineNum">    2919 </span>                :<span class="lineCov">        131 :     sigaction(SIGBUS, &amp;act, NULL);</span>
<span class="lineNum">    2920 </span>                :<span class="lineCov">        131 :     sigaction(SIGFPE, &amp;act, NULL);</span>
<span class="lineNum">    2921 </span>                :<span class="lineCov">        131 :     sigaction(SIGILL, &amp;act, NULL);</span>
<span class="lineNum">    2922 </span>                :            : #endif
<span class="lineNum">    2923 </span>                :<span class="lineCov">        131 :     return;</span>
<span class="lineNum">    2924 </span>                :            : }
<span class="lineNum">    2925 </span>                :            : 
<span class="lineNum">    2926 </span>                :            : void memtest(size_t megabytes, int passes);
<span class="lineNum">    2927 </span>                :            : 
<a name="2928"><span class="lineNum">    2928 </span>                :            : /* Returns 1 if there is --sentinel among the arguments or if</a>
<span class="lineNum">    2929 </span>                :            :  * argv[0] is exactly &quot;redis-sentinel&quot;. */
<span class="lineNum">    2930 </span>                :<span class="lineCov">        131 : int checkForSentinelMode(int argc, char **argv) {</span>
<span class="lineNum">    2931 </span>                :            :     int j;
<span class="lineNum">    2932 </span>                :            : 
<span class="lineNum">    2933 </span>        [<span class="branchCov" title="Branch 0 was taken 131 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        131 :     if (strstr(argv[0],&quot;redis-sentinel&quot;) != NULL) return 1;</span>
<span class="lineNum">    2934 </span>        [<span class="branchCov" title="Branch 0 was taken 131 times"> + </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">        262 :     for (j = 1; j &lt; argc; j++)</span>
<span class="lineNum">    2935 </span>        [<span class="branchCov" title="Branch 0 was taken 131 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        131 :         if (!strcmp(argv[j],&quot;--sentinel&quot;)) return 1;</span>
<span class="lineNum">    2936 </span>                :            :     return 0;
<span class="lineNum">    2937 </span>                :            : }
<a name="2938"><span class="lineNum">    2938 </span>                :            : </a>
<span class="lineNum">    2939 </span>                :            : /* Function called at startup to load RDB or AOF file in memory. */
<span class="lineNum">    2940 </span>                :<span class="lineCov">        131 : void loadDataFromDisk(void) {</span>
<span class="lineNum">    2941 </span>                :<span class="lineCov">        131 :     long long start = ustime();</span>
<span class="lineNum">    2942 </span>        [<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchCov" title="Branch 1 was taken 125 times"> + </span>]:<span class="lineCov">        131 :     if (server.aof_state == REDIS_AOF_ON) {</span>
<span class="lineNum">    2943 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">          6 :         if (loadAppendOnlyFile(server.aof_filename) == REDIS_OK)</span>
<span class="lineNum">    2944 </span>                :<span class="lineCov">          3 :             redisLog(REDIS_NOTICE,&quot;DB loaded from append only file: %.3f seconds&quot;,(float)(ustime()-start)/1000000);</span>
<span class="lineNum">    2945 </span>                :            :     } else {
<span class="lineNum">    2946 </span>        [<span class="branchCov" title="Branch 1 was taken 5 times"> + </span><span class="branchCov" title="Branch 2 was taken 119 times"> + </span>]:<span class="lineCov">        125 :         if (rdbLoad(server.rdb_filename) == REDIS_OK) {</span>
<span class="lineNum">    2947 </span>                :<span class="lineCov">          5 :             redisLog(REDIS_NOTICE,&quot;DB loaded from disk: %.3f seconds&quot;,</span>
<span class="lineNum">    2948 </span>                :<span class="lineCov">          5 :                 (float)(ustime()-start)/1000000);</span>
<span class="lineNum">    2949 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 118 times"> + </span>]:<span class="lineCov">        119 :         } else if (errno != ENOENT) {</span>
<span class="lineNum">    2950 </span>                :<span class="lineCov">          1 :             redisLog(REDIS_WARNING,&quot;Fatal error loading the DB: %s. Exiting.&quot;,strerror(errno));</span>
<span class="lineNum">    2951 </span>                :<span class="lineCov">          1 :             exit(1);</span>
<span class="lineNum">    2952 </span>                :            :         }
<span class="lineNum">    2953 </span>                :            :     }
<a name="2954"><span class="lineNum">    2954 </span>                :<span class="lineCov">        127 : }</span></a>
<span class="lineNum">    2955 </span>                :            : 
<span class="lineNum">    2956 </span>                :<span class="lineNoCov">          0 : void redisOutOfMemoryHandler(size_t allocation_size) {</span>
<span class="lineNum">    2957 </span>                :<span class="lineNoCov">          0 :     redisLog(REDIS_WARNING,&quot;Out Of Memory allocating %zu bytes!&quot;,</span>
<span class="lineNum">    2958 </span>                :            :         allocation_size);
<span class="lineNum">    2959 </span>                :<span class="lineNoCov">          0 :     redisPanic(&quot;Redis aborting for OUT OF MEMORY&quot;);</span>
<a name="2960"><span class="lineNum">    2960 </span>                :            : }</a>
<span class="lineNum">    2961 </span>                :            : 
<span class="lineNum">    2962 </span>                :<span class="lineCov">        182 : void redisSetProcTitle(char *title) {</span>
<span class="lineNum">    2963 </span>                :            : #ifdef USE_SETPROCTITLE
<span class="lineNum">    2964 </span>        [<span class="branchCov" title="Branch 0 was taken 182 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        182 :     setproctitle(&quot;%s %s:%d&quot;,</span>
<span class="lineNum">    2965 </span>                :            :         title,
<span class="lineNum">    2966 </span>                :<span class="lineCov">        182 :         server.bindaddr_count ? server.bindaddr[0] : &quot;*&quot;,</span>
<span class="lineNum">    2967 </span>                :            :         server.port);
<span class="lineNum">    2968 </span>                :            : #else
<span class="lineNum">    2969 </span>                :            :     REDIS_NOTUSED(title);
<span class="lineNum">    2970 </span>                :            : #endif
<a name="2971"><span class="lineNum">    2971 </span>                :<span class="lineCov">        182 : }</span></a>
<span class="lineNum">    2972 </span>                :            : 
<span class="lineNum">    2973 </span>                :<span class="lineCov">        131 : int main(int argc, char **argv) {</span>
<span class="lineNum">    2974 </span>                :            :     struct timeval tv;
<span class="lineNum">    2975 </span>                :            : 
<span class="lineNum">    2976 </span>                :            :     /* We need to initialize our libraries, and the server configuration. */
<span class="lineNum">    2977 </span>                :            : #ifdef INIT_SETPROCTITLE_REPLACEMENT
<span class="lineNum">    2978 </span>                :<span class="lineCov">        131 :     spt_init(argc, argv);</span>
<span class="lineNum">    2979 </span>                :            : #endif
<span class="lineNum">    2980 </span>                :<span class="lineCov">        131 :     setlocale(LC_COLLATE,&quot;&quot;);</span>
<span class="lineNum">    2981 </span>                :<span class="lineCov">        131 :     zmalloc_enable_thread_safeness();</span>
<span class="lineNum">    2982 </span>                :<span class="lineCov">        131 :     zmalloc_set_oom_handler(redisOutOfMemoryHandler);</span>
<span class="lineNum">    2983 </span>                :<span class="lineCov">        131 :     srand(time(NULL)^getpid());</span>
<span class="lineNum">    2984 </span>                :<span class="lineCov">        131 :     gettimeofday(&amp;tv,NULL);</span>
<span class="lineNum">    2985 </span>                :<span class="lineCov">        131 :     dictSetHashFunctionSeed(tv.tv_sec^tv.tv_usec^getpid());</span>
<span class="lineNum">    2986 </span>                :<span class="lineCov">        131 :     server.sentinel_mode = checkForSentinelMode(argc,argv);</span>
<span class="lineNum">    2987 </span>                :<span class="lineCov">        131 :     initServerConfig();</span>
<span class="lineNum">    2988 </span>                :            : 
<span class="lineNum">    2989 </span>                :            :     /* We need to init sentinel right now as parsing the configuration file
<span class="lineNum">    2990 </span>                :            :      * in sentinel mode will have the effect of populating the sentinel
<span class="lineNum">    2991 </span>                :            :      * data structures with master nodes to monitor. */
<span class="lineNum">    2992 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">        131 :     if (server.sentinel_mode) {</span>
<span class="lineNum">    2993 </span>                :<span class="lineNoCov">          0 :         initSentinelConfig();</span>
<span class="lineNum">    2994 </span>                :<span class="lineNoCov">          0 :         initSentinel();</span>
<span class="lineNum">    2995 </span>                :            :     }
<span class="lineNum">    2996 </span>                :            : 
<span class="lineNum">    2997 </span>        [<span class="branchCov" title="Branch 0 was taken 131 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        131 :     if (argc &gt;= 2) {</span>
<span class="lineNum">    2998 </span>                :<span class="lineCov">        131 :         int j = 1; /* First option to parse in argv[] */</span>
<span class="lineNum">    2999 </span>                :<span class="lineCov">        131 :         sds options = sdsempty();</span>
<span class="lineNum">    3000 </span>                :<span class="lineCov">        131 :         char *configfile = NULL;</span>
<span class="lineNum">    3001 </span>                :            : 
<span class="lineNum">    3002 </span>                :            :         /* Handle special options --help and --version */
<span class="lineNum">    3003 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">        131 :         if (strcmp(argv[1], &quot;-v&quot;) == 0 ||</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 131 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchNoCov" title="Branch 6 was not taken"> - </span><span class="branchCov" title="Branch 7 was taken 131 times"> + </span>]
<span class="lineNum">    3004 </span>                :<span class="lineNoCov">          0 :             strcmp(argv[1], &quot;--version&quot;) == 0) version();</span>
<span class="lineNum">    3005 </span>[<span class="branchCov" title="Branch 0 was taken 131 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 131 times"> + </span>]:<span class="lineCov">        262 :         if (strcmp(argv[1], &quot;--help&quot;) == 0 ||</span>
<span class="lineNum">    3006 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">        131 :             strcmp(argv[1], &quot;-h&quot;) == 0) usage();</span>
<span class="lineNum">    3007 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">        131 :         if (strcmp(argv[1], &quot;--test-memory&quot;) == 0) {</span>
<span class="lineNum">    3008 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (argc == 3) {</span>
<span class="lineNum">    3009 </span>                :<span class="lineNoCov">          0 :                 memtest(atoi(argv[2]),50);</span>
<span class="lineNum">    3010 </span>                :<span class="lineNoCov">          0 :                 exit(0);</span>
<span class="lineNum">    3011 </span>                :            :             } else {
<span class="lineNum">    3012 </span>                :<span class="lineNoCov">          0 :                 fprintf(stderr,&quot;Please specify the amount of memory to test in megabytes.\n&quot;);</span>
<span class="lineNum">    3013 </span>                :<span class="lineNoCov">          0 :                 fprintf(stderr,&quot;Example: ./redis-server --test-memory 4096\n\n&quot;);</span>
<span class="lineNum">    3014 </span>                :<span class="lineNoCov">          0 :                 exit(1);</span>
<span class="lineNum">    3015 </span>                :            :             }
<span class="lineNum">    3016 </span>                :            :         }
<span class="lineNum">    3017 </span>                :            : 
<span class="lineNum">    3018 </span>                :            :         /* First argument is the config file name? */
<span class="lineNum">    3019 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">        131 :         if (argv[j][0] != '-' || argv[j][1] != '-')</span>
<span class="lineNum">    3020 </span>                :<span class="lineCov">        131 :             configfile = argv[j++];</span>
<span class="lineNum">    3021 </span>                :            :         /* All the other options are parsed and conceptually appended to the
<span class="lineNum">    3022 </span>                :            :          * configuration file. For instance --port 6380 will generate the
<span class="lineNum">    3023 </span>                :            :          * string &quot;port 6380\n&quot; to be parsed after the actual file name
<span class="lineNum">    3024 </span>                :            :          * is parsed, if any. */
<span class="lineNum">    3025 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">        131 :         while(j != argc) {</span>
<span class="lineNum">    3026 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (argv[j][0] == '-' &amp;&amp; argv[j][1] == '-') {</span>
<span class="lineNum">    3027 </span>                :            :                 /* Option name */
<span class="lineNum">    3028 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (sdslen(options)) options = sdscat(options,&quot;\n&quot;);</span>
<span class="lineNum">    3029 </span>                :<span class="lineNoCov">          0 :                 options = sdscat(options,argv[j]+2);</span>
<span class="lineNum">    3030 </span>                :<span class="lineNoCov">          0 :                 options = sdscat(options,&quot; &quot;);</span>
<span class="lineNum">    3031 </span>                :            :             } else {
<span class="lineNum">    3032 </span>                :            :                 /* Option argument */
<span class="lineNum">    3033 </span>                :<span class="lineNoCov">          0 :                 options = sdscatrepr(options,argv[j],strlen(argv[j]));</span>
<span class="lineNum">    3034 </span>                :<span class="lineNoCov">          0 :                 options = sdscat(options,&quot; &quot;);</span>
<span class="lineNum">    3035 </span>                :            :             }
<span class="lineNum">    3036 </span>                :<span class="lineNoCov">          0 :             j++;</span>
<span class="lineNum">    3037 </span>                :            :         }
<span class="lineNum">    3038 </span>                :<span class="lineCov">        131 :         resetServerSaveParams();</span>
<span class="lineNum">    3039 </span>                :<span class="lineCov">        131 :         loadServerConfig(configfile,options);</span>
<span class="lineNum">    3040 </span>                :<span class="lineCov">        131 :         sdsfree(options);</span>
<span class="lineNum">    3041 </span>        [<span class="branchCov" title="Branch 0 was taken 131 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        131 :         if (configfile) server.configfile = getAbsolutePath(configfile);</span>
<span class="lineNum">    3042 </span>                :            :     } else {
<span class="lineNum">    3043 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         redisLog(REDIS_WARNING, &quot;Warning: no config file specified, using the default config. In order to specify a config file use %s /path/to/%s.conf&quot;, argv[0], server.sentinel_mode ? &quot;sentinel&quot; : &quot;redis&quot;);</span>
<span class="lineNum">    3044 </span>                :            :     }
<span class="lineNum">    3045 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">        131 :     if (server.daemonize) daemonize();</span>
<span class="lineNum">    3046 </span>                :<span class="lineCov">        131 :     initServer();</span>
<span class="lineNum">    3047 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 131 times"> + </span>]:<span class="lineCov">        131 :     if (server.daemonize) createPidFile();</span>
<span class="lineNum">    3048 </span>                :<span class="lineCov">        131 :     redisSetProcTitle(argv[0]);</span>
<span class="lineNum">    3049 </span>                :<span class="lineCov">        131 :     redisAsciiArt();</span>
<span class="lineNum">    3050 </span>                :            : 
<span class="lineNum">    3051 </span>        [<span class="branchCov" title="Branch 0 was taken 131 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        131 :     if (!server.sentinel_mode) {</span>
<span class="lineNum">    3052 </span>                :            :         /* Things not needed when running in Sentinel mode. */
<span class="lineNum">    3053 </span>                :<span class="lineCov">        131 :         redisLog(REDIS_WARNING,&quot;Server started, Redis version &quot; REDIS_VERSION);</span>
<span class="lineNum">    3054 </span>                :            :     #ifdef __linux__
<span class="lineNum">    3055 </span>                :<span class="lineCov">        131 :         linuxOvercommitMemoryWarning();</span>
<span class="lineNum">    3056 </span>                :            :     #endif
<span class="lineNum">    3057 </span>                :<span class="lineCov">        131 :         loadDataFromDisk();</span>
<span class="lineNum">    3058 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 127 times"> + </span>]:<span class="lineCov">        127 :         if (server.cluster_enabled) {</span>
<span class="lineNum">    3059 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (verifyClusterConfigWithData() == REDIS_ERR) {</span>
<span class="lineNum">    3060 </span>                :<span class="lineNoCov">          0 :                 redisLog(REDIS_WARNING,</span>
<span class="lineNum">    3061 </span>                :            :                     &quot;You can't have keys in a DB different than DB 0 when in &quot;
<span class="lineNum">    3062 </span>                :            :                     &quot;Cluster mode. Exiting.&quot;);
<span class="lineNum">    3063 </span>                :<span class="lineNoCov">          0 :                 exit(1);</span>
<span class="lineNum">    3064 </span>                :            :             }
<span class="lineNum">    3065 </span>                :            :         }
<span class="lineNum">    3066 </span>        [<span class="branchCov" title="Branch 0 was taken 127 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        127 :         if (server.ipfd_count &gt; 0)</span>
<span class="lineNum">    3067 </span>                :<span class="lineCov">        127 :             redisLog(REDIS_NOTICE,&quot;The server is now ready to accept connections on port %d&quot;, server.port);</span>
<span class="lineNum">    3068 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 127 times"> + </span>]:<span class="lineCov">        127 :         if (server.sofd &gt; 0)</span>
<span class="lineNum">    3069 </span>                :<span class="lineNoCov">          0 :             redisLog(REDIS_NOTICE,&quot;The server is now ready to accept connections at %s&quot;, server.unixsocket);</span>
<span class="lineNum">    3070 </span>                :            :     }
<span class="lineNum">    3071 </span>                :            : 
<span class="lineNum">    3072 </span>                :            :     /* Warning the user about suspicious maxmemory setting. */
<span class="lineNum">    3073 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 127 times"> + </span>]:<span class="lineCov">        127 :     if (server.maxmemory &gt; 0 &amp;&amp; server.maxmemory &lt; 1024*1024) {</span>
<span class="lineNum">    3074 </span>                :<span class="lineNoCov">          0 :         redisLog(REDIS_WARNING,&quot;WARNING: You specified a maxmemory value that is less than 1MB (current value is %llu bytes). Are you sure this is what you really want?&quot;, server.maxmemory);</span>
<span class="lineNum">    3075 </span>                :            :     }
<span class="lineNum">    3076 </span>                :            : 
<span class="lineNum">    3077 </span>                :<span class="lineCov">        127 :     aeSetBeforeSleepProc(server.el,beforeSleep);</span>
<span class="lineNum">    3078 </span>                :<span class="lineCov">        127 :     aeMain(server.el);</span>
<span class="lineNum">    3079 </span>                :<span class="lineNoCov">          0 :     aeDeleteEventLoop(server.el);</span>
<span class="lineNum">    3080 </span>                :            :     return 0;
<span class="lineNum">    3081 </span>                :            : }
<span class="lineNum">    3082 </span>                :            : 
<span class="lineNum">    3083 </span>                :            : /* The End */
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.9</a></td></tr>
  </table>
  <br>

</body>
</html>

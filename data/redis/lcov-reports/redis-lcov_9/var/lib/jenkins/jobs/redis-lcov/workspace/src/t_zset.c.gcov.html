<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - redis-lcov_9.info - /var/lib/jenkins/jobs/redis-lcov/workspace/src/t_zset.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../../../index.html">top level</a> - <a href="index.html">var/lib/jenkins/jobs/redis-lcov/workspace/src</a> - t_zset.c<span style="font-size: 80%;"> (source / <a href="t_zset.c.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">redis-lcov_9.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1037</td>
            <td class="headerCovTableEntry">1112</td>
            <td class="headerCovTableEntryHi">93.3 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2013-08-26</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">62</td>
            <td class="headerCovTableEntry">65</td>
            <td class="headerCovTableEntryHi">95.4 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
            | Branches:
            <span class="coverLegendCov">+</span> taken
            <span class="coverLegendNoCov">-</span> not taken
            <span class="coverLegendNoCov">#</span> not executed
</td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">740</td>
            <td class="headerCovTableEntry">916</td>
            <td class="headerCovTableEntryMed">80.8 %</td>
          </tr>
          <tr><td><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : /*</a>
<span class="lineNum">       2 </span>                :            :  * Copyright (c) 2009-2012, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;
<span class="lineNum">       3 </span>                :            :  * Copyright (c) 2009-2012, Pieter Noordhuis &lt;pcnoordhuis at gmail dot com&gt;
<span class="lineNum">       4 </span>                :            :  * All rights reserved.
<span class="lineNum">       5 </span>                :            :  *
<span class="lineNum">       6 </span>                :            :  * Redistribution and use in source and binary forms, with or without
<span class="lineNum">       7 </span>                :            :  * modification, are permitted provided that the following conditions are met:
<span class="lineNum">       8 </span>                :            :  *
<span class="lineNum">       9 </span>                :            :  *   * Redistributions of source code must retain the above copyright notice,
<span class="lineNum">      10 </span>                :            :  *     this list of conditions and the following disclaimer.
<span class="lineNum">      11 </span>                :            :  *   * Redistributions in binary form must reproduce the above copyright
<span class="lineNum">      12 </span>                :            :  *     notice, this list of conditions and the following disclaimer in the
<span class="lineNum">      13 </span>                :            :  *     documentation and/or other materials provided with the distribution.
<span class="lineNum">      14 </span>                :            :  *   * Neither the name of Redis nor the names of its contributors may be used
<span class="lineNum">      15 </span>                :            :  *     to endorse or promote products derived from this software without
<span class="lineNum">      16 </span>                :            :  *     specific prior written permission.
<span class="lineNum">      17 </span>                :            :  *
<span class="lineNum">      18 </span>                :            :  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;
<span class="lineNum">      19 </span>                :            :  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
<span class="lineNum">      20 </span>                :            :  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
<span class="lineNum">      21 </span>                :            :  * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
<span class="lineNum">      22 </span>                :            :  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
<span class="lineNum">      23 </span>                :            :  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
<span class="lineNum">      24 </span>                :            :  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
<span class="lineNum">      25 </span>                :            :  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
<span class="lineNum">      26 </span>                :            :  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
<span class="lineNum">      27 </span>                :            :  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
<span class="lineNum">      28 </span>                :            :  * POSSIBILITY OF SUCH DAMAGE.
<span class="lineNum">      29 </span>                :            :  */
<span class="lineNum">      30 </span>                :            : 
<span class="lineNum">      31 </span>                :            : /*-----------------------------------------------------------------------------
<span class="lineNum">      32 </span>                :            :  * Sorted set API
<span class="lineNum">      33 </span>                :            :  *----------------------------------------------------------------------------*/
<span class="lineNum">      34 </span>                :            : 
<span class="lineNum">      35 </span>                :            : /* ZSETs are ordered sets using two data structures to hold the same elements
<span class="lineNum">      36 </span>                :            :  * in order to get O(log(N)) INSERT and REMOVE operations into a sorted
<span class="lineNum">      37 </span>                :            :  * data structure.
<span class="lineNum">      38 </span>                :            :  *
<span class="lineNum">      39 </span>                :            :  * The elements are added to an hash table mapping Redis objects to scores.
<span class="lineNum">      40 </span>                :            :  * At the same time the elements are added to a skip list mapping scores
<span class="lineNum">      41 </span>                :            :  * to Redis objects (so objects are sorted by scores in this &quot;view&quot;). */
<span class="lineNum">      42 </span>                :            : 
<span class="lineNum">      43 </span>                :            : /* This skiplist implementation is almost a C translation of the original
<span class="lineNum">      44 </span>                :            :  * algorithm described by William Pugh in &quot;Skip Lists: A Probabilistic
<span class="lineNum">      45 </span>                :            :  * Alternative to Balanced Trees&quot;, modified in three ways:
<span class="lineNum">      46 </span>                :            :  * a) this implementation allows for repeated scores.
<span class="lineNum">      47 </span>                :            :  * b) the comparison is not just by key (our 'score') but by satellite data.
<span class="lineNum">      48 </span>                :            :  * c) there is a back pointer, so it's a doubly linked list with the back
<span class="lineNum">      49 </span>                :            :  * pointers being only at &quot;level 1&quot;. This allows to traverse the list
<span class="lineNum">      50 </span>                :            :  * from tail to head, useful for ZREVRANGE. */
<span class="lineNum">      51 </span>                :            : 
<span class="lineNum">      52 </span>                :            : #include &quot;redis.h&quot;
<a name="53"><span class="lineNum">      53 </span>                :            : #include &lt;math.h&gt;</a>
<span class="lineNum">      54 </span>                :            : 
<span class="lineNum">      55 </span>                :<span class="lineCov">      98587 : zskiplistNode *zslCreateNode(int level, double score, robj *obj) {</span>
<span class="lineNum">      56 </span>                :<span class="lineCov">      98587 :     zskiplistNode *zn = zmalloc(sizeof(*zn)+level*sizeof(struct zskiplistLevel));</span>
<span class="lineNum">      57 </span>                :<span class="lineCov">      98587 :     zn-&gt;score = score;</span>
<span class="lineNum">      58 </span>                :<span class="lineCov">      98587 :     zn-&gt;obj = obj;</span>
<span class="lineNum">      59 </span>                :<span class="lineCov">      98587 :     return zn;</span>
<a name="60"><span class="lineNum">      60 </span>                :            : }</a>
<span class="lineNum">      61 </span>                :            : 
<span class="lineNum">      62 </span>                :<span class="lineCov">      33422 : zskiplist *zslCreate(void) {</span>
<span class="lineNum">      63 </span>                :            :     int j;
<span class="lineNum">      64 </span>                :            :     zskiplist *zsl;
<span class="lineNum">      65 </span>                :            : 
<span class="lineNum">      66 </span>                :<span class="lineCov">      33422 :     zsl = zmalloc(sizeof(*zsl));</span>
<span class="lineNum">      67 </span>                :<span class="lineCov">      33422 :     zsl-&gt;level = 1;</span>
<span class="lineNum">      68 </span>                :<span class="lineCov">      33422 :     zsl-&gt;length = 0;</span>
<span class="lineNum">      69 </span>                :<span class="lineCov">      33422 :     zsl-&gt;header = zslCreateNode(ZSKIPLIST_MAXLEVEL,0,NULL);</span>
<span class="lineNum">      70 </span>        [<span class="branchCov" title="Branch 0 was taken 1069504 times"> + </span><span class="branchCov" title="Branch 1 was taken 33422 times"> + </span>]:<span class="lineCov">    1102926 :     for (j = 0; j &lt; ZSKIPLIST_MAXLEVEL; j++) {</span>
<span class="lineNum">      71 </span>                :<span class="lineCov">    1069504 :         zsl-&gt;header-&gt;level[j].forward = NULL;</span>
<span class="lineNum">      72 </span>                :<span class="lineCov">    1069504 :         zsl-&gt;header-&gt;level[j].span = 0;</span>
<span class="lineNum">      73 </span>                :            :     }
<span class="lineNum">      74 </span>                :<span class="lineCov">      33422 :     zsl-&gt;header-&gt;backward = NULL;</span>
<span class="lineNum">      75 </span>                :<span class="lineCov">      33422 :     zsl-&gt;tail = NULL;</span>
<span class="lineNum">      76 </span>                :<span class="lineCov">      33422 :     return zsl;</span>
<a name="77"><span class="lineNum">      77 </span>                :            : }</a>
<span class="lineNum">      78 </span>                :            : 
<span class="lineNum">      79 </span>                :<span class="lineCov">      37245 : void zslFreeNode(zskiplistNode *node) {</span>
<span class="lineNum">      80 </span>                :<span class="lineCov">      37245 :     decrRefCount(node-&gt;obj);</span>
<span class="lineNum">      81 </span>                :<span class="lineCov">      37245 :     zfree(node);</span>
<a name="82"><span class="lineNum">      82 </span>                :<span class="lineCov">      37245 : }</span></a>
<span class="lineNum">      83 </span>                :            : 
<span class="lineNum">      84 </span>                :<span class="lineCov">      13584 : void zslFree(zskiplist *zsl) {</span>
<span class="lineNum">      85 </span>                :<span class="lineCov">      13584 :     zskiplistNode *node = zsl-&gt;header-&gt;level[0].forward, *next;</span>
<span class="lineNum">      86 </span>                :            : 
<span class="lineNum">      87 </span>                :<span class="lineCov">      13584 :     zfree(zsl-&gt;header);</span>
<span class="lineNum">      88 </span>        [<span class="branchCov" title="Branch 0 was taken 16513 times"> + </span><span class="branchCov" title="Branch 1 was taken 13584 times"> + </span>]:<span class="lineCov">      30097 :     while(node) {</span>
<span class="lineNum">      89 </span>                :<span class="lineCov">      16513 :         next = node-&gt;level[0].forward;</span>
<span class="lineNum">      90 </span>                :<span class="lineCov">      16513 :         zslFreeNode(node);</span>
<span class="lineNum">      91 </span>                :<span class="lineCov">      16513 :         node = next;</span>
<span class="lineNum">      92 </span>                :            :     }
<span class="lineNum">      93 </span>                :<span class="lineCov">      13584 :     zfree(zsl);</span>
<span class="lineNum">      94 </span>                :<span class="lineCov">      13584 : }</span>
<span class="lineNum">      95 </span>                :            : 
<span class="lineNum">      96 </span>                :            : /* Returns a random level for the new skiplist node we are going to create.
<span class="lineNum">      97 </span>                :            :  * The return value of this function is between 1 and ZSKIPLIST_MAXLEVEL
<a name="98"><span class="lineNum">      98 </span>                :            :  * (both inclusive), with a powerlaw-alike distribution where higher</a>
<span class="lineNum">      99 </span>                :            :  * levels are less likely to be returned. */
<span class="lineNum">     100 </span>                :<span class="lineCov">      65165 : int zslRandomLevel(void) {</span>
<span class="lineNum">     101 </span>                :<span class="lineCov">      65165 :     int level = 1;</span>
<span class="lineNum">     102 </span>        [<span class="branchCov" title="Branch 1 was taken 21788 times"> + </span><span class="branchCov" title="Branch 2 was taken 65165 times"> + </span>]:<span class="lineCov">      86953 :     while ((random()&amp;0xFFFF) &lt; (ZSKIPLIST_P * 0xFFFF))</span>
<span class="lineNum">     103 </span>                :<span class="lineCov">      21788 :         level += 1;</span>
<span class="lineNum">     104 </span>                :<span class="lineCov">      65165 :     return (level&lt;ZSKIPLIST_MAXLEVEL) ? level : ZSKIPLIST_MAXLEVEL;</span>
<a name="105"><span class="lineNum">     105 </span>                :            : }</a>
<span class="lineNum">     106 </span>                :            : 
<span class="lineNum">     107 </span>                :<span class="lineCov">      65165 : zskiplistNode *zslInsert(zskiplist *zsl, double score, robj *obj) {</span>
<span class="lineNum">     108 </span>                :            :     zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;
<span class="lineNum">     109 </span>                :            :     unsigned int rank[ZSKIPLIST_MAXLEVEL];
<span class="lineNum">     110 </span>                :            :     int i, level;
<span class="lineNum">     111 </span>                :            : 
<span class="lineNum">     112 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 65165 times"> + </span>]:<span class="lineCov">      65165 :     redisAssert(!isnan(score));</span>
<span class="lineNum">     113 </span>                :<span class="lineCov">      65165 :     x = zsl-&gt;header;</span>
<span class="lineNum">     114 </span>        [<span class="branchCov" title="Branch 0 was taken 156686 times"> + </span><span class="branchCov" title="Branch 1 was taken 65165 times"> + </span>]:<span class="lineCov">     221851 :     for (i = zsl-&gt;level-1; i &gt;= 0; i--) {</span>
<span class="lineNum">     115 </span>                :            :         /* store rank that is crossed to reach the insert position */
<span class="lineNum">     116 </span>        [<span class="branchCov" title="Branch 0 was taken 91521 times"> + </span><span class="branchCov" title="Branch 1 was taken 65165 times"> + </span>]:<span class="lineCov">     156686 :         rank[i] = i == (zsl-&gt;level-1) ? 0 : rank[i+1];</span>
<span class="lineNum">     117 </span>[<span class="branchCov" title="Branch 0 was taken 304169 times"> + </span><span class="branchCov" title="Branch 1 was taken 61617 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 208512 times"> + </span><span class="branchCov" title="Branch 3 was taken 95657 times"> + </span>]:<span class="lineCov">     365786 :         while (x-&gt;level[i].forward &amp;&amp;</span>
<span class="lineNum">     118 </span>        [<span class="branchCov" title="Branch 0 was taken 900 times"> + </span><span class="branchCov" title="Branch 1 was taken 94757 times"> + </span>]:<span class="lineCov">      95657 :             (x-&gt;level[i].forward-&gt;score &lt; score ||</span>
<span class="lineNum">     119 </span>        [<span class="branchCov" title="Branch 0 was taken 588 times"> + </span><span class="branchCov" title="Branch 1 was taken 312 times"> + </span>]:<span class="lineCov">        900 :                 (x-&gt;level[i].forward-&gt;score == score &amp;&amp;</span>
<span class="lineNum">     120 </span>                :<span class="lineCov">        900 :                 compareStringObjects(x-&gt;level[i].forward-&gt;obj,obj) &lt; 0))) {</span>
<span class="lineNum">     121 </span>                :<span class="lineCov">     209100 :             rank[i] += x-&gt;level[i].span;</span>
<span class="lineNum">     122 </span>                :<span class="lineCov">     209100 :             x = x-&gt;level[i].forward;</span>
<span class="lineNum">     123 </span>                :            :         }
<span class="lineNum">     124 </span>                :<span class="lineCov">     156686 :         update[i] = x;</span>
<span class="lineNum">     125 </span>                :            :     }
<span class="lineNum">     126 </span>                :            :     /* we assume the key is not already inside, since we allow duplicated
<span class="lineNum">     127 </span>                :            :      * scores, and the re-insertion of score and redis object should never
<span class="lineNum">     128 </span>                :            :      * happen since the caller of zslInsert() should test in the hash table
<span class="lineNum">     129 </span>                :            :      * if the element is already inside or not. */
<span class="lineNum">     130 </span>                :<span class="lineCov">      65165 :     level = zslRandomLevel();</span>
<span class="lineNum">     131 </span>        [<span class="branchCov" title="Branch 0 was taken 10104 times"> + </span><span class="branchCov" title="Branch 1 was taken 55061 times"> + </span>]:<span class="lineCov">      65165 :     if (level &gt; zsl-&gt;level) {</span>
<span class="lineNum">     132 </span>        [<span class="branchCov" title="Branch 0 was taken 13507 times"> + </span><span class="branchCov" title="Branch 1 was taken 10104 times"> + </span>]:<span class="lineCov">      23611 :         for (i = zsl-&gt;level; i &lt; level; i++) {</span>
<span class="lineNum">     133 </span>                :<span class="lineCov">      13507 :             rank[i] = 0;</span>
<span class="lineNum">     134 </span>                :<span class="lineCov">      13507 :             update[i] = zsl-&gt;header;</span>
<span class="lineNum">     135 </span>                :<span class="lineCov">      13507 :             update[i]-&gt;level[i].span = zsl-&gt;length;</span>
<span class="lineNum">     136 </span>                :            :         }
<span class="lineNum">     137 </span>                :<span class="lineCov">      10104 :         zsl-&gt;level = level;</span>
<span class="lineNum">     138 </span>                :            :     }
<span class="lineNum">     139 </span>                :<span class="lineCov">      65165 :     x = zslCreateNode(level,score,obj);</span>
<span class="lineNum">     140 </span>        [<span class="branchCov" title="Branch 1 was taken 86953 times"> + </span><span class="branchCov" title="Branch 2 was taken 65165 times"> + </span>]:<span class="lineCov">     152118 :     for (i = 0; i &lt; level; i++) {</span>
<span class="lineNum">     141 </span>                :<span class="lineCov">      86953 :         x-&gt;level[i].forward = update[i]-&gt;level[i].forward;</span>
<span class="lineNum">     142 </span>                :<span class="lineCov">      86953 :         update[i]-&gt;level[i].forward = x;</span>
<span class="lineNum">     143 </span>                :            : 
<span class="lineNum">     144 </span>                :            :         /* update span covered by update[i] as x is inserted here */
<span class="lineNum">     145 </span>                :<span class="lineCov">      86953 :         x-&gt;level[i].span = update[i]-&gt;level[i].span - (rank[0] - rank[i]);</span>
<span class="lineNum">     146 </span>                :<span class="lineCov">      86953 :         update[i]-&gt;level[i].span = (rank[0] - rank[i]) + 1;</span>
<span class="lineNum">     147 </span>                :            :     }
<span class="lineNum">     148 </span>                :            : 
<span class="lineNum">     149 </span>                :            :     /* increment span for untouched levels */
<span class="lineNum">     150 </span>        [<span class="branchCov" title="Branch 0 was taken 83240 times"> + </span><span class="branchCov" title="Branch 1 was taken 65165 times"> + </span>]:<span class="lineCov">     148405 :     for (i = level; i &lt; zsl-&gt;level; i++) {</span>
<span class="lineNum">     151 </span>                :<span class="lineCov">      83240 :         update[i]-&gt;level[i].span++;</span>
<span class="lineNum">     152 </span>                :            :     }
<span class="lineNum">     153 </span>                :            : 
<span class="lineNum">     154 </span>        [<span class="branchCov" title="Branch 0 was taken 32453 times"> + </span><span class="branchCov" title="Branch 1 was taken 32712 times"> + </span>]:<span class="lineCov">      65165 :     x-&gt;backward = (update[0] == zsl-&gt;header) ? NULL : update[0];</span>
<span class="lineNum">     155 </span>        [<span class="branchCov" title="Branch 0 was taken 27263 times"> + </span><span class="branchCov" title="Branch 1 was taken 37902 times"> + </span>]:<span class="lineCov">      65165 :     if (x-&gt;level[0].forward)</span>
<span class="lineNum">     156 </span>                :<span class="lineCov">      27263 :         x-&gt;level[0].forward-&gt;backward = x;</span>
<span class="lineNum">     157 </span>                :            :     else
<span class="lineNum">     158 </span>                :<span class="lineCov">      37902 :         zsl-&gt;tail = x;</span>
<span class="lineNum">     159 </span>                :<span class="lineCov">      65165 :     zsl-&gt;length++;</span>
<span class="lineNum">     160 </span>                :<span class="lineCov">      65165 :     return x;</span>
<span class="lineNum">     161 </span>                :            : }
<a name="162"><span class="lineNum">     162 </span>                :            : </a>
<span class="lineNum">     163 </span>                :            : /* Internal function used by zslDelete, zslDeleteByScore and zslDeleteByRank */
<span class="lineNum">     164 </span>                :<span class="lineCov">       5490 : void zslDeleteNode(zskiplist *zsl, zskiplistNode *x, zskiplistNode **update) {</span>
<span class="lineNum">     165 </span>                :            :     int i;
<span class="lineNum">     166 </span>        [<span class="branchCov" title="Branch 0 was taken 13224 times"> + </span><span class="branchCov" title="Branch 1 was taken 5490 times"> + </span>]:<span class="lineCov">      18714 :     for (i = 0; i &lt; zsl-&gt;level; i++) {</span>
<span class="lineNum">     167 </span>        [<span class="branchCov" title="Branch 0 was taken 7429 times"> + </span><span class="branchCov" title="Branch 1 was taken 5795 times"> + </span>]:<span class="lineCov">      13224 :         if (update[i]-&gt;level[i].forward == x) {</span>
<span class="lineNum">     168 </span>                :<span class="lineCov">       7429 :             update[i]-&gt;level[i].span += x-&gt;level[i].span - 1;</span>
<span class="lineNum">     169 </span>                :<span class="lineCov">       7429 :             update[i]-&gt;level[i].forward = x-&gt;level[i].forward;</span>
<span class="lineNum">     170 </span>                :            :         } else {
<span class="lineNum">     171 </span>                :<span class="lineCov">       5795 :             update[i]-&gt;level[i].span -= 1;</span>
<span class="lineNum">     172 </span>                :            :         }
<span class="lineNum">     173 </span>                :            :     }
<span class="lineNum">     174 </span>        [<span class="branchCov" title="Branch 0 was taken 1992 times"> + </span><span class="branchCov" title="Branch 1 was taken 3498 times"> + </span>]:<span class="lineCov">       5490 :     if (x-&gt;level[0].forward) {</span>
<span class="lineNum">     175 </span>                :<span class="lineCov">       5490 :         x-&gt;level[0].forward-&gt;backward = x-&gt;backward;</span>
<span class="lineNum">     176 </span>                :            :     } else {
<span class="lineNum">     177 </span>                :<span class="lineCov">       3498 :         zsl-&gt;tail = x-&gt;backward;</span>
<span class="lineNum">     178 </span>                :            :     }
<span class="lineNum">     179 </span>[<span class="branchCov" title="Branch 0 was taken 3274 times"> + </span><span class="branchCov" title="Branch 1 was taken 3494 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1278 times"> + </span><span class="branchCov" title="Branch 3 was taken 1996 times"> + </span>]:<span class="lineCov">       6768 :     while(zsl-&gt;level &gt; 1 &amp;&amp; zsl-&gt;header-&gt;level[zsl-&gt;level-1].forward == NULL)</span>
<span class="lineNum">     180 </span>                :<span class="lineCov">       1278 :         zsl-&gt;level--;</span>
<span class="lineNum">     181 </span>                :<span class="lineCov">       5490 :     zsl-&gt;length--;</span>
<span class="lineNum">     182 </span>                :<span class="lineCov">       5490 : }</span>
<a name="183"><span class="lineNum">     183 </span>                :            : </a>
<span class="lineNum">     184 </span>                :            : /* Delete an element with matching score/object from the skiplist. */
<span class="lineNum">     185 </span>                :<span class="lineCov">       5438 : int zslDelete(zskiplist *zsl, double score, robj *obj) {</span>
<span class="lineNum">     186 </span>                :            :     zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;
<span class="lineNum">     187 </span>                :            :     int i;
<span class="lineNum">     188 </span>                :            : 
<span class="lineNum">     189 </span>                :<span class="lineCov">       5438 :     x = zsl-&gt;header;</span>
<span class="lineNum">     190 </span>        [<span class="branchCov" title="Branch 0 was taken 13104 times"> + </span><span class="branchCov" title="Branch 1 was taken 5438 times"> + </span>]:<span class="lineCov">      18542 :     for (i = zsl-&gt;level-1; i &gt;= 0; i--) {</span>
<span class="lineNum">     191 </span>[<span class="branchCov" title="Branch 0 was taken 27370 times"> + </span><span class="branchCov" title="Branch 1 was taken 1184 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 15450 times"> + </span><span class="branchCov" title="Branch 3 was taken 11920 times"> + </span>]:<span class="lineCov">      28554 :         while (x-&gt;level[i].forward &amp;&amp;</span>
<span class="lineNum">     192 </span>        [<span class="branchCov" title="Branch 0 was taken 7355 times"> + </span><span class="branchCov" title="Branch 1 was taken 4565 times"> + </span>]:<span class="lineCov">      11920 :             (x-&gt;level[i].forward-&gt;score &lt; score ||</span>
<span class="lineNum">     193 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7355 times"> + </span>]:<span class="lineCov">       7355 :                 (x-&gt;level[i].forward-&gt;score == score &amp;&amp;</span>
<span class="lineNum">     194 </span>                :<span class="lineCov">       7355 :                 compareStringObjects(x-&gt;level[i].forward-&gt;obj,obj) &lt; 0)))</span>
<span class="lineNum">     195 </span>                :<span class="lineCov">      15450 :             x = x-&gt;level[i].forward;</span>
<span class="lineNum">     196 </span>                :<span class="lineCov">      13104 :         update[i] = x;</span>
<span class="lineNum">     197 </span>                :            :     }
<span class="lineNum">     198 </span>                :            :     /* We may have multiple elements with the same score, what we need
<span class="lineNum">     199 </span>                :            :      * is to find the element with both the right score and object. */
<span class="lineNum">     200 </span>                :<span class="lineCov">       5438 :     x = x-&gt;level[0].forward;</span>
<span class="lineNum">     201 </span>[<span class="branchCov" title="Branch 0 was taken 5438 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 5438 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       5438 :     if (x &amp;&amp; score == x-&gt;score &amp;&amp; equalStringObjects(x-&gt;obj,obj)) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 5 was taken 5438 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>]
<span class="lineNum">     202 </span>                :<span class="lineCov">       5438 :         zslDeleteNode(zsl, x, update);</span>
<span class="lineNum">     203 </span>                :<span class="lineCov">       5438 :         zslFreeNode(x);</span>
<span class="lineNum">     204 </span>                :<span class="lineCov">       5438 :         return 1;</span>
<span class="lineNum">     205 </span>                :            :     } else {
<span class="lineNum">     206 </span>                :            :         return 0; /* not found */
<span class="lineNum">     207 </span>                :            :     }
<span class="lineNum">     208 </span>                :            :     return 0; /* not found */
<a name="209"><span class="lineNum">     209 </span>                :            : }</a>
<a name="210"><span class="lineNum">     210 </span>                :            : </a>
<span class="lineNum">     211 </span>                :<span class="lineNoCov">          0 : static int zslValueGteMin(double value, zrangespec *spec) {</span>
<span class="lineNum">     212 </span>[<span class="branchCov" title="Branch 0 was taken 10 times"> + </span><span class="branchCov" title="Branch 1 was taken 31 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 10 times"> + </span><span class="branchCov" title="Branch 3 was taken 31 times"> + </span>]:<span class="lineCov">      67037 :     return spec-&gt;minex ? (value &gt; spec-&gt;min) : (value &gt;= spec-&gt;min);</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 4 times"> + </span><span class="branchCov" title="Branch 5 was taken 10 times"> + </span>][<span class="branchCov" title="Branch 6 was taken 25520 times"> + </span><span class="branchCov" title="Branch 7 was taken 25935 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 8 was taken 418 times"> + </span><span class="branchCov" title="Branch 9 was taken 836 times"> + </span>][<span class="branchCov" title="Branch 10 was taken 201 times"> + </span><span class="branchCov" title="Branch 11 was taken 403 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 12 was taken 4712 times"> + </span><span class="branchCov" title="Branch 13 was taken 7084 times"> + </span>][<span class="branchCov" title="Branch 14 was taken 612 times"> + </span><span class="branchCov" title="Branch 15 was taken 1220 times"> + </span>]
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 16 was not executed"> # </span><span class="branchNoExec" title="Branch 17 was not executed"> # </span>]
<a name="213"><span class="lineNum">     213 </span>                :            : }</a>
<a name="214"><span class="lineNum">     214 </span>                :            : </a>
<span class="lineNum">     215 </span>                :<span class="lineNoCov">          0 : static int zslValueLteMax(double value, zrangespec *spec) {</span>
<span class="lineNum">     216 </span>[<span class="branchCov" title="Branch 0 was taken 200 times"> + </span><span class="branchCov" title="Branch 1 was taken 392 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 8926 times"> + </span><span class="branchCov" title="Branch 3 was taken 17071 times"> + </span>]:<span class="lineCov">      85719 :     return spec-&gt;maxex ? (value &lt; spec-&gt;max) : (value &lt;= spec-&gt;max);</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 8933 times"> + </span><span class="branchCov" title="Branch 5 was taken 17098 times"> + </span>][<span class="branchCov" title="Branch 6 was taken 6275 times"> + </span><span class="branchCov" title="Branch 7 was taken 14154 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 8 was taken 13 times"> + </span><span class="branchCov" title="Branch 9 was taken 31 times"> + </span>][<span class="branchCov" title="Branch 10 was taken 15 times"> + </span><span class="branchCov" title="Branch 11 was taken 26 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 12 was taken 408 times"> + </span><span class="branchCov" title="Branch 13 was taken 804 times"> + </span>][<span class="branchCov" title="Branch 14 was taken 416 times"> + </span><span class="branchCov" title="Branch 15 was taken 818 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 16 was taken 2366 times"> + </span><span class="branchCov" title="Branch 17 was taken 4749 times"> + </span>][<span class="branchCov" title="Branch 18 was taken 403 times"> + </span><span class="branchCov" title="Branch 19 was taken 801 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 20 was taken 610 times"> + </span><span class="branchCov" title="Branch 21 was taken 1210 times"> + </span>][<span class="branchNoExec" title="Branch 22 was not executed"> # </span><span class="branchNoExec" title="Branch 23 was not executed"> # </span>]
<span class="lineNum">     217 </span>                :            : }
<span class="lineNum">     218 </span>                :            : 
<span class="lineNum">     219 </span>                :            : /* Returns if there is a part of the zset is in range. */
<span class="lineNum">     220 </span>                :<span class="lineCov">       1836 : int zslIsInRange(zskiplist *zsl, zrangespec *range) {</span>
<span class="lineNum">     221 </span>                :            :     zskiplistNode *x;
<span class="lineNum">     222 </span>                :            : 
<span class="lineNum">     223 </span>                :            :     /* Test for ranges that will always be empty. */
<span class="lineNum">     224 </span>[<span class="branchCov" title="Branch 0 was taken 1834 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchCov" title="Branch 3 was taken 1832 times"> + </span>]:<span class="lineCov">       1836 :     if (range-&gt;min &gt; range-&gt;max ||</span>
<span class="lineNum">     225 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          2 :             (range-&gt;min == range-&gt;max &amp;&amp; (range-&gt;minex || range-&gt;maxex)))</span>
<span class="lineNum">     226 </span>                :            :         return 0;
<span class="lineNum">     227 </span>                :<span class="lineCov">       1832 :     x = zsl-&gt;tail;</span>
<span class="lineNum">     228 </span>[<span class="branchCov" title="Branch 0 was taken 1832 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1820 times"> + </span><span class="branchCov" title="Branch 3 was taken 12 times"> + </span>]:<span class="lineCov">       3664 :     if (x == NULL || !zslValueGteMin(x-&gt;score,range))</span>
<span class="lineNum">     229 </span>                :            :         return 0;
<span class="lineNum">     230 </span>                :<span class="lineCov">       1820 :     x = zsl-&gt;header-&gt;level[0].forward;</span>
<span class="lineNum">     231 </span>[<span class="branchCov" title="Branch 0 was taken 1820 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1808 times"> + </span><span class="branchCov" title="Branch 3 was taken 12 times"> + </span>]:<span class="lineCov">       3640 :     if (x == NULL || !zslValueLteMax(x-&gt;score,range))</span>
<span class="lineNum">     232 </span>                :            :         return 0;
<span class="lineNum">     233 </span>                :<span class="lineCov">       1836 :     return 1;</span>
<span class="lineNum">     234 </span>                :            : }
<span class="lineNum">     235 </span>                :            : 
<span class="lineNum">     236 </span>                :            : /* Find the first node that is contained in the specified range.
<span class="lineNum">     237 </span>                :            :  * Returns NULL when no element is contained in the range. */
<span class="lineNum">     238 </span>                :<span class="lineCov">       1228 : zskiplistNode *zslFirstInRange(zskiplist *zsl, zrangespec range) {</span>
<span class="lineNum">     239 </span>                :            :     zskiplistNode *x;
<span class="lineNum">     240 </span>                :            :     int i;
<span class="lineNum">     241 </span>                :            : 
<span class="lineNum">     242 </span>                :            :     /* If everything is out of range, return early. */
<span class="lineNum">     243 </span>        [<span class="branchCov" title="Branch 1 was taken 1204 times"> + </span><span class="branchCov" title="Branch 2 was taken 24 times"> + </span>]:<span class="lineCov">       1228 :     if (!zslIsInRange(zsl,&amp;range)) return NULL;</span>
<span class="lineNum">     244 </span>                :            : 
<span class="lineNum">     245 </span>                :<span class="lineCov">       1204 :     x = zsl-&gt;header;</span>
<span class="lineNum">     246 </span>        [<span class="branchCov" title="Branch 0 was taken 7164 times"> + </span><span class="branchCov" title="Branch 1 was taken 1204 times"> + </span>]:<span class="lineCov">       8368 :     for (i = zsl-&gt;level-1; i &gt;= 0; i--) {</span>
<span class="lineNum">     247 </span>                :            :         /* Go forward while *OUT* of range. */
<span class="lineNum">     248 </span>[<span class="branchCov" title="Branch 0 was taken 11796 times"> + </span><span class="branchCov" title="Branch 1 was taken 1676 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 6308 times"> + </span><span class="branchCov" title="Branch 3 was taken 5488 times"> + </span>]:<span class="lineCov">      25268 :         while (x-&gt;level[i].forward &amp;&amp;</span>
<span class="lineNum">     249 </span>                :<span class="lineCov">      11796 :             !zslValueGteMin(x-&gt;level[i].forward-&gt;score,&amp;range))</span>
<span class="lineNum">     250 </span>                :<span class="lineCov">       6308 :                 x = x-&gt;level[i].forward;</span>
<span class="lineNum">     251 </span>                :            :     }
<span class="lineNum">     252 </span>                :            : 
<span class="lineNum">     253 </span>                :            :     /* This is an inner range, so the next node cannot be NULL. */
<span class="lineNum">     254 </span>                :<span class="lineCov">       1204 :     x = x-&gt;level[0].forward;</span>
<span class="lineNum">     255 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1204 times"> + </span>]:<span class="lineCov">       1204 :     redisAssert(x != NULL);</span>
<span class="lineNum">     256 </span>                :            : 
<span class="lineNum">     257 </span>                :            :     /* Check if score &lt;= max. */
<span class="lineNum">     258 </span>        [<span class="branchCov" title="Branch 0 was taken 1192 times"> + </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>]:<span class="lineCov">       1204 :     if (!zslValueLteMax(x-&gt;score,&amp;range)) return NULL;</span>
<span class="lineNum">     259 </span>                :<span class="lineCov">       1228 :     return x;</span>
<span class="lineNum">     260 </span>                :            : }
<span class="lineNum">     261 </span>                :            : 
<span class="lineNum">     262 </span>                :            : /* Find the last node that is contained in the specified range.
<span class="lineNum">     263 </span>                :            :  * Returns NULL when no element is contained in the range. */
<span class="lineNum">     264 </span>                :<span class="lineCov">        608 : zskiplistNode *zslLastInRange(zskiplist *zsl, zrangespec range) {</span>
<span class="lineNum">     265 </span>                :            :     zskiplistNode *x;
<span class="lineNum">     266 </span>                :            :     int i;
<span class="lineNum">     267 </span>                :            : 
<span class="lineNum">     268 </span>                :            :     /* If everything is out of range, return early. */
<span class="lineNum">     269 </span>        [<span class="branchCov" title="Branch 1 was taken 604 times"> + </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span>]:<span class="lineCov">        608 :     if (!zslIsInRange(zsl,&amp;range)) return NULL;</span>
<span class="lineNum">     270 </span>                :            : 
<span class="lineNum">     271 </span>                :<span class="lineCov">        604 :     x = zsl-&gt;header;</span>
<span class="lineNum">     272 </span>        [<span class="branchCov" title="Branch 0 was taken 3584 times"> + </span><span class="branchCov" title="Branch 1 was taken 604 times"> + </span>]:<span class="lineCov">       4188 :     for (i = zsl-&gt;level-1; i &gt;= 0; i--) {</span>
<span class="lineNum">     273 </span>                :            :         /* Go forward while *IN* range. */
<span class="lineNum">     274 </span>[<span class="branchCov" title="Branch 0 was taken 7115 times"> + </span><span class="branchCov" title="Branch 1 was taken 2036 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 5567 times"> + </span><span class="branchCov" title="Branch 3 was taken 1548 times"> + </span>]:<span class="lineCov">      16266 :         while (x-&gt;level[i].forward &amp;&amp;</span>
<span class="lineNum">     275 </span>                :<span class="lineCov">       7115 :             zslValueLteMax(x-&gt;level[i].forward-&gt;score,&amp;range))</span>
<span class="lineNum">     276 </span>                :<span class="lineCov">       5567 :                 x = x-&gt;level[i].forward;</span>
<span class="lineNum">     277 </span>                :            :     }
<span class="lineNum">     278 </span>                :            : 
<span class="lineNum">     279 </span>                :            :     /* This is an inner range, so this node cannot be NULL. */
<span class="lineNum">     280 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 604 times"> + </span>]:<span class="lineCov">        604 :     redisAssert(x != NULL);</span>
<span class="lineNum">     281 </span>                :            : 
<span class="lineNum">     282 </span>                :            :     /* Check if score &gt;= min. */
<span class="lineNum">     283 </span>        [<span class="branchCov" title="Branch 0 was taken 604 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        604 :     if (!zslValueGteMin(x-&gt;score,&amp;range)) return NULL;</span>
<span class="lineNum">     284 </span>                :<span class="lineCov">        608 :     return x;</span>
<span class="lineNum">     285 </span>                :            : }
<span class="lineNum">     286 </span>                :            : 
<span class="lineNum">     287 </span>                :            : /* Delete all the elements with score between min and max from the skiplist.
<span class="lineNum">     288 </span>                :            :  * Min and max are inclusive, so a score &gt;= min || score &lt;= max is deleted.
<a name="289"><span class="lineNum">     289 </span>                :            :  * Note that this function takes the reference to the hash table view of the</a>
<span class="lineNum">     290 </span>                :            :  * sorted set, in order to remove the elements from the hash table too. */
<span class="lineNum">     291 </span>                :<span class="lineCov">         13 : unsigned long zslDeleteRangeByScore(zskiplist *zsl, zrangespec range, dict *dict) {</span>
<span class="lineNum">     292 </span>                :            :     zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;
<span class="lineNum">     293 </span>                :<span class="lineCov">         13 :     unsigned long removed = 0;</span>
<span class="lineNum">     294 </span>                :            :     int i;
<span class="lineNum">     295 </span>                :            : 
<span class="lineNum">     296 </span>                :<span class="lineCov">         13 :     x = zsl-&gt;header;</span>
<span class="lineNum">     297 </span>        [<span class="branchCov" title="Branch 0 was taken 30 times"> + </span><span class="branchCov" title="Branch 1 was taken 13 times"> + </span>]:<span class="lineCov">         43 :     for (i = zsl-&gt;level-1; i &gt;= 0; i--) {</span>
<span class="lineNum">     298 </span>[<span class="branchCov" title="Branch 0 was taken 37 times"> + </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 10 times"> + </span><span class="branchCov" title="Branch 3 was taken 27 times"> + </span>]:<span class="lineCov">         42 :         while (x-&gt;level[i].forward &amp;&amp; (range.minex ?</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 4 times"> + </span><span class="branchCov" title="Branch 5 was taken 6 times"> + </span>][<span class="branchCov" title="Branch 6 was taken 8 times"> + </span><span class="branchCov" title="Branch 7 was taken 19 times"> + </span>]
<span class="lineNum">     299 </span>                :<span class="lineCov">         10 :             x-&gt;level[i].forward-&gt;score &lt;= range.min :</span>
<span class="lineNum">     300 </span>                :<span class="lineCov">         27 :             x-&gt;level[i].forward-&gt;score &lt; range.min))</span>
<span class="lineNum">     301 </span>                :<span class="lineCov">         12 :                 x = x-&gt;level[i].forward;</span>
<span class="lineNum">     302 </span>                :<span class="lineCov">         30 :         update[i] = x;</span>
<span class="lineNum">     303 </span>                :            :     }
<span class="lineNum">     304 </span>                :            : 
<span class="lineNum">     305 </span>                :            :     /* Current node is the last with score &lt; or &lt;= min. */
<span class="lineNum">     306 </span>                :<span class="lineCov">         13 :     x = x-&gt;level[0].forward;</span>
<span class="lineNum">     307 </span>                :            : 
<span class="lineNum">     308 </span>                :            :     /* Delete nodes while in range. */
<span class="lineNum">     309 </span>[<span class="branchCov" title="Branch 0 was taken 45 times"> + </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 13 times"> + </span><span class="branchCov" title="Branch 3 was taken 32 times"> + </span>]:<span class="lineCov">         51 :     while (x &amp;&amp; (range.maxex ? x-&gt;score &lt; range.max : x-&gt;score &lt;= range.max)) {</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 10 times"> + </span><span class="branchCov" title="Branch 5 was taken 3 times"> + </span>][<span class="branchCov" title="Branch 6 was taken 28 times"> + </span><span class="branchCov" title="Branch 7 was taken 4 times"> + </span>]
<span class="lineNum">     310 </span>                :<span class="lineCov">         38 :         zskiplistNode *next = x-&gt;level[0].forward;</span>
<span class="lineNum">     311 </span>                :<span class="lineCov">         38 :         zslDeleteNode(zsl,x,update);</span>
<span class="lineNum">     312 </span>                :<span class="lineCov">         38 :         dictDelete(dict,x-&gt;obj);</span>
<span class="lineNum">     313 </span>                :<span class="lineCov">         38 :         zslFreeNode(x);</span>
<span class="lineNum">     314 </span>                :<span class="lineCov">         38 :         removed++;</span>
<span class="lineNum">     315 </span>                :<span class="lineCov">         38 :         x = next;</span>
<span class="lineNum">     316 </span>                :            :     }
<span class="lineNum">     317 </span>                :<span class="lineCov">         13 :     return removed;</span>
<span class="lineNum">     318 </span>                :            : }
<span class="lineNum">     319 </span>                :            : 
<a name="320"><span class="lineNum">     320 </span>                :            : /* Delete all the elements with rank between start and end from the skiplist.</a>
<span class="lineNum">     321 </span>                :            :  * Start and end are inclusive. Note that start and end need to be 1-based */
<span class="lineNum">     322 </span>                :<span class="lineCov">          4 : unsigned long zslDeleteRangeByRank(zskiplist *zsl, unsigned int start, unsigned int end, dict *dict) {</span>
<span class="lineNum">     323 </span>                :            :     zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;
<span class="lineNum">     324 </span>                :<span class="lineCov">          4 :     unsigned long traversed = 0, removed = 0;</span>
<span class="lineNum">     325 </span>                :            :     int i;
<span class="lineNum">     326 </span>                :            : 
<span class="lineNum">     327 </span>                :<span class="lineCov">          4 :     x = zsl-&gt;header;</span>
<span class="lineNum">     328 </span>        [<span class="branchCov" title="Branch 0 was taken 10 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">         14 :     for (i = zsl-&gt;level-1; i &gt;= 0; i--) {</span>
<span class="lineNum">     329 </span>[<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchCov" title="Branch 3 was taken 10 times"> + </span>]:<span class="lineCov">         11 :         while (x-&gt;level[i].forward &amp;&amp; (traversed + x-&gt;level[i].span) &lt; start) {</span>
<span class="lineNum">     330 </span>                :<span class="lineCov">          1 :             traversed += x-&gt;level[i].span;</span>
<span class="lineNum">     331 </span>                :<span class="lineCov">          1 :             x = x-&gt;level[i].forward;</span>
<span class="lineNum">     332 </span>                :            :         }
<span class="lineNum">     333 </span>                :<span class="lineCov">         10 :         update[i] = x;</span>
<span class="lineNum">     334 </span>                :            :     }
<span class="lineNum">     335 </span>                :            : 
<span class="lineNum">     336 </span>                :<span class="lineCov">          4 :     traversed++;</span>
<span class="lineNum">     337 </span>                :<span class="lineCov">          4 :     x = x-&gt;level[0].forward;</span>
<span class="lineNum">     338 </span>[<span class="branchCov" title="Branch 0 was taken 16 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 14 times"> + </span><span class="branchCov" title="Branch 3 was taken 2 times"> + </span>]:<span class="lineCov">         18 :     while (x &amp;&amp; traversed &lt;= end) {</span>
<span class="lineNum">     339 </span>                :<span class="lineCov">         14 :         zskiplistNode *next = x-&gt;level[0].forward;</span>
<span class="lineNum">     340 </span>                :<span class="lineCov">         14 :         zslDeleteNode(zsl,x,update);</span>
<span class="lineNum">     341 </span>                :<span class="lineCov">         14 :         dictDelete(dict,x-&gt;obj);</span>
<span class="lineNum">     342 </span>                :<span class="lineCov">         14 :         zslFreeNode(x);</span>
<span class="lineNum">     343 </span>                :<span class="lineCov">         14 :         removed++;</span>
<span class="lineNum">     344 </span>                :<span class="lineCov">         14 :         traversed++;</span>
<span class="lineNum">     345 </span>                :<span class="lineCov">         14 :         x = next;</span>
<span class="lineNum">     346 </span>                :            :     }
<span class="lineNum">     347 </span>                :<span class="lineCov">          4 :     return removed;</span>
<span class="lineNum">     348 </span>                :            : }
<span class="lineNum">     349 </span>                :            : 
<span class="lineNum">     350 </span>                :            : /* Find the rank for an element by both score and key.
<span class="lineNum">     351 </span>                :            :  * Returns 0 when the element cannot be found, rank otherwise.
<a name="352"><span class="lineNum">     352 </span>                :            :  * Note that the rank is 1-based due to the span of zsl-&gt;header to the</a>
<span class="lineNum">     353 </span>                :            :  * first element. */
<span class="lineNum">     354 </span>                :<span class="lineCov">       3187 : unsigned long zslGetRank(zskiplist *zsl, double score, robj *o) {</span>
<span class="lineNum">     355 </span>                :            :     zskiplistNode *x;
<span class="lineNum">     356 </span>                :<span class="lineCov">       3187 :     unsigned long rank = 0;</span>
<span class="lineNum">     357 </span>                :            :     int i;
<span class="lineNum">     358 </span>                :            : 
<span class="lineNum">     359 </span>                :<span class="lineCov">       3187 :     x = zsl-&gt;header;</span>
<span class="lineNum">     360 </span>        [<span class="branchCov" title="Branch 0 was taken 13832 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      17019 :     for (i = zsl-&gt;level-1; i &gt;= 0; i--) {</span>
<span class="lineNum">     361 </span>[<span class="branchCov" title="Branch 0 was taken 33370 times"> + </span><span class="branchCov" title="Branch 1 was taken 4134 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 20485 times"> + </span><span class="branchCov" title="Branch 3 was taken 12885 times"> + </span>]:<span class="lineCov">      37504 :         while (x-&gt;level[i].forward &amp;&amp;</span>
<span class="lineNum">     362 </span>        [<span class="branchCov" title="Branch 0 was taken 3187 times"> + </span><span class="branchCov" title="Branch 1 was taken 9698 times"> + </span>]:<span class="lineCov">      12885 :             (x-&gt;level[i].forward-&gt;score &lt; score ||</span>
<span class="lineNum">     363 </span>        [<span class="branchCov" title="Branch 0 was taken 3187 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       3187 :                 (x-&gt;level[i].forward-&gt;score == score &amp;&amp;</span>
<span class="lineNum">     364 </span>                :<span class="lineCov">       3187 :                 compareStringObjects(x-&gt;level[i].forward-&gt;obj,o) &lt;= 0))) {</span>
<span class="lineNum">     365 </span>                :<span class="lineCov">      23672 :             rank += x-&gt;level[i].span;</span>
<span class="lineNum">     366 </span>                :<span class="lineCov">      23672 :             x = x-&gt;level[i].forward;</span>
<span class="lineNum">     367 </span>                :            :         }
<span class="lineNum">     368 </span>                :            : 
<span class="lineNum">     369 </span>                :            :         /* x might be equal to zsl-&gt;header, so test if obj is non-NULL */
<span class="lineNum">     370 </span>[<span class="branchCov" title="Branch 0 was taken 11429 times"> + </span><span class="branchCov" title="Branch 1 was taken 2403 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 8242 times"> + </span><span class="branchCov" title="Branch 4 was taken 3187 times"> + </span>]:<span class="lineCov">      13832 :         if (x-&gt;obj &amp;&amp; equalStringObjects(x-&gt;obj,o)) {</span>
<span class="lineNum">     371 </span>                :            :             return rank;
<span class="lineNum">     372 </span>                :            :         }
<span class="lineNum">     373 </span>                :            :     }
<span class="lineNum">     374 </span>                :            :     return 0;
<span class="lineNum">     375 </span>                :            : }
<a name="376"><span class="lineNum">     376 </span>                :            : </a>
<span class="lineNum">     377 </span>                :            : /* Finds an element by its rank. The rank argument needs to be 1-based. */
<span class="lineNum">     378 </span>                :<span class="lineCov">       1975 : zskiplistNode* zslGetElementByRank(zskiplist *zsl, unsigned long rank) {</span>
<span class="lineNum">     379 </span>                :            :     zskiplistNode *x;
<span class="lineNum">     380 </span>                :<span class="lineCov">       1975 :     unsigned long traversed = 0;</span>
<span class="lineNum">     381 </span>                :            :     int i;
<span class="lineNum">     382 </span>                :            : 
<span class="lineNum">     383 </span>                :<span class="lineCov">       1975 :     x = zsl-&gt;header;</span>
<span class="lineNum">     384 </span>        [<span class="branchCov" title="Branch 0 was taken 6944 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       8919 :     for (i = zsl-&gt;level-1; i &gt;= 0; i--) {</span>
<span class="lineNum">     385 </span>[<span class="branchCov" title="Branch 0 was taken 20409 times"> + </span><span class="branchCov" title="Branch 1 was taken 1270 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 14735 times"> + </span><span class="branchCov" title="Branch 3 was taken 5674 times"> + </span>]:<span class="lineCov">      21679 :         while (x-&gt;level[i].forward &amp;&amp; (traversed + x-&gt;level[i].span) &lt;= rank)</span>
<span class="lineNum">     386 </span>                :            :         {
<span class="lineNum">     387 </span>                :<span class="lineCov">      14735 :             traversed += x-&gt;level[i].span;</span>
<span class="lineNum">     388 </span>                :<span class="lineCov">      14735 :             x = x-&gt;level[i].forward;</span>
<span class="lineNum">     389 </span>                :            :         }
<span class="lineNum">     390 </span>        [<span class="branchCov" title="Branch 0 was taken 4969 times"> + </span><span class="branchCov" title="Branch 1 was taken 1975 times"> + </span>]:<span class="lineCov">       6944 :         if (traversed == rank) {</span>
<span class="lineNum">     391 </span>                :            :             return x;
<span class="lineNum">     392 </span>                :            :         }
<span class="lineNum">     393 </span>                :            :     }
<span class="lineNum">     394 </span>                :            :     return NULL;
<span class="lineNum">     395 </span>                :            : }
<a name="396"><span class="lineNum">     396 </span>                :            : </a>
<span class="lineNum">     397 </span>                :            : /* Populate the rangespec according to the objects min and max. */
<span class="lineNum">     398 </span>                :<span class="lineCov">       2530 : static int zslParseRange(robj *min, robj *max, zrangespec *spec) {</span>
<span class="lineNum">     399 </span>                :            :     char *eptr;
<span class="lineNum">     400 </span>                :<span class="lineCov">       2530 :     spec-&gt;minex = spec-&gt;maxex = 0;</span>
<span class="lineNum">     401 </span>                :            : 
<span class="lineNum">     402 </span>                :            :     /* Parse the min-max interval. If one of the values is prefixed
<span class="lineNum">     403 </span>                :            :      * by the &quot;(&quot; character, it's considered &quot;open&quot;. For instance
<span class="lineNum">     404 </span>                :            :      * ZRANGEBYSCORE zset (1.5 (2.5 will match min &lt; x &lt; max
<span class="lineNum">     405 </span>                :            :      * ZRANGEBYSCORE zset 1.5 2.5 will instead match min &lt;= x &lt;= max */
<span class="lineNum">     406 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2530 times"> + </span>]:<span class="lineCov">       2530 :     if (min-&gt;encoding == REDIS_ENCODING_INT) {</span>
<span class="lineNum">     407 </span>                :<span class="lineNoCov">          0 :         spec-&gt;min = (long)min-&gt;ptr;</span>
<span class="lineNum">     408 </span>                :            :     } else {
<span class="lineNum">     409 </span>        [<span class="branchCov" title="Branch 0 was taken 840 times"> + </span><span class="branchCov" title="Branch 1 was taken 1690 times"> + </span>]:<span class="lineCov">       2530 :         if (((char*)min-&gt;ptr)[0] == '(') {</span>
<span class="lineNum">     410 </span>                :<span class="lineCov">        840 :             spec-&gt;min = strtod((char*)min-&gt;ptr+1,&amp;eptr);</span>
<span class="lineNum">     411 </span>[<span class="branchCov" title="Branch 0 was taken 840 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 840 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">        840 :             if (eptr[0] != '\0' || isnan(spec-&gt;min)) return REDIS_ERR;</span>
<span class="lineNum">     412 </span>                :<span class="lineCov">        840 :             spec-&gt;minex = 1;</span>
<span class="lineNum">     413 </span>                :            :         } else {
<span class="lineNum">     414 </span>                :<span class="lineCov">       1690 :             spec-&gt;min = strtod((char*)min-&gt;ptr,&amp;eptr);</span>
<span class="lineNum">     415 </span>[<span class="branchCov" title="Branch 0 was taken 1686 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 1686 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       1690 :             if (eptr[0] != '\0' || isnan(spec-&gt;min)) return REDIS_ERR;</span>
<span class="lineNum">     416 </span>                :            :         }
<span class="lineNum">     417 </span>                :            :     }
<span class="lineNum">     418 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2526 times"> + </span>]:<span class="lineCov">       2526 :     if (max-&gt;encoding == REDIS_ENCODING_INT) {</span>
<span class="lineNum">     419 </span>                :<span class="lineNoCov">          0 :         spec-&gt;max = (long)max-&gt;ptr;</span>
<span class="lineNum">     420 </span>                :            :     } else {
<span class="lineNum">     421 </span>        [<span class="branchCov" title="Branch 0 was taken 840 times"> + </span><span class="branchCov" title="Branch 1 was taken 1686 times"> + </span>]:<span class="lineCov">       2526 :         if (((char*)max-&gt;ptr)[0] == '(') {</span>
<span class="lineNum">     422 </span>                :<span class="lineCov">        840 :             spec-&gt;max = strtod((char*)max-&gt;ptr+1,&amp;eptr);</span>
<span class="lineNum">     423 </span>[<span class="branchCov" title="Branch 0 was taken 840 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 840 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">        840 :             if (eptr[0] != '\0' || isnan(spec-&gt;max)) return REDIS_ERR;</span>
<span class="lineNum">     424 </span>                :<span class="lineCov">        840 :             spec-&gt;maxex = 1;</span>
<span class="lineNum">     425 </span>                :            :         } else {
<span class="lineNum">     426 </span>                :<span class="lineCov">       1686 :             spec-&gt;max = strtod((char*)max-&gt;ptr,&amp;eptr);</span>
<span class="lineNum">     427 </span>[<span class="branchCov" title="Branch 0 was taken 1682 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 1678 times"> + </span><span class="branchCov" title="Branch 4 was taken 4 times"> + </span>]:<span class="lineCov">       1686 :             if (eptr[0] != '\0' || isnan(spec-&gt;max)) return REDIS_ERR;</span>
<span class="lineNum">     428 </span>                :            :         }
<span class="lineNum">     429 </span>                :            :     }
<span class="lineNum">     430 </span>                :            : 
<span class="lineNum">     431 </span>                :<span class="lineCov">       2530 :     return REDIS_OK;</span>
<span class="lineNum">     432 </span>                :            : }
<span class="lineNum">     433 </span>                :            : 
<span class="lineNum">     434 </span>                :            : /*-----------------------------------------------------------------------------
<span class="lineNum">     435 </span>                :            :  * Ziplist-backed sorted set API
<a name="436"><span class="lineNum">     436 </span>                :            :  *----------------------------------------------------------------------------*/</a>
<span class="lineNum">     437 </span>                :            : 
<span class="lineNum">     438 </span>                :<span class="lineCov">     482092 : double zzlGetScore(unsigned char *sptr) {</span>
<span class="lineNum">     439 </span>                :            :     unsigned char *vstr;
<span class="lineNum">     440 </span>                :            :     unsigned int vlen;
<span class="lineNum">     441 </span>                :            :     long long vlong;
<span class="lineNum">     442 </span>                :            :     char buf[128];
<span class="lineNum">     443 </span>                :            :     double score;
<span class="lineNum">     444 </span>                :            : 
<span class="lineNum">     445 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 482092 times"> + </span>]:<span class="lineCov">     482092 :     redisAssert(sptr != NULL);</span>
<span class="lineNum">     446 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 482092 times"> + </span>]:<span class="lineCov">     482092 :     redisAssert(ziplistGet(sptr,&amp;vstr,&amp;vlen,&amp;vlong));</span>
<span class="lineNum">     447 </span>                :            : 
<span class="lineNum">     448 </span>        [<span class="branchCov" title="Branch 0 was taken 472168 times"> + </span><span class="branchCov" title="Branch 1 was taken 9924 times"> + </span>]:<span class="lineCov">     482092 :     if (vstr) {</span>
<span class="lineNum">     449 </span>                :<span class="lineCov">     472168 :         memcpy(buf,vstr,vlen);</span>
<span class="lineNum">     450 </span>                :<span class="lineCov">     472168 :         buf[vlen] = '\0';</span>
<span class="lineNum">     451 </span>                :<span class="lineCov">     472168 :         score = strtod(buf,NULL);</span>
<span class="lineNum">     452 </span>                :            :     } else {
<span class="lineNum">     453 </span>                :<span class="lineCov">       9924 :         score = vlong;</span>
<span class="lineNum">     454 </span>                :            :     }
<span class="lineNum">     455 </span>                :            : 
<span class="lineNum">     456 </span>                :<span class="lineCov">     482092 :     return score;</span>
<span class="lineNum">     457 </span>                :            : }
<a name="458"><span class="lineNum">     458 </span>                :            : </a>
<span class="lineNum">     459 </span>                :            : /* Compare element in sorted set with given element. */
<span class="lineNum">     460 </span>                :<span class="lineCov">        847 : int zzlCompareElements(unsigned char *eptr, unsigned char *cstr, unsigned int clen) {</span>
<span class="lineNum">     461 </span>                :            :     unsigned char *vstr;
<span class="lineNum">     462 </span>                :            :     unsigned int vlen;
<span class="lineNum">     463 </span>                :            :     long long vlong;
<span class="lineNum">     464 </span>                :            :     unsigned char vbuf[32];
<span class="lineNum">     465 </span>                :            :     int minlen, cmp;
<span class="lineNum">     466 </span>                :            : 
<span class="lineNum">     467 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 847 times"> + </span>]:<span class="lineCov">        847 :     redisAssert(ziplistGet(eptr,&amp;vstr,&amp;vlen,&amp;vlong));</span>
<span class="lineNum">     468 </span>        [<span class="branchCov" title="Branch 0 was taken 847 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        847 :     if (vstr == NULL) {</span>
<span class="lineNum">     469 </span>                :            :         /* Store string representation of long long in buf. */
<span class="lineNum">     470 </span>                :<span class="lineCov">        847 :         vlen = ll2string((char*)vbuf,sizeof(vbuf),vlong);</span>
<span class="lineNum">     471 </span>                :<span class="lineCov">        847 :         vstr = vbuf;</span>
<span class="lineNum">     472 </span>                :            :     }
<span class="lineNum">     473 </span>                :            : 
<span class="lineNum">     474 </span>                :<span class="lineCov">        847 :     minlen = (vlen &lt; clen) ? vlen : clen;</span>
<span class="lineNum">     475 </span>                :<span class="lineCov">        847 :     cmp = memcmp(vstr,cstr,minlen);</span>
<span class="lineNum">     476 </span>        [<span class="branchCov" title="Branch 0 was taken 21 times"> + </span><span class="branchCov" title="Branch 1 was taken 826 times"> + </span>]:<span class="lineCov">        847 :     if (cmp == 0) return vlen-clen;</span>
<span class="lineNum">     477 </span>                :            :     return cmp;
<a name="478"><span class="lineNum">     478 </span>                :            : }</a>
<span class="lineNum">     479 </span>                :            : 
<span class="lineNum">     480 </span>                :<span class="lineCov">     144141 : unsigned int zzlLength(unsigned char *zl) {</span>
<span class="lineNum">     481 </span>                :<span class="lineCov">     144141 :     return ziplistLen(zl)/2;</span>
<span class="lineNum">     482 </span>                :            : }
<span class="lineNum">     483 </span>                :            : 
<a name="484"><span class="lineNum">     484 </span>                :            : /* Move to next entry based on the values in eptr and sptr. Both are set to</a>
<span class="lineNum">     485 </span>                :            :  * NULL when there is no next entry. */
<span class="lineNum">     486 </span>                :<span class="lineCov">     295367 : void zzlNext(unsigned char *zl, unsigned char **eptr, unsigned char **sptr) {</span>
<span class="lineNum">     487 </span>                :            :     unsigned char *_eptr, *_sptr;
<span class="lineNum">     488 </span>[<span class="branchCov" title="Branch 0 was taken 295367 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 295367 times"> + </span>]:<span class="lineCov">     295367 :     redisAssert(*eptr != NULL &amp;&amp; *sptr != NULL);</span>
<span class="lineNum">     489 </span>                :            : 
<span class="lineNum">     490 </span>                :<span class="lineCov">     295367 :     _eptr = ziplistNext(zl,*sptr);</span>
<span class="lineNum">     491 </span>        [<span class="branchCov" title="Branch 0 was taken 181580 times"> + </span><span class="branchCov" title="Branch 1 was taken 113787 times"> + </span>]:<span class="lineCov">     295367 :     if (_eptr != NULL) {</span>
<span class="lineNum">     492 </span>                :<span class="lineCov">     181580 :         _sptr = ziplistNext(zl,_eptr);</span>
<span class="lineNum">     493 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 181580 times"> + </span>]:<span class="lineCov">     181580 :         redisAssert(_sptr != NULL);</span>
<span class="lineNum">     494 </span>                :            :     } else {
<span class="lineNum">     495 </span>                :            :         /* No next entry. */
<span class="lineNum">     496 </span>                :            :         _sptr = NULL;
<span class="lineNum">     497 </span>                :            :     }
<span class="lineNum">     498 </span>                :            : 
<span class="lineNum">     499 </span>                :<span class="lineCov">     295367 :     *eptr = _eptr;</span>
<span class="lineNum">     500 </span>                :<span class="lineCov">     295367 :     *sptr = _sptr;</span>
<span class="lineNum">     501 </span>                :<span class="lineCov">     295367 : }</span>
<span class="lineNum">     502 </span>                :            : 
<a name="503"><span class="lineNum">     503 </span>                :            : /* Move to the previous entry based on the values in eptr and sptr. Both are</a>
<span class="lineNum">     504 </span>                :            :  * set to NULL when there is no next entry. */
<span class="lineNum">     505 </span>                :<span class="lineCov">        309 : void zzlPrev(unsigned char *zl, unsigned char **eptr, unsigned char **sptr) {</span>
<span class="lineNum">     506 </span>                :            :     unsigned char *_eptr, *_sptr;
<span class="lineNum">     507 </span>[<span class="branchCov" title="Branch 0 was taken 309 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 309 times"> + </span>]:<span class="lineCov">        309 :     redisAssert(*eptr != NULL &amp;&amp; *sptr != NULL);</span>
<span class="lineNum">     508 </span>                :            : 
<span class="lineNum">     509 </span>                :<span class="lineCov">        309 :     _sptr = ziplistPrev(zl,*eptr);</span>
<span class="lineNum">     510 </span>        [<span class="branchCov" title="Branch 0 was taken 300 times"> + </span><span class="branchCov" title="Branch 1 was taken 9 times"> + </span>]:<span class="lineCov">        309 :     if (_sptr != NULL) {</span>
<span class="lineNum">     511 </span>                :<span class="lineCov">        300 :         _eptr = ziplistPrev(zl,_sptr);</span>
<span class="lineNum">     512 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 300 times"> + </span>]:<span class="lineCov">        300 :         redisAssert(_eptr != NULL);</span>
<span class="lineNum">     513 </span>                :            :     } else {
<span class="lineNum">     514 </span>                :            :         /* No previous entry. */
<span class="lineNum">     515 </span>                :            :         _eptr = NULL;
<span class="lineNum">     516 </span>                :            :     }
<span class="lineNum">     517 </span>                :            : 
<span class="lineNum">     518 </span>                :<span class="lineCov">        309 :     *eptr = _eptr;</span>
<span class="lineNum">     519 </span>                :<span class="lineCov">        309 :     *sptr = _sptr;</span>
<span class="lineNum">     520 </span>                :<span class="lineCov">        309 : }</span>
<span class="lineNum">     521 </span>                :            : 
<span class="lineNum">     522 </span>                :            : /* Returns if there is a part of the zset is in range. Should only be used
<span class="lineNum">     523 </span>                :            :  * internally by zzlFirstInRange and zzlLastInRange. */
<span class="lineNum">     524 </span>                :<span class="lineCov">       1259 : int zzlIsInRange(unsigned char *zl, zrangespec *range) {</span>
<span class="lineNum">     525 </span>                :            :     unsigned char *p;
<span class="lineNum">     526 </span>                :            :     double score;
<span class="lineNum">     527 </span>                :            : 
<span class="lineNum">     528 </span>                :            :     /* Test for ranges that will always be empty. */
<span class="lineNum">     529 </span>[<span class="branchCov" title="Branch 0 was taken 1256 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchCov" title="Branch 3 was taken 1254 times"> + </span>]:<span class="lineCov">       1259 :     if (range-&gt;min &gt; range-&gt;max ||</span>
<span class="lineNum">     530 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          2 :             (range-&gt;min == range-&gt;max &amp;&amp; (range-&gt;minex || range-&gt;maxex)))</span>
<span class="lineNum">     531 </span>                :            :         return 0;
<span class="lineNum">     532 </span>                :            : 
<span class="lineNum">     533 </span>                :<span class="lineCov">       1254 :     p = ziplistIndex(zl,-1); /* Last score. */</span>
<span class="lineNum">     534 </span>        [<span class="branchCov" title="Branch 0 was taken 1254 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1254 :     if (p == NULL) return 0; /* Empty sorted set */</span>
<span class="lineNum">     535 </span>                :<span class="lineCov">       1254 :     score = zzlGetScore(p);</span>
<span class="lineNum">     536 </span>        [<span class="branchCov" title="Branch 0 was taken 1234 times"> + </span><span class="branchCov" title="Branch 1 was taken 20 times"> + </span>]:<span class="lineCov">       1254 :     if (!zslValueGteMin(score,range))</span>
<span class="lineNum">     537 </span>                :            :         return 0;
<span class="lineNum">     538 </span>                :            : 
<span class="lineNum">     539 </span>                :<span class="lineCov">       1234 :     p = ziplistIndex(zl,1); /* First score. */</span>
<span class="lineNum">     540 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1234 times"> + </span>]:<span class="lineCov">       1234 :     redisAssert(p != NULL);</span>
<span class="lineNum">     541 </span>                :<span class="lineCov">       1234 :     score = zzlGetScore(p);</span>
<span class="lineNum">     542 </span>        [<span class="branchCov" title="Branch 0 was taken 1226 times"> + </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>]:<span class="lineCov">       1234 :     if (!zslValueLteMax(score,range))</span>
<span class="lineNum">     543 </span>                :            :         return 0;
<span class="lineNum">     544 </span>                :            : 
<span class="lineNum">     545 </span>                :<span class="lineCov">       1259 :     return 1;</span>
<span class="lineNum">     546 </span>                :            : }
<span class="lineNum">     547 </span>                :            : 
<span class="lineNum">     548 </span>                :            : /* Find pointer to the first element contained in the specified range.
<span class="lineNum">     549 </span>                :            :  * Returns NULL when no element is contained in the range. */
<span class="lineNum">     550 </span>                :<span class="lineCov">       1241 : unsigned char *zzlFirstInRange(unsigned char *zl, zrangespec range) {</span>
<span class="lineNum">     551 </span>                :<span class="lineCov">       1241 :     unsigned char *eptr = ziplistIndex(zl,0), *sptr;</span>
<span class="lineNum">     552 </span>                :            :     double score;
<span class="lineNum">     553 </span>                :            : 
<span class="lineNum">     554 </span>                :            :     /* If everything is out of range, return early. */
<span class="lineNum">     555 </span>        [<span class="branchCov" title="Branch 1 was taken 1212 times"> + </span><span class="branchCov" title="Branch 2 was taken 29 times"> + </span>]:<span class="lineCov">       1241 :     if (!zzlIsInRange(zl,&amp;range)) return NULL;</span>
<span class="lineNum">     556 </span>                :            : 
<span class="lineNum">     557 </span>        [<span class="branchCov" title="Branch 0 was taken 51455 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      52696 :     while (eptr != NULL) {</span>
<span class="lineNum">     558 </span>                :<span class="lineCov">      51455 :         sptr = ziplistNext(zl,eptr);</span>
<span class="lineNum">     559 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 51455 times"> + </span>]:<span class="lineCov">      51455 :         redisAssert(sptr != NULL);</span>
<span class="lineNum">     560 </span>                :            : 
<span class="lineNum">     561 </span>                :<span class="lineCov">      51455 :         score = zzlGetScore(sptr);</span>
<span class="lineNum">     562 </span>        [<span class="branchCov" title="Branch 0 was taken 1212 times"> + </span><span class="branchCov" title="Branch 1 was taken 50243 times"> + </span>]:<span class="lineCov">      51455 :         if (zslValueGteMin(score,&amp;range)) {</span>
<span class="lineNum">     563 </span>                :            :             /* Check if score &lt;= max. */
<span class="lineNum">     564 </span>        [<span class="branchCov" title="Branch 0 was taken 1208 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">       1212 :             if (zslValueLteMax(score,&amp;range))</span>
<span class="lineNum">     565 </span>                :<span class="lineCov">       1208 :                 return eptr;</span>
<span class="lineNum">     566 </span>                :            :             return NULL;
<span class="lineNum">     567 </span>                :            :         }
<span class="lineNum">     568 </span>                :            : 
<span class="lineNum">     569 </span>                :            :         /* Move to next element. */
<span class="lineNum">     570 </span>                :<span class="lineCov">      50243 :         eptr = ziplistNext(zl,sptr);</span>
<span class="lineNum">     571 </span>                :            :     }
<span class="lineNum">     572 </span>                :            : 
<span class="lineNum">     573 </span>                :            :     return NULL;
<span class="lineNum">     574 </span>                :            : }
<span class="lineNum">     575 </span>                :            : 
<span class="lineNum">     576 </span>                :            : /* Find pointer to the last element contained in the specified range.
<span class="lineNum">     577 </span>                :            :  * Returns NULL when no element is contained in the range. */
<span class="lineNum">     578 </span>                :<span class="lineCov">         18 : unsigned char *zzlLastInRange(unsigned char *zl, zrangespec range) {</span>
<span class="lineNum">     579 </span>                :<span class="lineCov">         18 :     unsigned char *eptr = ziplistIndex(zl,-2), *sptr;</span>
<span class="lineNum">     580 </span>                :            :     double score;
<span class="lineNum">     581 </span>                :            : 
<span class="lineNum">     582 </span>                :            :     /* If everything is out of range, return early. */
<span class="lineNum">     583 </span>        [<span class="branchCov" title="Branch 1 was taken 14 times"> + </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span>]:<span class="lineCov">         18 :     if (!zzlIsInRange(zl,&amp;range)) return NULL;</span>
<span class="lineNum">     584 </span>                :            : 
<span class="lineNum">     585 </span>        [<span class="branchCov" title="Branch 0 was taken 41 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         59 :     while (eptr != NULL) {</span>
<span class="lineNum">     586 </span>                :<span class="lineCov">         41 :         sptr = ziplistNext(zl,eptr);</span>
<span class="lineNum">     587 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 41 times"> + </span>]:<span class="lineCov">         41 :         redisAssert(sptr != NULL);</span>
<span class="lineNum">     588 </span>                :            : 
<span class="lineNum">     589 </span>                :<span class="lineCov">         41 :         score = zzlGetScore(sptr);</span>
<span class="lineNum">     590 </span>        [<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchCov" title="Branch 1 was taken 27 times"> + </span>]:<span class="lineCov">         41 :         if (zslValueLteMax(score,&amp;range)) {</span>
<span class="lineNum">     591 </span>                :            :             /* Check if score &gt;= min. */
<span class="lineNum">     592 </span>        [<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         14 :             if (zslValueGteMin(score,&amp;range))</span>
<span class="lineNum">     593 </span>                :<span class="lineCov">         14 :                 return eptr;</span>
<span class="lineNum">     594 </span>                :            :             return NULL;
<span class="lineNum">     595 </span>                :            :         }
<span class="lineNum">     596 </span>                :            : 
<span class="lineNum">     597 </span>                :            :         /* Move to previous element by moving to the score of previous element.
<span class="lineNum">     598 </span>                :            :          * When this returns NULL, we know there also is no element. */
<span class="lineNum">     599 </span>                :<span class="lineCov">         27 :         sptr = ziplistPrev(zl,eptr);</span>
<span class="lineNum">     600 </span>        [<span class="branchCov" title="Branch 0 was taken 27 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         27 :         if (sptr != NULL)</span>
<span class="lineNum">     601 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 27 times"> + </span>]:<span class="lineCov">         41 :             redisAssert((eptr = ziplistPrev(zl,sptr)) != NULL);</span>
<span class="lineNum">     602 </span>                :            :         else
<span class="lineNum">     603 </span>                :            :             eptr = NULL;
<span class="lineNum">     604 </span>                :            :     }
<span class="lineNum">     605 </span>                :            : 
<span class="lineNum">     606 </span>                :            :     return NULL;
<a name="607"><span class="lineNum">     607 </span>                :            : }</a>
<span class="lineNum">     608 </span>                :            : 
<span class="lineNum">     609 </span>                :<span class="lineCov">     121581 : unsigned char *zzlFind(unsigned char *zl, robj *ele, double *score) {</span>
<span class="lineNum">     610 </span>                :<span class="lineCov">     121581 :     unsigned char *eptr = ziplistIndex(zl,0), *sptr;</span>
<span class="lineNum">     611 </span>                :            : 
<span class="lineNum">     612 </span>                :<span class="lineCov">     121581 :     ele = getDecodedObject(ele);</span>
<span class="lineNum">     613 </span>        [<span class="branchCov" title="Branch 0 was taken 2084298 times"> + </span><span class="branchCov" title="Branch 1 was taken 67826 times"> + </span>]:<span class="lineCov">    2152124 :     while (eptr != NULL) {</span>
<span class="lineNum">     614 </span>                :<span class="lineCov">    2084298 :         sptr = ziplistNext(zl,eptr);</span>
<span class="lineNum">     615 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2084298 times"> + </span>]:<span class="lineCov">    2084298 :         redisAssertWithInfo(NULL,ele,sptr != NULL);</span>
<span class="lineNum">     616 </span>                :            : 
<span class="lineNum">     617 </span>        [<span class="branchCov" title="Branch 1 was taken 53755 times"> + </span><span class="branchCov" title="Branch 2 was taken 2030543 times"> + </span>]:<span class="lineCov">    2084298 :         if (ziplistCompare(eptr,ele-&gt;ptr,sdslen(ele-&gt;ptr))) {</span>
<span class="lineNum">     618 </span>                :            :             /* Matching element, pull out score. */
<span class="lineNum">     619 </span>        [<span class="branchCov" title="Branch 0 was taken 38282 times"> + </span><span class="branchCov" title="Branch 1 was taken 15473 times"> + </span>]:<span class="lineCov">      53755 :             if (score != NULL) *score = zzlGetScore(sptr);</span>
<span class="lineNum">     620 </span>                :<span class="lineCov">      53755 :             decrRefCount(ele);</span>
<span class="lineNum">     621 </span>                :<span class="lineCov">      53755 :             return eptr;</span>
<span class="lineNum">     622 </span>                :            :         }
<span class="lineNum">     623 </span>                :            : 
<span class="lineNum">     624 </span>                :            :         /* Move to next element. */
<span class="lineNum">     625 </span>                :<span class="lineCov">    2030543 :         eptr = ziplistNext(zl,sptr);</span>
<span class="lineNum">     626 </span>                :            :     }
<span class="lineNum">     627 </span>                :            : 
<span class="lineNum">     628 </span>                :<span class="lineCov">      67826 :     decrRefCount(ele);</span>
<span class="lineNum">     629 </span>                :<span class="lineCov">     121581 :     return NULL;</span>
<span class="lineNum">     630 </span>                :            : }
<span class="lineNum">     631 </span>                :            : 
<a name="632"><span class="lineNum">     632 </span>                :            : /* Delete (element,score) pair from ziplist. Use local copy of eptr because we</a>
<span class="lineNum">     633 </span>                :            :  * don't want to modify the one given as argument. */
<span class="lineNum">     634 </span>                :<span class="lineCov">      16698 : unsigned char *zzlDelete(unsigned char *zl, unsigned char *eptr) {</span>
<span class="lineNum">     635 </span>                :<span class="lineCov">      16698 :     unsigned char *p = eptr;</span>
<span class="lineNum">     636 </span>                :            : 
<span class="lineNum">     637 </span>                :            :     /* TODO: add function to ziplist API to delete N elements from offset. */
<span class="lineNum">     638 </span>                :<span class="lineCov">      16698 :     zl = ziplistDelete(zl,&amp;p);</span>
<span class="lineNum">     639 </span>                :<span class="lineCov">      16698 :     zl = ziplistDelete(zl,&amp;p);</span>
<span class="lineNum">     640 </span>                :<span class="lineCov">      16698 :     return zl;</span>
<a name="641"><span class="lineNum">     641 </span>                :            : }</a>
<span class="lineNum">     642 </span>                :            : 
<span class="lineNum">     643 </span>                :<span class="lineCov">      67969 : unsigned char *zzlInsertAt(unsigned char *zl, unsigned char *eptr, robj *ele, double score) {</span>
<span class="lineNum">     644 </span>                :            :     unsigned char *sptr;
<span class="lineNum">     645 </span>                :            :     char scorebuf[128];
<span class="lineNum">     646 </span>                :            :     int scorelen;
<span class="lineNum">     647 </span>                :            :     size_t offset;
<span class="lineNum">     648 </span>                :            : 
<span class="lineNum">     649 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 67969 times"> + </span>]:<span class="lineCov">      67969 :     redisAssertWithInfo(NULL,ele,sdsEncodedObject(ele));</span>
<span class="lineNum">     650 </span>                :<span class="lineCov">      67969 :     scorelen = d2string(scorebuf,sizeof(scorebuf),score);</span>
<span class="lineNum">     651 </span>        [<span class="branchCov" title="Branch 0 was taken 61795 times"> + </span><span class="branchCov" title="Branch 1 was taken 6174 times"> + </span>]:<span class="lineCov">      67969 :     if (eptr == NULL) {</span>
<span class="lineNum">     652 </span>                :<span class="lineCov">      61795 :         zl = ziplistPush(zl,ele-&gt;ptr,sdslen(ele-&gt;ptr),ZIPLIST_TAIL);</span>
<span class="lineNum">     653 </span>                :<span class="lineCov">      61795 :         zl = ziplistPush(zl,(unsigned char*)scorebuf,scorelen,ZIPLIST_TAIL);</span>
<span class="lineNum">     654 </span>                :            :     } else {
<span class="lineNum">     655 </span>                :            :         /* Keep offset relative to zl, as it might be re-allocated. */
<span class="lineNum">     656 </span>                :<span class="lineCov">       6174 :         offset = eptr-zl;</span>
<span class="lineNum">     657 </span>                :<span class="lineCov">       6174 :         zl = ziplistInsert(zl,eptr,ele-&gt;ptr,sdslen(ele-&gt;ptr));</span>
<span class="lineNum">     658 </span>                :<span class="lineCov">       6174 :         eptr = zl+offset;</span>
<span class="lineNum">     659 </span>                :            : 
<span class="lineNum">     660 </span>                :            :         /* Insert score after the element. */
<span class="lineNum">     661 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 6174 times"> + </span>]:<span class="lineCov">       6174 :         redisAssertWithInfo(NULL,ele,(sptr = ziplistNext(zl,eptr)) != NULL);</span>
<span class="lineNum">     662 </span>                :<span class="lineCov">       6174 :         zl = ziplistInsert(zl,sptr,(unsigned char*)scorebuf,scorelen);</span>
<span class="lineNum">     663 </span>                :            :     }
<span class="lineNum">     664 </span>                :            : 
<span class="lineNum">     665 </span>                :<span class="lineCov">      67969 :     return zl;</span>
<span class="lineNum">     666 </span>                :            : }
<span class="lineNum">     667 </span>                :            : 
<a name="668"><span class="lineNum">     668 </span>                :            : /* Insert (element,score) pair in ziplist. This function assumes the element is</a>
<span class="lineNum">     669 </span>                :            :  * not yet present in the list. */
<span class="lineNum">     670 </span>                :<span class="lineCov">      52727 : unsigned char *zzlInsert(unsigned char *zl, robj *ele, double score) {</span>
<span class="lineNum">     671 </span>                :<span class="lineCov">      52727 :     unsigned char *eptr = ziplistIndex(zl,0), *sptr;</span>
<span class="lineNum">     672 </span>                :            :     double s;
<span class="lineNum">     673 </span>                :            : 
<span class="lineNum">     674 </span>                :<span class="lineCov">      52727 :     ele = getDecodedObject(ele);</span>
<span class="lineNum">     675 </span>        [<span class="branchCov" title="Branch 0 was taken 192510 times"> + </span><span class="branchCov" title="Branch 1 was taken 46553 times"> + </span>]:<span class="lineCov">     239063 :     while (eptr != NULL) {</span>
<span class="lineNum">     676 </span>                :<span class="lineCov">     192510 :         sptr = ziplistNext(zl,eptr);</span>
<span class="lineNum">     677 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 192510 times"> + </span>]:<span class="lineCov">     192510 :         redisAssertWithInfo(NULL,ele,sptr != NULL);</span>
<span class="lineNum">     678 </span>                :<span class="lineCov">     192510 :         s = zzlGetScore(sptr);</span>
<span class="lineNum">     679 </span>                :            : 
<span class="lineNum">     680 </span>        [<span class="branchCov" title="Branch 0 was taken 6051 times"> + </span><span class="branchCov" title="Branch 1 was taken 186459 times"> + </span>]:<span class="lineCov">     192510 :         if (s &gt; score) {</span>
<span class="lineNum">     681 </span>                :            :             /* First element with score larger than score for element to be
<span class="lineNum">     682 </span>                :            :              * inserted. This means we should take its spot in the list to
<span class="lineNum">     683 </span>                :            :              * maintain ordering. */
<span class="lineNum">     684 </span>                :<span class="lineCov">       6051 :             zl = zzlInsertAt(zl,eptr,ele,score);</span>
<span class="lineNum">     685 </span>                :<span class="lineCov">       6051 :             break;</span>
<span class="lineNum">     686 </span>        [<span class="branchCov" title="Branch 0 was taken 847 times"> + </span><span class="branchCov" title="Branch 1 was taken 185612 times"> + </span>]:<span class="lineCov">     186459 :         } else if (s == score) {</span>
<span class="lineNum">     687 </span>                :            :             /* Ensure lexicographical ordering for elements. */
<span class="lineNum">     688 </span>        [<span class="branchCov" title="Branch 1 was taken 123 times"> + </span><span class="branchCov" title="Branch 2 was taken 724 times"> + </span>]:<span class="lineCov">        847 :             if (zzlCompareElements(eptr,ele-&gt;ptr,sdslen(ele-&gt;ptr)) &gt; 0) {</span>
<span class="lineNum">     689 </span>                :<span class="lineCov">        123 :                 zl = zzlInsertAt(zl,eptr,ele,score);</span>
<span class="lineNum">     690 </span>                :<span class="lineCov">        123 :                 break;</span>
<span class="lineNum">     691 </span>                :            :             }
<span class="lineNum">     692 </span>                :            :         }
<span class="lineNum">     693 </span>                :            : 
<span class="lineNum">     694 </span>                :            :         /* Move to next element. */
<span class="lineNum">     695 </span>                :<span class="lineCov">     186336 :         eptr = ziplistNext(zl,sptr);</span>
<span class="lineNum">     696 </span>                :            :     }
<span class="lineNum">     697 </span>                :            : 
<span class="lineNum">     698 </span>                :            :     /* Push on tail of list when it was not yet inserted. */
<span class="lineNum">     699 </span>        [<span class="branchCov" title="Branch 0 was taken 46553 times"> + </span><span class="branchCov" title="Branch 1 was taken 6174 times"> + </span>]:<span class="lineCov">      52727 :     if (eptr == NULL)</span>
<span class="lineNum">     700 </span>                :<span class="lineCov">      46553 :         zl = zzlInsertAt(zl,NULL,ele,score);</span>
<span class="lineNum">     701 </span>                :            : 
<span class="lineNum">     702 </span>                :<span class="lineCov">      52727 :     decrRefCount(ele);</span>
<span class="lineNum">     703 </span>                :<span class="lineCov">      52727 :     return zl;</span>
<span class="lineNum">     704 </span>                :            : }
<span class="lineNum">     705 </span>                :            : 
<span class="lineNum">     706 </span>                :<span class="lineCov">         13 : unsigned char *zzlDeleteRangeByScore(unsigned char *zl, zrangespec range, unsigned long *deleted) {</span>
<span class="lineNum">     707 </span>                :            :     unsigned char *eptr, *sptr;
<span class="lineNum">     708 </span>                :            :     double score;
<span class="lineNum">     709 </span>                :<span class="lineCov">         13 :     unsigned long num = 0;</span>
<span class="lineNum">     710 </span>                :            : 
<span class="lineNum">     711 </span>        [<span class="branchCov" title="Branch 0 was taken 13 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         13 :     if (deleted != NULL) *deleted = 0;</span>
<span class="lineNum">     712 </span>                :            : 
<span class="lineNum">     713 </span>                :<span class="lineCov">         13 :     eptr = zzlFirstInRange(zl,range);</span>
<span class="lineNum">     714 </span>        [<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">         13 :     if (eptr == NULL) return zl;</span>
<span class="lineNum">     715 </span>                :            : 
<span class="lineNum">     716 </span>                :            :     /* When the tail of the ziplist is deleted, eptr will point to the sentinel
<span class="lineNum">     717 </span>                :            :      * byte and ziplistNext will return NULL. */
<span class="lineNum">     718 </span>        [<span class="branchCov" title="Branch 1 was taken 44 times"> + </span><span class="branchCov" title="Branch 2 was taken 6 times"> + </span>]:<span class="lineCov">         50 :     while ((sptr = ziplistNext(zl,eptr)) != NULL) {</span>
<span class="lineNum">     719 </span>                :<span class="lineCov">         44 :         score = zzlGetScore(sptr);</span>
<span class="lineNum">     720 </span>        [<span class="branchCov" title="Branch 0 was taken 38 times"> + </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">         44 :         if (zslValueLteMax(score,&amp;range)) {</span>
<span class="lineNum">     721 </span>                :            :             /* Delete both the element and the score. */
<span class="lineNum">     722 </span>                :<span class="lineCov">         38 :             zl = ziplistDelete(zl,&amp;eptr);</span>
<span class="lineNum">     723 </span>                :<span class="lineCov">         38 :             zl = ziplistDelete(zl,&amp;eptr);</span>
<span class="lineNum">     724 </span>                :<span class="lineCov">         38 :             num++;</span>
<span class="lineNum">     725 </span>                :            :         } else {
<span class="lineNum">     726 </span>                :            :             /* No longer in range. */
<span class="lineNum">     727 </span>                :            :             break;
<span class="lineNum">     728 </span>                :            :         }
<span class="lineNum">     729 </span>                :            :     }
<span class="lineNum">     730 </span>                :            : 
<span class="lineNum">     731 </span>        [<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         13 :     if (deleted != NULL) *deleted = num;</span>
<span class="lineNum">     732 </span>                :            :     return zl;
<span class="lineNum">     733 </span>                :            : }
<span class="lineNum">     734 </span>                :            : 
<a name="735"><span class="lineNum">     735 </span>                :            : /* Delete all the elements with rank between start and end from the skiplist.</a>
<span class="lineNum">     736 </span>                :            :  * Start and end are inclusive. Note that start and end need to be 1-based */
<span class="lineNum">     737 </span>                :<span class="lineCov">          4 : unsigned char *zzlDeleteRangeByRank(unsigned char *zl, unsigned int start, unsigned int end, unsigned long *deleted) {</span>
<span class="lineNum">     738 </span>                :<span class="lineCov">          4 :     unsigned int num = (end-start)+1;</span>
<span class="lineNum">     739 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          4 :     if (deleted) *deleted = num;</span>
<span class="lineNum">     740 </span>                :<span class="lineCov">          4 :     zl = ziplistDeleteRange(zl,2*(start-1),2*num);</span>
<span class="lineNum">     741 </span>                :<span class="lineCov">          4 :     return zl;</span>
<span class="lineNum">     742 </span>                :            : }
<span class="lineNum">     743 </span>                :            : 
<span class="lineNum">     744 </span>                :            : /*-----------------------------------------------------------------------------
<span class="lineNum">     745 </span>                :            :  * Common sorted set API
<a name="746"><span class="lineNum">     746 </span>                :            :  *----------------------------------------------------------------------------*/</a>
<span class="lineNum">     747 </span>                :            : 
<span class="lineNum">     748 </span>                :<span class="lineCov">      37525 : unsigned int zsetLength(robj *zobj) {</span>
<span class="lineNum">     749 </span>                :<span class="lineCov">      37525 :     int length = -1;</span>
<span class="lineNum">     750 </span>        [<span class="branchCov" title="Branch 0 was taken 23621 times"> + </span><span class="branchCov" title="Branch 1 was taken 13904 times"> + </span>]:<span class="lineCov">      37525 :     if (zobj-&gt;encoding == REDIS_ENCODING_ZIPLIST) {</span>
<span class="lineNum">     751 </span>                :<span class="lineCov">      23621 :         length = zzlLength(zobj-&gt;ptr);</span>
<span class="lineNum">     752 </span>        [<span class="branchCov" title="Branch 0 was taken 13904 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      13904 :     } else if (zobj-&gt;encoding == REDIS_ENCODING_SKIPLIST) {</span>
<span class="lineNum">     753 </span>                :<span class="lineCov">      13904 :         length = ((zset*)zobj-&gt;ptr)-&gt;zsl-&gt;length;</span>
<span class="lineNum">     754 </span>                :            :     } else {
<span class="lineNum">     755 </span>                :<span class="lineNoCov">          0 :         redisPanic(&quot;Unknown sorted set encoding&quot;);</span>
<span class="lineNum">     756 </span>                :            :     }
<span class="lineNum">     757 </span>                :<span class="lineCov">      37525 :     return length;</span>
<a name="758"><span class="lineNum">     758 </span>                :            : }</a>
<span class="lineNum">     759 </span>                :            : 
<span class="lineNum">     760 </span>                :<span class="lineCov">       7165 : void zsetConvert(robj *zobj, int encoding) {</span>
<span class="lineNum">     761 </span>                :            :     zset *zs;
<span class="lineNum">     762 </span>                :            :     zskiplistNode *node, *next;
<span class="lineNum">     763 </span>                :            :     robj *ele;
<span class="lineNum">     764 </span>                :            :     double score;
<span class="lineNum">     765 </span>                :            : 
<span class="lineNum">     766 </span>        [<span class="branchCov" title="Branch 0 was taken 7158 times"> + </span><span class="branchCov" title="Branch 1 was taken 7 times"> + </span>]:<span class="lineCov">      14323 :     if (zobj-&gt;encoding == encoding) return;</span>
<span class="lineNum">     767 </span>        [<span class="branchCov" title="Branch 0 was taken 466 times"> + </span><span class="branchCov" title="Branch 1 was taken 6692 times"> + </span>]:<span class="lineCov">       7158 :     if (zobj-&gt;encoding == REDIS_ENCODING_ZIPLIST) {</span>
<span class="lineNum">     768 </span>                :<span class="lineCov">        466 :         unsigned char *zl = zobj-&gt;ptr;</span>
<span class="lineNum">     769 </span>                :            :         unsigned char *eptr, *sptr;
<span class="lineNum">     770 </span>                :            :         unsigned char *vstr;
<span class="lineNum">     771 </span>                :            :         unsigned int vlen;
<span class="lineNum">     772 </span>                :            :         long long vlong;
<span class="lineNum">     773 </span>                :            : 
<span class="lineNum">     774 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 466 times"> + </span>]:<span class="lineCov">        466 :         if (encoding != REDIS_ENCODING_SKIPLIST)</span>
<span class="lineNum">     775 </span>                :<span class="lineNoCov">          0 :             redisPanic(&quot;Unknown target encoding&quot;);</span>
<span class="lineNum">     776 </span>                :            : 
<span class="lineNum">     777 </span>                :<span class="lineCov">        466 :         zs = zmalloc(sizeof(*zs));</span>
<span class="lineNum">     778 </span>                :<span class="lineCov">        466 :         zs-&gt;dict = dictCreate(&amp;zsetDictType,NULL);</span>
<span class="lineNum">     779 </span>                :<span class="lineCov">        466 :         zs-&gt;zsl = zslCreate();</span>
<span class="lineNum">     780 </span>                :            : 
<span class="lineNum">     781 </span>                :<span class="lineCov">        466 :         eptr = ziplistIndex(zl,0);</span>
<span class="lineNum">     782 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 466 times"> + </span>]:<span class="lineCov">        466 :         redisAssertWithInfo(NULL,zobj,eptr != NULL);</span>
<span class="lineNum">     783 </span>                :<span class="lineCov">        466 :         sptr = ziplistNext(zl,eptr);</span>
<span class="lineNum">     784 </span>        [<span class="branchCov" title="Branch 0 was taken 466 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        466 :         redisAssertWithInfo(NULL,zobj,sptr != NULL);</span>
<span class="lineNum">     785 </span>                :            : 
<span class="lineNum">     786 </span>        [<span class="branchCov" title="Branch 0 was taken 3711 times"> + </span><span class="branchCov" title="Branch 1 was taken 466 times"> + </span>]:<span class="lineCov">       4177 :         while (eptr != NULL) {</span>
<span class="lineNum">     787 </span>                :<span class="lineCov">       3711 :             score = zzlGetScore(sptr);</span>
<span class="lineNum">     788 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 3711 times"> + </span>]:<span class="lineCov">       3711 :             redisAssertWithInfo(NULL,zobj,ziplistGet(eptr,&amp;vstr,&amp;vlen,&amp;vlong));</span>
<span class="lineNum">     789 </span>        [<span class="branchCov" title="Branch 0 was taken 1770 times"> + </span><span class="branchCov" title="Branch 1 was taken 1941 times"> + </span>]:<span class="lineCov">       3711 :             if (vstr == NULL)</span>
<span class="lineNum">     790 </span>                :<span class="lineCov">       1770 :                 ele = createStringObjectFromLongLong(vlong);</span>
<span class="lineNum">     791 </span>                :            :             else
<span class="lineNum">     792 </span>                :<span class="lineCov">       1941 :                 ele = createStringObject((char*)vstr,vlen);</span>
<span class="lineNum">     793 </span>                :            : 
<span class="lineNum">     794 </span>                :            :             /* Has incremented refcount since it was just created. */
<span class="lineNum">     795 </span>                :<span class="lineCov">       3711 :             node = zslInsert(zs-&gt;zsl,score,ele);</span>
<span class="lineNum">     796 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 3711 times"> + </span>]:<span class="lineCov">       3711 :             redisAssertWithInfo(NULL,zobj,dictAdd(zs-&gt;dict,ele,&amp;node-&gt;score) == DICT_OK);</span>
<span class="lineNum">     797 </span>                :<span class="lineCov">       3711 :             incrRefCount(ele); /* Added to dictionary. */</span>
<span class="lineNum">     798 </span>                :<span class="lineCov">       3711 :             zzlNext(zl,&amp;eptr,&amp;sptr);</span>
<span class="lineNum">     799 </span>                :            :         }
<span class="lineNum">     800 </span>                :            : 
<span class="lineNum">     801 </span>                :<span class="lineCov">        466 :         zfree(zobj-&gt;ptr);</span>
<span class="lineNum">     802 </span>                :<span class="lineCov">        466 :         zobj-&gt;ptr = zs;</span>
<span class="lineNum">     803 </span>                :<span class="lineCov">        466 :         zobj-&gt;encoding = REDIS_ENCODING_SKIPLIST;</span>
<span class="lineNum">     804 </span>        [<span class="branchCov" title="Branch 0 was taken 6692 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       6692 :     } else if (zobj-&gt;encoding == REDIS_ENCODING_SKIPLIST) {</span>
<span class="lineNum">     805 </span>                :<span class="lineCov">       6692 :         unsigned char *zl = ziplistNew();</span>
<span class="lineNum">     806 </span>                :            : 
<span class="lineNum">     807 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 6692 times"> + </span>]:<span class="lineCov">       6692 :         if (encoding != REDIS_ENCODING_ZIPLIST)</span>
<span class="lineNum">     808 </span>                :<span class="lineNoCov">          0 :             redisPanic(&quot;Unknown target encoding&quot;);</span>
<span class="lineNum">     809 </span>                :            : 
<span class="lineNum">     810 </span>                :            :         /* Approach similar to zslFree(), since we want to free the skiplist at
<span class="lineNum">     811 </span>                :            :          * the same time as creating the ziplist. */
<span class="lineNum">     812 </span>                :<span class="lineCov">       6692 :         zs = zobj-&gt;ptr;</span>
<span class="lineNum">     813 </span>                :<span class="lineCov">       6692 :         dictRelease(zs-&gt;dict);</span>
<span class="lineNum">     814 </span>                :<span class="lineCov">       6692 :         node = zs-&gt;zsl-&gt;header-&gt;level[0].forward;</span>
<span class="lineNum">     815 </span>                :<span class="lineCov">       6692 :         zfree(zs-&gt;zsl-&gt;header);</span>
<span class="lineNum">     816 </span>                :<span class="lineCov">       6692 :         zfree(zs-&gt;zsl);</span>
<span class="lineNum">     817 </span>                :            : 
<span class="lineNum">     818 </span>        [<span class="branchCov" title="Branch 0 was taken 15242 times"> + </span><span class="branchCov" title="Branch 1 was taken 6692 times"> + </span>]:<span class="lineCov">      21934 :         while (node) {</span>
<span class="lineNum">     819 </span>                :<span class="lineCov">      15242 :             ele = getDecodedObject(node-&gt;obj);</span>
<span class="lineNum">     820 </span>                :<span class="lineCov">      15242 :             zl = zzlInsertAt(zl,NULL,ele,node-&gt;score);</span>
<span class="lineNum">     821 </span>                :<span class="lineCov">      15242 :             decrRefCount(ele);</span>
<span class="lineNum">     822 </span>                :            : 
<span class="lineNum">     823 </span>                :<span class="lineCov">      15242 :             next = node-&gt;level[0].forward;</span>
<span class="lineNum">     824 </span>                :<span class="lineCov">      15242 :             zslFreeNode(node);</span>
<span class="lineNum">     825 </span>                :<span class="lineCov">      15242 :             node = next;</span>
<span class="lineNum">     826 </span>                :            :         }
<span class="lineNum">     827 </span>                :            : 
<span class="lineNum">     828 </span>                :<span class="lineCov">       6692 :         zfree(zs);</span>
<span class="lineNum">     829 </span>                :<span class="lineCov">       6692 :         zobj-&gt;ptr = zl;</span>
<span class="lineNum">     830 </span>                :<span class="lineCov">       6692 :         zobj-&gt;encoding = REDIS_ENCODING_ZIPLIST;</span>
<span class="lineNum">     831 </span>                :            :     } else {
<span class="lineNum">     832 </span>                :<span class="lineNoCov">          0 :         redisPanic(&quot;Unknown sorted set encoding&quot;);</span>
<span class="lineNum">     833 </span>                :            :     }
<span class="lineNum">     834 </span>                :            : }
<span class="lineNum">     835 </span>                :            : 
<span class="lineNum">     836 </span>                :            : /*-----------------------------------------------------------------------------
<span class="lineNum">     837 </span>                :            :  * Sorted set commands 
<span class="lineNum">     838 </span>                :            :  *----------------------------------------------------------------------------*/
<a name="839"><span class="lineNum">     839 </span>                :            : </a>
<span class="lineNum">     840 </span>                :            : /* This generic command implements both ZADD and ZINCRBY. */
<span class="lineNum">     841 </span>                :<span class="lineCov">      87722 : void zaddGenericCommand(redisClient *c, int incr) {</span>
<span class="lineNum">     842 </span>                :            :     static char *nanerr = &quot;resulting score is not a number (NaN)&quot;;
<span class="lineNum">     843 </span>                :<span class="lineCov">      87722 :     robj *key = c-&gt;argv[1];</span>
<span class="lineNum">     844 </span>                :            :     robj *ele;
<span class="lineNum">     845 </span>                :            :     robj *zobj;
<span class="lineNum">     846 </span>                :            :     robj *curobj;
<span class="lineNum">     847 </span>                :<span class="lineCov">      87722 :     double score = 0, *scores = NULL, curscore = 0.0;</span>
<span class="lineNum">     848 </span>                :<span class="lineCov">      87722 :     int j, elements = (c-&gt;argc-2)/2;</span>
<span class="lineNum">     849 </span>                :<span class="lineCov">      87722 :     int added = 0, updated = 0;</span>
<span class="lineNum">     850 </span>                :            : 
<span class="lineNum">     851 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 87720 times"> + </span>]:<span class="lineCov">      87722 :     if (c-&gt;argc % 2) {</span>
<span class="lineNum">     852 </span>                :<span class="lineCov">          2 :         addReply(c,shared.syntaxerr);</span>
<span class="lineNum">     853 </span>                :<span class="lineCov">      87722 :         return;</span>
<span class="lineNum">     854 </span>                :            :     }
<span class="lineNum">     855 </span>                :            : 
<span class="lineNum">     856 </span>                :            :     /* Start parsing all the scores, we need to emit any syntax error
<span class="lineNum">     857 </span>                :            :      * before executing additions to the sorted set, as the command should
<span class="lineNum">     858 </span>                :            :      * either execute fully or nothing at all. */
<span class="lineNum">     859 </span>                :<span class="lineCov">      87720 :     scores = zmalloc(sizeof(double)*elements);</span>
<span class="lineNum">     860 </span>        [<span class="branchCov" title="Branch 1 was taken 95369 times"> + </span><span class="branchCov" title="Branch 2 was taken 87714 times"> + </span>]:<span class="lineCov">     183083 :     for (j = 0; j &lt; elements; j++) {</span>
<span class="lineNum">     861 </span>        [<span class="branchCov" title="Branch 1 was taken 95363 times"> + </span><span class="branchCov" title="Branch 2 was taken 6 times"> + </span>]:<span class="lineCov">      95369 :         if (getDoubleFromObjectOrReply(c,c-&gt;argv[2+j*2],&amp;scores[j],NULL)</span>
<span class="lineNum">     862 </span>                :            :             != REDIS_OK) goto cleanup;
<span class="lineNum">     863 </span>                :            :     }
<span class="lineNum">     864 </span>                :            : 
<span class="lineNum">     865 </span>                :            :     /* Lookup the key and create the sorted set if does not exist. */
<span class="lineNum">     866 </span>                :<span class="lineCov">      87714 :     zobj = lookupKeyWrite(c-&gt;db,key);</span>
<span class="lineNum">     867 </span>        [<span class="branchCov" title="Branch 0 was taken 55484 times"> + </span><span class="branchCov" title="Branch 1 was taken 32230 times"> + </span>]:<span class="lineCov">      87714 :     if (zobj == NULL) {</span>
<span class="lineNum">     868 </span>[<span class="branchCov" title="Branch 0 was taken 55431 times"> + </span><span class="branchCov" title="Branch 1 was taken 53 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 10251 times"> + </span><span class="branchCov" title="Branch 3 was taken 45180 times"> + </span>]:<span class="lineCov">      55484 :         if (server.zset_max_ziplist_entries == 0 ||</span>
<span class="lineNum">     869 </span>                :<span class="lineCov">      55431 :             server.zset_max_ziplist_value &lt; sdslen(c-&gt;argv[3]-&gt;ptr))</span>
<span class="lineNum">     870 </span>                :            :         {
<span class="lineNum">     871 </span>                :<span class="lineCov">      10304 :             zobj = createZsetObject();</span>
<span class="lineNum">     872 </span>                :            :         } else {
<span class="lineNum">     873 </span>                :<span class="lineCov">      45180 :             zobj = createZsetZiplistObject();</span>
<span class="lineNum">     874 </span>                :            :         }
<span class="lineNum">     875 </span>                :<span class="lineCov">      55484 :         dbAdd(c-&gt;db,key,zobj);</span>
<span class="lineNum">     876 </span>                :            :     } else {
<span class="lineNum">     877 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 32230 times"> + </span>]:<span class="lineCov">      32230 :         if (zobj-&gt;type != REDIS_ZSET) {</span>
<span class="lineNum">     878 </span>                :<span class="lineNoCov">          0 :             addReply(c,shared.wrongtypeerr);</span>
<span class="lineNum">     879 </span>                :<span class="lineNoCov">          0 :             goto cleanup;</span>
<span class="lineNum">     880 </span>                :            :         }
<span class="lineNum">     881 </span>                :            :     }
<span class="lineNum">     882 </span>                :            : 
<span class="lineNum">     883 </span>        [<span class="branchCov" title="Branch 0 was taken 95359 times"> + </span><span class="branchCov" title="Branch 1 was taken 87712 times"> + </span>]:<span class="lineCov">     183071 :     for (j = 0; j &lt; elements; j++) {</span>
<span class="lineNum">     884 </span>                :<span class="lineCov">      95359 :         score = scores[j];</span>
<span class="lineNum">     885 </span>                :            : 
<span class="lineNum">     886 </span>        [<span class="branchCov" title="Branch 0 was taken 63883 times"> + </span><span class="branchCov" title="Branch 1 was taken 31476 times"> + </span>]:<span class="lineCov">      95359 :         if (zobj-&gt;encoding == REDIS_ENCODING_ZIPLIST) {</span>
<span class="lineNum">     887 </span>                :            :             unsigned char *eptr;
<span class="lineNum">     888 </span>                :            : 
<span class="lineNum">     889 </span>                :            :             /* Prefer non-encoded element when dealing with ziplists. */
<span class="lineNum">     890 </span>                :<span class="lineCov">      63883 :             ele = c-&gt;argv[3+j*2];</span>
<span class="lineNum">     891 </span>        [<span class="branchCov" title="Branch 1 was taken 12381 times"> + </span><span class="branchCov" title="Branch 2 was taken 51502 times"> + </span>]:<span class="lineCov">      63883 :             if ((eptr = zzlFind(zobj-&gt;ptr,ele,&amp;curscore)) != NULL) {</span>
<span class="lineNum">     892 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchCov" title="Branch 1 was taken 12376 times"> + </span>]:<span class="lineCov">      12381 :                 if (incr) {</span>
<span class="lineNum">     893 </span>                :<span class="lineCov">          5 :                     score += curscore;</span>
<span class="lineNum">     894 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span>]:<span class="lineCov">          5 :                     if (isnan(score)) {</span>
<span class="lineNum">     895 </span>                :<span class="lineCov">          1 :                         addReplyError(c,nanerr);</span>
<span class="lineNum">     896 </span>                :<span class="lineCov">          1 :                         goto cleanup;</span>
<span class="lineNum">     897 </span>                :            :                     }
<span class="lineNum">     898 </span>                :            :                 }
<span class="lineNum">     899 </span>                :            : 
<span class="lineNum">     900 </span>                :            :                 /* Remove and re-insert when score changed. */
<span class="lineNum">     901 </span>        [<span class="branchCov" title="Branch 0 was taken 1225 times"> + </span><span class="branchCov" title="Branch 1 was taken 11155 times"> + </span>]:<span class="lineCov">      12380 :                 if (score != curscore) {</span>
<span class="lineNum">     902 </span>                :<span class="lineCov">       1225 :                     zobj-&gt;ptr = zzlDelete(zobj-&gt;ptr,eptr);</span>
<span class="lineNum">     903 </span>                :<span class="lineCov">       1225 :                     zobj-&gt;ptr = zzlInsert(zobj-&gt;ptr,ele,score);</span>
<span class="lineNum">     904 </span>                :<span class="lineCov">       1225 :                     server.dirty++;</span>
<span class="lineNum">     905 </span>                :<span class="lineCov">       1225 :                     updated++;</span>
<span class="lineNum">     906 </span>                :            :                 }
<span class="lineNum">     907 </span>                :            :             } else {
<span class="lineNum">     908 </span>                :            :                 /* Optimize: check if the element is too large or the list
<span class="lineNum">     909 </span>                :            :                  * becomes too long *before* executing zzlInsert. */
<span class="lineNum">     910 </span>                :<span class="lineCov">      51502 :                 zobj-&gt;ptr = zzlInsert(zobj-&gt;ptr,ele,score);</span>
<span class="lineNum">     911 </span>        [<span class="branchCov" title="Branch 1 was taken 18 times"> + </span><span class="branchCov" title="Branch 2 was taken 51484 times"> + </span>]:<span class="lineCov">      51502 :                 if (zzlLength(zobj-&gt;ptr) &gt; server.zset_max_ziplist_entries)</span>
<span class="lineNum">     912 </span>                :<span class="lineCov">         18 :                     zsetConvert(zobj,REDIS_ENCODING_SKIPLIST);</span>
<span class="lineNum">     913 </span>        [<span class="branchCov" title="Branch 0 was taken 430 times"> + </span><span class="branchCov" title="Branch 1 was taken 51072 times"> + </span>]:<span class="lineCov">      51502 :                 if (sdslen(ele-&gt;ptr) &gt; server.zset_max_ziplist_value)</span>
<span class="lineNum">     914 </span>                :<span class="lineCov">        430 :                     zsetConvert(zobj,REDIS_ENCODING_SKIPLIST);</span>
<span class="lineNum">     915 </span>                :<span class="lineCov">      51502 :                 server.dirty++;</span>
<span class="lineNum">     916 </span>                :<span class="lineCov">      51502 :                 added++;</span>
<span class="lineNum">     917 </span>                :            :             }
<span class="lineNum">     918 </span>        [<span class="branchCov" title="Branch 0 was taken 31476 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      31476 :         } else if (zobj-&gt;encoding == REDIS_ENCODING_SKIPLIST) {</span>
<span class="lineNum">     919 </span>                :<span class="lineCov">      31476 :             zset *zs = zobj-&gt;ptr;</span>
<span class="lineNum">     920 </span>                :            :             zskiplistNode *znode;
<span class="lineNum">     921 </span>                :            :             dictEntry *de;
<span class="lineNum">     922 </span>                :            : 
<span class="lineNum">     923 </span>                :<span class="lineCov">      31476 :             ele = c-&gt;argv[3+j*2] = tryObjectEncoding(c-&gt;argv[3+j*2]);</span>
<span class="lineNum">     924 </span>                :<span class="lineCov">      31476 :             de = dictFind(zs-&gt;dict,ele);</span>
<span class="lineNum">     925 </span>        [<span class="branchCov" title="Branch 0 was taken 4091 times"> + </span><span class="branchCov" title="Branch 1 was taken 27385 times"> + </span>]:<span class="lineCov">      31476 :             if (de != NULL) {</span>
<span class="lineNum">     926 </span>                :<span class="lineCov">       4091 :                 curobj = dictGetKey(de);</span>
<span class="lineNum">     927 </span>                :<span class="lineCov">       4091 :                 curscore = *(double*)dictGetVal(de);</span>
<span class="lineNum">     928 </span>                :            : 
<span class="lineNum">     929 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchCov" title="Branch 1 was taken 4086 times"> + </span>]:<span class="lineCov">       4091 :                 if (incr) {</span>
<span class="lineNum">     930 </span>                :<span class="lineCov">          5 :                     score += curscore;</span>
<span class="lineNum">     931 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span>]:<span class="lineCov">          5 :                     if (isnan(score)) {</span>
<span class="lineNum">     932 </span>                :<span class="lineCov">          1 :                         addReplyError(c,nanerr);</span>
<span class="lineNum">     933 </span>                :            :                         /* Don't need to check if the sorted set is empty
<span class="lineNum">     934 </span>                :            :                          * because we know it has at least one element. */
<span class="lineNum">     935 </span>                :<span class="lineCov">          1 :                         goto cleanup;</span>
<span class="lineNum">     936 </span>                :            :                     }
<span class="lineNum">     937 </span>                :            :                 }
<span class="lineNum">     938 </span>                :            : 
<span class="lineNum">     939 </span>                :            :                 /* Remove and re-insert when score changed. We can safely
<span class="lineNum">     940 </span>                :            :                  * delete the key object from the skiplist, since the
<span class="lineNum">     941 </span>                :            :                  * dictionary still has a reference to it. */
<span class="lineNum">     942 </span>        [<span class="branchCov" title="Branch 0 was taken 1640 times"> + </span><span class="branchCov" title="Branch 1 was taken 2450 times"> + </span>]:<span class="lineCov">       4090 :                 if (score != curscore) {</span>
<span class="lineNum">     943 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1640 times"> + </span>]:<span class="lineCov">       1640 :                     redisAssertWithInfo(c,curobj,zslDelete(zs-&gt;zsl,curscore,curobj));</span>
<span class="lineNum">     944 </span>                :<span class="lineCov">       1640 :                     znode = zslInsert(zs-&gt;zsl,score,curobj);</span>
<span class="lineNum">     945 </span>                :<span class="lineCov">       1640 :                     incrRefCount(curobj); /* Re-inserted in skiplist. */</span>
<span class="lineNum">     946 </span>                :<span class="lineCov">       1640 :                     dictGetVal(de) = &amp;znode-&gt;score; /* Update score ptr. */</span>
<span class="lineNum">     947 </span>                :<span class="lineCov">       1640 :                     server.dirty++;</span>
<span class="lineNum">     948 </span>                :<span class="lineCov">       1640 :                     updated++;</span>
<span class="lineNum">     949 </span>                :            :                 }
<span class="lineNum">     950 </span>                :            :             } else {
<span class="lineNum">     951 </span>                :<span class="lineCov">      27385 :                 znode = zslInsert(zs-&gt;zsl,score,ele);</span>
<span class="lineNum">     952 </span>                :<span class="lineCov">      27385 :                 incrRefCount(ele); /* Inserted in skiplist. */</span>
<span class="lineNum">     953 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 27385 times"> + </span>]:<span class="lineCov">      27385 :                 redisAssertWithInfo(c,NULL,dictAdd(zs-&gt;dict,ele,&amp;znode-&gt;score) == DICT_OK);</span>
<span class="lineNum">     954 </span>                :<span class="lineCov">      27385 :                 incrRefCount(ele); /* Added to dictionary. */</span>
<span class="lineNum">     955 </span>                :<span class="lineCov">      27385 :                 server.dirty++;</span>
<span class="lineNum">     956 </span>                :<span class="lineCov">      27385 :                 added++;</span>
<span class="lineNum">     957 </span>                :            :             }
<span class="lineNum">     958 </span>                :            :         } else {
<span class="lineNum">     959 </span>                :<span class="lineNoCov">          0 :             redisPanic(&quot;Unknown sorted set encoding&quot;);</span>
<span class="lineNum">     960 </span>                :            :         }
<span class="lineNum">     961 </span>                :            :     }
<span class="lineNum">     962 </span>        [<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchCov" title="Branch 1 was taken 87698 times"> + </span>]:<span class="lineCov">      87712 :     if (incr) /* ZINCRBY */</span>
<span class="lineNum">     963 </span>                :<span class="lineCov">         14 :         addReplyDouble(c,score);</span>
<span class="lineNum">     964 </span>                :            :     else /* ZADD */
<span class="lineNum">     965 </span>                :<span class="lineCov">      87698 :         addReplyLongLong(c,added);</span>
<span class="lineNum">     966 </span>                :            : 
<span class="lineNum">     967 </span>                :            : cleanup:
<span class="lineNum">     968 </span>                :<span class="lineCov">      87720 :     zfree(scores);</span>
<span class="lineNum">     969 </span>        [<span class="branchCov" title="Branch 0 was taken 74111 times"> + </span><span class="branchCov" title="Branch 1 was taken 13609 times"> + </span>]:<span class="lineCov">      87720 :     if (added || updated) {</span>
<span class="lineNum">     970 </span>                :<span class="lineCov">      74111 :         signalModifiedKey(c-&gt;db,key);</span>
<span class="lineNum">     971 </span>        [<span class="branchCov" title="Branch 0 was taken 74097 times"> + </span><span class="branchCov" title="Branch 1 was taken 14 times"> + </span>]:<span class="lineCov">      74111 :         notifyKeyspaceEvent(REDIS_NOTIFY_ZSET,</span>
<span class="lineNum">     972 </span>                :<span class="lineCov">      74111 :             incr ? &quot;zincr&quot; : &quot;zadd&quot;, key, c-&gt;db-&gt;id);</span>
<span class="lineNum">     973 </span>                :            :     }
<a name="974"><span class="lineNum">     974 </span>                :            : }</a>
<span class="lineNum">     975 </span>                :            : 
<span class="lineNum">     976 </span>                :<span class="lineCov">      87706 : void zaddCommand(redisClient *c) {</span>
<span class="lineNum">     977 </span>                :<span class="lineCov">      87706 :     zaddGenericCommand(c,0);</span>
<a name="978"><span class="lineNum">     978 </span>                :<span class="lineCov">      87706 : }</span></a>
<span class="lineNum">     979 </span>                :            : 
<span class="lineNum">     980 </span>                :<span class="lineCov">         16 : void zincrbyCommand(redisClient *c) {</span>
<span class="lineNum">     981 </span>                :<span class="lineCov">         16 :     zaddGenericCommand(c,1);</span>
<a name="982"><span class="lineNum">     982 </span>                :<span class="lineCov">         16 : }</span></a>
<span class="lineNum">     983 </span>                :            : 
<span class="lineNum">     984 </span>                :<span class="lineCov">      22038 : void zremCommand(redisClient *c) {</span>
<span class="lineNum">     985 </span>                :<span class="lineCov">      22038 :     robj *key = c-&gt;argv[1];</span>
<span class="lineNum">     986 </span>                :            :     robj *zobj;
<span class="lineNum">     987 </span>                :<span class="lineCov">      22038 :     int deleted = 0, keyremoved = 0, j;</span>
<span class="lineNum">     988 </span>                :            : 
<span class="lineNum">     989 </span>  [<span class="branchCov" title="Branch 1 was taken 22037 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchCov" title="Branch 3 was taken 22037 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">      44075 :     if ((zobj = lookupKeyWriteOrReply(c,key,shared.czero)) == NULL ||</span>
<span class="lineNum">     990 </span>                :<span class="lineCov">      44075 :         checkType(c,zobj,REDIS_ZSET)) return;</span>
<span class="lineNum">     991 </span>                :            : 
<span class="lineNum">     992 </span>        [<span class="branchCov" title="Branch 0 was taken 17421 times"> + </span><span class="branchCov" title="Branch 1 was taken 4616 times"> + </span>]:<span class="lineCov">      22037 :     if (zobj-&gt;encoding == REDIS_ENCODING_ZIPLIST) {</span>
<span class="lineNum">     993 </span>                :            :         unsigned char *eptr;
<span class="lineNum">     994 </span>                :            : 
<span class="lineNum">     995 </span>        [<span class="branchCov" title="Branch 0 was taken 17428 times"> + </span><span class="branchCov" title="Branch 1 was taken 2313 times"> + </span>]:<span class="lineCov">      19741 :         for (j = 2; j &lt; c-&gt;argc; j++) {</span>
<span class="lineNum">     996 </span>        [<span class="branchCov" title="Branch 1 was taken 15473 times"> + </span><span class="branchCov" title="Branch 2 was taken 1955 times"> + </span>]:<span class="lineCov">      17428 :             if ((eptr = zzlFind(zobj-&gt;ptr,c-&gt;argv[j],NULL)) != NULL) {</span>
<span class="lineNum">     997 </span>                :<span class="lineCov">      15473 :                 deleted++;</span>
<span class="lineNum">     998 </span>                :<span class="lineCov">      15473 :                 zobj-&gt;ptr = zzlDelete(zobj-&gt;ptr,eptr);</span>
<span class="lineNum">     999 </span>        [<span class="branchCov" title="Branch 1 was taken 15108 times"> + </span><span class="branchCov" title="Branch 2 was taken 365 times"> + </span>]:<span class="lineCov">      15473 :                 if (zzlLength(zobj-&gt;ptr) == 0) {</span>
<span class="lineNum">    1000 </span>                :<span class="lineCov">      15108 :                     dbDelete(c-&gt;db,key);</span>
<span class="lineNum">    1001 </span>                :<span class="lineCov">      15108 :                     break;</span>
<span class="lineNum">    1002 </span>                :            :                 }
<span class="lineNum">    1003 </span>                :            :             }
<span class="lineNum">    1004 </span>                :            :         }
<span class="lineNum">    1005 </span>        [<span class="branchCov" title="Branch 0 was taken 4616 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       4616 :     } else if (zobj-&gt;encoding == REDIS_ENCODING_SKIPLIST) {</span>
<span class="lineNum">    1006 </span>                :<span class="lineCov">       4616 :         zset *zs = zobj-&gt;ptr;</span>
<span class="lineNum">    1007 </span>                :            :         dictEntry *de;
<span class="lineNum">    1008 </span>                :            :         double score;
<span class="lineNum">    1009 </span>                :            : 
<span class="lineNum">    1010 </span>        [<span class="branchCov" title="Branch 0 was taken 4623 times"> + </span><span class="branchCov" title="Branch 1 was taken 1158 times"> + </span>]:<span class="lineCov">       5781 :         for (j = 2; j &lt; c-&gt;argc; j++) {</span>
<span class="lineNum">    1011 </span>                :<span class="lineCov">       4623 :             de = dictFind(zs-&gt;dict,c-&gt;argv[j]);</span>
<span class="lineNum">    1012 </span>        [<span class="branchCov" title="Branch 0 was taken 3798 times"> + </span><span class="branchCov" title="Branch 1 was taken 825 times"> + </span>]:<span class="lineCov">       4623 :             if (de != NULL) {</span>
<span class="lineNum">    1013 </span>                :<span class="lineCov">       3798 :                 deleted++;</span>
<span class="lineNum">    1014 </span>                :            : 
<span class="lineNum">    1015 </span>                :            :                 /* Delete from the skiplist */
<span class="lineNum">    1016 </span>                :<span class="lineCov">       3798 :                 score = *(double*)dictGetVal(de);</span>
<span class="lineNum">    1017 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 3798 times"> + </span>]:<span class="lineCov">       3798 :                 redisAssertWithInfo(c,c-&gt;argv[j],zslDelete(zs-&gt;zsl,score,c-&gt;argv[j]));</span>
<span class="lineNum">    1018 </span>                :            : 
<span class="lineNum">    1019 </span>                :            :                 /* Delete from the hash table */
<span class="lineNum">    1020 </span>                :<span class="lineCov">       3798 :                 dictDelete(zs-&gt;dict,c-&gt;argv[j]);</span>
<span class="lineNum">    1021 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 3798 times"> + </span>]:<span class="lineCov">       3798 :                 if (htNeedsResize(zs-&gt;dict)) dictResize(zs-&gt;dict);</span>
<span class="lineNum">    1022 </span>        [<span class="branchCov" title="Branch 0 was taken 3458 times"> + </span><span class="branchCov" title="Branch 1 was taken 340 times"> + </span>]:<span class="lineCov">       3798 :                 if (dictSize(zs-&gt;dict) == 0) {</span>
<span class="lineNum">    1023 </span>                :<span class="lineCov">       3458 :                     dbDelete(c-&gt;db,key);</span>
<span class="lineNum">    1024 </span>                :<span class="lineCov">       3458 :                     break;</span>
<span class="lineNum">    1025 </span>                :            :                 }
<span class="lineNum">    1026 </span>                :            :             }
<span class="lineNum">    1027 </span>                :            :         }
<span class="lineNum">    1028 </span>                :            :     } else {
<span class="lineNum">    1029 </span>                :<span class="lineNoCov">          0 :         redisPanic(&quot;Unknown sorted set encoding&quot;);</span>
<span class="lineNum">    1030 </span>                :            :     }
<span class="lineNum">    1031 </span>                :            : 
<span class="lineNum">    1032 </span>        [<span class="branchCov" title="Branch 0 was taken 19265 times"> + </span><span class="branchCov" title="Branch 1 was taken 2772 times"> + </span>]:<span class="lineCov">      22037 :     if (deleted) {</span>
<span class="lineNum">    1033 </span>                :<span class="lineCov">      19265 :         notifyKeyspaceEvent(REDIS_NOTIFY_ZSET,&quot;zrem&quot;,key,c-&gt;db-&gt;id);</span>
<span class="lineNum">    1034 </span>                :            :         if (keyremoved)
<span class="lineNum">    1035 </span>                :            :             notifyKeyspaceEvent(REDIS_NOTIFY_GENERIC,&quot;del&quot;,key,c-&gt;db-&gt;id);
<span class="lineNum">    1036 </span>                :<span class="lineCov">      19265 :         signalModifiedKey(c-&gt;db,key);</span>
<span class="lineNum">    1037 </span>                :<span class="lineCov">      19265 :         server.dirty += deleted;</span>
<span class="lineNum">    1038 </span>                :            :     }
<span class="lineNum">    1039 </span>                :<span class="lineCov">      22037 :     addReplyLongLong(c,deleted);</span>
<a name="1040"><span class="lineNum">    1040 </span>                :            : }</a>
<span class="lineNum">    1041 </span>                :            : 
<span class="lineNum">    1042 </span>                :<span class="lineCov">         32 : void zremrangebyscoreCommand(redisClient *c) {</span>
<span class="lineNum">    1043 </span>                :<span class="lineCov">         32 :     robj *key = c-&gt;argv[1];</span>
<span class="lineNum">    1044 </span>                :            :     robj *zobj;
<span class="lineNum">    1045 </span>                :            :     zrangespec range;
<span class="lineNum">    1046 </span>                :<span class="lineCov">         32 :     int keyremoved = 0;</span>
<span class="lineNum">    1047 </span>                :            :     unsigned long deleted;
<span class="lineNum">    1048 </span>                :            : 
<span class="lineNum">    1049 </span>                :            :     /* Parse the range arguments. */
<span class="lineNum">    1050 </span>        [<span class="branchCov" title="Branch 1 was taken 6 times"> + </span><span class="branchCov" title="Branch 2 was taken 26 times"> + </span>]:<span class="lineCov">         32 :     if (zslParseRange(c-&gt;argv[2],c-&gt;argv[3],&amp;range) != REDIS_OK) {</span>
<span class="lineNum">    1051 </span>                :<span class="lineCov">          6 :         addReplyError(c,&quot;min or max is not a float&quot;);</span>
<span class="lineNum">    1052 </span>                :<span class="lineCov">          6 :         return;</span>
<span class="lineNum">    1053 </span>                :            :     }
<span class="lineNum">    1054 </span>                :            : 
<span class="lineNum">    1055 </span>  [<span class="branchCov" title="Branch 1 was taken 26 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 26 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         52 :     if ((zobj = lookupKeyWriteOrReply(c,key,shared.czero)) == NULL ||</span>
<span class="lineNum">    1056 </span>                :<span class="lineCov">         26 :         checkType(c,zobj,REDIS_ZSET)) return;</span>
<span class="lineNum">    1057 </span>                :            : 
<span class="lineNum">    1058 </span>        [<span class="branchCov" title="Branch 0 was taken 13 times"> + </span><span class="branchCov" title="Branch 1 was taken 13 times"> + </span>]:<span class="lineCov">         26 :     if (zobj-&gt;encoding == REDIS_ENCODING_ZIPLIST) {</span>
<span class="lineNum">    1059 </span>                :<span class="lineCov">         13 :         zobj-&gt;ptr = zzlDeleteRangeByScore(zobj-&gt;ptr,range,&amp;deleted);</span>
<span class="lineNum">    1060 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 11 times"> + </span>]:<span class="lineCov">         13 :         if (zzlLength(zobj-&gt;ptr) == 0) {</span>
<span class="lineNum">    1061 </span>                :<span class="lineCov">          2 :             dbDelete(c-&gt;db,key);</span>
<span class="lineNum">    1062 </span>                :<span class="lineCov">          2 :             keyremoved = 1;</span>
<span class="lineNum">    1063 </span>                :            :         }
<span class="lineNum">    1064 </span>        [<span class="branchCov" title="Branch 0 was taken 13 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         13 :     } else if (zobj-&gt;encoding == REDIS_ENCODING_SKIPLIST) {</span>
<span class="lineNum">    1065 </span>                :<span class="lineCov">         13 :         zset *zs = zobj-&gt;ptr;</span>
<span class="lineNum">    1066 </span>                :<span class="lineCov">         13 :         deleted = zslDeleteRangeByScore(zs-&gt;zsl,range,zs-&gt;dict);</span>
<span class="lineNum">    1067 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 13 times"> + </span>]:<span class="lineCov">         13 :         if (htNeedsResize(zs-&gt;dict)) dictResize(zs-&gt;dict);</span>
<span class="lineNum">    1068 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 11 times"> + </span>]:<span class="lineCov">         13 :         if (dictSize(zs-&gt;dict) == 0) {</span>
<span class="lineNum">    1069 </span>                :<span class="lineCov">          2 :             dbDelete(c-&gt;db,key);</span>
<span class="lineNum">    1070 </span>                :<span class="lineCov">          2 :             keyremoved = 1;</span>
<span class="lineNum">    1071 </span>                :            :         }
<span class="lineNum">    1072 </span>                :            :     } else {
<span class="lineNum">    1073 </span>                :<span class="lineNoCov">          0 :         redisPanic(&quot;Unknown sorted set encoding&quot;);</span>
<span class="lineNum">    1074 </span>                :            :     }
<span class="lineNum">    1075 </span>                :            : 
<span class="lineNum">    1076 </span>        [<span class="branchCov" title="Branch 0 was taken 24 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">         26 :     if (deleted) {</span>
<span class="lineNum">    1077 </span>                :<span class="lineCov">         24 :         signalModifiedKey(c-&gt;db,key);</span>
<span class="lineNum">    1078 </span>                :<span class="lineCov">         24 :         notifyKeyspaceEvent(REDIS_NOTIFY_ZSET,&quot;zrembyscore&quot;,key,c-&gt;db-&gt;id);</span>
<span class="lineNum">    1079 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 20 times"> + </span>]:<span class="lineCov">         24 :         if (keyremoved)</span>
<span class="lineNum">    1080 </span>                :<span class="lineCov">          4 :             notifyKeyspaceEvent(REDIS_NOTIFY_GENERIC,&quot;del&quot;,key,c-&gt;db-&gt;id);</span>
<span class="lineNum">    1081 </span>                :            :     }
<span class="lineNum">    1082 </span>                :<span class="lineCov">         26 :     server.dirty += deleted;</span>
<span class="lineNum">    1083 </span>                :<span class="lineCov">         32 :     addReplyLongLong(c,deleted);</span>
<a name="1084"><span class="lineNum">    1084 </span>                :            : }</a>
<span class="lineNum">    1085 </span>                :            : 
<span class="lineNum">    1086 </span>                :<span class="lineCov">         12 : void zremrangebyrankCommand(redisClient *c) {</span>
<span class="lineNum">    1087 </span>                :<span class="lineCov">         12 :     robj *key = c-&gt;argv[1];</span>
<span class="lineNum">    1088 </span>                :            :     robj *zobj;
<span class="lineNum">    1089 </span>                :            :     long start;
<span class="lineNum">    1090 </span>                :            :     long end;
<span class="lineNum">    1091 </span>                :            :     int llen;
<span class="lineNum">    1092 </span>                :            :     unsigned long deleted;
<span class="lineNum">    1093 </span>                :<span class="lineCov">         12 :     int keyremoved = 0;</span>
<span class="lineNum">    1094 </span>                :            : 
<span class="lineNum">    1095 </span>  [<span class="branchCov" title="Branch 1 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         24 :     if ((getLongFromObjectOrReply(c, c-&gt;argv[2], &amp;start, NULL) != REDIS_OK) ||</span>
<span class="lineNum">    1096 </span>                :<span class="lineCov">         12 :         (getLongFromObjectOrReply(c, c-&gt;argv[3], &amp;end, NULL) != REDIS_OK)) return;</span>
<span class="lineNum">    1097 </span>                :            : 
<span class="lineNum">    1098 </span>  [<span class="branchCov" title="Branch 1 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         24 :     if ((zobj = lookupKeyWriteOrReply(c,key,shared.czero)) == NULL ||</span>
<span class="lineNum">    1099 </span>                :<span class="lineCov">         12 :         checkType(c,zobj,REDIS_ZSET)) return;</span>
<span class="lineNum">    1100 </span>                :            : 
<span class="lineNum">    1101 </span>                :            :     /* Sanitize indexes. */
<span class="lineNum">    1102 </span>                :<span class="lineCov">         12 :     llen = zsetLength(zobj);</span>
<span class="lineNum">    1103 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 10 times"> + </span>]:<span class="lineCov">         12 :     if (start &lt; 0) start = llen+start;</span>
<span class="lineNum">    1104 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>]:<span class="lineCov">         12 :     if (end &lt; 0) end = llen+end;</span>
<span class="lineNum">    1105 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 10 times"> + </span>]:<span class="lineCov">         12 :     if (start &lt; 0) start = 0;</span>
<span class="lineNum">    1106 </span>                :            : 
<span class="lineNum">    1107 </span>                :            :     /* Invariant: start &gt;= 0, so this test will be true when end &lt; 0.
<span class="lineNum">    1108 </span>                :            :      * The range is empty when start &gt; end or start &gt;= length. */
<span class="lineNum">    1109 </span>[<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 8 times"> + </span>]:<span class="lineCov">         12 :     if (start &gt; end || start &gt;= llen) {</span>
<span class="lineNum">    1110 </span>                :<span class="lineCov">          4 :         addReply(c,shared.czero);</span>
<span class="lineNum">    1111 </span>                :<span class="lineCov">          4 :         return;</span>
<span class="lineNum">    1112 </span>                :            :     }
<span class="lineNum">    1113 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">          8 :     if (end &gt;= llen) end = llen-1;</span>
<span class="lineNum">    1114 </span>                :            : 
<span class="lineNum">    1115 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">          8 :     if (zobj-&gt;encoding == REDIS_ENCODING_ZIPLIST) {</span>
<span class="lineNum">    1116 </span>                :            :         /* Correct for 1-based rank. */
<span class="lineNum">    1117 </span>                :<span class="lineCov">          4 :         zobj-&gt;ptr = zzlDeleteRangeByRank(zobj-&gt;ptr,start+1,end+1,&amp;deleted);</span>
<span class="lineNum">    1118 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span>]:<span class="lineCov">          4 :         if (zzlLength(zobj-&gt;ptr) == 0) {</span>
<span class="lineNum">    1119 </span>                :<span class="lineCov">          2 :             dbDelete(c-&gt;db,key);</span>
<span class="lineNum">    1120 </span>                :<span class="lineCov">          2 :             keyremoved = 1;</span>
<span class="lineNum">    1121 </span>                :            :         }
<span class="lineNum">    1122 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          4 :     } else if (zobj-&gt;encoding == REDIS_ENCODING_SKIPLIST) {</span>
<span class="lineNum">    1123 </span>                :<span class="lineCov">          4 :         zset *zs = zobj-&gt;ptr;</span>
<span class="lineNum">    1124 </span>                :            : 
<span class="lineNum">    1125 </span>                :            :         /* Correct for 1-based rank. */
<span class="lineNum">    1126 </span>                :<span class="lineCov">          4 :         deleted = zslDeleteRangeByRank(zs-&gt;zsl,start+1,end+1,zs-&gt;dict);</span>
<span class="lineNum">    1127 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span>]:<span class="lineCov">          4 :         if (htNeedsResize(zs-&gt;dict)) dictResize(zs-&gt;dict);</span>
<span class="lineNum">    1128 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          4 :         if (dictSize(zs-&gt;dict) == 0) {</span>
<span class="lineNum">    1129 </span>                :<span class="lineCov">          2 :             dbDelete(c-&gt;db,key);</span>
<span class="lineNum">    1130 </span>                :<span class="lineCov">          2 :             keyremoved = 1;</span>
<span class="lineNum">    1131 </span>                :            :         }
<span class="lineNum">    1132 </span>                :            :     } else {
<span class="lineNum">    1133 </span>                :<span class="lineNoCov">          0 :         redisPanic(&quot;Unknown sorted set encoding&quot;);</span>
<span class="lineNum">    1134 </span>                :            :     }
<span class="lineNum">    1135 </span>                :            : 
<span class="lineNum">    1136 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          8 :     if (deleted) {</span>
<span class="lineNum">    1137 </span>                :<span class="lineCov">          8 :         signalModifiedKey(c-&gt;db,key);</span>
<span class="lineNum">    1138 </span>                :<span class="lineCov">          8 :         notifyKeyspaceEvent(REDIS_NOTIFY_ZSET,&quot;zrembyrank&quot;,key,c-&gt;db-&gt;id);</span>
<span class="lineNum">    1139 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">          8 :         if (keyremoved)</span>
<span class="lineNum">    1140 </span>                :<span class="lineCov">          4 :             notifyKeyspaceEvent(REDIS_NOTIFY_GENERIC,&quot;del&quot;,key,c-&gt;db-&gt;id);</span>
<span class="lineNum">    1141 </span>                :            :     }
<span class="lineNum">    1142 </span>                :<span class="lineCov">          8 :     server.dirty += deleted;</span>
<span class="lineNum">    1143 </span>                :<span class="lineCov">         12 :     addReplyLongLong(c,deleted);</span>
<span class="lineNum">    1144 </span>                :            : }
<span class="lineNum">    1145 </span>                :            : 
<span class="lineNum">    1146 </span>                :            : typedef struct {
<span class="lineNum">    1147 </span>                :            :     robj *subject;
<span class="lineNum">    1148 </span>                :            :     int type; /* Set, sorted set */
<span class="lineNum">    1149 </span>                :            :     int encoding;
<span class="lineNum">    1150 </span>                :            :     double weight;
<span class="lineNum">    1151 </span>                :            : 
<span class="lineNum">    1152 </span>                :            :     union {
<span class="lineNum">    1153 </span>                :            :         /* Set iterators. */
<span class="lineNum">    1154 </span>                :            :         union _iterset {
<span class="lineNum">    1155 </span>                :            :             struct {
<span class="lineNum">    1156 </span>                :            :                 intset *is;
<span class="lineNum">    1157 </span>                :            :                 int ii;
<span class="lineNum">    1158 </span>                :            :             } is;
<span class="lineNum">    1159 </span>                :            :             struct {
<span class="lineNum">    1160 </span>                :            :                 dict *dict;
<span class="lineNum">    1161 </span>                :            :                 dictIterator *di;
<span class="lineNum">    1162 </span>                :            :                 dictEntry *de;
<span class="lineNum">    1163 </span>                :            :             } ht;
<span class="lineNum">    1164 </span>                :            :         } set;
<span class="lineNum">    1165 </span>                :            : 
<span class="lineNum">    1166 </span>                :            :         /* Sorted set iterators. */
<span class="lineNum">    1167 </span>                :            :         union _iterzset {
<span class="lineNum">    1168 </span>                :            :             struct {
<span class="lineNum">    1169 </span>                :            :                 unsigned char *zl;
<span class="lineNum">    1170 </span>                :            :                 unsigned char *eptr, *sptr;
<span class="lineNum">    1171 </span>                :            :             } zl;
<span class="lineNum">    1172 </span>                :            :             struct {
<span class="lineNum">    1173 </span>                :            :                 zset *zs;
<span class="lineNum">    1174 </span>                :            :                 zskiplistNode *node;
<span class="lineNum">    1175 </span>                :            :             } sl;
<span class="lineNum">    1176 </span>                :            :         } zset;
<span class="lineNum">    1177 </span>                :            :     } iter;
<span class="lineNum">    1178 </span>                :            : } zsetopsrc;
<span class="lineNum">    1179 </span>                :            : 
<span class="lineNum">    1180 </span>                :            : 
<span class="lineNum">    1181 </span>                :            : /* Use dirty flags for pointers that need to be cleaned up in the next
<span class="lineNum">    1182 </span>                :            :  * iteration over the zsetopval. The dirty flag for the long long value is
<span class="lineNum">    1183 </span>                :            :  * special, since long long values don't need cleanup. Instead, it means that
<span class="lineNum">    1184 </span>                :            :  * we already checked that &quot;ell&quot; holds a long long, or tried to convert another
<span class="lineNum">    1185 </span>                :            :  * representation into a long long value. When this was successful,
<span class="lineNum">    1186 </span>                :            :  * OPVAL_VALID_LL is set as well. */
<span class="lineNum">    1187 </span>                :            : #define OPVAL_DIRTY_ROBJ 1
<span class="lineNum">    1188 </span>                :            : #define OPVAL_DIRTY_LL 2
<span class="lineNum">    1189 </span>                :            : #define OPVAL_VALID_LL 4
<span class="lineNum">    1190 </span>                :            : 
<span class="lineNum">    1191 </span>                :            : /* Store value retrieved from the iterator. */
<span class="lineNum">    1192 </span>                :            : typedef struct {
<span class="lineNum">    1193 </span>                :            :     int flags;
<span class="lineNum">    1194 </span>                :            :     unsigned char _buf[32]; /* Private buffer. */
<span class="lineNum">    1195 </span>                :            :     robj *ele;
<span class="lineNum">    1196 </span>                :            :     unsigned char *estr;
<span class="lineNum">    1197 </span>                :            :     unsigned int elen;
<span class="lineNum">    1198 </span>                :            :     long long ell;
<span class="lineNum">    1199 </span>                :            :     double score;
<span class="lineNum">    1200 </span>                :            : } zsetopval;
<span class="lineNum">    1201 </span>                :            : 
<span class="lineNum">    1202 </span>                :            : typedef union _iterset iterset;
<a name="1203"><span class="lineNum">    1203 </span>                :            : typedef union _iterzset iterzset;</a>
<span class="lineNum">    1204 </span>                :            : 
<span class="lineNum">    1205 </span>                :<span class="lineCov">      38438 : void zuiInitIterator(zsetopsrc *op) {</span>
<span class="lineNum">    1206 </span>        [<span class="branchCov" title="Branch 0 was taken 38434 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">      38438 :     if (op-&gt;subject == NULL)</span>
<span class="lineNum">    1207 </span>                :<span class="lineCov">      38438 :         return;</span>
<span class="lineNum">    1208 </span>                :            : 
<span class="lineNum">    1209 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 38426 times"> + </span>]:<span class="lineCov">      38434 :     if (op-&gt;type == REDIS_SET) {</span>
<span class="lineNum">    1210 </span>                :<span class="lineCov">          8 :         iterset *it = &amp;op-&gt;iter.set;</span>
<span class="lineNum">    1211 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">          8 :         if (op-&gt;encoding == REDIS_ENCODING_INTSET) {</span>
<span class="lineNum">    1212 </span>                :<span class="lineCov">          3 :             it-&gt;is.is = op-&gt;subject-&gt;ptr;</span>
<span class="lineNum">    1213 </span>                :<span class="lineCov">          3 :             it-&gt;is.ii = 0;</span>
<span class="lineNum">    1214 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          5 :         } else if (op-&gt;encoding == REDIS_ENCODING_HT) {</span>
<span class="lineNum">    1215 </span>                :<span class="lineCov">          5 :             it-&gt;ht.dict = op-&gt;subject-&gt;ptr;</span>
<span class="lineNum">    1216 </span>                :<span class="lineCov">          5 :             it-&gt;ht.di = dictGetIterator(op-&gt;subject-&gt;ptr);</span>
<span class="lineNum">    1217 </span>                :<span class="lineCov">          5 :             it-&gt;ht.de = dictNext(it-&gt;ht.di);</span>
<span class="lineNum">    1218 </span>                :            :         } else {
<span class="lineNum">    1219 </span>                :<span class="lineNoCov">          0 :             redisPanic(&quot;Unknown set encoding&quot;);</span>
<span class="lineNum">    1220 </span>                :            :         }
<span class="lineNum">    1221 </span>        [<span class="branchCov" title="Branch 0 was taken 38426 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      38426 :     } else if (op-&gt;type == REDIS_ZSET) {</span>
<span class="lineNum">    1222 </span>                :<span class="lineCov">      38426 :         iterzset *it = &amp;op-&gt;iter.zset;</span>
<span class="lineNum">    1223 </span>        [<span class="branchCov" title="Branch 0 was taken 29825 times"> + </span><span class="branchCov" title="Branch 1 was taken 8601 times"> + </span>]:<span class="lineCov">      38426 :         if (op-&gt;encoding == REDIS_ENCODING_ZIPLIST) {</span>
<span class="lineNum">    1224 </span>                :<span class="lineCov">      29825 :             it-&gt;zl.zl = op-&gt;subject-&gt;ptr;</span>
<span class="lineNum">    1225 </span>                :<span class="lineCov">      29825 :             it-&gt;zl.eptr = ziplistIndex(it-&gt;zl.zl,0);</span>
<span class="lineNum">    1226 </span>        [<span class="branchCov" title="Branch 0 was taken 29825 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      29825 :             if (it-&gt;zl.eptr != NULL) {</span>
<span class="lineNum">    1227 </span>                :<span class="lineCov">      29825 :                 it-&gt;zl.sptr = ziplistNext(it-&gt;zl.zl,it-&gt;zl.eptr);</span>
<span class="lineNum">    1228 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 29825 times"> + </span>]:<span class="lineCov">      29825 :                 redisAssert(it-&gt;zl.sptr != NULL);</span>
<span class="lineNum">    1229 </span>                :            :             }
<span class="lineNum">    1230 </span>        [<span class="branchCov" title="Branch 0 was taken 8601 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       8601 :         } else if (op-&gt;encoding == REDIS_ENCODING_SKIPLIST) {</span>
<span class="lineNum">    1231 </span>                :<span class="lineCov">       8601 :             it-&gt;sl.zs = op-&gt;subject-&gt;ptr;</span>
<span class="lineNum">    1232 </span>                :<span class="lineCov">       8601 :             it-&gt;sl.node = it-&gt;sl.zs-&gt;zsl-&gt;header-&gt;level[0].forward;</span>
<span class="lineNum">    1233 </span>                :            :         } else {
<span class="lineNum">    1234 </span>                :<span class="lineNoCov">          0 :             redisPanic(&quot;Unknown sorted set encoding&quot;);</span>
<span class="lineNum">    1235 </span>                :            :         }
<span class="lineNum">    1236 </span>                :            :     } else {
<span class="lineNum">    1237 </span>                :<span class="lineNoCov">          0 :         redisPanic(&quot;Unsupported type&quot;);</span>
<span class="lineNum">    1238 </span>                :            :     }
<a name="1239"><span class="lineNum">    1239 </span>                :            : }</a>
<span class="lineNum">    1240 </span>                :            : 
<span class="lineNum">    1241 </span>                :<span class="lineCov">      38438 : void zuiClearIterator(zsetopsrc *op) {</span>
<span class="lineNum">    1242 </span>        [<span class="branchCov" title="Branch 0 was taken 38434 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">      38438 :     if (op-&gt;subject == NULL)</span>
<span class="lineNum">    1243 </span>                :<span class="lineCov">      38438 :         return;</span>
<span class="lineNum">    1244 </span>                :            : 
<span class="lineNum">    1245 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 38426 times"> + </span>]:<span class="lineCov">      38434 :     if (op-&gt;type == REDIS_SET) {</span>
<span class="lineNum">    1246 </span>                :<span class="lineCov">          8 :         iterset *it = &amp;op-&gt;iter.set;</span>
<span class="lineNum">    1247 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          8 :         if (op-&gt;encoding == REDIS_ENCODING_INTSET) {</span>
<span class="lineNum">    1248 </span>                :            :             REDIS_NOTUSED(it); /* skip */
<span class="lineNum">    1249 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          5 :         } else if (op-&gt;encoding == REDIS_ENCODING_HT) {</span>
<span class="lineNum">    1250 </span>                :<span class="lineCov">          5 :             dictReleaseIterator(it-&gt;ht.di);</span>
<span class="lineNum">    1251 </span>                :            :         } else {
<span class="lineNum">    1252 </span>                :<span class="lineNoCov">          0 :             redisPanic(&quot;Unknown set encoding&quot;);</span>
<span class="lineNum">    1253 </span>                :            :         }
<span class="lineNum">    1254 </span>        [<span class="branchCov" title="Branch 0 was taken 38426 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      38426 :     } else if (op-&gt;type == REDIS_ZSET) {</span>
<span class="lineNum">    1255 </span>                :<span class="lineCov">      38426 :         iterzset *it = &amp;op-&gt;iter.zset;</span>
<span class="lineNum">    1256 </span>        [<span class="branchCov" title="Branch 0 was taken 8601 times"> + </span><span class="branchCov" title="Branch 1 was taken 29825 times"> + </span>]:<span class="lineCov">      38426 :         if (op-&gt;encoding == REDIS_ENCODING_ZIPLIST) {</span>
<span class="lineNum">    1257 </span>                :            :             REDIS_NOTUSED(it); /* skip */
<span class="lineNum">    1258 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 8601 times"> + </span>]:<span class="lineCov">       8601 :         } else if (op-&gt;encoding == REDIS_ENCODING_SKIPLIST) {</span>
<span class="lineNum">    1259 </span>                :            :             REDIS_NOTUSED(it); /* skip */
<span class="lineNum">    1260 </span>                :            :         } else {
<span class="lineNum">    1261 </span>                :<span class="lineNoCov">          0 :             redisPanic(&quot;Unknown sorted set encoding&quot;);</span>
<span class="lineNum">    1262 </span>                :            :         }
<span class="lineNum">    1263 </span>                :            :     } else {
<span class="lineNum">    1264 </span>                :<span class="lineNoCov">          0 :         redisPanic(&quot;Unsupported type&quot;);</span>
<span class="lineNum">    1265 </span>                :            :     }
<a name="1266"><span class="lineNum">    1266 </span>                :            : }</a>
<span class="lineNum">    1267 </span>                :            : 
<span class="lineNum">    1268 </span>                :<span class="lineCov">      68610 : int zuiLength(zsetopsrc *op) {</span>
<span class="lineNum">    1269 </span>        [<span class="branchCov" title="Branch 0 was taken 68604 times"> + </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">      68610 :     if (op-&gt;subject == NULL)</span>
<span class="lineNum">    1270 </span>                :            :         return 0;
<span class="lineNum">    1271 </span>                :            : 
<span class="lineNum">    1272 </span>        [<span class="branchCov" title="Branch 0 was taken 15 times"> + </span><span class="branchCov" title="Branch 1 was taken 68589 times"> + </span>]:<span class="lineCov">      68604 :     if (op-&gt;type == REDIS_SET) {</span>
<span class="lineNum">    1273 </span>                :<span class="lineCov">         15 :         iterset *it = &amp;op-&gt;iter.set;</span>
<span class="lineNum">    1274 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchCov" title="Branch 1 was taken 10 times"> + </span>]:<span class="lineCov">         15 :         if (op-&gt;encoding == REDIS_ENCODING_INTSET) {</span>
<span class="lineNum">    1275 </span>                :<span class="lineCov">          5 :             return intsetLen(it-&gt;is.is);</span>
<span class="lineNum">    1276 </span>        [<span class="branchCov" title="Branch 0 was taken 10 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         10 :         } else if (op-&gt;encoding == REDIS_ENCODING_HT) {</span>
<span class="lineNum">    1277 </span>                :<span class="lineCov">         10 :             return dictSize(it-&gt;ht.dict);</span>
<span class="lineNum">    1278 </span>                :            :         } else {
<span class="lineNum">    1279 </span>                :<span class="lineNoCov">          0 :             redisPanic(&quot;Unknown set encoding&quot;);</span>
<span class="lineNum">    1280 </span>                :            :         }
<span class="lineNum">    1281 </span>        [<span class="branchCov" title="Branch 0 was taken 68589 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      68589 :     } else if (op-&gt;type == REDIS_ZSET) {</span>
<span class="lineNum">    1282 </span>                :<span class="lineCov">      68589 :         iterzset *it = &amp;op-&gt;iter.zset;</span>
<span class="lineNum">    1283 </span>        [<span class="branchCov" title="Branch 0 was taken 53528 times"> + </span><span class="branchCov" title="Branch 1 was taken 15061 times"> + </span>]:<span class="lineCov">      68589 :         if (op-&gt;encoding == REDIS_ENCODING_ZIPLIST) {</span>
<span class="lineNum">    1284 </span>                :<span class="lineCov">      53528 :             return zzlLength(it-&gt;zl.zl);</span>
<span class="lineNum">    1285 </span>        [<span class="branchCov" title="Branch 0 was taken 15061 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      15061 :         } else if (op-&gt;encoding == REDIS_ENCODING_SKIPLIST) {</span>
<span class="lineNum">    1286 </span>                :<span class="lineCov">      15061 :             return it-&gt;sl.zs-&gt;zsl-&gt;length;</span>
<span class="lineNum">    1287 </span>                :            :         } else {
<span class="lineNum">    1288 </span>                :<span class="lineNoCov">          0 :             redisPanic(&quot;Unknown sorted set encoding&quot;);</span>
<span class="lineNum">    1289 </span>                :            :         }
<span class="lineNum">    1290 </span>                :            :     } else {
<span class="lineNum">    1291 </span>                :<span class="lineCov">      68610 :         redisPanic(&quot;Unsupported type&quot;);</span>
<span class="lineNum">    1292 </span>                :            :     }
<span class="lineNum">    1293 </span>                :            : }
<span class="lineNum">    1294 </span>                :            : 
<span class="lineNum">    1295 </span>                :            : /* Check if the current value is valid. If so, store it in the passed structure
<a name="1296"><span class="lineNum">    1296 </span>                :            :  * and move to the next element. If not valid, this means we have reached the</a>
<span class="lineNum">    1297 </span>                :            :  * end of the structure and can abort. */
<span class="lineNum">    1298 </span>                :<span class="lineCov">      65097 : int zuiNext(zsetopsrc *op, zsetopval *val) {</span>
<span class="lineNum">    1299 </span>        [<span class="branchCov" title="Branch 0 was taken 65097 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      65097 :     if (op-&gt;subject == NULL)</span>
<span class="lineNum">    1300 </span>                :            :         return 0;
<span class="lineNum">    1301 </span>                :            : 
<span class="lineNum">    1302 </span>        [<span class="branchCov" title="Branch 0 was taken 26329 times"> + </span><span class="branchCov" title="Branch 1 was taken 38768 times"> + </span>]:<span class="lineCov">      65097 :     if (val-&gt;flags &amp; OPVAL_DIRTY_ROBJ)</span>
<span class="lineNum">    1303 </span>                :<span class="lineCov">      26329 :         decrRefCount(val-&gt;ele);</span>
<span class="lineNum">    1304 </span>                :            : 
<span class="lineNum">    1305 </span>                :            :     memset(val,0,sizeof(zsetopval));
<span class="lineNum">    1306 </span>                :            : 
<span class="lineNum">    1307 </span>        [<span class="branchCov" title="Branch 0 was taken 23 times"> + </span><span class="branchCov" title="Branch 1 was taken 65074 times"> + </span>]:<span class="lineCov">      65097 :     if (op-&gt;type == REDIS_SET) {</span>
<span class="lineNum">    1308 </span>                :<span class="lineCov">         23 :         iterset *it = &amp;op-&gt;iter.set;</span>
<span class="lineNum">    1309 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchCov" title="Branch 1 was taken 18 times"> + </span>]:<span class="lineCov">         23 :         if (op-&gt;encoding == REDIS_ENCODING_INTSET) {</span>
<span class="lineNum">    1310 </span>                :            :             int64_t ell;
<span class="lineNum">    1311 </span>                :            : 
<span class="lineNum">    1312 </span>        [<span class="branchCov" title="Branch 1 was taken 4 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">          5 :             if (!intsetGet(it-&gt;is.is,it-&gt;is.ii,&amp;ell))</span>
<span class="lineNum">    1313 </span>                :            :                 return 0;
<span class="lineNum">    1314 </span>                :<span class="lineCov">          4 :             val-&gt;ell = ell;</span>
<span class="lineNum">    1315 </span>                :<span class="lineCov">          4 :             val-&gt;score = 1.0;</span>
<span class="lineNum">    1316 </span>                :            : 
<span class="lineNum">    1317 </span>                :            :             /* Move to next element. */
<span class="lineNum">    1318 </span>                :<span class="lineCov">          4 :             it-&gt;is.ii++;</span>
<span class="lineNum">    1319 </span>        [<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         18 :         } else if (op-&gt;encoding == REDIS_ENCODING_HT) {</span>
<span class="lineNum">    1320 </span>        [<span class="branchCov" title="Branch 0 was taken 13 times"> + </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">         18 :             if (it-&gt;ht.de == NULL)</span>
<span class="lineNum">    1321 </span>                :            :                 return 0;
<span class="lineNum">    1322 </span>                :<span class="lineCov">         13 :             val-&gt;ele = dictGetKey(it-&gt;ht.de);</span>
<span class="lineNum">    1323 </span>                :<span class="lineCov">         13 :             val-&gt;score = 1.0;</span>
<span class="lineNum">    1324 </span>                :            : 
<span class="lineNum">    1325 </span>                :            :             /* Move to next element. */
<span class="lineNum">    1326 </span>                :<span class="lineCov">         13 :             it-&gt;ht.de = dictNext(it-&gt;ht.di);</span>
<span class="lineNum">    1327 </span>                :            :         } else {
<span class="lineNum">    1328 </span>                :<span class="lineNoCov">          0 :             redisPanic(&quot;Unknown set encoding&quot;);</span>
<span class="lineNum">    1329 </span>                :            :         }
<span class="lineNum">    1330 </span>        [<span class="branchCov" title="Branch 0 was taken 65074 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      65074 :     } else if (op-&gt;type == REDIS_ZSET) {</span>
<span class="lineNum">    1331 </span>                :<span class="lineCov">      65074 :         iterzset *it = &amp;op-&gt;iter.zset;</span>
<span class="lineNum">    1332 </span>        [<span class="branchCov" title="Branch 0 was taken 50031 times"> + </span><span class="branchCov" title="Branch 1 was taken 15043 times"> + </span>]:<span class="lineCov">      65074 :         if (op-&gt;encoding == REDIS_ENCODING_ZIPLIST) {</span>
<span class="lineNum">    1333 </span>                :            :             /* No need to check both, but better be explicit. */
<span class="lineNum">    1334 </span>[<span class="branchCov" title="Branch 0 was taken 26328 times"> + </span><span class="branchCov" title="Branch 1 was taken 23703 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 26328 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">      50031 :             if (it-&gt;zl.eptr == NULL || it-&gt;zl.sptr == NULL)</span>
<span class="lineNum">    1335 </span>                :            :                 return 0;
<span class="lineNum">    1336 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 26328 times"> + </span>]:<span class="lineCov">      26328 :             redisAssert(ziplistGet(it-&gt;zl.eptr,&amp;val-&gt;estr,&amp;val-&gt;elen,&amp;val-&gt;ell));</span>
<span class="lineNum">    1337 </span>                :<span class="lineCov">      26328 :             val-&gt;score = zzlGetScore(it-&gt;zl.sptr);</span>
<span class="lineNum">    1338 </span>                :            : 
<span class="lineNum">    1339 </span>                :            :             /* Move to next element. */
<span class="lineNum">    1340 </span>                :<span class="lineCov">      26328 :             zzlNext(it-&gt;zl.zl,&amp;it-&gt;zl.eptr,&amp;it-&gt;zl.sptr);</span>
<span class="lineNum">    1341 </span>        [<span class="branchCov" title="Branch 0 was taken 15043 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      15043 :         } else if (op-&gt;encoding == REDIS_ENCODING_SKIPLIST) {</span>
<span class="lineNum">    1342 </span>        [<span class="branchCov" title="Branch 0 was taken 8582 times"> + </span><span class="branchCov" title="Branch 1 was taken 6461 times"> + </span>]:<span class="lineCov">      15043 :             if (it-&gt;sl.node == NULL)</span>
<span class="lineNum">    1343 </span>                :            :                 return 0;
<span class="lineNum">    1344 </span>                :<span class="lineCov">       8582 :             val-&gt;ele = it-&gt;sl.node-&gt;obj;</span>
<span class="lineNum">    1345 </span>                :<span class="lineCov">       8582 :             val-&gt;score = it-&gt;sl.node-&gt;score;</span>
<span class="lineNum">    1346 </span>                :            : 
<span class="lineNum">    1347 </span>                :            :             /* Move to next element. */
<span class="lineNum">    1348 </span>                :<span class="lineCov">       8582 :             it-&gt;sl.node = it-&gt;sl.node-&gt;level[0].forward;</span>
<span class="lineNum">    1349 </span>                :            :         } else {
<span class="lineNum">    1350 </span>                :<span class="lineNoCov">          0 :             redisPanic(&quot;Unknown sorted set encoding&quot;);</span>
<span class="lineNum">    1351 </span>                :            :         }
<span class="lineNum">    1352 </span>                :            :     } else {
<span class="lineNum">    1353 </span>                :<span class="lineCov">      65097 :         redisPanic(&quot;Unsupported type&quot;);</span>
<span class="lineNum">    1354 </span>                :            :     }
<span class="lineNum">    1355 </span>                :            :     return 1;
<a name="1356"><span class="lineNum">    1356 </span>                :            : }</a>
<span class="lineNum">    1357 </span>                :            : 
<span class="lineNum">    1358 </span>                :<span class="lineCov">          5 : int zuiLongLongFromValue(zsetopval *val) {</span>
<span class="lineNum">    1359 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          5 :     if (!(val-&gt;flags &amp; OPVAL_DIRTY_LL)) {</span>
<span class="lineNum">    1360 </span>                :<span class="lineCov">          5 :         val-&gt;flags |= OPVAL_DIRTY_LL;</span>
<span class="lineNum">    1361 </span>                :            : 
<span class="lineNum">    1362 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">          5 :         if (val-&gt;ele != NULL) {</span>
<span class="lineNum">    1363 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :             if (val-&gt;ele-&gt;encoding == REDIS_ENCODING_INT) {</span>
<span class="lineNum">    1364 </span>                :<span class="lineNoCov">          0 :                 val-&gt;ell = (long)val-&gt;ele-&gt;ptr;</span>
<span class="lineNum">    1365 </span>                :<span class="lineNoCov">          0 :                 val-&gt;flags |= OPVAL_VALID_LL;</span>
<span class="lineNum">    1366 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :             } else if (sdsEncodedObject(val-&gt;ele)) {</span>
<span class="lineNum">    1367 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                 if (string2ll(val-&gt;ele-&gt;ptr,sdslen(val-&gt;ele-&gt;ptr),&amp;val-&gt;ell))</span>
<span class="lineNum">    1368 </span>                :<span class="lineNoCov">          0 :                     val-&gt;flags |= OPVAL_VALID_LL;</span>
<span class="lineNum">    1369 </span>                :            :             } else {
<span class="lineNum">    1370 </span>                :<span class="lineNoCov">          0 :                 redisPanic(&quot;Unsupported element encoding&quot;);</span>
<span class="lineNum">    1371 </span>                :            :             }
<span class="lineNum">    1372 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">          4 :         } else if (val-&gt;estr != NULL) {</span>
<span class="lineNum">    1373 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (string2ll((char*)val-&gt;estr,val-&gt;elen,&amp;val-&gt;ell))</span>
<span class="lineNum">    1374 </span>                :<span class="lineNoCov">          0 :                 val-&gt;flags |= OPVAL_VALID_LL;</span>
<span class="lineNum">    1375 </span>                :            :         } else {
<span class="lineNum">    1376 </span>                :            :             /* The long long was already set, flag as valid. */
<span class="lineNum">    1377 </span>                :<span class="lineCov">          4 :             val-&gt;flags |= OPVAL_VALID_LL;</span>
<span class="lineNum">    1378 </span>                :            :         }
<span class="lineNum">    1379 </span>                :            :     }
<span class="lineNum">    1380 </span>                :<span class="lineCov">          5 :     return val-&gt;flags &amp; OPVAL_VALID_LL;</span>
<a name="1381"><span class="lineNum">    1381 </span>                :            : }</a>
<span class="lineNum">    1382 </span>                :            : 
<span class="lineNum">    1383 </span>                :<span class="lineCov">      72469 : robj *zuiObjectFromValue(zsetopval *val) {</span>
<span class="lineNum">    1384 </span>        [<span class="branchCov" title="Branch 0 was taken 26329 times"> + </span><span class="branchCov" title="Branch 1 was taken 46140 times"> + </span>]:<span class="lineCov">      72469 :     if (val-&gt;ele == NULL) {</span>
<span class="lineNum">    1385 </span>        [<span class="branchCov" title="Branch 0 was taken 1944 times"> + </span><span class="branchCov" title="Branch 1 was taken 24385 times"> + </span>]:<span class="lineCov">      26329 :         if (val-&gt;estr != NULL) {</span>
<span class="lineNum">    1386 </span>                :<span class="lineCov">       1944 :             val-&gt;ele = createStringObject((char*)val-&gt;estr,val-&gt;elen);</span>
<span class="lineNum">    1387 </span>                :            :         } else {
<span class="lineNum">    1388 </span>                :<span class="lineCov">      24385 :             val-&gt;ele = createStringObjectFromLongLong(val-&gt;ell);</span>
<span class="lineNum">    1389 </span>                :            :         }
<span class="lineNum">    1390 </span>                :<span class="lineCov">      26329 :         val-&gt;flags |= OPVAL_DIRTY_ROBJ;</span>
<span class="lineNum">    1391 </span>                :            :     }
<span class="lineNum">    1392 </span>                :<span class="lineCov">      72469 :     return val-&gt;ele;</span>
<a name="1393"><span class="lineNum">    1393 </span>                :            : }</a>
<span class="lineNum">    1394 </span>                :            : 
<span class="lineNum">    1395 </span>                :<span class="lineNoCov">          0 : int zuiBufferFromValue(zsetopval *val) {</span>
<span class="lineNum">    1396 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (val-&gt;estr == NULL) {</span>
<span class="lineNum">    1397 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (val-&gt;ele != NULL) {</span>
<span class="lineNum">    1398 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (val-&gt;ele-&gt;encoding == REDIS_ENCODING_INT) {</span>
<span class="lineNum">    1399 </span>                :<span class="lineNoCov">          0 :                 val-&gt;elen = ll2string((char*)val-&gt;_buf,sizeof(val-&gt;_buf),(long)val-&gt;ele-&gt;ptr);</span>
<span class="lineNum">    1400 </span>                :<span class="lineNoCov">          0 :                 val-&gt;estr = val-&gt;_buf;</span>
<span class="lineNum">    1401 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             } else if (sdsEncodedObject(val-&gt;ele)) {</span>
<span class="lineNum">    1402 </span>                :<span class="lineNoCov">          0 :                 val-&gt;elen = sdslen(val-&gt;ele-&gt;ptr);</span>
<span class="lineNum">    1403 </span>                :<span class="lineNoCov">          0 :                 val-&gt;estr = val-&gt;ele-&gt;ptr;</span>
<span class="lineNum">    1404 </span>                :            :             } else {
<span class="lineNum">    1405 </span>                :<span class="lineNoCov">          0 :                 redisPanic(&quot;Unsupported element encoding&quot;);</span>
<span class="lineNum">    1406 </span>                :            :             }
<span class="lineNum">    1407 </span>                :            :         } else {
<span class="lineNum">    1408 </span>                :<span class="lineNoCov">          0 :             val-&gt;elen = ll2string((char*)val-&gt;_buf,sizeof(val-&gt;_buf),val-&gt;ell);</span>
<span class="lineNum">    1409 </span>                :<span class="lineNoCov">          0 :             val-&gt;estr = val-&gt;_buf;</span>
<span class="lineNum">    1410 </span>                :            :         }
<span class="lineNum">    1411 </span>                :            :     }
<span class="lineNum">    1412 </span>                :<span class="lineNoCov">          0 :     return 1;</span>
<span class="lineNum">    1413 </span>                :            : }
<span class="lineNum">    1414 </span>                :            : 
<a name="1415"><span class="lineNum">    1415 </span>                :            : /* Find value pointed to by val in the source pointer to by op. When found,</a>
<span class="lineNum">    1416 </span>                :            :  * return 1 and store its score in target. Return 0 otherwise. */
<span class="lineNum">    1417 </span>                :<span class="lineCov">      19468 : int zuiFind(zsetopsrc *op, zsetopval *val, double *score) {</span>
<span class="lineNum">    1418 </span>        [<span class="branchCov" title="Branch 0 was taken 19468 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      19468 :     if (op-&gt;subject == NULL)</span>
<span class="lineNum">    1419 </span>                :            :         return 0;
<span class="lineNum">    1420 </span>                :            : 
<span class="lineNum">    1421 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchCov" title="Branch 1 was taken 19463 times"> + </span>]:<span class="lineCov">      19468 :     if (op-&gt;type == REDIS_SET) {</span>
<span class="lineNum">    1422 </span>                :<span class="lineCov">          5 :         iterset *it = &amp;op-&gt;iter.set;</span>
<span class="lineNum">    1423 </span>                :            : 
<span class="lineNum">    1424 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          5 :         if (op-&gt;encoding == REDIS_ENCODING_INTSET) {</span>
<span class="lineNum">    1425 </span>[<span class="branchCov" title="Branch 1 was taken 4 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>][<span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchCov" title="Branch 5 was taken 3 times"> + </span>]:<span class="lineCov">          5 :             if (zuiLongLongFromValue(val) &amp;&amp; intsetFind(it-&gt;is.is,val-&gt;ell)) {</span>
<span class="lineNum">    1426 </span>                :<span class="lineCov">          1 :                 *score = 1.0;</span>
<span class="lineNum">    1427 </span>                :<span class="lineCov">          1 :                 return 1;</span>
<span class="lineNum">    1428 </span>                :            :             } else {
<span class="lineNum">    1429 </span>                :            :                 return 0;
<span class="lineNum">    1430 </span>                :            :             }
<span class="lineNum">    1431 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         } else if (op-&gt;encoding == REDIS_ENCODING_HT) {</span>
<span class="lineNum">    1432 </span>                :<span class="lineNoCov">          0 :             zuiObjectFromValue(val);</span>
<span class="lineNum">    1433 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (dictFind(it-&gt;ht.dict,val-&gt;ele) != NULL) {</span>
<span class="lineNum">    1434 </span>                :<span class="lineNoCov">          0 :                 *score = 1.0;</span>
<span class="lineNum">    1435 </span>                :<span class="lineNoCov">          0 :                 return 1;</span>
<span class="lineNum">    1436 </span>                :            :             } else {
<span class="lineNum">    1437 </span>                :            :                 return 0;
<span class="lineNum">    1438 </span>                :            :             }
<span class="lineNum">    1439 </span>                :            :         } else {
<span class="lineNum">    1440 </span>                :<span class="lineNoCov">          0 :             redisPanic(&quot;Unknown set encoding&quot;);</span>
<span class="lineNum">    1441 </span>                :            :         }
<span class="lineNum">    1442 </span>        [<span class="branchCov" title="Branch 0 was taken 19463 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      19463 :     } else if (op-&gt;type == REDIS_ZSET) {</span>
<span class="lineNum">    1443 </span>                :<span class="lineCov">      19463 :         iterzset *it = &amp;op-&gt;iter.zset;</span>
<span class="lineNum">    1444 </span>                :<span class="lineCov">      19463 :         zuiObjectFromValue(val);</span>
<span class="lineNum">    1445 </span>                :            : 
<span class="lineNum">    1446 </span>        [<span class="branchCov" title="Branch 0 was taken 14403 times"> + </span><span class="branchCov" title="Branch 1 was taken 5060 times"> + </span>]:<span class="lineCov">      19463 :         if (op-&gt;encoding == REDIS_ENCODING_ZIPLIST) {</span>
<span class="lineNum">    1447 </span>        [<span class="branchCov" title="Branch 1 was taken 14369 times"> + </span><span class="branchCov" title="Branch 2 was taken 34 times"> + </span>]:<span class="lineCov">      14403 :             if (zzlFind(it-&gt;zl.zl,val-&gt;ele,score) != NULL) {</span>
<span class="lineNum">    1448 </span>                :            :                 /* Score is already set by zzlFind. */
<span class="lineNum">    1449 </span>                :            :                 return 1;
<span class="lineNum">    1450 </span>                :            :             } else {
<span class="lineNum">    1451 </span>                :<span class="lineCov">      14369 :                 return 0;</span>
<span class="lineNum">    1452 </span>                :            :             }
<span class="lineNum">    1453 </span>        [<span class="branchCov" title="Branch 0 was taken 5060 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       5060 :         } else if (op-&gt;encoding == REDIS_ENCODING_SKIPLIST) {</span>
<span class="lineNum">    1454 </span>                :            :             dictEntry *de;
<span class="lineNum">    1455 </span>        [<span class="branchCov" title="Branch 1 was taken 34 times"> + </span><span class="branchCov" title="Branch 2 was taken 5026 times"> + </span>]:<span class="lineCov">       5060 :             if ((de = dictFind(it-&gt;sl.zs-&gt;dict,val-&gt;ele)) != NULL) {</span>
<span class="lineNum">    1456 </span>                :<span class="lineCov">         34 :                 *score = *(double*)dictGetVal(de);</span>
<span class="lineNum">    1457 </span>                :<span class="lineCov">         34 :                 return 1;</span>
<span class="lineNum">    1458 </span>                :            :             } else {
<span class="lineNum">    1459 </span>                :            :                 return 0;
<span class="lineNum">    1460 </span>                :            :             }
<span class="lineNum">    1461 </span>                :            :         } else {
<span class="lineNum">    1462 </span>                :<span class="lineNoCov">          0 :             redisPanic(&quot;Unknown sorted set encoding&quot;);</span>
<span class="lineNum">    1463 </span>                :            :         }
<span class="lineNum">    1464 </span>                :            :     } else {
<span class="lineNum">    1465 </span>                :<span class="lineCov">      19468 :         redisPanic(&quot;Unsupported type&quot;);</span>
<span class="lineNum">    1466 </span>                :            :     }
<a name="1467"><span class="lineNum">    1467 </span>                :            : }</a>
<span class="lineNum">    1468 </span>                :            : 
<span class="lineNum">    1469 </span>                :<span class="lineCov">      19218 : int zuiCompareByCardinality(const void *s1, const void *s2) {</span>
<span class="lineNum">    1470 </span>                :<span class="lineCov">      19218 :     return zuiLength((zsetopsrc*)s1) - zuiLength((zsetopsrc*)s2);</span>
<span class="lineNum">    1471 </span>                :            : }
<span class="lineNum">    1472 </span>                :            : 
<span class="lineNum">    1473 </span>                :            : #define REDIS_AGGR_SUM 1
<span class="lineNum">    1474 </span>                :            : #define REDIS_AGGR_MIN 2
<span class="lineNum">    1475 </span>                :            : #define REDIS_AGGR_MAX 3
<a name="1476"><span class="lineNum">    1476 </span>                :            : #define zunionInterDictValue(_e) (dictGetVal(_e) == NULL ? 1.0 : *(double*)dictGetVal(_e))</a>
<span class="lineNum">    1477 </span>                :            : 
<span class="lineNum">    1478 </span>                :<span class="lineCov">        207 : inline static void zunionInterAggregate(double *target, double val, int aggregate) {</span>
<span class="lineNum">    1479 </span>        [<span class="branchCov" title="Branch 0 was taken 191 times"> + </span><span class="branchCov" title="Branch 1 was taken 16 times"> + </span>]:<span class="lineCov">        207 :     if (aggregate == REDIS_AGGR_SUM) {</span>
<span class="lineNum">    1480 </span>                :<span class="lineCov">        191 :         *target = *target + val;</span>
<span class="lineNum">    1481 </span>                :            :         /* The result of adding two doubles is NaN when one variable
<span class="lineNum">    1482 </span>                :            :          * is +inf and the other is -inf. When these numbers are added,
<span class="lineNum">    1483 </span>                :            :          * we maintain the convention of the result being 0.0. */
<span class="lineNum">    1484 </span>        [<span class="branchCov" title="Branch 1 was taken 8 times"> + </span><span class="branchCov" title="Branch 2 was taken 183 times"> + </span>]:<span class="lineCov">        191 :         if (isnan(*target)) *target = 0.0;</span>
<span class="lineNum">    1485 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>]:<span class="lineCov">         16 :     } else if (aggregate == REDIS_AGGR_MIN) {</span>
<span class="lineNum">    1486 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>]:<span class="lineCov">          8 :         *target = val &lt; *target ? val : *target;</span>
<span class="lineNum">    1487 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          8 :     } else if (aggregate == REDIS_AGGR_MAX) {</span>
<span class="lineNum">    1488 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          8 :         *target = val &gt; *target ? val : *target;</span>
<span class="lineNum">    1489 </span>                :            :     } else {
<span class="lineNum">    1490 </span>                :            :         /* safety net */
<span class="lineNum">    1491 </span>                :<span class="lineNoCov">          0 :         redisPanic(&quot;Unknown ZUNION/INTER aggregate type&quot;);</span>
<span class="lineNum">    1492 </span>                :            :     }
<a name="1493"><span class="lineNum">    1493 </span>                :<span class="lineCov">        207 : }</span></a>
<span class="lineNum">    1494 </span>                :            : 
<span class="lineNum">    1495 </span>                :<span class="lineCov">      19224 : void zunionInterGenericCommand(redisClient *c, robj *dstkey, int op) {</span>
<span class="lineNum">    1496 </span>                :            :     int i, j;
<span class="lineNum">    1497 </span>                :            :     long setnum;
<span class="lineNum">    1498 </span>                :<span class="lineCov">      19224 :     int aggregate = REDIS_AGGR_SUM;</span>
<span class="lineNum">    1499 </span>                :            :     zsetopsrc *src;
<span class="lineNum">    1500 </span>                :            :     zsetopval zval;
<span class="lineNum">    1501 </span>                :            :     robj *tmp;
<span class="lineNum">    1502 </span>                :<span class="lineCov">      19224 :     unsigned int maxelelen = 0;</span>
<span class="lineNum">    1503 </span>                :            :     robj *dstobj;
<span class="lineNum">    1504 </span>                :            :     zset *dstzset;
<span class="lineNum">    1505 </span>                :            :     zskiplistNode *znode;
<span class="lineNum">    1506 </span>                :<span class="lineCov">      19224 :     int touched = 0;</span>
<span class="lineNum">    1507 </span>                :            : 
<span class="lineNum">    1508 </span>                :            :     /* expect setnum input keys to be given */
<span class="lineNum">    1509 </span>        [<span class="branchCov" title="Branch 1 was taken 19224 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      19224 :     if ((getLongFromObjectOrReply(c, c-&gt;argv[2], &amp;setnum, NULL) != REDIS_OK))</span>
<span class="lineNum">    1510 </span>                :            :         return;
<span class="lineNum">    1511 </span>                :            : 
<span class="lineNum">    1512 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 19224 times"> + </span>]:<span class="lineCov">      19224 :     if (setnum &lt; 1) {</span>
<span class="lineNum">    1513 </span>                :<span class="lineNoCov">          0 :         addReplyError(c,</span>
<span class="lineNum">    1514 </span>                :            :             &quot;at least 1 input key is needed for ZUNIONSTORE/ZINTERSTORE&quot;);
<span class="lineNum">    1515 </span>                :<span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    1516 </span>                :            :     }
<span class="lineNum">    1517 </span>                :            : 
<span class="lineNum">    1518 </span>                :            :     /* test if the expected number of keys would overflow */
<span class="lineNum">    1519 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 19224 times"> + </span>]:<span class="lineCov">      19224 :     if (setnum &gt; c-&gt;argc-3) {</span>
<span class="lineNum">    1520 </span>                :<span class="lineNoCov">          0 :         addReply(c,shared.syntaxerr);</span>
<span class="lineNum">    1521 </span>                :<span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    1522 </span>                :            :     }
<span class="lineNum">    1523 </span>                :            : 
<span class="lineNum">    1524 </span>                :            :     /* read keys to be used for input */
<span class="lineNum">    1525 </span>                :<span class="lineCov">      19224 :     src = zcalloc(sizeof(zsetopsrc) * setnum);</span>
<span class="lineNum">    1526 </span>        [<span class="branchCov" title="Branch 1 was taken 38446 times"> + </span><span class="branchCov" title="Branch 2 was taken 19224 times"> + </span>]:<span class="lineCov">      57670 :     for (i = 0, j = 3; i &lt; setnum; i++, j++) {</span>
<span class="lineNum">    1527 </span>                :<span class="lineCov">      38446 :         robj *obj = lookupKeyWrite(c-&gt;db,c-&gt;argv[j]);</span>
<span class="lineNum">    1528 </span>        [<span class="branchCov" title="Branch 0 was taken 38442 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">      38446 :         if (obj != NULL) {</span>
<span class="lineNum">    1529 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 38442 times"> + </span>]:<span class="lineCov">      38442 :             if (obj-&gt;type != REDIS_ZSET &amp;&amp; obj-&gt;type != REDIS_SET) {</span>
<span class="lineNum">    1530 </span>                :<span class="lineNoCov">          0 :                 zfree(src);</span>
<span class="lineNum">    1531 </span>                :<span class="lineNoCov">          0 :                 addReply(c,shared.wrongtypeerr);</span>
<span class="lineNum">    1532 </span>                :<span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1533 </span>                :            :             }
<span class="lineNum">    1534 </span>                :            : 
<span class="lineNum">    1535 </span>                :<span class="lineCov">      38442 :             src[i].subject = obj;</span>
<span class="lineNum">    1536 </span>                :<span class="lineCov">      38442 :             src[i].type = obj-&gt;type;</span>
<span class="lineNum">    1537 </span>                :<span class="lineCov">      38442 :             src[i].encoding = obj-&gt;encoding;</span>
<span class="lineNum">    1538 </span>                :            :         } else {
<span class="lineNum">    1539 </span>                :<span class="lineCov">          4 :             src[i].subject = NULL;</span>
<span class="lineNum">    1540 </span>                :            :         }
<span class="lineNum">    1541 </span>                :            : 
<span class="lineNum">    1542 </span>                :            :         /* Default all weights to 1. */
<span class="lineNum">    1543 </span>                :<span class="lineCov">      38446 :         src[i].weight = 1.0;</span>
<span class="lineNum">    1544 </span>                :            :     }
<span class="lineNum">    1545 </span>                :            : 
<span class="lineNum">    1546 </span>                :            :     /* parse optional extra arguments */
<span class="lineNum">    1547 </span>        [<span class="branchCov" title="Branch 0 was taken 22 times"> + </span><span class="branchCov" title="Branch 1 was taken 19202 times"> + </span>]:<span class="lineCov">      19224 :     if (j &lt; c-&gt;argc) {</span>
<span class="lineNum">    1548 </span>                :<span class="lineCov">         22 :         int remaining = c-&gt;argc - j;</span>
<span class="lineNum">    1549 </span>                :            : 
<span class="lineNum">    1550 </span>        [<span class="branchCov" title="Branch 0 was taken 22 times"> + </span><span class="branchCov" title="Branch 1 was taken 18 times"> + </span>]:<span class="lineCov">         40 :         while (remaining) {</span>
<span class="lineNum">    1551 </span>[<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         22 :             if (remaining &gt;= (setnum + 1) &amp;&amp; !strcasecmp(c-&gt;argv[j]-&gt;ptr,&quot;weights&quot;)) {</span>
<span class="lineNum">    1552 </span>                :<span class="lineCov">         14 :                 j++; remaining--;</span>
<span class="lineNum">    1553 </span>        [<span class="branchCov" title="Branch 0 was taken 24 times"> + </span><span class="branchCov" title="Branch 1 was taken 10 times"> + </span>]:<span class="lineCov">         34 :                 for (i = 0; i &lt; setnum; i++, j++, remaining--) {</span>
<span class="lineNum">    1554 </span>        [<span class="branchCov" title="Branch 1 was taken 4 times"> + </span><span class="branchCov" title="Branch 2 was taken 20 times"> + </span>]:<span class="lineCov">         24 :                     if (getDoubleFromObjectOrReply(c,c-&gt;argv[j],&amp;src[i].weight,</span>
<span class="lineNum">    1555 </span>                :            :                             &quot;weight value is not a float&quot;) != REDIS_OK)
<span class="lineNum">    1556 </span>                :            :                     {
<span class="lineNum">    1557 </span>                :<span class="lineCov">          4 :                         zfree(src);</span>
<span class="lineNum">    1558 </span>                :<span class="lineCov">          4 :                         return;</span>
<span class="lineNum">    1559 </span>                :            :                     }
<span class="lineNum">    1560 </span>                :            :                 }
<span class="lineNum">    1561 </span>[<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          8 :             } else if (remaining &gt;= 2 &amp;&amp; !strcasecmp(c-&gt;argv[j]-&gt;ptr,&quot;aggregate&quot;)) {</span>
<span class="lineNum">    1562 </span>                :<span class="lineCov">          8 :                 j++; remaining--;</span>
<span class="lineNum">    1563 </span>        [<span class="branchCov" title="Branch 1 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          8 :                 if (!strcasecmp(c-&gt;argv[j]-&gt;ptr,&quot;sum&quot;)) {</span>
<span class="lineNum">    1564 </span>                :            :                     aggregate = REDIS_AGGR_SUM;
<span class="lineNum">    1565 </span>        [<span class="branchCov" title="Branch 1 was taken 4 times"> + </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span>]:<span class="lineCov">          8 :                 } else if (!strcasecmp(c-&gt;argv[j]-&gt;ptr,&quot;min&quot;)) {</span>
<span class="lineNum">    1566 </span>                :            :                     aggregate = REDIS_AGGR_MIN;
<span class="lineNum">    1567 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span>]:<span class="lineCov">          4 :                 } else if (!strcasecmp(c-&gt;argv[j]-&gt;ptr,&quot;max&quot;)) {</span>
<span class="lineNum">    1568 </span>                :            :                     aggregate = REDIS_AGGR_MAX;
<span class="lineNum">    1569 </span>                :            :                 } else {
<span class="lineNum">    1570 </span>                :<span class="lineNoCov">          0 :                     zfree(src);</span>
<span class="lineNum">    1571 </span>                :<span class="lineNoCov">          0 :                     addReply(c,shared.syntaxerr);</span>
<span class="lineNum">    1572 </span>                :<span class="lineNoCov">          0 :                     return;</span>
<span class="lineNum">    1573 </span>                :            :                 }
<span class="lineNum">    1574 </span>                :<span class="lineCov">          8 :                 j++; remaining--;</span>
<span class="lineNum">    1575 </span>                :            :             } else {
<span class="lineNum">    1576 </span>                :<span class="lineNoCov">          0 :                 zfree(src);</span>
<span class="lineNum">    1577 </span>                :<span class="lineNoCov">          0 :                 addReply(c,shared.syntaxerr);</span>
<span class="lineNum">    1578 </span>                :<span class="lineCov">         18 :                 return;</span>
<span class="lineNum">    1579 </span>                :            :             }
<span class="lineNum">    1580 </span>                :            :         }
<span class="lineNum">    1581 </span>                :            :     }
<span class="lineNum">    1582 </span>                :            : 
<span class="lineNum">    1583 </span>        [<span class="branchCov" title="Branch 0 was taken 38438 times"> + </span><span class="branchCov" title="Branch 1 was taken 19220 times"> + </span>]:<span class="lineCov">      57658 :     for (i = 0; i &lt; setnum; i++)</span>
<span class="lineNum">    1584 </span>                :<span class="lineCov">      38438 :         zuiInitIterator(&amp;src[i]);</span>
<span class="lineNum">    1585 </span>                :            : 
<span class="lineNum">    1586 </span>                :            :     /* sort sets from the smallest to largest, this will improve our
<span class="lineNum">    1587 </span>                :            :      * algorithm's performance */
<span class="lineNum">    1588 </span>                :<span class="lineCov">      19220 :     qsort(src,setnum,sizeof(zsetopsrc),zuiCompareByCardinality);</span>
<span class="lineNum">    1589 </span>                :            : 
<span class="lineNum">    1590 </span>                :<span class="lineCov">      19220 :     dstobj = createZsetObject();</span>
<span class="lineNum">    1591 </span>                :<span class="lineCov">      19220 :     dstzset = dstobj-&gt;ptr;</span>
<span class="lineNum">    1592 </span>                :            :     memset(&amp;zval, 0, sizeof(zval));
<span class="lineNum">    1593 </span>                :            : 
<span class="lineNum">    1594 </span>        [<span class="branchCov" title="Branch 0 was taken 8263 times"> + </span><span class="branchCov" title="Branch 1 was taken 10957 times"> + </span>]:<span class="lineCov">      19220 :     if (op == REDIS_OP_INTER) {</span>
<span class="lineNum">    1595 </span>                :            :         /* Skip everything if the smallest input is empty. */
<span class="lineNum">    1596 </span>        [<span class="branchCov" title="Branch 1 was taken 8263 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       8263 :         if (zuiLength(&amp;src[0]) &gt; 0) {</span>
<span class="lineNum">    1597 </span>                :            :             /* Precondition: as src[0] is non-empty and the inputs are ordered
<span class="lineNum">    1598 </span>                :            :              * by size, all src[i &gt; 0] are non-empty too. */
<span class="lineNum">    1599 </span>        [<span class="branchCov" title="Branch 1 was taken 8447 times"> + </span><span class="branchCov" title="Branch 2 was taken 8263 times"> + </span>]:<span class="lineCov">      16710 :             while (zuiNext(&amp;src[0],&amp;zval)) {</span>
<span class="lineNum">    1600 </span>                :            :                 double score, value;
<span class="lineNum">    1601 </span>                :            : 
<span class="lineNum">    1602 </span>                :<span class="lineCov">       8447 :                 score = src[0].weight * zval.score;</span>
<span class="lineNum">    1603 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 8447 times"> + </span>]:<span class="lineCov">       8447 :                 if (isnan(score)) score = 0;</span>
<span class="lineNum">    1604 </span>                :            : 
<span class="lineNum">    1605 </span>        [<span class="branchCov" title="Branch 0 was taken 8448 times"> + </span><span class="branchCov" title="Branch 1 was taken 126 times"> + </span>]:<span class="lineCov">       8574 :                 for (j = 1; j &lt; setnum; j++) {</span>
<span class="lineNum">    1606 </span>                :            :                     /* It is not safe to access the zset we are
<span class="lineNum">    1607 </span>                :            :                      * iterating, so explicitly check for equal object. */
<span class="lineNum">    1608 </span>        [<span class="branchCov" title="Branch 0 was taken 88 times"> + </span><span class="branchCov" title="Branch 1 was taken 8360 times"> + </span>]:<span class="lineCov">       8448 :                     if (src[j].subject == src[0].subject) {</span>
<span class="lineNum">    1609 </span>                :<span class="lineCov">         88 :                         value = zval.score*src[j].weight;</span>
<span class="lineNum">    1610 </span>                :<span class="lineCov">         88 :                         zunionInterAggregate(&amp;score,value,aggregate);</span>
<span class="lineNum">    1611 </span>        [<span class="branchCov" title="Branch 1 was taken 39 times"> + </span><span class="branchCov" title="Branch 2 was taken 8321 times"> + </span>]:<span class="lineCov">       8360 :                     } else if (zuiFind(&amp;src[j],&amp;zval,&amp;value)) {</span>
<span class="lineNum">    1612 </span>                :<span class="lineCov">         39 :                         value *= src[j].weight;</span>
<span class="lineNum">    1613 </span>                :<span class="lineCov">         39 :                         zunionInterAggregate(&amp;score,value,aggregate);</span>
<span class="lineNum">    1614 </span>                :            :                     } else {
<span class="lineNum">    1615 </span>                :            :                         break;
<span class="lineNum">    1616 </span>                :            :                     }
<span class="lineNum">    1617 </span>                :            :                 }
<span class="lineNum">    1618 </span>                :            : 
<span class="lineNum">    1619 </span>                :            :                 /* Only continue when present in every input. */
<span class="lineNum">    1620 </span>        [<span class="branchCov" title="Branch 0 was taken 126 times"> + </span><span class="branchCov" title="Branch 1 was taken 8321 times"> + </span>]:<span class="lineCov">       8447 :                 if (j == setnum) {</span>
<span class="lineNum">    1621 </span>                :<span class="lineCov">        126 :                     tmp = zuiObjectFromValue(&amp;zval);</span>
<span class="lineNum">    1622 </span>                :<span class="lineCov">        126 :                     znode = zslInsert(dstzset-&gt;zsl,score,tmp);</span>
<span class="lineNum">    1623 </span>                :<span class="lineCov">        126 :                     incrRefCount(tmp); /* added to skiplist */</span>
<span class="lineNum">    1624 </span>                :<span class="lineCov">        126 :                     dictAdd(dstzset-&gt;dict,tmp,&amp;znode-&gt;score);</span>
<span class="lineNum">    1625 </span>                :<span class="lineCov">        126 :                     incrRefCount(tmp); /* added to dictionary */</span>
<span class="lineNum">    1626 </span>                :            : 
<span class="lineNum">    1627 </span>        [<span class="branchCov" title="Branch 0 was taken 55 times"> + </span><span class="branchCov" title="Branch 1 was taken 71 times"> + </span>]:<span class="lineCov">        126 :                     if (sdsEncodedObject(tmp)) {</span>
<span class="lineNum">    1628 </span>        [<span class="branchCov" title="Branch 0 was taken 45 times"> + </span><span class="branchCov" title="Branch 1 was taken 10 times"> + </span>]:<span class="lineCov">         55 :                         if (sdslen(tmp-&gt;ptr) &gt; maxelelen)</span>
<span class="lineNum">    1629 </span>                :<span class="lineCov">       8389 :                             maxelelen = sdslen(tmp-&gt;ptr);</span>
<span class="lineNum">    1630 </span>                :            :                     }
<span class="lineNum">    1631 </span>                :            :                 }
<span class="lineNum">    1632 </span>                :            :             }
<span class="lineNum">    1633 </span>                :            :         }
<span class="lineNum">    1634 </span>        [<span class="branchCov" title="Branch 0 was taken 10957 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      10957 :     } else if (op == REDIS_OP_UNION) {</span>
<span class="lineNum">    1635 </span>        [<span class="branchCov" title="Branch 0 was taken 21911 times"> + </span><span class="branchCov" title="Branch 1 was taken 10957 times"> + </span>]:<span class="lineCov">      32868 :         for (i = 0; i &lt; setnum; i++) {</span>
<span class="lineNum">    1636 </span>        [<span class="branchCov" title="Branch 1 was taken 21907 times"> + </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span>]:<span class="lineCov">      21911 :             if (zuiLength(&amp;src[i]) == 0)</span>
<span class="lineNum">    1637 </span>                :<span class="lineCov">          4 :                 continue;</span>
<span class="lineNum">    1638 </span>                :            : 
<span class="lineNum">    1639 </span>        [<span class="branchCov" title="Branch 1 was taken 26480 times"> + </span><span class="branchCov" title="Branch 2 was taken 21907 times"> + </span>]:<span class="lineCov">      48387 :             while (zuiNext(&amp;src[i],&amp;zval)) {</span>
<span class="lineNum">    1640 </span>                :            :                 double score, value;
<span class="lineNum">    1641 </span>                :            : 
<span class="lineNum">    1642 </span>                :            :                 /* Skip key when already processed */
<span class="lineNum">    1643 </span>        [<span class="branchCov" title="Branch 2 was taken 80 times"> + </span><span class="branchCov" title="Branch 3 was taken 26400 times"> + </span>]:<span class="lineCov">      26480 :                 if (dictFind(dstzset-&gt;dict,zuiObjectFromValue(&amp;zval)) != NULL)</span>
<span class="lineNum">    1644 </span>                :<span class="lineCov">         80 :                     continue;</span>
<span class="lineNum">    1645 </span>                :            : 
<span class="lineNum">    1646 </span>                :            :                 /* Initialize score */
<span class="lineNum">    1647 </span>                :<span class="lineCov">      26400 :                 score = src[i].weight * zval.score;</span>
<span class="lineNum">    1648 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 26399 times"> + </span>]:<span class="lineCov">      26400 :                 if (isnan(score)) score = 0;</span>
<span class="lineNum">    1649 </span>                :            : 
<span class="lineNum">    1650 </span>                :            :                 /* Because the inputs are sorted by size, it's only possible
<span class="lineNum">    1651 </span>                :            :                  * for sets at larger indices to hold this element. */
<span class="lineNum">    1652 </span>        [<span class="branchCov" title="Branch 0 was taken 11158 times"> + </span><span class="branchCov" title="Branch 1 was taken 26400 times"> + </span>]:<span class="lineCov">      37558 :                 for (j = (i+1); j &lt; setnum; j++) {</span>
<span class="lineNum">    1653 </span>                :            :                     /* It is not safe to access the zset we are
<span class="lineNum">    1654 </span>                :            :                      * iterating, so explicitly check for equal object. */
<span class="lineNum">    1655 </span>        [<span class="branchCov" title="Branch 0 was taken 50 times"> + </span><span class="branchCov" title="Branch 1 was taken 11108 times"> + </span>]:<span class="lineCov">      11158 :                     if(src[j].subject == src[i].subject) {</span>
<span class="lineNum">    1656 </span>                :<span class="lineCov">         50 :                         value = zval.score*src[j].weight;</span>
<span class="lineNum">    1657 </span>                :<span class="lineCov">         50 :                         zunionInterAggregate(&amp;score,value,aggregate);</span>
<span class="lineNum">    1658 </span>        [<span class="branchCov" title="Branch 1 was taken 30 times"> + </span><span class="branchCov" title="Branch 2 was taken 11078 times"> + </span>]:<span class="lineCov">      11108 :                     } else if (zuiFind(&amp;src[j],&amp;zval,&amp;value)) {</span>
<span class="lineNum">    1659 </span>                :<span class="lineCov">         30 :                         value *= src[j].weight;</span>
<span class="lineNum">    1660 </span>                :<span class="lineCov">         30 :                         zunionInterAggregate(&amp;score,value,aggregate);</span>
<span class="lineNum">    1661 </span>                :            :                     }
<span class="lineNum">    1662 </span>                :            :                 }
<span class="lineNum">    1663 </span>                :            : 
<span class="lineNum">    1664 </span>                :<span class="lineCov">      26400 :                 tmp = zuiObjectFromValue(&amp;zval);</span>
<span class="lineNum">    1665 </span>                :<span class="lineCov">      26400 :                 znode = zslInsert(dstzset-&gt;zsl,score,tmp);</span>
<span class="lineNum">    1666 </span>                :<span class="lineCov">      26400 :                 incrRefCount(zval.ele); /* added to skiplist */</span>
<span class="lineNum">    1667 </span>                :<span class="lineCov">      26400 :                 dictAdd(dstzset-&gt;dict,tmp,&amp;znode-&gt;score);</span>
<span class="lineNum">    1668 </span>                :<span class="lineCov">      26400 :                 incrRefCount(zval.ele); /* added to dictionary */</span>
<span class="lineNum">    1669 </span>                :            : 
<span class="lineNum">    1670 </span>        [<span class="branchCov" title="Branch 0 was taken 6641 times"> + </span><span class="branchCov" title="Branch 1 was taken 19759 times"> + </span>]:<span class="lineCov">      26400 :                 if (sdsEncodedObject(tmp)) {</span>
<span class="lineNum">    1671 </span>        [<span class="branchCov" title="Branch 0 was taken 5949 times"> + </span><span class="branchCov" title="Branch 1 was taken 692 times"> + </span>]:<span class="lineCov">       6641 :                     if (sdslen(tmp-&gt;ptr) &gt; maxelelen)</span>
<span class="lineNum">    1672 </span>                :<span class="lineCov">      26480 :                         maxelelen = sdslen(tmp-&gt;ptr);</span>
<span class="lineNum">    1673 </span>                :            :                 }
<span class="lineNum">    1674 </span>                :            :             }
<span class="lineNum">    1675 </span>                :            :         }
<span class="lineNum">    1676 </span>                :            :     } else {
<span class="lineNum">    1677 </span>                :<span class="lineNoCov">          0 :         redisPanic(&quot;Unknown operator&quot;);</span>
<span class="lineNum">    1678 </span>                :            :     }
<span class="lineNum">    1679 </span>                :            : 
<span class="lineNum">    1680 </span>        [<span class="branchCov" title="Branch 0 was taken 38438 times"> + </span><span class="branchCov" title="Branch 1 was taken 19220 times"> + </span>]:<span class="lineCov">      57658 :     for (i = 0; i &lt; setnum; i++)</span>
<span class="lineNum">    1681 </span>                :<span class="lineCov">      38438 :         zuiClearIterator(&amp;src[i]);</span>
<span class="lineNum">    1682 </span>                :            : 
<span class="lineNum">    1683 </span>        [<span class="branchCov" title="Branch 1 was taken 2449 times"> + </span><span class="branchCov" title="Branch 2 was taken 16771 times"> + </span>]:<span class="lineCov">      19220 :     if (dbDelete(c-&gt;db,dstkey)) {</span>
<span class="lineNum">    1684 </span>                :<span class="lineCov">       2449 :         signalModifiedKey(c-&gt;db,dstkey);</span>
<span class="lineNum">    1685 </span>                :<span class="lineCov">       2449 :         touched = 1;</span>
<span class="lineNum">    1686 </span>                :<span class="lineCov">       2449 :         server.dirty++;</span>
<span class="lineNum">    1687 </span>                :            :     }
<span class="lineNum">    1688 </span>        [<span class="branchCov" title="Branch 0 was taken 11065 times"> + </span><span class="branchCov" title="Branch 1 was taken 8155 times"> + </span>]:<span class="lineCov">      19220 :     if (dstzset-&gt;zsl-&gt;length) {</span>
<span class="lineNum">    1689 </span>                :            :         /* Convert to ziplist when in limits. */
<span class="lineNum">    1690 </span>[<span class="branchCov" title="Branch 0 was taken 11044 times"> + </span><span class="branchCov" title="Branch 1 was taken 21 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 6679 times"> + </span><span class="branchCov" title="Branch 3 was taken 4365 times"> + </span>]:<span class="lineCov">      11065 :         if (dstzset-&gt;zsl-&gt;length &lt;= server.zset_max_ziplist_entries &amp;&amp;</span>
<span class="lineNum">    1691 </span>                :<span class="lineCov">      11044 :             maxelelen &lt;= server.zset_max_ziplist_value)</span>
<span class="lineNum">    1692 </span>                :<span class="lineCov">       6679 :                 zsetConvert(dstobj,REDIS_ENCODING_ZIPLIST);</span>
<span class="lineNum">    1693 </span>                :            : 
<span class="lineNum">    1694 </span>                :<span class="lineCov">      11065 :         dbAdd(c-&gt;db,dstkey,dstobj);</span>
<span class="lineNum">    1695 </span>                :<span class="lineCov">      11065 :         addReplyLongLong(c,zsetLength(dstobj));</span>
<span class="lineNum">    1696 </span>        [<span class="branchCov" title="Branch 0 was taken 9833 times"> + </span><span class="branchCov" title="Branch 1 was taken 1232 times"> + </span>]:<span class="lineCov">      11065 :         if (!touched) signalModifiedKey(c-&gt;db,dstkey);</span>
<span class="lineNum">    1697 </span>        [<span class="branchCov" title="Branch 0 was taken 110 times"> + </span><span class="branchCov" title="Branch 1 was taken 10955 times"> + </span>]:<span class="lineCov">      11065 :         notifyKeyspaceEvent(REDIS_NOTIFY_ZSET,</span>
<span class="lineNum">    1698 </span>                :            :             (op == REDIS_OP_UNION) ? &quot;zunionstore&quot; : &quot;zinterstore&quot;,
<span class="lineNum">    1699 </span>                :<span class="lineCov">      11065 :             dstkey,c-&gt;db-&gt;id);</span>
<span class="lineNum">    1700 </span>                :<span class="lineCov">      11065 :         server.dirty++;</span>
<span class="lineNum">    1701 </span>                :            :     } else {
<span class="lineNum">    1702 </span>                :<span class="lineCov">       8155 :         decrRefCount(dstobj);</span>
<span class="lineNum">    1703 </span>                :<span class="lineCov">       8155 :         addReply(c,shared.czero);</span>
<span class="lineNum">    1704 </span>        [<span class="branchCov" title="Branch 0 was taken 1217 times"> + </span><span class="branchCov" title="Branch 1 was taken 6938 times"> + </span>]:<span class="lineCov">       8155 :         if (touched)</span>
<span class="lineNum">    1705 </span>                :<span class="lineCov">       1217 :             notifyKeyspaceEvent(REDIS_NOTIFY_GENERIC,&quot;del&quot;,dstkey,c-&gt;db-&gt;id);</span>
<span class="lineNum">    1706 </span>                :            :     }
<span class="lineNum">    1707 </span>                :<span class="lineCov">      19224 :     zfree(src);</span>
<a name="1708"><span class="lineNum">    1708 </span>                :            : }</a>
<span class="lineNum">    1709 </span>                :            : 
<span class="lineNum">    1710 </span>                :<span class="lineCov">      10959 : void zunionstoreCommand(redisClient *c) {</span>
<span class="lineNum">    1711 </span>                :<span class="lineCov">      10959 :     zunionInterGenericCommand(c,c-&gt;argv[1], REDIS_OP_UNION);</span>
<a name="1712"><span class="lineNum">    1712 </span>                :<span class="lineCov">      10959 : }</span></a>
<span class="lineNum">    1713 </span>                :            : 
<span class="lineNum">    1714 </span>                :<span class="lineCov">       8265 : void zinterstoreCommand(redisClient *c) {</span>
<span class="lineNum">    1715 </span>                :<span class="lineCov">       8265 :     zunionInterGenericCommand(c,c-&gt;argv[1], REDIS_OP_INTER);</span>
<a name="1716"><span class="lineNum">    1716 </span>                :<span class="lineCov">       8265 : }</span></a>
<span class="lineNum">    1717 </span>                :            : 
<span class="lineNum">    1718 </span>                :<span class="lineCov">       4142 : void zrangeGenericCommand(redisClient *c, int reverse) {</span>
<span class="lineNum">    1719 </span>                :<span class="lineCov">       4142 :     robj *key = c-&gt;argv[1];</span>
<span class="lineNum">    1720 </span>                :            :     robj *zobj;
<span class="lineNum">    1721 </span>                :<span class="lineCov">       4142 :     int withscores = 0;</span>
<span class="lineNum">    1722 </span>                :            :     long start;
<span class="lineNum">    1723 </span>                :            :     long end;
<span class="lineNum">    1724 </span>                :            :     int llen;
<span class="lineNum">    1725 </span>                :            :     int rangelen;
<span class="lineNum">    1726 </span>                :            : 
<span class="lineNum">    1727 </span>  [<span class="branchCov" title="Branch 1 was taken 4142 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 4142 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       8284 :     if ((getLongFromObjectOrReply(c, c-&gt;argv[2], &amp;start, NULL) != REDIS_OK) ||</span>
<span class="lineNum">    1728 </span>                :<span class="lineCov">       4142 :         (getLongFromObjectOrReply(c, c-&gt;argv[3], &amp;end, NULL) != REDIS_OK)) return;</span>
<span class="lineNum">    1729 </span>                :            : 
<span class="lineNum">    1730 </span>[<span class="branchCov" title="Branch 0 was taken 33 times"> + </span><span class="branchCov" title="Branch 1 was taken 4109 times"> + </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 33 times"> + </span>]:<span class="lineCov">       4142 :     if (c-&gt;argc == 5 &amp;&amp; !strcasecmp(c-&gt;argv[4]-&gt;ptr,&quot;withscores&quot;)) {</span>
<span class="lineNum">    1731 </span>                :            :         withscores = 1;
<span class="lineNum">    1732 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4109 times"> + </span>]:<span class="lineCov">       4109 :     } else if (c-&gt;argc &gt;= 5) {</span>
<span class="lineNum">    1733 </span>                :<span class="lineNoCov">          0 :         addReply(c,shared.syntaxerr);</span>
<span class="lineNum">    1734 </span>                :<span class="lineCov">       4142 :         return;</span>
<span class="lineNum">    1735 </span>                :            :     }
<span class="lineNum">    1736 </span>                :            : 
<span class="lineNum">    1737 </span>        [<span class="branchCov" title="Branch 1 was taken 4138 times"> + </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span>]:<span class="lineCov">       4142 :     if ((zobj = lookupKeyReadOrReply(c,key,shared.emptymultibulk)) == NULL</span>
<span class="lineNum">    1738 </span>        [<span class="branchCov" title="Branch 1 was taken 4138 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       4138 :          || checkType(c,zobj,REDIS_ZSET)) return;</span>
<span class="lineNum">    1739 </span>                :            : 
<span class="lineNum">    1740 </span>                :            :     /* Sanitize indexes. */
<span class="lineNum">    1741 </span>                :<span class="lineCov">       4138 :     llen = zsetLength(zobj);</span>
<span class="lineNum">    1742 </span>        [<span class="branchCov" title="Branch 0 was taken 16 times"> + </span><span class="branchCov" title="Branch 1 was taken 4122 times"> + </span>]:<span class="lineCov">       4138 :     if (start &lt; 0) start = llen+start;</span>
<span class="lineNum">    1743 </span>        [<span class="branchCov" title="Branch 0 was taken 123 times"> + </span><span class="branchCov" title="Branch 1 was taken 4015 times"> + </span>]:<span class="lineCov">       4138 :     if (end &lt; 0) end = llen+end;</span>
<span class="lineNum">    1744 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 4130 times"> + </span>]:<span class="lineCov">       4138 :     if (start &lt; 0) start = 0;</span>
<span class="lineNum">    1745 </span>                :            : 
<span class="lineNum">    1746 </span>                :            :     /* Invariant: start &gt;= 0, so this test will be true when end &lt; 0.
<span class="lineNum">    1747 </span>                :            :      * The range is empty when start &gt; end or start &gt;= length. */
<span class="lineNum">    1748 </span>[<span class="branchCov" title="Branch 0 was taken 4122 times"> + </span><span class="branchCov" title="Branch 1 was taken 16 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 4122 times"> + </span>]:<span class="lineCov">       4138 :     if (start &gt; end || start &gt;= llen) {</span>
<span class="lineNum">    1749 </span>                :<span class="lineCov">         16 :         addReply(c,shared.emptymultibulk);</span>
<span class="lineNum">    1750 </span>                :<span class="lineCov">         16 :         return;</span>
<span class="lineNum">    1751 </span>                :            :     }
<span class="lineNum">    1752 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 4114 times"> + </span>]:<span class="lineCov">       4122 :     if (end &gt;= llen) end = llen-1;</span>
<span class="lineNum">    1753 </span>                :<span class="lineCov">       4122 :     rangelen = (end-start)+1;</span>
<span class="lineNum">    1754 </span>                :            : 
<span class="lineNum">    1755 </span>                :            :     /* Return the result in form of a multi-bulk reply */
<span class="lineNum">    1756 </span>        [<span class="branchCov" title="Branch 0 was taken 33 times"> + </span><span class="branchCov" title="Branch 1 was taken 4089 times"> + </span>]:<span class="lineCov">       4122 :     addReplyMultiBulkLen(c, withscores ? (rangelen*2) : rangelen);</span>
<span class="lineNum">    1757 </span>                :            : 
<span class="lineNum">    1758 </span>        [<span class="branchCov" title="Branch 0 was taken 2062 times"> + </span><span class="branchCov" title="Branch 1 was taken 2060 times"> + </span>]:<span class="lineCov">       4122 :     if (zobj-&gt;encoding == REDIS_ENCODING_ZIPLIST) {</span>
<span class="lineNum">    1759 </span>                :<span class="lineCov">       2062 :         unsigned char *zl = zobj-&gt;ptr;</span>
<span class="lineNum">    1760 </span>                :            :         unsigned char *eptr, *sptr;
<span class="lineNum">    1761 </span>                :            :         unsigned char *vstr;
<span class="lineNum">    1762 </span>                :            :         unsigned int vlen;
<span class="lineNum">    1763 </span>                :            :         long long vlong;
<span class="lineNum">    1764 </span>                :            : 
<span class="lineNum">    1765 </span>        [<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchCov" title="Branch 1 was taken 2050 times"> + </span>]:<span class="lineCov">       2062 :         if (reverse)</span>
<span class="lineNum">    1766 </span>                :<span class="lineCov">         12 :             eptr = ziplistIndex(zl,-2-(2*start));</span>
<span class="lineNum">    1767 </span>                :            :         else
<span class="lineNum">    1768 </span>                :<span class="lineCov">       2050 :             eptr = ziplistIndex(zl,2*start);</span>
<span class="lineNum">    1769 </span>                :            : 
<span class="lineNum">    1770 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2062 times"> + </span>]:<span class="lineCov">       2062 :         redisAssertWithInfo(c,zobj,eptr != NULL);</span>
<span class="lineNum">    1771 </span>                :<span class="lineCov">       2062 :         sptr = ziplistNext(zl,eptr);</span>
<span class="lineNum">    1772 </span>                :            : 
<span class="lineNum">    1773 </span>        [<span class="branchCov" title="Branch 0 was taken 2954 times"> + </span><span class="branchCov" title="Branch 1 was taken 2062 times"> + </span>]:<span class="lineCov">       5016 :         while (rangelen--) {</span>
<span class="lineNum">    1774 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2954 times"> + </span>]:<span class="lineCov">       2954 :             redisAssertWithInfo(c,zobj,eptr != NULL &amp;&amp; sptr != NULL);</span>
<span class="lineNum">    1775 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2954 times"> + </span>]:<span class="lineCov">       2954 :             redisAssertWithInfo(c,zobj,ziplistGet(eptr,&amp;vstr,&amp;vlen,&amp;vlong));</span>
<span class="lineNum">    1776 </span>        [<span class="branchCov" title="Branch 0 was taken 2620 times"> + </span><span class="branchCov" title="Branch 1 was taken 334 times"> + </span>]:<span class="lineCov">       2954 :             if (vstr == NULL)</span>
<span class="lineNum">    1777 </span>                :<span class="lineCov">       2620 :                 addReplyBulkLongLong(c,vlong);</span>
<span class="lineNum">    1778 </span>                :            :             else
<span class="lineNum">    1779 </span>                :<span class="lineCov">        334 :                 addReplyBulkCBuffer(c,vstr,vlen);</span>
<span class="lineNum">    1780 </span>                :            : 
<span class="lineNum">    1781 </span>        [<span class="branchCov" title="Branch 0 was taken 62 times"> + </span><span class="branchCov" title="Branch 1 was taken 2892 times"> + </span>]:<span class="lineCov">       2954 :             if (withscores)</span>
<span class="lineNum">    1782 </span>                :<span class="lineCov">         62 :                 addReplyDouble(c,zzlGetScore(sptr));</span>
<span class="lineNum">    1783 </span>                :            : 
<span class="lineNum">    1784 </span>        [<span class="branchCov" title="Branch 0 was taken 266 times"> + </span><span class="branchCov" title="Branch 1 was taken 2688 times"> + </span>]:<span class="lineCov">       2954 :             if (reverse)</span>
<span class="lineNum">    1785 </span>                :<span class="lineCov">        266 :                 zzlPrev(zl,&amp;eptr,&amp;sptr);</span>
<span class="lineNum">    1786 </span>                :            :             else
<span class="lineNum">    1787 </span>                :<span class="lineCov">       2954 :                 zzlNext(zl,&amp;eptr,&amp;sptr);</span>
<span class="lineNum">    1788 </span>                :            :         }
<span class="lineNum">    1789 </span>                :            : 
<span class="lineNum">    1790 </span>        [<span class="branchCov" title="Branch 0 was taken 2060 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2060 :     } else if (zobj-&gt;encoding == REDIS_ENCODING_SKIPLIST) {</span>
<span class="lineNum">    1791 </span>                :<span class="lineCov">       2060 :         zset *zs = zobj-&gt;ptr;</span>
<span class="lineNum">    1792 </span>                :<span class="lineCov">       2060 :         zskiplist *zsl = zs-&gt;zsl;</span>
<span class="lineNum">    1793 </span>                :            :         zskiplistNode *ln;
<span class="lineNum">    1794 </span>                :            :         robj *ele;
<span class="lineNum">    1795 </span>                :            : 
<span class="lineNum">    1796 </span>                :            :         /* Check if starting point is trivial, before doing log(N) lookup. */
<span class="lineNum">    1797 </span>        [<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchCov" title="Branch 1 was taken 2048 times"> + </span>]:<span class="lineCov">       2060 :         if (reverse) {</span>
<span class="lineNum">    1798 </span>                :<span class="lineCov">         12 :             ln = zsl-&gt;tail;</span>
<span class="lineNum">    1799 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchCov" title="Branch 1 was taken 7 times"> + </span>]:<span class="lineCov">         12 :             if (start &gt; 0)</span>
<span class="lineNum">    1800 </span>                :<span class="lineCov">          5 :                 ln = zslGetElementByRank(zsl,llen-start);</span>
<span class="lineNum">    1801 </span>                :            :         } else {
<span class="lineNum">    1802 </span>                :<span class="lineCov">       2048 :             ln = zsl-&gt;header-&gt;level[0].forward;</span>
<span class="lineNum">    1803 </span>        [<span class="branchCov" title="Branch 0 was taken 1969 times"> + </span><span class="branchCov" title="Branch 1 was taken 79 times"> + </span>]:<span class="lineCov">       2048 :             if (start &gt; 0)</span>
<span class="lineNum">    1804 </span>                :<span class="lineCov">       2060 :                 ln = zslGetElementByRank(zsl,start+1);</span>
<span class="lineNum">    1805 </span>                :            :         }
<span class="lineNum">    1806 </span>                :            : 
<span class="lineNum">    1807 </span>        [<span class="branchCov" title="Branch 0 was taken 2759 times"> + </span><span class="branchCov" title="Branch 1 was taken 2060 times"> + </span>]:<span class="lineCov">       4819 :         while(rangelen--) {</span>
<span class="lineNum">    1808 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2759 times"> + </span>]:<span class="lineCov">       2759 :             redisAssertWithInfo(c,zobj,ln != NULL);</span>
<span class="lineNum">    1809 </span>                :<span class="lineCov">       2759 :             ele = ln-&gt;obj;</span>
<span class="lineNum">    1810 </span>                :<span class="lineCov">       2759 :             addReplyBulk(c,ele);</span>
<span class="lineNum">    1811 </span>        [<span class="branchCov" title="Branch 0 was taken 48 times"> + </span><span class="branchCov" title="Branch 1 was taken 2711 times"> + </span>]:<span class="lineCov">       2759 :             if (withscores)</span>
<span class="lineNum">    1812 </span>                :<span class="lineCov">         48 :                 addReplyDouble(c,ln-&gt;score);</span>
<span class="lineNum">    1813 </span>        [<span class="branchCov" title="Branch 0 was taken 216 times"> + </span><span class="branchCov" title="Branch 1 was taken 2543 times"> + </span>]:<span class="lineCov">       2759 :             ln = reverse ? ln-&gt;backward : ln-&gt;level[0].forward;</span>
<span class="lineNum">    1814 </span>                :            :         }
<span class="lineNum">    1815 </span>                :            :     } else {
<span class="lineNum">    1816 </span>                :<span class="lineNoCov">          0 :         redisPanic(&quot;Unknown sorted set encoding&quot;);</span>
<span class="lineNum">    1817 </span>                :            :     }
<a name="1818"><span class="lineNum">    1818 </span>                :            : }</a>
<span class="lineNum">    1819 </span>                :            : 
<span class="lineNum">    1820 </span>                :<span class="lineCov">       4110 : void zrangeCommand(redisClient *c) {</span>
<span class="lineNum">    1821 </span>                :<span class="lineCov">       4110 :     zrangeGenericCommand(c,0);</span>
<a name="1822"><span class="lineNum">    1822 </span>                :<span class="lineCov">       4110 : }</span></a>
<span class="lineNum">    1823 </span>                :            : 
<span class="lineNum">    1824 </span>                :<span class="lineCov">         32 : void zrevrangeCommand(redisClient *c) {</span>
<span class="lineNum">    1825 </span>                :<span class="lineCov">         32 :     zrangeGenericCommand(c,1);</span>
<span class="lineNum">    1826 </span>                :<span class="lineCov">         32 : }</span>
<span class="lineNum">    1827 </span>                :            : 
<span class="lineNum">    1828 </span>                :            : /* This command implements ZRANGEBYSCORE, ZREVRANGEBYSCORE. */
<span class="lineNum">    1829 </span>                :<span class="lineCov">       1294 : void genericZrangebyscoreCommand(redisClient *c, int reverse) {</span>
<span class="lineNum">    1830 </span>                :            :     zrangespec range;
<span class="lineNum">    1831 </span>                :<span class="lineCov">       1294 :     robj *key = c-&gt;argv[1];</span>
<span class="lineNum">    1832 </span>                :            :     robj *zobj;
<span class="lineNum">    1833 </span>                :<span class="lineCov">       1294 :     long offset = 0, limit = -1;</span>
<span class="lineNum">    1834 </span>                :<span class="lineCov">       1294 :     int withscores = 0;</span>
<span class="lineNum">    1835 </span>                :<span class="lineCov">       1294 :     unsigned long rangelen = 0;</span>
<span class="lineNum">    1836 </span>                :<span class="lineCov">       1294 :     void *replylen = NULL;</span>
<span class="lineNum">    1837 </span>                :            :     int minidx, maxidx;
<span class="lineNum">    1838 </span>                :            : 
<span class="lineNum">    1839 </span>                :            :     /* Parse the range arguments. */
<span class="lineNum">    1840 </span>        [<span class="branchCov" title="Branch 0 was taken 1258 times"> + </span><span class="branchCov" title="Branch 1 was taken 36 times"> + </span>]:<span class="lineCov">       1294 :     if (reverse) {</span>
<span class="lineNum">    1841 </span>                :            :         /* Range is given as [max,min] */
<span class="lineNum">    1842 </span>                :            :         maxidx = 2; minidx = 3;
<span class="lineNum">    1843 </span>                :            :     } else {
<span class="lineNum">    1844 </span>                :            :         /* Range is given as [min,max] */
<span class="lineNum">    1845 </span>                :<span class="lineCov">       1258 :         minidx = 2; maxidx = 3;</span>
<span class="lineNum">    1846 </span>                :            :     }
<span class="lineNum">    1847 </span>                :            : 
<span class="lineNum">    1848 </span>        [<span class="branchCov" title="Branch 1 was taken 6 times"> + </span><span class="branchCov" title="Branch 2 was taken 1288 times"> + </span>]:<span class="lineCov">       1294 :     if (zslParseRange(c-&gt;argv[minidx],c-&gt;argv[maxidx],&amp;range) != REDIS_OK) {</span>
<span class="lineNum">    1849 </span>                :<span class="lineCov">          6 :         addReplyError(c,&quot;min or max is not a float&quot;);</span>
<span class="lineNum">    1850 </span>                :<span class="lineCov">          6 :         return;</span>
<span class="lineNum">    1851 </span>                :            :     }
<span class="lineNum">    1852 </span>                :            : 
<span class="lineNum">    1853 </span>                :            :     /* Parse optional extra arguments. Note that ZCOUNT will exactly have
<span class="lineNum">    1854 </span>                :            :      * 4 arguments, so we'll never enter the following code path. */
<span class="lineNum">    1855 </span>        [<span class="branchCov" title="Branch 0 was taken 24 times"> + </span><span class="branchCov" title="Branch 1 was taken 1264 times"> + </span>]:<span class="lineCov">       1288 :     if (c-&gt;argc &gt; 4) {</span>
<span class="lineNum">    1856 </span>                :<span class="lineCov">         24 :         int remaining = c-&gt;argc - 4;</span>
<span class="lineNum">    1857 </span>                :<span class="lineCov">         24 :         int pos = 4;</span>
<span class="lineNum">    1858 </span>                :            : 
<span class="lineNum">    1859 </span>        [<span class="branchCov" title="Branch 0 was taken 28 times"> + </span><span class="branchCov" title="Branch 1 was taken 24 times"> + </span>]:<span class="lineCov">         52 :         while (remaining) {</span>
<span class="lineNum">    1860 </span>[<span class="branchCov" title="Branch 0 was taken 28 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 8 times"> + </span><span class="branchCov" title="Branch 4 was taken 20 times"> + </span>]:<span class="lineCov">         28 :             if (remaining &gt;= 1 &amp;&amp; !strcasecmp(c-&gt;argv[pos]-&gt;ptr,&quot;withscores&quot;)) {</span>
<span class="lineNum">    1861 </span>                :<span class="lineCov">          8 :                 pos++; remaining--;</span>
<span class="lineNum">    1862 </span>                :<span class="lineCov">          8 :                 withscores = 1;</span>
<span class="lineNum">    1863 </span>[<span class="branchCov" title="Branch 0 was taken 20 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 20 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         20 :             } else if (remaining &gt;= 3 &amp;&amp; !strcasecmp(c-&gt;argv[pos]-&gt;ptr,&quot;limit&quot;)) {</span>
<span class="lineNum">    1864 </span>  [<span class="branchCov" title="Branch 1 was taken 20 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 20 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         40 :                 if ((getLongFromObjectOrReply(c, c-&gt;argv[pos+1], &amp;offset, NULL) != REDIS_OK) ||</span>
<span class="lineNum">    1865 </span>                :<span class="lineCov">         20 :                     (getLongFromObjectOrReply(c, c-&gt;argv[pos+2], &amp;limit, NULL) != REDIS_OK)) return;</span>
<span class="lineNum">    1866 </span>                :<span class="lineCov">         20 :                 pos += 3; remaining -= 3;</span>
<span class="lineNum">    1867 </span>                :            :             } else {
<span class="lineNum">    1868 </span>                :<span class="lineNoCov">          0 :                 addReply(c,shared.syntaxerr);</span>
<span class="lineNum">    1869 </span>                :<span class="lineCov">         28 :                 return;</span>
<span class="lineNum">    1870 </span>                :            :             }
<span class="lineNum">    1871 </span>                :            :         }
<span class="lineNum">    1872 </span>                :            :     }
<span class="lineNum">    1873 </span>                :            : 
<span class="lineNum">    1874 </span>                :            :     /* Ok, lookup the key and get the range */
<span class="lineNum">    1875 </span>  [<span class="branchCov" title="Branch 1 was taken 1288 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1288 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       2576 :     if ((zobj = lookupKeyReadOrReply(c,key,shared.emptymultibulk)) == NULL ||</span>
<span class="lineNum">    1876 </span>                :<span class="lineCov">       1288 :         checkType(c,zobj,REDIS_ZSET)) return;</span>
<span class="lineNum">    1877 </span>                :            : 
<span class="lineNum">    1878 </span>        [<span class="branchCov" title="Branch 0 was taken 644 times"> + </span><span class="branchCov" title="Branch 1 was taken 644 times"> + </span>]:<span class="lineCov">       1288 :     if (zobj-&gt;encoding == REDIS_ENCODING_ZIPLIST) {</span>
<span class="lineNum">    1879 </span>                :<span class="lineCov">        644 :         unsigned char *zl = zobj-&gt;ptr;</span>
<span class="lineNum">    1880 </span>                :            :         unsigned char *eptr, *sptr;
<span class="lineNum">    1881 </span>                :            :         unsigned char *vstr;
<span class="lineNum">    1882 </span>                :            :         unsigned int vlen;
<span class="lineNum">    1883 </span>                :            :         long long vlong;
<span class="lineNum">    1884 </span>                :            :         double score;
<span class="lineNum">    1885 </span>                :            : 
<span class="lineNum">    1886 </span>                :            :         /* If reversed, get the last node in range as starting point. */
<span class="lineNum">    1887 </span>        [<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchCov" title="Branch 1 was taken 626 times"> + </span>]:<span class="lineCov">        644 :         if (reverse) {</span>
<span class="lineNum">    1888 </span>                :<span class="lineCov">         18 :             eptr = zzlLastInRange(zl,range);</span>
<span class="lineNum">    1889 </span>                :            :         } else {
<span class="lineNum">    1890 </span>                :<span class="lineCov">        626 :             eptr = zzlFirstInRange(zl,range);</span>
<span class="lineNum">    1891 </span>                :            :         }
<span class="lineNum">    1892 </span>                :            : 
<span class="lineNum">    1893 </span>                :            :         /* No &quot;first&quot; element in the specified interval. */
<span class="lineNum">    1894 </span>        [<span class="branchCov" title="Branch 0 was taken 26 times"> + </span><span class="branchCov" title="Branch 1 was taken 618 times"> + </span>]:<span class="lineCov">        644 :         if (eptr == NULL) {</span>
<span class="lineNum">    1895 </span>                :<span class="lineCov">         26 :             addReply(c, shared.emptymultibulk);</span>
<span class="lineNum">    1896 </span>                :<span class="lineCov">         26 :             return;</span>
<span class="lineNum">    1897 </span>                :            :         }
<span class="lineNum">    1898 </span>                :            : 
<span class="lineNum">    1899 </span>                :            :         /* Get score pointer for the first element. */
<span class="lineNum">    1900 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 618 times"> + </span>]:<span class="lineCov">        618 :         redisAssertWithInfo(c,zobj,eptr != NULL);</span>
<span class="lineNum">    1901 </span>                :<span class="lineCov">        618 :         sptr = ziplistNext(zl,eptr);</span>
<span class="lineNum">    1902 </span>                :            : 
<span class="lineNum">    1903 </span>                :            :         /* We don't know in advance how many matching elements there are in the
<span class="lineNum">    1904 </span>                :            :          * list, so we push this object that will represent the multi-bulk
<span class="lineNum">    1905 </span>                :            :          * length in the output buffer, and will &quot;fix&quot; it later */
<span class="lineNum">    1906 </span>                :<span class="lineCov">        618 :         replylen = addDeferredMultiBulkLength(c);</span>
<span class="lineNum">    1907 </span>                :            : 
<span class="lineNum">    1908 </span>                :            :         /* If there is an offset, just traverse the number of elements without
<span class="lineNum">    1909 </span>                :            :          * checking the score because that is done in the next loop. */
<span class="lineNum">    1910 </span>[<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 640 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 24 times"> + </span><span class="branchCov" title="Branch 3 was taken 616 times"> + </span>]:<span class="lineCov">        642 :         while (eptr &amp;&amp; offset--) {</span>
<span class="lineNum">    1911 </span>        [<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>]:<span class="lineCov">         24 :             if (reverse) {</span>
<span class="lineNum">    1912 </span>                :<span class="lineCov">         12 :                 zzlPrev(zl,&amp;eptr,&amp;sptr);</span>
<span class="lineNum">    1913 </span>                :            :             } else {
<span class="lineNum">    1914 </span>                :<span class="lineCov">         24 :                 zzlNext(zl,&amp;eptr,&amp;sptr);</span>
<span class="lineNum">    1915 </span>                :            :             }
<span class="lineNum">    1916 </span>                :            :         }
<span class="lineNum">    1917 </span>                :            : 
<span class="lineNum">    1918 </span>[<span class="branchCov" title="Branch 0 was taken 26076 times"> + </span><span class="branchCov" title="Branch 1 was taken 204 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 26072 times"> + </span><span class="branchCov" title="Branch 3 was taken 4 times"> + </span>]:<span class="lineCov">      26280 :         while (eptr &amp;&amp; limit--) {</span>
<span class="lineNum">    1919 </span>                :<span class="lineCov">      26072 :             score = zzlGetScore(sptr);</span>
<span class="lineNum">    1920 </span>                :            : 
<span class="lineNum">    1921 </span>                :            :             /* Abort when the node is no longer in range. */
<span class="lineNum">    1922 </span>        [<span class="branchCov" title="Branch 0 was taken 41 times"> + </span><span class="branchCov" title="Branch 1 was taken 26031 times"> + </span>]:<span class="lineCov">      26072 :             if (reverse) {</span>
<span class="lineNum">    1923 </span>        [<span class="branchCov" title="Branch 0 was taken 31 times"> + </span><span class="branchCov" title="Branch 1 was taken 10 times"> + </span>]:<span class="lineCov">         41 :                 if (!zslValueGteMin(score,&amp;range)) break;</span>
<span class="lineNum">    1924 </span>                :            :             } else {
<span class="lineNum">    1925 </span>        [<span class="branchCov" title="Branch 0 was taken 25631 times"> + </span><span class="branchCov" title="Branch 1 was taken 400 times"> + </span>]:<span class="lineCov">      26031 :                 if (!zslValueLteMax(score,&amp;range)) break;</span>
<span class="lineNum">    1926 </span>                :            :             }
<span class="lineNum">    1927 </span>                :            : 
<span class="lineNum">    1928 </span>                :            :             /* We know the element exists, so ziplistGet should always succeed */
<span class="lineNum">    1929 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 25662 times"> + </span>]:<span class="lineCov">      25662 :             redisAssertWithInfo(c,zobj,ziplistGet(eptr,&amp;vstr,&amp;vlen,&amp;vlong));</span>
<span class="lineNum">    1930 </span>                :            : 
<span class="lineNum">    1931 </span>                :<span class="lineCov">      25662 :             rangelen++;</span>
<span class="lineNum">    1932 </span>        [<span class="branchCov" title="Branch 0 was taken 25600 times"> + </span><span class="branchCov" title="Branch 1 was taken 62 times"> + </span>]:<span class="lineCov">      25662 :             if (vstr == NULL) {</span>
<span class="lineNum">    1933 </span>                :<span class="lineCov">      25600 :                 addReplyBulkLongLong(c,vlong);</span>
<span class="lineNum">    1934 </span>                :            :             } else {
<span class="lineNum">    1935 </span>                :<span class="lineCov">         62 :                 addReplyBulkCBuffer(c,vstr,vlen);</span>
<span class="lineNum">    1936 </span>                :            :             }
<span class="lineNum">    1937 </span>                :            : 
<span class="lineNum">    1938 </span>        [<span class="branchCov" title="Branch 0 was taken 10 times"> + </span><span class="branchCov" title="Branch 1 was taken 25652 times"> + </span>]:<span class="lineCov">      25662 :             if (withscores) {</span>
<span class="lineNum">    1939 </span>                :<span class="lineCov">         10 :                 addReplyDouble(c,score);</span>
<span class="lineNum">    1940 </span>                :            :             }
<span class="lineNum">    1941 </span>                :            : 
<span class="lineNum">    1942 </span>                :            :             /* Move to next node */
<span class="lineNum">    1943 </span>        [<span class="branchCov" title="Branch 0 was taken 31 times"> + </span><span class="branchCov" title="Branch 1 was taken 25631 times"> + </span>]:<span class="lineCov">      25662 :             if (reverse) {</span>
<span class="lineNum">    1944 </span>                :<span class="lineCov">         31 :                 zzlPrev(zl,&amp;eptr,&amp;sptr);</span>
<span class="lineNum">    1945 </span>                :            :             } else {
<span class="lineNum">    1946 </span>                :<span class="lineCov">      25662 :                 zzlNext(zl,&amp;eptr,&amp;sptr);</span>
<span class="lineNum">    1947 </span>                :            :             }
<span class="lineNum">    1948 </span>                :            :         }
<span class="lineNum">    1949 </span>        [<span class="branchCov" title="Branch 0 was taken 644 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        644 :     } else if (zobj-&gt;encoding == REDIS_ENCODING_SKIPLIST) {</span>
<span class="lineNum">    1950 </span>                :<span class="lineCov">        644 :         zset *zs = zobj-&gt;ptr;</span>
<span class="lineNum">    1951 </span>                :<span class="lineCov">        644 :         zskiplist *zsl = zs-&gt;zsl;</span>
<span class="lineNum">    1952 </span>                :            :         zskiplistNode *ln;
<span class="lineNum">    1953 </span>                :            : 
<span class="lineNum">    1954 </span>                :            :         /* If reversed, get the last node in range as starting point. */
<span class="lineNum">    1955 </span>        [<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchCov" title="Branch 1 was taken 626 times"> + </span>]:<span class="lineCov">        644 :         if (reverse) {</span>
<span class="lineNum">    1956 </span>                :<span class="lineCov">         18 :             ln = zslLastInRange(zsl,range);</span>
<span class="lineNum">    1957 </span>                :            :         } else {
<span class="lineNum">    1958 </span>                :<span class="lineCov">        626 :             ln = zslFirstInRange(zsl,range);</span>
<span class="lineNum">    1959 </span>                :            :         }
<span class="lineNum">    1960 </span>                :            : 
<span class="lineNum">    1961 </span>                :            :         /* No &quot;first&quot; element in the specified interval. */
<span class="lineNum">    1962 </span>        [<span class="branchCov" title="Branch 0 was taken 28 times"> + </span><span class="branchCov" title="Branch 1 was taken 616 times"> + </span>]:<span class="lineCov">        644 :         if (ln == NULL) {</span>
<span class="lineNum">    1963 </span>                :<span class="lineCov">         28 :             addReply(c, shared.emptymultibulk);</span>
<span class="lineNum">    1964 </span>                :<span class="lineCov">         28 :             return;</span>
<span class="lineNum">    1965 </span>                :            :         }
<span class="lineNum">    1966 </span>                :            : 
<span class="lineNum">    1967 </span>                :            :         /* We don't know in advance how many matching elements there are in the
<span class="lineNum">    1968 </span>                :            :          * list, so we push this object that will represent the multi-bulk
<span class="lineNum">    1969 </span>                :            :          * length in the output buffer, and will &quot;fix&quot; it later */
<span class="lineNum">    1970 </span>                :<span class="lineCov">        616 :         replylen = addDeferredMultiBulkLength(c);</span>
<span class="lineNum">    1971 </span>                :            : 
<span class="lineNum">    1972 </span>                :            :         /* If there is an offset, just traverse the number of elements without
<span class="lineNum">    1973 </span>                :            :          * checking the score because that is done in the next loop. */
<span class="lineNum">    1974 </span>[<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 638 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 24 times"> + </span><span class="branchCov" title="Branch 3 was taken 614 times"> + </span>]:<span class="lineCov">        640 :         while (ln &amp;&amp; offset--) {</span>
<span class="lineNum">    1975 </span>        [<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>]:<span class="lineCov">         24 :             if (reverse) {</span>
<span class="lineNum">    1976 </span>                :<span class="lineCov">         12 :                 ln = ln-&gt;backward;</span>
<span class="lineNum">    1977 </span>                :            :             } else {
<span class="lineNum">    1978 </span>                :<span class="lineCov">         24 :                 ln = ln-&gt;level[0].forward;</span>
<span class="lineNum">    1979 </span>                :            :             }
<span class="lineNum">    1980 </span>                :            :         }
<span class="lineNum">    1981 </span>                :            : 
<span class="lineNum">    1982 </span>[<span class="branchCov" title="Branch 0 was taken 20474 times"> + </span><span class="branchCov" title="Branch 1 was taken 204 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 20470 times"> + </span><span class="branchCov" title="Branch 3 was taken 4 times"> + </span>]:<span class="lineCov">      20678 :         while (ln &amp;&amp; limit--) {</span>
<span class="lineNum">    1983 </span>                :            :             /* Abort when the node is no longer in range. */
<span class="lineNum">    1984 </span>        [<span class="branchCov" title="Branch 0 was taken 41 times"> + </span><span class="branchCov" title="Branch 1 was taken 20429 times"> + </span>]:<span class="lineCov">      20470 :             if (reverse) {</span>
<span class="lineNum">    1985 </span>        [<span class="branchCov" title="Branch 0 was taken 31 times"> + </span><span class="branchCov" title="Branch 1 was taken 10 times"> + </span>]:<span class="lineCov">         41 :                 if (!zslValueGteMin(ln-&gt;score,&amp;range)) break;</span>
<span class="lineNum">    1986 </span>                :            :             } else {
<span class="lineNum">    1987 </span>        [<span class="branchCov" title="Branch 0 was taken 20031 times"> + </span><span class="branchCov" title="Branch 1 was taken 398 times"> + </span>]:<span class="lineCov">      20429 :                 if (!zslValueLteMax(ln-&gt;score,&amp;range)) break;</span>
<span class="lineNum">    1988 </span>                :            :             }
<span class="lineNum">    1989 </span>                :            : 
<span class="lineNum">    1990 </span>                :<span class="lineCov">      20062 :             rangelen++;</span>
<span class="lineNum">    1991 </span>                :<span class="lineCov">      20062 :             addReplyBulk(c,ln-&gt;obj);</span>
<span class="lineNum">    1992 </span>                :            : 
<span class="lineNum">    1993 </span>        [<span class="branchCov" title="Branch 0 was taken 10 times"> + </span><span class="branchCov" title="Branch 1 was taken 20052 times"> + </span>]:<span class="lineCov">      20062 :             if (withscores) {</span>
<span class="lineNum">    1994 </span>                :<span class="lineCov">         10 :                 addReplyDouble(c,ln-&gt;score);</span>
<span class="lineNum">    1995 </span>                :            :             }
<span class="lineNum">    1996 </span>                :            : 
<span class="lineNum">    1997 </span>                :            :             /* Move to next node */
<span class="lineNum">    1998 </span>        [<span class="branchCov" title="Branch 0 was taken 31 times"> + </span><span class="branchCov" title="Branch 1 was taken 20031 times"> + </span>]:<span class="lineCov">      20062 :             if (reverse) {</span>
<span class="lineNum">    1999 </span>                :<span class="lineCov">         31 :                 ln = ln-&gt;backward;</span>
<span class="lineNum">    2000 </span>                :            :             } else {
<span class="lineNum">    2001 </span>                :<span class="lineCov">      20062 :                 ln = ln-&gt;level[0].forward;</span>
<span class="lineNum">    2002 </span>                :            :             }
<span class="lineNum">    2003 </span>                :            :         }
<span class="lineNum">    2004 </span>                :            :     } else {
<span class="lineNum">    2005 </span>                :<span class="lineNoCov">          0 :         redisPanic(&quot;Unknown sorted set encoding&quot;);</span>
<span class="lineNum">    2006 </span>                :            :     }
<span class="lineNum">    2007 </span>                :            : 
<span class="lineNum">    2008 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 1226 times"> + </span>]:<span class="lineCov">       1234 :     if (withscores) {</span>
<span class="lineNum">    2009 </span>                :<span class="lineCov">          8 :         rangelen *= 2;</span>
<span class="lineNum">    2010 </span>                :            :     }
<span class="lineNum">    2011 </span>                :            : 
<span class="lineNum">    2012 </span>                :<span class="lineCov">       1294 :     setDeferredMultiBulkLength(c, replylen, rangelen);</span>
<a name="2013"><span class="lineNum">    2013 </span>                :            : }</a>
<span class="lineNum">    2014 </span>                :            : 
<span class="lineNum">    2015 </span>                :<span class="lineCov">       1258 : void zrangebyscoreCommand(redisClient *c) {</span>
<span class="lineNum">    2016 </span>                :<span class="lineCov">       1258 :     genericZrangebyscoreCommand(c,0);</span>
<a name="2017"><span class="lineNum">    2017 </span>                :<span class="lineCov">       1258 : }</span></a>
<span class="lineNum">    2018 </span>                :            : 
<span class="lineNum">    2019 </span>                :<span class="lineCov">         36 : void zrevrangebyscoreCommand(redisClient *c) {</span>
<span class="lineNum">    2020 </span>                :<span class="lineCov">         36 :     genericZrangebyscoreCommand(c,1);</span>
<span class="lineNum">    2021 </span>                :<span class="lineCov">         36 : }</span>
<span class="lineNum">    2022 </span>                :            : 
<span class="lineNum">    2023 </span>                :<span class="lineCov">       1204 : void zcountCommand(redisClient *c) {</span>
<span class="lineNum">    2024 </span>                :<span class="lineCov">       1204 :     robj *key = c-&gt;argv[1];</span>
<span class="lineNum">    2025 </span>                :            :     robj *zobj;
<span class="lineNum">    2026 </span>                :            :     zrangespec range;
<span class="lineNum">    2027 </span>                :<span class="lineCov">       1204 :     int count = 0;</span>
<span class="lineNum">    2028 </span>                :            : 
<span class="lineNum">    2029 </span>                :            :     /* Parse the range arguments */
<span class="lineNum">    2030 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1204 times"> + </span>]:<span class="lineCov">       1204 :     if (zslParseRange(c-&gt;argv[2],c-&gt;argv[3],&amp;range) != REDIS_OK) {</span>
<span class="lineNum">    2031 </span>                :<span class="lineNoCov">          0 :         addReplyError(c,&quot;min or max is not a float&quot;);</span>
<span class="lineNum">    2032 </span>                :<span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    2033 </span>                :            :     }
<span class="lineNum">    2034 </span>                :            : 
<span class="lineNum">    2035 </span>                :            :     /* Lookup the sorted set */
<span class="lineNum">    2036 </span>  [<span class="branchCov" title="Branch 1 was taken 1204 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1204 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       2408 :     if ((zobj = lookupKeyReadOrReply(c, key, shared.czero)) == NULL ||</span>
<span class="lineNum">    2037 </span>                :<span class="lineCov">       1204 :         checkType(c, zobj, REDIS_ZSET)) return;</span>
<span class="lineNum">    2038 </span>                :            : 
<span class="lineNum">    2039 </span>        [<span class="branchCov" title="Branch 0 was taken 602 times"> + </span><span class="branchCov" title="Branch 1 was taken 602 times"> + </span>]:<span class="lineCov">       1204 :     if (zobj-&gt;encoding == REDIS_ENCODING_ZIPLIST) {</span>
<span class="lineNum">    2040 </span>                :<span class="lineCov">        602 :         unsigned char *zl = zobj-&gt;ptr;</span>
<span class="lineNum">    2041 </span>                :            :         unsigned char *eptr, *sptr;
<span class="lineNum">    2042 </span>                :            :         double score;
<span class="lineNum">    2043 </span>                :            : 
<span class="lineNum">    2044 </span>                :            :         /* Use the first element in range as the starting point */
<span class="lineNum">    2045 </span>                :<span class="lineCov">        602 :         eptr = zzlFirstInRange(zl,range);</span>
<span class="lineNum">    2046 </span>                :            : 
<span class="lineNum">    2047 </span>                :            :         /* No &quot;first&quot; element */
<span class="lineNum">    2048 </span>        [<span class="branchCov" title="Branch 0 was taken 10 times"> + </span><span class="branchCov" title="Branch 1 was taken 592 times"> + </span>]:<span class="lineCov">        602 :         if (eptr == NULL) {</span>
<span class="lineNum">    2049 </span>                :<span class="lineCov">         10 :             addReply(c, shared.czero);</span>
<span class="lineNum">    2050 </span>                :<span class="lineCov">         10 :             return;</span>
<span class="lineNum">    2051 </span>                :            :         }
<span class="lineNum">    2052 </span>                :            : 
<span class="lineNum">    2053 </span>                :            :         /* First element is in range */
<span class="lineNum">    2054 </span>                :<span class="lineCov">        592 :         sptr = ziplistNext(zl,eptr);</span>
<span class="lineNum">    2055 </span>                :<span class="lineCov">        592 :         score = zzlGetScore(sptr);</span>
<span class="lineNum">    2056 </span>        [<span class="branchCov" title="Branch 0 was taken 592 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        592 :         redisAssertWithInfo(c,zobj,zslValueLteMax(score,&amp;range));</span>
<span class="lineNum">    2057 </span>                :            : 
<span class="lineNum">    2058 </span>                :            :         /* Iterate over elements in range */
<span class="lineNum">    2059 </span>        [<span class="branchCov" title="Branch 0 was taken 25997 times"> + </span><span class="branchCov" title="Branch 1 was taken 200 times"> + </span>]:<span class="lineCov">      26197 :         while (eptr) {</span>
<span class="lineNum">    2060 </span>                :<span class="lineCov">      25997 :             score = zzlGetScore(sptr);</span>
<span class="lineNum">    2061 </span>                :            : 
<span class="lineNum">    2062 </span>                :            :             /* Abort when the node is no longer in range. */
<span class="lineNum">    2063 </span>        [<span class="branchCov" title="Branch 0 was taken 25605 times"> + </span><span class="branchCov" title="Branch 1 was taken 392 times"> + </span>]:<span class="lineCov">      25997 :             if (!zslValueLteMax(score,&amp;range)) {</span>
<span class="lineNum">    2064 </span>                :            :                 break;
<span class="lineNum">    2065 </span>                :            :             } else {
<span class="lineNum">    2066 </span>                :<span class="lineCov">      25605 :                 count++;</span>
<span class="lineNum">    2067 </span>                :<span class="lineCov">      25605 :                 zzlNext(zl,&amp;eptr,&amp;sptr);</span>
<span class="lineNum">    2068 </span>                :            :             }
<span class="lineNum">    2069 </span>                :            :         }
<span class="lineNum">    2070 </span>        [<span class="branchCov" title="Branch 0 was taken 602 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        602 :     } else if (zobj-&gt;encoding == REDIS_ENCODING_SKIPLIST) {</span>
<span class="lineNum">    2071 </span>                :<span class="lineCov">        602 :         zset *zs = zobj-&gt;ptr;</span>
<span class="lineNum">    2072 </span>                :<span class="lineCov">        602 :         zskiplist *zsl = zs-&gt;zsl;</span>
<span class="lineNum">    2073 </span>                :            :         zskiplistNode *zn;
<span class="lineNum">    2074 </span>                :            :         unsigned long rank;
<span class="lineNum">    2075 </span>                :            : 
<span class="lineNum">    2076 </span>                :            :         /* Find first element in range */
<span class="lineNum">    2077 </span>                :<span class="lineCov">        602 :         zn = zslFirstInRange(zsl, range);</span>
<span class="lineNum">    2078 </span>                :            : 
<span class="lineNum">    2079 </span>                :            :         /* Use rank of first element, if any, to determine preliminary count */
<span class="lineNum">    2080 </span>        [<span class="branchCov" title="Branch 0 was taken 590 times"> + </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>]:<span class="lineCov">        602 :         if (zn != NULL) {</span>
<span class="lineNum">    2081 </span>                :<span class="lineCov">        590 :             rank = zslGetRank(zsl, zn-&gt;score, zn-&gt;obj);</span>
<span class="lineNum">    2082 </span>                :<span class="lineCov">        590 :             count = (zsl-&gt;length - (rank - 1));</span>
<span class="lineNum">    2083 </span>                :            : 
<span class="lineNum">    2084 </span>                :            :             /* Find last element in range */
<span class="lineNum">    2085 </span>                :<span class="lineCov">        590 :             zn = zslLastInRange(zsl, range);</span>
<span class="lineNum">    2086 </span>                :            : 
<span class="lineNum">    2087 </span>                :            :             /* Use rank of last element, if any, to determine the actual count */
<span class="lineNum">    2088 </span>        [<span class="branchCov" title="Branch 0 was taken 590 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        590 :             if (zn != NULL) {</span>
<span class="lineNum">    2089 </span>                :<span class="lineCov">        590 :                 rank = zslGetRank(zsl, zn-&gt;score, zn-&gt;obj);</span>
<span class="lineNum">    2090 </span>                :<span class="lineCov">        590 :                 count -= (zsl-&gt;length - rank);</span>
<span class="lineNum">    2091 </span>                :            :             }
<span class="lineNum">    2092 </span>                :            :         }
<span class="lineNum">    2093 </span>                :            :     } else {
<span class="lineNum">    2094 </span>                :<span class="lineNoCov">          0 :         redisPanic(&quot;Unknown sorted set encoding&quot;);</span>
<span class="lineNum">    2095 </span>                :            :     }
<span class="lineNum">    2096 </span>                :            : 
<span class="lineNum">    2097 </span>                :<span class="lineCov">       1204 :     addReplyLongLong(c, count);</span>
<a name="2098"><span class="lineNum">    2098 </span>                :            : }</a>
<span class="lineNum">    2099 </span>                :            : 
<span class="lineNum">    2100 </span>                :<span class="lineCov">       4004 : void zcardCommand(redisClient *c) {</span>
<span class="lineNum">    2101 </span>                :<span class="lineCov">       4004 :     robj *key = c-&gt;argv[1];</span>
<span class="lineNum">    2102 </span>                :            :     robj *zobj;
<span class="lineNum">    2103 </span>                :            : 
<span class="lineNum">    2104 </span>  [<span class="branchCov" title="Branch 1 was taken 4001 times"> + </span><span class="branchCov" title="Branch 2 was taken 3 times"> + </span><span class="branchCov" title="Branch 3 was taken 4001 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       8005 :     if ((zobj = lookupKeyReadOrReply(c,key,shared.czero)) == NULL ||</span>
<span class="lineNum">    2105 </span>                :<span class="lineCov">       8005 :         checkType(c,zobj,REDIS_ZSET)) return;</span>
<span class="lineNum">    2106 </span>                :            : 
<span class="lineNum">    2107 </span>                :<span class="lineCov">       4001 :     addReplyLongLong(c,zsetLength(zobj));</span>
<a name="2108"><span class="lineNum">    2108 </span>                :            : }</a>
<span class="lineNum">    2109 </span>                :            : 
<span class="lineNum">    2110 </span>                :<span class="lineCov">      46078 : void zscoreCommand(redisClient *c) {</span>
<span class="lineNum">    2111 </span>                :<span class="lineCov">      46078 :     robj *key = c-&gt;argv[1];</span>
<span class="lineNum">    2112 </span>                :            :     robj *zobj;
<span class="lineNum">    2113 </span>                :            :     double score;
<span class="lineNum">    2114 </span>                :            : 
<span class="lineNum">    2115 </span>  [<span class="branchCov" title="Branch 1 was taken 46078 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 46078 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">      92156 :     if ((zobj = lookupKeyReadOrReply(c,key,shared.nullbulk)) == NULL ||</span>
<span class="lineNum">    2116 </span>                :<span class="lineCov">      92156 :         checkType(c,zobj,REDIS_ZSET)) return;</span>
<span class="lineNum">    2117 </span>                :            : 
<span class="lineNum">    2118 </span>        [<span class="branchCov" title="Branch 0 was taken 25867 times"> + </span><span class="branchCov" title="Branch 1 was taken 20211 times"> + </span>]:<span class="lineCov">      46078 :     if (zobj-&gt;encoding == REDIS_ENCODING_ZIPLIST) {</span>
<span class="lineNum">    2119 </span>        [<span class="branchCov" title="Branch 1 was taken 25867 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      25867 :         if (zzlFind(zobj-&gt;ptr,c-&gt;argv[2],&amp;score) != NULL)</span>
<span class="lineNum">    2120 </span>                :<span class="lineCov">      25867 :             addReplyDouble(c,score);</span>
<span class="lineNum">    2121 </span>                :            :         else
<span class="lineNum">    2122 </span>                :<span class="lineNoCov">          0 :             addReply(c,shared.nullbulk);</span>
<span class="lineNum">    2123 </span>        [<span class="branchCov" title="Branch 0 was taken 20211 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      20211 :     } else if (zobj-&gt;encoding == REDIS_ENCODING_SKIPLIST) {</span>
<span class="lineNum">    2124 </span>                :<span class="lineCov">      20211 :         zset *zs = zobj-&gt;ptr;</span>
<span class="lineNum">    2125 </span>                :            :         dictEntry *de;
<span class="lineNum">    2126 </span>                :            : 
<span class="lineNum">    2127 </span>                :<span class="lineCov">      20211 :         c-&gt;argv[2] = tryObjectEncoding(c-&gt;argv[2]);</span>
<span class="lineNum">    2128 </span>                :<span class="lineCov">      20211 :         de = dictFind(zs-&gt;dict,c-&gt;argv[2]);</span>
<span class="lineNum">    2129 </span>        [<span class="branchCov" title="Branch 0 was taken 20211 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      20211 :         if (de != NULL) {</span>
<span class="lineNum">    2130 </span>                :<span class="lineCov">      20211 :             score = *(double*)dictGetVal(de);</span>
<span class="lineNum">    2131 </span>                :<span class="lineCov">      20211 :             addReplyDouble(c,score);</span>
<span class="lineNum">    2132 </span>                :            :         } else {
<span class="lineNum">    2133 </span>                :<span class="lineNoCov">          0 :             addReply(c,shared.nullbulk);</span>
<span class="lineNum">    2134 </span>                :            :         }
<span class="lineNum">    2135 </span>                :            :     } else {
<span class="lineNum">    2136 </span>                :<span class="lineNoCov">          0 :         redisPanic(&quot;Unknown sorted set encoding&quot;);</span>
<span class="lineNum">    2137 </span>                :            :     }
<a name="2138"><span class="lineNum">    2138 </span>                :            : }</a>
<span class="lineNum">    2139 </span>                :            : 
<span class="lineNum">    2140 </span>                :<span class="lineCov">       4019 : void zrankGenericCommand(redisClient *c, int reverse) {</span>
<span class="lineNum">    2141 </span>                :<span class="lineCov">       4019 :     robj *key = c-&gt;argv[1];</span>
<span class="lineNum">    2142 </span>                :<span class="lineCov">       4019 :     robj *ele = c-&gt;argv[2];</span>
<span class="lineNum">    2143 </span>                :            :     robj *zobj;
<span class="lineNum">    2144 </span>                :            :     unsigned long llen;
<span class="lineNum">    2145 </span>                :            :     unsigned long rank;
<span class="lineNum">    2146 </span>                :            : 
<span class="lineNum">    2147 </span>  [<span class="branchCov" title="Branch 1 was taken 4019 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 4019 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       8038 :     if ((zobj = lookupKeyReadOrReply(c,key,shared.nullbulk)) == NULL ||</span>
<span class="lineNum">    2148 </span>                :<span class="lineCov">       8038 :         checkType(c,zobj,REDIS_ZSET)) return;</span>
<span class="lineNum">    2149 </span>                :<span class="lineCov">       4019 :     llen = zsetLength(zobj);</span>
<span class="lineNum">    2150 </span>                :            : 
<span class="lineNum">    2151 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4019 times"> + </span>]:<span class="lineCov">       4019 :     redisAssertWithInfo(c,ele,sdsEncodedObject(ele));</span>
<span class="lineNum">    2152 </span>                :            : 
<span class="lineNum">    2153 </span>        [<span class="branchCov" title="Branch 0 was taken 2010 times"> + </span><span class="branchCov" title="Branch 1 was taken 2009 times"> + </span>]:<span class="lineCov">       4019 :     if (zobj-&gt;encoding == REDIS_ENCODING_ZIPLIST) {</span>
<span class="lineNum">    2154 </span>                :<span class="lineCov">       2010 :         unsigned char *zl = zobj-&gt;ptr;</span>
<span class="lineNum">    2155 </span>                :            :         unsigned char *eptr, *sptr;
<span class="lineNum">    2156 </span>                :            : 
<span class="lineNum">    2157 </span>                :<span class="lineCov">       2010 :         eptr = ziplistIndex(zl,0);</span>
<span class="lineNum">    2158 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2010 times"> + </span>]:<span class="lineCov">       2010 :         redisAssertWithInfo(c,zobj,eptr != NULL);</span>
<span class="lineNum">    2159 </span>                :<span class="lineCov">       2010 :         sptr = ziplistNext(zl,eptr);</span>
<span class="lineNum">    2160 </span>        [<span class="branchCov" title="Branch 0 was taken 2010 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2010 :         redisAssertWithInfo(c,zobj,sptr != NULL);</span>
<span class="lineNum">    2161 </span>                :            : 
<span class="lineNum">    2162 </span>                :            :         rank = 1;
<span class="lineNum">    2163 </span>        [<span class="branchCov" title="Branch 0 was taken 98890 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">      98892 :         while(eptr != NULL) {</span>
<span class="lineNum">    2164 </span>        [<span class="branchCov" title="Branch 1 was taken 96882 times"> + </span><span class="branchCov" title="Branch 2 was taken 2008 times"> + </span>]:<span class="lineCov">      98890 :             if (ziplistCompare(eptr,ele-&gt;ptr,sdslen(ele-&gt;ptr)))</span>
<span class="lineNum">    2165 </span>                :            :                 break;
<span class="lineNum">    2166 </span>                :<span class="lineCov">      96882 :             rank++;</span>
<span class="lineNum">    2167 </span>                :<span class="lineCov">      96882 :             zzlNext(zl,&amp;eptr,&amp;sptr);</span>
<span class="lineNum">    2168 </span>                :            :         }
<span class="lineNum">    2169 </span>                :            : 
<span class="lineNum">    2170 </span>        [<span class="branchCov" title="Branch 0 was taken 2008 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">       2010 :         if (eptr != NULL) {</span>
<span class="lineNum">    2171 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 2005 times"> + </span>]:<span class="lineCov">       2008 :             if (reverse)</span>
<span class="lineNum">    2172 </span>                :<span class="lineCov">          3 :                 addReplyLongLong(c,llen-rank);</span>
<span class="lineNum">    2173 </span>                :            :             else
<span class="lineNum">    2174 </span>                :<span class="lineCov">       2005 :                 addReplyLongLong(c,rank-1);</span>
<span class="lineNum">    2175 </span>                :            :         } else {
<span class="lineNum">    2176 </span>                :<span class="lineCov">          2 :             addReply(c,shared.nullbulk);</span>
<span class="lineNum">    2177 </span>                :            :         }
<span class="lineNum">    2178 </span>        [<span class="branchCov" title="Branch 0 was taken 2009 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2009 :     } else if (zobj-&gt;encoding == REDIS_ENCODING_SKIPLIST) {</span>
<span class="lineNum">    2179 </span>                :<span class="lineCov">       2009 :         zset *zs = zobj-&gt;ptr;</span>
<span class="lineNum">    2180 </span>                :<span class="lineCov">       2009 :         zskiplist *zsl = zs-&gt;zsl;</span>
<span class="lineNum">    2181 </span>                :            :         dictEntry *de;
<span class="lineNum">    2182 </span>                :            :         double score;
<span class="lineNum">    2183 </span>                :            : 
<span class="lineNum">    2184 </span>                :<span class="lineCov">       2009 :         ele = c-&gt;argv[2] = tryObjectEncoding(c-&gt;argv[2]);</span>
<span class="lineNum">    2185 </span>                :<span class="lineCov">       2009 :         de = dictFind(zs-&gt;dict,ele);</span>
<span class="lineNum">    2186 </span>        [<span class="branchCov" title="Branch 0 was taken 2007 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">       2009 :         if (de != NULL) {</span>
<span class="lineNum">    2187 </span>                :<span class="lineCov">       2007 :             score = *(double*)dictGetVal(de);</span>
<span class="lineNum">    2188 </span>                :<span class="lineCov">       2007 :             rank = zslGetRank(zsl,score,ele);</span>
<span class="lineNum">    2189 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2007 times"> + </span>]:<span class="lineCov">       2007 :             redisAssertWithInfo(c,ele,rank); /* Existing elements always have a rank. */</span>
<span class="lineNum">    2190 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 2004 times"> + </span>]:<span class="lineCov">       2007 :             if (reverse)</span>
<span class="lineNum">    2191 </span>                :<span class="lineCov">          3 :                 addReplyLongLong(c,llen-rank);</span>
<span class="lineNum">    2192 </span>                :            :             else
<span class="lineNum">    2193 </span>                :<span class="lineCov">       2004 :                 addReplyLongLong(c,rank-1);</span>
<span class="lineNum">    2194 </span>                :            :         } else {
<span class="lineNum">    2195 </span>                :<span class="lineCov">          2 :             addReply(c,shared.nullbulk);</span>
<span class="lineNum">    2196 </span>                :            :         }
<span class="lineNum">    2197 </span>                :            :     } else {
<span class="lineNum">    2198 </span>                :<span class="lineNoCov">          0 :         redisPanic(&quot;Unknown sorted set encoding&quot;);</span>
<span class="lineNum">    2199 </span>                :            :     }
<a name="2200"><span class="lineNum">    2200 </span>                :            : }</a>
<span class="lineNum">    2201 </span>                :            : 
<span class="lineNum">    2202 </span>                :<span class="lineCov">       4011 : void zrankCommand(redisClient *c) {</span>
<span class="lineNum">    2203 </span>                :<span class="lineCov">       4011 :     zrankGenericCommand(c, 0);</span>
<a name="2204"><span class="lineNum">    2204 </span>                :<span class="lineCov">       4011 : }</span></a>
<span class="lineNum">    2205 </span>                :            : 
<span class="lineNum">    2206 </span>                :<span class="lineCov">          8 : void zrevrankCommand(redisClient *c) {</span>
<span class="lineNum">    2207 </span>                :<span class="lineCov">          8 :     zrankGenericCommand(c, 1);</span>
<span class="lineNum">    2208 </span>                :<span class="lineCov">          8 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.9</a></td></tr>
  </table>
  <br>

</body>
</html>
